<!DOCTYPE html>
    <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALDO Admin Panel</title>
  <style>
  body {
    background-color: #000 !important;
    color: #fff !important;
    font-family: Arial, sans-serif;
    padding: 20px;
  }

  /* üîí Force solid black cards + blocks */
  .card, .section, .wp-block, .wp-block-group, .wp-block-cover, .wp-block-column, .wp-block-html {
    background-color: #000 !important;
    color: #fff !important;
    border: none !important;
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.15) !important;
    backdrop-filter: none !important;
    opacity: 1 !important;
  }

  .card * {
    background-color: inherit !important;
  }

  .wp-block-cover__inner-container,
  .wp-block-group__inner-container {
    background: #000 !important;
    padding: 0 !important;
    opacity: 1 !important;
  }

  h2 {
    color: #ff3b3b;
  }

  .section {
    border: 2px solid #555;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 25px;
    background-color: #000 !important;
  }

  label, input, textarea, select, button {
    display: block;
    margin: 5px 0;
    font-size: 14px;
  }

  /* üßº General Input Defaults (Dark Theme) */
  input, textarea, select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: none;
    background-color: #111;
    color: #ccc;
  }

  /* ‚úÖ Force white background for filter/search inputs */
  input[type="date"],
  input[type="datetime-local"],
  input[type="text"].airdrop-filter,
  input.airdrop-filter {
    background-color: #ffffff !important;
    color: #000000 !important;
    border: 2px solid #ff3b3b !important;
    border-radius: 6px !important;
    padding: 10px !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    box-shadow: none !important;
  }

  button {
    background-color: #ff3b3b;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 5px;
    cursor: pointer;
  }

  button:hover {
    background-color: #ff5e5e;
  }

  #presale-timer {
    font-size: 1.5em;
    margin-bottom: 10px;
    color: #00ffcc;
  }

  .presale-countdown-box {
    background: #000 !important;
    color: #fff;
    padding: 20px;
    border: 2px dashed #ff0033;
    border-radius: 16px;
    font-family: 'Press Start 2P', monospace;
    max-width: 600px;
    margin: 20px auto;
    box-shadow: 0 0 18px rgba(255,0,0,0.5);
  }

  .presale-countdown-title {
    font-size: 12px;
    color: #ff0033;
    margin-bottom: 12px;
  }

  .presale-countdown-label {
    font-size: 10px;
    color: #ccc;
  }

  .presale-countdown-input {
    margin-top: 4px;
    padding: 8px;
    width: 100%;
    font-size: 12px;
    background: #000;
    color: #ff0033;
    border: 1px solid #ff0033;
    border-radius: 8px;
  }

  .presale-countdown-button {
    background: #ff0033;
    color: #fff;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
  }

  .presale-countdown-status {
    margin-top: 12px;
    font-size: 10px;
    color: #0f0;
  }

  table {
    width: 100%;
    overflow-x: auto;
    display: block;
    white-space: nowrap;
  }

  table, th, td {
    background-color: #000 !important;
    color: #fff;
    border: 1px solid #333;
  }

  .buyer-search-container {
    margin: 10px 0;
  }

  .buyer-search-input {
    width: 100%;
    padding: 8px;
    background: #111;
    border: 1px solid #444;
    color: #fff;
    border-radius: 5px;
  }
  /* üõë Reset All Inputs to Match Visible Theme */
input,
textarea,
select {
  background-color: #000 !important;
  color: #fff !important;
  border: 1px solid #ff3b3b !important;
  border-radius: 6px !important;
  padding: 10px !important;
  box-shadow: none !important;
  appearance: none !important;
  -webkit-appearance: none !important;
}

/* ‚úÖ Bonus: Add red border on focus for visual cue */
input:focus,
textarea:focus,
select:focus {
  outline: none !important;
  border-color: #ff5e5e !important;
  box-shadow: 0 0 6px #ff5e5e;
}

#countdown-date {
  color: #888;
}
#countdown-date-secondary {
  color: #888;
}
#refundStatus {
  margin-top: 10px;
  color: #0f0;
}

</style>
<div class="custom-black-box"></div>
<!-- WALDO Admin Panel Table Section -->
<div class="admin-card">
  <h3>üìã Presale Buyers</h3>
  <div>
    üßÆ Total WALDO: <span id="totalWaldo">Loading...</span> | üí∏ Total XRP: <span id="totalXrp">Loading...</span>
  </div>

  <input type="text" id="buyerSearch" oninput="filterBuyers()" placeholder="Search buyers...">
  <table>
    <thead>
      <tr>
        <th>Wallet</th>
        <th>XRP Sent</th>
        <th>WALDO</th>
        <th>Email</th>
        <th>Timestamp</th>
        <th>WALDO Balance</th>
      </tr>
    </thead>
    <tbody id="buyerRowsMain">
      <!-- Dynamic rows -->
    </tbody>
  </table>
</div>
<!-- üìä WALDO Presale Summary -->
<div class="card">
  <h2>üìä Presale Summary</h2>
  <button type="button" onclick="downloadCSV()">‚¨áÔ∏è Download Presale CSV</button>
  <button type="button" onclick="loadBuyers()">üîÑ Refresh Buyer List</button>
  <p>
    <strong>WALDO Sold:</strong> <span id="totalWaldoSold">...</span><br>
  <input type="text" id="buyerSearchTop" placeholder="Start typing..." oninput="filterBuyers()" class="buyer-search-input">
  </p>
  <div class="margin-10">
    <label for="startDate">Filter by Date:</label><br>
    <input type="date" id="startDate" class="date-input">
    <input type="date" id="endDate" class="date-input">
  <div><small id="countdown-date-secondary-2"></small></div>
  <label for="buyerSearch">üîç Search Wallet / Email / Amount:</label>
  <input type="text" id="buyerSearchSecondary" placeholder="Start typing..." oninput="filterBuyers()" class="buyer-search-input">

</div>
</div>

  <table>
    <thead>
      <tr>
        <th scope="col">Wallet</th>
        <th scope="col">XRP</th>
        <th scope="col">WALDO</th>
        <th scope="col">Email</th>
        <th scope="col">Timestamp</th>
        <th scope="col">WALDO Balance</th>
      </tr>
    </thead>
    <tbody id="buyerRows">
      <tr><td colspan="6">Loading...</td></tr>
    </tbody>
  </table>

<!-- üéÅ WALDO Airdrop History -->
<div class="card">
  <h2>üéÅ Airdrop History</h2>
  <input type="date" id="historyStart" class="date-input">
  <input type="date" id="historyEnd" class="date-input">
  <button type="button" onclick="downloadAirdropHistoryCSV()" class="export-history-btn">Export History CSV</button>
  <table>
    <thead>
      <tr>
        <th scope="col">Wallet</th>
        <th scope="col">Amount</th>
        <th scope="col">Date</th>
      </tr>
    </thead>
    <tbody id="airdropHistoryRows">
      <tr><td colspan="3">Loading...</td></tr>
    </tbody>
  </table>
</div>
<div id="presale-timer">
  Countdown: <span id="presale-countdown">Loading...</span><br>
  <small id="countdown-date"></small>
</div>

<div class="presale-countdown-box">
  <h3 class="presale-countdown-title">‚è±Ô∏è Set WALDOcoin Presale Countdown</h3>
  <label class="presale-countdown-label">New End Date (UTC):</label><br>
  <input type="datetime-local" id="countdownInput" class="presale-countdown-input"><br><br>
  <button type="button" onclick="submitCountdown()" class="presale-countdown-button">
    üöÄ Update Countdown
  </button>
  <div id="countdownStatus" class="presale-countdown-status"></div>
</div>

  <div class="section">
    <h2>üó≥ DAO: Create Proposal</h2>
    <input id="proposalTitle" type="text" placeholder="Proposal Title">
    <textarea id="proposalDescription" placeholder="Proposal Description"></textarea>
    <input id="proposalDeadline" type="datetime-local">
    <button type="button" onclick="createProposal()">Create Proposal</button>
  </div>

  <div class="section">
    <h2>üß† DAO: Override Proposal</h2>
    <input id="overrideId" type="text" placeholder="Proposal ID">
    <select id="newStatus">
      <option value="active">Active</option>
      <option value="expired">Expired</option>
      <option value="closed">Closed</option>
    </select>
    <button type="button" onclick="overrideProposal()">Override Status</button>
  </div>

  <div class="section">
    <h2>üíÄ DAO: Expire / Delete</h2>
    <input id="expireId" type="text" placeholder="Proposal ID">
    <button type="button" onclick="expireProposal()">Expire</button>
    <button type="button" onclick="deleteProposal()">Delete</button>
  </div>

  <div class="section">
    <h2>üìö DAO: Voter History &amp; Config</h2>
    <input id="voterWallet" type="text" placeholder="Wallet address">
    <button type="button" onclick="lookupVoter()">Lookup Voter History</button>
    <label>Minimum WALDO to Vote</label>
    <input id="daoMinWaldo" type="number" value="10000">
    <button type="button" onclick="updateDaoConfig()">Update Config</button>
  </div>

<div class="section">
  <h2>‚öîÔ∏è Battle Debug &amp; Backup</h2>

  <input id="payoutBattleId" type="text" placeholder="Battle ID">
  <button type="button" onclick="triggerPayout()">Force Payout</button>
  <div id="refundStatus2"></div>
  <button id="triggerRefundBtn" type="button">üßØ Trigger Manual Refund</button>
  <button type="button" onclick="viewBattles()">View All Battles</button>

  <div id="refundStatus"></div>
</div>

<script>
const base = "https://waldocoin-backend-api.onrender.com";
let allBuyers = [];
let allHistory = [];

function secureAdminPost(route, payload = {}) {
  return fetch("/wp-admin/admin-ajax.php?action=waldo_admin_proxy", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      route,
      payload: JSON.stringify(payload)
    })
  })
  .then(res => res.json())
  .then(res => {
    if (!res.success) throw new Error(res.data?.error || "Unknown error");
    return res.data;
  });
}

function renderBuyers(list) {
  const tbody = document.getElementById("buyerRowsMain");
  tbody.innerHTML = list.length
    ? list.map((b, i) => `
      <tr>
        <td>${b.wallet}</td>
        <td>${b.amountXRP}</td>
        <td>${b.tokens}</td>
        <td>${b.email || "-"}</td>
        <td>${new Date(b.timestamp).toLocaleString()}</td>
        <td id="bal-${i}">Loading...</td>
      </tr>
    `).join("")
    : "<tr><td colspan='6'>No buyers found.</td></tr>";

  list.forEach(async (b, i) => {
    const balance = await fetchWaldoBalance(b.wallet);
    document.getElementById(`bal-${i}`).innerText = balance;
  });
}

function filterBuyers() {
  // Try both search inputs, prioritizing the one with a value
  const searchMain = document.getElementById("buyerSearch");
  const searchSecondary = document.getElementById("buyerSearchSecondary");
  let term = "";
  if (searchMain && searchMain.value.trim() !== "") {
    term = searchMain.value.trim().toLowerCase();
  } else if (searchSecondary && searchSecondary.value.trim() !== "") {
    term = searchSecondary.value.trim().toLowerCase();
  }
  const filtered = allBuyers.filter(b =>
    b.wallet.toLowerCase().includes(term) ||
    (b.email || "").toLowerCase().includes(term) ||
    (b.amountXRP + "").includes(term) ||
    (b.tokens + "").includes(term)
  );
  renderBuyers(filtered);
}

async function fetchWaldoBalance(wallet) {
  try {
    const res = await fetch("https://s1.ripple.com:51234", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ method: "account_lines", params: [{ account: wallet }] })
    });
    const data = await res.json();
    const waldo = data.result.lines.find(l => l.currency === "WALDO" && l.account === "rf97bQQbqztUnL1BYB5ti4rC691e7u5C8F");
    return waldo ? parseFloat(waldo.balance).toLocaleString() : "0";
  } catch (err) {
    console.error("Balance fetch failed:", err);
    return "‚Äî";
  }
}

function downloadCSV() {
  window.open(`${base}/admin/export/presale`, "_blank");
}

function downloadCSVByDate() {
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  if (!start || !end) return alert("Select both start and end dates.");

  fetch(`${base}/admin/export/presale?start=${start}&end=${end}`)
    .then(res => res.blob())
    .then(blob => {
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `waldo_presale_${start}_to_${end}.csv`;
      link.click();
    })
    .catch(err => alert("CSV download failed: " + err.message));
}

function getTotals() {
  const totalWaldo = allBuyers.reduce((sum, b) => sum + (b.tokens || 0), 0);
  const totalXrp = allBuyers.reduce((sum, b) => sum + (b.amountXRP || 0), 0);
  document.getElementById("totalWaldo").textContent = totalWaldo.toLocaleString();
  document.getElementById("totalXrp").textContent = totalXrp.toLocaleString();
  const soldElem = document.getElementById("totalWaldoSold");
  if (soldElem) soldElem.textContent = totalWaldo.toLocaleString();
}

async function loadBuyers() {
  try {
    const res = await fetch(`${base}/api/presale`);
    const text = await res.text();
    allBuyers = JSON.parse(text);
    renderBuyers(allBuyers);
    getTotals();
  } catch (err) {
    console.error("Buyers load failed", err);
  }
}

async function loadAirdropHistory() {
  try {
    const res = await fetch(`${base}/api/presale/airdrops`);
    const text = await res.text();
    allHistory = JSON.parse(text);
    renderHistory(allHistory);
  } catch (err) {
    console.error("Airdrop history load failed", err);
  }
}

function renderHistory(list) {
  const tbody = document.getElementById("airdropHistoryRows");
  tbody.innerHTML = list.length
    ? list.map(e => `
      <tr>
        <td>${e.wallet}</td>
        <td>${e.amount}</td>
        <td>${new Date(e.timestamp).toLocaleString()}</td>
      </tr>
    `).join("")
    : "<tr><td colspan='3'>No airdrops yet.</td></tr>";
}
function downloadAirdropHistoryCSV() {
  const start = document.getElementById("historyStart").value;
  const end = document.getElementById("historyEnd").value;

  const filtered = allHistory.filter(entry => {
    const ts = new Date(entry.timestamp);
    if (start && new Date(start) > ts) return false;
    if (end && new Date(end) < ts) return false;
    return true;
  });

  const csv = "Wallet,Amount,Timestamp\n" + filtered.map(e => `${e.wallet},${e.amount},${e.timestamp}`).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `waldo_airdrop_history_${Date.now()}.csv`;
  link.click();
}
function fetchPresaleCountdown() {
  fetch(`${base}/api/presale/countdown`)
    .then(res => res.json())
    .then(data => {
      const span = document.getElementById("presale-countdown");
      const dateEl = document.getElementById("countdown-date"); // Add this if you're using a second span

      if (data.endDate) {
        const endDate = new Date(data.endDate);

        const localTime = endDate.toLocaleString(undefined, {
          timeZoneName: "short"
        });
        const utcTime = endDate.toUTCString();

        // Update main countdown label
        if (span) {
          span.textContent = `${localTime} (Local)`;
        }

        // Optional second display for UTC
        if (dateEl) {
          dateEl.textContent = `${utcTime} (UTC)`;
        }
      } else {
        if (span) span.textContent = "Not Set";
        if (dateEl) dateEl.textContent = "";
      }
    })
    .catch(err => {
      console.error("Failed to load countdown:", err);
      const span = document.getElementById("presale-countdown");
      const dateEl = document.getElementById("countdown-date");
      if (span) span.textContent = "Error loading";
      if (dateEl) dateEl.textContent = "";
    });
}
function submitCountdown() {
  const newDate = document.getElementById("countdownInput").value;
  const status = document.getElementById("countdownStatus");
  if (!newDate) {
    status.textContent = "‚ö†Ô∏è Please enter a valid date.";
    return;
  }

  secureAdminPost("/api/presale/set-end-date", { newDate: newDate + ":00Z" })
    .then(() => {
      status.textContent = "‚úÖ Countdown updated!";
      fetchPresaleCountdown();
    })
    .catch(err => {
      console.error("Countdown update failed:", err);
      status.textContent = "‚ùå Update failed. Check console.";
    });
}

// DAO and Battle Handlers
function createProposal() {
  secureAdminPost("/api/dao/create", {
    title: document.getElementById("proposalTitle").value,
    description: document.getElementById("proposalDescription").value,
    deadline: document.getElementById("proposalDeadline").value
  }).then(() => alert("‚úÖ Proposal created"))
    .catch(err => alert("‚ùå " + err.message));
}

function overrideProposal() {
  secureAdminPost("/api/dao/override", {
    proposalId: document.getElementById("overrideId").value,
    newStatus: document.getElementById("newStatus").value
  }).then(() => alert("‚úÖ Proposal overridden"))
    .catch(err => alert("‚ùå " + err.message));
}

function expireProposal() {
  secureAdminPost("/api/dao/expire", {
    proposalId: document.getElementById("expireId").value
  }).then(() => alert("‚úÖ Proposal expired"))
    .catch(err => alert("‚ùå " + err.message));
}

function deleteProposal() {
  secureAdminPost("/api/dao/delete", {
    proposalId: document.getElementById("expireId").value
  }).then(() => alert("‚úÖ Proposal deleted"))
    .catch(err => alert("‚ùå " + err.message));
}

function lookupVoter() {
  secureAdminPost("/api/dao/voter-history", {
    wallet: document.getElementById("voterWallet").value
  }).then(data => alert(JSON.stringify(data, null, 2)))
    .catch(err => alert("‚ùå " + err.message));
}

function updateDaoConfig() {
  secureAdminPost("/api/dao/config", {
    minWaldo: parseInt(document.getElementById("daoMinWaldo").value)
  }).then(() => alert("‚úÖ DAO config updated"))
    .catch(err => alert("‚ùå " + err.message));
}

function triggerPayout() {
  secureAdminPost("/api/battle/payout", {
    battleId: document.getElementById("payoutBattleId").value
  }).then(() => alert("‚úÖ Payout triggered"))
    .catch(err => alert("‚ùå " + err.message));
}

function createFakeBattle() {
  secureAdminPost("/api/debug/fake-battle")
    .then(() => alert("‚úÖ Fake battle created"))
    .catch(err => alert("‚ùå " + err.message));
}

function viewBattles() {
  window.open(`${base}/api/debug/battles`, "_blank");
}

document.addEventListener("DOMContentLoaded", () => {
  loadBuyers();
  loadAirdropHistory();
  fetchPresaleCountdown();
});
</script>
<style>
  .digital-clock-box {
    background-color: #000;
    border: 3px solid #ff0033;
    border-radius: 16px;
    padding: 20px;
    text-align: center;
    margin: 30px auto;
    box-shadow: 0 0 12px rgba(255, 0, 0, 0.6);
    max-width: 90%;
    font-family: 'Courier New', monospace;
  }

  .digital-label,
  .digital-date-label {
    font-size: 16px;
    color: #ff0033;
    margin-bottom: 10px;
  }

  .digital-display {
    font-size: 28px;
    color: #00ffcc;
    background-color: #111;
    padding: 12px 20px;
    border-radius: 8px;
    border: 2px solid #00ffcc;
    display: inline-block;
    letter-spacing: 2px;
    margin-bottom: 10px;
  }

  @media screen and (max-width: 600px) {
    .digital-display {
      font-size: 22px;
      padding: 10px 16px;
    }

    .digital-label,
    .digital-date-label {
      font-size: 14px;
    }
  }
</style>

<script>
function updateCountdown() {
  fetch("https://waldocoin-backend-api.onrender.com/api/presale/countdown")
    .then(res => res.json())
    .then(data => {
      const countdownEl = document.getElementById("presale-countdown");
      const utcEl = document.getElementById("countdown-date");
      const localEl = document.getElementById("countdown-local");

      const endDate = new Date(data.endDate);

      utcEl.textContent = endDate.toLocaleString("en-US", { timeZone: "UTC" }) + " UTC";
      localEl.textContent = endDate.toLocaleString(); // Browser's local time

      const updateTimer = () => {
        const now = new Date();
        const diff = endDate - now;

        if (diff <= 0) {
          countdownEl.textContent = "Presale Ended";
          clearInterval(timer);
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((diff / (1000 * 60)) % 60);
        const seconds = Math.floor((diff / 1000) % 60);

        countdownEl.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
      };

      updateTimer();
      const timer = setInterval(updateTimer, 1000);
    })
    .catch(err => {
      console.error("Countdown fetch error:", err);
      document.getElementById("presale-countdown").textContent = "Error";
      document.getElementById("countdown-date").textContent = "Fetch Error";
      document.getElementById("countdown-local").textContent = "Fetch Error";
    });
}
</script>
<script>
const API_BASE = "https://waldocoin-backend-api.onrender.com";

// üîê You must set this via secure method (env-injected inline or input field):
const getAdminKey = () => localStorage.getItem("waldoAdminKey") || prompt("Enter admin key");

async function triggerPayout() {
  const id = document.getElementById("payoutBattleId").value.trim();
  if (!id) return alert("Please enter a Battle ID");

  try {
    const res = await fetch(`${API_BASE}/api/battle/payout?id=${id}`, {
      method: "POST",
      headers: { "x-admin-key": getAdminKey() }
    });
    const data = await res.json();
    alert(data.success ? `‚úÖ Payout triggered: ${data.message || "Success"}` : `‚ùå ${data.error || "Failed"}`);
  } catch (err) {
    alert("‚ùå Request failed: " + err.message);
  }
}

async function createFakeBattle() {
  try {
    const res = await fetch(`${API_BASE}/api/debug/fake-battle`, {
      method: "POST",
      headers: { "x-admin-key": getAdminKey() }
    });
    const data = await res.json();
    alert(data.success ? "‚úÖ Fake battle created" : `‚ùå ${data.error || "Failed to create fake battle"}`);
  } catch (err) {
    alert("‚ùå Request failed: " + err.message);
  }
}

async function viewBattles() {
  try {
    const res = await fetch(`${API_BASE}/api/debug/battles`, {
      headers: { "x-admin-key": getAdminKey() }
    });
    const data = await res.json();
    alert("üóÇÔ∏è Total battles: " + data.battles?.length);
    console.log("üß† Live battle data:", data);
  } catch (err) {
    alert("‚ùå Could not fetch battle list: " + err.message);
  }
}

document.getElementById("triggerRefundBtn").addEventListener("click", async () => {
  const statusEl = document.getElementById("refundStatus");
  statusEl.textContent = "‚è≥ Processing refund...";
  statusEl.style.color = "#ff0";

  try {
    const res = await fetch(`${API_BASE}/api/debug/refund`, {
      method: "GET",
      headers: { "x-admin-key": getAdminKey() }
    });
    const data = await res.json();
    if (data.success) {
      statusEl.textContent = `‚úÖ ${data.message || "Refund triggered"}`;
      statusEl.style.color = "#0f0";
    } else {
      statusEl.textContent = `‚ùå ${data.error || "Refund failed"}`;
      statusEl.style.color = "#f00";
    }
  } catch (err) {
    statusEl.textContent = "‚ùå Request failed: " + err.message;
    statusEl.style.color = "#f00";
  }
});

document.addEventListener("DOMContentLoaded", updateCountdown);
</script>