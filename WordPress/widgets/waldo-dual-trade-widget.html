<!-- WALDO Dual Trading Widget: XRPL DEX + First Ledger (drop-in) -->
<div class="waldo-trade collapsed" id="waldoTrade">
  <div class="trade-head">
    <div class="title"><span class="accent">🟢</span> WALDO Trading</div>
    <div class="sub">Price: <span id="priceXrp">—</span> • Vol 24h: <span id="vol24">—</span></div>
    <div class="tabs">
      <button id="widgetToggle" class="toggle" aria-label="Toggle widget" title="Toggle"></button>
      <button class="tab active" data-tab="xrpl">XRPL DEX</button>
      <button class="tab" data-tab="fl">First Ledger</button>
    </div>
  </div>
  <div class="trade-body">
    <div class="panel" id="panelXrpl">
      <div class="row">
        <button class="btn connect-cta" onclick="waldoConnect()">Connect Xaman</button>
        <button class="btn" onclick="waldoTrustline()">Add Trustline</button>
        <button class="btn" id="btnDisconnect" onclick="waldoDisconnect()" style="display:none;">Disconnect</button>
      </div>
      <div class="row status-row">
        <div id="connStatus" class="conn">Not connected</div>
        <div id="tlStatus" class="conn">Trustline: —</div>
      </div>
      <div class="swap-card">
        <div class="swap-row">
          <div class="token">
            <label>From</label>
            <div class="token-box">
              <span class="sym" id="fromSymbol">XRP</span>
              <input type="number" min="0" step="0.000001" id="fromAmount" placeholder="0.0" />
            </div>
          </div>
          <button class="flip" onclick="window.swapFlip()" title="Flip">⇅</button>
          <div class="token">
            <label>To</label>
            <div class="token-box">
              <span class="sym" id="toSymbol">WLO</span>
              <input type="text" id="toAmount" placeholder="0" readonly />
            </div>
          </div>
        </div>
        <div class="chipbar">
          <span>Slippage:</span>
          <button class="chip" data-slip="0">0%</button>
          <button class="chip" data-slip="50">0.5%</button>
          <button class="chip" data-slip="100">1%</button>
          <button class="chip" data-slip="200">2%</button>
        </div>
        <div class="minline">Min receive: <span id="swapMinOut">—</span></div>
        <div class="subline">Price: <span id="swapPrice">—</span> • Impact: <span id="swapImpact">—</span></div>
        <div class="actions"><button class="btn buy" onclick="waldoSwap()">Swap</button></div>
      </div>
      <div id="tradeMsg" class="msg"></div>
    </div>

    <div class="panel" id="panelFl" style="display:none;">
      <div class="fl-card">
        <div class="fl-icon">💱</div>
        <div class="fl-title">First Ledger</div>
        <div class="fl-sub">Trade WLO on First Ledger in a new tab</div>
        <div class="fl-actions">
          <a class="btn buy fl-cta" target="_blank" rel="noopener"
            href="https://firstledger.net/token/rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY/WLO">Open First Ledger</a>
        </div>
      </div>
    </div>
  </div>

  <!-- XUMM Modal -->
  <div id="xummModal" class="xumm-modal" style="display:none;">
    <div class="backdrop" onclick="xummClose()"></div>
    <div class="content">
      <button class="close" onclick="xummClose()">✕</button>
      <h4 id="xummTitle">Xaman</h4>
      <div id="xummDesktop">
        <img id="xummQr" alt="Scan with Xaman"
          style="display:none; max-width:280px; border-radius:10px; box-shadow: 0 0 18px #25c2a055;" />
        <div id="xummLoad" class="spin" style="display:none;"></div>
        <p id="xummHint" class="hint" style="display:none;">Scan the QR with your Xaman app</p>
      </div>
      <div id="xummMobile" style="display:none; display:flex; flex-direction:column; gap:8px; align-items:center;">
        <button id="xummMobileBtn" class="btn" type="button"
          style="background: #25c2a0; color: white; border: none; padding: 15px 20px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;">📱
          Open Xaman App</button>
        <a id="xummLink" href="#" target="_blank" rel="noopener"
          style="display:none; color:#9adbcf; word-break:break-all;">Open in Xaman (link)</a>


        <small class="hint" style="color:#9adbcf; opacity:.9;">If the app doesn’t open, copy the link and paste into
          Xaman.</small>
      </div>
    </div>
    <!-- Toast -->
    <div id="waldoToast" class="toast" style="display:none;">Done</div>
  </div>
</div>

<style>
  .waldo-trade {
    --mint: #25c2a0;
    --red: #ff6b6b;
    --line: #1a1a1a;
    --neonAqua: #00f7ff;
    --neonMagenta: #ff3df7;
    background: radial-gradient(600px 200px at 10% -10%, rgba(255, 61, 247, .10), transparent 60%),
      radial-gradient(600px 180px at 90% -10%, rgba(0, 247, 255, .10), transparent 60%),
      linear-gradient(180deg, #0a0c1a 0%, #0b0f23 100%);
    border: 1px solid #18213d;
    border-radius: 16px;
    box-shadow: 0 0 22px rgba(0, 247, 255, .08), 0 0 42px rgba(255, 61, 247, .06);
    max-width: 520px;
    margin: 14px auto;
    color: #eafff9;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overflow: hidden;
  }

  .trade-head {
    text-align: center;
    position: relative
  }

  .tabs {
    justify-content: center
  }

  .toggle {
    position: absolute;
    right: 8px;
    top: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid #26335f;
    background: radial-gradient(circle, #00f7ff 0, #00f7ff 50%, transparent 51%);
    box-shadow: 0 0 10px rgba(0, 247, 255, .4);
    cursor: pointer
  }

  .collapsed .panel,
  .collapsed .status-row {
    display: none;
  }

  .collapsed .tabs {
    display: flex
  }

  .collapsed .trade-head {
    padding-bottom: 10px
  }

  .collapsed .trade-head {
    padding-bottom: 10px
  }

  .collapsed .tabs {
    display: flex
  }

  @media (max-width: 520px) {
    .waldo-trade {
      max-width: 94vw
    }
  }

  .trade-head {
    padding: 12px 16px 0
  }

  .title {
    position: relative;
    text-transform: uppercase;
    letter-spacing: .8px;
    font-weight: 1000;
    font-size: 18px;
    background: linear-gradient(90deg, var(--neonAqua), var(--neonMagenta), var(--neonAqua));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 300% 100%;
    animation: shimmer 5s linear infinite;
    text-shadow: 0 0 12px rgba(0, 247, 255, .35), 0 0 20px rgba(255, 61, 247, .25);
  }

  .title:after {
    content: "";
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -6px;
    width: 60%;
    height: 3px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(0, 247, 255, .9), rgba(255, 61, 247, .9), rgba(0, 247, 255, .9));
    box-shadow: 0 0 10px rgba(0, 247, 255, .4), 0 0 16px rgba(255, 61, 247, .3);
    animation: shimmer 6s linear infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: 0% 0
    }

    100% {
      background-position: -200% 0
    }
  }

  .sub {
    font-size: 13px;
    color: #bfeee3;
    margin-top: 6px
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-top: 10px
  }

  .tabs .tab {
    background: #111;
    border: 1px solid #1c1c1c;
    color: #bfeee3;
    padding: 8px 12px;
  }

  /* Rows under header */
  .status-row {
    margin-top: 4px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }

  .conn {
    font-size: 12px;
    color: #9adbcf
  }

  /* Swap UI */
  .swap-card {
    position: relative;
    border: 1px solid #202a4e;
    border-radius: 12px;
    padding: 12px;
    background: linear-gradient(180deg, #0a0f26, #0b112d);
    box-shadow: inset 0 0 0 1px rgba(0, 247, 255, .05);
  }

  .swap-card:before,
  .swap-card:after {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: 12px;
    pointer-events: none;
  }

  .swap-card:before {
    background: linear-gradient(90deg, transparent, rgba(0, 247, 255, .25), transparent);
    filter: blur(8px)
  }

  .swap-card:after {
    background: linear-gradient(90deg, transparent, rgba(255, 61, 247, .2), transparent);
    opacity: .7;
    mix-blend-mode: screen
  }

  .swap-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .token {
    flex: 1 1 260px
  }

  .token input {
    height: 36px;
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    color: #eafff9;
    font-size: 16px;
    appearance: textfield;
  }

  .token .sym {
    min-width: 46px;
    text-align: center;
    font-weight: 900;
    color: #a9ffee
  }

  .swap-card .token-box {
    max-width: 240px
  }

  .token-box {
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #202a4e;
    border-radius: 12px;
    padding: 8px 10px;
    background: linear-gradient(180deg, #0a0f26, #0b112d);
    box-shadow: inset 0 0 0 1px rgba(0, 247, 255, .05), 0 0 14px rgba(0, 247, 255, .06);
    max-width: 100%;
  }

  #fromAmount {
    background: linear-gradient(180deg, rgba(0, 247, 255, .08), rgba(255, 61, 247, .06));
    border-radius: 8px;
    padding: 0 8px
  }

  .token input::-webkit-outer-spin-button,
  .token input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0
  }

  .token #toAmount {
    opacity: .85
  }

  .flip {
    align-self: center;
    background: #111;
    border: 1px solid #1c1c1c;
    color: #c6fff0;
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer
  }

  .subline {
    font-size: 12px;
    color: #9adbcf;
    margin-top: 6px
  }

  .actions {
    margin-top: 10px;
    display: flex;
    justify-content: center
  }

  .tabs .tab.active {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #07120f;
    border-color: rgba(37, 194, 160, .35)
  }

  /* Enhance tabs visibility */
  .tabs {
    gap: 12px;
    margin-top: 12px
  }

  .tabs .tab {
    border-radius: 12px;
    padding: 10px 16px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.02em;
    border: 1px solid #2a2a2a;
    color: #cffff3;
    box-shadow: 0 0 0 1px rgba(0, 0, 0, .35), 0 6px 16px rgba(0, 0, 0, .35);
  }

  .tabs .tab:hover {
    filter: brightness(1.08);
    border-color: rgba(37, 194, 160, .35);
    box-shadow: 0 0 0 1px rgba(37, 194, 160, .25), 0 8px 18px rgba(37, 194, 160, .15);
  }

  .tabs .tab:focus-visible {
    outline: 2px solid var(--mint);
    outline-offset: 2px
  }

  .tabs .tab.active {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #07120f;
    border-color: rgba(37, 194, 160, .5);
    box-shadow: 0 0 0 2px rgba(37, 194, 160, .25) inset, 0 10px 24px rgba(37, 194, 160, .25);
  }



  .trade-body {
    padding: 12px 16px 16px
  }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px
  }

  .col {
    flex: 1 1 260px;
    background: #101010;
    border: 1px solid #1a1a1a;
    border-radius: 10px;
    padding: 12px
  }

  .chipbar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin: 6px 0
  }

  .chipbar span {
    font-size: 12px;
    color: #9adbcf
  }

  .minline {
    font-size: 12px;
    color: #8ae9cf;
    margin: 6px 0 8px
  }


  .chip {
    background: #0c1513;
    border: 1px solid #16342b;
    color: #bff7ea;
    border-radius: 999px;
    padding: 6px 10px;
    font-weight: 800;
    cursor: pointer
  }

  .chip:hover {
    filter: brightness(1.08)
  }


  label {
    display: block;
    font-size: 12px;
    color: #c6fff0;
    margin-bottom: 6px
  }

  input[type=number] {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #1c1c1c;
    background: #0b0b0b;
    color: #eafff9
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #111;
    border: 1px solid #1c1c1c;
    color: #c6fff0;
    border-radius: 8px;
    padding: 10px 12px;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none
  }

  .btn.buy {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #06110E;
    border-color: rgba(37, 194, 160, .35)
  }

  .btn.sell {
    background: linear-gradient(90deg, #ff8c8c, var(--red));
    color: #170a0a;
    border-color: rgba(255, 107, 107, .35)
  }

  /* Pronounced CTAs */
  .connect-cta {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #06110E;
    border: 2px solid rgba(37, 194, 160, .55);
    padding: 14px 22px;
    font-size: 17px;
    font-weight: 900;
    letter-spacing: .2px;
    border-radius: 12px;
    box-shadow: 0 0 0 2px rgba(37, 194, 160, .12), 0 8px 22px rgba(37, 194, 160, .25);
    animation: pulseGlow 2.2s ease-in-out infinite;
  }

  .connect-cta:hover {
    filter: brightness(1.06);
    transform: translateY(-1px);
    box-shadow: 0 0 0 2px rgba(37, 194, 160, .18), 0 10px 28px rgba(37, 194, 160, .32);
  }

  .connect-cta:focus-visible {
    outline: 2px solid var(--mint);
    outline-offset: 2px;
  }

  .fl-cta {
    background: linear-gradient(90deg, #19e39a, #4fc2f7);
    color: #06110E;
    border: 2px solid rgba(25, 227, 154, .45);
    padding: 14px 22px;
    font-size: 17px;
    font-weight: 900;
    letter-spacing: .2px;
    border-radius: 12px;
    min-width: 240px;
    box-shadow: 0 0 0 2px rgba(25, 227, 154, .10), 0 8px 22px rgba(79, 194, 247, .20);
  }

  .fl-cta:hover {
    filter: brightness(1.06);
    transform: translateY(-1px);
    box-shadow: 0 0 0 2px rgba(25, 227, 154, .16), 0 10px 28px rgba(79, 194, 247, .28);
  }

  .fl-cta:focus-visible {
    outline: 2px solid #4fc2f7;
    outline-offset: 2px;
  }

  @keyframes pulseGlow {
    0% {
      box-shadow: 0 0 0 2px rgba(37, 194, 160, .10), 0 6px 18px rgba(37, 194, 160, .22);
    }

    50% {
      box-shadow: 0 0 0 3px rgba(37, 194, 160, .18), 0 10px 26px rgba(37, 194, 160, .34);
    }

    100% {
      box-shadow: 0 0 0 2px rgba(37, 194, 160, .10), 0 6px 18px rgba(37, 194, 160, .22);
    }
  }


  .iframe-wrap {
    position: relative
  }

  .iframe-wrap iframe {
    width: 100%;
    height: 640px;
    border: 1px solid #1a1a1a;
    border-radius: 12px;
    background: #0b0b0b
  }

  .iframe-wrap .fallback {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0, 0, 0, .5);
    border: 1px dashed #333;
    border-radius: 12px
  }

  .msg {
    font-size: 13px;
    color: #bfeee3
  }

  .xumm-modal {
    position: fixed;
    inset: 0;
    z-index: 99999
  }

  .xumm-modal .backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, .8);
    backdrop-filter: blur(2px)
  }

  .xumm-modal .content {

    /* First Ledger link-only card (flashy) */
    .fl-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 8px;
      padding: 24px;
      border: 1px solid #1a1a1a;
      border-radius: 12px;
      background: radial-gradient(1200px 200px at 50% -10%, rgba(37, 194, 160, .15), transparent 60%), #0b0b0b
    }

    .fl-icon {
      font-size: 28px;
      filter: drop-shadow(0 0 10px rgba(37, 194, 160, .25))
    }

    .fl-title {
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 900;
      color: #c6fff0
    }

    .fl-sub {
      font-size: 13px;
      color: #bfeee3
    }

    .fl-actions .btn.buy {
      min-width: 220px
    }

    position: relative;
    margin: 10vh auto;
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 14px;
    padding: 20px;
    width: min(92vw, 500px);
    box-shadow: 0 0 24px rgba(37, 194, 160, .25)
  }

  .xumm-modal .close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    color: #9adbcf;
    font-size: 18px;
    cursor: pointer;
  }

  /* Center the XUMM modal and its QR on all devices */
  .xumm-modal {
    padding: 16px;
  }

  .xumm-modal .backdrop {
    z-index: 1;
  }

  .xumm-modal .content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin: 0;
    z-index: 2;
  }

  #xummDesktop {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    text-align: center;
  }

  #xummQr {
    margin: 0 auto;
  }

  #xummLoad.spin {
    margin: 0 auto;
  }

  #xummHint.hint {
    text-align: center;
  }


  .spin {
    border: 4px solid #1c1c1c;
    border-top: 4px solid var(--mint);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    animation: spin 1s linear infinite;
    margin: 10px auto 0
  }

  @keyframes spin {
    0% {
      transform: rotate(0)
    }

    100% {
      transform: rotate(360deg)
    }
  }

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 22px;
    transform: translateX(-50%);
    background: rgba(6, 17, 14, .95);
    color: #c6fff0;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #1a1a1a;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .35)
  }

  .toast.show {
    animation: toastPop .38s ease-out
  }

  @keyframes toastPop {
    0% {
      transform: translateX(-50%) scale(.96);
      opacity: 0
    }

    60% {
      transform: translateX(-50%) scale(1.04);
      opacity: 1
    }

    100% {
      transform: translateX(-50%) scale(1)
    }
  }
</style>

<script>
  (function () {
    console.log('🎯 WALDO Trading Widget Loading...');
    const API = "https://waldocoin-backend-api.onrender.com";
    const el = id => document.getElementById(id);
    const isMobile = /iphone|android|ipad|mobile/i.test(navigator.userAgent);
    console.log('📱 Mobile device detected:', isMobile);

    // Collapsible (start closed)
    const root = document.getElementById('waldoTrade');
    const toggle = document.getElementById('widgetToggle');
    let collapsed = true;
    function applyCollapsed() { root.classList.toggle('collapsed', collapsed); }
    if (toggle) toggle.addEventListener('click', () => { collapsed = !collapsed; applyCollapsed(); if (!collapsed) { try { loadMarket(); refreshSwapMarket(); } catch (_) { } } });
    applyCollapsed();

    // Expose programmatic controls for external CTA buttons
    window.waldoTradeOpen = function () {
      try { collapsed = false; applyCollapsed(); root.focus(); root.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (_) { collapsed = false; applyCollapsed(); }
    };
    window.waldoTradeToggle = function () { collapsed = !collapsed; applyCollapsed(); };

    // Connection & trustline state (for automatic flow)
    let connectedAccount = null;
    let trustlineStatus = null; // true/false/unknown
    window._afterConnect = [];

    window.waldoTradeIsCollapsed = function () { return root.classList.contains('collapsed'); };

    // Toast & Status (top-level)
    function showToast(msg) {
      const t = el('waldoToast'); if (!t) return;
      t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
      setTimeout(() => { t.style.display = 'none'; }, 1400);
    }
    async function startStatusPoll(uuid, successMsg, onSuccess) {
      if (!uuid) return;
      const url = `${API}/api/login/status/${encodeURIComponent(uuid)}`;
      let tries = 0; const max = 300; // up to 5 mins
      const id = setInterval(async () => {
        try {
          const r = await fetch(url + `?_t=${Date.now()}`);
          const s = await r.json();
          if (s?.signed) {
            clearInterval(id);
            if (typeof onSuccess === 'function') try { onSuccess(s); } catch (_) { };
            if (s?.txid) { window._waldoLastTx = s.txid; }
            if (s?.account) {
              setConnected(s.account);
              // Update TL immediately; if missing, kick off auto-add
              try {
                await checkTrustline(s.account);
                if (trustlineStatus === false) {
                  try { ensureTrustlineThen(() => { }); } catch (_) { }
                }
              } catch (_) { }
            }
            // Drain queued callbacks waiting for connection
            if (Array.isArray(window._afterConnect) && window._afterConnect.length) {
              const cbs = window._afterConnect.slice(); window._afterConnect.length = 0;
              cbs.forEach(fn => { try { typeof fn === 'function' && fn(); } catch (_) { } });
            }
            showToast(successMsg || 'Success');
            try { loadMarket(); refreshSwapMarket(); } catch (_) { }
            xummClose();
          }
          if (++tries >= max) clearInterval(id);
        } catch (_) { clearInterval(id); }
      }, 1000);
    }

    // Auto flow helpers: ensure connection and trustline before actions
    function pollTrustlineUntilTrue(account, timeoutMs = 180000, intervalMs = 1500) {
      return new Promise((resolve) => {
        const start = Date.now();
        const iv = setInterval(async () => {
          try {
            await checkTrustline(account);
            if (trustlineStatus === true) { clearInterval(iv); return resolve(true); }
          } catch (_) { }
          if (Date.now() - start >= timeoutMs) { clearInterval(iv); return resolve(false); }
        }, intervalMs);
      });
    }
    window.ensureConnectedThen = function (cb) {
      if (connectedAccount) { try { return cb && cb(); } catch (_) { } return; }
      if (!Array.isArray(window._afterConnect)) window._afterConnect = [];
      window._afterConnect.push(cb);
      try { waldoConnect(); } catch (_) { }
    };
    window.ensureTrustlineThen = function (cb) {
      if (trustlineStatus === true) { try { return cb && cb(); } catch (_) { } return; }
      if (!connectedAccount) return window.ensureConnectedThen(() => window.ensureTrustlineThen(cb));
      try { waldoTrustline(); } catch (_) { }
      pollTrustlineUntilTrue(connectedAccount).then(() => { try { cb && cb(); } catch (_) { } });
    };


    // Trade-specific status poll: waits for WALDO delivery after signature
    async function startTradeStatusPoll(uuid, successMsg, onSuccess) {
      if (!uuid) return;
      const url = `${API}/api/xrpl/trade/status/${encodeURIComponent(uuid)}`;
      let tries = 0; const max = 360; // up to 6 mins
      const id = setInterval(async () => {
        try {
          const r = await fetch(url + `?_t=${Date.now()}`);
          const s = await r.json();
          if (s?.signed) {
            if (s?.account) { setConnected(s.account); }
            if (s?.error === 'missing_sender_secret') {
              clearInterval(id);
              el('tradeMsg').textContent = 'Signed, but delivery is not configured (admin: set WALDO_SENDER_SECRET or WALDO_DISTRIBUTOR_SECRET)';
              xummClose();
              return;
            }
            if (s?.delivered) {
              clearInterval(id);
              if (typeof onSuccess === 'function') try { onSuccess(s); } catch (_) { };
              showToast(successMsg || 'Swap completed');
              try { loadMarket(); refreshSwapMarket(); checkTrustline(s.account); } catch (_) { }
              xummClose();
              return;
            }
            // Signed but not yet delivered: keep polling and show interim status once
            const msg = el('tradeMsg');
            if (msg && !msg._waitingShown) { msg.textContent = 'Signed. Delivering WALDO…'; msg._waitingShown = true; }
          }
          if (++tries >= max) clearInterval(id);
        } catch (_) { clearInterval(id); }
      }, 1000);
    }

    function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
    function appendReceipt(msg) {
      try {
        const box = el('tradeMsg');
        const hash = window._waldoLastTx;
        const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
        box.innerHTML = `${msg}${link}`;
      } catch (_) {/* noop */ }
    }

    // Tabs
    document.querySelectorAll('#waldoTrade .tab').forEach(t => t.addEventListener('click', () => {
      document.querySelectorAll('#waldoTrade .tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      // auto-expand if collapsed
      const root = document.getElementById('waldoTrade');
      if (root.classList.contains('collapsed')) { collapsed = false; root.classList.remove('collapsed'); }
      el('panelXrpl').style.display = tab === 'xrpl' ? 'block' : 'none';
      el('panelFl').style.display = tab === 'fl' ? 'block' : 'none';
      try { loadMarket(); refreshSwapMarket(); } catch (_) { }
    }));

    // Market data
    async function loadMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo?_=${Date.now()}`, { cache: 'no-store' });
        const j = await r.json();
        const xrpPerWlo = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        el('priceXrp').textContent = (xrpPerWlo && isFinite(xrpPerWlo)) ? `${xrpPerWlo.toFixed(8)} XRP` : '—';
        const v = j?.volume24h; el('vol24').textContent = (v == null) ? '—' : (isFinite(v) ? `${Number(v).toLocaleString()} XRP` : String(v));
      } catch (e) { el('priceXrp').textContent = '—'; el('vol24').textContent = '—'; }
    }
    loadMarket(); setInterval(loadMarket, 15000);
    document.addEventListener('visibilitychange', () => { if (!document.hidden) { try { loadMarket(); refreshSwapMarket(); } catch (_) { } } });
    window.addEventListener('focus', () => { try { loadMarket(); refreshSwapMarket(); } catch (_) { } });

    // XUMM modal
    function xummOpen(title, data) {
      console.log('🚀 xummOpen called with title:', title, 'data:', data);
      const refs = data?.refs || data;
      const next = data?.next;
      el('xummTitle').textContent = title || 'Xaman';
      const m = el('xummModal');
      console.log('📱 Showing XUMM modal');
      m.style.display = 'block';
      const qr = el('xummQr'); const spin = el('xummLoad'); const hint = el('xummHint'); const link = el('xummLink');
      qr.style.display = 'none'; spin.style.display = 'block'; hint.style.display = 'none';
      if (isMobile) {
        el('xummDesktop').style.display = 'none'; el('xummMobile').style.display = 'flex';

        // The correct way to get the deep link for mobile
        let deep = refs?.qr_uri;

        // If qr_uri is not available, construct it manually from UUID
        if (!deep && data?.uuid) {
          // Use the standard XUMM deep link format that actually works
          deep = `https://xumm.app/sign/${data.uuid}`;
          console.log('🔧 Constructed XUMM web link from UUID:', deep);
        }

        console.log('🔗 Deep link extraction:', { refs, next, data, deep, uuid: data?.uuid });

        // Store deep link globally for copy functionality
        currentDeepLink = deep;
        // Show a direct link on mobile as well (in case the button is blocked by in-app browsers)
        if (link) {
          if (deep && deep !== '#' && deep !== '') {
            link.href = deep;
            link.textContent = 'Open in Xaman (link)';
            link.style.display = 'block';
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener');
          } else {
            link.style.display = 'none';
          }
        }


        // Set up mobile button click handler
        const mobileBtn = el('xummMobileBtn');
        if (mobileBtn) {
          const openDeep = (url) => {
            try { window.location.href = url; } catch (_) { }
            setTimeout(() => { try { window.open(url, '_self'); } catch (_) { } }, 200);
          };
          mobileBtn.onclick = () => {
            console.log('📱 Mobile Xaman button clicked, opening:', deep);

            if (deep && deep !== '#' && deep !== '') {
              console.log('🚀 Opening XUMM/Xaman with:', deep);
              openDeep(deep);
              showToast('Opening Xaman app...');
            } else {
              console.error('❌ No valid deep link found:', { deep, refs, next, data });
              showToast('Xaman link not available - please try again');
            }
          };
        }
      } else {
        el('xummDesktop').style.display = 'block'; el('xummMobile').style.display = 'none';
        qr.src = refs?.qr_png || refs?.qr; qr.style.display = 'block'; hint.style.display = 'block'; spin.style.display = 'none';
      }
      function showToast(msg) {
        const t = el('waldoToast'); if (!t) return;
        t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
        setTimeout(() => { t.style.display = 'none'; }, 1400);
      }
    }

    // Global connection helpers
    function setConnected(account) {
      connectedAccount = account || null;
      const s = el('connStatus'); const btn = document.getElementById('btnDisconnect');
      if (account) { const suffix = account.slice(-6); s.textContent = `Connected: …${suffix}`; btn.style.display = 'inline-flex'; }
      else { s.textContent = 'Not connected'; btn.style.display = 'none'; }
    }
    window.waldoDisconnect = function () {
      setConnected(null);
      try {
        const tls = el('tlStatus'); if (tls) tls.textContent = 'Trustline: —';
        const fa = el('fromAmount'); if (fa) fa.value = '';
        const ta = el('toAmount'); if (ta) ta.value = '';
        const min = el('swapMinOut'); if (min) min.textContent = '—';
        const imp = el('swapImpact'); if (imp) imp.textContent = '—';
        const msg = el('tradeMsg'); if (msg) msg.textContent = '';
      } catch (_) { }
      showToast('Disconnected');
    }
    async function checkTrustline(account) {
      try {
        const r = await fetch(`${API}/api/xrpl/trustline/status?account=${encodeURIComponent(account)}`, { cache: 'no-store' });
        const j = await r.json();
        trustlineStatus = !!j?.trustline;
        el('tlStatus').textContent = `Trustline: ${trustlineStatus ? 'Yes' : 'No'}`;
      } catch (_) {
        trustlineStatus = null;
        el('tlStatus').textContent = 'Trustline: ?';
      }
      return trustlineStatus;
    }



    window.xummClose = function () { el('xummModal').style.display = 'none'; }

    // Swap logic (global scope)
    let swapFrom = 'XRP'; let swapTo = 'WLO'; let swapSlip = 0; let swapMid = null;

    window.swapFlip = function () {
      const f = swapFrom; swapFrom = swapTo; swapTo = f;
      el('fromSymbol').textContent = swapFrom; el('toSymbol').textContent = swapTo;
      recomputeSwap();
    }

    async function refreshSwapMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo?_=${Date.now()}`, { cache: 'no-store' });
        const j = await r.json();
        swapMid = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        updateSwapPrice(); recomputeSwap();
      } catch (_) { }
    }

    function updateSwapPrice() {
      if (swapMid) {
        const priceTxt = (swapFrom === 'XRP') ? `${swapMid.toFixed(8)} XRP/WLO` : `${(1 / swapMid).toFixed(2)} WLO/XRP`;
        el('swapPrice').textContent = priceTxt;
      }
    }

    function recomputeSwap() {
      const amt = parseFloat(el('fromAmount').value);
      if (!isFinite(amt) || !swapMid) {
        el('toAmount').value = ''; el('swapMinOut').textContent = '—'; return;
      }
      const slip = swapSlip / 10000;
      if (swapFrom === 'XRP') {
        const out = amt / (swapMid * (1 + slip));
        el('toAmount').value = out.toFixed(2);
        el('swapMinOut').textContent = `${out.toFixed(2)} WLO`;
      } else {
        const out = amt * (swapMid * (1 - slip));
        el('toAmount').value = out.toFixed(6);
        el('swapMinOut').textContent = `${out.toFixed(6)} XRP`;
      }
    }

    // Initialize swap
    document.querySelectorAll('#waldoTrade .chip[data-slip]').forEach(b => b.addEventListener('click', () => {
      swapSlip = parseInt(b.getAttribute('data-slip'), 10) || 0;
      document.querySelectorAll('#waldoTrade .chip[data-slip]').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      recomputeSwap();
    }));
    el('fromAmount').addEventListener('input', recomputeSwap);
    refreshSwapMarket(); setInterval(refreshSwapMarket, 15000);

    window.waldoSwap = async function () {
      const amt = parseFloat(el('fromAmount').value);
      if (!isFinite(amt) || amt <= 0) return alert('Enter amount');
      const doSwap = async () => {
        const body = (swapFrom === 'XRP')
          ? { side: 'buy', amountXrp: amt, slippageBps: swapSlip, destination: 'rMFoici99gcnXMjKwzJWP2WGe9bK4E5iLL' }
          : { side: 'sell', amountWlo: amt, slippageBps: swapSlip, destination: 'rMFoici99gcnXMjKwzJWP2WGe9bK4E5iLL' };
        try {
          const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
          const j = await r.json();
          console.log('📱 Swap API Response:', j);
          if (!j.success) throw new Error(j.error || 'Trade failed');
          xummOpen('Swap', j);
          startTradeStatusPoll(j.uuid, 'Swap placed!', s => appendReceipt('Swap placed!'));
        } catch (e) {
          el('tradeMsg').textContent = 'Swap failed: ' + e.message;
        }
      };
      // Ensure connection and trustline automatically, then place the swap
      ensureConnectedThen(() => ensureTrustlineThen(() => doSwap()));
    }

    // Actions
    window.waldoConnect = async function () {
      console.log('🔗 waldoConnect called - user clicked Connect Xaman button');
      try {
        const r = await fetch(`${API}/api/login`);
        const j = await r.json();
        console.log('📱 API Response:', j);
        console.log('📱 Opening Xaman modal with full data:', j);
        xummOpen('Connect Xaman', j);  // Pass full response, not just refs
        startStatusPoll(j.uuid, 'Connected!', s => { /* could store s.account */ });
      } catch (e) {
        console.error('❌ Login failed:', e);
        alert('Login failed');
      }
      function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
      function appendReceipt(msg) {
        try {
          const box = el('tradeMsg');
          const hash = window._waldoLastTx;
          const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
          box.innerHTML = `${msg}${link}`;
        } catch (_) {/* noop */ }
      }
      // Inject receipts on buy/sell toasts (rely on _waldoLastTx set by status poll)
      const _oldShowToast = showToast;
      showToast = function (msg) { _oldShowToast(msg); if (/buy|sell|connected/i.test(msg) && window._waldoLastTx) { appendReceipt(msg); } }

    }

    window.waldoTrustline = async function () {
      try {
        const r = await fetch(`${API}/api/xrpl/trustline/create`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const j = await r.json();
        console.log('📱 Trustline API Response:', j);
        if (!j.success) throw new Error(j.error || 'Trustline failed');
        xummOpen('Add WALDO Trustline', j);  // Pass full response
      } catch (e) {
        alert('Trustline failed');
      }
    }

    // Simplified mobile experience - no extra buttons needed
  })();
</script>