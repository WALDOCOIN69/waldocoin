<!-- WALDO Trading Widget -->
<div id="waldoWidget" style="max-width:500px;margin:20px auto;background:#0a0c1a;border:1px solid #25c2a0;border-radius:12px;padding:20px;color:#fff;font-family:Arial,sans-serif;">
  <h3 style="text-align:center;color:#25c2a0;margin:0 0 20px 0;">WALDO Trading</h3>
  
  <div style="display:flex;gap:10px;margin-bottom:20px;">
    <button onclick="showXRPL()" style="flex:1;padding:10px;background:#25c2a0;color:#000;border:none;border-radius:6px;cursor:pointer;">XRPL DEX</button>
    <button onclick="showFL()" style="flex:1;padding:10px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer;">First Ledger</button>
  </div>
  
  <div id="xrplPanel">
    <div style="margin-bottom:15px;">
      <button onclick="connectWallet()" style="padding:10px 20px;background:#25c2a0;color:#000;border:none;border-radius:6px;cursor:pointer;">Connect Xaman</button>
      <span id="status" style="margin-left:15px;color:#ccc;">Not connected</span>
    </div>
    
    <div style="background:#111;padding:15px;border-radius:8px;margin-bottom:15px;">
      <div style="margin-bottom:10px;">
        <label>Amount (XRP):</label>
        <input type="number" id="xrpAmount" placeholder="1.0" style="width:100%;padding:8px;margin-top:5px;background:#222;color:#fff;border:1px solid #444;border-radius:4px;">
      </div>
      <button onclick="swapXRP()" style="width:100%;padding:12px;background:#25c2a0;color:#000;border:none;border-radius:6px;cursor:pointer;font-weight:bold;">Swap XRP → WLO</button>
    </div>
    
    <div id="price" style="text-align:center;color:#ccc;">Loading price...</div>
  </div>
  
  <div id="flPanel" style="display:none;text-align:center;">
    <p>Trade WLO on First Ledger exchange</p>
    <a href="https://firstledger.net/token/rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY/WLO" target="_blank" style="display:inline-block;padding:12px 24px;background:#25c2a0;color:#000;text-decoration:none;border-radius:6px;font-weight:bold;">Open First Ledger</a>
  </div>
</div>

<script>
function showXRPL() {
  document.getElementById('xrplPanel').style.display = 'block';
  document.getElementById('flPanel').style.display = 'none';
}

function showFL() {
  document.getElementById('xrplPanel').style.display = 'none';
  document.getElementById('flPanel').style.display = 'block';
}

async function connectWallet() {
  try {
    const r = await fetch('https://waldocoin-backend-api.onrender.com/api/login');
    const j = await r.json();
    document.getElementById('status').textContent = 'Opening Xaman...';
    if (/mobile/i.test(navigator.userAgent)) {
      window.location.href = j.next?.always || j.refs?.qr_uri;
    } else {
      alert('QR: ' + (j.refs?.qr_uri || 'Error'));
    }
  } catch (e) {
    alert('Connect failed: ' + e.message);
  }
}

async function swapXRP() {
  const amt = parseFloat(document.getElementById('xrpAmount').value);
  if (!amt || amt <= 0) return alert('Enter XRP amount');
  
  try {
    const r = await fetch('https://waldocoin-backend-api.onrender.com/api/xrpl/trade/offer', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({side: 'buy', amountXrp: amt, slippageBps: 200})
    });
    const j = await r.json();
    if (!j.success) throw new Error(j.error);
    
    if (/mobile/i.test(navigator.userAgent)) {
      window.location.href = j.next?.always || j.refs?.qr_uri;
    } else {
      alert('QR: ' + (j.refs?.qr_uri || 'Error'));
    }
  } catch (e) {
    alert('Swap failed: ' + e.message);
  }
}

// Load price
fetch('https://waldocoin-backend-api.onrender.com/api/market/wlo')
  .then(r => r.json())
  .then(j => {
    const price = j.xrpPerWlo || j.best?.mid;
    document.getElementById('price').textContent = price ? 
      'Price: ' + price.toFixed(8) + ' XRP/WLO' : 'Price: —';
  })
  .catch(() => {
    document.getElementById('price').textContent = 'Price: —';
  });
</script>
