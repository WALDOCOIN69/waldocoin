<!-- WALDO Dual Trading Widget: XRPL DEX + First Ledger (drop-in) -->
<div class="waldo-trade collapsed" id="waldoTrade">
  <div class="trade-head">
    <div class="title"><span class="accent">ðŸŸ¢</span> WALDO Trading</div>
    <div class="sub">Price: <span id="priceXrp">â€”</span> â€¢ Vol 24h: <span id="vol24">â€”</span></div>
    <div class="tabs">
      <button id="widgetToggle" class="toggle" aria-label="Toggle widget" title="Toggle"></button>
      <button class="tab active" data-tab="xrpl">XRPL DEX</button>
      <button class="tab" data-tab="fl">First Ledger</button>
    </div>
  </div>
  <div class="trade-body">
    <div class="panel" id="panelXrpl">
      <div class="row">
        <button class="btn" onclick="waldoConnect()">Connect Xaman</button>
        <button class="btn" onclick="waldoTrustline()">Add Trustline</button>
        <button class="btn" id="btnDisconnect" onclick="waldoDisconnect()" style="display:none;">Disconnect</button>
      </div>
      <div class="row status-row">
        <div id="connStatus" class="conn">Not connected</div>
        <div id="tlStatus" class="conn">Trustline: â€”</div>
      </div>
      <div class="swap-card">
        <div class="swap-row">
          <div class="token">
            <label>From</label>
            <div class="token-box">
              <span class="sym" id="fromSymbol">XRP</span>
              <input type="number" min="0" step="0.000001" id="fromAmount" placeholder="0.0" />
            </div>
          </div>
          <button class="flip" onclick="window.swapFlip()" title="Flip">â‡…</button>
          <div class="token">
            <label>To</label>
            <div class="token-box">
              <span class="sym" id="toSymbol">WLO</span>
              <input type="text" id="toAmount" placeholder="0" readonly />
            </div>
          </div>
        </div>
        <div class="chipbar">
          <span>Slippage:</span>
          <button class="chip" data-slip="0">0%</button>
          <button class="chip" data-slip="50">0.5%</button>
          <button class="chip" data-slip="100">1%</button>
          <button class="chip" data-slip="200">2%</button>
        </div>
        <div class="minline">Min receive: <span id="swapMinOut">â€”</span></div>
        <div class="subline">Price: <span id="swapPrice">â€”</span> â€¢ Impact: <span id="swapImpact">â€”</span></div>
        <div class="actions"><button class="btn buy" onclick="waldoSwap()">Swap</button></div>
      </div>
      <div id="tradeMsg" class="msg"></div>
    </div>

    <div class="panel" id="panelFl" style="display:none;">
      <div class="fl-card">
        <div class="fl-icon">ðŸ’±</div>
        <div class="fl-title">First Ledger</div>
        <div class="fl-sub">Trade WLO on First Ledger in a new tab</div>
        <div class="fl-actions">
          <a class="btn buy" target="_blank" rel="noopener"
            href="https://firstledger.net/token/rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY/WLO">Open First Ledger</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Xaman Modal -->
  <div id="xummModal" class="xumm-modal" style="display:none;" aria-label="Xaman modal">
    <div class="backdrop" onclick="xummClose()"></div>
    <div class="content">
      <button class="close" onclick="xummClose()">âœ•</button>
      <h4 id="xummTitle">XAMAN</h4>
      <div id="xummDesktop">
        <img id="xummQr" alt="Scan with Xaman"
          style="display:none; max-width:280px; border-radius:10px; box-shadow: 0 0 18px #25c2a055;" />
        <div id="xummLoad" class="spin" style="display:none;"></div>
        <p id="xummHint" class="hint" style="display:none;">Scan the QR with your Xaman app</p>
      </div>
      <div id="xummMobile" style="display:none; display:flex; flex-direction:column; gap:8px; align-items:center;">
        <a id="xummLink" class="btn" href="#" target="_self" rel="noopener">ðŸ‘‰ Tap to open Xaman</a>
        <div style="display:flex; gap:8px;">
          <button id="xummCopy" class="btn" type="button">Copy link</button>
          <button id="xummShowQr" class="btn" type="button">Show QR</button>
        </div>
        <small class="hint" style="color:#9adbcf; opacity:.9;">If the app doesnâ€™t open, copy the link and paste into
          Xaman.</small>
      </div>
    </div>
    <!-- Toast -->
    <div id="waldoToast" class="toast" style="display:none;">Done</div>
  </div>
</div>

<style>
  .waldo-trade {
    --mint: #25c2a0;
    --red: #ff6b6b;
    --line: #1a1a1a;
    --neonAqua: #00f7ff;
    --neonMagenta: #ff3df7;
    background: radial-gradient(600px 200px at 10% -10%, rgba(255, 61, 247, .10), transparent 60%),
      radial-gradient(600px 180px at 90% -10%, rgba(0, 247, 255, .10), transparent 60%),
      linear-gradient(180deg, #0a0c1a 0%, #0b0f23 100%);
    border: 1px solid #18213d;
    border-radius: 16px;
    box-shadow: 0 0 22px rgba(0, 247, 255, .08), 0 0 42px rgba(255, 61, 247, .06);
    max-width: 520px;
    margin: 14px auto;
    color: #eafff9;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overflow: hidden;
  }

  .trade-head {
    text-align: center;
    position: relative
  }

  .tabs {
    justify-content: center
  }

  .toggle {
    position: absolute;
    right: 8px;
    top: 8px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid #26335f;
    background: radial-gradient(circle, #00f7ff 0, #00f7ff 50%, transparent 51%);
    box-shadow: 0 0 10px rgba(0, 247, 255, .4);
    cursor: pointer
  }

  .collapsed .panel,
  .collapsed .status-row {
    display: none;
  }

  .collapsed .tabs {
    display: flex
  }

  .collapsed .trade-head {
    padding-bottom: 10px
  }

  .collapsed .trade-head {
    padding-bottom: 10px
  }

  .collapsed .tabs {
    display: flex
  }

  @media (max-width: 520px) {
    .waldo-trade {
      max-width: 94vw
    }
  }

  .trade-head {
    padding: 12px 16px 0
  }

  .title {
    position: relative;
    text-transform: uppercase;
    letter-spacing: .8px;
    font-weight: 1000;
    font-size: 18px;
    background: linear-gradient(90deg, var(--neonAqua), var(--neonMagenta), var(--neonAqua));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 300% 100%;
    animation: shimmer 5s linear infinite;
    text-shadow: 0 0 12px rgba(0, 247, 255, .35), 0 0 20px rgba(255, 61, 247, .25);
  }

  .title:after {
    content: "";
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    bottom: -6px;
    width: 60%;
    height: 3px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(0, 247, 255, .9), rgba(255, 61, 247, .9), rgba(0, 247, 255, .9));
    box-shadow: 0 0 10px rgba(0, 247, 255, .4), 0 0 16px rgba(255, 61, 247, .3);
    animation: shimmer 6s linear infinite;
  }

  @keyframes shimmer {
    0% {
      background-position: 0% 0
    }

    100% {
      background-position: -200% 0
    }
  }

  .sub {
    font-size: 13px;
    color: #bfeee3;
    margin-top: 6px
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-top: 10px
  }

  .tabs .tab {
    background: #0e1225;
    border: 1px solid #1d2859;
    color: #bfeef0;
    transition: transform .16s ease, box-shadow .16s ease, color .16s ease, border-color .16s ease;
    position: relative;
    overflow: hidden;
    cursor: pointer;
    --glowA: rgba(0, 247, 255, .32);
    --glowB: rgba(255, 61, 247, .28);
  }

  .tabs .tab::before {
    content: "";
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity .18s ease;
    background: radial-gradient(80% 80% at 30% 0%, var(--glowA), transparent 60%), radial-gradient(80% 80% at 70% 100%, var(--glowB), transparent 60%)
  }

  .tabs .tab:hover {
    border-color: #21d7ff;
    color: #eaffff;
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 0 16px rgba(0, 247, 255, .25), 0 0 28px rgba(255, 61, 247, .18);
  }

  .tabs .tab:active {
    transform: translateY(0) scale(0.99)
  }

  .tabs .tab:hover::before {
    opacity: 1
  }


  .status-row {
    margin-top: 4px;
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center
  }

  .conn {
    font-size: 12px;
    color: #9adbcf
  }

  /* Swap UI */
  .swap-card {
    position: relative;
    border: 1px solid #202a4e;
    border-radius: 12px;
    padding: 12px;
    background: linear-gradient(180deg, #0a0f26, #0b112d);
    box-shadow: inset 0 0 0 1px rgba(0, 247, 255, .05)
  }

  .swap-card:before,
  .swap-card:after {
    content: "";
    position: absolute;
    inset: -1px;
    border-radius: 12px;
    pointer-events: none
  }

  .swap-card:before {
    background: linear-gradient(90deg, transparent, rgba(0, 247, 255, .25), transparent);
    filter: blur(8px)
  }

  .swap-card:after {
    background: linear-gradient(90deg, transparent, rgba(255, 61, 247, .2), transparent);
    opacity: .7;
    mix-blend-mode: screen
  }

  .swap-row {
    display: flex;
    align-items: flex-end;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center
  }

  .token {
    flex: 1 1 260px
  }

  .token input {
    height: 36px
  }

  .token .sym {
    min-width: 46px;
    text-align: center
  }

  .swap-card .token-box {
    max-width: 240px
  }

  .swap-row {
    justify-content: center
  }

  .token-box {
    display: flex;
    align-items: center;
    gap: 8px;
    border: 1px solid #202a4e;
    border-radius: 12px;
    padding: 8px 10px;
    background: linear-gradient(180deg, #0a0f26, #0b112d);
    box-shadow: inset 0 0 0 1px rgba(0, 247, 255, .05), 0 0 14px rgba(0, 247, 255, .06);
    max-width: 100%;
  }

  .token .sym {
    font-weight: 900;
    color: #a9ffee
  }

  .token input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    color: #eafff9;
    font-size: 16px;
    appearance: textfield
  }

  /* Brighter field for FROM input */
  #fromAmount {
    background: linear-gradient(180deg, rgba(0, 247, 255, .08), rgba(255, 61, 247, .06));
    border-radius: 8px;
    padding: 0 8px
  }

  .token input::-webkit-outer-spin-button,
  .token input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0
  }

  .token #toAmount {
    opacity: .85
  }

  .flip {
    align-self: center;
    background: #111;
    border: 1px solid #1c1c1c;
    color: #c6fff0;
    border-radius: 10px;
    padding: 10px 12px;
    cursor: pointer
  }

  .subline {
    font-size: 12px;
    color: #9adbcf;
    margin-top: 6px
  }

  .actions {
    margin-top: 10px;
    display: flex;
    justify-content: center
  }

  .tabs .tab.active {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #07120f;
    border-color: rgba(37, 194, 160, .35)
  }

  .trade-body {
    padding: 12px 16px 16px
  }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px
  }

  .col {
    flex: 1 1 260px;
    background: #101010;
    border: 1px solid #1a1a1a;
    border-radius: 10px;
    padding: 12px
  }

  .chipbar {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    margin: 6px 0
  }

  .chipbar span {
    font-size: 12px;
    color: #9adbcf
  }

  .minline {
    font-size: 12px;
    color: #8ae9cf;
    margin: 6px 0 8px
  }


  .chip {
    background: #0c1513;
    border: 1px solid #16342b;
    color: #bff7ea;
    border-radius: 999px;
    padding: 6px 10px;
    font-weight: 800;
    cursor: pointer
  }

  .chip:hover {
    filter: brightness(1.08)
  }


  label {
    display: block;
    font-size: 12px;
    color: #c6fff0;
    margin-bottom: 6px
  }

  input[type=number] {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #1c1c1c;
    background: #0b0b0b;
    color: #eafff9
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #111;
    border: 1px solid #1c1c1c;
    color: #c6fff0;
    border-radius: 8px;
    padding: 10px 12px;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none
  }

  .btn.buy {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #06110E;
    border-color: rgba(37, 194, 160, .35)
  }

  /* First Ledger button neon hover like tabs */
  .fl-actions .btn.buy {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease
  }

  .fl-actions .btn.buy::before {
    content: "";
    position: absolute;
    inset: 0;
    opacity: 0;
    transition: opacity .18s ease;
    background: radial-gradient(80% 80% at 30% 0%, rgba(0, 247, 255, .32), transparent 60%),
      radial-gradient(80% 80% at 70% 100%, rgba(255, 61, 247, .28), transparent 60%)
  }

  .fl-actions .btn.buy:hover {
    border-color: #21d7ff;
    transform: translateY(-1px) scale(1.02);
    box-shadow: 0 0 16px rgba(0, 247, 255, .25), 0 0 28px rgba(255, 61, 247, .18)
  }

  .fl-actions .btn.buy:hover::before {
    opacity: 1
  }


  .btn.sell {
    background: linear-gradient(90deg, #ff8c8c, var(--red));
    color: #170a0a;
    border-color: rgba(255, 107, 107, .35)
  }

  .iframe-wrap {
    position: relative
  }

  .iframe-wrap iframe {
    width: 100%;
    height: 640px;
    border: 1px solid #1a1a1a;
    border-radius: 12px;
    background: #0b0b0b
  }

  .iframe-wrap .fallback {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0, 0, 0, .5);
    border: 1px dashed #333;
    border-radius: 12px
  }

  .msg {
    font-size: 13px;
    color: #bfeee3
  }

  /* Ensure modal content is clickable above backdrop */
  .xumm-modal .backdrop {
    z-index: 1
  }

  .xumm-modal .content {
    position: relative;
    z-index: 2;
    pointer-events: auto
  }

  .xumm-modal {
    position: fixed;
    inset: 0;
    z-index: 99999
  }

  .xumm-modal .backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, .8);
    backdrop-filter: blur(2px)
  }

  .xumm-modal .content {

    /* First Ledger link-only card (flashy) */
    .fl-card {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 10px;
      padding: 16px;
      border: 1px solid #202a4e;
      border-radius: 12px;
      background: linear-gradient(180deg, #0a0f26, #0b112d);
      box-shadow: inset 0 0 0 1px rgba(0, 247, 255, .05), 0 0 14px rgba(0, 247, 255, .06);

      .fl-card::before,
      .fl-card::after {
        content: "";
        position: absolute;
        inset: -1px;
        border-radius: 12px;
        pointer-events: none;
      }

      .fl-card::before {
        background: linear-gradient(90deg, transparent, rgba(0, 247, 255, .25), transparent);
        filter: blur(8px)
      }

      .fl-card::after {
        background: linear-gradient(90deg, transparent, rgba(255, 61, 247, .2), transparent);
        opacity: .7;
        mix-blend-mode: screen
      }


    }

    .fl-icon {
      font-size: 28px;
      filter: drop-shadow(0 0 10px rgba(37, 194, 160, .25))
    }

    .fl-title {
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 900;
      color: #c6fff0
    }

    .fl-sub {
      font-size: 13px;
      color: #bfeee3
    }

    .fl-actions .btn.buy {
      min-width: 220px
    }

    position: relative;
    margin: 10vh auto;
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 14px;
    padding: 20px;
    width: min(92vw, 500px);
    box-shadow: 0 0 24px rgba(37, 194, 160, .25)
  }

  .xumm-modal .close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    color: #9adbcf;
    font-size: 18px;
    cursor: pointer
  }

  .spin {
    border: 4px solid #1c1c1c;
    border-top: 4px solid var(--mint);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    animation: spin 1s linear infinite;
    margin: 10px auto 0
  }

  @keyframes spin {
    0% {
      transform: rotate(0)
    }

    100% {
      transform: rotate(360deg)
    }
  }

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 22px;
    transform: translateX(-50%);
    background: rgba(6, 17, 14, .95);
    color: #c6fff0;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #1a1a1a;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .35)
  }

  .toast.show {
    animation: toastPop .38s ease-out
  }

  @keyframes toastPop {
    0% {
      transform: translateX(-50%) scale(.96);
      opacity: 0
    }

    60% {
      transform: translateX(-50%) scale(1.04);
      opacity: 1
    }

    100% {
      transform: translateX(-50%) scale(1)
    }
  }
</style>

<script>
  (function () {
    const API = "https://waldocoin-backend-api.onrender.com";
    const el = id => document.getElementById(id);
    const isMobile = /iphone|android|ipad|mobile/i.test(navigator.userAgent);

    // Collapsible (start closed)
    const root = document.getElementById('waldoTrade');
    const toggle = document.getElementById('widgetToggle');
    let collapsed = true;
    function applyCollapsed() { root.classList.toggle('collapsed', collapsed); }
    if (toggle) toggle.addEventListener('click', () => { collapsed = !collapsed; applyCollapsed(); });
    applyCollapsed();

    // Toast & Status (top-level)
    function showToast(msg) {
      const t = el('waldoToast'); if (!t) return;
      t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
      setTimeout(() => { t.style.display = 'none'; }, 1400);
    }
    async function startStatusPoll(uuid, successMsg, onSuccess) {
      if (!uuid) return;
      const url = `${API}/api/login/status?uuid=${encodeURIComponent(uuid)}`;
      let tries = 0; const max = 300; // up to 5 mins
      const id = setInterval(async () => {
        try {
          const r = await fetch(url + `&_t=${Date.now()}`);
          const s = await r.json();
          if (s?.signed) { clearInterval(id); if (typeof onSuccess === 'function') try { onSuccess(s); } catch (_) { }; if (s?.txid) { window._waldoLastTx = s.txid; } showToast(successMsg || 'Success'); xummClose(); }
          if (++tries >= max) clearInterval(id);
        } catch (_) { clearInterval(id); }
      }, 1000);
    }
    function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
    function appendReceipt(msg) {
      try {
        const box = el('tradeMsg');
        const hash = window._waldoLastTx;
        const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
        box.innerHTML = `${msg}${link}`;
      } catch (_) {/* noop */ }
    }

    // Tabs
    document.querySelectorAll('#waldoTrade .tab').forEach(t => t.addEventListener('click', () => {
      document.querySelectorAll('#waldoTrade .tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      // auto-expand if collapsed
      const root = document.getElementById('waldoTrade');
      if (root.classList.contains('collapsed')) { collapsed = false; root.classList.remove('collapsed'); }
      el('panelXrpl').style.display = tab === 'xrpl' ? 'block' : 'none';
      el('panelFl').style.display = tab === 'fl' ? 'block' : 'none';
    }));

    // Market data
    async function loadMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo`, { cache: 'no-store' });
        const j = await r.json();
        const xrpPerWlo = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        el('priceXrp').textContent = (xrpPerWlo && isFinite(xrpPerWlo)) ? `${xrpPerWlo.toFixed(8)} XRP` : 'â€”';
        const v = j?.volume24h; el('vol24').textContent = (v == null) ? 'â€”' : (isFinite(v) ? Number(v).toLocaleString() : String(v));
      } catch (e) { el('priceXrp').textContent = 'â€”'; el('vol24').textContent = 'â€”'; }
    }
    loadMarket(); setInterval(loadMarket, 60_000);

    // Xaman modal
    function xummOpen(title, data) {
      const refs = data?.refs || data; const next = data?.next;
      el('xummTitle').textContent = title || 'Xaman';
      const m = el('xummModal'); m.style.display = 'block';
      const qr = el('xummQr'); const spin = el('xummLoad'); const hint = el('xummHint'); const link = el('xummLink');
      qr.style.display = 'none'; spin.style.display = 'block'; hint.style.display = 'none';
      if (isMobile) {
        // Mobile: do NOT show QR; force deep link via user gesture

        el('xummDesktop').style.display = 'none'; el('xummMobile').style.display = 'block';
        // Use universal link to open Xaman (most reliable)
        const universal = next?.always || refs?.qr_uri || '#';
        link.href = universal; link.rel = 'external noopener'; link.removeAttribute('target');
        // Hide spinner on mobile
        spin.style.display = 'none';

      } else {
        // Desktop: show QR
        el('xummDesktop').style.display = 'block'; el('xummMobile').style.display = 'none';
        qr.src = refs?.qr_png || refs?.qr; qr.style.display = 'block'; hint.style.display = 'block'; spin.style.display = 'none';
      }
      function showToast(msg) {
        const t = el('waldoToast'); if (!t) return;
        t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
        setTimeout(() => { t.style.display = 'none'; }, 1400);
      }
    }

    // Global connection helpers
    function setConnected(account) {
      const s = el('connStatus'); const btn = document.getElementById('btnDisconnect');
      if (account) { const suffix = account.slice(-6); s.textContent = `Connected: â€¦${suffix}`; btn.style.display = 'inline-flex'; }
      else { s.textContent = 'Not connected'; btn.style.display = 'none'; }
    }
    window.waldoDisconnect = function () { setConnected(null); showToast('Disconnected'); }
    async function checkTrustline(account) {
      try { const r = await fetch(`${API}/api/xrpl/trustline/status?account=${encodeURIComponent(account)}`, { cache: 'no-store' }); const j = await r.json(); el('tlStatus').textContent = `Trustline: ${j?.trustline ? 'Yes' : 'No'}`; }
      catch (_) { el('tlStatus').textContent = 'Trustline: ?'; }
    }


    async function startStatusPoll(uuid, successMsg) {
      if (!uuid) return;
      const url = `${API}/api/login/status?uuid=${encodeURIComponent(uuid)}`;
      let tries = 0; const max = 300; // up to 5 mins
      const id = setInterval(async () => {
        try {
          const r = await fetch(url + `&_t=${Date.now()}`);
          const s = await r.json();
          if (s?.signed) { clearInterval(id); showToast(successMsg || 'Success'); if (s?.txid) { window._waldoLastTx = s.txid; } if (s?.account) { setConnected(s.account); checkTrustline(s.account); } xummClose(); }
          if (++tries >= max) clearInterval(id);
        } catch (_) { clearInterval(id); }
      }, 1000);
    }

    window.xummClose = function () { el('xummModal').style.display = 'none'; }

    // Swap logic (global scope)
    let swapFrom = 'XRP'; let swapTo = 'WLO'; let swapSlip = 0; let swapMid = null;

    window.swapFlip = function () {
      const f = swapFrom; swapFrom = swapTo; swapTo = f;
      el('fromSymbol').textContent = swapFrom; el('toSymbol').textContent = swapTo;
      recomputeSwap();
    }

    async function refreshSwapMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo`, { cache: 'no-store' });
        const j = await r.json();
        swapMid = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        updateSwapPrice(); recomputeSwap();
      } catch (_) { }
    }

    function updateSwapPrice() {
      if (swapMid) {
        const priceTxt = (swapFrom === 'XRP') ? `${swapMid.toFixed(8)} XRP/WLO` : `${(1 / swapMid).toFixed(2)} WLO/XRP`;
        el('swapPrice').textContent = priceTxt;
      }
    }

    function recomputeSwap() {
      const amt = parseFloat(el('fromAmount').value);
      if (!isFinite(amt) || !swapMid) {
        el('toAmount').value = ''; el('swapMinOut').textContent = 'â€”'; return;
      }
      const slip = swapSlip / 10000;
      if (swapFrom === 'XRP') {
        const out = amt / (swapMid * (1 + slip));
        el('toAmount').value = out.toFixed(2);
        el('swapMinOut').textContent = `${out.toFixed(2)} WLO`;
      } else {
        const out = amt * (swapMid * (1 - slip));
        el('toAmount').value = out.toFixed(6);
        el('swapMinOut').textContent = `${out.toFixed(6)} XRP`;
      }
    }

    // Initialize swap
    document.querySelectorAll('#waldoTrade .chip[data-slip]').forEach(b => b.addEventListener('click', () => {
      swapSlip = parseInt(b.getAttribute('data-slip'), 10) || 0;
      document.querySelectorAll('#waldoTrade .chip[data-slip]').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      recomputeSwap();
    }));
    el('fromAmount').addEventListener('input', recomputeSwap);
    refreshSwapMarket(); setInterval(refreshSwapMarket, 60_000);

    window.waldoSwap = async function () {
      const amt = parseFloat(el('fromAmount').value);
      if (!isFinite(amt) || amt <= 0) return alert('Enter amount');
      const body = (swapFrom === 'XRP') ? { side: 'buy', amountXrp: amt, slippageBps: swapSlip } : { side: 'sell', amountWlo: amt, slippageBps: swapSlip };
      try {
        const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Trade failed');
        xummOpen('Swap', j.refs);
        startStatusPoll(j.uuid, 'Swap placed!', s => appendReceipt('Swap placed!'));
      } catch (e) {
        el('tradeMsg').textContent = 'Swap failed: ' + e.message;
      }
    }

    // Actions
    window.waldoConnect = async function () {
      try {
        const r = await fetch(`${API}/api/login`);
        const j = await r.json();
        if (isMobile) {
          const deep = j?.next?.always || j?.refs?.qr_uri || '#';
          if (deep && deep !== '#') { try { window.location.href = deep; } catch (_) { } return; }
        }
        xummOpen('Connect Xaman', j);
        startStatusPoll(j.uuid, 'Connected!', s => { /* could store s.account */ });
      } catch (e) { alert('Login failed'); }
      function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
      function appendReceipt(msg) {
        try {
          const box = el('tradeMsg');
          const hash = window._waldoLastTx;
          const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
          box.innerHTML = `${msg}${link}`;
        } catch (_) {/* noop */ }
      }
      // Inject receipts on buy/sell toasts (rely on _waldoLastTx set by status poll)
      const _oldShowToast = showToast;
      showToast = function (msg) { _oldShowToast(msg); if (/buy|sell|connected/i.test(msg) && window._waldoLastTx) { appendReceipt(msg); } }

    }
    // Min preview state
    let currentSlip = 0; let lastMid = null;
    async function refreshMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo`, { cache: 'no-store' });
        const j = await r.json();
        const xrpPerWlo = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        lastMid = xrpPerWlo || lastMid;
        el('priceXrp').textContent = (xrpPerWlo && isFinite(xrpPerWlo)) ? `${xrpPerWlo.toFixed(8)} XRP` : 'â€”';
        const v = j?.volume24h; el('vol24').textContent = (v == null) ? 'â€”' : (isFinite(v) ? Number(v).toLocaleString() : String(v));
        updateMins();
      } catch (_) { }
    }
    function updateMins() {
      const slip = currentSlip / 10000;
      if (lastMid && isFinite(lastMid)) {
        const bx = parseFloat(el('buyXrp').value);
        el('buyMinOut').textContent = (isFinite(bx) && bx > 0) ? (bx / (lastMid * (1 + slip))).toFixed(2) : 'â€”';
        const sw = parseFloat(el('sellWlo').value);
        el('sellMinOut').textContent = (isFinite(sw) && sw > 0) ? (sw * (lastMid * (1 - slip))).toFixed(6) : 'â€”';
      }
    }
    document.querySelectorAll('#waldoTrade .chip[data-slip]').forEach(b => b.addEventListener('click', () => { currentSlip = parseInt(b.getAttribute('data-slip'), 10) || 0; updateMins(); }));
    el('buyXrp').addEventListener('input', updateMins);
    el('sellWlo').addEventListener('input', updateMins);
    refreshMarket(); setInterval(refreshMarket, 60_000);

    window.waldoTrustline = async function () {
      try { const r = await fetch(`${API}/api/login/trustline-noripple`); const j = await r.json(); xummOpen('Add WALDO Trustline', j.refs); } catch (e) { alert('Trustline failed'); }
    }
    window.waldoBuy = async function () {
      const amount = parseFloat(el('buyXrp').value);
      // Mobile helpers: copy / show QR
      (function () {
        const copyBtn = document.getElementById('xummCopy');
        const showQrBtn = document.getElementById('xummShowQr');
        const qr = document.getElementById('xummQr');
        const link = document.getElementById('xummLink');
        if (copyBtn) copyBtn.addEventListener('click', async () => {
          try { await navigator.clipboard.writeText(link?.href || ''); showToast('Link copied'); } catch { showToast('Copy failed'); }
        });
        if (showQrBtn) showQrBtn.addEventListener('click', () => {
          // Force QR mode on mobile
          document.getElementById('xummDesktop').style.display = 'block';
          document.getElementById('xummMobile').style.display = 'none';
          qr.style.display = 'block';
        });
      })();

      if (!isFinite(amount) || amount <= 0) return alert('Enter XRP amount');
      try {
        const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ side: 'buy', amountXrp: amount }) });
        const j = await r.json(); if (!j.success) throw new Error(j.error || 'Trade failed'); xummOpen('Buy WALDO', j.refs); startStatusPoll(j.uuid, 'Buy placed!', s => appendReceipt('Buy placed!'));
      } catch (e) { el('tradeMsg').textContent = 'Buy failed: ' + e.message; }
    }
    window.waldoSell = async function () {
      const amount = parseFloat(el('sellWlo').value);
      if (!isFinite(amount) || amount <= 0) return alert('Enter WLO amount');
      try {
        const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ side: 'sell', amountWlo: amount }) });
        const j = await r.json(); if (!j.success) throw new Error(j.error || 'Trade failed'); xummOpen('Sell WALDO', j.refs); startStatusPoll(j.uuid, 'Sell placed!', s => appendReceipt('Sell placed!'));
      } catch (e) { el('tradeMsg').textContent = 'Sell failed: ' + e.message; }

    }
  })();
</script>