<!-- WALDO Dual Trading Widget: XRPL DEX + First Ledger (drop-in) -->
<div class="waldo-trade" id="waldoTrade">
  <div class="trade-head">
    <div class="title"><span class="accent">ðŸŸ¢</span> WALDO Trading</div>
    <div class="sub">Price: <span id="priceXrp">â€”</span> â€¢ Vol 24h: <span id="vol24">â€”</span></div>
    <div class="tabs">
      <button class="tab active" data-tab="xrpl">XRPL DEX</button>
      <button class="tab" data-tab="fl">First Ledger</button>
    </div>
  </div>
  <div class="trade-body">
    <div class="panel" id="panelXrpl">
      <div class="row">
        <button class="btn" onclick="waldoConnect()">Connect Xaman</button>
        <button class="btn" onclick="waldoTrustline()">Add Trustline</button>
      </div>
      <div class="row">
        <div class="col">
          <label>Buy (XRP)</label>
          <input type="number" min="0" step="0.1" id="buyXrp" placeholder="Amount in XRP" />
          <button class="btn buy" onclick="waldoBuy()">Buy WLO</button>
        </div>
        <div class="col">
          <label>Sell (WLO)</label>
          <input type="number" min="0" step="1" id="sellWlo" placeholder="Amount in WLO" />
          <button class="btn sell" onclick="waldoSell()">Sell WLO</button>
        </div>
      </div>
      <div id="tradeMsg" class="msg"></div>
    </div>

    <div class="panel" id="panelFl" style="display:none;">
      <div class="fl-card">
        <div class="fl-icon">ðŸ’±</div>
        <div class="fl-title">First Ledger</div>
        <div class="fl-sub">Trade WLO on First Ledger in a new tab</div>
        <div class="fl-actions">
          <a class="btn buy" target="_blank" rel="noopener"
            href="https://firstledger.net/token/rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY/WLO">Open First Ledger</a>
        </div>
      </div>
    </div>
  </div>

  <!-- XUMM Modal -->
  <div id="xummModal" class="xumm-modal" style="display:none;">
    <div class="backdrop" onclick="xummClose()"></div>
    <div class="content">
      <button class="close" onclick="xummClose()">âœ•</button>
      <h4 id="xummTitle">XUMM</h4>
      <div id="xummDesktop">
        <img id="xummQr" alt="Scan with XUMM"
          style="display:none; max-width:280px; border-radius:10px; box-shadow: 0 0 18px #25c2a055;" />
        <div id="xummLoad" class="spin" style="display:none;"></div>
        <p id="xummHint" class="hint" style="display:none;">Scan the QR with your XUMM app</p>
      </div>
      <div id="xummMobile" style="display:none;">
        <a id="xummLink" class="btn" href="#" target="_blank">ðŸ‘‰ Tap to open XUMM</a>
      </div>
    </div>
    <!-- Toast -->
    <div id="waldoToast" class="toast" style="display:none;">Done</div>
  </div>
</div>

<style>
  .waldo-trade {
    --mint: #25c2a0;
    --red: #ff6b6b;
    --line: #1a1a1a;
    background: #0f0f0f;
    border: 1px solid var(--line);
    border-radius: 14px;
    box-shadow: 0 10px 24px rgba(0, 0, 0, .35), 0 0 18px rgba(37, 194, 160, .12);
    max-width: 980px;
    margin: 12px auto;
    color: #eafff9;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
  }

  .trade-head {
    padding: 12px 16px 0
  }

  .title {
    text-transform: uppercase;
    letter-spacing: .5px;
    font-weight: 900;
    font-size: 14px;
    background: linear-gradient(90deg, #dffff7, #a6ffea, #dffff7);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    background-size: 200% 100%;
    animation: shimmer 6s linear infinite
  }

  @keyframes shimmer {
    0% {
      background-position: 0% 0
    }

    100% {
      background-position: -200% 0
    }
  }

  .sub {
    font-size: 13px;
    color: #bfeee3;
    margin-top: 6px
  }

  .tabs {
    display: flex;
    gap: 8px;
    margin-top: 10px
  }

  .tabs .tab {
    background: #111;
    border: 1px solid #1c1c1c;
    color: #bfeee3;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700
  }

  .tabs .tab.active {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #07120f;
    border-color: rgba(37, 194, 160, .35)
  }

  .trade-body {
    padding: 12px 16px 16px
  }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 10px
  }

  .col {
    flex: 1 1 260px;
    background: #101010;
    border: 1px solid #1a1a1a;
    border-radius: 10px;
    padding: 12px
  }

  label {
    display: block;
    font-size: 12px;
    color: #c6fff0;
    margin-bottom: 6px
  }

  input[type=number] {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #1c1c1c;
    background: #0b0b0b;
    color: #eafff9
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #111;
    border: 1px solid #1c1c1c;
    color: #c6fff0;
    border-radius: 8px;
    padding: 10px 12px;
    font-weight: 800;
    cursor: pointer;
    text-decoration: none
  }

  .btn.buy {
    background: linear-gradient(90deg, var(--mint), #19e39a);
    color: #06110E;
    border-color: rgba(37, 194, 160, .35)
  }

  .btn.sell {
    background: linear-gradient(90deg, #ff8c8c, var(--red));
    color: #170a0a;
    border-color: rgba(255, 107, 107, .35)
  }

  .iframe-wrap {
    position: relative
  }

  .iframe-wrap iframe {
    width: 100%;
    height: 640px;
    border: 1px solid #1a1a1a;
    border-radius: 12px;
    background: #0b0b0b
  }

  .iframe-wrap .fallback {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    background: rgba(0, 0, 0, .5);
    border: 1px dashed #333;
    border-radius: 12px
  }

  .msg {
    font-size: 13px;
    color: #bfeee3
  }

  .xumm-modal {
    position: fixed;
    inset: 0;
    z-index: 99999
  }

  .xumm-modal .backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, .8);
    backdrop-filter: blur(2px)
  }

  .xumm-modal .content {

    /* First Ledger link-only card (flashy) */
    .fl-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      gap: 8px;
      padding: 24px;
      border: 1px solid #1a1a1a;
      border-radius: 12px;
      background: radial-gradient(1200px 200px at 50% -10%, rgba(37, 194, 160, .15), transparent 60%), #0b0b0b
    }

    .fl-icon {
      font-size: 28px;
      filter: drop-shadow(0 0 10px rgba(37, 194, 160, .25))
    }

    .fl-title {
      text-transform: uppercase;
      letter-spacing: .5px;
      font-weight: 900;
      color: #c6fff0
    }

    .fl-sub {
      font-size: 13px;
      color: #bfeee3
    }

    .fl-actions .btn.buy {
      min-width: 220px
    }

    position: relative;
    margin: 10vh auto;
    background: #0d0d0d;
    border: 1px solid #1e1e1e;
    border-radius: 14px;
    padding: 20px;
    width: min(92vw, 500px);
    box-shadow: 0 0 24px rgba(37, 194, 160, .25)
  }

  .xumm-modal .close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: transparent;
    border: none;
    color: #9adbcf;
    font-size: 18px;
    cursor: pointer
  }

  .spin {
    border: 4px solid #1c1c1c;
    border-top: 4px solid var(--mint);
    border-radius: 50%;
    width: 32px;
    height: 32px;
    animation: spin 1s linear infinite;
    margin: 10px auto 0
  }

  @keyframes spin {
    0% {
      transform: rotate(0)
    }

    100% {
      transform: rotate(360deg)
    }
  }

  /* Toast */
  .toast {
    position: fixed;
    left: 50%;
    bottom: 22px;
    transform: translateX(-50%);
    background: rgba(6, 17, 14, .95);
    color: #c6fff0;
    padding: 10px 14px;
    border-radius: 10px;
    border: 1px solid #1a1a1a;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .35)
  }

  .toast.show {
    animation: toastPop .38s ease-out
  }

  @keyframes toastPop {
    0% {
      transform: translateX(-50%) scale(.96);
      opacity: 0
    }

    60% {
      transform: translateX(-50%) scale(1.04);
      opacity: 1
    }

    100% {
      transform: translateX(-50%) scale(1)
    }
  }
</style>

<script>
  (function () {
    const API = "https://waldocoin-backend-api.onrender.com";
    const el = id => document.getElementById(id);
    const isMobile = /iphone|android|ipad|mobile/i.test(navigator.userAgent);

    // Toast & Status (top-level)
    function showToast(msg) {
      const t = el('waldoToast'); if (!t) return;
      t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
      setTimeout(() => { t.style.display = 'none'; }, 1400);
    }
    async function startStatusPoll(uuid, successMsg, onSuccess) {
      if (!uuid) return;
      const url = `${API}/api/login/status?uuid=${encodeURIComponent(uuid)}`;
      let tries = 0; const max = 300; // up to 5 mins
      const id = setInterval(async () => {
        try {
          const r = await fetch(url + `&_t=${Date.now()}`);
          const s = await r.json();
          if (s?.signed) { clearInterval(id); if (typeof onSuccess === 'function') try { onSuccess(s); } catch (_) { }; if (s?.txid) { window._waldoLastTx = s.txid; } showToast(successMsg || 'Success'); xummClose(); }
          if (++tries >= max) clearInterval(id);
        } catch (_) { clearInterval(id); }
      }, 1000);
    }
    function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
    function appendReceipt(msg) {
      try {
        const box = el('tradeMsg');
        const hash = window._waldoLastTx;
        const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
        box.innerHTML = `${msg}${link}`;
      } catch (_) {/* noop */ }
    }

    // Tabs
    document.querySelectorAll('#waldoTrade .tab').forEach(t => t.addEventListener('click', () => {
      document.querySelectorAll('#waldoTrade .tab').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      el('panelXrpl').style.display = tab === 'xrpl' ? 'block' : 'none';
      el('panelFl').style.display = tab === 'fl' ? 'block' : 'none';
    }));

    // Market data
    async function loadMarket() {
      try {
        const r = await fetch(`${API}/api/market/wlo`, { cache: 'no-store' });
        const j = await r.json();
        const xrpPerWlo = (j?.xrpPerWlo && isFinite(j.xrpPerWlo)) ? j.xrpPerWlo : (j?.best?.mid || null);
        el('priceXrp').textContent = (xrpPerWlo && isFinite(xrpPerWlo)) ? `${xrpPerWlo.toFixed(8)} XRP` : 'â€”';
        const v = j?.volume24h; el('vol24').textContent = (v == null) ? 'â€”' : (isFinite(v) ? Number(v).toLocaleString() : String(v));
      } catch (e) { el('priceXrp').textContent = 'â€”'; el('vol24').textContent = 'â€”'; }
    }
    loadMarket(); setInterval(loadMarket, 60_000);

    // XUMM modal
    function xummOpen(title, refs) {
      el('xummTitle').textContent = title || 'XUMM';
      const m = el('xummModal'); m.style.display = 'block';
      const qr = el('xummQr'); const spin = el('xummLoad'); const hint = el('xummHint'); const link = el('xummLink');
      qr.style.display = 'none'; spin.style.display = 'block'; hint.style.display = 'none';
      if (isMobile) {
        el('xummDesktop').style.display = 'none'; el('xummMobile').style.display = 'block';
        link.href = refs?.qr_uri || '#';
      } else {
        el('xummDesktop').style.display = 'block'; el('xummMobile').style.display = 'none';
        qr.src = refs?.qr_png || refs?.qr; qr.style.display = 'block'; hint.style.display = 'block'; spin.style.display = 'none';
      }
      function showToast(msg) {
        const t = el('waldoToast'); if (!t) return;
        t.textContent = msg; t.style.display = 'block'; t.classList.remove('show'); void t.offsetWidth; t.classList.add('show');
        setTimeout(() => { t.style.display = 'none'; }, 1400);
      }
      async function startStatusPoll(uuid, successMsg) {
        if (!uuid) return;
        const url = `${API}/api/login/status?uuid=${encodeURIComponent(uuid)}`;
        let tries = 0; const max = 300; // up to 5 mins
        const id = setInterval(async () => {
          try {
            const r = await fetch(url + `&_t=${Date.now()}`);
            const s = await r.json();
            if (s?.signed) { clearInterval(id); showToast(successMsg || 'Success'); if (s?.txid) { window._waldoLastTx = s.txid; } xummClose(); }
            if (++tries >= max) clearInterval(id);
          } catch (_) { clearInterval(id); }
        }, 1000);
      }

    }
    window.xummClose = function () { el('xummModal').style.display = 'none'; }

    // Actions
    window.waldoConnect = async function () {
      try {
        const r = await fetch(`${API}/api/login`);
        const j = await r.json();
        xummOpen('Connect XUMM', j.refs);
        startStatusPoll(j.uuid, 'Connected!', s => { /* could store s.account */ });
      } catch (e) { alert('Login failed'); }
      function explorerLink(hash) { return `https://livenet.xrpl.org/transactions/${hash}`; }
      function appendReceipt(msg) {
        try {
          const box = el('tradeMsg');
          const hash = window._waldoLastTx;
          const link = hash ? ` <a href="${explorerLink(hash)}" target="_blank" rel="noopener">View tx</a>` : '';
          box.innerHTML = `${msg}${link}`;
        } catch (_) {/* noop */ }
      }
      // Inject receipts on buy/sell toasts (rely on _waldoLastTx set by status poll)
      const _oldShowToast = showToast;
      showToast = function (msg) { _oldShowToast(msg); if (/buy|sell|connected/i.test(msg) && window._waldoLastTx) { appendReceipt(msg); } }

    }
    window.waldoTrustline = async function () {
      try { const r = await fetch(`${API}/api/login/trustline-noripple`); const j = await r.json(); xummOpen('Add WALDO Trustline', j.refs); } catch (e) { alert('Trustline failed'); }
    }
    window.waldoBuy = async function () {
      const amount = parseFloat(el('buyXrp').value);
      if (!isFinite(amount) || amount <= 0) return alert('Enter XRP amount');
      try {
        const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ side: 'buy', amountXrp: amount }) });
        const j = await r.json(); if (!j.success) throw new Error(j.error || 'Trade failed'); xummOpen('Buy WALDO', j.refs); startStatusPoll(j.uuid, 'Buy placed!', s => appendReceipt('Buy placed!'));
      } catch (e) { el('tradeMsg').textContent = 'Buy failed: ' + e.message; }
    }
    window.waldoSell = async function () {
      const amount = parseFloat(el('sellWlo').value);
      if (!isFinite(amount) || amount <= 0) return alert('Enter WLO amount');
      try {
        const r = await fetch(`${API}/api/xrpl/trade/offer`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ side: 'sell', amountWlo: amount }) });
        const j = await r.json(); if (!j.success) throw new Error(j.error || 'Trade failed'); xummOpen('Sell WALDO', j.refs); startStatusPoll(j.uuid, 'Sell placed!', s => appendReceipt('Sell placed!'));
      } catch (e) { el('tradeMsg').textContent = 'Sell failed: ' + e.message; }
    }
  })();
</script>