<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WALDO Staking</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: #070a18;
      color: #eafff9;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .center {
      max-width: 840px;
      margin: 20px auto;
      padding: 0 12px;
    }

    .loader {
      margin: 60px auto;
      width: 32px;
      height: 32px;
      border: 3px solid #1a1a1a;
      border-top-color: #25c2a0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .hint {
      text-align: center;
      opacity: .8;
      font-size: 14px;
    }

    a {
      color: #9adbcf;
    }
  </style>
</head>

<body>
  <div class="center">
    <div id="mount">
      <div class="loader" aria-label="loading"></div>
      <p class="hint">Loading WALDO Stakingâ€¦</p>
    </div>
  </div>

  <script>
    (function () {
      const target = document.getElementById('mount');
      const ver = (window.WALDO_WIDGET_VERSION || Date.now());
      const localSrc = 'waldo-staking-widget.html?v=' + encodeURIComponent(ver);
      const rawSrc = 'https://raw.githubusercontent.com/WALDOCOIN69/waldocoin/main/WordPress/widgets/waldo-staking-widget.html?v=' + encodeURIComponent(ver);

      async function inject(html) {
        target.innerHTML = html;
        const scripts = target.querySelectorAll('script');
        let injectedOk = true;
        for (const old of scripts) {
          try {
            const s = document.createElement('script');
            s.defer = false; s.async = false;
            if (old.src) { s.src = old.src; } else { s.textContent = old.textContent; }
            for (const a of old.attributes) s.setAttribute(a.name, a.value);
            document.body.appendChild(s);
            old.remove();
          } catch (err) {
            injectedOk = false;
            console.warn('Script inject error:', err?.message || err);
          }
        }
        // Fallback: ensure widget opens and toggle works even if inner script didn't bind
        try {
          const stake = document.getElementById('waldoStake');
          if (stake) stake.classList.remove('collapsed');
          const toggle = document.getElementById('stakeToggle');
          if (toggle) {
            toggle.addEventListener('click', () => {
              const root = document.getElementById('waldoStake');
              if (root) root.classList.toggle('collapsed');
            }, { passive: true });
          }
        } catch (_) { }
        return injectedOk;
      }

      async function loadAndInject(urlPrimary, urlFallback) {
        try {
          const r = await fetch(urlPrimary, { cache: 'no-store' });
          if (!r.ok) throw new Error('HTTP ' + r.status);
          const html = await r.text();
          const ok = await inject(html);
          // If any inline script fails to eval, fallback to raw GitHub copy
          if (!ok) throw new Error('Inline script eval failed');
        } catch (e) {
          console.warn('Primary widget failed, trying fallback:', e.message);
          try {
            const r2 = await fetch(urlFallback, { cache: 'no-store' });
            if (!r2.ok) throw new Error('HTTP ' + r2.status);
            const html2 = await r2.text();
            await inject(html2);
          } catch (e2) {
            target.innerHTML = '<p class="hint">Failed to load widget (' + e2.message + ').</p>' +
              '<p class="hint">Open the raw widget file: <a href="https://raw.githubusercontent.com/WALDOCOIN69/waldocoin/main/WordPress/widgets/waldo-staking-widget.html" target="_blank" rel="noopener">waldo-staking-widget.html</a></p>';
          }
        }
      }

      // Define safe placeholders so clicks before scripts load won't error
      (function () {
        const names = ['stakeConnect', 'stakeTrustline', 'stakeDisconnect', 'stakeLoadInfo', 'ltSetMax', 'createLongTermStake', 'redeemStake'];
        const mk = (name) => function () {
          const args = arguments;
          const tryCall = () => {
            const f = window[name];
            if (typeof f === 'function' && f !== mk) return f.apply(window, args);
            setTimeout(tryCall, 300);
          };
          tryCall();
        };
        for (const n of names) { if (typeof window[n] !== 'function') window[n] = mk(n); }
      })();


      loadAndInject(localSrc, rawSrc);
    })();
  </script>
</body>

</html>