
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>WALDOcoin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <style>
html, body {
  font-family: 'Inter', sans-serif;
  background-image: url("https://waldocoin.live/wp-content/uploads/2025/05/1737843965137.jpg") !important;
  background-color: #000 !important;
  background-size: 200px 200px !important;
  background-repeat: repeat !important;
  background-attachment: fixed !important;
  margin: 0;
  padding: 0;
  min-height: 100vh;
  overflow-y: auto !important;
  overflow-x: hidden;
}

.dashboard-title-card {
  background: #000;
  border-radius: 18px;
  box-shadow: 0 0 22px #25c2a0;
  max-width: 650px;
  margin: 32px auto 18px auto;
  padding: 34px 16px 20px 16px;
  text-align: center;
  z-index: 10;
  position: relative;
}

.dashboard-title {
  font-size: 2.7rem;
  color: #25c2a0;
  font-weight: 900;
  letter-spacing: 1.5px;
  margin: 0 0 8px 0;
  text-shadow: 0 2px 24px #25c2a099, 0 1px 0 #fff;
}

.dashboard-subtitle {
  color: #fff;
  font-size: 1.18rem;
  font-weight: 400;
  margin-bottom: 0;
  opacity: 0.8;
  text-shadow: 0 1px 8px #25c2a055;
}

.instruction-card {
  background: #111 !important;
  color: #fff;
  border-radius: 14px;
  box-shadow: 0 0 18px #25c2a044;
  max-width: 600px;
  margin: 0 auto 32px auto;
  padding: 28px 24px;
  text-align: center;
  font-size: 1.15rem;
  position: relative;
  z-index: 9;
}
.instruction-card h2 {
  color: #25c2a0;
  margin-top: 0;
  font-weight: 700;
  letter-spacing: 1px;
}
.instruction-card ul {
  padding: 0;
  margin: 0;
  list-style: none;
}
.instruction-card li {
  margin-bottom: 12px;
  line-height: 1.7;
  font-size: 1.1em;
}

/* Grid Container for Cards */
.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 30px;
  margin: 0 auto;
  padding: 40px 10px;
  box-sizing: border-box;
  max-width: 1400px;
  width: 100%;
}    /* Responsive! */
  .dashboard-title-card, .instruction-card {
    max-width: 98vw;
    padding-left: 8px;
    padding-right: 8px;
  }
  .twitter-link-container {
    max-width: 96vw;
  }


/* Card Styles */
.card {
  background: #111;
  color: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
  animation: fadeInUp 0.8s ease;
  position: relative;
}
.big-card, .battle-arena, .dao-voting-card {
  grid-column: 1 / -1;
}

.reward-logic-table {
  grid-column: 1 / -1;
  width: 100%;
  margin: 0;
  padding: 0; /* or padding: 0 18px; if you want some space inside */
  box-sizing: border-box;
}
.reward-logic-table table {
  width: 100%;
  table-layout: fixed;
  border-collapse: collapse;
}

.reward-logic-table th,
.reward-logic-table td {
  padding: 14px 8px;
  text-align: center;
  white-space: nowrap;
  font-size: 1.1em;
  /* Optional: */
  /* border-bottom: 1px solid #333; */
}

/* Stretch each column equally */
.reward-logic-table th,
.reward-logic-table td {
  width: 12.5%;  /* 8 columns: 100%/8 = 12.5% */
}

/* Optionally, let first column a bit smaller and others bigger */
.reward-logic-table th:first-child,
.reward-logic-table td:first-child {
  width: 10%;
}
.reward-logic-table th:last-child,
.reward-logic-table td:last-child {
  width: 16%;
}
.tooltip-wrapper {
  position: relative;
  display: inline-block;
}

.tooltip-icon {
  background: #25c2a0;
  color: black;
  font-size: 15px;
  font-weight: bold;
  padding: 2px 7px;
  border-radius: 50%;
  cursor: pointer;
  margin-left: 8px;
}

.tooltip-text {
  visibility: hidden;
  opacity: 0;
  width: 240px;
  background-color: #111;
  color: #25c2a0;
  text-align: center;
  border-radius: 6px;
  padding: 10px 14px;
  position: absolute;
  z-index: 10;
  left: 50%;
  top: 120%;
  margin-left: -120px;
  transition: opacity 0.3s, visibility 0.3s;
  font-size: 1.03em;
  box-shadow: 0 0 10px #25c2a0;
}

/* Show on hover */
.tooltip-wrapper:hover .tooltip-text,
.tooltip-wrapper:focus-within .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* Twitter Link (Input + Button) */
.twitter-link-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin: 28px auto 18px auto;
  width: 100%;
  max-width: 350px;
}
.input-style {
  width: 100%;
  padding: 13px 16px;
  border-radius: 8px;
  background: #222;
  color: white;
  border: 1.5px solid #25c2a0;
  font-size: 17px;
  font-weight: 600;
  box-shadow: 0 0 8px #25c2a022;
}
.button-style {
  width: 100%;
  max-width: 360px;
  padding: 14px 0;
  border-radius: 8px;
  background: linear-gradient(90deg, #25c2a0 30%, #ff2626 100%);
  color: #fff;
  font-weight: bold;
  font-size: 18px;
  border: none;
  margin: 0;
  cursor: pointer;
  box-shadow: 0 0 8px #25c2a0bb;
  transition: background 0.2s, box-shadow 0.2s;
  letter-spacing: 1px;
}
.button-style:hover {
  background: linear-gradient(90deg, #1ba97b 20%, #ff5252 100%);
  box-shadow: 0 0 16px #25c2a0;
}

/* General Element Styles */
.card h1, .card h2, .card h3, .battle-arena h2 {
  color: #25c2a0;
  text-align: center;
  font-weight: bold;
}
.level-title {
  margin: 10px 0;
  font-weight: bold;
  color: #25c2a0;
}
.level-title.level-1 { color: #ff2626; }
.level-title.level-2 { color: #298cf5; }
.level-title.level-3 { color: #ff930e; }
.level-title.level-4 { color: #63f707; }
.level-title.level-5 { color: rgb(255, 196, 0); }

.level-icon {
  width: 80px;
  height: auto;
  display: block;
  margin: 10px auto;
  border-radius: 8px;
}
#userLevelIcon {
  width: 100px;
  height: auto;
  margin: 10px auto;
  display: block;
}
.wallet-address {
  text-align: center;
  margin-bottom: 30px;
}
.disconnect-btn {
  display: block;
  margin: 0 auto 20px;
  background: red;
  color: white;
  padding: 8px 18px;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
}

/* Battle Arena Styles */
.battle-arena {
  background: #111;
  border-radius: 18px;
  box-shadow: 0 0 18px #25c2a0;
  padding: 40px 24px 30px 24px;
  text-align: center;
  margin: 0 0 36px 0;
}
.battle-memes-container {
  display: flex;
  justify-content: space-around;
  gap: 30px;
  flex-wrap: wrap;
}
.battle-memes-container .flex-item {
  flex: 1;
  min-width: 180px;
  max-width: 280px;
  background: #191919;
  border-radius: 12px;
  padding: 16px;
  margin: 0 12px;
  box-shadow: 0 0 12px #222;
  text-align: center;
}
@media (max-width: 900px) {}
  .battle-memes-container {
    flex-direction: column;
    align-items: center;
  }
  .battle-memes-container .flex-item {
    max-width: 95vw;
    margin: 10px 0;
  }
.battle-timer {
  margin-top: 20px;
  font-weight: bold;
  font-size: 2.2rem;
  color: #25c2a0;
  text-align: center;
  letter-spacing: 1px;
  text-shadow: 0 0 14px #25c2a088, 0 2px 0 #000;
  animation: pulseTimer 2s infinite;
}
@keyframes pulseTimer {
  0%   { color: #25c2a0; }
  50%  { color: #fff; }
  100% { color: #25c2a0; }
}

.battle-result { font-weight: bold; font-size: 16px; color: gold; margin-top: 10px; }
.battle-notification {
  display: none;
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #fb2f2f;
  color: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: 0 0 15px rgba(251, 47, 47, 0.6);
  z-index: 999;
  animation: pulse 2s infinite;
  cursor: pointer;
}
.notification-banner {
  background: #111;
  color: #25c2a0;
  text-align: center;
  padding: 16px 0;
  border-radius: 10px;
  margin-bottom: 20px;
  font-size: 1.18rem;
  font-weight: 600;
}

/* Miscellaneous Styles */
.progress-bar { width: 100%; height: 12px; }
#levelProgress { width: 100%; height: 20px; }
  /* max-width: 90%; */
  /* max-height: 90%; */
  /* border-radius: 12px; */
  /* box-shadow: 0 0 20px #fb2f2f; */
.dao-voting-card { box-shadow: 0 0 12px #ffcc00; }
.margin-top-0 { margin-top: 0; }
.margin-top-20 { margin-top: 20px; }
.meme-thumb {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  transition: transform 0.3s, box-shadow 0.3s;
}
.meme-thumb:hover {
  transform: scale(1.1);
  box-shadow: 0 0 10px #fb2f2f;
}
.waldo-promo-img {
  width: 100%;
  border-radius: 8px;
}
.waldo-total-earned-display {
  font-size: 24px;
  font-weight: bold;
  text-align: center;
}
.pagination {
  display: flex;
  justify-content: center;
  gap: 5px;
  margin-top: 15px;
}
.pagination button {
  padding: 5px 10px;
  border: none;
  background: transparent;
  color: white;
  border-radius: 4px;
  cursor: pointer;
}
.meme-score {
  font-size: 60px;
  font-weight: bold;
  color: #25c2a0;
  transition: all 0.5s;
}
.xp-stats-card {
  background: #111;
  color: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
}
.flex-column-center {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.centered-flex-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-bottom: 10px;
}
.overflow-auto { overflow-x: auto; }
.activity-feed, .leaderboard-list { list-style: none; padding: 0; font-size: 16px; }
.leaderboard-container { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px; }
.flex-item { flex: 1; min-width: 300px; }
.info-text { font-size: 14px; color: #aaa; margin-top: 10px; }
.toast { background: #191919; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 0 8px #25c2a055; margin-top: 12px; font-weight: 600; font-size: 1.09em; }
.hidden { display: none !important; }
.dismiss-btn {
  margin-left: 20px;
  background: transparent;
  border: 1px solid #25c2a0;
  color: #25c2a0;
  padding: 4px 10px;
  border-radius: 6px;
  cursor: pointer;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(40px);}
  to { opacity: 1; transform: translateY(0);}
}
@keyframes pulseBanner {
  0% { box-shadow: 0 0 10px #25c2a0; }
  50% { box-shadow: 0 0 20px #25c2a0; }
  100% { box-shadow: 0 0 10px #25c2a0; }
}
/* Make the table fill the card and space headers/cells */
.card table,
.reward-logic-table table {
  width: 100%;
  table-layout: auto;         /* Let columns size naturally */
  border-collapse: separate;
  border-spacing: 0;
}

.card th, .card td,
.reward-logic-table th, .reward-logic-table td {
  padding: 14px 12px;         /* Adds horizontal and vertical space */
  text-align: center;
  vertical-align: middle;
  font-size: 1.07em;
  white-space: nowrap;
}

.card th,
.reward-logic-table th {
  background: #161616;
  color: #25c2a0;
  font-weight: 700;
  font-size: 1.11em;
  letter-spacing: 0.03em;
  border-bottom: 2px solid #222;
}

.card td,
.reward-logic-table td {
  border-bottom: 1px solid #232323;
}

.card tr:last-child td,
.reward-logic-table tr:last-child td {
  border-bottom: none;
}

/* Responsive: Let table scroll horizontally on small screens */
.overflow-auto {
  overflow-x: auto;
  width: 100%;
}

/* Optional: Make Thumbnail column wider */
.card td:first-child, .card th:first-child {
  min-width: 90px;
}
.battle-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  align-items: center;
  margin-bottom: 24px;
}
@media (max-width: 700px) {
  .battle-actions {
    flex-direction: column;
    align-items: stretch;
  }
}
#claimBlock button { min-width: 150px; }
#waldoNotification {
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99999;
  min-width: 270px;
  max-width: 92vw;
  background: #111;
  color: #fff;
  border-radius: 10px;
  box-shadow: 0 0 18px #25c2a0aa;
  padding: 18px 32px;
  font-size: 1.17rem;
  font-weight: 600;
  opacity: 0.98;
  transition: opacity 0.4s;
}
#waldoNotification .dismiss-btn {
  margin-left: 24px;
  background: transparent;
  border: 1.5px solid #25c2a0;
  color: #25c2a0;
  font-size: 1rem;
  font-weight: bold;
  padding: 6px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.18s, color 0.18s;
}
#waldoNotification .dismiss-btn:hover {
  background: #25c2a0;
  color: #111;
}
.nft-modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.92);
  z-index: 10001;
  align-items: center;
  justify-content: center;
}
.nft-modal[style*="display: block"] {
  display: flex !important;
}
.close-nft-modal {
  position: absolute;
  top: 24px;
  right: 36px;
  color: #fff;
  font-size: 3rem;
  cursor: pointer;
  font-weight: bold;
  z-index: 10002;
}
.nft-modal-image {
  max-width: 96vw;
  max-height: 80vh;
  border-radius: 18px;
  box-shadow: 0 0 40px #25c2a0;
}

.battle-leaderboard-table {
  width: 100%;
  text-align: left;
}
</style>
</head>
<body>

    <!-- WALDO Dashboard Title -->
  <div>
    <div class="dashboard-title-card">
      <h1 class="dashboard-title">WALDOcoin Dashboard</h1>
      <p class="dashboard-subtitle">Track your memes, earn rewards, and battle for the leaderboard.</p>
    </div>
<!-- Instructions Card -->
  </div>
  <div class="instruction-card">
    <h2>üöÄ How to Earn WALDO</h2>
    <ul>
      <li>üñº Post a meme on Twitter with the hashtag <strong>#WaldoMeme</strong></li>
      <li>üîó Link your Twitter handle to your WALDO wallet below</li>
      <li>üìä Watch your meme earn XP and rewards</li>
      <li>üèÜ Claim or stake your rewards on the dashboard</li>
      <li>üî• Mint your meme as an NFT when it hits 60 XP</li>
    </ul>
  </div>
  <!-- Notification bar -->
  <div id="waldoNotification">
    <span id="waldoMessage">üëã Welcome back! Ready to earn some WALDO?</span>
<button type="button" onclick="dismissWaldoNotification()" class="dismiss-btn">Dismiss</button>
  </div>
    <div class="container">
    <!-- WELCOME CARD + LINK TWITTER ACCOUNT -->
    <div class="card big-card">
      <button type="button" onclick="logoutWallet()" class="disconnect-btn">üîå Disconnect</button>
      <p id="walletAddress" class="wallet-address">Wallet: Loading...</p>
      <h3 class="center-text">üîó Link Twitter Account</h3>
      <div class="twitter-link-container">
        <input type="text" id="twitterHandleInput" placeholder="Enter Twitter handle" class="input-style">
        <button id="linkButton" type="button" class="button-style">Link Twitter</button>
      </div>
      <h2>üéÆ Member Level</h2>
      <img id="userLevelIcon" alt="Level Icon" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png">
      <p id="userLevelTitle" class="center-text level-title">Loading...</p>
      <progress id="levelProgress" max="100" value="0"></progress>
      <p id="xpToNextLevel" class="center-text">...</p>
    </div>

    <!-- XP Trends -->
    <div class="card">
      <h2>üìä Meme XP Trends</h2>
      <canvas height="200" id="xpChart"></canvas>
    </div>
    <!-- Social Stats -->
    <div class="card">
      <h2>üì± Social Stats</h2>
      <p><strong>üî• Top Meme:</strong> <span id="socialHandle">Loading...</span></p>
      <p><strong>üë• Followers:</strong> <span id="socialFollowers">‚Äî</span></p>
      <p><strong>üî• Total Likes:</strong> <span id="totalLikes">Loading...</span></p>
      <p><strong>üèÜ Top Meme Likes:</strong> <span id="topMemeLikes">Loading...</span></p>
      <p><strong>üñºÔ∏è Top Meme Preview:</strong></p>
      <img id="topMemeImage" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="Top Meme" class="meme-thumb">
      <p><a id="topMemeLink" href="#" target="_blank" class="xrpl-link-green">üîó View Meme</a></p>
    </div>
    <!-- Enhanced XP Level System -->
    <div class="card xp-stats-card" id="userLevelCard">
      <h3>üéÆ Level Progression</h3>
      <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
        <div style="flex: 1;">
          <div style="font-size: 1.2em; color: #25c2a0; font-weight: bold;" id="levelDisplay">
            Loading...
          </div>
          <div style="color: #ccc; font-size: 0.9em;" id="levelDetails">
            Loading...
          </div>
        </div>
      </div>
      <div style="background: #333; border-radius: 10px; height: 8px; margin: 10px 0;">
        <div id="levelProgressBar" style="background: linear-gradient(90deg, #25c2a0, #00ff88); height: 100%; border-radius: 10px; width: 0%; transition: width 0.5s ease;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #aaa;">
        <span id="currentLevelXP">0 XP in current level</span>
        <span id="nextLevelXP">0 XP to next</span>
      </div>
    </div>

    <!-- XP Stats (Legacy) -->
    <div class="card xp-stats-card">
      <h3>üß† WALDO XP Stats</h3>
      <p><strong>Level:</strong> <span id="waldoLevel">Loading...</span></p>
      <p><strong>Title:</strong> <span id="waldoTitle">Loading...</span></p>
      <p><strong>XP:</strong> <span id="waldoXP">Loading...</span></p>
      <p><strong>Likes:</strong> <span id="waldoLikes">Loading...</span></p>
      <p><strong>Retweets:</strong> <span id="waldoRetweets">Loading...</span></p>
      <p><strong>Minted Memes:</strong> <span id="waldoMemes">Loading...</span></p>
      <p><strong>Battles Won:</strong> <span id="waldoBattles">Loading...</span></p>
      <p><strong>Referrals:</strong> <span id="waldoReferrals">Loading...</span></p>
      <p><strong>Next Level In:</strong> <span id="xpToNextLevelStats">Loading...</span></p>
    </div>
    <!-- Total WALDO Earned -->
    <div class="card">
      <h2>üí∞ Total WALDO Earned</h2>
      <p id="waldoTotalEarnedDisplay" class="waldo-total-earned-display">Loading...</p>
    </div>

    <!-- Staking Positions -->
    <div class="card" id="stakingCard">
      <h3>üè¶ Staking Positions</h3>
      <div style="margin: 15px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
          <div>
            <div style="color: #25c2a0; font-weight: bold;" id="totalStaked">0 WALDO</div>
            <div style="font-size: 0.85em; color: #aaa;">Total Staked</div>
          </div>
          <div>
            <div style="color: #00ff88; font-weight: bold;" id="totalRewards">0 WALDO</div>
            <div style="font-size: 0.85em; color: #aaa;">Total Rewards</div>
          </div>
        </div>
        <div id="stakingPositions">
          <div style="color: #aaa; text-align: center; padding: 20px;">No active stakes</div>
        </div>
        <div style="margin-top: 15px; text-align: center;">
          <button type="button" onclick="showStakingModal()" class="button-style">üè¶ New Stake</button>
        </div>
      </div>
    </div>
    <!-- WALDO Promo Media -->
    <div class="card">
      <img alt="WALDO Promo" src="https://waldocoin.live/wp-content/uploads/2025/03/1737843965515-1.webp" class="waldo-promo-img">
      <h1>Use #WaldoMeme on Tweets for Rewards.</h1>
    </div>
    <!-- Meme XP Score -->
    <div class="card full-width-card center-text">
      <h2>üéØ Your Meme XP Score</h2>
      <p id="memeScoreDisplay" class="meme-score">0</p>
    </div>
    <!-- WALDO Conversion Rate -->
    <div class="card">
      <h2>üí∏ WALDO Conversion Rate</h2>
      <p id="waldoConversion" class="waldoConversionRate text-center">Loading...</p>
      <p id="waldoEarnings" class="text-center">Loading...</p>
      <img id="topMemeImg" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="Top Meme">
    </div>
    <!-- Referral Program -->
    <div class="card">
      <h2>ü§ù Referral Program</h2>
      <p class="center-text">Share your referral link to earn rewards when friends use #WaldoMeme.</p>
      <div class="flex-column-center">
        <input id="referralLink" readonly type="text" class="input-style">
        <button type="button" onclick="copyReferral()" class="button-style">Copy Referral Link</button>
        <p id="copyStatus" class="twitter-link-status"></p>
        <p class="centered-text">üë• Referrals: <strong id="refCount">0</strong></p>
      </div>
    </div>

    <!-- Tokenomics Dashboard -->
    <div class="card" id="tokenomicsCard">
      <h3>üí∞ Tokenomics</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
        <div style="background: #222; padding: 12px; border-radius: 8px;">
          <div style="color: #25c2a0; font-weight: bold;" id="airdropsClaimed">0/1000</div>
          <div style="font-size: 0.85em; color: #aaa;">Airdrops Claimed</div>
        </div>
        <div style="background: #222; padding: 12px; border-radius: 8px;">
          <div style="color: #ff6b6b; font-weight: bold;" id="dailyBurns">0</div>
          <div style="font-size: 0.85em; color: #aaa;">Daily Burns (WALDO)</div>
        </div>
        <div style="background: #222; padding: 12px; border-radius: 8px;">
          <div style="color: #ffd93d; font-weight: bold;" id="totalBattles">0</div>
          <div style="font-size: 0.85em; color: #aaa;">Total Battles</div>
        </div>
        <div style="background: #222; padding: 12px; border-radius: 8px;">
          <div style="color: #6bcf7f; font-weight: bold;" id="waldoDistributed">0M</div>
          <div style="font-size: 0.85em; color: #aaa;">WALDO Distributed</div>
        </div>
      </div>
    </div>

    <!-- Security Status -->
    <div class="card" id="securityCard">
      <h3>üõ°Ô∏è Security Status</h3>
      <div style="margin: 15px 0;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
          <div id="securityIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #00ff88;"></div>
          <span id="securityStatus" style="color: #00ff88; font-weight: bold;">CLEAN</span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div style="background: #222; padding: 10px; border-radius: 6px;">
            <div style="color: #25c2a0;" id="violationCount">0</div>
            <div style="font-size: 0.8em; color: #aaa;">Violations</div>
          </div>
          <div style="background: #222; padding: 10px; border-radius: 6px;">
            <div style="color: #00ff88;" id="accountStatus">ACTIVE</div>
            <div style="font-size: 0.8em; color: #aaa;">Status</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Recent Activity -->
    <div class="card">
      <h2>üì∞ Recent Activity</h2>
      <ul id="activityFeed" class="activity-feed"></ul>
    </div>
    <!-- WALDO/USD Trend -->
    <div class="card">
      <h2>üìà WALDO/USD Trend (7 Days)</h2>
      <canvas height="200" id="waldoPriceChart"></canvas>
    </div>
    <!-- WALDO Promo Media 2 -->
    <div class="card">
      <img alt="WALDO Promo" src="https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg" class="waldo-promo-img">
      <h1>Use #WaldoMeme on Tweets for Rewards.</h1>
    </div>
    <!-- XP Gain Breakdown -->
    <div class="card">
      <h2>üß† XP Gain Breakdown</h2>
      <table>
        <tbody id="xpBreakdownTable">
          <tr><td>‚ù§Ô∏è Likes</td><td><strong id="xpLikes">0 XP</strong></td></tr>
          <tr><td>üîÅ Retweets</td><td><strong id="xpRetweets">0 XP</strong></td></tr>
          <tr><td>‚öîÔ∏è Battle Wins</td><td><strong id="xpBattles">0 XP</strong></td></tr>
          <tr><td>üì£ Referrals</td><td><strong id="xpReferrals">0 XP</strong></td></tr>
          <tr><td>üó≥ Meme Voting</td><td><strong id="xpVoting">0 XP</strong></td></tr>
          <tr><td>‚è≥ Staking Bonus</td><td><strong id="xpStakingBonus">0%</strong></td></tr>
        </tbody>
      </table>
    </div>
    <!-- Reward Tiers Card -->
    <div class="card reward-logic-table">
      <h2>üíé Reward Tiers</h2>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr>
              <th scope="col">Tier</th>
              <th scope="col">Likes</th>
              <th scope="col">Retweets</th>
              <th scope="col">Base</th>
              <th scope="col">Instant Payout</th>
              <th scope="col">Stake Payout</th>
              <th scope="col">Max No-Stake (x40)</th>
              <th scope="col">Max Stake (x40)</th>
            </tr>
          </thead>
          <tbody id="rewardTierBody"></tbody>
        </table>
      </div>
    </div>
    <!-- Meme Table with Pagination, XP, Claim/Stake/Mint -->
    <div class="card big-card">
      <div class="centered-flex-container">
        <h2 class="margin-top-0">üì∏ My Memes</h2>
        <div class="tooltip-wrapper">
          <span class="tooltip-icon">i</span>
          <span class="tooltip-text">Each meme must reach 60 XP to be eligible for minting as an NFT.</span>
        </div>
      </div>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr>
              <th scope="col">Thumbnail</th>
              <th scope="col">Retweets</th>
              <th scope="col">Likes</th>
              <th scope="col">XP</th>
              <th scope="col">Tier</th>
              <th scope="col">Claim</th>
              <th scope="col">Stake</th>
              <th scope="col">Mint</th>
            </tr>
          </thead>
          <tbody id="memeTableBody"></tbody>
        </table>
        <div class="pagination" id="pagination"></div>
      </div>
<!-- WALDOcoin Battle Arena ‚Äì FULL WIDTH -->
<div class="card big-card battle-arena full-width-battle-arena">
  <h2>üî• Meme Battle Arena</h2>
  <p>üì¢ Welcome to the Meme Battle Arena! Paste a meme tweet link, start a battle, or accept one to begin voting. Voters pay 5 WALDO to participate, and get a share of the pot + XP if they pick the winner!</p>
  <div id="battleStatus">Loading current battle...</div>
  <div id="battleContent" style="display: none;">
    <div class="battle-memes-container">
      <div class="flex-item">
        <h3>Meme 1</h3>
        <a id="meme1Link" href="#" target="_blank">
          <img alt="Meme 1" class="meme-thumb" id="meme1Img" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/300x300?text=Meme+1">
        </a>
        <button type="button" onclick="voteBattle('meme1')" class="button-style" id="voteMeme1Btn">Vote for Meme 1 (5 WALDO)</button>
      </div>
      <div class="battle-controls" data-tweetid="" data-status="open" data-canaccept="false" id="battle-wrapper">
        <input id="memeTweetId" onblur="extractTweetId(this.value)" placeholder="Paste Meme Tweet Link (e.g. https://x.com/user/status/1234567890)" class="input-style margin-bottom-10" type="text">
        <button id="start-battle-btn" type="button" class="button-style">üß† Start New Battle (100 WALDO)</button>
        <button id="accept-battle-btn" type="button" class="button-style">ü§ú Accept Current Battle (50 WALDO)</button>
      </div>
      <div class="flex-item">
        <h3>Meme 2</h3>
        <a id="meme2Link" href="#" target="_blank">
          <img alt="Meme 2" class="meme-thumb" id="meme2Img" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/300x300?text=Meme+2">
        </a>
        <button type="button" onclick="voteBattle('meme2')" class="button-style" id="voteMeme2Btn">Vote for Meme 2 (5 WALDO)</button>
      </div>
    </div>
    <p id="battleTimer" class="battle-timer"></p>
    <p id="battleVoteStatus" class="twitter-link-status"></p>
    <div class="margin-top-20">
      <p id="battleFinalResult" class="battle-result"></p>
    </div>
    <div class="margin-top-20">
      <h3 class="centered-text">üöÄ Launch or Accept a Battle</h3>
      <div class="centered-column">
        <div id="toast" class="toast hidden"></div>
      </div>
    </div>
  </div>
</div>
    <!-- BATTLE HISTORY + LEADERBOARD as 2-column row (centered and big) -->
    <div class="battle-bottom-row">
      <div class="card battle-history-card">
        <h2>üìú Past Meme Battles</h2>
        <div id="battleHistoryStatus">Loading battle history...</div>
        <div id="battleHistoryTableContainer" style="display: none;">
          <table class="battle-history-table">
            <thead>
              <tr>
                <th>üÜî</th>
                <th>Meme 1</th>
                <th>Meme 2</th>
                <th>Votes</th>
                <th>Winner</th>
                <th>Ended</th>
              </tr>
            </thead>
            <tbody id="battleHistoryTable"></tbody>
          </table>
  <table id="battleLeaderboardTable" class="battle-leaderboard-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Profile</th>
        <th>Wallet</th>
        <th>Wins</th>
      </tr>
    </thead>
          </table>
        </div>
      </div>
    </div>

    <!-- NFT Modal -->
    <div id="nftModal" class="nft-modal">
      <span onclick="closeNFTModal()" class="close-nft-modal">&times;</span>
      <img id="nftModalImg" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/600x400.png?text=NFT+Preview" alt="NFT Preview" class="nft-modal-image">
    </div>

    <!-- Staking Modal -->
    <div id="stakingModal" class="nft-modal" style="display: none;">
      <div style="background: #111; padding: 30px; border-radius: 15px; max-width: 500px; margin: 50px auto; position: relative;">
        <span onclick="closeStakingModal()" class="close-nft-modal" style="position: absolute; top: 10px; right: 15px; font-size: 28px; cursor: pointer;">&times;</span>
        <h3 style="color: #25c2a0; margin-top: 0;">üè¶ Stake WALDO Tokens</h3>

        <div style="margin: 20px 0;">
          <label style="color: #fff; display: block; margin-bottom: 5px;">Amount to Stake:</label>
          <input type="number" id="stakeAmount" placeholder="1000" min="1" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background: #222; color: #fff;">
        </div>

        <div style="margin: 20px 0;">
          <label style="color: #fff; display: block; margin-bottom: 5px;">Staking Duration:</label>
          <select id="stakeDuration" style="width: 100%; padding: 10px; border-radius: 8px; border: none; background: #222; color: #fff;">
            <option value="30">30 days (12% APY)</option>
            <option value="90">90 days (12% APY)</option>
            <option value="180">180 days (20% APY)</option>
            <option value="365">365 days (20% APY)</option>
          </select>
        </div>

        <div style="background: #222; padding: 15px; border-radius: 8px; margin: 20px 0;">
          <div style="color: #25c2a0; font-weight: bold;">Estimated Returns:</div>
          <div id="stakingEstimate" style="color: #fff; margin-top: 5px;">Select amount and duration</div>
        </div>

        <button type="button" onclick="createStake()" class="button-style" style="width: 100%; margin-top: 15px;">üè¶ Create Stake</button>
      </div>
    </div>
    <!-- WALDO DAO Voting Card -->
    <div class="card big-card dao-voting-card" id="daoVotingCard">
      <h2>üó≥ WALDOcoin DAO Voting</h2>
      <div id="proposalContainer">COMMING SOON...</div>
    </div>
    </div> <!-- Close .battle-bottom-row -->
    <!-- Close .container -->
</div>
<!-- END .container -->
<script>
(function() {
  let isInitializing = false;
  let originalInit = window.initWaldoDashboard;
  
  if (originalInit) {
    window.initWaldoDashboard = async function() {
      if (isInitializing) return;
      isInitializing = true;
      try {
        await originalInit.call(this);
      } finally {
        isInitializing = false;
      }
    };
  }
  
  window.addEventListener('beforeunload', () => {
    if (window.dashboardIntervals) {
      window.dashboardIntervals.forEach(clearInterval);
    }
    if (window.battleTimerInterval) {
      clearInterval(window.battleTimerInterval);
    }
  });
})();
</script>
<script>
(function() {
  // Always force logout if not logged in on THIS device+tab
  const wallet = localStorage.getItem('xummWallet');
  const desktopFlag = sessionStorage.getItem('waldoLoginDesktop');
  // Show for debugging
  // alert('DASHBOARD: wallet=' + wallet + ' flag=' + desktopFlag);
  if (!wallet || !desktopFlag) {
    localStorage.removeItem('xummWallet');
    sessionStorage.removeItem('waldoLoginDesktop');
    window.location.replace('/');
    throw new Error('Not signed in on desktop session.');
  }
})();
</script>

<script>
/** === CONFIG === **/
const baseURL = "https://waldocoin-backend-api.onrender.com"; // Production API
const statsPage = "/"; // Dashboard homepage
const loginPage = "/connect-waldo-wallet/"; // Login page (adjust if different)

/** === UTILS === **/
function $(id) { return document.getElementById(id); }
function getWallet() { return localStorage.getItem("xummWallet") || null; }

/** === LEVELS === **/
const levelTitles = {
  1: "Fresh Poster", 2: "Shitposter", 3: "Meme Dealer", 4: "OG Degen", 5: "WALDO Master"
};
const levelThresholds = [0, 250, 850, 1750, 3000];
const levelImages = {
  1: "https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg",
  2: "https://waldocoin.live/wp-content/uploads/2025/03/1737843965414.jpeg",
  3: "https://waldocoin.live/wp-content/uploads/2025/03/F.A.F.O.png",
  4: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.52.10.jpeg",
  5: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.53.38.jpeg"
};
const rewardTiers = [
  { tier: 1, likes: 25, retweets: 0, base: 1 },
  { tier: 2, likes: 50, retweets: 5, base: 2 },
  { tier: 3, likes: 100, retweets: 10, base: 5 },
  { tier: 4, likes: 500, retweets: 50, base: 25 },
  { tier: 5, likes: 1000, retweets: 100, base: 50 }
];

/** === NOTIFICATIONS === **/
function showWaldoNotification(msg, timeout = 5000) {
  const n = $("waldoNotification"), m = $("waldoMessage");
  if (!n || !m) return;
  m.textContent = msg;
  n.style.display = "flex";
  if (timeout) setTimeout(() => { n.style.display = "none"; }, timeout);
}
function dismissWaldoNotification() { $("waldoNotification")?.style && ($("waldoNotification").style.display = "none"); }

/** === TOASTS === **/
function showToast(message, type = "info", duration = 3500) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; bottom:30px; left:50%; transform:translateX(-50%);
    background: ${type === "error" ? "#e63e3e" : type === "success" ? "#2ecc71" : "#222"};
    color:white; padding:12px 20px; border-radius:8px; font-weight:600;
    z-index:99999; box-shadow:0 0 12px rgba(0,0,0,0.28);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

/** === COPY REFERRAL === **/
function copyReferral() {
  const input = $("referralLink");
  if (!input) return;
  input.select();
navigator.clipboard.writeText(input.value)
  .then(() => $("copyStatus").textContent = "üìã Copied!")
  .catch(() => $("copyStatus").textContent = "Copy failed.");

}

/** === REWARD TIERS === **/
function generateRewardTable() {
  const table = $("rewardTierBody");
  if (!table) return;
  table.innerHTML = "";
  rewardTiers.forEach(t => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>Tier ${t.tier}</td>
      <td>${t.likes}+</td>
      <td>${t.retweets}+</td>
      <td>${t.base.toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9).toFixed(2)} WALDO</td>
      <td>${(t.base * 1.15 * 0.95).toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9 * 40).toFixed(2)}</td>
      <td>${(t.base * 1.15 * 0.95 * 40).toFixed(2)}</td>
    `;
    table.appendChild(row);
  });
}

/** === XP CALC === **/
function calculateXPToNextLevel(xp) {
  for (let i = 0; i < levelThresholds.length; i++)
    if (xp < levelThresholds[i]) return levelThresholds[i] - xp;
  return 0;
}

/** === CHARTS === **/
let xpChartInstance = null;
function renderXPTrendChart(xpTrend) {
  const el = $("xpChart");
  if (!el || !window.Chart) return;
  const ctx = el.getContext("2d");
  if (xpChartInstance) xpChartInstance.destroy();
  xpChartInstance = new Chart(ctx, {
    type: "line",
    data: xpTrend || { labels:[], datasets:[] },
    options: { responsive: true, scales: { y: { beginAtZero:true } } }
  });
}

/** === DASHBOARD POPULATION === **/
async function fetchUserStats(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/userStats?wallet=${wallet}`);
    const stats = await res.json();
    $("walletAddress") && ($("walletAddress").textContent = `Wallet: ${wallet}`);
    $("waldoXP") && ($("waldoXP").textContent = stats.xp ?? "0");
    $("waldoLevel") && ($("waldoLevel").textContent = `Level ${stats.level ?? 1}`);
    $("waldoTitle") && ($("waldoTitle").textContent = (levelTitles[stats.level] || `Level ${stats.level}`));
    $("waldoLikes") && ($("waldoLikes").textContent = stats.likes ?? "0");
    $("waldoRetweets") && ($("waldoRetweets").textContent = stats.retweets ?? "0");
    $("waldoMemes") && ($("waldoMemes").textContent = stats.memes ?? "0");
    $("waldoBattles") && ($("waldoBattles").textContent = stats.battles ?? "0");
    $("waldoReferrals") && ($("waldoReferrals").textContent = stats.referrals?.length ?? 0);
    $("refCount") && ($("refCount").textContent = stats.referrals?.length ?? 0);
    $("referralLink") && ($("referralLink").value = `https://waldocoin.live/?ref=${wallet}`);
    // XP breakdown
    const breakdown = stats.xpBreakdown || {};
    $("xpLikes") && ($("xpLikes").textContent = `${breakdown.likes ?? 0} XP`);
    $("xpRetweets") && ($("xpRetweets").textContent = `${breakdown.retweets ?? 0} XP`);
    $("xpBattles") && ($("xpBattles").textContent = `${breakdown.battles ?? 0} XP`);
    $("xpReferrals") && ($("xpReferrals").textContent = `${breakdown.referrals ?? 0} XP`);
    $("xpVoting") && ($("xpVoting").textContent = `${breakdown.voting ?? 0} XP`);
    $("xpStakingBonus") && ($("xpStakingBonus").textContent = `${breakdown.stakingBonus ?? 0}%`);
    // Level logic
    const level = stats.level || 1, xp = stats.xp || 0;
    const xpFloor = levelThresholds[level - 1] || 0, xpCeil = levelThresholds[level] || (xpFloor + 1000);
    const xpProgress = Math.min(100, Math.floor(((xp - xpFloor) / (xpCeil - xpFloor)) * 100));
    $("userLevelIcon") && ($("userLevelIcon").src = levelImages[level] || levelImages[1]);
    $("userLevelTitle") && ($("userLevelTitle").textContent = levelTitles[level] || `Level ${level}`);
    $("levelProgress") && ($("levelProgress").value = xpProgress);
    $("xpToNextLevel") && ($("xpToNextLevel").textContent = `${calculateXPToNextLevel(xp)} XP to next level`);
    $("xpToNextLevelStats") && ($("xpToNextLevelStats").textContent = `${calculateXPToNextLevel(xp)} XP`);
    renderXPTrendChart(stats.memeXPTrend || []);
  } catch (err) {
    showToast("Error loading user stats", "error");
  }
}
async function fetchConversionRate() {
  try {
    const res = await fetch(`${baseURL}/api/conversion`);
    const data = await res.json();
    $("waldoConversion") && ($("waldoConversion").textContent = `${data.waldoToUSD} USD / ${data.waldoToXRP} XRP`);
    $("waldoEarnings") && ($("waldoEarnings").textContent = `${data.totalWaldo} WALDO = ${data.totalUSD} USD`);
  } catch (err) { showToast("Could not load rates", "error"); }
}
async function loadTopMeme() {
  try {
    const res = await fetch(`${baseURL}/api/topMeme`);
    const data = await res.json();
    $("topMemeLikes") && ($("topMemeLikes").textContent = data.likes);
    $("topMemeImage") && ($("topMemeImage").src = data.image);
    $("topMemeImg") && ($("topMemeImg").src = data.image);
    $("topMemeLink") && ($("topMemeLink").href = `https://x.com/${data.author}/status/${data.id}`);
  } catch (err) {}
}
// === Meme Table Logic ===
async function fetchMemes(wallet, page = 1, perPage = 5) {
  try {
    const res = await fetch(`${baseURL}/api/tweets?wallet=${wallet}&page=${page}&perPage=${perPage}`);
    const data = await res.json();
    renderMemeTable(data.memes || [], wallet);
    renderMemePagination(data.totalPages || 1, page);
  } catch (e) {
    showToast("Could not load memes", "error");
  }
}
function renderMemeTable(memes, wallet) {
  const tbody = $("memeTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";
  memes.forEach(meme => {
    const isMintable = meme.xp >= 60; // Or whatever XP threshold
    tbody.innerHTML += `
      <tr>
        <td><img class="meme-thumb" src="${meme.image}" alt="meme" onclick="showNFTModal('${meme.image}')"></td>
        <td>${meme.retweets}</td>
        <td>${meme.likes}</td>
        <td>${meme.xp}</td>
        <td>${meme.tier || '-'}</td>
        <td><button onclick="claimMeme('${meme.id}', ${meme.tier})" class="button-style" ${meme.claimed ? 'disabled' : ''}>Claim</button></td>
        <td><button onclick="stakeMeme('${meme.id}', ${meme.tier})" class="button-style" ${meme.staked ? 'disabled' : ''}>Stake</button></td>
        <td><button onclick="mintMeme('${meme.id}', '${meme.image}')" class="button-style" ${isMintable ? "" : "disabled"}>Mint</button></td>
      </tr>`;
  });
}
function renderMemePagination(totalPages, currentPage) {
  const pag = $("pagination");
  if (!pag) return;
  pag.innerHTML = "";
  for (let i = 1; i <= totalPages; i++) {
    pag.innerHTML += `<button onclick="fetchMemes('${getWallet()}', ${i})" ${i === currentPage ? 'style="font-weight:bold;"' : ''}>${i}</button>`;
  }
}
// Claim/Stake/Mint Handlers
async function claimMeme(id, tier) {
  try {
    const res = await fetch(`${baseURL}/api/claim`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), memeId: id, tier, stake: false })
    });
    const data = await res.json();
    if (data.success) showToast("Claim initiated! Check your XAMAN wallet.", "success");
    else showToast(data.error || "Claim failed", "error");
    fetchMemes(getWallet()); // Refresh
  } catch (e) { showToast("Claim error", "error"); }
}
async function stakeMeme(id, tier) {
  try {
    const res = await fetch(`${baseURL}/api/claim`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), memeId: id, tier, stake: true })
    });
    const data = await res.json();
    if (data.success) showToast("Stake started! Check your XAMAN wallet.", "success");
    else showToast(data.error || "Stake failed", "error");
    fetchMemes(getWallet());
  } catch (e) { showToast("Stake error", "error"); }
}
async function mintMeme(id, img) {
  // Open modal for mint confirmation if needed, then call backend
  showNFTModal(img);
  if (!confirm("Mint this meme as NFT? (50 WALDO fee applies)")) return;
  try {
    const res = await fetch(`${baseURL}/api/mint`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), memeId: id })
    });
    const data = await res.json();
    if (data.success) showToast("Mint initiated. Sign in wallet!", "success");
    else showToast(data.error || "Mint failed", "error");
    fetchMemes(getWallet());
  } catch (e) { showToast("Mint error", "error"); }
}
window.claimMeme = claimMeme;
window.stakeMeme = stakeMeme;
window.mintMeme = mintMeme;
window.showNFTModal = showNFTModal; // Needed for thumbnail click
// On page load, after initWaldoDashboard, call: fetchMemes(getWallet());
// === NFT Modal Preview Logic ===
function showNFTModal(img) {
  const modal = document.getElementById("nftModal");
  const modalImg = document.getElementById("nftModalImg");
  if (!modal || !modalImg) return;
  modal.style.display = "block";
  modalImg.src = img;
}
function closeNFTModal() {
  const modal = document.getElementById("nftModal");
  if (modal) modal.style.display = "none";
}
window.closeNFTModal = closeNFTModal;
// CSS: add `.nft-modal { display:none; position:fixed; ... }` if not present
// === Activity Feed Logic ===
async function fetchActivity(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/activity?wallet=${wallet}`);
    const data = await res.json();
    const ul = $("activityFeed");
    if (!ul) return;
    ul.innerHTML = "";
    (data.activity || []).forEach(act => {
      ul.innerHTML += `<li>${act.time ? `<b>[${act.time}]</b> ` : ''}${act.message || JSON.stringify(act)}</li>`;
    });
  } catch (e) { showToast("Could not load activity", "error"); }
}
// After init, call: fetchActivity(getWallet());
// === Battle Arena Logic ===
async function fetchBattleStatus() {
  try {
    const res = await fetch(`${baseURL}/api/battle/current`);
    const battle = await res.json();
    const statusDiv = $("battleStatus");
    const content = $("battleContent");
    if (!battle.active) {
      statusDiv.textContent = "No current battle. Start one!";
      content.style.display = "none";
      $("battle-wrapper").dataset.status = "open";
      $("accept-battle-btn").disabled = true;
      $("start-battle-btn").disabled = false;
      return;
    }
    statusDiv.textContent = "Current Battle:";
    content.style.display = "block";
    $("meme1Img").src = battle.meme1.image;
    $("meme2Img").src = battle.meme2.image;
    $("meme1Link").href = battle.meme1.link;
    $("meme2Link").href = battle.meme2.link;
    $("voteMeme1Btn").disabled = false;
    $("voteMeme2Btn").disabled = false;
    renderBattleTimer(battle.timerSeconds);
    // Add timer update logic if needed
    // Enable/disable buttons based on user/battle state
    $("battle-wrapper").dataset.status = "running";
    $("accept-battle-btn").disabled = true;
    $("start-battle-btn").disabled = true;
  } catch (e) {
    $("battleStatus").textContent = "Could not load battle info.";
  }
}
let battleTimerInterval = null;
function renderBattleTimer(seconds) {
  clearInterval(battleTimerInterval);
  const timerEl = $("battleTimer");
  if (!timerEl) return;
  if (!seconds || seconds < 1) {
    timerEl.textContent = "Battle running";
    return;
  }
  function update() {
    if (seconds < 0) {
      timerEl.textContent = "Battle ended";
      clearInterval(battleTimerInterval);
      return;
    }
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    seconds--;
  }

  // Clear existing timer first
  if (window.battleTimerInterval) {
    clearInterval(window.battleTimerInterval);
  }

  update();
  window.battleTimerInterval = setInterval(update, 1000);
}

async function startBattle() {
  const tweetId = $("memeTweetId").value.trim();
  if (!tweetId) return showToast("Paste a meme tweet link!", "error");
  try {
    const res = await fetch(`${baseURL}/api/battle/start`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), tweetId })
    });
    const data = await res.json();
    if (data.success) showToast("Battle started! Waiting for opponent...", "success");
    else showToast(data.error || "Could not start battle", "error");
    fetchBattleStatus();
  } catch (e) { showToast("Battle start error", "error"); }
}
async function acceptBattle() {
  try {
    const res = await fetch(`${baseURL}/api/battle/accept`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet() })
    });
    const data = await res.json();
    if (data.success) showToast("Battle accepted. Battle is ON!", "success");
    else showToast(data.error || "Accept failed", "error");
    fetchBattleStatus();
  } catch (e) { showToast("Battle accept error", "error"); }
}
async function voteBattle(meme) {
  try {
    const res = await fetch(`${baseURL}/api/battle/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), meme })
    });
    const data = await res.json();
    if (data.success) showToast("Vote cast! Check battle results after timer.", "success");
    else showToast(data.error || "Vote failed", "error");
    fetchBattleStatus();
  } catch (e) { showToast("Vote error", "error"); }
}
$("start-battle-btn").onclick = startBattle;
$("accept-battle-btn").onclick = acceptBattle;
window.voteBattle = voteBattle;
// On dashboard init, call fetchBattleStatus();
// === Battle History & Leaderboard ===
async function fetchBattleHistory() {
  try {
    const res = await fetch(`${baseURL}/api/battle/history`);
    const data = await res.json();
    $("battleHistoryStatus").style.display = "none";
    $("battleHistoryTableContainer").style.display = "block";
    const tbody = $("battleHistoryTable");
    tbody.innerHTML = "";
    (data.battles || []).forEach(b => {
      tbody.innerHTML += `
        <tr>
          <td>${b.id}</td>
          <td><a href="${b.meme1.link}" target="_blank">Meme 1</a></td>
          <td><a href="${b.meme2.link}" target="_blank">Meme 2</a></td>
          <td>${b.votes}</td>
          <td>${b.winner || '-'}</td>
          <td>${b.ended ? "Yes" : "No"}</td>
        </tr>`;
    });
  } catch (e) {
    $("battleHistoryStatus").textContent = "Failed to load battle history.";
  }
}
async function fetchBattleLeaderboard() {
  try {
    const res = await fetch(`${baseURL}/api/battle/leaderboard`);
    const { leaderboard } = await res.json();
    renderBattleLeaderboard(leaderboard);
  } catch (e) {
    showToast("Could not load leaderboard", "error");
  }
}

function renderBattleLeaderboard(leaderboard) {
  const tbody = document.querySelector("#battleLeaderboardTable tbody");
  if (!tbody) return;
  tbody.innerHTML = "";

  if (!leaderboard || !leaderboard.length) {
    tbody.innerHTML = `<tr><td colspan="4">No data yet</td></tr>`;
    return;
  }

  leaderboard.forEach((entry, i) => {
    const walletShort = entry.wallet
      ? entry.wallet.slice(0, 6) + "..." + entry.wallet.slice(-4)
      : "";

    // If you have a saved twitterUrl, use that. Otherwise, generate from handle
    let twitterUrl = entry.twitterUrl;
    if (!twitterUrl && entry.twitter) {
      twitterUrl = `https://twitter.com/${entry.twitter.replace(/^@/, "")}`;
    }

    tbody.innerHTML += `
      <tr>
        <td style="font-size:1.6em;">${i === 0 ? "üèÜ" : i + 1}</td>
        <td>
          ${entry.twitterPic
            ? `<img src="${entry.twitterPic}" alt="avatar" style="width:38px;height:38px;border-radius:50%;vertical-align:middle;margin-right:8px;">`
            : `<span style="display:inline-block;width:38px;height:38px;background:#222;border-radius:50%;margin-right:8px;"></span>`}
          ${entry.twitter ? 
            `<a href="${twitterUrl}" target="_blank" style="color:#1da1f2;text-decoration:none;">
              @${entry.twitter.replace(/^@/, "")}
            </a>` 
            : `<span style="color:#aaa;">(unknown)</span>`}
        </td>
        <td>
          <code style="font-size:12px;">${walletShort}</code>
        </td>
        <td>
          <span style="font-weight:bold;color:gold;">${entry.wins}</span>
        </td>
      </tr>
    `;
  });
}
// On dashboard init, call fetchBattleHistory(); fetchBattleLeaderboard();
// === DAO Voting (Placeholder/Scaffold) ===
async function fetchDAOProposals() {
  try {
    const res = await fetch(`${baseURL}/api/dao/proposals`);
    const data = await res.json();
    const cont = $("proposalContainer");
    cont.innerHTML = "";
    (data.proposals || []).forEach(p => {
      cont.innerHTML += `
        <div>
          <b>${p.title}</b> - ${p.status}
          <button onclick="voteDAO('${p.id}', true)">Yes</button>
          <button onclick="voteDAO('${p.id}', false)">No</button>
        </div>
      `;
    });
  } catch (e) {
    $("proposalContainer").textContent = "Could not load proposals.";
  }
}
async function voteDAO(proposalId, yes) {
  try {
    const res = await fetch(`${baseURL}/api/dao/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: getWallet(), proposalId, vote: yes })
    });
    const data = await res.json();
    if (data.success) showToast("Vote cast!", "success");
    else showToast(data.error || "Vote failed", "error");
    fetchDAOProposals();
  } catch (e) { showToast("Vote error", "error"); }
}
window.voteDAO = voteDAO;
// On dashboard init, call fetchDAOProposals();

/** === NEW ENHANCED FEATURES === **/

// Fetch user level progression
async function fetchUserLevel(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/userLevel/${wallet}`);
    const data = await res.json();
    if (data.success) {
      updateLevelDisplay(data);
    }
  } catch (e) {
    console.error("Error fetching user level:", e);
  }
}

// Update level display in UI
function updateLevelDisplay(levelData) {
  const levelCard = $("userLevelCard");
  if (!levelCard) return;

  levelCard.innerHTML = `
    <h3>üéÆ Level Progression</h3>
    <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
      <div style="flex: 1;">
        <div style="font-size: 1.2em; color: #25c2a0; font-weight: bold;">
          Level ${levelData.level}: ${levelData.title}
        </div>
        <div style="color: #ccc; font-size: 0.9em;">
          ${levelData.totalXp} XP ‚Ä¢ ${levelData.multiplier}x multiplier
        </div>
      </div>
    </div>
    <div style="background: #333; border-radius: 10px; height: 8px; margin: 10px 0;">
      <div style="background: linear-gradient(90deg, #25c2a0, #00ff88); height: 100%; border-radius: 10px; width: ${levelData.progress}%; transition: width 0.5s ease;"></div>
    </div>
    <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #aaa;">
      <span>${levelData.xpInCurrentLevel} XP in current level</span>
      <span>${levelData.isMaxLevel ? 'MAX LEVEL!' : levelData.xpToNext + ' XP to next'}</span>
    </div>
  `;
}

// Fetch staking positions
async function fetchStakingPositions(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/staking/positions/${wallet}`);
    const data = await res.json();
    if (data.success) {
      updateStakingDisplay(data);
    }
  } catch (e) {
    console.error("Error fetching staking positions:", e);
  }
}

// Update staking display
function updateStakingDisplay(stakingData) {
  const stakingCard = $("stakingCard");
  if (!stakingCard) return;

  const positions = stakingData.positions || [];
  const positionsHtml = positions.length > 0 ?
    positions.map(pos => `
      <div style="background: #222; padding: 12px; border-radius: 8px; margin: 8px 0;">
        <div style="display: flex; justify-content: space-between;">
          <span>${pos.amount} WALDO</span>
          <span style="color: #25c2a0;">${(pos.apy * 100).toFixed(1)}% APY</span>
        </div>
        <div style="font-size: 0.85em; color: #aaa;">
          Unlocks: ${new Date(pos.unlockDate).toLocaleDateString()}
        </div>
        <div style="font-size: 0.85em; color: #00ff88;">
          Current Rewards: ${pos.currentRewards.toFixed(2)} WALDO
        </div>
      </div>
    `).join('') :
    '<div style="color: #aaa; text-align: center; padding: 20px;">No active stakes</div>';

  stakingCard.innerHTML = `
    <h3>üè¶ Staking Positions</h3>
    <div style="margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div>
          <div style="color: #25c2a0; font-weight: bold;">${stakingData.totalStaked.toFixed(2)} WALDO</div>
          <div style="font-size: 0.85em; color: #aaa;">Total Staked</div>
        </div>
        <div>
          <div style="color: #00ff88; font-weight: bold;">${stakingData.totalRewards.toFixed(2)} WALDO</div>
          <div style="font-size: 0.85em; color: #aaa;">Total Rewards</div>
        </div>
      </div>
      ${positionsHtml}
    </div>
  `;
}

// Fetch tokenomics stats
async function fetchTokenomicsStats() {
  try {
    const res = await fetch(`${baseURL}/api/tokenomics/stats`);
    const data = await res.json();
    if (data.success) {
      updateTokenomicsDisplay(data.stats);
    }
  } catch (e) {
    console.error("Error fetching tokenomics:", e);
  }
}

// Update tokenomics display
function updateTokenomicsDisplay(stats) {
  const tokenomicsCard = $("tokenomicsCard");
  if (!tokenomicsCard) return;

  tokenomicsCard.innerHTML = `
    <h3>üí∞ Tokenomics</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
      <div style="background: #222; padding: 12px; border-radius: 8px;">
        <div style="color: #25c2a0; font-weight: bold;">${stats.airdrop.claimed}/1000</div>
        <div style="font-size: 0.85em; color: #aaa;">Airdrops Claimed</div>
      </div>
      <div style="background: #222; padding: 12px; border-radius: 8px;">
        <div style="color: #ff6b6b; font-weight: bold;">${stats.estimatedDailyBurns.toFixed(1)}</div>
        <div style="font-size: 0.85em; color: #aaa;">Daily Burns (WALDO)</div>
      </div>
      <div style="background: #222; padding: 12px; border-radius: 8px;">
        <div style="color: #ffd93d; font-weight: bold;">${stats.battles.total}</div>
        <div style="font-size: 0.85em; color: #aaa;">Total Battles</div>
      </div>
      <div style="background: #222; padding: 12px; border-radius: 8px;">
        <div style="color: #6bcf7f; font-weight: bold;">${(stats.airdrop.totalDistributed / 1000000).toFixed(1)}M</div>
        <div style="font-size: 0.85em; color: #aaa;">WALDO Distributed</div>
      </div>
    </div>
  `;
}

// Fetch security status
async function fetchSecurityStatus(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/security/check/${wallet}`);
    const data = await res.json();
    if (data.success) {
      updateSecurityDisplay(data);
    }
  } catch (e) {
    console.error("Error fetching security status:", e);
  }
}

// Update security display
function updateSecurityDisplay(securityData) {
  const securityCard = $("securityCard");
  if (!securityCard) return;

  const statusColor = securityData.status === 'CLEAN' ? '#00ff88' :
                     securityData.status === 'FLAGGED' ? '#ffd93d' : '#ff6b6b';

  securityCard.innerHTML = `
    <h3>üõ°Ô∏è Security Status</h3>
    <div style="margin: 15px 0;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${statusColor};"></div>
        <span style="color: ${statusColor}; font-weight: bold;">${securityData.status}</span>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div style="background: #222; padding: 10px; border-radius: 6px;">
          <div style="color: #25c2a0;">${securityData.violationCount}</div>
          <div style="font-size: 0.8em; color: #aaa;">Violations</div>
        </div>
        <div style="background: #222; padding: 10px; border-radius: 6px;">
          <div style="color: ${securityData.isBlocked ? '#ff6b6b' : '#00ff88'};">
            ${securityData.isBlocked ? 'BLOCKED' : 'ACTIVE'}
          </div>
          <div style="font-size: 0.8em; color: #aaa;">Status</div>
        </div>
      </div>
    </div>
  `;
}

// Staking modal functions
function showStakingModal() {
  const modal = document.getElementById("stakingModal");
  if (modal) modal.style.display = "block";
  updateStakingEstimate();
}

function closeStakingModal() {
  const modal = document.getElementById("stakingModal");
  if (modal) modal.style.display = "none";
}

function updateStakingEstimate() {
  const amount = parseFloat(document.getElementById("stakeAmount").value) || 0;
  const duration = parseInt(document.getElementById("stakeDuration").value) || 30;
  const apy = duration >= 180 ? 0.20 : 0.12;

  const dailyRate = apy / 365;
  const rewards = amount * (Math.pow(1 + dailyRate, duration) - 1);

  const estimateDiv = document.getElementById("stakingEstimate");
  if (estimateDiv && amount > 0) {
    estimateDiv.innerHTML = `
      <div>Amount: ${amount} WALDO</div>
      <div>Duration: ${duration} days</div>
      <div>APY: ${(apy * 100).toFixed(1)}%</div>
      <div style="color: #00ff88; font-weight: bold;">Estimated Rewards: ${rewards.toFixed(2)} WALDO</div>
      <div style="color: #25c2a0; font-weight: bold;">Total Return: ${(amount + rewards).toFixed(2)} WALDO</div>
    `;
  }
}

async function createStake() {
  const amount = parseFloat(document.getElementById("stakeAmount").value);
  const duration = parseInt(document.getElementById("stakeDuration").value);
  const wallet = getWallet();

  if (!amount || amount <= 0) {
    showToast("Please enter a valid amount", "error");
    return;
  }

  if (!wallet) {
    showToast("Please connect your wallet first", "error");
    return;
  }

  try {
    const res = await fetch(`${baseURL}/api/staking/stake`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet, amount, duration })
    });

    const data = await res.json();

    if (data.success) {
      showToast("Staking transaction created! Please sign in XUMM", "success");
      closeStakingModal();
      // Optionally open XUMM link
      if (data.redirect) {
        window.open(data.redirect, '_blank');
      }
    } else {
      showToast(data.error || "Failed to create stake", "error");
    }
  } catch (error) {
    showToast("Error creating stake", "error");
    console.error("Staking error:", error);
  }
}

// Add event listeners for staking modal
document.addEventListener("DOMContentLoaded", () => {
  const stakeAmount = document.getElementById("stakeAmount");
  const stakeDuration = document.getElementById("stakeDuration");

  if (stakeAmount) stakeAmount.addEventListener("input", updateStakingEstimate);
  if (stakeDuration) stakeDuration.addEventListener("change", updateStakingEstimate);
});

// Make functions globally available
window.showStakingModal = showStakingModal;
window.closeStakingModal = closeStakingModal;
window.createStake = createStake;

/** === INIT EVERYTHING === **/
let dashboardIntervals = []; // Track intervals for cleanup
let isDashboardInitialized = false; // Prevent multiple initializations

async function initWaldoDashboard() {
  const wallet = getWallet();
  if (!wallet || isDashboardInitialized) return;

  isDashboardInitialized = true;
  console.log("üöÄ Initializing WALDO Dashboard...");

  // Clear any existing intervals
  clearDashboardIntervals();

  try {
    generateRewardTable();

    // Load all data with error handling
    const loadPromises = [
      fetchUserStats(wallet).catch(e => console.warn('User stats failed:', e)),
      fetchUserLevel(wallet).catch(e => console.warn('User level failed:', e)),
      fetchStakingPositions(wallet).catch(e => console.warn('Staking failed:', e)),
      fetchTokenomicsStats().catch(e => console.warn('Tokenomics failed:', e)),
      fetchSecurityStatus(wallet).catch(e => console.warn('Security failed:', e)),
      fetchConversionRate().catch(e => console.warn('Conversion rate failed:', e)),
      loadTopMeme().catch(e => console.warn('Top meme failed:', e)),
      fetchMemes(wallet).catch(e => console.warn('Memes failed:', e)),
      fetchActivity(wallet).catch(e => console.warn('Activity failed:', e)),
      fetchBattleStatus().catch(e => console.warn('Battle status failed:', e)),
      fetchBattleHistory().catch(e => console.warn('Battle history failed:', e)),
      fetchBattleLeaderboard().catch(e => console.warn('Battle leaderboard failed:', e)),
      fetchDAOProposals().catch(e => console.warn('DAO proposals failed:', e))
    ];

    await Promise.allSettled(loadPromises);
    console.log("‚úÖ Dashboard data loaded");

    // Set up periodic updates with cleanup tracking
    setupPeriodicUpdates(wallet);

  } catch (error) {
    console.error("‚ùå Dashboard initialization failed:", error);
    isDashboardInitialized = false; // Allow retry
  }
}

function clearDashboardIntervals() {
  dashboardIntervals.forEach(interval => clearInterval(interval));
  dashboardIntervals = [];

  // Clear battle timer if exists
  if (window.battleTimerInterval) {
    clearInterval(window.battleTimerInterval);
    window.battleTimerInterval = null;
  }
}

function setupPeriodicUpdates(wallet) {
  // Clear existing intervals first
  clearDashboardIntervals();

  // Set up new intervals with tracking
  dashboardIntervals.push(
    setInterval(() => {
      fetchBattleLeaderboard().catch(e => console.warn('Periodic battle leaderboard failed:', e));
    }, 5 * 60 * 1000) // every 5 minutes
  );

  dashboardIntervals.push(
    setInterval(() => {
      fetchUserLevel(wallet).catch(e => console.warn('Periodic user level failed:', e));
    }, 3 * 60 * 1000) // every 3 minutes (reduced frequency)
  );

  dashboardIntervals.push(
    setInterval(() => {
      fetchStakingPositions(wallet).catch(e => console.warn('Periodic staking failed:', e));
    }, 5 * 60 * 1000) // every 5 minutes
  );

  dashboardIntervals.push(
    setInterval(() => {
      fetchTokenomicsStats().catch(e => console.warn('Periodic tokenomics failed:', e));
    }, 10 * 60 * 1000) // every 10 minutes
  );

  console.log("‚è∞ Periodic updates configured");
}

//** === ON PAGE LOAD === **/
let dashboardStarted = false; // Prevent multiple starts

function startDashboard() {
  const wallet = getWallet();
  if (!wallet) {
    console.log("‚è≥ Waiting for wallet login...");
    return;
  }

  if (dashboardStarted) {
    console.log("‚ö†Ô∏è Dashboard already started, skipping...");
    return;
  }

  dashboardStarted = true;
  console.log("üöÄ Starting dashboard for wallet:", wallet);

  $("walletAddress") && ($("walletAddress").innerText = `Wallet: ${wallet}`);
  showWaldoNotification("‚úÖ WALDO wallet connected");
  initWaldoDashboard();
}

// Reset dashboard state on logout
function resetDashboard() {
  dashboardStarted = false;
  isDashboardInitialized = false;
  clearDashboardIntervals();
  console.log("üîÑ Dashboard reset");
}

document.addEventListener("DOMContentLoaded", () => {
  startDashboard();
});

/** === POSTMESSAGE LOGIN SUPPORT === **/
window.addEventListener("message", (event) => {
  if (
    event.origin !== "https://stats-page.waldocoin.live" &&
    event.origin !== "https://waldocoin.live"
  ) return;

  if (event.data.wallet) {
    localStorage.setItem("xummWallet", event.data.wallet);
    sessionStorage.setItem("waldoLoginDesktop", "1");

    // Only start if not already started
    if (!dashboardStarted) {
      startDashboard();
    }
  }
});
function logoutWallet() {
  localStorage.removeItem("xummWallet");
  sessionStorage.removeItem("waldoLoginDesktop");
  window.location.replace("https://waldocoin.live/?logout=1");

}
window.logoutWallet = logoutWallet;

/** === BUTTON HOOKS FOR HTML === **/
window.dismissWaldoNotification = dismissWaldoNotification;
window.copyReferral = copyReferral;
</script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const params = new URLSearchParams(window.location.search);
  if (params.get("logout") === "1") {
    // Toast style notification
    const toast = document.createElement("div");
    toast.textContent = "‚úÖ You have been logged out.";
    toast.style.cssText = `
      position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
      background: #222; color: #fff; padding: 16px 36px; border-radius: 8px;
      font-size: 1.25rem; box-shadow: 0 0 12px #25c2a0bb; z-index: 99999;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3200);
  }
});
</script>
</body>
</html>