<!DOCTYPE html>
<html lang="en">
<!-- VERSION: 2025-10-08-BONUS-FIX - Stats page with correct +12%/18%/25%/45% bonuses -->

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>WALDOcoin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <style>
    html,
    body {
      font-family: 'Inter', sans-serif;
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/05/1737843965137.jpg") !important;
      background-color: #000 !important;
      background-size: 200px 200px !important;
      background-repeat: repeat !important;
      background-attachment: fixed !important;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-y: auto !important;
      overflow-x: hidden;
    }

    .dashboard-title-card {
      background: #000;
      border-radius: 18px;
      box-shadow: 0 0 22px #25c2a0;
      max-width: 650px;
      margin: 32px auto 18px auto;
      padding: 34px 16px 20px 16px;
      text-align: center;
      z-index: 10;
      position: relative;
    }

    .dashboard-title {
      font-size: 2.7rem;
      color: #25c2a0;
      font-weight: 900;
      letter-spacing: 1.5px;
      margin: 0 0 8px 0;
      text-shadow: 0 2px 24px #25c2a099, 0 1px 0 #fff;
    }

    .dashboard-subtitle {
      color: #fff;
      font-size: 1.18rem;
      font-weight: 400;
      margin-bottom: 0;
      opacity: 0.8;
      text-shadow: 0 1px 8px #25c2a055;
    }

    .instruction-card {
      background: #111 !important;
      color: #fff;
      border-radius: 14px;
      box-shadow: 0 0 18px #25c2a044;
      max-width: 600px;
      margin: 0 auto 32px auto;
      padding: 28px 24px;
      text-align: center;
      font-size: 1.15rem;
      position: relative;
      z-index: 9;
    }

    .instruction-card h2 {
      color: #25c2a0;
      margin-top: 0;
      font-weight: 700;
      letter-spacing: 1px;
    }

    .instruction-card ul {
      padding: 0;
      margin: 0;
      list-style: none;
    }

    .instruction-card li {
      margin-bottom: 12px;
      line-height: 1.7;
      font-size: 1.1em;
    }

    /* Grid Container for Cards */
    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 30px;
      margin: 0 auto;
      padding: 40px 10px;
      box-sizing: border-box;
      max-width: 1400px;
      width: 100%;
    }

    /* Responsive! */
    .dashboard-title-card,
    .instruction-card {
      max-width: 98vw;
      padding-left: 8px;
      padding-right: 8px;
    }

    .twitter-link-container {
      max-width: 96vw;
    }


    /* Card Styles */
    .card {
      background: #111;
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      animation: fadeInUp 0.8s ease;
      position: relative;
    }

    .big-card,
    .battle-arena,
    .dao-voting-card {
      grid-column: 1 / -1;
    }

    .reward-logic-table {
      grid-column: 1 / -1;
      width: 100%;
      margin: 0;
      padding: 0;
      /* or padding: 0 18px; if you want some space inside */
      box-sizing: border-box;
    }

    .reward-logic-table table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
    }

    .reward-logic-table th,
    .reward-logic-table td {
      padding: 14px 8px;
      text-align: center;
      white-space: nowrap;
      font-size: 1.1em;
      /* Optional: */
      /* border-bottom: 1px solid #333; */
    }

    /* Stretch each column equally */
    .reward-logic-table th,
    .reward-logic-table td {
      width: 12.5%;
      /* 8 columns: 100%/8 = 12.5% */
    }

    /* Optionally, let first column a bit smaller and others bigger */
    .reward-logic-table th:first-child,
    .reward-logic-table td:first-child {
      width: 10%;
    }

    .reward-logic-table th:last-child,
    .reward-logic-table td:last-child {
      width: 16%;
    }

    .tooltip-wrapper {
      position: relative;
      display: inline-block;
    }

    .tooltip-icon {
      background: #25c2a0;
      color: black;
      font-size: 15px;
      font-weight: bold;
      padding: 2px 7px;
      border-radius: 50%;
      cursor: pointer;
      margin-left: 8px;
    }

    .tooltip-text {
      visibility: hidden;
      opacity: 0;
      width: 240px;
      background-color: #111;
      color: #25c2a0;
      text-align: center;
      border-radius: 6px;
      padding: 10px 14px;
      position: absolute;
      z-index: 10;
      left: 50%;
      top: 120%;
      margin-left: -120px;
      transition: opacity 0.3s, visibility 0.3s;
      font-size: 1.03em;
      box-shadow: 0 0 10px #25c2a0;
    }

    /* Show on hover */
    .tooltip-wrapper:hover .tooltip-text,
    .tooltip-wrapper:focus-within .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Twitter Link (Input + Button) */
    .twitter-link-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin: 28px auto 18px auto;
      width: 100%;
      max-width: 350px;
    }

    .input-style {
      width: 100%;
      padding: 13px 16px;
      border-radius: 8px;
      background: #222;
      color: white;
      border: 1.5px solid #25c2a0;
      font-size: 17px;
      font-weight: 600;
      box-shadow: 0 0 8px #25c2a022;
    }

    .button-style {
      width: 100%;
      max-width: 360px;
      padding: 14px 0;
      border-radius: 8px;
      background: linear-gradient(90deg, #25c2a0 30%, #ff2626 100%);
      color: #fff;
      font-weight: bold;
      font-size: 18px;
      border: none;
      margin: 0;
      cursor: pointer;
      box-shadow: 0 0 8px #25c2a0bb;
      transition: background 0.2s, box-shadow 0.2s;
      letter-spacing: 1px;
    }

    .button-style:hover {
      background: linear-gradient(90deg, #1ba97b 20%, #ff5252 100%);
      box-shadow: 0 0 16px #25c2a0;
    }

    /* General Element Styles */
    .card h1,
    .card h2,
    .card h3,
    .battle-arena h2 {
      color: #25c2a0;
      text-align: center;
      font-weight: bold;
    }

    .level-title {
      margin: 10px 0;
      font-weight: bold;
      color: #25c2a0;
    }

    .level-title.level-1 {
      color: #ff2626;
    }

    .level-title.level-2 {
      color: #298cf5;
    }

    .level-title.level-3 {
      color: #ff930e;
    }

    .level-title.level-4 {
      color: #63f707;
    }

    .level-title.level-5 {
      color: rgb(255, 196, 0);
    }

    .level-icon {
      width: 80px;
      height: auto;
      display: block;
      margin: 10px auto;
      border-radius: 8px;
    }

    #userLevelIcon {
      width: 100px;
      height: auto;
      margin: 10px auto;
      display: block;
    }

    .wallet-address {
      text-align: center;
      margin-bottom: 30px;
    }

    .disconnect-btn,
    .connect-btn {
      display: block;
      margin: 0 auto 20px;
      padding: 8px 18px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }

    .disconnect-btn {
      background: red;
    }

    .connect-btn {
      background: #25c2a0;
      box-shadow: 0 0 10px rgba(37, 194, 160, 0.3);
    }

    .connect-btn:hover {
      background: #1ea085;
      box-shadow: 0 0 15px rgba(37, 194, 160, 0.5);
    }

    /* XUMM Modal Styles */
    .xumm-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .xumm-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      cursor: pointer;
    }

    .xumm-content {
      position: relative;
      background: #111;
      border-radius: 15px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 0 30px rgba(37, 194, 160, 0.3);
      border: 1px solid #25c2a0;
    }

    .xumm-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
      padding: 5px;
    }

    .xumm-close:hover {
      color: #25c2a0;
    }

    #xummTitle {
      color: #25c2a0;
      margin: 0 0 20px 0;
      font-size: 1.4em;
    }

    .xumm-hint {
      color: #ccc;
      margin: 15px 0 0 0;
      font-size: 0.9em;
    }

    .xumm-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top: 3px solid #25c2a0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Battle Arena Styles */
    .battle-arena {
      background: #111;
      border-radius: 18px;
      box-shadow: 0 0 18px #25c2a0;
      padding: 40px 24px 30px 24px;
      text-align: center;
      margin: 0 0 36px 0;
    }

    .battle-memes-container {
      display: flex;
      justify-content: space-around;
      gap: 30px;
      flex-wrap: wrap;
    }

    .battle-memes-container .flex-item {
      flex: 1;
      min-width: 180px;
      max-width: 280px;
      background: #191919;
      border-radius: 12px;
      padding: 16px;
      margin: 0 12px;
      box-shadow: 0 0 12px #222;
      text-align: center;
    }

    @media (max-width: 900px) {}

    .battle-memes-container {
      flex-direction: column;
      align-items: center;
    }

    .battle-memes-container .flex-item {
      max-width: 95vw;
      margin: 10px 0;
    }

    .battle-timer {
      margin-top: 20px;
      font-weight: bold;
      font-size: 2.2rem;
      color: #25c2a0;
      text-align: center;
      letter-spacing: 1px;
      text-shadow: 0 0 14px #25c2a088, 0 2px 0 #000;
      animation: pulseTimer 2s infinite;
    }

    @keyframes pulseTimer {
      0% {
        color: #25c2a0;
      }

      50% {
        color: #fff;
      }

      100% {
        color: #25c2a0;
      }
    }

    .battle-result {
      font-weight: bold;
      font-size: 16px;
      color: gold;
      margin-top: 10px;
    }

    .battle-notification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fb2f2f;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(251, 47, 47, 0.6);
      z-index: 999;
      animation: pulse 2s infinite;
      cursor: pointer;
    }

    .notification-banner {
      background: #111;
      color: #25c2a0;
      text-align: center;
      padding: 16px 0;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 1.18rem;
      font-weight: 600;
    }

    /* Miscellaneous Styles */
    .progress-bar {
      width: 100%;
      height: 12px;
    }

    #levelProgress {
      width: 100%;
      height: 20px;
    }

    /* max-width: 90%; */
    /* max-height: 90%; */
    /* border-radius: 12px; */
    /* box-shadow: 0 0 20px #fb2f2f; */
    .dao-voting-card {
      box-shadow: 0 0 12px #ffcc00;
    }

    .margin-top-0 {
      margin-top: 0;
    }

    .margin-top-20 {
      margin-top: 20px;
    }

    .meme-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .meme-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px #fb2f2f;
    }

    .waldo-promo-img {
      width: 100%;
      border-radius: 8px;
    }

    .waldo-total-earned-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 15px;
    }

    .pagination button {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .meme-score {
      font-size: 60px;
      font-weight: bold;
      color: #25c2a0;
      transition: all 0.5s;
    }

    /* Enhanced Meme Score Card with Dynamic Backgrounds */
    #memeScoreCard {
      position: relative;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: background-image 0.8s ease-in-out;
    }

    #memeScoreCard::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(17, 17, 17, 0.85);
      /* Dark overlay for readability */
      z-index: 1;
    }

    #memeScoreCard>* {
      position: relative;
      z-index: 2;
    }

    .meme-score-container {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 120px;
      margin: 20px 0;
    }

    .meme-score-enhanced {
      font-size: 120px;
      font-weight: 900;
      color: #25c2a0;
      text-align: center;
      margin: 0;
      text-shadow:
        0 0 20px #25c2a0,
        0 0 40px #25c2a0,
        2px 2px 4px rgba(0, 0, 0, 0.8);
      transition: all 0.6s ease;
      line-height: 1;
    }

    /* Level-specific background classes */
    .level-bg-1 {
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .level-bg-2 {
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/03/1737843965414.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .level-bg-3 {
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/03/F.A.F.O.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .level-bg-4 {
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.52.10.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    .level-bg-5 {
      background-image: url("https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.53.38.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }

    /* Add overlay to make text readable over background images */
    .level-bg-1::before,
    .level-bg-2::before,
    .level-bg-3::before,
    .level-bg-4::before,
    .level-bg-5::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 12px;
      z-index: 1;
    }

    /* Ensure content appears above the overlay */
    .level-bg-1>*,
    .level-bg-2>*,
    .level-bg-3>*,
    .level-bg-4>*,
    .level-bg-5>* {
      position: relative;
      z-index: 2;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .meme-score-enhanced {
        font-size: 80px;
      }

      .meme-score-container {
        min-height: 100px;
      }
    }

    @media (max-width: 480px) {
      .meme-score-enhanced {
        font-size: 60px;
      }

      .meme-score-container {
        min-height: 80px;
      }
    }

    /* Pulse animation for high scores */
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }

      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }

      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .xp-stats-card {
      background: #111;
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }

    .flex-column-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .centered-flex-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .overflow-auto {
      overflow-x: auto;
    }

    .activity-feed,
    .leaderboard-list {
      list-style: none;
      padding: 0;
      font-size: 16px;
    }

    .leaderboard-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }

    .flex-item {
      flex: 1;
      min-width: 300px;
    }

    .info-text {
      font-size: 14px;
      color: #aaa;
      margin-top: 10px;
    }

    .toast {
      background: #191919;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: 0 0 8px #25c2a055;
      margin-top: 12px;
      font-weight: 600;
      font-size: 1.09em;
    }

    .hidden {
      display: none !important;
    }

    .margin-bottom-10 {
      margin-bottom: 10px;
    }

    .dismiss-btn {
      margin-left: 20px;
      background: transparent;
      border: 1px solid #25c2a0;
      color: #25c2a0;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(40px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulseBanner {
      0% {
        box-shadow: 0 0 10px #25c2a0;
      }

      50% {
        box-shadow: 0 0 20px #25c2a0;
      }

      100% {
        box-shadow: 0 0 10px #25c2a0;
      }
    }

    /* Make the table fill the card and space headers/cells */
    .card table,
    .reward-logic-table table {
      width: 100%;
      table-layout: auto;
      /* Let columns size naturally */
      border-collapse: separate;
      border-spacing: 0;
    }

    .card th,
    .card td,
    .reward-logic-table th,
    .reward-logic-table td {
      padding: 14px 12px;
      /* Adds horizontal and vertical space */
      text-align: center;
      vertical-align: middle;
      font-size: 1.07em;
      white-space: nowrap;
    }

    .card th,
    .reward-logic-table th {
      background: #161616;
      color: #25c2a0;
      font-weight: 700;
      font-size: 1.11em;
      letter-spacing: 0.03em;
      border-bottom: 2px solid #222;
    }

    .card td,
    .reward-logic-table td {
      border-bottom: 1px solid #232323;
    }

    .card tr:last-child td,
    .reward-logic-table tr:last-child td {
      border-bottom: none;
    }

    /* Responsive: Let table scroll horizontally on small screens */
    .overflow-auto {
      overflow-x: auto;
      width: 100%;
    }

    /* Optional: Make Thumbnail column wider */
    .card td:first-child,
    .card th:first-child {
      min-width: 90px;
    }

    .battle-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      align-items: center;
      margin-bottom: 24px;
    }

    @media (max-width: 700px) {
      .battle-actions {
        flex-direction: column;
        align-items: stretch;
      }
    }

    #claimBlock button {
      min-width: 150px;
    }

    /* Battle Controls Styling */
    .battle-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 20px;
      background: #191919;
      border-radius: 12px;
      margin: 0 20px;
    }

    .battle-controls input {
      width: 100%;
      max-width: 400px;
    }

    .battle-controls button {
      width: 100%;
      max-width: 300px;
    }

    /* === STAKING ZONE STYLES === */
    .staking-zone {
      max-width: 1000px;
      margin: 0 auto 30px auto;
      padding: 25px;
    }

    .staking-zone-bar {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      margin: 30px 20px;
      padding: 25px;
      width: calc(100% - 40px);
      box-sizing: border-box;
      max-width: none;
      color: #fff;
    }

    .staking-zone-bar h2,
    .staking-zone-bar h3,
    .staking-zone-bar p,
    .staking-zone-bar span,
    .staking-zone-bar div,
    .staking-zone-bar th,
    .staking-zone-bar td {
      color: #fff !important;
    }

    .staking-zone-bar .apy-banner-title,
    .staking-zone-bar .apy-rate-text,
    .staking-zone-bar .staking-stat-label {
      color: #fff !important;
    }

    .staking-zone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      margin: 0;
      font-size: 1.4em;
      font-weight: 600;
      color: #fff;
      transition: color 0.3s ease;
    }

    .staking-zone-header:hover {
      color: #25c2a0;
    }

    .staking-zone-content {
      margin-top: 20px;
    }

    .staking-table-container {
      margin-bottom: 20px;
    }

    .staking-table-wrapper {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* === ENHANCED STAKING TABLE STYLES === */
    .staking-zone-bar #stakingTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #1a1a1a;
      border-radius: 8px;
      overflow: hidden;
    }

    .staking-zone-bar #stakingTable th {
      background: #161616;
      color: #25c2a0 !important;
      font-weight: 700;
      font-size: 1.1em;
      padding: 16px 12px;
      text-align: center;
      border-bottom: 2px solid #333;
    }

    .staking-zone-bar #stakingTable td {
      color: #fff !important;
      padding: 14px 12px;
      text-align: center;
      border-bottom: 1px solid #333;
      background: #1a1a1a;
    }

    .staking-zone-bar #stakingTable tr:hover td {
      background: #222;
    }

    .staking-zone-bar .staking-positions-empty {
      color: #888 !important;
      font-style: italic;
      padding: 30px !important;
      text-align: center;
    }

    .staking-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .staking-summary-card {
      background: #1a1a1a;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .toggle-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
    }

    /* === WALDO PROMO STYLES === */
    .waldo-promo-content {
      background: linear-gradient(135deg, #25c2a0 0%, #00ff88 100%);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      color: #000;
    }

    .waldo-promo-icon {
      font-size: 2.5em;
      margin-bottom: 15px;
    }

    .waldo-promo-title {
      margin: 0;
      font-size: 1.8em;
      font-weight: bold;
    }

    .waldo-promo-subtitle {
      font-size: 1.1em;
      margin-top: 10px;
      opacity: 0.8;
    }

    /* === CONTENT LAYOUT STYLES === */
    .content-center {
      text-align: center;
      margin-top: 10px;
    }

    .content-center-padded {
      text-align: center;
      padding: 20px 0;
    }

    .large-number {
      font-size: 2.5em;
      font-weight: bold;
      margin: 15px 0;
    }

    .large-number-green {
      color: #00ff88;
    }

    .large-number-yellow {
      color: #ffd93d;
    }

    .subtitle-text {
      color: #aaa;
      font-size: 1.1em;
      margin-bottom: 15px;
    }

    .level-info {
      color: #25c2a0;
      font-weight: bold;
    }

    .next-level-info {
      color: #aaa;
      font-size: 0.9em;
      margin-top: 5px;
    }

    .hidden-input {
      display: none;
    }

    .chart-container {
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }

    .chart-canvas {
      max-width: 100%;
    }

    .activity-feed-padded {
      padding: 20px 0;
    }

    /* === APY BANNER STYLES === */
    .apy-banner {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }

    .apy-banner-title {
      color: #25c2a0;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .apy-banner-rates {
      display: flex;
      justify-content: space-around;
      font-size: 0.9em;
    }

    .apy-rate-text {
      color: #fff;
    }

    .apy-rate-green {
      color: #25c2a0;
    }

    .apy-rate-bright-green {
      color: #00ff88;
    }

    .apy-warning {
      font-size: 0.8em;
      color: #aaa;
      margin-top: 5px;
    }

    /* === STAKING STATS STYLES === */
    .staking-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .staking-stat-item {
      text-align: center;
    }

    .staking-stat-value {
      font-weight: bold;
    }

    .staking-stat-green {
      color: #25c2a0;
    }

    .staking-stat-bright-green {
      color: #00ff88;
    }

    .staking-stat-label {
      font-size: 0.85em;
      color: #aaa;
    }

    .staking-positions-empty {
      color: #aaa;
      text-align: center;
      padding: 20px;
    }

    .staking-button-container {
      margin-top: 15px;
      text-align: center;
    }

    /* === WALLET CONNECTION SCREEN STYLES === */
    .wallet-connection-screen {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    /* === LOADER STYLES === */
    .waldo-loader {
      position: fixed;
      z-index: 999999;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .waldo-loader-text {
      color: #25c2a0;
      font-size: 2.2em;
      font-weight: bold;
      letter-spacing: 2px;
    }

    /* === INSTRUCTION CARD STYLES === */
    .instruction-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .instruction-card-content {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .instruction-card-warning {
      background: #ffd93d20;
      padding: 8px;
      border-radius: 6px;
      margin-top: 10px;
      text-align: center;
    }

    .instruction-subtitle {
      font-size: 0.85em;
      color: #aaa;
      margin-bottom: 10px;
    }

    .tier-grid {
      display: grid;
      gap: 8px;
    }

    .tier-item {
      background: #25c2a020;
      padding: 8px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
    }

    .tier-item-blue {
      background: rgba(79, 195, 247, 0.5);
    }

    .tier-item-yellow {
      background: rgba(255, 217, 61, 0.5);
    }

    .tier-item-purple {
      background: rgba(156, 39, 176, 0.5);
    }

    .process-grid {
      display: grid;
      gap: 8px;
      font-size: 0.9em;
    }

    .process-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .process-number {
      background: #25c2a0;
      color: #000;
      padding: 4px 8px;
      border-radius: 50%;
      font-weight: bold;
      font-size: 0.8em;
      min-width: 24px;
      text-align: center;
    }

    .process-number-yellow {
      background: #ffd93d;
    }

    .warning-box {
      background: #ff6b6b20;
      padding: 8px;
      border-radius: 6px;
      margin-top: 12px;
      text-align: center;
    }

    .example-title {
      color: #ffd93d;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .example-card {
      background: #222;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .hidden {
      display: none;
    }

    .text-red {
      color: #ff6b6b;
    }

    .text-green {
      color: #25c2a0;
    }

    .text-yellow {
      color: #ffd93d;
    }

    .text-blue {
      color: #4fc3f7;
    }

    .text-purple {
      color: #9c27b0;
    }

    .text-gray {
      color: #ccc;
    }

    .text-light-gray {
      color: #aaa;
    }

    .text-dark-gray {
      color: #666;
    }

    .font-bold {
      font-weight: bold;
    }

    .font-small {
      font-size: 0.85em;
    }

    .font-tiny {
      font-size: 0.75em;
    }

    .margin-bottom-5 {
      margin-bottom: 5px;
    }

    .margin-bottom-6 {
      margin-bottom: 6px;
    }

    .margin-bottom-8 {
      margin-bottom: 8px;
    }

    .margin-bottom-10 {
      margin-bottom: 10px;
    }

    .margin-top-5 {
      margin-top: 5px;
    }

    .margin-top-10 {
      margin-top: 10px;
    }

    .padding-20 {
      padding: 20px;
    }

    /* === XP MULTIPLIERS STYLES === */
    .xp-multipliers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }

    .xp-multiplier-card {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .xp-multiplier-value {
      font-size: 1.5em;
      font-weight: bold;
    }

    .xp-multiplier-value-green {
      color: #25c2a0;
    }

    .xp-multiplier-value-red {
      color: #ff6b6b;
    }

    .xp-multiplier-value-yellow {
      color: #ffd93d;
    }

    .xp-multiplier-value-light-green {
      color: #6bcf7f;
    }

    .xp-multiplier-label {
      font-size: 0.9em;
      color: #aaa;
    }

    .xp-multiplier-description {
      font-size: 0.8em;
      color: #666;
      margin-top: 5px;
    }

    .xp-tips-box {
      background: #191919;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: center;
    }

    .xp-tips-title {
      color: #25c2a0;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .xp-tips-content {
      font-size: 0.9em;
      color: #ccc;
    }

    /* === XP BREAKDOWN STYLES === */
    .xp-breakdown-container {
      padding: 15px 0;
    }

    .xp-breakdown-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .xp-breakdown-row:last-child {
      margin-bottom: 0;
    }

    .xp-breakdown-label {
      color: #fff;
      font-weight: 500;
    }

    .xp-breakdown-value {
      color: #25c2a0;
      font-weight: bold;
    }

    .xp-breakdown-value-yellow {
      color: #ffd93d;
      font-weight: bold;
    }

    /* === INSTRUCTION CARDS SPACING === */
    .instruction-cards-spacing {
      margin: 30px 0;
    }

    /* === FULL-WIDTH INSTRUCTION CARDS === */
    .instruction-cards-full-width {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      margin: 30px 20px;
      width: calc(100% - 40px);
      box-sizing: border-box;
    }

    /* When inside staking zone, adjust margins */
    .staking-zone-content .instruction-cards-full-width {
      margin: 20px 0 30px 0;
      width: 100%;
    }

    .instruction-card-full {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 25px;
      color: #fff;
    }

    .instruction-card-full h2 {
      margin: 0 0 20px 0;
      color: #fff;
      font-size: 1.4em;
    }

    @media (max-width: 768px) {
      .instruction-cards-full-width {
        grid-template-columns: 1fr;
        margin: 30px 10px;
        width: calc(100% - 20px);
      }
    }

    /* === MEDIA CARD STYLES === */
    .media-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 15px;
      justify-items: center;
    }

    .media-item {
      text-align: center;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .media-item:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .media-image {
      width: 100%;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .media-title {
      color: #25c2a0;
      font-weight: 600;
      font-size: 0.9em;
      margin-bottom: 5px;
    }

    .media-description {
      color: #ccc;
      font-size: 0.8em;
      line-height: 1.3;
    }

    /* === REFERRAL BENEFITS STYLES === */
    .referral-benefits {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .benefit-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      background: rgba(37, 194, 160, 0.1);
      border-radius: 6px;
    }

    .benefit-icon {
      font-size: 1.2em;
    }

    .benefit-text {
      color: #fff;
      font-size: 0.9em;
    }

    /* === ACTIVITY FEED STYLES === */
    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid #333;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-icon {
      font-size: 1.1em;
      min-width: 20px;
    }

    .activity-text {
      flex: 1;
      color: #fff;
      font-size: 0.9em;
    }

    .activity-time {
      color: #888;
      font-size: 0.8em;
    }

    .activity-footer {
      margin-top: 15px;
      text-align: center;
    }

    @media (max-width: 768px) {
      .media-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .referral-benefits {
        gap: 8px;
      }
    }

    /* === MOVING LEVEL PROGRESS STYLES === */
    .level-title-centered {
      text-align: center;
      margin: 10px 0 20px 0;
      color: #25c2a0;
      font-weight: 600;
      font-size: 1.1em;
    }

    .level-progress-container {
      position: relative;
      margin: 20px 30px;
      /* Add side margins to shorten the bar */
      overflow: visible;
      padding-top: 30px;
    }

    .level-progress-indicator {
      position: absolute;
      top: -30px;
      left: 0%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: left 0.5s ease;
      z-index: 5;
      max-width: 60px;
    }

    .level-icon-moving {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #25c2a0;
      background: #1a1a1a;
      padding: 1px;
      margin-bottom: 3px;
      object-fit: cover;
    }

    .xp-next-level-moving {
      background: rgba(37, 194, 160, 0.9);
      color: #fff;
      padding: 3px 6px;
      border-radius: 8px;
      font-size: 0.7em;
      font-weight: 600;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(37, 194, 160, 0.3);
      min-width: 60px;
      text-align: center;
    }

    #levelProgress {
      width: 100%;
      height: 20px;
      border-radius: 10px;
      background: #333;
      border: none;
      overflow: hidden;
    }

    #levelProgress::-webkit-progress-bar {
      background: #333;
      border-radius: 10px;
    }

    #levelProgress::-webkit-progress-value {
      background: linear-gradient(90deg, #25c2a0, #00ff88);
      background-size: 200% 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
      animation: progressShimmer 6s linear infinite;
    }

    #levelProgress::-moz-progress-bar {
      background: linear-gradient(90deg, #25c2a0, #00ff88);
      background-size: 200% 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
      animation: progressShimmer 6s linear infinite;
    }

    @media (max-width: 768px) {
      .level-icon-moving {
        width: 20px;
        height: 20px;
      }

      .xp-next-level-moving {
        font-size: 0.65em;
        padding: 2px 4px;
        min-width: 50px;
      }

      .level-progress-indicator {
        top: -20px;
      }

      .level-progress-container {
        margin: 20px 20px;
        /* Smaller side margins on mobile */
      }
    }

    /* === REWARD TIERS & MY MEMES CARD === */
    .reward-tiers-section {
      margin-bottom: 30px;
      padding-bottom: 25px;
      border-bottom: 1px solid #333;
    }

    .reward-tiers-section h3,
    .my-memes-section h3 {
      color: #25c2a0;
      margin: 0 0 15px 0;

      /* Global keyframes and helper classes for progress/indicator */
      @keyframes progressShimmer {
        0% {
          background-position: 0% 0;
        }

        100% {
          background-position: -200% 0;
        }
      }

      .level-progress-indicator.pulse {
        animation: indicatorPulse 1.2s ease-out 1;
      }

      @keyframes indicatorPulse {
        0% {
          transform: translateX(-50%) scale(0.96);
          filter: drop-shadow(0 0 0 rgba(37, 194, 160, 0));
        }

        60% {
          transform: translateX(-50%) scale(1.06);
          filter: drop-shadow(0 0 8px rgba(37, 194, 160, 0.6));
        }

        100% {
          transform: translateX(-50%) scale(1);
          filter: drop-shadow(0 0 0 rgba(37, 194, 160, 0));
        }
      }

      font-size: 1.2em;
      font-weight: 600;
    }

    /* Eligibility card glow when eligible */
    #eligibilityCard.eligible {
      box-shadow: 0 0 18px rgba(37, 194, 160, 0.25), inset 0 0 12px rgba(37, 194, 160, 0.15);
      animation: eligGlow 3.5s ease-in-out infinite;
    }

    @keyframes eligGlow {

      0%,
      100% {
        box-shadow: 0 0 12px rgba(37, 194, 160, 0.18), inset 0 0 8px rgba(37, 194, 160, 0.10);
      }

      50% {
        box-shadow: 0 0 24px rgba(37, 194, 160, 0.35), inset 0 0 16px rgba(37, 194, 160, 0.18);
      }
    }

    /* Spark particle that travels with the indicator on milestone updates */
    .level-progress-indicator .spark {
      position: absolute;
      top: 10px;
      left: 0;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #00ff88;
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.8);
      opacity: 0;
      transform: translateX(-8px) translateY(-6px) scale(0.8);
      animation: sparkFly 700ms ease-out forwards;
      pointer-events: none;
    }

    @keyframes sparkFly {
      0% {
        opacity: 0;
        transform: translateX(-8px) translateY(-6px) scale(0.8);
      }

      20% {
        opacity: 1;
      }

      100% {
        opacity: 0;
        transform: translateX(16px) translateY(6px) scale(0.9);
      }
    }


    .tiers-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }

    .tier-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .tier-card:hover {
      background: rgba(255, 255, 255, 0.08);
      transform: translateY(-2px);
    }

    .tier-1 {
      border-left: 3px solid #cd7f32;
    }

    .tier-2 {
      border-left: 3px solid #c0c0c0;
    }

    .tier-3 {
      border-left: 3px solid #ffd700;
    }

    .tier-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .tier-icon {
      font-size: 1.2em;
    }

    .tier-title {
      color: #fff;
      font-weight: 600;
    }

    .tier-requirements {
      color: #ccc;
      font-size: 0.9em;
      margin-bottom: 8px;
    }

    .tier-reward {
      color: #25c2a0;
      font-weight: 700;
      font-size: 1.1em;
    }

    .tier-multiplier-note {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(37, 194, 160, 0.1);
      padding: 10px;
      border-radius: 6px;
    }

    .multiplier-icon {
      color: #ffd93d;
      font-size: 1.1em;
    }

    .multiplier-text {
      color: #25c2a0;
      font-weight: 600;
      font-size: 0.9em;
    }

    .my-memes-section {
      margin-top: 25px;
    }

    .memes-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .meme-stat {
      text-align: center;
      padding: 15px;
      background: rgba(37, 194, 160, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(37, 194, 160, 0.2);
    }

    .stat-number {
      display: block;
      color: #25c2a0;
      font-size: 1.8em;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-label {
      color: #ccc;
      font-size: 0.9em;
    }

    .memes-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .tiers-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .memes-summary {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .memes-actions {
        flex-direction: column;
        gap: 8px;
      }
    }

    /* === SHORT TERM OPTION COLLAPSIBLE CARD === */
    .collapsible-container {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 25px;
      margin: 36px 0;
      /* Half inch spacing (36px ≈ 0.5 inch) */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .collapsible-header {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 0 20px 0;
      padding: 0;
      transition: color 0.3s ease;
      color: #fff;
      font-size: 1.4em;
      font-weight: 600;
    }

    .collapsible-header:hover {
      color: #25c2a0;
    }

    .toggle-icon {
      font-size: 1.2em;
      transition: transform 0.3s ease;
      color: #25c2a0;
    }

    .toggle-icon.collapsed {
      transform: rotate(-90deg);
    }

    .collapsible-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
      max-height: 0;
      padding: 0;
      margin: 0;
    }

    .collapsible-content.expanded {
      max-height: 2000px;
      padding: inherit;
      margin: inherit;
    }

    .collapsible-content .card {
      margin-bottom: 20px;
      background: #222;
      border: 1px solid #444;
    }

    .collapsible-content .card:last-child {
      margin-bottom: 0;
    }

    /* === AUTO-CONTINUE STAKING STYLES === */
    .auto-continue-explanation {
      margin: 20px 0;
      padding: 20px;
      background: rgba(37, 194, 160, 0.15);
      border-radius: 8px;
      border-left: 3px solid #25c2a0;
    }

    .auto-continue-step {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
      gap: 15px;
    }

    .auto-continue-step:last-child {
      margin-bottom: 0;
    }

    .step-number {
      background: #25c2a0;
      color: #000;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 0.9em;
      flex-shrink: 0;
    }

    .step-content {
      flex: 1;
    }

    .step-title {
      color: #25c2a0;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .step-description {
      color: #ccc;
      font-size: 0.9em;
      line-height: 1.4;
    }

    .tier-item-default {
      border-left: 3px solid #25c2a0;
      background: rgba(37, 194, 160, 0.3);
    }

    .text-small {
      display: block;
      font-size: 0.8em;
      color: #aaa;
      margin-top: 4px;
    }

    .duplicate-restrictions-secondary {
      margin-top: 15px;
    }

    /* === ENHANCED WALDO MERGED CARD === */
    .waldo-merged-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-top: 20px;
    }

    .waldo-section {
      background: rgba(37, 194, 160, 0.05);
      border: 1px solid rgba(37, 194, 160, 0.2);
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s ease;
      overflow: hidden;
      box-sizing: border-box;
    }

    .waldo-section:hover {
      background: rgba(37, 194, 160, 0.08);
      border-color: rgba(37, 194, 160, 0.3);
      transform: translateY(-2px);
    }

    .waldo-section-header {
      margin-bottom: 15px;
    }

    .waldo-section-title {
      margin: 0 0 8px 0;
      color: #25c2a0;
      font-size: 1.1em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .waldo-section-divider {
      height: 2px;
      background: linear-gradient(90deg, #25c2a0, transparent);
      border-radius: 1px;
      width: 60px;
    }

    .waldo-section-content {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .waldo-value-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .value-detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
    }

    .value-label {
      color: #ccc;
      font-size: 0.9em;
    }

    .value-amount {
      color: #25c2a0;
      font-weight: 600;
    }

    .chart-container-enhanced {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-sizing: border-box;
      max-width: 100%;
    }

    .trend-stats {
      display: flex;
      justify-content: flex-start;
      gap: 15px;
      padding-left: 0;
    }

    .trend-stat-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      min-width: 120px;
    }

    .trend-label {
      color: #ccc;
      font-size: 0.85em;
      margin-bottom: 4px;
    }

    .trend-value {
      font-weight: 600;
      font-size: 0.95em;
    }

    .trend-positive {
      color: #25c2a0;
    }

    .trend-negative {
      color: #ff6b6b;
    }

    @media (max-width: 768px) {
      .waldo-merged-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .trend-stats {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* === STAKING PROCESS STYLES === */
    .staking-process-section {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .staking-process-title {
      color: #25c2a0;
      margin-top: 0;
    }

    .staking-process-title-yellow {
      color: #ffd93d;
      margin-top: 0;
    }

    .staking-process-title-green {
      color: #00ff88;
      margin-top: 0;
    }

    .staking-process-step {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }

    .staking-process-number {
      background: #25c2a0;
      color: #000;
      padding: 8px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.8em;
    }

    .staking-process-number-yellow {
      background: #ffd93d;
    }

    .staking-process-text {
      flex: 1;
      color: #ccc;
    }

    .staking-tier-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .staking-tier-card {
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .staking-tier-card-green {
      background: #25c2a0d3;
    }

    .staking-tier-card-blue {
      background: #4fc2f7c1;
    }

    .staking-tier-card-yellow {
      background: #caa617f0;
    }

    .staking-tier-card-purple {
      background: #9b27b0e1;
    }

    .staking-tier-title {
      font-weight: bold;
    }

    .staking-tier-subtitle {
      color: #ccc;
      font-size: 0.9em;
    }

    .staking-example-section {
      background: #191919;
      padding: 15px;
      border-radius: 8px;
    }

    .staking-example-card {
      background: #222;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .staking-example-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      font-size: 0.9em;
    }

    .staking-restrictions-box {
      background: #ff6b6b20;
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
    }

    .staking-restrictions-title {
      color: #ff6b6b;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .staking-restrictions-text {
      font-size: 0.85em;
      color: #ccc;
    }

    /* === BATTLE ARENA STYLES === */
    .battle-arena {
      max-width: 800px;
      margin: 0 auto 20px auto;
    }

    .battle-content {
      display: block;
    }

    .battle-history-container {
      display: none;
    }

    /* === MODAL STYLES === */
    .modal-container {
      display: none;
    }

    .modal-content {
      background: #111;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      margin: 50px auto;
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      cursor: pointer;
    }

    .modal-title {
      color: #25c2a0;
      margin-top: 0;
    }

    .modal-field {
      margin: 20px 0;
    }

    .modal-label {
      color: #fff;
      display: block;
      margin-bottom: 5px;
    }

    .modal-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #222;
      color: #fff;
    }

    .modal-select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: #222;
      color: #fff;
    }

    .modal-estimate {
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .modal-estimate-title {
      color: #25c2a0;
      font-weight: bold;
    }

    .modal-estimate-content {
      color: #fff;
      margin-top: 5px;
    }

    .modal-button {
      width: 100%;
      margin-top: 15px;
    }

    /* === TABLE STYLES === */
    .table-empty {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .table-italic {
      font-style: italic;
    }

    .table-center {
      text-align: center;
    }

    /* === PAGINATION STYLES === */
    .pagination-bold {
      font-weight: bold;
    }

    /* === LEADERBOARD STYLES === */
    .leaderboard-rank {
      font-size: 1.6em;
    }

    .leaderboard-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 8px;
    }

    .leaderboard-avatar-placeholder {
      display: inline-block;
      width: 38px;
      height: 38px;
      background: #222;
      border-radius: 50%;
      margin-right: 8px;
    }

    .leaderboard-twitter-link {
      color: #1da1f2;
      text-decoration: none;
    }

    .leaderboard-unknown {
      color: #aaa;
    }

    .leaderboard-wallet {
      font-size: 12px;
    }

    .leaderboard-wins {
      font-weight: bold;
      color: gold;
    }

    /* === DAO STYLES === */
    .dao-placeholder {
      color: #666;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }

    /* === JAVASCRIPT GENERATED CONTENT STYLES === */
    .js-table-empty {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    .js-table-italic {
      color: #666;
      font-style: italic;
    }

    .js-pagination-bold {
      font-weight: bold;
    }

    .js-estimate-rewards {
      color: #25c2a0;
    }

    .js-estimate-total {
      color: #00ff88;
    }

    .js-estimate-apy {
      color: #aaa;
      font-size: 0.9em;
    }

    .js-button-tiered {
      width: 100%;
      margin-top: 10px;
      font-size: 0.9em;
      background: #ffd93d;
      color: #000;
    }

    .js-button-unstake {
      width: 100%;
      margin-top: 10px;
      font-size: 0.9em;
    }

    .js-status-completed {
      text-align: center;
      margin-top: 8px;
      font-size: 0.8em;
      color: #aaa;
    }

    .js-status-processing {
      text-align: center;
      margin-top: 8px;
      font-size: 0.8em;
      color: #ff6b6b;
    }

    .js-status-locked {
      text-align: center;
      margin-top: 8px;
      font-size: 0.8em;
      color: #aaa;
    }

    .js-position-card {
      background: #222;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 3px solid;
    }

    .js-position-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .js-position-amount {
      font-weight: bold;
    }

    .js-position-details {
      font-size: 0.8em;
      color: #aaa;
    }

    .js-position-status {
      font-size: 0.75em;
    }

    .js-position-right {
      text-align: right;
    }

    .js-position-rewards {
      color: #00ff88;
      font-weight: bold;
    }

    .js-position-unlock {
      font-size: 0.8em;
      color: #aaa;
    }

    .js-no-stakes {
      color: #aaa;
      text-align: center;
      padding: 20px;
    }

    .js-activity-placeholder {
      color: #666;
      font-style: italic;
    }

    .js-leaderboard-rank {
      font-size: 1.6em;
    }

    .js-leaderboard-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 8px;
    }

    .js-leaderboard-placeholder {
      display: inline-block;
      width: 38px;
      height: 38px;
      background: #222;
      border-radius: 50%;
      margin-right: 8px;
    }

    .js-leaderboard-twitter {
      color: #1da1f2;
      text-decoration: none;
    }

    .js-leaderboard-unknown {
      color: #aaa;
    }

    .js-leaderboard-wallet {
      font-size: 12px;
    }

    .js-leaderboard-wins {
      font-weight: bold;
      color: gold;
    }

    /* === REMAINING DUPLICATE SECTION STYLES === */
    .duplicate-example-section {
      background: #191919;
      padding: 15px;
      border-radius: 8px;
    }

    .duplicate-example-title {
      color: #00ff88;
      margin-top: 0;
    }

    .duplicate-example-card {
      background: #222;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .duplicate-example-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      font-size: 0.9em;
    }

    .duplicate-journey-content {
      font-size: 0.9em;
      color: #ccc;
      line-height: 1.6;
    }

    .duplicate-journey-step {
      margin-bottom: 6px;
    }

    .duplicate-restrictions {
      background: #ff6b6b20;
      padding: 10px;
      border-radius: 6px;
      margin-top: 15px;
    }

    .duplicate-restrictions-title {
      color: #ff6b6b;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .duplicate-restrictions-text {
      font-size: 0.85em;
      color: #ccc;
    }

    /* === WALDO PROMO STYLES === */
    .waldo-promo-content {
      background: linear-gradient(135deg, #25c2a0 0%, #00ff88 100%);
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      color: #000;
    }

    .waldo-promo-icon {
      font-size: 2.5em;
      margin-bottom: 15px;
    }

    .waldo-promo-title {
      margin: 0;
      font-size: 1.8em;
      font-weight: bold;
    }

    .waldo-promo-subtitle {
      font-size: 1.1em;
      margin-top: 10px;
      opacity: 0.8;
    }

    /* === MEDIUM CARD STYLES === */
    .medium-card {
      max-width: 700px;
      margin: 0 auto;
      padding: 25px;
    }

    .medium-card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .medium-card-single {
      max-width: 700px;
      margin: 0 auto 30px auto;
      padding: 25px;
    }

    /* === RESPONSIVE STYLES === */
    @media (max-width: 768px) {
      .battle-controls {
        margin: 0 10px;
      }

      .medium-card-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .medium-card,
      .medium-card-single,
      .staking-zone {
        max-width: 100%;
        margin: 0 auto 20px auto;
        padding: 20px;
      }

      .staking-summary-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
    }

    #waldoNotification {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      min-width: 270px;
      max-width: 92vw;
      background: #111;
      color: #fff;
      border-radius: 10px;
      box-shadow: 0 0 18px #25c2a0aa;
      padding: 18px 32px;
      font-size: 1.17rem;
      font-weight: 600;
      opacity: 0.98;
      transition: opacity 0.4s;
    }

    #waldoNotification .dismiss-btn {
      margin-left: 24px;
      background: transparent;
      border: 1.5px solid #25c2a0;
      color: #25c2a0;
      font-size: 1rem;
      font-weight: bold;
      padding: 6px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
    }

    #waldoNotification .dismiss-btn:hover {
      background: #25c2a0;
      color: #111;
    }

    .nft-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.92);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }

    .nft-modal[style*="display: block"] {
      display: flex !important;
    }

    .close-nft-modal {
      position: absolute;
      top: 24px;
      right: 36px;
      color: #fff;
      font-size: 3rem;
      cursor: pointer;
      font-weight: bold;
      z-index: 10002;
    }

    .nft-modal-image {
      max-width: 96vw;
      max-height: 80vh;
      border-radius: 18px;
      box-shadow: 0 0 40px #25c2a0;
    }

    /* NFT Collection Grid Styles */
    .nft-collection-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
      min-height: 120px;
    }

    .nft-collection-item {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border-radius: 12px;
      border: 1px solid #333;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
    }

    .nft-collection-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(37, 194, 160, 0.3);
      border-color: #25c2a0;
    }

    .nft-collection-image {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: #222;
    }

    .nft-collection-info {
      padding: 12px;
    }

    .nft-collection-title {
      font-size: 0.9rem;
      font-weight: bold;
      color: #eee;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.3;
    }

    .nft-collection-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #ccc;
      margin-bottom: 8px;
    }

    .nft-collection-rarity {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .rarity-common {
      background: #9E9E9E;
      color: white;
    }

    .rarity-uncommon {
      background: #4CAF50;
      color: white;
    }

    .rarity-rare {
      background: #2196F3;
      color: white;
    }

    .rarity-epic {
      background: #9C27B0;
      color: white;
    }

    .rarity-legendary {
      background: #FFD700;
      color: black;
    }

    .nft-collection-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }

    .marketplace-btn {
      background: linear-gradient(45deg, #25c2a0, #00ff88) !important;
      color: white !important;
      border: none !important;
    }

    .manage-btn {
      background: linear-gradient(45deg, #ff5252, #ff8a80) !important;
      color: white !important;
      border: none !important;
    }

    .nft-empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #ccc;
      grid-column: 1 / -1;
    }

    .nft-empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: #25c2a0;
    }

    .loading-spinner {
      text-align: center;
      padding: 40px 20px;
      color: #ccc;
      grid-column: 1 / -1;
    }

    .loading-spinner::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ccc;
      border-radius: 50%;
      border-top-color: #25c2a0;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 768px) {
      .nft-collection-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
      }

      .nft-collection-actions {
        flex-direction: column;
      }
    }

    .battle-leaderboard-table {
      width: 100%;
      text-align: left;
    }
  </style>
</head>

<body>
  <!-- Wallet Connection Screen -->
  <div id="walletConnectionScreen" class="wallet-connection-screen">
    <div class="dashboard-title-card">
      <h1 class="dashboard-title">WALDOcoin Dashboard</h1>
      <p class="dashboard-subtitle">Connect your wallet to access your stats, battles, and rewards.</p>
      <button id="connectWalletBtn" class="button-style" style="margin-top: 20px;">
        Connect XUMM Wallet
      </button>
    </div>
  </div>

  <div id="waldoLoader" class="waldo-loader" style="display: none;">
    <span class="waldo-loader-text">Loading WALDO Dashboard...</span>
  </div>

  <!-- Main Dashboard Content -->
  <div id="mainContent" style="display: none;">

    <!-- WALDO Dashboard Title -->
    <div>
      <div class="dashboard-title-card">
        <h1 class="dashboard-title">WALDOcoin Dashboard</h1>
        <p class="dashboard-subtitle">Track your memes, earn rewards, and battle for the leaderboard.</p>
      </div>
      <!-- Instructions Card -->
    </div>
    <div class="instruction-card">
      <h2>🚀 How to Earn WALDO</h2>
      <ul>
        <li>🖼 Post a meme on Twitter with the hashtag <strong>#WaldoMeme</strong></li>
        <li>🔗 Link your Twitter handle to your WALDO wallet below</li>
        <li>📊 Watch your meme earn XP and rewards</li>
        <li>🏆 Claim or stake your rewards on the dashboard</li>
        <li>🔥 Mint your meme as an NFT when it hits 60 XP</li>
      </ul>
    </div>
    <!-- Notification bar -->
    <div id="waldoNotification">
      <span id="waldoMessage">👋 Welcome back! Ready to earn some WALDO?</span>
      <button type="button" onclick="dismissWaldoNotification()" class="dismiss-btn">Dismiss</button>
    </div>
    <div class="container">
      <!-- WELCOME CARD + LINK TWITTER ACCOUNT -->
      <div class="card big-card">
        <div id="walletControls">
          <button type="button" onclick="logoutWallet()" class="disconnect-btn" id="disconnectBtn"
            style="display:none;">Disconnect</button>
          <button type="button" onclick="connectWallet()" class="connect-btn" id="connectBtn">Connect Wallet</button>
        </div>
        <p id="walletAddress" class="wallet-address">Wallet: Not Connected</p>
        <h3 class="center-text">🔗 Link Twitter Account</h3>
        <div class="twitter-link-container">
          <input type="text" id="twitterHandleInput" placeholder="Enter Twitter handle" class="input-style">
          <button id="linkButton" type="button" onclick="linkTwitterAccount()" class="button-style">Link
            Twitter</button>
        </div>
        <h2>🎮 Member Level</h2>
        <p id="userLevelTitle" class="center-text level-title-centered">Loading...</p>

        <div class="level-progress-container">
          <progress id="levelProgress" max="100" value="0"></progress>
          <div class="level-progress-indicator" id="levelProgressIndicator">
            <img id="userLevelIcon" alt="Level Icon"
              src="https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg" class="level-icon-moving">
            <div id="xpToNextLevel" class="xp-next-level-moving">...</div>
          </div>
        </div>
      </div>


      <!-- Eligibility Badge Card (top status) -->
      <div class="card" id="eligibilityCard">
        <h2>✅ WALDO Eligibility</h2>
        <div class="content-center">
          <div class="large-number" id="eligibilityStatus">Checking…</div>
          <div class="subtitle-text" id="eligibilityDetail">—</div>
        </div>
      </div>

      <!-- XP Trends -->
      <div class="card">
        <h2>📊 Meme XP Trends</h2>
        <canvas height="200" id="xpChart"></canvas>
      </div>
      <!-- Social Stats -->
      <div class="card">
        <h2>📱 Social Stats</h2>
        <p><strong>🔥 Top Meme:</strong> <span id="socialHandle">Loading...</span></p>
        <p><strong>👥 Followers:</strong> <span id="socialFollowers">—</span></p>
        <p><strong>🔥 Total Likes:</strong> <span id="totalLikes">Loading...</span></p>
        <p><strong>🏆 Top Meme Likes:</strong> <span id="topMemeLikes">Loading...</span></p>
        <p><strong>🖼️ Top Meme Preview:</strong></p>
        <img id="topMemeImage" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png"
          alt="Top Meme" class="meme-thumb">
        <p><a id="topMemeLink" href="#" target="_blank" class="xrpl-link-green">🔗 View Meme</a></p>
      </div>

      <!-- WALDO Value & Trend -->
      <div class="card">
        <h2>💸 WALDO Market Data</h2>
        <div class="waldo-merged-container">

          <!-- Current Value Section -->
          <div class="waldo-section">
            <div class="waldo-section-header">
              <h3 class="waldo-section-title">💰 Current Value</h3>
              <div class="waldo-section-divider"></div>
            </div>
            <div class="waldo-section-content">
              <div class="waldo-value-details">
                <div class="value-detail-item">
                  <span class="value-label">XRP Rate:</span>
                  <span class="value-amount" id="waldoXrpRate">Loading...</span>
                </div>
                <div class="value-detail-item">
                  <span class="value-label">USD Rate:</span>
                  <span class="value-amount" id="waldoUsdRate">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Trend Chart Section -->
          <div class="waldo-section">
            <div class="waldo-section-header">
              <h3 class="waldo-section-title">📈 7-Day Price Trend</h3>
              <div class="waldo-section-divider"></div>
            </div>
            <div class="waldo-section-content">
              <div class="chart-container-enhanced">
                <canvas height="140" id="waldoPriceChartMerged" class="chart-canvas"></canvas>
              </div>
              <div class="trend-stats">
                <div class="trend-stat-item">
                  <span class="trend-label">24h Change:</span>
                  <span class="trend-value trend-positive" id="change24h">+0.00%</span>
                </div>
                <div class="trend-stat-item">
                  <span class="trend-label">7d Change:</span>
                  <span class="trend-value trend-positive" id="change7d">+0.00%</span>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Meme XP Score -->
      <div class="card" id="memeScoreCard">
        <h2>🎯 Your Meme XP Score</h2>
        <div class="meme-score-container">
          <p id="memeScoreDisplay" class="meme-score-enhanced">0</p>
        </div>
        <div class="content-center">
          <div class="level-info" id="currentLevel">Level 1: Waldo Watcher</div>
          <div class="next-level-info" id="nextLevelInfo">250 XP to Level 2</div>
        </div>
      </div>

      <!-- Next Level Requirements Card -->
      <div class="card" id="nextLevelRequirementsCard">
        <h2>📈 Next Level Requirements</h2>
        <div id="reqStatusSummary" style="color:#ccc;margin-bottom:8px;">Loading...</div>
        <ul style="list-style:none;padding-left:0;margin:0;display:flex;flex-direction:column;gap:8px;">
          <li>
            <strong>XP Needed:</strong>
            <span id="reqXpNeeded">—</span>
          </li>
          <li>
            <strong>Memes Minted:</strong>
            <span id="reqMintedProgress">—</span>
          </li>
          <li>
            <strong>Battles Won:</strong>
            <span id="reqBattlesProgress">—</span>
          </li>
          <li>
            <strong>Referrals:</strong>
            <span id="reqReferralsProgress">—</span>
          </li>
        </ul>
        <div style="font-size:0.85rem;color:#888;margin-top:8px;">
          Note: For the next level, you need XP threshold plus either Battles Won or Referrals (whichever you meet), and
          minimum Memes Minted.
        </div>
      </div>


      <!-- WALDO/USD Trend -->
      <div class="card">
        <h2>📈 WALDO/USD Trend (7 Days)</h2>
        <div class="chart-container">
          <canvas height="160" id="waldoPriceChartNew" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- XP Gain Breakdown -->
      <div class="card">
        <h2>🧠 XP Gain Breakdown</h2>
        <div class="xp-breakdown-container">
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">❤️ Likes</span>
            <span class="xp-breakdown-value" id="likesXP">0 XP</span>
          </div>
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">🔁 Retweets</span>
            <span class="xp-breakdown-value" id="retweetsXP">0 XP</span>
          </div>
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">⚔️ Battle Wins</span>
            <span class="xp-breakdown-value" id="battleWinsXP">0 XP</span>
          </div>
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">📣 Referrals</span>
            <span class="xp-breakdown-value" id="referralsXP">0 XP</span>
          </div>
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">🗳 Meme Voting</span>
            <span class="xp-breakdown-value" id="votingXP">0 XP</span>
          </div>
          <div class="xp-breakdown-row">
            <span class="xp-breakdown-label">⏳ Staking Bonus</span>
            <span class="xp-breakdown-value-yellow" id="stakingBonusXP">0%</span>
          </div>
        </div>
      </div>
    </div> <!-- End container -->

    <!-- Three Cards Above Staking Zone -->
    <div class="container">

      <!-- Media Card -->
      <div class="card">
        <h2>📺 WALDO Promo Media</h2>
        <div class="media-grid">
          <div class="media-item">
            <img src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="WALDO Promo"
              class="media-image">
            <div class="media-title">Official Trailer</div>
            <div class="media-description">Watch the WALDOCOIN introduction video</div>
          </div>
          <div class="media-item">
            <img src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="WALDO Guide"
              class="media-image">
            <div class="media-title">How-To Guide</div>
            <div class="media-description">Learn how to earn and stake WALDO</div>
          </div>
          <div class="media-item">
            <img src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="WALDO News"
              class="media-image">
            <div class="media-title">Latest Updates</div>
            <div class="media-description">Stay updated with WALDOCOIN news</div>
          </div>
        </div>
      </div>

      <!-- Referral Program -->
      <div class="card">
        <h2>🤝 Referral Program</h2>
        <div class="content-center-padded">
          <div class="large-number large-number-yellow" id="refCountMain">0</div>
          <div class="subtitle-text">Friends Referred</div>
          <button type="button" onclick="copyReferral()" class="button-style">Copy Referral Link</button>
          <input id="referralLinkMain" readonly type="text" class="hidden-input">
          <p id="copyStatusMain" class="twitter-link-status"></p>
        </div>
        <div class="referral-benefits">
          <div class="benefit-item">
            <span class="benefit-icon">🎁</span>
            <span class="benefit-text">Earn 5% of friend's rewards</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-icon">⚡</span>
            <span class="benefit-text">XP multiplier bonus</span>
          </div>
          <div class="benefit-item">
            <span class="benefit-icon">🏆</span>
            <span class="benefit-text">Leaderboard ranking boost</span>
          </div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="card">
        <h2>📰 Recent Activity</h2>
        <ul id="activityFeedMain" class="activity-feed activity-feed-padded">
          <li class="activity-item">
            <span class="activity-icon">🎉</span>
            <span class="activity-text">Welcome to WALDOCOIN!</span>
            <span class="activity-time">Just now</span>
          </li>
          <li class="activity-item">
            <span class="activity-icon">📊</span>
            <span class="activity-text">Dashboard loaded successfully</span>
            <span class="activity-time">1 min ago</span>
          </li>
          <li class="activity-item">
            <span class="activity-icon">🔗</span>
            <span class="activity-text">Connect your wallet to see more activity</span>
            <span class="activity-time">2 min ago</span>
          </li>
        </ul>
        <div class="activity-footer">
          <button type="button" class="button-style button-secondary" onclick="loadMoreActivity()">Load More</button>
        </div>
      </div>
      <!-- Per‑Meme Matured Redemptions -->
      <div class="card" id="perMemeRedemptionsCard">
        <h2>🎯 Per‑Meme Matured Redemptions</h2>
        <p><strong>Count:</strong> <span id="pmRedCount">—</span></p>
        <p><strong>Total Paid:</strong> <span id="pmRedTotal">—</span></p>
        <div id="pmRedList"></div>
      </div>


    </div> <!-- End container -->

    <!-- 🔒 COMPREHENSIVE WALDO STAKING ZONE (FULL-WIDTH BAR) -->
    <div class="staking-zone-bar">
      <h2 class="staking-zone-header" onclick="toggleStakingZone()">
        🔒 WALDO Staking Zone (Long Term APY%)
        <span id="stakingZoneToggleIcon" class="toggle-icon collapsed">►</span>
      </h2>

      <div id="stakingZoneSection" class="staking-zone-content">

        <!-- Staking Instruction Cards Inside Zone -->
        <div class="instruction-cards-full-width">

          <!-- Initial Choice -->
          <div class="instruction-card-full">
            <h2>🎯 Initial Choice</h2>
            <div class="instruction-card-content">
              <div class="text-red font-bold margin-bottom-5">❌ Instant Payout</div>
              <div class="font-small text-gray">10% fee • No future staking opportunities</div>
            </div>
            <div class="instruction-card-content">
              <div class="text-green font-bold margin-bottom-5">✅ Staking Option</div>
              <div class="font-small text-gray">5% fee • Tiered re-staking eligible</div>
            </div>
            <div class="instruction-card-warning">
              <div class="text-yellow font-bold font-small">⚠️ Choice made per meme when claiming</div>
            </div>
          </div>

          <!-- Auto-Continue Staking System -->
          <div class="instruction-card-full">
            <h2>🔄 Auto-Continue Staking System (Only when staking was initially chosen)</h2>
            <div class="instruction-subtitle">How long-term staking works:</div>

            <div class="auto-continue-explanation">
              <div class="auto-continue-step">
                <span class="step-number">1</span>
                <div class="step-content">
                  <div class="step-title">Initial Stake Completes</div>
                  <div class="step-description">Your 30-day stake finishes, you earn 12% APY</div>
                </div>
              </div>

              <div class="auto-continue-step">
                <span class="step-number">2</span>
                <div class="step-content">
                  <div class="step-title">7-Day Decision Window</div>
                  <div class="step-description">Choose your next move or do nothing</div>
                </div>
              </div>

              <div class="auto-continue-step">
                <span class="step-number">3</span>
                <div class="step-content">
                  <div class="step-title">Auto-Continue (Default)</div>
                  <div class="step-description">Do nothing → Automatically renews for 30 days at 12% APY</div>
                </div>
              </div>
            </div>

            <div class="tier-grid">
              <div class="tier-item tier-item-default">
                <span class="text-green font-bold">Auto-Renew</span>
                <span class="text-gray">30 days • 12% APY</span>
                <span class="text-small">Default if no action</span>
              </div>
              <div class="tier-item tier-item-blue">
                <span class="text-blue font-bold">Upgrade Option</span>
                <span class="text-gray">90 days • 13.2% APY</span>
                <span class="text-small">Choose during window</span>
              </div>
              <div class="tier-item tier-item-yellow">
                <span class="text-yellow font-bold">Upgrade Option</span>
                <span class="text-gray">180 days • 24% APY</span>
                <span class="text-small">Choose during window</span>
              </div>
              <div class="tier-item tier-item-purple">
                <span class="text-purple font-bold">Upgrade Option</span>
                <span class="text-gray">365 days • 26% APY</span>
                <span class="text-small">Choose during window</span>
              </div>
            </div>
          </div>

          <!-- How It Works -->
          <div class="instruction-card-full">
            <h2>🔄 How It Works</h2>
            <div class="process-grid">
              <div class="process-step">
                <div class="process-number">1</div>
                <span class="text-gray">Lock tokens (30-365 days)</span>
              </div>
              <div class="process-step">
                <div class="process-number">2</div>
                <span class="text-gray">Daily compounding rewards</span>
              </div>
              <div class="process-step">
                <div class="process-number">3</div>
                <span class="text-gray">Automatic payout</span>
              </div>
              <div class="process-step">
                <div class="process-number process-number-yellow">4</div>
                <span class="text-gray">7-day re-staking window</span>
              </div>
            </div>
            <div class="warning-box">
              <div class="text-red font-bold font-small">⚠️ Early unstaking: 15% penalty</div>
            </div>
          </div>

        </div>

        <!-- APY Information Banner -->
        <div class="apy-banner">
          <div class="apy-banner-title">📈 Staking Rewards</div>
          <div class="apy-banner-rates">
            <span class="apy-rate-text">30-89 days: <strong class="apy-rate-green">12% APY</strong></span>
            <span class="apy-rate-text">90+ days: <strong class="apy-rate-green">13.2% APY</strong></span>
            <span class="apy-rate-text">180+ days: <strong class="apy-rate-bright-green">24% APY</strong></span>
            <span class="apy-rate-text">365+ days: <strong class="apy-rate-bright-green">26% APY</strong></span>
          </div>
          <div class="apy-warning">
            ⚠️ Early unstaking: 15% penalty
          </div>
        </div>

        <!-- Staking Summary Stats -->
        <div class="staking-stats">
          <div class="staking-stat-item">
            <div class="staking-stat-value staking-stat-green" id="totalStaked">0 WALDO</div>
            <div class="staking-stat-label">Total Staked</div>
          </div>
          <div class="staking-stat-item">
            <div class="staking-stat-value staking-stat-bright-green" id="totalRewards">0 WALDO</div>
            <div class="staking-stat-label">Total Rewards</div>
          </div>
          <div class="staking-stat-item">
            <div class="staking-stat-value staking-stat-green" id="totalStakedDisplay">Loading...</div>
            <div class="staking-stat-label">Total WALDO Staked</div>
          </div>
        </div>

        <!-- Long-Term Staking Table -->
        <div class="staking-table-container">
          <div class="staking-table-wrapper">
            <h3>📈 Long-Term Staking Positions</h3>
            <table id="stakingTable" class="styled-table">
              <thead>
                <tr>
                  <th scope="col">Stake ID</th>
                  <th scope="col">Amount Staked</th>
                  <th scope="col">Duration</th>
                  <th scope="col">APY</th>
                  <th scope="col">Current Rewards</th>
                  <th scope="col">Status</th>
                  <th scope="col">Action</th>
                </tr>
              </thead>
              <tbody id="stakingPositionsTable">
                <tr>
                  <td colspan="7" class="staking-positions-empty">No active stakes</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Next Payout Timer -->
        <div class="staking-summary-grid">
          <div class="staking-summary-card">
            <h3>⏳ Next Staking Payout</h3>
            <p class="center-text" id="nextPayoutTimer">Calculating...</p>
          </div>
        </div>

        <!-- New Stake Button -->
        <div class="staking-button-container">
          <button type="button" onclick="showStakingModal()" class="button-style">🏦 New Stake</button>
        </div>
      </div>
    </div>
    <!-- WALDO Promo Media -->
    <div class="card medium-card-single">
      <div class="waldo-promo-content">
        <div class="waldo-promo-icon">🐸</div>
        <h2 class="waldo-promo-title">Use #WaldoMeme on Tweets for Rewards!</h2>
        <div class="waldo-promo-subtitle">Join the meme revolution and earn WALDO tokens</div>
      </div>
    </div>

    <!-- XP Multipliers & Bonuses -->
    <div class="card">
      <h2>⚡ Active XP Multipliers</h2>
      <div class="xp-multipliers-grid">
        <div class="xp-multiplier-card">
          <div class="xp-multiplier-value xp-multiplier-value-green" id="stakingMultiplier">1.0x</div>
          <div class="xp-multiplier-label">Staking Bonus</div>
          <div class="xp-multiplier-description">Stake WALDO for XP boost</div>
        </div>
        <div class="xp-multiplier-card">
          <div class="xp-multiplier-value xp-multiplier-value-red" id="battleMultiplier">1.0x</div>
          <div class="xp-multiplier-label">Battle Streak</div>
          <div class="xp-multiplier-description">Win battles for bonus XP</div>
        </div>
        <div class="xp-multiplier-card">
          <div class="xp-multiplier-value xp-multiplier-value-yellow" id="levelMultiplier">1.0x</div>
          <div class="xp-multiplier-label">Level Bonus</div>
          <div class="xp-multiplier-description">Higher levels = more XP</div>
        </div>
        <div class="xp-multiplier-card">
          <div class="xp-multiplier-value xp-multiplier-value-light-green" id="referralMultiplier">1.0x</div>
          <div class="xp-multiplier-label">Referral Bonus</div>
          <div class="xp-multiplier-description">Invite friends for XP boost</div>
        </div>
      </div>
      <div class="xp-tips-box">
        <div class="xp-tips-title">💡 Pro Tips</div>
        <div class="xp-tips-content">
          • Stake WALDO tokens for permanent XP multiplier<br>
          • Win battles to build streak bonuses<br>
          • Higher levels unlock better multipliers
        </div>
      </div>
    </div>

    <!-- Short term Option Collapsible Container -->
    <div class="collapsible-container">
      <h2 class="collapsible-header" onclick="toggleShortTermOption()">
        💎 Short Term Option
        <span id="shortTermToggleIcon" class="toggle-icon collapsed">►</span>
      </h2>

      <div id="shortTermSection" class="collapsible-content">

        <!-- Payout Examples Card -->
        <div class="card">
          <h4 class="duplicate-example-title">💰 Per-Meme Staking (30-Day, 15% Bonus)</h4>


          <!-- Tier 3 Example -->
          <div class="duplicate-example-card">
            <div class="example-title">Tier 3 Meme (5 WALDO base)</div>
            <div class="duplicate-example-grid">
              <div>
                <div class="text-red">❌ <strong>Instant Payout:</strong></div>
                <div class="text-gray">5 WALDO - 10% fee = <strong>4.5 WALDO</strong></div>
                <div class="text-light-gray font-small">Max potential: 180 WALDO (x40)</div>
              </div>
              <div>
                <div class="text-green">✅ <strong>30-Day Stake:</strong></div>
                <div class="text-gray">5 WALDO - 5% fee = <strong>5.46 WALDO</strong> (15% bonus)</div>
                <div class="text-light-gray font-small">Max potential: 218.5 WALDO (x40)</div>
              </div>
            </div>
          </div>

          <div class="duplicate-restrictions">
            <div class="duplicate-restrictions-title">📋 Key Rules</div>
            <div class="duplicate-restrictions-text">
              • <strong>Per-Meme Choice:</strong> Decide instant vs staking for each meme individually<br>
              • <strong>Unlock Access:</strong> Staking choice unlocks long-term staking options<br>
              • <strong>Lower Fees:</strong> 5% staking fee vs 10% instant payout fee<br>
              • <strong>15% Bonus:</strong> All staked meme rewards get 15% bonus after 30 days
            </div>
          </div>
        </div>

        <!-- Level-Specific Reward Tiers Card -->
        <div class="card reward-logic-table">
          <h2 id="rewardTableTitle">💎 Level 1 - WALDO Reward Table (Waldo Watcher)</h2>
          <div class="overflow-auto">
            <table>
              <thead>
                <tr>
                  <th scope="col">Tier</th>
                  <th scope="col">Likes Required</th>
                  <th scope="col">Retweets Required</th>
                  <th scope="col">Base Reward</th>
                  <th scope="col">Instant Payout</th>
                  <th scope="col">Staking Payout</th>
                  <th scope="col">Max No-Stake (40x)</th>
                  <th scope="col">Max Stake (40x)</th>
                </tr>
              </thead>
              <tbody id="rewardTierBody"></tbody>
            </table>
          </div>
        </div>
        <!-- Meme Table with Pagination, XP, Claim/Stake/Mint -->
        <div class="card big-card">
          <div class="centered-flex-container">
            <h2 class="margin-top-0">📸 My Memes</h2>
            <div class="tooltip-wrapper">
              <span class="tooltip-icon">i</span>
              <span class="tooltip-text">Each meme must reach 60 XP to be eligible for minting as an NFT.</span>
            </div>
          </div>
          <div class="overflow-auto">
            <table>
              <thead>
                <tr>
                  <th scope="col">Thumbnail</th>
                  <th scope="col">Retweets</th>
                  <th scope="col">Likes</th>
                  <th scope="col">XP</th>
                  <th scope="col">Tier</th>
                  <th scope="col">Claim</th>
                  <th scope="col">Stake</th>
                  <th scope="col">Mint</th>
                </tr>
              </thead>
              <tbody id="memeTableBody"></tbody>
            </table>
            <div class="pagination" id="pagination"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- WALDOcoin Battle Arena – MEDIUM SIZE -->
    <div class="card battle-arena">
      <h2>🔥 Meme Battle Arena</h2>
      <p>📢 Welcome to the Meme Battle Arena! Paste a meme tweet link, start a battle, or accept one to begin voting.
        Voters pay 5 WALDO to participate, and get a share of the pot + XP if they pick the winner!</p>
      <div id="battleStatus">Loading current battle...</div>
      <div id="battleContent" class="battle-content">
        <div class="battle-memes-container">
          <div class="flex-item">
            <h3>Meme 1</h3>
            <a id="meme1Link" href="#" target="_blank">
              <img alt="Meme 1" class="meme-thumb" id="meme1Img"
                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyNWMyYTAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmODgiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0idXJsKCNnKSIgcng9IjE1Ii8+PHRleHQgeD0iMTUwIiB5PSIxNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TWVtZSAxPC90ZXh0Pjx0ZXh0IHg9IjE1MCIgeT0iMTgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNjAiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkLg8L3RleHQ+PC9zdmc+">
            </a>
            <p id="battleFeeInfo" class="twitter-link-status" style="margin-top:8px;color:#aaa;">Loading battle fees…
            </p>

            <button type="button" onclick="voteBattle('meme1')" class="button-style" id="voteMeme1Btn">Vote for Meme 1
              (5
              WALDO)</button>
          </div>
          <div class="battle-controls" data-tweetid="" data-status="open" data-canaccept="false" id="battle-wrapper">
            <input id="memeTweetId" onblur="extractTweetId(this.value)"
              placeholder="Paste Meme Tweet Link (e.g. https://x.com/user/status/1234567890)"
              class="input-style margin-bottom-10" type="text">
            <button id="start-battle-btn" type="button" class="button-style">🧠 Start New Battle (100 WALDO)</button>
            <button id="accept-battle-btn" type="button" class="button-style">🤜 Accept Current Battle (50
              WALDO)</button>
          </div>
          <div class="flex-item">
            <h3>Meme 2</h3>
            <a id="meme2Link" href="#" target="_blank">
              <img alt="Meme 2" class="meme-thumb" id="meme2Img"
                src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyNWMyYTAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmODgiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0idXJsKCNnKSIgcng9IjE1Ii8+PHRleHQgeD0iMTUwIiB5PSIxNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+TWVtZSAyPC90ZXh0Pjx0ZXh0IHg9IjE1MCIgeT0iMTgwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iNjAiIGZpbGw9IiMwMDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiPvCfkLg8L3RleHQ+PC9zdmc+">
            </a>
            <button type="button" onclick="voteBattle('meme2')" class="button-style" id="voteMeme2Btn">Vote for Meme 2
              (5
              WALDO)</button>
          </div>
        </div>
        <p id="battleTimer" class="battle-timer"></p>
        <p id="battleVoteStatus" class="twitter-link-status"></p>
        <div class="margin-top-20">
          <p id="battleFinalResult" class="battle-result"></p>
        </div>
        <div class="margin-top-20">
          <h3 class="centered-text">🚀 Launch or Accept a Battle</h3>
          <div class="centered-column">
            <div id="toast" class="toast hidden"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- BATTLE HISTORY + LEADERBOARD as 2-column row (centered and big) -->
    <div class="battle-bottom-row">
      <div class="card battle-history-card">
        <h2>📜 Past Meme Battles</h2>
        <div id="battleHistoryStatus">Loading battle history...</div>
        <div id="battleHistoryTableContainer" class="battle-history-container">
          <table class="battle-history-table">
            <thead>
              <tr>
                <th>🆔</th>
                <th>Meme 1</th>
                <th>Meme 2</th>
                <th>Votes</th>
                <th>Winner</th>
                <th>Ended</th>
              </tr>
            </thead>
            <tbody id="battleHistoryTable"></tbody>
          </table>
          <table id="battleLeaderboardTable" class="battle-leaderboard-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Profile</th>
                <th>Wallet</th>
                <th>Wins</th>
              </tr>
            </thead>
          </table>
        </div>
      </div>
    </div>

    <!-- My NFT Collection -->
    <div class="card big-card">
      <div class="centered-flex-container">
        <h2 class="margin-top-0">🖼️ My NFT Collection</h2>
        <div class="tooltip-wrapper">
          <span class="tooltip-icon">i</span>
          <span class="tooltip-text">Your minted NFTs. Click to view details or list for sale on the marketplace.</span>
        </div>
      </div>
      <div id="nftCollectionContainer" class="nft-collection-grid">
        <div class="loading-spinner">Loading your NFT collection...</div>
      </div>
      <div class="nft-collection-actions">
        <button onclick="window.open('/marketplace.html', '_blank')" class="button-style marketplace-btn">
          🏪 Browse Marketplace
        </button>
        <button onclick="window.open('/my-nfts.html', '_blank')" class="button-style manage-btn">
          ⚙️ Manage Collection
        </button>
      </div>
    </div>

    <!-- NFT Modal -->
    <div id="nftModal" class="nft-modal">
      <span onclick="closeNFTModal()" class="close-nft-modal">&times;</span>
      <img id="nftModalImg"
        src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/600x400.png?text=NFT+Preview"
        alt="NFT Preview" class="nft-modal-image">
    </div>

    <!-- Staking Modal -->
    <div id="stakingModal" class="nft-modal modal-container">
      <div class="modal-content">
        <span onclick="closeStakingModal()" class="close-nft-modal modal-close">&times;</span>
        <h3 class="modal-title">🏦 Stake WALDO Tokens</h3>

        <div class="modal-field">
          <label class="modal-label">Amount to Stake:</label>
          <input type="number" id="stakeAmount" placeholder="1000" min="1" class="modal-input">
        </div>

        <div class="modal-field">
          <label class="modal-label">Staking Duration:</label>
          <select id="stakeDuration" class="modal-select">
            <option value="30">30 days (+12% bonus)</option>
            <option value="90">90 days (+18% bonus)</option>
            <option value="180">180 days (+25% bonus)</option>
            <option value="365">365 days (+45% bonus)</option>
          </select>
          <div class="modal-hint" style="margin-top: 8px; font-size: 12px; color: #888;">
            💎 Level 5 (Waldo Legend) gets +2% bonus on all durations
          </div>
        </div>

        <div class="modal-estimate">
          <div class="modal-estimate-title">Estimated Returns:</div>
          <div id="stakingEstimate" class="modal-estimate-content">Select amount and duration</div>
        </div>

        <button type="button" onclick="createStake()" class="button-style modal-button">🏦 Create Stake</button>
      </div>
    </div>
    <!-- WALDO DAO Voting Card -->
    <div class="card big-card dao-voting-card" id="daoVotingCard">
      <h2>🗳 WALDOcoin DAO Voting</h2>
      <div id="proposalContainer">COMMING SOON...</div>
    </div> <!-- Close .battle-bottom-row -->
    <!-- END .container -->
    <!--script src="dashboard-fix.js"></-script-->
    <script>
      (function () {
        let isInitializing = false;
        let originalInit = window.initWaldoDashboard;

        if (originalInit) {
          window.initWaldoDashboard = async function () {
            if (isInitializing) return;
            isInitializing = true;
            try {
              await originalInit.call(this);
            } finally {
              isInitializing = false;
            }
          };
        }

        window.addEventListener('beforeunload', () => {
          if (window.dashboardIntervals) {
            window.dashboardIntervals.forEach(clearInterval);
          }
          if (window.battleTimerInterval) {
            clearInterval(window.battleTimerInterval);
          }
        });
      })();

      (function () {
        // Check authentication without forcing redirects
        const wallet = localStorage.getItem('xummWallet');
        const desktopFlag = sessionStorage.getItem('waldoLoginDesktop');

        // If wallet exists but no desktop flag, set it to prevent future issues
        if (wallet && !desktopFlag) {
          sessionStorage.setItem('waldoLoginDesktop', 'true');
        }

        // Update UI based on wallet state
        updateWalletUI(wallet);

        // Only show warning if no wallet, don't redirect automatically
        if (!wallet) {
          console.warn('No wallet found in localStorage. User may need to reconnect.');
          // Show a user-friendly message instead of forcing redirect
          showWaldoNotification('⚠️ Please connect your wallet to access the dashboard', 0);
        }
      })();

      /** === CONFIG === **/
      const baseURL = "https://waldocoin-backend-api.onrender.com"; // Production API
      const statsPage = "/"; // Dashboard homepage
      const loginPage = "/connect-waldo-wallet/"; // Login page (adjust if different)

      // 🚀 PRODUCTION LAUNCH - ALL FEATURES ENABLED!
      const FEATURES = {
        USER_STATS: true,        // ✅ Working
        CONVERSION_RATES: true,  // ✅ Working
        TOP_MEME: true,         // ✅ Working
        MEME_LISTING: true,     // ✅ Working
        BATTLE_STATUS: true,    // ✅ Working
        DAO_PROPOSALS: true,    // ✅ Working

        // ✅ NOW ENABLED - All endpoints implemented!
        MEME_CLAIMING: true,    // ✅ /api/claim implemented
        NFT_MINTING: true,      // ✅ /api/mint working
        STAKING_SYSTEM: true,   // ✅ Staking endpoints implemented
        TWITTER_LINKING: true,  // ✅ /api/linkTwitter implemented
        ACTIVITY_FEED: true,    // ✅ /api/activity implemented
        BATTLE_ACTIONS: true,   // ✅ Battle action endpoints implemented
        BATTLE_HISTORY: true,   // ✅ /api/battle/history implemented
        BATTLE_LEADERBOARD: true, // ✅ /api/battle/leaderboard implemented
        DAO_VOTING: true        // ✅ /api/dao/vote implemented
      };

      /** === UTILS === **/
      function $(id) { return document.getElementById(id); }
      function getWallet() { return localStorage.getItem("xummWallet") || null; }

      /** === LEVELS === **/
      const levelTitles = {
        1: "Waldo Watcher",
        2: "Waldo Scout",
        3: "Waldo Agent",
        4: "Waldo Commander",
        5: "Waldo Legend"
      };
      const levelThresholds = [0, 1000, 3000, 7000, 15000];
      const levelImages = {
        1: "https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg",
        2: "https://waldocoin.live/wp-content/uploads/2025/03/1737843965414.jpeg",
        3: "https://waldocoin.live/wp-content/uploads/2025/03/F.A.F.O.png",
        4: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.52.10.jpeg",
        5: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.53.38.jpeg"
      };
      const rewardTiers = [
        { tier: 1, likes: 25, retweets: 0, base: 1 },
        { tier: 2, likes: 50, retweets: 5, base: 2 },
        { tier: 3, likes: 100, retweets: 10, base: 5 },
        { tier: 4, likes: 500, retweets: 50, base: 25 },
        { tier: 5, likes: 1000, retweets: 100, base: 50 }
      ];

      /** === NOTIFICATIONS === **/
      function showWaldoNotification(msg, timeout = 5000) {
        const n = $("waldoNotification"), m = $("waldoMessage");
        if (!n || !m) return;
        m.textContent = msg;
        n.style.display = "flex";
        if (timeout) setTimeout(() => { n.style.display = "none"; }, timeout);
      }
      function dismissWaldoNotification() { $("waldoNotification")?.style && ($("waldoNotification").style.display = "none"); }

      /** === TOASTS === **/
      function showToast(message, type = "info", duration = 3500) {
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.textContent = message;
        toast.style.cssText = `
    position: fixed; bottom:30px; left:50%; transform:translateX(-50%);
    background: ${type === "error" ? "#e63e3e" : type === "success" ? "#2ecc71" : "#222"};
    color:white; padding:12px 20px; border-radius:8px; font-weight:600;
    z-index:99999; box-shadow:0 0 12px rgba(0,0,0,0.28);
  `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
      }

      /** === COPY REFERRAL === **/
      function copyReferral() {
        const input = $("referralLink");
        if (!input) return;
        input.select();
        navigator.clipboard.writeText(input.value)
          .then(() => $("copyStatus").textContent = "📋 Copied!")
          .catch(() => $("copyStatus").textContent = "Copy failed.");
      }

      /** === LEVEL-SPECIFIC REWARD TIERS === **/
      const levelRewardTables = {
        1: {
          title: "Level 1 - WALDO Reward Table (Waldo Watcher)",
          tiers: [
            { tier: 1, likes: 25, retweets: 0, base: 1.00, instant: 0.9005, staking: 1.1078, maxNoStake: 40.00, maxStake: 44.3120 },
            { tier: 2, likes: 50, retweets: 5, base: 2.00, instant: 1.8010, staking: 2.2156, maxNoStake: 80.00, maxStake: 88.6240 },
            { tier: 3, likes: 100, retweets: 10, base: 5.00, instant: 4.5025, staking: 5.5390, maxNoStake: 200.00, maxStake: 221.5600 },
            { tier: 4, likes: 500, retweets: 50, base: 25.00, instant: 22.5125, staking: 27.6950, maxNoStake: 1000.00, maxStake: 1107.8000 },
            { tier: 5, likes: 1000, retweets: 100, base: 50.00, instant: 45.0250, staking: 55.3900, maxNoStake: 2000.00, maxStake: 2215.6000 }
          ]
        },
        2: {
          title: "Level 2 - WALDO Reward Table (Waldo Scout)",
          tiers: [
            { tier: 1, likes: 25, retweets: 0, base: 1.00, instant: 0.9010, staking: 1.1232, maxNoStake: 40.00, maxStake: 44.9280 },
            { tier: 2, likes: 50, retweets: 5, base: 2.00, instant: 1.8020, staking: 2.2464, maxNoStake: 80.00, maxStake: 89.8560 },
            { tier: 3, likes: 100, retweets: 10, base: 5.00, instant: 4.5050, staking: 5.6160, maxNoStake: 200.00, maxStake: 224.6400 },
            { tier: 4, likes: 500, retweets: 50, base: 25.00, instant: 22.5250, staking: 28.0800, maxNoStake: 1000.00, maxStake: 1123.2000 },
            { tier: 5, likes: 1000, retweets: 100, base: 50.00, instant: 45.0500, staking: 56.1600, maxNoStake: 2000.00, maxStake: 2246.4000 }
          ]
        },
        3: {
          title: "Level 3 - WALDO Reward Table (Waldo Agent)",
          tiers: [
            { tier: 1, likes: 25, retweets: 0, base: 1.00, instant: 0.9015, staking: 1.1387, maxNoStake: 40.00, maxStake: 45.5480 },
            { tier: 2, likes: 50, retweets: 5, base: 2.00, instant: 1.8030, staking: 2.2774, maxNoStake: 80.00, maxStake: 91.0960 },
            { tier: 3, likes: 100, retweets: 10, base: 5.00, instant: 4.5075, staking: 5.6935, maxNoStake: 200.00, maxStake: 227.7400 },
            { tier: 4, likes: 500, retweets: 50, base: 25.00, instant: 22.5375, staking: 28.4675, maxNoStake: 1000.00, maxStake: 1138.7000 },
            { tier: 5, likes: 1000, retweets: 100, base: 50.00, instant: 45.0750, staking: 56.9350, maxNoStake: 2000.00, maxStake: 2277.4000 }
          ]
        },
        4: {
          title: "Level 4 - WALDO Reward Table (Waldo Commander)",
          tiers: [
            { tier: 1, likes: 25, retweets: 0, base: 1.00, instant: 0.9020, staking: 1.1543, maxNoStake: 40.00, maxStake: 46.1720 },
            { tier: 2, likes: 50, retweets: 5, base: 2.00, instant: 1.8040, staking: 2.3086, maxNoStake: 80.00, maxStake: 92.3440 },
            { tier: 3, likes: 100, retweets: 10, base: 5.00, instant: 4.5100, staking: 5.7715, maxNoStake: 200.00, maxStake: 230.8600 },
            { tier: 4, likes: 500, retweets: 50, base: 25.00, instant: 22.5500, staking: 28.8575, maxNoStake: 1000.00, maxStake: 1154.3000 },
            { tier: 5, likes: 1000, retweets: 100, base: 50.00, instant: 45.1000, staking: 57.7150, maxNoStake: 2000.00, maxStake: 2308.6000 }
          ]
        },
        5: {
          title: "Level 5 - WALDO Reward Table (Waldo Legend)",
          tiers: [
            { tier: 1, likes: 25, retweets: 0, base: 1.00, instant: 0.9025, staking: 1.1700, maxNoStake: 40.00, maxStake: 46.8000 },
            { tier: 2, likes: 50, retweets: 5, base: 2.00, instant: 1.8050, staking: 2.3400, maxNoStake: 80.00, maxStake: 93.6000 },
            { tier: 3, likes: 100, retweets: 10, base: 5.00, instant: 4.5125, staking: 5.8500, maxNoStake: 200.00, maxStake: 234.0000 },
            { tier: 4, likes: 500, retweets: 50, base: 25.00, instant: 22.5625, staking: 29.2500, maxNoStake: 1000.00, maxStake: 1170.0000 },
            { tier: 5, likes: 1000, retweets: 100, base: 50.00, instant: 45.1250, staking: 58.5000, maxNoStake: 2000.00, maxStake: 2340.0000 }
          ]
        }
      };

      function getCurrentUserLevel(xp) {
        const val = Number.isFinite(xp) ? xp : 0;
        if (val >= 10000) return 5; // Waldo Legend
        if (val >= 5000) return 4;  // Waldo Commander
        if (val >= 2000) return 3;  // Waldo Agent
        if (val >= 500) return 2;   // Waldo Scout
        return 1; // Waldo Watcher (default)
      }

      function generateRewardTable(userLevel = 1) {
        const table = $("rewardTierBody");
        const titleElement = $("rewardTableTitle");
        if (!table) return;

        const levelData = levelRewardTables[userLevel] || levelRewardTables[1];

        // Update title
        if (titleElement) {
          titleElement.textContent = `💎 ${levelData.title}`;
        }

        // Clear and populate table
        table.innerHTML = "";
        levelData.tiers.forEach(t => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${t.tier}</td>
      <td>${t.likes}+</td>
      <td>${t.retweets}+</td>
      <td>${t.base.toFixed(2)} WALDO</td>
      <td>${t.instant.toFixed(4)} WALDO</td>
      <td>${t.staking.toFixed(4)} WALDO</td>

    /** === COUNT-UP UTILS === */
    function animateCountUp(el, to, duration=800) {
      try {
        if (!el) return;
        const start = Number(el.textContent.replace(/[^0-9.]/g,'')) || 0;
        const diff = to - start;
        const startTime = performance.now();
        function step(now){
          const p = Math.min(1, (now - startTime)/duration);
          const val = Math.floor(start + diff * p);
          el.textContent = val.toLocaleString();
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      } catch(e){ /* noop */ }
    }

      <td>${t.maxNoStake.toFixed(2)} WALDO</td>
      <td>${t.maxStake.toFixed(4)} WALDO</td>
    `;
          table.appendChild(row);
        });
      }

      /** === XP CALC === **/
      function calculateXPToNextLevel(xp) {
        for (let i = 0; i < levelThresholds.length; i++)
          if (xp < levelThresholds[i]) return levelThresholds[i] - xp;
        return 0;
      }

      /** === CHARTS === **/
      let xpChartInstance = null;
      let priceChartMergedInstance = null;
      let priceChartNewInstance = null;

      function renderXPTrendChart(xpTrend) {
        const el = $("xpChart");
        if (!el || !window.Chart) return;
        const ctx = el.getContext("2d");
        if (xpChartInstance) xpChartInstance.destroy();
        xpChartInstance = new Chart(ctx, {
          type: "line",
          data: xpTrend || { labels: [], datasets: [] },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      }

      // Initialize price charts with real-time data
      async function initializePriceCharts() {
        try {
          const res = await fetch(`${baseURL}/api/market/price-history?days=7`);
          const data = await res.json();

          if (data.success && data.history && data.history.length > 0) {
            const labels = data.history.map(h => {
              const date = new Date(h.timestamp);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });
            const prices = data.history.map(h => h.usdPrice || 0);

            // Calculate 24h and 7d changes
            const currentPrice = prices[prices.length - 1];
            const price24hAgo = prices.length > 1 ? prices[prices.length - 2] : currentPrice;
            const price7dAgo = prices[0];

            const change24h = ((currentPrice - price24hAgo) / price24hAgo * 100).toFixed(2);
            const change7d = ((currentPrice - price7dAgo) / price7dAgo * 100).toFixed(2);

            // Update change displays
            const change24hEl = $("change24h");
            const change7dEl = $("change7d");

            if (change24hEl) {
              change24hEl.textContent = `${change24h >= 0 ? '+' : ''}${change24h}%`;
              change24hEl.className = `trend-value ${change24h >= 0 ? 'trend-positive' : 'trend-negative'}`;
            }

            if (change7dEl) {
              change7dEl.textContent = `${change7d >= 0 ? '+' : ''}${change7d}%`;
              change7dEl.className = `trend-value ${change7d >= 0 ? 'trend-positive' : 'trend-negative'}`;
            }

            // Update rate displays
            if (data.current) {
              $("waldoXrpRate") && ($("waldoXrpRate").textContent = `${data.current.xrpPrice || '0.00'} XRP`);
              $("waldoUsdRate") && ($("waldoUsdRate").textContent = `$${data.current.usdPrice || '0.00'}`);
            }

            const chartData = {
              labels: labels,
              datasets: [{
                label: 'WALDO/USD',
                data: prices,
                borderColor: '#25c2a0',
                backgroundColor: 'rgba(37, 194, 160, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: '#25c2a0',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
              }]
            };

            const chartOptions = {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: 'rgba(0, 0, 0, 0.8)',
                  titleColor: '#25c2a0',
                  bodyColor: '#fff',
                  borderColor: '#25c2a0',
                  borderWidth: 1,
                  padding: 10,
                  displayColors: false,
                  callbacks: {
                    label: function (context) {
                      return `$${context.parsed.y.toFixed(6)}`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: 'rgba(255, 255, 255, 0.1)' },
                  ticks: { color: '#ccc', font: { size: 10 } }
                },
                y: {
                  grid: { color: 'rgba(255, 255, 255, 0.1)' },
                  ticks: {
                    color: '#ccc',
                    font: { size: 10 },
                    callback: function (value) {
                      return '$' + value.toFixed(6);
                    }
                  }
                }
              }
            };

            // Render merged chart
            const mergedEl = $("waldoPriceChartMerged");
            if (mergedEl) {
              const ctx = mergedEl.getContext("2d");
              if (priceChartMergedInstance) priceChartMergedInstance.destroy();
              priceChartMergedInstance = new Chart(ctx, {
                type: "line",
                data: chartData,
                options: chartOptions
              });
            }

            // Render new chart
            const newEl = $("waldoPriceChartNew");
            if (newEl) {
              const ctx = newEl.getContext("2d");
              if (priceChartNewInstance) priceChartNewInstance.destroy();
              priceChartNewInstance = new Chart(ctx, {
                type: "line",
                data: chartData,
                options: chartOptions
              });
            }
          } else {
            // Show placeholder if no data
            showPlaceholderCharts();
          }
        } catch (err) {
          console.error('Error loading price charts:', err);
          showPlaceholderCharts();
        }
      }

      function showPlaceholderCharts() {
        // Show placeholder data when API isn't available
        const labels = ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'];
        const prices = [0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001, 0.000001];

        $("waldoXrpRate") && ($("waldoXrpRate").textContent = 'Loading...');
        $("waldoUsdRate") && ($("waldoUsdRate").textContent = 'Loading...');
        $("change24h") && ($("change24h").textContent = '+0.00%');
        $("change7d") && ($("change7d").textContent = '+0.00%');

        const chartData = {
          labels: labels,
          datasets: [{
            label: 'WALDO/USD',
            data: prices,
            borderColor: '#666',
            backgroundColor: 'rgba(102, 102, 102, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        };

        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#666' }
            },
            y: {
              grid: { color: 'rgba(255, 255, 255, 0.1)' },
              ticks: { color: '#666' }
            }
          }
        };

        const mergedEl = $("waldoPriceChartMerged");
        if (mergedEl) {
          const ctx = mergedEl.getContext("2d");
          if (priceChartMergedInstance) priceChartMergedInstance.destroy();
          priceChartMergedInstance = new Chart(ctx, {
            type: "line",
            data: chartData,
            options: chartOptions
          });
        }

        const newEl = $("waldoPriceChartNew");
        if (newEl) {
          const ctx = newEl.getContext("2d");
          if (priceChartNewInstance) priceChartNewInstance.destroy();
          priceChartNewInstance = new Chart(ctx, {
            type: "line",
            data: chartData,
            options: chartOptions
          });
        }
      }

      /** === DASHBOARD POPULATION === **/
      async function fetchUserStats(wallet) {
        try {
          const res = await fetch(`${baseURL}/api/userstats?wallet=${wallet}`);
          const stats = await res.json();
          $("walletAddress") && ($("walletAddress").textContent = `Wallet: ${wallet}`);
          $("refCount") && ($("refCount").textContent = stats.referrals?.length ?? 0);
          $("referralLink") && ($("referralLink").value = `https://waldocoin.live/?ref=${wallet}`);
          // XP breakdown (match HTML IDs)
          const breakdown = stats.xpBreakdown || {};
          $("likesXP") && ($("likesXP").textContent = `${breakdown.likes ?? 0} XP`);
          $("retweetsXP") && ($("retweetsXP").textContent = `${breakdown.retweets ?? 0} XP`);
          $("battleWinsXP") && ($("battleWinsXP").textContent = `${breakdown.battles ?? 0} XP`);
          $("referralsXP") && ($("referralsXP").textContent = `${breakdown.referrals ?? 0} XP`);
          $("votingXP") && ($("votingXP").textContent = `${breakdown.voting ?? 0} XP`);
          $("stakingBonusXP") && ($("stakingBonusXP").textContent = `${breakdown.stakingBonus ?? 0}%`);

          // Update XP multipliers
          updateXPMultipliers(stats);

          // Level logic
          const level = stats.level || 1, xp = stats.xp || 0;
          const xpFloor = levelThresholds[level - 1] || 0, xpCeil = levelThresholds[level] || (xpFloor + 1000);
          const xpProgress = Math.min(100, Math.floor(((xp - xpFloor) / (xpCeil - xpFloor)) * 100));
          $("userLevelIcon") && ($("userLevelIcon").src = levelImages[level] || levelImages[1]);
          $("userLevelTitle") && ($("userLevelTitle").textContent = levelTitles[level] || `Level ${level}`);
          $("levelProgress") && ($("levelProgress").value = xpProgress);
          $("xpToNextLevel") && ($("xpToNextLevel").textContent = `${calculateXPToNextLevel(xp)} XP to next level`);

          // Move the level indicator with the progress bar
          const indicator = $("levelProgressIndicator");
          if (indicator) {
            // Calculate position based on progress (0% = 0%, 100% = 95% to prevent overflow)
            const position = Math.min(95, xpProgress); // 0% at start, max 95% to prevent edge overflow
            const prev = Number(indicator.getAttribute('data-prev') || 0);
            indicator.style.left = position + '%';
            // Trigger subtle pulse when crossing 25/50/75/100 thresholds
            const thresholds = [25, 50, 75, 100];
            const crossed = thresholds.some(t => prev < t && position >= t);
            if (crossed) {
              indicator.classList.remove('pulse'); // restart animation if already applied
              void indicator.offsetWidth; // reflow to restart CSS animation
              indicator.classList.add('pulse');
              // spawn a spark element
              const spark = document.createElement('div');
              spark.className = 'spark';
              indicator.appendChild(spark);
              setTimeout(() => {
                indicator.classList.remove('pulse');
                spark.remove();
              }, 800);
            }
            indicator.setAttribute('data-prev', String(position));
          }

          // Update enhanced meme score display with dynamic background
          updateMemeScoreDisplay(xp, level);
          // Count up the meme score number
          animateCountUp(document.getElementById('memeScoreDisplay'), xp);


          // Update reward table if level is available from API
          if (Number.isFinite(level)) {

            // === Next Level Requirements Logic ===
            const levelMinRequirements = {
              1: { minted: 0, battles: 0, referrals: 0 },
              2: { minted: 1, battles: 0, referrals: 1 },
              3: { minted: 3, battles: 1, referrals: 2 },
              4: { minted: 7, battles: 3, referrals: 3 },
              5: { minted: 10, battles: 5, referrals: 5 }
            };

            function updateNextLevelRequirements(xp, level, mintedCount, battlesWon, referralsCount) {
              try {
                const currentLevel = Math.max(1, Math.min(level || 1, 5));
                const nextLevel = Math.min(currentLevel + 1, 5);

                // XP to next
                const xpNeeded = calculateXPToNextLevel(xp);
                const xpText = nextLevel > currentLevel ? `${xpNeeded} XP to Level ${nextLevel}` : `Max level reached`;
                const xpEl = document.getElementById("reqXpNeeded");
                if (xpEl) xpEl.textContent = xpText;

                // Requirements
                const req = levelMinRequirements[nextLevel] || { minted: 0, battles: 0, referrals: 0 };
                const mintedOk = (mintedCount || 0) >= (req.minted || 0);
                const battlesOk = (battlesWon || 0) >= (req.battles || 0);
                const referralsOk = (referralsCount || 0) >= (req.referrals || 0);

                const mintedStr = `${mintedCount || 0}/${req.minted || 0} ${mintedOk ? '✅' : '❌'}`;
                const battlesStr = `${battlesWon || 0}/${req.battles || 0} ${battlesOk ? '✅' : '❌'}`;
                const referralsStr = `${referralsCount || 0}/${req.referrals || 0} ${referralsOk ? '✅' : '❌'}`;

                const mintedEl = document.getElementById("reqMintedProgress");
                const battlesEl = document.getElementById("reqBattlesProgress");
                const referralsEl = document.getElementById("reqReferralsProgress");

                if (mintedEl) mintedEl.textContent = mintedStr;
                if (battlesEl) battlesEl.textContent = battlesStr;
                if (referralsEl) referralsEl.textContent = referralsStr;

                // Summary logic: need XP + minted + (battles OR referrals)
                const meetsXP = xpNeeded <= 0;
                const meetsMinted = mintedOk;
                const meetsEngagement = battlesOk || referralsOk;

                const summary = document.getElementById("reqStatusSummary");
                if (summary) {
                  if (currentLevel === 5) {
                    summary.textContent = "🎉 You are at max level (Waldo Legend).";
                    summary.style.color = "#25c2a0";
                  } else {
                    const ok = meetsXP && meetsMinted && meetsEngagement;
                    summary.textContent = ok ? "✅ All requirements met for next level (awaiting backend update)" : "⏳ Keep going to reach next level";
                    summary.style.color = ok ? "#25c2a0" : "#ffd93d";
                  }
                }
              } catch (e) {
                console.warn("Next level requirements update failed:", e);
              }
            }

            generateRewardTable(level);
          }

          renderXPTrendChart(stats.memeXPTrend || []);

          // Update Next Level Requirements card using fetched stats
          try {
            const mintedCount = (window.__waldoMintedCount || 0);
            const referralsCount = Array.isArray(stats.referrals) ? stats.referrals.length : (stats.referrals || 0);
            const battlesWon = stats.battles || 0;
            updateNextLevelRequirements(xp, level, mintedCount, battlesWon, referralsCount);
          } catch (e) {
            console.warn('Next level card update skipped:', e);
          }

        } catch (err) {
          showToast("Error loading user stats", "error");
        }
      }

      // Update XP Multipliers display
      function updateXPMultipliers(stats) {
        try {
          // Calculate staking multiplier based on staked amount
          const stakingBonus = (stats.xpBreakdown?.stakingBonus || 0) / 100;
          const stakingMultiplier = 1 + stakingBonus;
          $("stakingMultiplier") && ($("stakingMultiplier").textContent = `${stakingMultiplier.toFixed(1)}x`);

          // Calculate battle streak multiplier
          const battleWins = stats.battles || 0;
          const battleMultiplier = Math.min(1 + (battleWins * 0.1), 3.0); // Max 3x multiplier
          $("battleMultiplier") && ($("battleMultiplier").textContent = `${battleMultiplier.toFixed(1)}x`);

          // Calculate level multiplier
          const level = stats.level || 1;
          const levelMultiplier = 1 + ((level - 1) * 0.2); // 0.2x per level
          $("levelMultiplier") && ($("levelMultiplier").textContent = `${levelMultiplier.toFixed(1)}x`);

          // Calculate referral multiplier
          const referrals = stats.referrals?.length || 0;
          const referralMultiplier = 1 + (referrals * 0.05); // 0.05x per referral
          $("referralMultiplier") && ($("referralMultiplier").textContent = `${referralMultiplier.toFixed(1)}x`);

        } catch (error) {
          console.warn("Error updating XP multipliers:", error);
        }
      }

      // Update Meme Score Display with Dynamic Background
      function updateMemeScoreDisplay(xp, level) {
        try {
          const scoreDisplay = document.getElementById("memeScoreDisplay");
          const scoreCard = document.getElementById("memeScoreCard");

          if (!scoreDisplay || !scoreCard) return;

          // Update the score with animation
          scoreDisplay.textContent = xp || 0;

          // Remove existing level background classes
          scoreCard.classList.remove('level-bg-1', 'level-bg-2', 'level-bg-3', 'level-bg-4', 'level-bg-5');

          // Add appropriate background class based on level
          const currentLevel = level || 1;
          const bgClass = `level-bg-${Math.min(currentLevel, 5)}`; // Max 5 levels for backgrounds
          scoreCard.classList.add(bgClass);

          // Add pulsing effect for high scores
          if (xp > 10000) {
            scoreDisplay.style.animation = 'pulse 2s infinite';
          } else {
            scoreDisplay.style.animation = 'none';
          }

          // Color changes based on level
          const levelColors = {
            1: '#25c2a0', // Green (Beginner)
            2: '#4fc3f7', // Light Blue (Novice)
            3: '#ffd93d', // Yellow (Intermediate)
            4: '#ff6b6b', // Red (Advanced)
            5: '#9c27b0'  // Purple (Expert)
          };

          const color = levelColors[Math.min(currentLevel, 5)] || '#25c2a0';
          scoreDisplay.style.color = color;
          scoreDisplay.style.textShadow = `
      0 0 20px ${color},
      0 0 40px ${color},
      2px 2px 4px rgba(0,0,0,0.8)
    `;

        } catch (error) {
          console.warn("Error updating meme score display:", error);
        }
      }
      async function fetchConversionRate() {
        try {
          const res = await fetch(`${baseURL}/api/conversion`);
          const data = await res.json();
          $("waldoConversion") && ($("waldoConversion").textContent = `${data.waldoToUSD} USD / ${data.waldoToXRP} XRP`);
          $("waldoEarnings") && ($("waldoEarnings").textContent = `${data.totalWaldo} WALDO = ${data.totalUSD} USD`);
        } catch (err) { showToast("Could not load rates", "error"); }
      }
      async function loadTopMeme() {
        try {
          const res = await fetch(`${baseURL}/api/topMeme`);
          const data = await res.json();

          if (data && data.likes !== undefined) {
            $("topMemeLikes") && ($("topMemeLikes").textContent = data.likes);
          }

          if (data && data.image) {
            $("topMemeImage") && ($("topMemeImage").src = data.image);
          }
          // Load staking stats summary (Per‑Meme redemptions)
          async function fetchStakingStatsSummary() {
            try {
              const res = await fetch(`${baseURL}/api/staking/stats`);
              const data = await res.json();
              if (!data || !data.success) return;
              const s = data.stats && data.stats.perMemeRedemptions;
              if (!s) return;

              const countEl = document.getElementById('pmRedCount');
              const totalEl = document.getElementById('pmRedTotal');
              const listEl = document.getElementById('pmRedList');

              if (countEl) countEl.textContent = (s.count || 0).toLocaleString();
              if (totalEl) totalEl.textContent = `${Number(s.totalAmount || 0).toFixed(2)} WALDO`;

              if (listEl) {
                if (!s.last10 || s.last10.length === 0) {
                  listEl.innerHTML = '<div class="js-no-stakes">No matured per‑meme redemptions yet</div>';
                } else {
                  listEl.innerHTML = '<ul style="list-style:none;padding:0;margin:0;"></ul>';
                  const ul = listEl.querySelector('ul');
                  s.last10.forEach(ev => {
                    const short = ev.txid ? `${ev.txid.slice(0, 8)}…${ev.txid.slice(-6)}` : '—';
                    const when = ev.timestamp ? new Date(ev.timestamp).toLocaleString() : '';
                    const li = document.createElement('li');
                    li.style.margin = '6px 0';
                    li.innerHTML = `+${(Number(ev.amount) || 0).toFixed(2)} WALDO • <a class="xrpl-link-green" href="https://livenet.xrpl.org/transactions/${ev.txid}" target="_blank" rel="noopener">${short}</a> <span style="color:#888;">${when}</span>`;
                    ul.appendChild(li);
                  });
                }
              }
            } catch (e) {
              console.warn('Staking stats summary failed:', e);
            }
          }


          if (data && data.author && data.id) {
            $("topMemeLink") && ($("topMemeLink").href = `https://x.com/${data.author}/status/${data.id}`);
          }
        } catch (err) {
          console.warn('Top meme not available:', err.message);
        }
      }
      // === Meme Table Logic ===
      async function fetchMemes(wallet, page = 1, perPage = 5) {
        try {
          const res = await fetch(`${baseURL}/api/tweets?wallet=${wallet}&page=${page}&perPage=${perPage}`);
          const data = await res.json();
          renderMemeTable(data.memes || [], wallet);
          renderMemePagination(data.totalPages || 1, page);
        } catch (e) {
          showToast("Could not load memes", "error");
        }
      }
      function renderMemeTable(memes, wallet) {
        const tbody = $("memeTableBody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!memes || memes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="js-table-empty">No memes found for this wallet</td></tr>';
          return;
        }

        memes.forEach(meme => {
          // Ensure meme has required properties
          if (!meme || !meme.id) return;

          const isMintable = (meme.xp || 0) >= 60;
          const imageUrl = meme.image || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48bGluZWFyR3JhZGllbnQgaWQ9ImciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyNWMyYTAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiMwMGZmODgiLz48L2xpbmVhckdyYWRpZW50PjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0idXJsKCNnKSIgcng9IjgiLz48dGV4dCB4PSI1MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iIzAwMCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+8J+QuDwvdGV4dD48L3N2Zz4=';

          tbody.innerHTML += `
      <tr>
        <td><img class="meme-thumb" src="${imageUrl}" alt="meme" onclick="showNFTModal('${imageUrl}')" onerror="handleImageError(this)" crossorigin="anonymous"></td>
        <td>${meme.retweets || 0}</td>
        <td>${meme.likes || 0}</td>
        <td>${meme.xp || 0}</td>
        <td>${meme.tier || '-'}</td>
        <td><button onclick="claimMeme('${meme.id}', ${meme.tier || 1})" class="button-style" ${meme.claimed ? 'disabled' : ''}>Claim</button></td>
        <td><button onclick="stakeMeme('${meme.id}', ${meme.tier || 1})" class="button-style" ${meme.staked ? 'disabled' : ''}>Stake</button></td>
        <td><button onclick="mintMeme('${meme.id}', '${imageUrl}')" class="button-style" ${isMintable ? "" : "disabled"}>Mint</button></td>
      </tr>`;
        });
      }
      function renderMemePagination(totalPages, currentPage) {
        const pag = $("pagination");
        if (!pag) return;
        pag.innerHTML = "";
        const wallet = getWallet();
        if (!wallet) return; // Don't render pagination if no wallet

        for (let i = 1; i <= totalPages; i++) {
          pag.innerHTML += `<button onclick="fetchMemes('${wallet}', ${i})" ${i === currentPage ? 'class="js-pagination-bold"' : ''}>${i}</button>`;
        }
      }
      // Claim/Stake/Mint Handlers
      async function claimMeme(id, tier) {
        if (!FEATURES.MEME_CLAIMING) {
          showToast("🚧 Meme claiming temporarily disabled", "info");
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/claim`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), memeId: id, tier, stake: false })
          });
          const data = await res.json();
          if (data.success) showToast(data.message || "Claim successful!", "success");
          else {
            if (data && data.details && data.details.requiredWaldo !== undefined) {
              const { waldoPerXrp, minXrp, requiredWaldo, balance } = data.details;
              showToast(`You need at least ${requiredWaldo.toLocaleString()} WALDO (~${minXrp} XRP at ${waldoPerXrp.toLocaleString()} WALDO/XRP). You currently have ${Number(balance).toLocaleString()} WALDO.`, "error");
            } else {
              showToast(data.error || "Claim failed", "error");
            }
          }
          fetchMemes(getWallet()); // Refresh
        } catch (e) {
          console.error('Claim error:', e);
          showToast("Claim error: " + e.message, "error");
        }
      }
      async function stakeMeme(id, tier) {
        try {
          const res = await fetch(`${baseURL}/api/claim`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), memeId: id, tier, stake: true })
          });
          const data = await res.json();
          if (data.success) showToast("Stake started! Check your XAMAN wallet.", "success");
          else showToast(data.error || "Stake failed", "error");
          fetchMemes(getWallet());
        } catch (e) { showToast("Stake error", "error"); }
      }
      async function mintMeme(id, img) {
        // Open modal for mint confirmation if needed, then call backend
        showNFTModal(img);
        if (!confirm("Mint this meme as NFT? (50 WALDO fee applies)")) return;
        try {
          const res = await fetch(`${baseURL}/api/mint`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), memeId: id })
          });
          const data = await res.json();
          if (data.success) {
            showToast("Mint initiated. Sign in wallet!", "success");
            // Refresh both memes and NFT collection
            fetchMemes(getWallet());
            fetchNFTCollection(getWallet());
          } else {
            if (data && data.details && data.details.requiredWaldo !== undefined) {
              const { waldoPerXrp, minXrp, requiredWaldo, balance } = data.details;
              showToast(`You need at least ${requiredWaldo.toLocaleString()} WALDO (~${minXrp} XRP at ${waldoPerXrp.toLocaleString()} WALDO/XRP). You currently have ${Number(balance).toLocaleString()} WALDO.`, "error");
            } else {
              showToast(data.error || "Mint failed", "error");
            }
          }
        } catch (e) { showToast("Mint error", "error"); }
      }
      window.claimMeme = claimMeme;
      window.stakeMeme = stakeMeme;
      window.mintMeme = mintMeme;
      window.showNFTModal = showNFTModal; // Needed for thumbnail click
      window.showNFTDetails = showNFTDetails; // Needed for NFT collection clicks

      // Debug function to test meme functionality
      window.debugMemes = function () {
        const wallet = getWallet();
        console.log('🔍 Debug Memes - Wallet:', wallet);

        if (!wallet) {
          console.error('❌ No wallet found');
          return;
        }

        console.log('📡 Fetching memes...');
        fetchMemes(wallet).then(() => {
          console.log('✅ Memes fetch completed');
        }).catch(error => {
          console.error('❌ Memes fetch failed:', error);
        });
      };

      // Handle image loading errors and CORS issues
      function handleImageError(img) {
        console.warn('Image failed to load:', img.src);
        // Replace with CSS-based placeholder instead of another image
        img.style.display = 'none';

        // Create a CSS placeholder div
        const placeholder = document.createElement('div');
        placeholder.style.cssText = `
    width: ${img.width || 100}px;
    height: ${img.height || 100}px;
    background: linear-gradient(135deg, #25c2a0 0%, #00ff88 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    color: #000;
    font-weight: bold;
    font-size: 2em;
  `;
        placeholder.textContent = '🐸';
        placeholder.title = 'WALDO Meme';

        // Replace the image with the placeholder
        img.parentNode.insertBefore(placeholder, img);
        img.remove();
      }

      // Add global error handler for undefined resources
      window.addEventListener('error', function (e) {
        if (e.target && e.target.tagName === 'IMG') {
          console.warn('Image load error:', e.target.src);
          handleImageError(e.target);
        }
      }, true);
      // On page load, after initWaldoDashboard, call: fetchMemes(getWallet());
      // === NFT Modal Preview Logic ===
      function showNFTModal(img) {
        const modal = document.getElementById("nftModal");
        const modalImg = document.getElementById("nftModalImg");
        if (!modal || !modalImg) return;
        modal.style.display = "block";
        modalImg.src = img;
      }
      function closeNFTModal() {
        const modal = document.getElementById("nftModal");
        if (modal) modal.style.display = "none";
      }
      window.closeNFTModal = closeNFTModal;

      // === Staking Modal & Functions ===
      function showStakingModal() {
        const modal = document.getElementById("stakingModal");
        if (!modal) return;
        modal.style.display = "block";

        // Reset form
        document.getElementById("stakeAmount").value = "";
        document.getElementById("stakeDuration").value = "30";
        document.getElementById("stakingEstimate").textContent = "Select amount and duration";

        // Add event listeners for real-time calculation
        const amountInput = document.getElementById("stakeAmount");
        const durationSelect = document.getElementById("stakeDuration");

        const updateEstimate = () => {
          const amount = parseFloat(amountInput.value) || 0;
          const duration = parseInt(durationSelect.value) || 30;

          // Use flat bonus rates (not annualized APY) - matches backend calculation
          let bonusPercent;
          if (duration >= 365) {
            bonusPercent = 45; // +45% flat bonus for 365 days
          } else if (duration >= 180) {
            bonusPercent = 25; // +25% flat bonus for 180 days
          } else if (duration >= 90) {
            bonusPercent = 18; // +18% flat bonus for 90 days
          } else {
            bonusPercent = 12; // +12% flat bonus for 30 days
          }

          if (amount > 0) {
            // Calculate as flat bonus (not annualized)
            const totalRewards = amount * (bonusPercent / 100);
            const finalAmount = amount + totalRewards;

            document.getElementById("stakingEstimate").innerHTML = `
        <div class="js-estimate-rewards">💰 Estimated Rewards: ${totalRewards.toFixed(2)} WALDO</div>
        <div class="js-estimate-total">📈 Total Return: ${finalAmount.toFixed(2)} WALDO</div>
        <div class="js-estimate-apy">+${bonusPercent}% bonus | Duration: ${duration} days</div>
      `;
          } else {
            document.getElementById("stakingEstimate").textContent = "Enter amount to see estimate";
          }
        };

        amountInput.addEventListener("input", updateEstimate);
        durationSelect.addEventListener("change", updateEstimate);
      }

      function closeStakingModal() {
        const modal = document.getElementById("stakingModal");
        if (modal) modal.style.display = "none";
      }

      async function createStake() {
        const amount = parseFloat(document.getElementById("stakeAmount").value);
        const duration = parseInt(document.getElementById("stakeDuration").value);

        if (!amount || amount <= 0) {
          showToast("Please enter a valid staking amount", "error");
          return;
        }

        if (!duration || duration < 30) {
          showToast("Minimum staking duration is 30 days", "error");
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/staking/stake`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              wallet: getWallet(),
              amount: amount,
              duration: duration
            })
          });

          const data = await res.json();

          if (data.success) {
            showToast("Staking initiated! Check your XAMAN wallet to sign.", "success");
            closeStakingModal();

            // Open XUMM payment in new window if available
            if (data.redirect) {
              window.open(data.redirect, '_blank');
            }

            // Refresh staking positions after a delay
            setTimeout(() => {
              fetchStakingPositions(getWallet());
            }, 2000);

          } else {
            // Worth policy friendly message
            if (data && data.details && data.details.requiredWaldo !== undefined) {
              const { waldoPerXrp, minXrp, requiredWaldo, balance } = data.details;
              showToast(`You need at least ${requiredWaldo.toLocaleString()} WALDO (~${minXrp} XRP at ${waldoPerXrp.toLocaleString()} WALDO/XRP). You currently have ${Number(balance).toLocaleString()} WALDO.`, "error");
            } else {
              showToast(data.error || "Failed to create stake", "error");
            }
          }

        } catch (error) {
          console.error("Staking error:", error);
          showToast("Error creating stake. Please try again.", "error");
        }
      }

      // Fetch and display user's staking positions
      async function fetchStakingPositions(wallet) {
        try {
          const res = await fetch(`${baseURL}/api/staking/positions/${wallet}`);
          const data = await res.json();

          if (data.success) {
            // Calculate totals from positions
            const totalStaked = data.positions
              .filter(p => p.status === 'active')
              .reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);

            const totalRewards = data.positions
              .filter(p => p.status === 'active')
              .reduce((sum, p) => sum + (parseFloat(p.expectedReward) || 0), 0);

            document.getElementById("totalStaked").textContent = `${totalStaked.toFixed(2)} WALDO`;
            document.getElementById("totalRewards").textContent = `${totalRewards.toFixed(2)} WALDO`;

            // Update positions display
            const positionsDiv = document.getElementById("stakingPositions");
            if (data.positions && data.positions.length > 0) {
              positionsDiv.innerHTML = data.positions.map(position => {
                // Use endDate from backend (not unlockDate)
                const unlockDate = new Date(position.endDate).toLocaleDateString();
                const now = new Date();
                const unlockDateTime = new Date(position.endDate);
                const bufferMs = 60 * 1000; // 60-second buffer to match backend
                const isMatured = now >= (unlockDateTime.getTime() - bufferMs);

                // Status-based styling
                let statusColor, statusText, actionButton;

                if (position.status === 'redeemed' || position.status === 'completed') {
                  statusColor = '#ffd93d';
                  statusText = 'Redeemed';
                  actionButton = `<div class="js-status-completed">✅ Completed</div>`;

                } else if (position.status === 'active' && isMatured) {
                  statusColor = '#25c2a0';
                  statusText = 'Ready to Redeem';
                  actionButton = `<button onclick="unstakePosition('${position.stakeId}')" class="button-style js-button-redeem">💰 Redeem Now</button>`;

                } else if (position.status === 'active') {
                  statusColor = '#25c2a0';
                  statusText = 'Active';
                  actionButton = `<div class="js-status-locked">🔒 Locked until ${unlockDate}</div>`;

                } else {
                  statusColor = '#aaa';
                  statusText = position.status || 'Unknown';
                  actionButton = `<div class="js-status-completed">${position.status}</div>`;
                }

                const apyPercent = position.apy ? (position.apy).toFixed(1) : '0.0';
                const currentRewards = position.expectedReward || 0;

                return `
            <div class="js-position-card" style="border-left-color: ${statusColor};">
              <div class="js-position-header">
                <div>
                  <div class="js-position-amount" style="color: ${statusColor};">${position.amount} WALDO</div>
                  <div class="js-position-details">${position.duration} days • ${apyPercent}% APY</div>
                  <div class="js-position-status" style="color: ${statusColor};">● ${statusText}</div>
                </div>
                <div class="js-position-right">
                  <div class="js-position-rewards">+${parseFloat(currentRewards).toFixed(2)} WALDO</div>
                  <div class="js-position-unlock">${position.status === 'redeemed' ? 'Redeemed' : `Unlocks: ${unlockDate}`}</div>
                </div>
              </div>
              ${actionButton}
            </div>
          `;
              }).join('');
            } else {
              positionsDiv.innerHTML = '<div class="js-no-stakes">No active stakes yet. Create your first stake above!</div>';
            }
          }
        } catch (error) {
          console.error("Error fetching staking positions:", error);
          showToast("Could not load staking positions", "error");
          document.getElementById("stakingPositions").innerHTML = '<div class="js-no-stakes">Error loading stakes. Please refresh.</div>';
        }
      }

      // Unstake/Redeem function - automatically chooses correct endpoint based on maturity
      async function unstakePosition(stakeId) {
        // First check if stake is matured to determine which endpoint to use
        const wallet = getWallet();
        let isMatured = false;

        try {
          const posRes = await fetch(`${baseURL}/api/staking/positions/${wallet}`);
          const posData = await posRes.json();
          if (posData.success) {
            const stake = posData.positions.find(p => p.stakeId === stakeId);
            if (stake) {
              const now = new Date();
              const unlockDateTime = new Date(stake.unlockDate || stake.endDate);
              const bufferMs = 60 * 1000; // 60-second buffer to match backend
              isMatured = now >= (unlockDateTime.getTime() - bufferMs);
            }
          }
        } catch (e) {
          console.warn('Could not check stake maturity, defaulting to unstake:', e);
        }

        const action = isMatured ? "redeem" : "unstake";
        const confirmMsg = isMatured ?
          "Are you sure you want to redeem this matured position? You'll receive your full stake + rewards." :
          "Are you sure you want to unstake this position early? A 15% penalty will be applied.";

        if (!confirm(confirmMsg)) return;

        try {
          const endpoint = isMatured ? `${baseURL}/api/staking/redeem` : `${baseURL}/api/staking/unstake`;
          const body = isMatured ?
            { wallet, stakeId } :
            { wallet, stakeId, force: false };

          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });

          const data = await res.json();

          if (data.success) {
            const successMsg = isMatured ?
              "Redemption initiated! Check your XAMAN wallet." :
              "Early unstaking initiated! Check your XAMAN wallet.";
            showToast(successMsg, "success");

            // Open XUMM payment if available
            if (data.qr) {
              window.open(data.qr, '_blank');
            }

            // Refresh positions
            setTimeout(() => {
              fetchStakingPositions(getWallet());
            }, 2000);

          } else {
            showToast(data.error || `Failed to ${action}`, "error");
          }

        } catch (error) {
          console.error("Unstaking error:", error);
          showToast("Error unstaking. Please try again.", "error");
        }
      }

      // Twitter Account Linking
      async function linkTwitterAccount() {
        const twitterHandle = document.getElementById("twitterHandleInput").value.trim();

        if (!twitterHandle) {
          showToast("Please enter a Twitter handle", "error");
          return;
        }

        // Remove @ if user included it
        const cleanHandle = twitterHandle.replace(/^@/, '');

        try {
          const res = await fetch(`${baseURL}/api/linkTwitter`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              wallet: getWallet(),
              twitterHandle: cleanHandle
            })
          });

          const data = await res.json();

          if (data.success) {
            showToast(`✅ Twitter @${cleanHandle} linked successfully!`, "success");
            document.getElementById("twitterHandleInput").value = "";

            // Refresh user stats to show updated social info
            setTimeout(() => {
              fetchUserStats(getWallet());
            }, 1000);

          } else {
            showToast(data.error || "Failed to link Twitter account", "error");
          }

        } catch (error) {
          console.error("Twitter linking error:", error);
          showToast("Error linking Twitter account. Please try again.", "error");
        }
      }

      // Staking Zone Toggle Function
      function toggleStakingZone() {
        const section = document.getElementById("stakingZoneSection");
        const icon = document.getElementById("stakingZoneToggleIcon");
        if (section.style.display === "none") {
          section.style.display = "block";
          icon.textContent = "▼";
          icon.classList.remove("collapsed");
        } else {
          section.style.display = "none";
          icon.textContent = "►";
          icon.classList.add("collapsed");
        }
      }

      // Short Term Option Toggle Function
      function toggleShortTermOption() {
        const section = document.getElementById("shortTermSection");
        const icon = document.getElementById("shortTermToggleIcon");

        if (section.classList.contains("expanded")) {
          section.classList.remove("expanded");
          icon.textContent = "►";
          icon.classList.add("collapsed");
        } else {
          section.classList.add("expanded");
          icon.textContent = "▼";
          icon.classList.remove("collapsed");
        }
      }

      // Make functions globally available
      window.showStakingModal = showStakingModal;
      window.closeStakingModal = closeStakingModal;
      window.createStake = createStake;
      window.fetchStakingPositions = fetchStakingPositions;
      window.unstakePosition = unstakePosition;
      window.linkTwitterAccount = linkTwitterAccount;
      window.toggleStakingZone = toggleStakingZone;

      // === NFT Collection Logic ===
      async function fetchNFTCollection(wallet) {
        const container = document.getElementById("nftCollectionContainer");
        if (!container || !wallet) return;

        try {
          // Get user's memes that have been minted as NFTs
          const response = await fetch(`${baseURL}/api/userMemes?wallet=${wallet}`);
          const data = await response.json();

          if (data.success && data.memes) {
            const mintedNFTs = data.memes.filter(meme => meme.nft_minted === 'true' || meme.nft_minted === true);

            // Expose minted count globally for requirements card
            window.__waldoMintedCount = mintedNFTs.length;

            if (mintedNFTs.length === 0) {
              container.innerHTML = `
          <div class="nft-empty-state">
            <h3>🖼️ No NFTs Yet</h3>
            <p>Mint your first NFT from your memes above!</p>
            <p>Any meme can be minted for 50 WALDO</p>
          </div>
        `;
              return;
            }

            // Calculate rarity for each NFT
            const nftsWithRarity = mintedNFTs.map(nft => {
              const engagementScore = (nft.likes * 0.6) + (nft.retweets * 1.4) + (nft.xp * 10);
              const ageBonus = Math.min((Date.now() - new Date(nft.created_at).getTime()) / (30 * 24 * 60 * 60 * 1000), 2);
              const totalScore = engagementScore * (1 + ageBonus);

              let rarity = 'common';
              if (totalScore >= 10000) rarity = 'legendary';
              else if (totalScore >= 5000) rarity = 'epic';
              else if (totalScore >= 2000) rarity = 'rare';
              else if (totalScore >= 500) rarity = 'uncommon';

              return { ...nft, rarity, engagementScore: Math.floor(totalScore) };
            });

            // Sort by rarity and engagement
            nftsWithRarity.sort((a, b) => b.engagementScore - a.engagementScore);

            container.innerHTML = nftsWithRarity.map(nft => `
        <div class="nft-collection-item" onclick="showNFTDetails('${nft.tweet_id}', '${nft.text}', '${nft.image_url}', '${nft.rarity}')">
          <img src="${nft.image_url}" alt="${nft.text}" class="nft-collection-image" onerror="this.src='https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png'">
          <div class="nft-collection-info">
            <div class="nft-collection-rarity rarity-${nft.rarity}">${nft.rarity}</div>
            <div class="nft-collection-title">${nft.text.substring(0, 60)}${nft.text.length > 60 ? '...' : ''}</div>
            <div class="nft-collection-stats">
              <span>❤️ ${nft.likes}</span>
              <span>🔁 ${nft.retweets}</span>
              <span>⭐ ${nft.xp} XP</span>
            </div>
          </div>
        </div>
      `).join('');

          } else {
            container.innerHTML = `
        <div class="nft-empty-state">
          <h3>❌ Failed to Load</h3>
          <p>Unable to fetch your NFT collection</p>
        </div>
      `;
          }
        } catch (error) {
          console.error('Error fetching NFT collection:', error);
          container.innerHTML = `
      <div class="nft-empty-state">
        <h3>🔌 Connection Error</h3>
        <p>Unable to load your NFT collection</p>
      </div>
    `;
        }
      }

      // Show NFT details with marketplace options
      function showNFTDetails(tweetId, title, imageUrl, rarity) {
        const modal = document.getElementById("nftModal");
        const modalImg = document.getElementById("nftModalImg");

        if (!modal || !modalImg) return;

        // Show the NFT image
        modal.style.display = "block";
        modalImg.src = imageUrl;

        // Add marketplace actions (you can enhance this further)
        setTimeout(() => {
          if (confirm(`${title.substring(0, 100)}...\n\nRarity: ${rarity.toUpperCase()}\n\nWould you like to list this NFT for sale on the marketplace?`)) {
            window.open(`/my-nfts.html?highlight=${tweetId}`, '_blank');
          }
        }, 500);
      }

      // CSS: add `.nft-modal { display:none; position:fixed; ... }` if not present
      // === Activity Feed Logic ===
      async function fetchActivity(wallet) {
        const ul = $("activityFeed");
        if (!ul) return;

        if (!FEATURES.ACTIVITY_FEED) {
          ul.innerHTML = '<li class="js-activity-placeholder">📊 Activity feed coming soon...</li>';
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/activity?wallet=${wallet}`);
          const data = await res.json();
          ul.innerHTML = "";
          (data.activity || []).forEach(act => {
            ul.innerHTML += `<li>${act.time ? `<b>[${act.time}]</b> ` : ''}${act.message || JSON.stringify(act)}</li>`;
          });
        } catch (e) {
          console.warn('Activity feed failed:', e.message);
          ul.innerHTML = '<li class="js-activity-placeholder">📊 Activity feed temporarily unavailable</li>';
        }
      }
      // After init, call: fetchActivity(getWallet());
      // === Battle Arena Logic ===
      async function fetchBattleStatus() {
        try {
          const res = await fetch(`${baseURL}/api/battle/current`);
          const battle = await res.json();
          const statusDiv = $("battleStatus");
          const content = $("battleContent");

          // Always show battle content so users can see controls
          content.style.display = "block";

          if (!battle.active) {
            statusDiv.textContent = "No current battle. Start one!";

            // Hide meme voting sections when no battle
            $("voteMeme1Btn").style.display = "none";
            $("voteMeme2Btn").style.display = "none";
            $("battleTimer").style.display = "none";

            // Show battle controls
            $("battle-wrapper").dataset.status = "open";
            $("accept-battle-btn").disabled = true;
            $("start-battle-btn").disabled = false;

            // Set battle placeholder image when no active battles
            $("meme1Img").src = "https://waldocoin.live/wp-content/uploads/2025/07/waldobattle-1.png";
            $("meme2Img").src = "https://waldocoin.live/wp-content/uploads/2025/07/waldobattle-1.png";
            $("meme1Link").href = "#";
            $("meme2Link").href = "#";

            return;
          }

          // Active battle - show everything
          statusDiv.textContent = "Current Battle:";
          $("voteMeme1Btn").style.display = "block";
          $("voteMeme2Btn").style.display = "block";
          $("battleTimer").style.display = "block";

          $("meme1Img").src = battle.meme1.image;
          $("meme2Img").src = battle.meme2.image;
          $("meme1Link").href = battle.meme1.link;
          $("meme2Link").href = battle.meme2.link;
          $("voteMeme1Btn").disabled = false;
          $("voteMeme2Btn").disabled = false;
          renderBattleTimer(battle.timerSeconds);
          $("battle-wrapper").dataset.status = "running";
          $("accept-battle-btn").disabled = true;
          $("start-battle-btn").disabled = true;

        } catch (e) {
          console.error("Battle status error:", e);
          $("battleStatus").textContent = "Could not load battle info.";
          // Still show controls so users can try to start battles
          $("battleContent").style.display = "block";
        }
      }
      let battleTimerInterval = null;
      function renderBattleTimer(seconds) {
        clearInterval(battleTimerInterval);
        const timerEl = $("battleTimer");
        if (!timerEl) return;
        if (!seconds || seconds < 1) {
          timerEl.textContent = "Battle running";
          return;
        }
        function update() {
          if (seconds < 0) {
            timerEl.textContent = "Battle ended";
            clearInterval(battleTimerInterval);
            return;
          }
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          seconds--;
        }

        if (window.battleTimerInterval) {
          clearInterval(window.battleTimerInterval);
        }

        update();
        window.battleTimerInterval = setInterval(update, 1000);
      }

      async function startBattle() {
        const tweetId = $("memeTweetId").value.trim();
        if (!tweetId) return showToast("Paste a meme tweet link!", "error");
        try {
          const res = await fetch(`${baseURL}/api/battle/start`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), tweetId })
          });
          const data = await res.json();
          if (data.success) showToast("Battle started! Waiting for opponent...", "success");
          else showToast(data.error || "Could not start battle", "error");
          fetchBattleStatus();
        } catch (e) { showToast("Battle start error", "error"); }
      }
      async function acceptBattle() {
        try {
          const res = await fetch(`${baseURL}/api/battle/accept`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet() })
          });
          const data = await res.json();
          if (data.success) showToast("Battle accepted. Battle is ON!", "success");
          else showToast(data.error || "Accept failed", "error");
          fetchBattleStatus();
        } catch (e) { showToast("Battle accept error", "error"); }
      }
      async function voteBattle(meme) {
        try {
          const res = await fetch(`${baseURL}/api/battle/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), meme })
          });
          const data = await res.json();
          if (data.success) showToast("Vote cast! Check battle results after timer.", "success");
          else showToast(data.error || "Vote failed", "error");
          fetchBattleStatus();
        } catch (e) { showToast("Vote error", "error"); }
      }
      // Extract Tweet ID from various Twitter URL formats
      function extractTweetId(url) {
        if (!url) return '';

        // Handle various Twitter URL formats
        const patterns = [
          /twitter\.com\/\w+\/status\/(\d+)/,
          /x\.com\/\w+\/status\/(\d+)/,
          /mobile\.twitter\.com\/\w+\/status\/(\d+)/,
          /^(\d+)$/ // Just the ID itself
        ];

        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match) {
            const tweetId = match[1] || match[0];
            document.getElementById("memeTweetId").value = tweetId;
            return tweetId;
          }
        }

        showToast("Invalid Twitter URL format. Please paste a valid tweet link.", "error");
        return '';
      }

      $("start-battle-btn").onclick = startBattle;
      $("accept-battle-btn").onclick = acceptBattle;
      window.voteBattle = voteBattle;
      window.extractTweetId = extractTweetId;

      // Initialize battle arena on page load
      function initializeBattleArena() {
        const battleContent = document.getElementById("battleContent");
        if (battleContent) {
          battleContent.style.display = "block";
        }

        // Ensure buttons are properly set up
        const startBtn = document.getElementById("start-battle-btn");
        const acceptBtn = document.getElementById("accept-battle-btn");

        if (startBtn) {
          startBtn.disabled = false;
          startBtn.style.display = "block";
        }

        if (acceptBtn) {
          acceptBtn.disabled = true;
          acceptBtn.style.display = "block";
        }

        // Set initial battle status
        const statusDiv = document.getElementById("battleStatus");
        if (statusDiv) {
          statusDiv.textContent = "Ready to battle! Paste a meme tweet link to start.";
        }
      }

      // Call initialization immediately
      initializeBattleArena();

      // On dashboard init, call fetchBattleStatus();
      // === Battle History & Leaderboard ===
      async function fetchBattleHistory() {
        if (!FEATURES.BATTLE_HISTORY) {
          $("battleHistoryStatus").textContent = "📜 Battle history feature coming soon...";
          $("battleHistoryStatus").style.color = "#666";
          $("battleHistoryStatus").style.fontStyle = "italic";
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/battle/history`);
          const data = await res.json();
          $("battleHistoryStatus").style.display = "none";
          $("battleHistoryTableContainer").style.display = "block";
          const tbody = $("battleHistoryTable");
          tbody.innerHTML = "";
          (data.battles || []).forEach(b => {
            tbody.innerHTML += `
        <tr>
          <td>${b.id}</td>
          <td><a href="${b.meme1.link}" target="_blank">Meme 1</a></td>
          <td><a href="${b.meme2.link}" target="_blank">Meme 2</a></td>
          <td>${b.votes}</td>
          <td>${b.winner || '-'}</td>
          <td>${b.ended ? "Yes" : "No"}</td>
        </tr>`;
          });
        } catch (e) {
          console.warn('Battle history failed:', e.message);
          $("battleHistoryStatus").textContent = "📜 Battle history temporarily unavailable";
          $("battleHistoryStatus").style.color = "#666";
          $("battleHistoryStatus").style.fontStyle = "italic";
        }
      }
      async function fetchBattleLeaderboard() {
        const tbody = document.querySelector("#battleLeaderboardTable tbody");

        if (!FEATURES.BATTLE_LEADERBOARD) {
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="4" class="js-table-empty js-table-italic">🏆 Battle leaderboard coming soon...</td></tr>`;
          }
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/battle/leaderboard`);
          const { leaderboard } = await res.json();
          renderBattleLeaderboard(leaderboard);
        } catch (e) {
          console.warn('Battle leaderboard failed:', e.message);
          if (tbody) {
            tbody.innerHTML = `<tr><td colspan="4" class="js-table-empty js-table-italic">🏆 Battle leaderboard temporarily unavailable</td></tr>`;
          }
        }
      }
      function renderBattleLeaderboard(leaderboard) {
        const tbody = document.querySelector("#battleLeaderboardTable tbody");
        if (!tbody) return;
        tbody.innerHTML = "";

        if (!leaderboard || !leaderboard.length) {
          tbody.innerHTML = `<tr><td colspan="4">No data yet</td></tr>`;
          return;
        }

        leaderboard.forEach((entry, i) => {
          const walletShort = entry.wallet
            ? entry.wallet.slice(0, 6) + "..." + entry.wallet.slice(-4)
            : "";

          let twitterUrl = entry.twitterUrl;
          if (!twitterUrl && entry.twitter) {
            twitterUrl = `https://twitter.com/${entry.twitter.replace(/^@/, "")}`;
          }

          tbody.innerHTML += `
      <tr>
        <td class="js-leaderboard-rank">${i === 0 ? "🏆" : i + 1}</td>
        <td>
          ${entry.twitterPic
              ? `<img src="${entry.twitterPic}" alt="avatar" class="js-leaderboard-avatar">`
              : `<span class="js-leaderboard-placeholder"></span>`}
          ${entry.twitter ?
              `<a href="${twitterUrl}" target="_blank" class="js-leaderboard-twitter">
              @${entry.twitter.replace(/^@/, "")}
            </a>`
              : `<span class="js-leaderboard-unknown">(unknown)</span>`}
        </td>
        <td>
          <code class="js-leaderboard-wallet">${walletShort}</code>
        </td>
        <td>
          <span class="js-leaderboard-wins">${entry.wins}</span>
        </td>
      </tr>
    `;
        });
      }
      // On dashboard init, call fetchBattleHistory(); fetchBattleLeaderboard();
      // === DAO Voting (Placeholder/Scaffold) ===
      async function fetchDAOProposals() {
        const cont = $("proposalContainer");
        if (!cont) return;

        if (!FEATURES.DAO_PROPOSALS) {
          cont.innerHTML = '<div class="dao-placeholder">🗳️ DAO voting features coming soon...</div>';
          return;
        }

        try {
          const res = await fetch(`${baseURL}/api/dao/proposals`);
          const data = await res.json();
          cont.innerHTML = "";
          (data.proposals || []).forEach(p => {
            cont.innerHTML += `
        <div>
          <b>${p.title}</b> - ${p.status}
          <button onclick="voteDAO('${p.id}', true)">Yes</button>
          <button onclick="voteDAO('${p.id}', false)">No</button>
        </div>
      `;
          });
        } catch (e) {
          console.warn('DAO proposals failed:', e.message);
          cont.innerHTML = '<div class="dao-placeholder">🗳️ DAO voting temporarily unavailable</div>';
        }
      }
      async function voteDAO(proposalId, yes) {
        try {
          const res = await fetch(`${baseURL}/api/dao/vote`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ wallet: getWallet(), proposalId, vote: yes })
          });
          const data = await res.json();
          if (data.success) showToast("Vote cast!", "success");
          else showToast(data.error || "Vote failed", "error");
          fetchDAOProposals();
        } catch (e) { showToast("Vote error", "error"); }
      }
      window.voteDAO = voteDAO;

      // --- [YOUR ENHANCED FEATURES & MODALS: see your original paste, all logic goes here] ---
      // (No code omitted, all previous functions and event listeners are included below.)

      // (Add any additional functions if you have them below this comment...)


      // ==== INIT EVERYTHING ====
      let dashboardIntervals = [];
      let isDashboardInitialized = false;

      async function initWaldoDashboard() {
        async function loadBattleFeesForUI() {
          try {
            const res = await fetch(`${baseURL}/api/config/public`);
            const data = await res.json();
            const info = document.getElementById('battleFeeInfo');
            if (data && data.success && data.config && data.config.battle && info) {
              const b = data.config.battle;
              info.textContent = `Fees: Start ${b.startFeeWLO} WLO • Accept ${b.acceptFeeWLO} WLO • Vote ${b.voteFeeWLO} WLO ${b.useDefaults ? '(default)' : '(custom)'}`;
            } else if (info) {
              info.textContent = 'Fees unavailable';
            }
          } catch (e) {
            const info = document.getElementById('battleFeeInfo');
            if (info) info.textContent = 'Fees unavailable';
          }
        }

        const wallet = getWallet();
        if (!wallet || isDashboardInitialized) return;

        isDashboardInitialized = true;

        async function fetchPolicyWorth(wallet) {
          try {
            const res = await fetch(`${baseURL}/api/policy/worth?wallet=${wallet}`);
            const data = await res.json();
            const statusEl = $("eligibilityStatus");
            const detailEl = $("eligibilityDetail");
            if (!statusEl || !detailEl) return;
            if (data && data.success) {
              statusEl.textContent = data.ok ? "Eligible" : "Not Eligible";
              statusEl.style.color = data.ok ? "#25c2a0" : "#ff6b6b";
              const bal = Number(data.balance || 0).toLocaleString();
              const req = Number(data.requiredWaldo || 0).toLocaleString();
              const rate = Number(data.waldoPerXrp || 0).toLocaleString();
              detailEl.textContent = data.ok
                ? `You have ${bal} WALDO (min ${req} at ${rate} WALDO/XRP)`
                : `You need ${req} WALDO (≈${data.minXrp} XRP at ${rate} WALDO/XRP). You have ${bal}.`;
            } else {
              statusEl.textContent = "Unknown";
              detailEl.textContent = data?.error || "Policy status unavailable";
            }
          } catch (e) {
            const statusEl = $("eligibilityStatus");
            const detailEl = $("eligibilityDetail");
            if (statusEl) statusEl.textContent = "Unknown";
            if (detailEl) detailEl.textContent = "Policy status unavailable";
          }
        }

        console.log("🚀 Initializing WALDO Dashboard...");

        clearDashboardIntervals();

        try {
          // Generate reward table based on user level (use stats value if available later)
          const userLevel = getCurrentUserLevel(0);
          generateRewardTable(userLevel);

          const loadPromises = [
            fetchUserStats(wallet).catch(e => console.warn('User stats failed:', e)),
            fetchPolicyWorth(wallet).catch(e => console.warn('Worth policy failed:', e)),
            loadBattleFeesForUI().catch(e => console.warn('Battle config failed:', e)),
            // Add all other data fetches here
            fetchConversionRate().catch(e => console.warn('Conversion rate failed:', e)),
            loadTopMeme().catch(e => console.warn('Top meme failed:', e)),
            fetchMemes(wallet).catch(e => console.warn('Memes failed:', e)),
            fetchNFTCollection(wallet).catch(e => console.warn('NFT collection failed:', e)),
            fetchActivity(wallet).catch(e => console.warn('Activity failed:', e)),
            fetchStakingPositions(wallet).catch(e => console.warn('Staking positions failed:', e)),
            fetchBattleStatus().catch(e => console.warn('Battle status failed:', e)),
            fetchBattleHistory().catch(e => console.warn('Battle history failed:', e)),
            fetchBattleLeaderboard().catch(e => console.warn('Battle leaderboard failed:', e)),
            fetchDAOProposals().catch(e => console.warn('DAO proposals failed:', e)),
            fetchStakingStatsSummary().catch(e => console.warn('Staking stats summary failed:', e)),
            initializePriceCharts().catch(e => console.warn('Price charts failed:', e))
          ];

          await Promise.allSettled(loadPromises);
          setupPeriodicUpdates(wallet);

        } catch (error) {
          console.error("❌ Dashboard initialization failed:", error);
          isDashboardInitialized = false; // Allow retry
        }
      }

      function clearDashboardIntervals() {
        dashboardIntervals.forEach(interval => clearInterval(interval));
        dashboardIntervals = [];

        if (window.battleTimerInterval) {
          clearInterval(window.battleTimerInterval);
          window.battleTimerInterval = null;
        }
      }

      function setupPeriodicUpdates(wallet) {
        clearDashboardIntervals();

        dashboardIntervals.push(
          setInterval(() => fetchBattleLeaderboard().catch(e => console.warn('Periodic battle leaderboard failed:', e)), 5 * 60 * 1000)
        );
        dashboardIntervals.push(
          setInterval(() => fetchUserStats(wallet).catch(e => console.warn('Periodic user stats failed:', e)), 3 * 60 * 1000)
        );
        dashboardIntervals.push(
          setInterval(() => {
            fetchMemes(wallet).catch(e => console.warn('Periodic memes failed:', e));
            fetchNFTCollection(wallet).catch(e => console.warn('Periodic NFT collection failed:', e));
          }, 5 * 60 * 1000)
        );
        dashboardIntervals.push(
          setInterval(() => fetchStakingPositions(wallet).catch(e => console.warn('Periodic staking positions failed:', e)), 2 * 60 * 1000)
        );
        dashboardIntervals.push(
          setInterval(() => fetchPolicyWorth(wallet).catch(e => console.warn('Periodic worth policy failed:', e)), 2 * 60 * 1000)
        );
        dashboardIntervals.push(
          setInterval(() => fetchStakingStatsSummary().catch(e => console.warn('Periodic staking stats summary failed:', e)), 2 * 60 * 1000)
        );

      }

      let dashboardStarted = false;

      function startDashboard() {
        const wallet = getWallet();
        if (!wallet) {
          console.log("⏳ Waiting for wallet login...");
          return;
        }
        if (dashboardStarted) {
          console.log("⚠️ Dashboard already started, skipping...");
          return;
        }
        dashboardStarted = true;
        $("walletAddress") && ($("walletAddress").innerText = `Wallet: ${wallet}`);
        showWaldoNotification("✅ WALDO wallet connected");
        initWaldoDashboard().finally(() => {
          const loader = document.getElementById("waldoLoader");
          if (loader) loader.style.display = "none";
          const mainContent = document.getElementById("mainContent");
          if (mainContent) mainContent.style.display = "block";
        });
      }

      function resetDashboard() {
        dashboardStarted = false;
        isDashboardInitialized = false;
        clearDashboardIntervals();
        console.log("🔄 Dashboard reset");
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Initialize staking zone as collapsed
        const stakingZoneSection = document.getElementById("stakingZoneSection");
        if (stakingZoneSection) {
          stakingZoneSection.style.display = "none";
        }

        initializePage();
      });

      function initializePage() {
        // Always show wallet connection screen first
        // This prevents getting stuck on loading
        console.log("🚀 Initializing page - showing connect wallet screen");
        showWalletConnectionScreen();
        setupConnectWalletButton();

        // Check if wallet is already connected in background
        const walletAddress = localStorage.getItem('walletAddress') || localStorage.getItem('xummWallet');

        if (walletAddress) {
          console.log("📱 Found existing wallet, auto-connecting...");
          // Small delay to show the connect screen briefly, then auto-connect
          setTimeout(() => {
            handleWalletConnection();
          }, 500);
        }
      }

      function showWalletConnectionScreen() {
        const connectionScreen = document.getElementById("walletConnectionScreen");
        if (connectionScreen) connectionScreen.style.display = "flex";
      }

      function hideWalletConnectionScreen() {
        const connectionScreen = document.getElementById("walletConnectionScreen");
        if (connectionScreen) connectionScreen.style.display = "none";
      }

      function showLoader() {
        const loader = document.getElementById("waldoLoader");
        if (loader) loader.style.display = "flex";
      }

      function hideLoader() {
        const loader = document.getElementById("waldoLoader");
        if (loader) loader.style.display = "none";
      }

      function showMainContent() {
        const mainContent = document.getElementById("mainContent");
        if (mainContent) mainContent.style.display = "block";
      }

      function setupConnectWalletButton() {
        const connectBtn = document.getElementById("connectWalletBtn");
        if (connectBtn) {
          connectBtn.addEventListener("click", handleWalletConnection);
        }
      }

      async function handleWalletConnection() {
        try {
          console.log("🔗 Starting wallet connection...");

          // Hide connection screen and show loader
          hideWalletConnectionScreen();
          showLoader();

          // Check if wallet is already connected
          const existingWallet = localStorage.getItem('walletAddress') || localStorage.getItem('xummWallet');

          if (existingWallet) {
            console.log("📱 Using existing wallet:", existingWallet);
            // Wallet already exists, just start dashboard
            startDashboard();
          } else {
            console.log("🔗 Connecting new wallet...");
            // Connect wallet using existing XUMM functionality
            await connectWallet();

            // Wait a moment for wallet to be stored
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Start dashboard
            startDashboard();
          }

          // Hide loader and show main content
          hideLoader();
          showMainContent();

          console.log("✅ Dashboard loaded successfully!");

        } catch (error) {
          console.error("❌ Wallet connection failed:", error);
          // Show connection screen again on error
          hideLoader();
          showWalletConnectionScreen();
          showToast("Wallet connection failed. Please try again.");
        }
      }

      /** === POSTMESSAGE LOGIN SUPPORT === **/
      window.addEventListener("message", (event) => {
        if (
          event.origin !== "https://stats-page.waldocoin.live" &&
          event.origin !== "https://waldocoin.live"
        ) return;

        if (event.data.wallet) {
          localStorage.setItem("xummWallet", event.data.wallet);
          sessionStorage.setItem("waldoLoginDesktop", "1");

          if (!dashboardStarted) {
            startDashboard();
          }
        }
      });
      function logoutWallet() {
        localStorage.removeItem("xummWallet");
        sessionStorage.removeItem("waldoLoginDesktop");
        updateWalletUI(null);
        window.location.replace("https://waldocoin.live/?logout=1");
      }
      window.logoutWallet = logoutWallet;

      // Connect wallet function
      async function connectWallet() {
        try {
          console.log('🔗 Connecting wallet...');
          const response = await fetch(`${baseURL}/api/login`);
          const data = await response.json();

          if (data.qr && data.uuid) {
            showXummModal('Connect Wallet', data);
            pollLoginStatus(data.uuid);
          } else {
            throw new Error('Failed to create login payload');
          }
        } catch (error) {
          console.error('❌ Connect wallet error:', error);
          showToast('Failed to connect wallet. Please try again.', 'error');
        }
      }
      window.connectWallet = connectWallet;

      // Update wallet UI based on connection status
      function updateWalletUI(wallet) {
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const walletAddress = document.getElementById('walletAddress');

        if (wallet) {
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'block';
          walletAddress.textContent = `Wallet: ${wallet.slice(0, 6)}...${wallet.slice(-6)}`;
        } else {
          connectBtn.style.display = 'block';
          disconnectBtn.style.display = 'none';
          walletAddress.textContent = 'Wallet: Not Connected';
        }
      }

      // Poll login status
      function pollLoginStatus(uuid) {
        const pollInterval = setInterval(async () => {
          try {
            const response = await fetch(`${baseURL}/api/login/status?uuid=${uuid}`);
            const status = await response.json();

            if (status.signed && status.account) {
              clearInterval(pollInterval);
              localStorage.setItem('xummWallet', status.account);
              sessionStorage.setItem('waldoLoginDesktop', 'true');
              updateWalletUI(status.account);
              hideXummModal();
              showToast('✅ Wallet connected successfully!', 'success');

              // Start dashboard if not already started
              if (!dashboardStarted) {
                startDashboard();
              }
            } else if (status.expired) {
              clearInterval(pollInterval);
              hideXummModal();
              showToast('Login expired. Please try again.', 'error');
            }
          } catch (error) {
            console.error('Login polling error:', error);
          }
        }, 2000);

        // Stop polling after 5 minutes
        setTimeout(() => clearInterval(pollInterval), 300000);
      }

      // Show XUMM modal
      function showXummModal(title, data) {
        const modal = document.getElementById('xummModal');
        const titleEl = document.getElementById('xummTitle');
        const qrEl = document.getElementById('xummQr');
        const qrContainer = document.getElementById('xummQrContainer');
        const loader = document.getElementById('xummLoader');

        titleEl.textContent = title;
        qrEl.src = data.qr || data.refs?.qr_png;

        qrContainer.style.display = 'block';
        loader.style.display = 'none';
        modal.style.display = 'flex';
      }

      // Hide XUMM modal
      function hideXummModal() {
        const modal = document.getElementById('xummModal');
        modal.style.display = 'none';
      }

      window.showXummModal = showXummModal;
      window.hideXummModal = hideXummModal;

      /** === BUTTON HOOKS FOR HTML === **/
      window.dismissWaldoNotification = dismissWaldoNotification;
      window.copyReferral = copyReferral;
    </script>

  </div> <!-- End mainContent -->

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const params = new URLSearchParams(window.location.search);
      if (params.get("logout") === "1") {
        const toast = document.createElement("div");
        toast.textContent = "✅ You have been logged out.";
        toast.style.cssText = `
      position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
      background: #222; color: #fff; padding: 16px 36px; border-radius: 8px;
      font-size: 1.25rem; box-shadow: 0 0 12px #25c2a0bb; z-index: 99999;
    `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3200);
      }
    });
  </script>

  <!-- XUMM Connection Modal -->
  <div id="xummModal" class="xumm-modal" style="display:none;">
    <div class="xumm-backdrop" onclick="hideXummModal()"></div>
    <div class="xumm-content">
      <button class="xumm-close" onclick="hideXummModal()">✕</button>
      <h3 id="xummTitle">Connect Wallet</h3>
      <div id="xummQrContainer">
        <img id="xummQr" alt="Scan with XUMM" style="max-width: 280px; border-radius: 10px;" />
        <p class="xumm-hint">Scan the QR code with your XUMM app</p>
      </div>
      <div id="xummLoader" class="xumm-loader" style="display:none;">
        <div class="spinner"></div>
        <p>Waiting for wallet connection...</p>
      </div>
    </div>
  </div>

</body>

</html>