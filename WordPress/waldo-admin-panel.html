<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALDO Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
    }

    .admin-header {
      background: linear-gradient(90deg, #25c2a0, #1ea085);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .admin-title {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .admin-subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .admin-nav {
      background: #111;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
    }

    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: #25c2a0;
      transform: translateY(-2px);
    }

    .nav-btn.active {
      background: #25c2a0;
      box-shadow: 0 0 10px rgba(37, 194, 160, 0.3);
    }

    .admin-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .admin-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .admin-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #222 0%, #333 100%);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      text-align: center;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #25c2a0;
      margin-bottom: 10px;
    }

    .stat-label {
      font-size: 1.1em;
      opacity: 0.8;
    }

    .admin-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .card-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #25c2a0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #ccc;
    }

    .form-input {
      width: 100%;
      padding: 12px 15px;
      background: #333;
      border: 1px solid #555;
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #25c2a0;
      box-shadow: 0 0 0 2px rgba(37, 194, 160, 0.2);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .btn {
      background: linear-gradient(135deg, #25c2a0, #1ea085);
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 194, 160, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #666, #555);
      color: #fff;
    }

    /* Password Management Styles */
    .password-display {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #25c2a0;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      color: #25c2a0;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }

    .password-source {
      background: rgba(255, 217, 61, 0.1);
      border: 1px solid #ffd93d;
      color: #ffd93d;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      text-align: center;
    }

    .quick-passwords {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }

    .quick-btn {
      background: #444;
      color: white;
      border: 1px solid #666;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      text-align: center;
    }

    .quick-btn:hover {
      background: #555;
      border-color: #25c2a0;
      transform: translateY(-1px);
    }

    /* Environment Status Styles */
    .env-status {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .env-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }

    .env-item:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    .env-label {
      color: #ccc;
      font-size: 0.9em;
    }

    .env-value {
      color: #25c2a0;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: #111;
      border: 2px solid #25c2a0;
      border-radius: 18px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 30px rgba(37, 194, 160, 0.3);
      text-align: center;
    }

    .login-header h1 {
      color: #25c2a0;
      margin: 0 0 10px 0;
      font-size: 2.2em;
    }

    .login-header p {
      color: #ccc;
      margin: 0 0 30px 0;
      font-size: 1.1em;
    }

    .login-form {
      text-align: left;
    }

    .login-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
    }

    .login-info {
      background: rgba(37, 194, 160, 0.1);
      border: 1px solid #25c2a0;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }

    .login-info p {
      color: #25c2a0;
      margin: 5px 0;
      font-size: 0.9em;
    }

    .header-with-logout {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Utility Classes */
    .hidden {
      display: none !important;
    }

    .margin-bottom-30 {
      margin-bottom: 30px;
    }

    .margin-bottom-20 {
      margin-bottom: 20px;
    }

    .margin-bottom-15 {
      margin-bottom: 15px;
    }

    .margin-bottom-10 {
      margin-bottom: 10px;
    }

    .margin-top-15 {
      margin-top: 15px;
    }

    .margin-top-10 {
      margin-top: 10px;
    }

    .text-center {
      text-align: center;
    }

    .text-muted {
      color: #666;
    }

    .text-success {
      color: #27ae60;
    }

    .text-error {
      color: #e74c3c;
    }

    .text-warning {
      color: #f39c12;
    }

    .text-primary {
      color: #25c2a0;
    }

    .padding-20 {
      padding: 20px;
    }

    .width-100 {
      width: 100%;
    }

    .font-small {
      font-size: 0.9em;
    }

    .font-bold {
      font-weight: bold;
    }

    .opacity-80 {
      opacity: 0.8;
    }

    .status-container {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .stat-box {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .help-text {
      color: #666;
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
    }

    /* Additional utility classes */
    .section-title {
      color: #25c2a0;
      margin-bottom: 15px;
    }

    .section-title-spaced {
      color: #25c2a0;
      margin: 25px 0 15px 0;
    }

    .stake-details {
      display: none;
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .emergency-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .checkbox-margin {
      margin-right: 8px;
    }

    .alert-small {
      margin-bottom: 15px;
      font-size: 0.9em;
    }

    .data-table {
      width: 100%;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }

    .data-table th {
      background: #333;
      padding: 15px;
      text-align: left;
      font-weight: bold;
      color: #25c2a0;
      border-bottom: 1px solid #444;
    }

    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
    }

    .data-table tr:hover {
      background: #2a2a2a;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
    }

    .status-active {
      background: #27ae60;
      color: #fff;
    }

    .status-blocked {
      background: #e74c3c;
      color: #fff;
    }

    .status-flagged {
      background: #f39c12;
      color: #fff;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      border: 1px solid #27ae60;
      color: #2ecc71;
    }

    .alert-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
    }

    .alert-warning {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid #f39c12;
      color: #f39c12;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #25c2a0;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }

    /* Staking Admin Styles */
    .stake-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .stake-detail-row:last-child {
      border-bottom: none;
    }

    .stake-detail-row span:first-child {
      color: #aaa;
      font-weight: 500;
    }

    .stake-detail-row span:last-child {
      color: #25c2a0;
      font-weight: bold;
    }

    #stakeSelector {
      margin-bottom: 15px;
    }

    #unstakeResult {
      padding: 10px;
      border-radius: 6px;
      display: none;
    }

    #unstakeResult.success {
      background: #25c2a020;
      border: 1px solid #25c2a0;
      color: #25c2a0;
      display: block;
    }

    #unstakeResult.error {
      background: #ff6b6b20;
      border: 1px solid #ff6b6b;
      color: #ff6b6b;
      display: block;
    }

    @media (max-width: 768px) {

      .grid-2,
      .grid-3 {
        grid-template-columns: 1fr;
      }

      .nav-buttons {
        flex-direction: column;
      }

      .admin-content {
        padding: 20px;
      }
    }

    /* New Layout Styles */
    .auth-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-button-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-button-row .form-input {
      flex: 1;
      min-width: 250px;
    }

    .auth-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .password-control-section {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .current-password-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .password-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .current-password {
      font-size: 24px;
      font-weight: bold;
      color: #25c2a0;
      font-family: monospace;
      letter-spacing: 2px;
    }

    .password-source {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    .password-change-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .password-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .result-display {
      min-height: 40px;
      padding: 10px;
      border-radius: 6px;
      background: #2a2a2a;
      border: 1px solid #444;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>üîí WALDO Admin Panel</h1>
        <p>Enter admin password to access system controls</p>
      </div>

      <div class="login-form">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="Enter admin password"
            onkeypress="handleLoginKeypress(event)">
        </div>

        <button type="button" class="btn btn-primary" onclick="attemptLogin()">
          üîì Access Admin Panel
        </button>

        <div id="loginError" class="login-error hidden"></div>

        <div class="login-info">
          <p>üí° Use the X_ADMIN_KEY environment variable password</p>
          <p>üîê This password is for admin panel access only</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Admin Panel (Hidden by default) -->
  <div id="adminPanel" class="hidden">
    <!-- Admin Header -->
    <div class="admin-header">
      <div class="header-with-logout">
        <div>
          <div class="admin-title">üõ†Ô∏è WALDO Emergency Admin Panel</div>
          <div class="admin-subtitle">Backup controls and manual overrides for automated systems</div>
        </div>
        <button type="button" class="btn btn-danger" onclick="logout()">
          üö™ Logout
        </button>
      </div>
    </div>

    <!-- Navigation -->
    <div class="admin-nav">
      <div class="nav-buttons">
        <button type="button" class="nav-btn active" onclick="showSection('dashboard')">üìä System Status</button>
        <button type="button" class="nav-btn" onclick="showSection('users')">üë• User Override</button>
        <button type="button" class="nav-btn" onclick="showSection('airdrops')">üéÅ Airdrop/Presale</button>
        <button type="button" class="nav-btn" onclick="showSection('battles')">‚öîÔ∏è Battle Override</button>
        <button type="button" class="nav-btn" onclick="showSection('staking')">üè¶ Staking Monitor</button>
        <button type="button" class="nav-btn" onclick="showSection('security')">üõ°Ô∏è Security Override</button>
        <button type="button" class="nav-btn" onclick="showSection('dao')">üó≥Ô∏è DAO Override</button>
        <button type="button" class="nav-btn" onclick="showSection('volumebot')">ü§ñ Trading Bot</button>
        <button type="button" class="nav-btn" onclick="showSection('system')">‚öôÔ∏è Emergency Controls</button>
        <button type="button" class="nav-btn" onclick="runDiagnostics()" style="background: #f39c12;">üîç
          Diagnostics</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="admin-content">
      <!-- Dashboard Section -->
      <div id="dashboard" class="admin-section active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalUsers">-</div>
            <div class="stat-label">WALDO Trustlines</div>
            <button onclick="loadTrustlineCount()"
              style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">üîÑ
              Refresh</button>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalWaldoDistributed">-</div>
            <div class="stat-label">WALDO Distributed</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeBattles">-</div>
            <div class="stat-label">Active Battles</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalStaked">-</div>
            <div class="stat-label">Total Staked</div>
          </div>
        </div>

        <!-- Admin Key Configuration -->
        <!-- üîë Admin Authentication Section -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üîë Admin Authentication</div>
          <p class="text-muted margin-bottom-20">Set your admin key to access all admin functions (from X_ADMIN_KEY
            environment variable)</p>

          <div class="auth-section">
            <div class="auth-input-group">
              <label class="form-label">Admin Key</label>
              <div class="input-button-row">
                <input type="password" id="adminKeyInput" class="form-input" placeholder="Enter your admin key">
                <button type="button" class="btn btn-primary" onclick="saveAdminKey()">
                  üíæ Save
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearAdminKey()">
                  üóëÔ∏è Clear
                </button>
              </div>
            </div>

            <div class="auth-status-row">
              <div id="adminKeyStatus" class="status-indicator">
                <span id="keyStatusText" class="text-muted">‚ùå No admin key stored</span>
              </div>
              <button type="button" class="btn btn-info btn-small" onclick="testEnvironmentKeys()">
                üß™ Test Connection
              </button>
            </div>
          </div>
        </div>

        <!-- üîê Airdrop Password Control Section -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üîê Daily Airdrop Password</div>
          <p class="text-muted margin-bottom-20">Control the password users need to claim airdrops (separate from admin
            key)</p>

          <div class="password-control-section">
            <div class="current-password-display">
              <div class="password-info">
                <label class="form-label">Current Airdrop Password</label>
                <div id="currentPasswordDisplay" class="current-password" style="color: #25c2a0;">Loading...</div>
                <div id="passwordSource" class="password-source">Redis override</div>
              </div>
              <button type="button" class="btn btn-info" onclick="forceRefreshPassword();">
                üîÑ Refresh
              </button>
            </div>

            <div class="password-change-group">
              <label class="form-label">Change Airdrop Password</label>
              <div class="input-button-row">
                <input type="text" id="newDailyPassword" class="form-input" placeholder="Enter new password for users">
                <button type="button" class="btn btn-primary" onclick="updateAirdropPassword()">
                  ‚úÖ Update
                </button>
              </div>
              <div class="password-actions">
                <button type="button" class="btn btn-secondary btn-small" onclick="generateDailyPassword()">
                  üé≤ Generate Random
                </button>
                <button type="button" class="btn btn-warning btn-small" onclick="clearPasswordOverride()">
                  üîÑ Reset to Default
                </button>
              </div>
            </div>

            <div id="passwordUpdateResult" class="result-display"></div>
          </div>
        </div>

        <div class="grid-2">
          <div class="admin-card">
            <div class="card-title">üìà Recent Activity</div>
            <div id="recentActivity" class="loading">
              <div class="spinner"></div> Loading...
            </div>
          </div>
          <div class="admin-card">
            <div class="card-title">üö® System Alerts</div>
            <div id="systemAlerts" class="loading">
              <div class="spinner"></div> Loading...
            </div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="users" class="admin-section">
        <div class="alert alert-warning margin-bottom-20">
          ‚ö†Ô∏è <strong>User Security Override</strong><br>
          Manual user blocking/unblocking for when automated fraud detection needs intervention.
        </div>

        <div class="admin-card">
          <div class="card-title">üë• User Security Controls</div>

          <!-- Export Users Section -->
          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Export User Data</h4>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <button onclick="exportUsersCSV()" class="btn btn-secondary">
                üì• Download CSV
              </button>
              <button onclick="exportUsersJSON()" class="btn btn-secondary">
                üì• Download JSON
              </button>
              <span style="color: #666; font-size: 0.9em;">Export all user data before reset</span>
            </div>
            <div id="exportResult" class="margin-top-10"></div>
          </div>

          <div class="form-group">
            <input type="text" id="userSearch" class="form-input"
              placeholder="Search by wallet address or Twitter handle...">
          </div>

          <div id="usersList" class="loading">
            <div class="spinner"></div> Loading users...
          </div>
        </div>

        <!-- Manual Security Actions -->
        <div class="admin-card margin-top-20">
          <div class="card-title">üõ°Ô∏è Manual Security Actions</div>

          <div class="grid-2">
            <!-- Block User -->
            <div>
              <h4 style="color: #e74c3c; margin-bottom: 15px;">üö´ Block User</h4>
              <div class="form-group">
                <input type="text" id="blockWallet" class="form-input" placeholder="Wallet address to block">
              </div>
              <div class="form-group">
                <input type="text" id="blockReason" class="form-input" placeholder="Reason for blocking">
              </div>
              <button onclick="blockUser()" class="btn btn-danger">Block User</button>
              <div id="blockResult" class="result-message"></div>
            </div>

            <!-- Unblock User -->
            <div>
              <h4 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Unblock User</h4>
              <div class="form-group">
                <input type="text" id="unblockWallet" class="form-input" placeholder="Wallet address to unblock">
              </div>
              <div class="form-group">
                <input type="text" id="unblockReason" class="form-input" placeholder="Reason for unblocking">
              </div>
              <button onclick="unblockUser()" class="btn btn-success">Unblock User</button>
              <div id="unblockResult" class="result-message"></div>
            </div>
          </div>

          <!-- Security Check -->
          <div class="margin-top-20">
            <h4 style="color: #f39c12; margin-bottom: 15px;">üîç Security Check</h4>
            <div class="form-group">
              <input type="text" id="checkWallet" class="form-input" placeholder="Wallet address to check">
            </div>
            <button onclick="checkUserSecurity()" class="btn btn-warning">Check Security Status</button>
            <div id="securityCheckResult" class="result-message"></div>
          </div>
        </div>
      </div>

      <!-- Airdrops Section -->
      <div id="airdrops" class="admin-section">
        <div class="alert alert-warning margin-bottom-20">
          ‚ö†Ô∏è <strong>Airdrop &amp; Presale Management</strong><br>
          Manage manual airdrops, presale countdown, and presale analytics from this section.
        </div>

        <!-- System Health & Security -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üö® System Health & Emergency Controls</div>

          <div class="grid-3">
            <div>
              <div class="form-group">
                <label class="form-label">System Status</label>
                <div id="systemStatus" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Overall system health status</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">WALDO Balance</label>
                <div id="distributorBalance" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Distributor wallet WALDO balance</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Emergency Controls</label>
                <div style="display: flex; gap: 10px; flex-direction: column;">
                  <button type="button" id="emergencyStopBtn" class="btn btn-danger" onclick="toggleEmergencyStop()">
                    üö® Emergency Stop
                  </button>
                  <button type="button" class="btn btn-info" onclick="refreshSystemHealth()">
                    üîÑ Refresh Status
                  </button>
                </div>
                <small class="help-text">Emergency stop disables all airdrops</small>
              </div>
            </div>
          </div>

          <div class="info-display" style="margin-top: 15px;">
            <div class="stat-item">
              <span class="stat-label">‚ö° Response Times:</span>
              <span id="responseTimes" class="stat-value">Redis: -ms, XRPL: -ms</span>
            </div>
          </div>
        </div>

        <!-- Failed Transactions & Retry System -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üîÑ Failed Transactions & Retry System</div>

          <div class="grid-2">
            <div>
              <div class="form-group">
                <label class="form-label">Failed Transactions</label>
                <div id="failedTxCount" class="info-display" style="color: #e74c3c; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Transactions that failed and need retry</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Success Rate</label>
                <div id="successRate" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Overall transaction success rate</small>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-warning" onclick="loadFailedTransactions()">
              üîÑ Load Failed Transactions
            </button>
            <button type="button" class="btn btn-info" onclick="toggleFailedTxView()">
              üëÅÔ∏è Toggle Failed TX View
            </button>
          </div>

          <div id="failedTxContainer" style="display: none; margin-top: 15px;">
            <div id="failedTxList"
              style="max-height: 300px; overflow-y: auto; border: 1px solid #444; border-radius: 6px; padding: 10px; background: #222;">
              <div style="color: #666; text-align: center; padding: 20px;">
                Click "Load Failed Transactions" to view failed transactions
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Wallet Operations -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üë• Bulk Wallet Operations</div>

          <div class="grid-2">
            <div>
              <div class="form-group">
                <label class="form-label">Operation Type</label>
                <select id="bulkOperation"
                  style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px;">
                  <option value="blacklist">Blacklist Wallets</option>
                  <option value="whitelist">Whitelist Wallets</option>
                  <option value="remove_blacklist">Remove from Blacklist</option>
                  <option value="remove_whitelist">Remove from Whitelist</option>
                </select>
                <small class="help-text">Choose the operation to perform</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Reason</label>
                <input type="text" id="bulkReason" placeholder="Reason for bulk operation"
                  style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px;">
                <small class="help-text">Reason for this bulk operation</small>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Wallet Addresses (one per line)</label>
            <textarea id="bulkWallets" rows="5"
              placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&#10;rYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY&#10;rZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ"
              style="width: 100%; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; font-family: monospace; font-size: 12px;"></textarea>
            <small class="help-text">Enter wallet addresses, one per line</small>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="performBulkOperation()">
              üë• Perform Bulk Operation
            </button>
            <button type="button" class="btn btn-info" onclick="showWalletLists()">
              üìã Show Current Lists
            </button>
          </div>

          <div id="bulkResults"
            style="display: none; margin-top: 15px; padding: 10px; background: #222; border-radius: 6px;">
            <!-- Bulk operation results will appear here -->
          </div>
        </div>

        <!-- Business Intelligence & ROI Analytics -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìà Business Intelligence & ROI Analytics</div>

          <div class="grid-4">
            <div>
              <div class="form-group">
                <label class="form-label">Conversion Rate</label>
                <div id="conversionRate" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Trustline to claim conversion</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Cost Per User</label>
                <div id="costPerUser" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Average WALDO cost per user</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Growth Rate</label>
                <div id="growthRate" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">7-day growth trend</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">ROI Score</label>
                <div id="roiScore" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Return on investment</small>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="loadROIAnalytics()">
              üìà Load ROI Analytics
            </button>
            <button type="button" class="btn btn-info" onclick="loadTokenDistribution()">
              ü™ô Token Distribution
            </button>
            <button type="button" class="btn btn-secondary" onclick="loadMarketingPerformance()">
              üì¢ Marketing Performance
            </button>
          </div>

          <div id="roiDetails"
            style="display: none; margin-top: 15px; padding: 10px; background: #222; border-radius: 6px;">
            <!-- ROI analytics details will appear here -->
          </div>
        </div>

        <!-- Advanced Reports & Executive Dashboard -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìã Advanced Reports & Executive Dashboard</div>

          <div class="grid-3">
            <div>
              <div class="form-group">
                <label class="form-label">System Health</label>
                <div id="executiveSystemHealth" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Overall system status</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Performance Score</label>
                <div id="performanceScore" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Overall performance rating</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Risk Level</label>
                <div id="riskLevel" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Current risk assessment</small>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="loadAdvancedReports()">
              üìã Generate Executive Report
            </button>
            <button type="button" class="btn btn-info" onclick="exportExecutiveReport()">
              üìÑ Export Executive Summary
            </button>
            <button type="button" class="btn btn-secondary" onclick="toggleExecutiveView()">
              üëÅÔ∏è Toggle Executive View
            </button>
          </div>

          <div id="executiveReportContainer" style="display: none; margin-top: 15px;">
            <div id="executiveReport"
              style="max-height: 500px; overflow-y: auto; border: 1px solid #444; border-radius: 6px; padding: 15px; background: #222;">
              <div style="color: #666; text-align: center; padding: 20px;">
                Click "Generate Executive Report" to view comprehensive analytics
              </div>
            </div>
          </div>
        </div>

        <!-- Presale Countdown Management -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">‚è±Ô∏è Presale Countdown Management</div>

          <div class="grid-2">
            <div>
              <div class="form-group">
                <label class="form-label">Current End Date</label>
                <div id="currentEndDate" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Current presale countdown end date</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Time Remaining</label>
                <div id="timeRemaining" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Time left until presale ends</small>
              </div>
            </div>
          </div>

          <div class="grid-2" style="margin-top: 15px;">
            <div>
              <div class="form-group">
                <label class="form-label">Set New End Date & Time</label>
                <input type="datetime-local" id="newEndDate" class="form-input" style="width: 100%;">
                <small class="help-text">Select when the presale should end</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Quick Actions</label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                  <button type="button" class="btn btn-secondary" onclick="setCountdownQuick(24)">
                    +24 Hours
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="setCountdownQuick(168)">
                    +7 Days
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="setCountdownQuick(720)">
                    +30 Days
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="updatePresaleCountdown()">
              ‚è±Ô∏è Update Countdown
            </button>
            <button type="button" class="btn btn-info" onclick="loadCurrentCountdown()">
              üîÑ Refresh Status
            </button>
            <button type="button" class="btn btn-danger" onclick="clearPresaleCountdown()">
              üóëÔ∏è Clear Countdown
            </button>
          </div>

          <div id="countdownStatus"
            style="margin-top: 15px; padding: 10px; background: #222; border-radius: 6px; display: none;">
            <!-- Countdown status messages will appear here -->
          </div>
        </div>

        <!-- Presale Analytics & Tracking -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üöÄ Presale Analytics & Tracking</div>

          <div class="grid-4">
            <div>
              <div class="form-group">
                <label class="form-label">Total WALDO Sold</label>
                <div id="presaleTotalSold" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Total WALDO tokens sold in presale</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Total XRP Raised</label>
                <div id="presaleTotalXRP" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Total XRP raised from presale</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Total Purchases</label>
                <div id="presaleTotalPurchases" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Number of presale purchases</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">24h Activity</label>
                <div id="presaleRecentActivity" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Recent presale activity</small>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-primary" onclick="loadPresaleAnalytics()">
              üöÄ Load Presale Analytics
            </button>
            <button type="button" class="btn btn-info" onclick="loadPresalePurchases()">
              üìã View Recent Purchases
            </button>
            <button type="button" class="btn btn-secondary" onclick="exportPresaleData()">
              üìÑ Export Presale Data
            </button>
          </div>

          <div id="presaleDetails"
            style="display: none; margin-top: 15px; padding: 10px; background: #222; border-radius: 6px;">
            <!-- Presale analytics details will appear here -->
          </div>
        </div>

        <!-- Enhanced Analytics Dashboard -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìä Enhanced Analytics Dashboard</div>

          <div class="grid-3">
            <div>
              <div class="form-group">
                <label class="form-label">24h Activity</label>
                <div id="dailyActivity" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Claims in last 24 hours</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Total Distributed</label>
                <div id="totalDistributed" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Total WALDO distributed</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Wallet Management</label>
                <div id="walletStats" class="info-display" style="color: #25c2a0; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Blacklisted/Whitelisted counts</small>
              </div>
            </div>
          </div>

          <div style="margin-top: 15px;">
            <button type="button" class="btn btn-info" onclick="loadEnhancedAnalytics()">
              üìä Load Enhanced Analytics
            </button>
            <button type="button" class="btn btn-secondary" onclick="loadUserBehavior()">
              üë§ Load User Behavior
            </button>
          </div>

          <div id="analyticsDetails"
            style="display: none; margin-top: 15px; padding: 10px; background: #222; border-radius: 6px;">
            <!-- Enhanced analytics details will appear here -->
          </div>
        </div>

        <!-- Admin Activity Logs -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìù Admin Activity Logs</div>

          <div style="margin-bottom: 15px;">
            <button type="button" class="btn btn-secondary" onclick="loadAdminLogs()">
              üìã Load Recent Activity
            </button>
            <button type="button" class="btn btn-info" onclick="toggleLogsView()">
              üëÅÔ∏è Toggle Logs View
            </button>
          </div>

          <div id="adminLogsContainer" style="display: none;">
            <div id="adminLogsList"
              style="max-height: 400px; overflow-y: auto; border: 1px solid #444; border-radius: 6px; padding: 10px; background: #222;">
              <div style="color: #666; text-align: center; padding: 20px;">
                Click "Load Recent Activity" to view admin logs
              </div>
            </div>
          </div>
        </div>

        <!-- Airdrop Amount Control -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üí∞ Airdrop Amount Control</div>

          <div class="grid-2">
            <div>
              <div class="form-group">
                <label class="form-label">Current Airdrop Amount</label>
                <div id="currentAirdropAmount" class="info-display"
                  style="color: #25c2a0; font-size: 18px; font-weight: bold;">
                  Loading...
                </div>
                <small class="help-text">Amount of WALDO tokens per airdrop claim</small>
              </div>
            </div>

            <div>
              <div class="form-group">
                <label class="form-label">Set New Amount</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="number" id="newAirdropAmount" placeholder="20000" min="1" max="1000000"
                    style="flex: 1; padding: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 4px;">
                  <button type="button" class="btn btn-primary" onclick="updateAirdropAmount()">
                    üí∞ Update Amount
                  </button>
                </div>
                <small class="help-text">
                  Enter new amount (1 - 1,000,000 WALDO). Current claims will use new amount.
                </small>
              </div>
            </div>
          </div>

          <div class="info-display" style="margin-top: 15px;">
            <div class="stat-item">
              <span class="stat-label">‚ö†Ô∏è Important:</span>
              <span class="stat-value" style="color: #ffd93d;">Changes apply to all future airdrops immediately</span>
            </div>
          </div>
        </div>

        <!-- Claimed Wallets Export -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìä Claimed Wallets Export</div>

          <div class="grid-2">
            <div>
              <div class="form-group">
                <label class="form-label">Export Options</label>
                <div class="button-group">
                  <button type="button" class="btn btn-primary" onclick="exportClaimedWallets()">
                    üì• Download CSV Spreadsheet
                  </button>
                  <button type="button" class="btn btn-secondary" onclick="viewClaimedWallets()">
                    üëÅÔ∏è View Claimed List
                  </button>
                </div>
                <small class="help-text">
                  Export all wallets that have claimed airdrops for analysis
                </small>
              </div>
            </div>

            <div>
              <div id="claimedWalletsInfo" class="info-display">
                <div class="stat-item">
                  <span class="stat-label">Total Claimed:</span>
                  <span id="totalClaimedCount" class="stat-value">Loading...</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Manual Airdrops:</span>
                  <span id="manualCount" class="stat-value">Loading...</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Regular Claims:</span>
                  <span id="regularCount" class="stat-value">Loading...</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Remaining:</span>
                  <span id="remainingCount" class="stat-value">Loading...</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Last Updated:</span>
                  <span id="lastUpdated" class="stat-value">Never</span>
                </div>
              </div>
            </div>
          </div>

          <div id="claimedWalletsList" style="display:none; margin-top:20px;">
            <div class="card-title">üìã Claimed Wallets List</div>

            <!-- Add Missing Wallet Section -->
            <div style="margin-bottom:15px; padding:10px; background:#333; border-radius:6px;">
              <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">‚ûï Add Missing Wallet</div>
              <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="missingWalletAddress" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                  style="flex:1; padding:6px; background:#222; border:1px solid #555; color:white; border-radius:4px; font-family:monospace; font-size:12px;">
                <input type="text" id="missingWalletReason" placeholder="Reason (e.g., tracking failed yesterday)"
                  style="flex:1; padding:6px; background:#222; border:1px solid #555; color:white; border-radius:4px; font-size:12px;">
                <button type="button" onclick="addMissingWallet()"
                  style="padding:6px 12px; background:#25c2a0; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer;">
                  Add to Tracking
                </button>
              </div>
              <div style="font-size:10px; color:#666; margin-top:5px;">
                Use this to add wallets that received airdrops but aren't in the tracking system
              </div>
            </div>

            <div id="walletsTableContainer"
              style="max-height:300px; overflow-y:auto; border:1px solid #444; border-radius:6px; padding:10px;">
              <!-- Wallets list will be populated here -->
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="admin-card">
            <div class="card-title">üéÅ Emergency Airdrop</div>

            <form id="airdropForm">
              <div class="form-group">
                <label class="form-label">Wallet Address</label>
                <input type="text" id="airdropWallet" class="form-input" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                  required>
              </div>

              <div class="form-group">
                <label class="form-label">Amount (WALDO)</label>
                <input type="number" id="airdropAmount" class="form-input" placeholder="1000" min="1" max="1000000"
                  required>
              </div>

              <div class="form-group">
                <label class="form-label">Reason (Required for manual override)</label>
                <input type="text" id="airdropReason" class="form-input"
                  placeholder="e.g., Automated system failed, emergency distribution" required>
              </div>

              <button type="submit" class="btn btn-warning">‚ö†Ô∏è Manual Override Send</button>
            </form>
          </div>

          <div class="admin-card">
            <div class="card-title">üìä Airdrop Statistics</div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="airdropsClaimed">-</div>
                <div class="stat-label">Claims / 1000</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="airdropsRemaining">-</div>
                <div class="stat-label">Remaining</div>
              </div>
            </div>

            <div id="airdropHistory" class="loading">
              <div class="spinner"></div> Loading history...
            </div>
          </div>
        </div>

        <!-- Reset Airdrop Section -->
        <div class="admin-card" style="border: 2px solid #e74c3c; background: #2a1f1f;">
          <div class="card-title" style="color: #e74c3c;">üîÑ Reset Airdrop System</div>

          <div class="alert alert-warning margin-bottom-15">
            ‚ö†Ô∏è <strong>DANGER:</strong> This will reset the airdrop counter to 0/1000 and clear all claimed wallets. Use
            only for testing or official launch preparation.
          </div>

          <div class="margin-bottom-15">
            <strong>What gets reset:</strong>
            <ul style="margin: 10px 0; padding-left: 20px; color: #ccc;">
              <li>Airdrop counter: Reset to 0/1000</li>
              <li>Claimed wallets: All cleared</li>
              <li>Password override: Cleared (back to WALDOCREW)</li>
            </ul>
          </div>

          <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <button onclick="resetAirdropSystem()" class="btn" style="background: #e74c3c; color: white; border: none;">
              üîÑ Reset Airdrop System
            </button>
            <span style="color: #ff6b6b; font-size: 0.9em; font-weight: bold;">‚ö†Ô∏è This action cannot be undone!</span>
          </div>

          <div id="resetResult" class="margin-top-15"></div>
        </div>

        <!-- Airdrop Configuration Controls -->
        <div class="admin-card" style="border: 2px solid #3498db; background: #1a2332;">
          <div class="card-title" style="color: #3498db;">‚öôÔ∏è Airdrop Configuration Controls</div>

          <div class="margin-bottom-20">
            <h4 style="color: #3498db; margin-bottom: 10px;">üìä Current Airdrop Settings</h4>
            <div id="currentAirdropConfig" class="margin-bottom-15">
              <div style="color: #666; font-style: italic;">Loading current configuration...</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #3498db; margin-bottom: 15px;">üîß Update Airdrop Limits</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Maximum
                  Wallets:</label>
                <input type="number" id="maxWallets" class="form-input" min="100" max="100000" step="100"
                  placeholder="1000">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 1000 wallets</div>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Duration
                  (days):</label>
                <input type="number" id="airdropDays" class="form-input" min="1" max="365" step="1" placeholder="5">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 5 days</div>
              </div>
            </div>

            <div class="margin-bottom-15">
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for
                Change:</label>
              <input type="text" id="configChangeReason" class="form-input"
                placeholder="e.g., High demand, Extended promotion, Contest event" maxlength="100">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <button onclick="updateAirdropConfig()" class="btn" style="background: #3498db; color: white;">
                ‚öôÔ∏è Update Configuration
              </button>
              <button onclick="resetToDefaults()" class="btn" style="background: #95a5a6; color: white;">
                üîÑ Reset to Defaults
              </button>
            </div>

            <div id="configResult" class="margin-top-15"></div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #3498db; margin-bottom: 10px;">üöÄ Quick Configuration Presets</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="setQuickConfig(2000, 10, 'Extended Launch')" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üöÄ Extended Launch (2K wallets, 10 days)
              </button>
              <button onclick="setQuickConfig(5000, 14, 'Major Promotion')" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üéØ Major Promo (5K wallets, 14 days)
              </button>
              <button onclick="setQuickConfig(10000, 30, 'Mega Campaign')" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üíé Mega Campaign (10K wallets, 30 days)
              </button>
              <button onclick="setQuickConfig(500, 3, 'Limited Flash')" class="btn btn-secondary"
                style="font-size: 0.9em;">
                ‚ö° Flash Drop (500 wallets, 3 days)
              </button>
            </div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #3498db; margin-bottom: 10px;">üìà Configuration History</h4>
            <div id="configHistory" style="max-height: 200px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">No configuration changes yet</div>
            </div>
          </div>

          <div class="alert alert-info">
            üí° <strong>Note:</strong> Configuration changes take effect immediately. Users will see updated limits in
            real-time. All changes are logged for audit purposes.
          </div>
        </div>

        <!-- Minimum WALDO Requirements Control -->
        <div class="admin-card" style="border: 2px solid #e74c3c; background: #2a1616;">
          <div class="card-title" style="color: #e74c3c;">üí∞ Minimum WALDO Requirements</div>

          <div class="margin-bottom-20">
            <h4 style="color: #e74c3c; margin-bottom: 10px;">üìä Current Requirements</h4>
            <div id="currentWaldoRequirements" class="margin-bottom-15">
              <div style="color: #666; font-style: italic;">Loading current requirements...</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #e74c3c; margin-bottom: 15px;">‚öôÔ∏è Update Minimum Requirements</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for Meme
                  Rewards:</label>
                <input type="number" id="minWaldoMemes" class="form-input" min="0" max="100000" step="100"
                  placeholder="6000">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 6000 WALDO (6 XRP worth)</div>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for
                  Battles:</label>
                <input type="number" id="minWaldoBattles" class="form-input" min="0" max="100000" step="100"
                  placeholder="6000">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 6000 WALDO (6 XRP worth)</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for DAO
                  Voting:</label>
                <input type="number" id="minWaldoDAO" class="form-input" min="0" max="100000" step="100"
                  placeholder="100">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 100 WALDO</div>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">WALDO per XRP
                  Rate:</label>
                <input type="number" id="waldoPerXrp" class="form-input" min="1" max="10000" step="1"
                  placeholder="1000">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 1000 WALDO per XRP</div>
              </div>
            </div>

            <div class="margin-bottom-15">
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for
                Change:</label>
              <input type="text" id="requirementChangeReason" class="form-input"
                placeholder="e.g., Market adjustment, Anti-spam measure, Economic rebalancing" maxlength="100">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <button onclick="updateWaldoRequirements()" class="btn" style="background: #e74c3c; color: white;">
                üí∞ Update Requirements
              </button>
              <button onclick="resetWaldoRequirements()" class="btn" style="background: #95a5a6; color: white;">
                üîÑ Reset to Defaults
              </button>
            </div>

            <div id="requirementResult" class="margin-top-15"></div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #e74c3c; margin-bottom: 10px;">üöÄ Quick Requirement Presets</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="setQuickRequirement('launch', 6000, 6000, 100)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üöÄ Launch (6K WALDO)
              </button>
              <button onclick="setQuickRequirement('growth', 3000, 3000, 50)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üìà Growth (3K WALDO)
              </button>
              <button onclick="setQuickRequirement('premium', 10000, 10000, 500)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üíé Premium (10K WALDO)
              </button>
              <button onclick="setQuickRequirement('open', 0, 0, 0)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üåç Open Access (No Min)
              </button>
            </div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #e74c3c; margin-bottom: 10px;">üìà Requirement History</h4>
            <div id="requirementHistory" style="max-height: 200px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">No requirement changes yet</div>
            </div>
          </div>

          <div class="alert alert-info">
            üí° <strong>How it works:</strong> Users need minimum WALDO balance to claim meme rewards, start battles, and
            vote in DAO. Airdrop users get 50,000 WALDO (well above minimums). Changes apply immediately.
          </div>
        </div>

        <!-- Daily Meme Limits Control -->
        <div class="admin-card" style="border: 2px solid #e67e22; background: #2a1f16;">
          <div class="card-title" style="color: #e67e22;">üé≠ Daily Meme Limits Control</div>

          <div class="margin-bottom-20">
            <h4 style="color: #e67e22; margin-bottom: 10px;">üìä Current Meme Limits</h4>
            <div id="currentMemeLimits" class="margin-bottom-15">
              <div style="color: #666; font-style: italic;">Loading current meme limits...</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #e67e22; margin-bottom: 15px;">‚öôÔ∏è Update Meme Limits</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Daily Memes per
                  User:</label>
                <input type="number" id="dailyMemeLimit" class="form-input" min="1" max="100" step="1" placeholder="10">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 10 memes per day</div>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Premium User
                  Limit:</label>
                <input type="number" id="premiumMemeLimit" class="form-input" min="1" max="200" step="1"
                  placeholder="25">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 25 memes per day (10K+ WALDO
                  holders)</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">VIP User
                  Limit:</label>
                <input type="number" id="vipMemeLimit" class="form-input" min="1" max="500" step="1" placeholder="50">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 50 memes per day (50K+ WALDO
                  holders)</div>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reset Time (UTC
                  Hour):</label>
                <input type="number" id="resetHour" class="form-input" min="0" max="23" step="1" placeholder="0">
                <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 0 (midnight UTC)</div>
              </div>
            </div>

            <div class="margin-bottom-15">
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for
                Change:</label>
              <input type="text" id="memeLimitChangeReason" class="form-input"
                placeholder="e.g., Spam prevention, Quality control, Event adjustment" maxlength="100">
            </div>

            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
              <button onclick="updateMemeLimits()" class="btn" style="background: #e67e22; color: white;">
                üé≠ Update Limits
              </button>
              <button onclick="resetMemeLimits()" class="btn" style="background: #95a5a6; color: white;">
                üîÑ Reset to Defaults
              </button>
              <button onclick="viewMemeUsage()" class="btn btn-secondary">
                üìä View Usage Stats
              </button>
            </div>

            <div id="memeLimitResult" class="margin-top-15"></div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #e67e22; margin-bottom: 10px;">üöÄ Quick Limit Presets</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="setQuickMemeLimit('strict', 5, 15, 30)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üîí Strict (5/15/30)
              </button>
              <button onclick="setQuickMemeLimit('balanced', 10, 25, 50)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                ‚öñÔ∏è Balanced (10/25/50)
              </button>
              <button onclick="setQuickMemeLimit('generous', 20, 50, 100)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                üéâ Generous (20/50/100)
              </button>
              <button onclick="setQuickMemeLimit('unlimited', 1000, 1000, 1000)" class="btn btn-secondary"
                style="font-size: 0.9em;">
                ‚ôæÔ∏è Unlimited (1000 each)
              </button>
            </div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #e67e22; margin-bottom: 10px;">üìà Recent Limit Changes</h4>
            <div id="memeLimitHistory" style="max-height: 200px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">No limit changes yet</div>
            </div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #e67e22; margin-bottom: 10px;">üîç User Meme Usage Lookup</h4>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input type="text" id="lookupWallet" class="form-input" placeholder="Enter wallet address"
                style="flex: 1;">
              <button onclick="lookupUserMemeUsage()" class="btn btn-secondary">
                üîç Check Usage
              </button>
            </div>
            <div id="memeUsageResult" class="margin-top-10"></div>
          </div>

          <div class="alert alert-info">
            üé≠ <strong>How it works:</strong> Users can post limited memes per day based on their WALDO holdings. Limits
            reset at midnight UTC. Premium/VIP users get higher limits for holding more WALDO.
          </div>
        </div>

        <!-- AI Fraud Detection System -->
        <div class="admin-card" style="border: 2px solid #9b59b6; background: #2a1a2a;">
          <div class="card-title" style="color: #9b59b6;">ü§ñ AI Fraud Detection System</div>

          <div class="margin-bottom-20">
            <h4 style="color: #9b59b6; margin-bottom: 10px;">üìä Real-Time Fraud Analytics</h4>
            <div id="fraudAnalytics" class="margin-bottom-15">
              <div style="color: #666; font-style: italic;">Loading fraud detection analytics...</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #9b59b6; margin-bottom: 15px;">üö® Recent Violations</h4>
            <div id="recentViolations" style="max-height: 300px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">Loading recent violations...</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #9b59b6; margin-bottom: 15px;">üîç Suspicious Activity Monitor</h4>
            <div id="suspiciousActivity" style="max-height: 250px; overflow-y: auto;">
              <div style="color: #666; font-style: italic;">Loading suspicious activity...</div>
            </div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #9b59b6; margin-bottom: 10px;">‚öôÔ∏è Fraud Detection Controls</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="refreshFraudData()" class="btn" style="background: #9b59b6; color: white;">
                üîÑ Refresh Data
              </button>
              <button onclick="exportViolations()" class="btn btn-secondary">
                üì• Export Violations
              </button>
              <button onclick="clearOldViolations()" class="btn" style="background: #e67e22; color: white;">
                üóëÔ∏è Clear Old Data
              </button>
              <button onclick="adjustSensitivity()" class="btn btn-secondary">
                üéõÔ∏è Adjust Sensitivity
              </button>
            </div>
          </div>

          <div class="alert alert-info">
            ü§ñ <strong>AI System Active:</strong> Advanced bot detection, behavioral analysis, timing patterns, IP
            reputation, and automated blocking. 3 violations = 7-day auto-block.
          </div>
        </div>

        <!-- Bonus Control System -->
        <div class="admin-card" style="border: 2px solid #f39c12; background: #2a2416;">
          <div class="card-title" style="color: #f39c12;">üéÅ Reward Bonus Control System</div>

          <div class="margin-bottom-20">
            <h4 style="color: #f39c12; margin-bottom: 10px;">üöÄ Active Bonus Multipliers</h4>
            <div id="activeBonuses" class="margin-bottom-15">
              <div style="color: #666; font-style: italic;">No active bonuses - all rewards at base rates</div>
            </div>
          </div>

          <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
            <h4 style="color: #f39c12; margin-bottom: 15px;">‚ö° Set New Bonus</h4>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Bonus Type:</label>
                <select id="bonusType" class="form-input">
                  <option value="all">All Rewards (Global)</option>
                  <option value="meme">Meme Rewards Only</option>
                  <option value="battle">Battle Rewards Only</option>
                  <option value="referral">Referral Rewards Only</option>
                  <option value="staking">Staking Rewards Only</option>
                </select>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Multiplier:</label>
                <select id="bonusMultiplier" class="form-input">
                  <option value="1.5">1.5x (50% bonus)</option>
                  <option value="2">2x (Double rewards)</option>
                  <option value="2.5">2.5x (150% bonus)</option>
                  <option value="3">3x (Triple rewards)</option>
                  <option value="5">5x (500% bonus)</option>
                  <option value="10">10x (1000% bonus)</option>
                </select>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Duration
                  (hours):</label>
                <select id="bonusDuration" class="form-input">
                  <option value="1">1 Hour</option>
                  <option value="6">6 Hours</option>
                  <option value="12">12 Hours</option>
                  <option value="24">24 Hours (1 Day)</option>
                  <option value="48">48 Hours (2 Days)</option>
                  <option value="72">72 Hours (3 Days)</option>
                  <option value="168">168 Hours (1 Week)</option>
                  <option value="0">Permanent (until manually removed)</option>
                </select>
              </div>

              <div>
                <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Event Name:</label>
                <input type="text" id="bonusName" class="form-input" placeholder="e.g., Weekend Bonus, Contest Event"
                  maxlength="50">
              </div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
              <button onclick="setBonusMultiplier()" class="btn" style="background: #f39c12; color: white;">
                üöÄ Activate Bonus
              </button>
              <button onclick="clearAllBonuses()" class="btn" style="background: #e74c3c; color: white;">
                üóëÔ∏è Clear All Bonuses
              </button>
            </div>

            <div id="bonusResult" class="margin-top-15"></div>
          </div>

          <div class="margin-bottom-15">
            <h4 style="color: #f39c12; margin-bottom: 10px;">üìä Quick Bonus Presets</h4>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
              <button onclick="setQuickBonus('weekend', 2, 48)" class="btn btn-secondary" style="font-size: 0.9em;">
                üåü Weekend 2x (48h)
              </button>
              <button onclick="setQuickBonus('contest', 5, 24)" class="btn btn-secondary" style="font-size: 0.9em;">
                üèÜ Contest 5x (24h)
              </button>
              <button onclick="setQuickBonus('flash', 10, 1)" class="btn btn-secondary" style="font-size: 0.9em;">
                ‚ö° Flash 10x (1h)
              </button>
              <button onclick="setQuickBonus('launch', 3, 72)" class="btn btn-secondary" style="font-size: 0.9em;">
                üöÄ Launch 3x (72h)
              </button>
            </div>
          </div>

          <div class="alert alert-info">
            üí° <strong>How it works:</strong> Bonuses multiply the base reward amounts. Users will see the bonus in
            their reward notifications. All bonuses are logged and can be reverted instantly.
          </div>
        </div>
      </div>

      <!-- Battles Section -->
      <div id="battles" class="admin-section">
        <div class="alert alert-warning margin-bottom-20">
          ‚ö†Ô∏è <strong>Battle Emergency Controls</strong><br>
          Use these controls only when automated battle system malfunctions or requires manual intervention.
        </div>

        <div class="admin-card">
          <div class="card-title">‚öîÔ∏è Battle Override Controls</div>

          <div class="grid-2">
            <div>
              <h3 class="section-title">Current Battle Status</h3>
              <div id="currentBattle" class="loading">
                <div class="spinner"></div> Loading...
              </div>
            </div>

            <div>
              <h3 class="section-title">Emergency Controls</h3>
              <div class="alert alert-error alert-small">

                <div class="admin-card">
                  <div class="card-title">‚öôÔ∏è Battle Fee Settings</div>
                  <div class="alert alert-small">Toggle defaults or set custom WLO amounts for battle actions.</div>
                  <div class="grid-2">
                    <div>
                      <label class="label">Use Defaults</label>
                      <input type="checkbox" id="battleUseDefaults" />
                    </div>
                    <div></div>
                    <div>
                      <label class="label">Start Fee (WLO)</label>
                      <input class="input" type="number" id="battleStartFee" min="0" step="1" />
                    </div>
                    <div>
                      <label class="label">Accept Fee (WLO)</label>
                      <input class="input" type="number" id="battleAcceptFee" min="0" step="1" />
                    </div>
                    <div>
                      <label class="label">Vote Fee (WLO)</label>
                      <input class="input" type="number" id="battleVoteFee" min="0" step="1" />
                    </div>
                    <div style="display:flex;gap:10px;align-items:flex-end;">
                      <button class="btn" style="background:#25c2a0" onclick="saveBattleFees()">Save</button>
                      <button class="btn" onclick="loadBattleFees()">Reload</button>
                      <span id="battleFeeSaveStatus" class="label" style="color:#aaa"></span>
                    </div>
                  </div>
                </div>

                ‚ö†Ô∏è These actions cannot be undone and will affect active users
              </div>
              <button type="button" class="btn btn-warning" onclick="endCurrentBattle()">‚èπÔ∏è Force End Battle</button>
              <button type="button" class="btn btn-danger" onclick="cancelCurrentBattle()">‚ùå Emergency Cancel</button>
            </div>
          </div>

          <h3 class="section-title-spaced">Recent Battles</h3>
          <div id="battleHistory" class="loading">
            <div class="spinner"></div> Loading battle history...
          </div>
        </div>
      </div>

      <!-- Staking Section -->
      <div id="staking" class="admin-section">
        <div class="alert alert-warning margin-bottom-20">
          ‚ö†Ô∏è <strong>Staking Emergency Controls</strong><br>
          Manual unstaking is a backup mechanism for when automated functions fail. Use with caution.
        </div>

        <div class="grid-2">
          <!-- Staking Overview -->
          <div class="admin-card">
            <div class="card-title">üè¶ Staking Overview</div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="totalStakingPositions">-</div>
                <div class="stat-label">Active Stakes</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="totalStakingValue">-</div>
                <div class="stat-label">Total Value</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="totalStakingRewards">-</div>
                <div class="stat-label">Total Rewards</div>
              </div>
            </div>

            <div id="stakingPositions" class="loading">
              <div class="spinner"></div> Loading staking positions...
            </div>

            <!-- Active Stakes Section -->
            <div style="margin-top: 20px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">‚úÖ Active Stakes</h4>
              <div id="activeStakesTable" style="font-size: 0.9em; overflow-x: auto;">
                <div style="color: #666; text-align: center; padding: 10px;">Loading...</div>
              </div>
            </div>

            <!-- Pending Signature Section -->
            <div style="margin-top: 20px;">
              <h4 style="color: #f39c12; margin-bottom: 10px;">‚è≥ Pending Signature</h4>
              <div id="pendingStakesTable" style="font-size: 0.9em; overflow-x: auto;">
                <div style="color: #666; text-align: center; padding: 10px;">None</div>
              </div>
            </div>

            <!-- Redeemed & Completed Section -->
            <div style="margin-top: 20px;">
              <h4 style="color: #27ae60; margin-bottom: 10px;">‚ú® Redeemed & Completed</h4>
              <div id="redeemedStakesTable" style="font-size: 0.9em; overflow-x: auto;">
                <div style="color: #666; text-align: center; padding: 10px;">None</div>
              </div>
            </div>
          </div>

          <!-- Manual Unstaking Controls -->
          <div class="admin-card">
            <div class="card-title">üîì Manual Unstaking</div>

            <div class="margin-bottom-20">
              <label class="form-label">User Wallet Address</label>
              <input type="text" id="unstakeWalletAddress" class="form-input margin-bottom-10"
                placeholder="rWalletAddress...">
              <button type="button" onclick="loadUserStakes()" class="btn btn-secondary width-100">
                üîç Load User Stakes
              </button>
            </div>

            <div id="userStakesContainer" style="display: none;">
              <div class="form-group">
                <label class="form-label">Select Stake to Unstake</label>
                <select id="stakeSelector" class="form-input">
                  <option value="">Select a stake...</option>
                </select>
              </div>

              <div id="stakeDetails" class="stake-details">
                <div class="stake-detail-row">
                  <span>Amount:</span>
                  <span id="stakeAmount">-</span>
                </div>
                <div class="stake-detail-row">
                  <span>Duration:</span>
                  <span id="stakeDuration">-</span>
                </div>
                <div class="stake-detail-row">
                  <span>APY:</span>
                  <span id="stakeAPY">-</span>
                </div>
                <div class="stake-detail-row">
                  <span>Unlock Date:</span>
                  <span id="stakeUnlockDate">-</span>
                </div>
                <div class="stake-detail-row">
                  <span>Current Rewards:</span>
                  <span id="stakeRewards">-</span>
                </div>
                <div class="stake-detail-row">
                  <span>Status:</span>
                  <span id="stakeStatus">-</span>
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <input type="checkbox" id="forceUnstake" class="checkbox-margin">
                  Force Early Unstaking (15% penalty will apply)
                </label>
              </div>

              <div class="form-group">
                <label class="form-label">Admin Reason (Required)</label>
                <textarea id="unstakeReason" class="form-input" rows="3"
                  placeholder="Explain why manual unstaking is necessary..."></textarea>
              </div>

              <button type="button" onclick="executeManualUnstake()" class="btn btn-danger width-100">
                üîì Execute Manual Unstake
              </button>
            </div>

            <div id="unstakeResult" class="margin-top-15"></div>
          </div>
        </div>
      </div>

      <!-- Security Section -->
      <div id="security" class="admin-section">
        <div class="grid-2">
          <div class="admin-card">
            <div class="card-title">üõ°Ô∏è Security Monitoring</div>

            <div id="securityAlerts" class="loading">
              <div class="spinner"></div> Loading security data...
            </div>
          </div>

          <div class="admin-card">
            <div class="card-title">üö® Fraud Detection</div>

            <div class="form-group">
              <label class="form-label">Check Wallet</label>
              <input type="text" id="securityWallet" class="form-input" placeholder="Enter wallet address">
              <button type="button" class="btn margin-top-10" onclick="checkWalletSecurity()">üîç Check Security</button>
            </div>

            <div id="securityResults"></div>
          </div>
        </div>
      </div>

      <!-- DAO Section -->
      <div id="dao" class="admin-section">
        <div class="grid-2">
          <div class="admin-card">
            <div class="card-title">üó≥Ô∏è Create DAO Proposal</div>

            <form id="daoForm">
              <div class="form-group">
                <label class="form-label">Proposal Title</label>
                <input type="text" id="daoTitle" class="form-input" placeholder="Enter proposal title" required>
              </div>

              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="daoDescription" class="form-input form-textarea"
                  placeholder="Describe the proposal..."></textarea>
              </div>

              <div class="form-group">
                <label class="form-label">Options (comma-separated)</label>
                <input type="text" id="daoOptions" class="form-input" placeholder="Yes, No" required>
              </div>

              <div class="form-group">
                <label class="form-label">Duration (hours)</label>
                <input type="number" id="daoDuration" class="form-input" placeholder="72" min="1" required>
              </div>

              <button type="submit" class="btn">üì® Create Proposal</button>
            </form>
          </div>

          <div class="admin-card">
            <div class="card-title">üìã Active Proposals</div>

            <div id="daoProposals" class="loading">
              <div class="spinner"></div> Loading proposals...
            </div>
          </div>
        </div>
      </div>


      <!-- System Section -->
      <div id="system" class="admin-section">
        <div class="alert alert-error margin-bottom-20">
          üö® <strong>EMERGENCY SYSTEM CONTROLS</strong><br>
          These controls can affect the entire WALDOCOIN system. Use only in critical situations.
        </div>

        <div class="grid-2">
          <div class="admin-card">
            <div class="card-title">‚öôÔ∏è System Health Monitor</div>

            <div id="systemHealth" class="loading">
              <div class="spinner"></div> Checking system health...
            </div>
          </div>

          <div class="admin-card">
            <div class="card-title">üö® Emergency Controls</div>

            <div class="alert alert-warning alert-small">
              ‚ö†Ô∏è These actions affect all users and cannot be easily undone
            </div>

            <div class="emergency-controls">
              <button type="button" class="btn" onclick="refreshAllData()">üîÑ Force Data Refresh</button>
              <button type="button" class="btn btn-warning" onclick="clearCache()">üóëÔ∏è Emergency Cache Clear</button>
              <button type="button" class="btn btn-danger" onclick="emergencyStop()">üõë SYSTEM EMERGENCY STOP</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Trading Bot Section -->
      <div id="volumebot" class="admin-section">
        <div class="alert alert-info margin-bottom-20">
          ü§ñ <strong>TRADING BOT CONTROLS</strong><br>
          Manage the XRPL trading bot that generates real volume for WALDOCOIN.
        </div>

        <!-- Simple Bot Selector -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
          <label style="font-weight: bold; color: #fff;">Select Bot:</label>
          <select id="botSelector" onchange="switchBot(this.value)" style="padding: 8px 12px; background: #333; color: #fff; border: 1px solid #555; border-radius: 6px; cursor: pointer; font-size: 1em;">
            <option value="bot1">ü§ñ Bot 1 (Primary)</option>
            <option value="bot2" id="bot2Option" style="display: none;">ü§ñ Bot 2 (Secondary)</option>
          </select>
        </div>

        <!-- Bot Status -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìä Bot Status & Metrics</div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="botStatus">-</div>
              <div class="stat-label">Bot Status</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="botTrades">-</div>
              <div class="stat-label">Trades Today</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="botVolume">-</div>
              <div class="stat-label">24h Volume</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="activeBots">1 Bot</div>
              <div class="stat-label">Active Bots</div>
            </div>
          </div>

          <!-- Bot 1 Metrics -->
          <div style="background: #2a2a2a; padding: 15px; border-radius: 6px; margin-top: 15px; border-left: 4px solid #25c2a0;">
            <div style="font-size: 1.1em; color: #25c2a0; font-weight: bold; margin-bottom: 10px;">ü§ñ Bot 1 Metrics</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <div style="color: #999; font-size: 0.9em;">Wallet Balance:</div>
                <div style="color: #25c2a0; font-weight: bold;" id="bot1Balance">-</div>
              </div>
              <div>
                <div style="color: #999; font-size: 0.9em;">Trades:</div>
                <div style="color: #25c2a0; font-weight: bold;" id="bot1Trades">-</div>
              </div>
            </div>
          </div>

          <!-- Bot 2 Metrics -->
          <div style="background: #2a2a2a; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 4px solid #3498db;">
            <div style="font-size: 1.1em; color: #3498db; font-weight: bold; margin-bottom: 10px;">ü§ñ Bot 2 Metrics</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <div style="color: #999; font-size: 0.9em;">Wallet Balance:</div>
                <div style="color: #3498db; font-weight: bold;" id="bot2Balance">Not configured</div>
              </div>
              <div>
                <div style="color: #999; font-size: 0.9em;">Trades:</div>
                <div style="color: #3498db; font-weight: bold;" id="bot2Trades">-</div>
              </div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #25c2a0;">
              <div style="font-size: 0.9em; color: #ccc; margin-bottom: 5px;">üîë Trading Wallet 1:</div>
              <div style="font-family: monospace; color: #25c2a0; font-weight: bold; word-break: break-all; font-size: 0.85em;" id="tradingWalletAddress">Loading...</div>
            </div>
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #3498db;">
              <div style="font-size: 0.9em; color: #ccc; margin-bottom: 5px;">üîë Trading Wallet 2:</div>
              <div style="font-family: monospace; color: #3498db; font-weight: bold; word-break: break-all; font-size: 0.85em;" id="tradingWalletAddress2">Not configured</div>
            </div>
          </div>
          <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #f39c12; margin-top: 15px;">
            <div style="font-size: 0.9em; color: #ccc; margin-bottom: 5px;">üéõÔ∏è Current Trading Mode:</div>
            <div style="color: #f39c12; font-weight: bold; font-size: 1.1em;" id="currentTradingMode">Loading...</div>
          </div>
          <button onclick="loadTradingBotStatus()" class="btn btn-primary margin-top-15">üîÑ Refresh Status</button>
        </div>

        <!-- Bot 1 Controls Section -->
        <div id="bot1ControlsSection">
        <!-- Bot Controls -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üéõÔ∏è Bot 1 Trading Controls</div>

          <div class="form-group">
            <label class="form-label">Trading Frequency</label>
            <select id="tbTradingFrequency" class="form-control">
              <option value="5">Every 5 minutes</option>
              <option value="10">Every 10 minutes</option>
              <option value="15">Every 15 minutes</option>
              <option value="30" selected>Every 30 minutes</option>
              <option value="45">Every 45 minutes</option>
              <option value="60">Every 60 minutes</option>
              <option value="120">Every 2 hours</option>
              <option value="random">Random (5-45 min intervals)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Trading Mode</label>
            <select id="tbTradingMode" class="form-control">
              <option value="automated" selected>Automated Mode (Smart Emergency Detection)</option>
              <option value="buy_only">Buy Only Mode</option>
              <option value="buy_sell">Buy & Sell Mode</option>
              <option value="sell_only">Sell Only Mode</option>
            </select>
            <small class="help-text">Control what types of trades the bot executes</small>
          </div>



          <div class="form-group">
            <label class="form-label">Trade Size Range (XRP)</label>
            <div style="display: flex; gap: 10px;">
              <input type="number" id="tbMinTradeSize" class="form-control" placeholder="1" min="1" max="10" step="0.1">
              <span style="color: #ccc; align-self: center;">to</span>
              <input type="number" id="tbMaxTradeSize" class="form-control" placeholder="3" min="1" max="10" step="0.1">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Price Spread (%)</label>
            <input type="number" id="tbPriceSpread" class="form-control" placeholder="0" min="0" max="5" step="0.1">
            <small class="help-text">0% = No spread loss (recommended for longevity)</small>
          </div>

          <div class="form-group">
            <label class="form-label">Max Daily Volume (XRP)</label>
            <input type="number" id="tbMaxDailyVolume" class="form-control" placeholder="500" min="10" max="10000" step="10">
            <small class="help-text">Maximum trading volume per day</small>
          </div>

          <div class="button-group">
            <button onclick="updateTradingBotSettings()" class="btn btn-primary">üíæ Update Settings</button>
            <button onclick="pauseTradingBot()" class="btn btn-warning">‚è∏Ô∏è Pause Bot</button>
            <button onclick="resumeTradingBot()" class="btn btn-success">‚ñ∂Ô∏è Resume Bot</button>
            <button onclick="emergencyStopTradingBot()" class="btn btn-danger">üõë Emergency Stop</button>
          </div>

          <div id="botControlResult" class="margin-top-15"></div>
        </div>
        </div>
        <!-- End Bot 1 Controls Section -->

        <!-- Bot 2 Controls (Second Wallet) -->
        <div class="admin-card margin-bottom-30" id="bot2ControlsCard" style="display: none; border-left: 4px solid #3498db;">
          <div class="card-title">ü§ñ Bot 2 Controls (Second Wallet)</div>
          <div class="alert alert-info margin-bottom-20">
            Control the second trading wallet independently. This bot runs in parallel with Bot 1 to increase volume.
          </div>

          <div class="form-group">
            <label class="form-label">Bot 2 Status</label>
            <div style="padding: 10px; background: #2a2a2a; border-radius: 6px; color: #3498db;">
              <strong id="bot2StatusDisplay">Not configured</strong>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Bot 2 Enabled</label>
            <div style="display: flex; gap: 10px;">
              <button onclick="enableBot2()" class="btn btn-success" style="flex: 1;">‚úÖ Enable Bot 2</button>
              <button onclick="disableBot2()" class="btn btn-danger" style="flex: 1;">‚ùå Disable Bot 2</button>
            </div>
            <small class="help-text">Enable or disable the second trading wallet</small>
          </div>

          <div class="form-group">
            <label class="form-label">Bot 2 Trading Mode</label>
            <select id="tbBot2TradingMode" class="form-control">
              <option value="automated" selected>Automated Mode (Smart Emergency Detection)</option>
              <option value="buy_only">Buy Only Mode</option>
              <option value="buy_sell">Buy & Sell Mode</option>
              <option value="sell_only">Sell Only Mode</option>
            </select>
            <small class="help-text">Independent trading mode for Bot 2</small>
          </div>

          <div class="form-group">
            <label class="form-label">Bot 2 Trade Size Range (XRP)</label>
            <div style="display: flex; gap: 10px;">
              <input type="number" id="tbBot2MinTradeSize" class="form-control" placeholder="1" min="1" max="10" step="0.1">
              <span style="color: #ccc; align-self: center;">to</span>
              <input type="number" id="tbBot2MaxTradeSize" class="form-control" placeholder="3" min="1" max="10" step="0.1">
            </div>
          </div>

          <div class="button-group">
            <button onclick="updateBot2Settings()" class="btn btn-primary">üíæ Update Bot 2 Settings</button>
            <button onclick="pauseBot2()" class="btn btn-warning">‚è∏Ô∏è Pause Bot 2</button>
            <button onclick="resumeBot2()" class="btn btn-success">‚ñ∂Ô∏è Resume Bot 2</button>
          </div>

          <div id="bot2ControlResult" class="margin-top-15"></div>
        </div>

        <!-- Recent Trades -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üìà Recent Trades</div>
          <div id="tradingBotTradesList" style="max-height: 300px; overflow-y: auto;">
            Loading recent trades...
          </div>
          <button onclick="loadTradingBotTrades()" class="btn btn-secondary margin-top-15">üîÑ Refresh Trades</button>
        </div>

        <!-- Profit Tracking -->
        <div class="admin-card margin-bottom-30">
          <div class="card-title">üí∞ Profit Tracking</div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="tradingBotProfit">-</div>
              <div class="stat-label">Total Profit</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="tradingBotWLO">-</div>
              <div class="stat-label">WLO Holdings</div>
            </div>
          </div>
          <button onclick="resetTradingBotProfit()" class="btn btn-secondary margin-top-15">üîÑ Reset Profit Tracking</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Production Configuration
    const API_BASE = "https://waldocoin-backend-api.onrender.com";
    const ADMIN_WALLET = "rMFoici99gcnXMjKwzJWP2WGe9bK4E5iLL"; // WALDO distributor wallet (updated)
    let currentSection = 'dashboard';
    let isAuthenticated = false;

    // Debug mode for troubleshooting
    const DEBUG_MODE = true;

    // Enhanced error logging
    function logError(context, error, response = null) {
      if (DEBUG_MODE) {
        console.error(`‚ùå [${context}] Error:`, error);
        if (response) {
          console.error(`‚ùå [${context}] Response:`, response);
        }
      }
    }

    // Enhanced API call wrapper with better error handling and CORS fallback
    async function apiCall(endpoint, options = {}) {
      const defaultOptions = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'x-admin-key': localStorage.getItem('adminKey')
        }
      };

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...defaultOptions,
          ...options,
          headers: { ...defaultOptions.headers, ...options.headers }
        });

        if (DEBUG_MODE) {
          console.log(`üì° API Call: ${options.method || 'GET'} ${endpoint} ‚Üí ${response.status}`);
        }

        if (!response.ok) {
          const errorText = await response.text();
          logError(`API Call ${endpoint}`, `HTTP ${response.status}: ${errorText}`, response);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        // Check if it's a CORS error
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
          console.warn(`üö® CORS Error detected for ${endpoint}. This is likely due to accessing from file:// protocol.`);
          console.warn(`üí° Solution: Host the admin panel on a web server or use the live version.`);

          // Show user-friendly error
          showAlert(`CORS Error: Please host admin panel on a web server or use the live version at admin-vip-only-page.waldocoin.live`, 'error');
        }

        logError(`API Call ${endpoint}`, error);
        throw error;
      }
    }

    // Login Functions
    async function attemptLogin() {
      const password = document.getElementById('loginPassword').value.trim();
      const loginError = document.getElementById('loginError');

      if (!password) {
        showLoginError('Please enter a password');
        return;
      }

      try {
        // Debug: Log the password being sent
        if (DEBUG_MODE) {
          console.log('üîê Attempting login with password:', password);
          console.log('üîó API_BASE:', API_BASE);
        }

        // Use verify-admin endpoint for authentication
        const response = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          method: 'GET',
          headers: {
            'x-admin-key': password,
            'Content-Type': 'application/json'
          }
        });

        if (DEBUG_MODE) {
          console.log('üîê Response status:', response.status);
        }

        if (!response.ok) {
          const errorText = await response.text();
          if (DEBUG_MODE) {
            console.log('‚ùå Error response:', errorText);
          }
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        if (DEBUG_MODE) {
          console.log('üîê Login response:', data);
        }

        if (data.success) {
          // Admin authentication successful
          localStorage.setItem('adminKey', password);
          isAuthenticated = true;

          // Hide login screen and show admin panel
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('adminPanel').classList.remove('hidden');

          // Load dashboard by default
          showSection('dashboard', null);

          hideLoginError();

          // Show success message
          if (DEBUG_MODE) {
            console.log('‚úÖ Admin login successful!', data.message);
          }
          showAlert('Successfully logged in as admin', 'success');
        } else {
          showLoginError(`Invalid admin password. Error: ${data.error || 'Unknown error'}`);
          logError('Login', data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('‚ùå Login error:', error);

        if (error.message.includes('Failed to fetch')) {
          showLoginError(`CORS Error: Please access the admin panel from admin-vip-only-page.waldocoin.live instead of opening the file directly.`);
        } else {
          showLoginError(`Connection failed: ${error.message}. Check if backend is running.`);
        }

        logError('Login', error);
      }
    }

    function handleLoginKeypress(event) {
      if (event.key === 'Enter') {
        attemptLogin();
      }
    }

    // Comprehensive diagnostic function
    async function runDiagnostics() {
      const diagnosticsDiv = document.getElementById('diagnosticsResults') || createDiagnosticsDiv();
      diagnosticsDiv.innerHTML = '<h3>üîç Running Admin Panel Diagnostics...</h3>';

      const adminKey = localStorage.getItem('adminKey');
      const tests = [
        { name: 'Backend Health', endpoint: '/api/health', requiresAuth: false },
        { name: 'Admin Authentication', endpoint: '/api/airdrop/verify-admin', requiresAuth: true },
        { name: 'System Requirements', endpoint: '/api/system/waldo-requirements', requiresAuth: true },
        { name: 'Airdrop Config', endpoint: '/api/airdrop/config', requiresAuth: true },
        { name: 'Volume Bot Status', endpoint: '/api/admin/volume-bot/status', requiresAuth: true },
        { name: 'Rewards Bonuses', endpoint: '/api/rewards/active-bonuses', requiresAuth: true },
        { name: 'Battle System', endpoint: '/api/battle/current', requiresAuth: false },
        { name: 'Presale Analytics', endpoint: '/api/presale/analytics', requiresAuth: true }
      ];

      let results = '<div style="margin-top: 20px;">';

      for (const test of tests) {
        try {
          const headers = test.requiresAuth && adminKey ? { 'x-admin-key': adminKey } : {};
          const response = await fetch(`${API_BASE}${test.endpoint}`, { headers });

          if (response.ok) {
            const data = await response.json();
            results += `<div style="color: #25c2a0; margin: 5px 0;">‚úÖ ${test.name}: OK (${response.status})</div>`;
            if (DEBUG_MODE) {
              console.log(`‚úÖ ${test.name}:`, data);
            }
          } else {
            const errorText = await response.text();
            results += `<div style="color: #e74c3c; margin: 5px 0;">‚ùå ${test.name}: Failed (${response.status}) - ${errorText.substring(0, 100)}</div>`;
            if (DEBUG_MODE) {
              console.error(`‚ùå ${test.name}:`, errorText);
            }
          }
        } catch (error) {
          results += `<div style="color: #f39c12; margin: 5px 0;">‚ö†Ô∏è ${test.name}: Error - ${error.message}</div>`;
          if (DEBUG_MODE) {
            console.error(`‚ö†Ô∏è ${test.name}:`, error);
          }
        }
      }

      results += '</div>';
      diagnosticsDiv.innerHTML += results;
    }

    function createDiagnosticsDiv() {
      const div = document.createElement('div');
      div.id = 'diagnosticsResults';
      div.style.cssText = 'background: #222; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #333;';
      document.querySelector('.admin-content').appendChild(div);
      return div;
    }

    // üí∞ WALDO Requirements Control Functions
    async function loadWaldoRequirements() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/waldo-requirements`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const requirementsDiv = document.getElementById('currentWaldoRequirements');

        if (data.success) {
          const req = data.requirements;
          requirementsDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e74c3c;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Meme Rewards</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.memeRewards.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.memeRewards / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Battle Participation</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.battles.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.battles / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
              </div>
              <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">DAO Voting</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.daoVoting.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.daoVoting / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Exchange Rate</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.waldoPerXrp.toLocaleString()} WALDO/XRP</div>
                  <div style="color: #666; font-size: 0.9em;">1 XRP = ${req.waldoPerXrp} WALDO</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('minWaldoMemes').placeholder = req.memeRewards;
          document.getElementById('minWaldoBattles').placeholder = req.battles;
          document.getElementById('minWaldoDAO').placeholder = req.daoVoting;
          document.getElementById('waldoPerXrp').placeholder = req.waldoPerXrp;
        } else {
          requirementsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading requirements</div>';
        }
      } catch (error) {
        console.error('Error loading WALDO requirements:', error);
        document.getElementById('currentWaldoRequirements').innerHTML = '<div style="color: #e74c3c;">Error loading requirements</div>';
      }
    }

    async function updateWaldoRequirements() {
      const minWaldoMemes = parseInt(document.getElementById('minWaldoMemes').value);
      const minWaldoBattles = parseInt(document.getElementById('minWaldoBattles').value);
      const minWaldoDAO = parseInt(document.getElementById('minWaldoDAO').value);
      const waldoPerXrp = parseInt(document.getElementById('waldoPerXrp').value);
      const reason = document.getElementById('requirementChangeReason').value.trim();

      if (!minWaldoMemes && !minWaldoBattles && !minWaldoDAO && !waldoPerXrp) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      const resultDiv = document.getElementById('requirementResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üí∞ Updating WALDO requirements...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/update-waldo-requirements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            memeRewards: minWaldoMemes || undefined,
            battles: minWaldoBattles || undefined,
            daoVoting: minWaldoDAO || undefined,
            waldoPerXrp: waldoPerXrp || undefined,
            reason: reason || 'Admin requirement update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Requirements updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' ‚Ä¢ ')}
            </div>
          `;

          // Clear form
          document.getElementById('minWaldoMemes').value = '';
          document.getElementById('minWaldoBattles').value = '';
          document.getElementById('minWaldoDAO').value = '';
          document.getElementById('waldoPerXrp').value = '';
          document.getElementById('requirementChangeReason').value = '';

          // Refresh displays
          loadWaldoRequirements();
          loadRequirementHistory();
          showAlert('WALDO requirements updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update requirements: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update requirements error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error updating requirements</div>';
        showAlert('Network error updating requirements', 'error');
      }
    }

    async function resetWaldoRequirements() {
      const confirm = window.confirm('‚ö†Ô∏è Reset WALDO requirements to defaults?\n\n‚Ä¢ Meme Rewards: 6000 WALDO (6 XRP)\n‚Ä¢ Battles: 6000 WALDO (6 XRP)\n‚Ä¢ DAO Voting: 100 WALDO\n‚Ä¢ Rate: 1000 WALDO per XRP\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/reset-waldo-requirements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default requirements'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('requirementResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Requirements reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              6000 WALDO for memes/battles ‚Ä¢ 100 WALDO for DAO ‚Ä¢ 1000 WALDO/XRP
            </div>
          `;

          loadWaldoRequirements();
          loadRequirementHistory();
          showAlert('Requirements reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset requirements error:', error);
        showAlert('Network error resetting requirements', 'error');
      }
    }

    function setQuickRequirement(preset, memes, battles, dao) {
      let eventName, waldoPerXrp = 1000;

      switch (preset) {
        case 'launch':
          eventName = 'Launch Configuration';
          break;
        case 'growth':
          eventName = 'Growth Phase';
          break;
        case 'premium':
          eventName = 'Premium Access';
          break;
        case 'open':
          eventName = 'Open Access';
          break;
      }

      // Set the form values
      document.getElementById('minWaldoMemes').value = memes;
      document.getElementById('minWaldoBattles').value = battles;
      document.getElementById('minWaldoDAO').value = dao;
      document.getElementById('waldoPerXrp').value = waldoPerXrp;
      document.getElementById('requirementChangeReason').value = eventName;

      // Auto-update
      updateWaldoRequirements();
    }

    async function loadRequirementHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/requirement-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('requirementHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #e74c3c;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #e74c3c;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' ‚Ä¢ ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No requirement changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading requirement history:', error);
        document.getElementById('requirementHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    // ‚öôÔ∏è Airdrop Configuration Functions
    async function loadAirdropConfig() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/config`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const configDiv = document.getElementById('currentAirdropConfig');

        if (data.success) {
          const config = data.config;
          const endDate = new Date(config.endDate).toLocaleDateString();
          const daysRemaining = Math.ceil((new Date(config.endDate) - new Date()) / (1000 * 60 * 60 * 24));

          configDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #3498db;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #3498db; font-weight: bold;">Wallet Limit</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${config.claimed}/${config.maxWallets}</div>
                  <div style="color: #666; font-size: 0.9em;">${config.maxWallets - config.claimed} remaining</div>
                </div>
                <div>
                  <div style="color: #3498db; font-weight: bold;">Duration</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${daysRemaining} days left</div>
                  <div style="color: #666; font-size: 0.9em;">Ends: ${endDate}</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('maxWallets').placeholder = config.maxWallets;
          document.getElementById('airdropDays').placeholder = Math.ceil(config.durationDays);
        } else {
          configDiv.innerHTML = '<div style="color: #e74c3c;">Error loading configuration</div>';
        }
      } catch (error) {
        console.error('Error loading airdrop config:', error);
        document.getElementById('currentAirdropConfig').innerHTML = '<div style="color: #e74c3c;">Error loading configuration</div>';
      }
    }

    async function updateAirdropConfig() {
      const maxWallets = parseInt(document.getElementById('maxWallets').value);
      const airdropDays = parseInt(document.getElementById('airdropDays').value);
      const reason = document.getElementById('configChangeReason').value.trim();

      if (!maxWallets && !airdropDays) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      if (maxWallets && (maxWallets < 100 || maxWallets > 100000)) {
        showAlert('Wallet limit must be between 100 and 100,000', 'error');
        return;
      }

      if (airdropDays && (airdropDays < 1 || airdropDays > 365)) {
        showAlert('Duration must be between 1 and 365 days', 'error');
        return;
      }

      const resultDiv = document.getElementById('configResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">‚öôÔ∏è Updating airdrop configuration...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/update-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            maxWallets: maxWallets || undefined,
            durationDays: airdropDays || undefined,
            reason: reason || 'Admin configuration update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Configuration updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' ‚Ä¢ ')}
            </div>
          `;

          // Clear form
          document.getElementById('maxWallets').value = '';
          document.getElementById('airdropDays').value = '';
          document.getElementById('configChangeReason').value = '';

          // Refresh displays
          loadAirdropConfig();
          loadConfigHistory();
          showAlert('Airdrop configuration updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update configuration: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Config update error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error updating configuration</div>';
        showAlert('Network error updating configuration', 'error');
      }
    }

    async function resetToDefaults() {
      const confirm = window.confirm('‚ö†Ô∏è Reset airdrop configuration to defaults?\n\n‚Ä¢ 1000 wallet limit\n‚Ä¢ 5 day duration\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default configuration'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('configResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Configuration reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              1000 wallet limit ‚Ä¢ 5 day duration
            </div>
          `;

          loadAirdropConfig();
          loadConfigHistory();
          showAlert('Configuration reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset config error:', error);
        showAlert('Network error resetting configuration', 'error');
      }
    }

    function setQuickConfig(wallets, days, eventName) {
      // Set the form values
      document.getElementById('maxWallets').value = wallets;
      document.getElementById('airdropDays').value = days;
      document.getElementById('configChangeReason').value = eventName;

      // Auto-update
      updateAirdropConfig();
    }

    async function loadConfigHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/config-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('configHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #3498db;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #3498db;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' ‚Ä¢ ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No configuration changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading config history:', error);
        document.getElementById('configHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    // üéÅ Bonus Control System Functions
    async function setBonusMultiplier() {
      const bonusType = document.getElementById('bonusType').value;
      const multiplier = parseFloat(document.getElementById('bonusMultiplier').value);
      const duration = parseInt(document.getElementById('bonusDuration').value);
      const eventName = document.getElementById('bonusName').value.trim() || 'Admin Bonus';

      const resultDiv = document.getElementById('bonusResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üöÄ Setting bonus multiplier...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/set-bonus`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            type: bonusType,
            multiplier: multiplier,
            duration: duration,
            eventName: eventName
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Bonus activated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${eventName}: ${multiplier}x multiplier for ${bonusType} rewards
              ${duration > 0 ? `(expires in ${duration} hours)` : '(permanent)'}
            </div>
          `;

          // Refresh active bonuses display
          loadActiveBonuses();
          showAlert(`Bonus activated: ${eventName} (${multiplier}x)`, 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to set bonus: ${data.error}</div>`;
          showAlert(`Failed to set bonus: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Bonus error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error setting bonus</div>';
        showAlert('Network error setting bonus', 'error');
      }
    }

    async function clearAllBonuses() {
      const confirm = window.confirm('‚ö†Ô∏è Are you sure you want to clear ALL active bonuses?\n\nThis will revert all rewards back to base rates.');
      if (!confirm) return;

      const resultDiv = document.getElementById('bonusResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üóëÔ∏è Clearing all bonuses...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/clear-bonuses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ All bonuses cleared!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              All rewards reverted to base rates. ${data.clearedCount || 0} bonuses removed.
            </div>
          `;

          // Refresh active bonuses display
          loadActiveBonuses();
          showAlert('All bonuses cleared - back to base rates', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to clear bonuses: ${data.error}</div>`;
          showAlert(`Failed to clear bonuses: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear bonuses error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error clearing bonuses</div>';
        showAlert('Network error clearing bonuses', 'error');
      }
    }

    function setQuickBonus(preset, multiplier, duration) {
      let eventName, bonusType;

      switch (preset) {
        case 'weekend':
          eventName = 'Weekend Bonus';
          bonusType = 'all';
          break;
        case 'contest':
          eventName = 'Contest Event';
          bonusType = 'meme';
          break;
        case 'flash':
          eventName = 'Flash Bonus';
          bonusType = 'all';
          break;
        case 'launch':
          eventName = 'Launch Celebration';
          bonusType = 'all';
          break;
      }

      // Set the form values
      document.getElementById('bonusType').value = bonusType;
      document.getElementById('bonusMultiplier').value = multiplier.toString();
      document.getElementById('bonusDuration').value = duration.toString();
      document.getElementById('bonusName').value = eventName;

      // Activate the bonus
      setBonusMultiplier();
    }

    async function loadActiveBonuses() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/active-bonuses`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const bonusesDiv = document.getElementById('activeBonuses');

        if (data.success && data.bonuses && data.bonuses.length > 0) {
          let bonusesHtml = '';
          data.bonuses.forEach(bonus => {
            const expiresText = bonus.permanent ? 'Permanent' :
              `Expires: ${new Date(bonus.expiresAt).toLocaleString()}`;

            bonusesHtml += `
              <div style="background: #333; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #f39c12;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #f39c12;">${bonus.eventName}</strong>
                    <span style="color: #27ae60; margin-left: 10px;">${bonus.multiplier}x ${bonus.type} rewards</span>
                  </div>
                  <button onclick="removeBonus('${bonus.id}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                    Remove
                  </button>
                </div>
                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">${expiresText}</div>
              </div>
            `;
          });
          bonusesDiv.innerHTML = bonusesHtml;
        } else {
          bonusesDiv.innerHTML = '<div style="color: #666; font-style: italic;">No active bonuses - all rewards at base rates</div>';
        }
      } catch (error) {
        console.error('Error loading active bonuses:', error);
        document.getElementById('activeBonuses').innerHTML = '<div style="color: #e74c3c;">Error loading bonuses</div>';
      }
    }

    async function removeBonus(bonusId) {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/remove-bonus`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ bonusId: bonusId })
        });

        const data = await response.json();

        if (data.success) {
          loadActiveBonuses(); // Refresh the display
          showAlert('Bonus removed successfully', 'success');
        } else {
          showAlert(`Failed to remove bonus: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Remove bonus error:', error);
        showAlert('Network error removing bonus', 'error');
      }
    }

    // üì• Export Users as CSV
    async function exportUsersCSV() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üì• Exporting users to CSV...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success && data.users) {
          // Create CSV content
          const headers = [
            'Wallet Address', 'Username', 'Twitter Handle', 'XP Level', 'Total XP',
            'WALDO Balance', 'Last Active', 'Joined At', 'Battles Total', 'Battles Won',
            'Battle Votes', 'Staking Active', 'Total Staked', 'Staking Positions'
          ];

          let csvContent = headers.join(',') + '\n';

          data.users.forEach(user => {
            const row = [
              `"${user.walletAddress}"`,
              `"${user.username}"`,
              `"${user.twitterHandle || ''}"`,
              user.xpLevel,
              user.totalXP,
              user.waldoBalance,
              `"${user.lastActive}"`,
              `"${user.joinedAt}"`,
              user.battles.total,
              user.battles.won,
              user.battles.votes,
              user.staking.active,
              user.staking.totalStaked,
              user.staking.positions
            ];
            csvContent += row.join(',') + '\n';
          });

          // Download CSV
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ CSV exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during export</div>';
      }
    }

    // üì• Export Users as JSON
    async function exportUsersJSON() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üì• Exporting users to JSON...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Download JSON
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ JSON exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during export</div>';
      }
    }

    // üîÑ Reset Airdrop System
    async function resetAirdropSystem() {
      // Double confirmation for safety
      const firstConfirm = confirm(
        "‚ö†Ô∏è DANGER: This will reset the airdrop system!\n\n" +
        "‚Ä¢ Counter will reset to 0/1000\n" +
        "‚Ä¢ All claimed wallets will be cleared\n" +
        "‚Ä¢ Password override will be cleared\n\n" +
        "Are you sure you want to continue?"
      );

      if (!firstConfirm) return;

      const secondConfirm = confirm(
        "üö® FINAL WARNING!\n\n" +
        "This action CANNOT be undone!\n" +
        "All airdrop progress will be lost!\n\n" +
        "Type 'RESET' in the next dialog to confirm."
      );

      if (!secondConfirm) return;

      const typeConfirm = prompt("Type 'RESET' to confirm (case sensitive):");
      if (typeConfirm !== 'RESET') {
        showAlert('Reset cancelled - confirmation text did not match', 'warning');
        return;
      }

      const resultDiv = document.getElementById('resetResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üîÑ Resetting airdrop system...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Airdrop system reset successfully!</div>
            <div style="color: #ccc; margin-top: 10px; font-size: 0.9em;">
              ‚Ä¢ Counter: ${data.details.counter}<br>
              ‚Ä¢ Claimed wallets: ${data.details.claimedWallets}<br>
              ‚Ä¢ Password: ${data.details.passwordOverride}<br>
              ‚Ä¢ Total limit: ${data.details.totalLimit}
            </div>
          `;

          // Refresh airdrop status
          setTimeout(() => {
            loadAirdropData();
          }, 1000);

          showAlert('Airdrop system reset successfully! Ready for fresh launch.', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Reset failed: ${data.error}</div>`;
          showAlert(`Reset failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during reset</div>';
        showAlert('Network error during reset', 'error');
      }
    }

    function showLoginError(message) {
      const loginError = document.getElementById('loginError');
      loginError.textContent = message;
      loginError.classList.remove('hidden');
    }

    function hideLoginError() {
      const loginError = document.getElementById('loginError');
      loginError.classList.add('hidden');
    }

    function logout() {
      if (confirm('Are you sure you want to logout from the admin panel?')) {
        // Clear all stored authentication data
        localStorage.removeItem('adminKey');
        localStorage.removeItem('xummWallet'); // Clear any old wallet data
        sessionStorage.clear(); // Clear session data
        isAuthenticated = false;

        // Show login screen and hide admin panel
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');

        // Clear password field and any error messages
        document.getElementById('loginPassword').value = '';
        hideLoginError();

        // Clear any test results
        const testDiv = document.getElementById('connectionTest');
        if (testDiv) testDiv.innerHTML = '';

        console.log('Logged out successfully');
      }
    }

    // Check if user is already logged in on page load
    function checkExistingLogin() {
      const savedKey = localStorage.getItem('adminKey');
      if (savedKey) {
        // Auto-login with saved key
        document.getElementById('loginPassword').value = savedKey;
        attemptLogin();
      } else {
        // Show login screen by default
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
      }
    }

    // Test backend connection
    async function testConnection() {
      const testDiv = document.getElementById('connectionTest');
      testDiv.innerHTML = '<div style="color: #f39c12;">üîÑ Testing connection...</div>';

      // Test 1: Basic API connection
      try {
        const response1 = await fetch(`${API_BASE}/api/airdrop/status`);
        testDiv.innerHTML += `<div style="color: #666;">Status endpoint: ${response1.status}</div>`;

        if (response1.ok) {
          const data1 = await response1.json();
          if (data1.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Backend API: Connected</div>';
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">‚ùå Backend API: Error in response</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Backend API: HTTP ${response1.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Backend API: ${error.message}</div>`;
      }

      // Test 2: Try current-password endpoint
      try {
        const response2 = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Password endpoint: ${response2.status}</div>`;

        if (response2.ok) {
          const data2 = await response2.json();
          if (data2.success) {
            testDiv.innerHTML += `<div style="color: #27ae60;">‚úÖ Password 'waldogod2025': Works</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Current password: ${data2.currentPassword}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Source: ${data2.source}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password failed: ${data2.error}</div>`;
          }
        } else {
          const text = await response2.text();
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password endpoint: HTTP ${response2.status}</div>`;
          testDiv.innerHTML += `<div style="color: #666;">Response: ${text.substring(0, 100)}...</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password test: ${error.message}</div>`;
      }

      // Test 3: Try verify-admin endpoint
      try {
        const response3 = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Verify endpoint: ${response3.status}</div>`;

        if (response3.ok) {
          const data3 = await response3.json();
          if (data3.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Admin verification: Success</div>';
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Admin verification: ${data3.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Verify endpoint: HTTP ${response3.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Verify test: ${error.message}</div>`;
      }

      // Test 4: Debug environment variables
      try {
        const response4 = await fetch(`${API_BASE}/api/airdrop/debug-env`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });

        if (response4.ok) {
          const data4 = await response4.json();
          if (data4.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Environment debug: Success</div>';
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY set: ${data4.environment.X_ADMIN_KEY_SET}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY value: ${data4.environment.X_ADMIN_KEY_VALUE}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Environment debug: ${data4.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Debug endpoint: HTTP ${response4.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Debug test: ${error.message}</div>`;
      }

      // Test 5: Check available routes
      try {
        const response5 = await fetch(`${API_BASE}/api/routes`);

        if (response5.ok) {
          const routes = await response5.json();
          testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Available routes loaded</div>';

          const airdropRoutes = routes.filter(r => r.path && r.path.includes('airdrop'));
          if (airdropRoutes.length > 0) {
            testDiv.innerHTML += '<div style="color: #25c2a0;">Airdrop routes found:</div>';
            airdropRoutes.forEach(route => {
              testDiv.innerHTML += `<div style="color: #666; font-size: 0.9em;">${route.method} ${route.path}</div>`;
            });
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">‚ùå No airdrop routes found in backend</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Routes endpoint: HTTP ${response5.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Routes test: ${error.message}</div>`;
      }
    }

    // Authentication check - now uses password-based login
    function checkAdminAuth() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        // Show login screen instead of old modal
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
        return false;
      }
      isAuthenticated = true;
      updateAdminKeyStatus(); // Update admin key status on auth
      return true;
    }

    // Admin Key Management
    function saveAdminKey() {
      const adminKey = document.getElementById('adminKeyInput').value.trim();
      if (!adminKey) {
        showAlert('Please enter an admin key', 'error');
        return;
      }

      localStorage.setItem('adminKey', adminKey);
      document.getElementById('adminKeyInput').value = ''; // Clear input for security
      updateAdminKeyStatus();
      showAlert('Admin key saved successfully', 'success');

      // Auto-load current password when admin key is saved
      getCurrentAirdropPassword();
    }

    function clearAdminKey() {
      localStorage.removeItem('adminKey');
      updateAdminKeyStatus();
      showAlert('Admin key cleared', 'info');
    }

    function updateAdminKeyStatus() {
      const adminKey = localStorage.getItem('adminKey');
      const statusText = document.getElementById('keyStatusText');

      if (adminKey) {
        statusText.textContent = '‚úÖ Admin key stored and ready';
        statusText.className = 'text-success';
        statusText.style.color = '#27ae60';
      } else {
        statusText.textContent = '‚ùå No admin key stored';
        statusText.className = 'text-muted';
        statusText.style.color = '#e74c3c';
      }
    }

    async function testEnvironmentKeys() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Test current airdrop password (should be WALDOCREW or admin override)
        const response = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: {
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('envAdminKey').textContent = data.currentPassword;
          showAlert(`Environment test successful! Current airdrop password: ${data.currentPassword}`, 'success');
        } else {
          showAlert(`Environment test failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Environment test error:', error);
        showAlert('Failed to test environment keys', 'error');
      }
    }

    // Old authentication functions removed - now using password-based login screen

    // Navigation
    function showSection(sectionName, clickedElement = null) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionName).classList.add('active');

      // Add active class to clicked button (if provided)
      if (clickedElement) {
        clickedElement.classList.add('active');
      } else {
        // Fallback: find the nav button for this section
        const navBtn = document.querySelector(`[onclick*="${sectionName}"]`);
        if (navBtn) {
          navBtn.classList.add('active');
        }
      }

      currentSection = sectionName;

      // Load section data
      loadSectionData(sectionName);

      // Load active bonuses, airdrop config, WALDO requirements, fraud data, and meme limits if on dashboard
      if (sectionName === 'dashboard') {
        loadActiveBonuses();
        loadAirdropConfig();
        loadConfigHistory();
        loadWaldoRequirements();
        loadRequirementHistory();
        loadMemeLimits();
        loadMemeLimitHistory();
        loadFraudAnalytics();
        loadRecentViolations();
        loadSuspiciousActivity();
      }
    }

    // Duplicate apiCall function removed - using enhanced version above

    // Load data for specific section with error handling
    async function loadSectionData(section) {
      if (!checkAdminAuth()) return;


      async function loadBattleFees() {
        const adminKey = localStorage.getItem('adminKey');
        try {
          const res = await fetch(`${API_BASE}/api/config/public`);
          const data = await res.json();
          if (data && data.success && data.config && data.config.battle) {
            const b = data.config.battle;
            document.getElementById('battleUseDefaults').checked = !!b.useDefaults;
            document.getElementById('battleStartFee').value = Number(b.startFeeWLO || 0);
            document.getElementById('battleAcceptFee').value = Number(b.acceptFeeWLO || 0);
            document.getElementById('battleVoteFee').value = Number(b.voteFeeWLO || 0);
          }
        } catch (e) {
          console.warn('Failed to load battle fees:', e);
        }
      }
      async function saveBattleFees() {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) { showAlert('Enter admin key first', 'error'); return; }
        const useDefaults = document.getElementById('battleUseDefaults').checked;
        const startFeeWLO = Number(document.getElementById('battleStartFee').value);
        const acceptFeeWLO = Number(document.getElementById('battleAcceptFee').value);
        const voteFeeWLO = Number(document.getElementById('battleVoteFee').value);
        try {
          const res = await fetch(`${API_BASE}/api/config/battle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'x-admin-key': adminKey },
            body: JSON.stringify({ useDefaults, startFeeWLO, acceptFeeWLO, voteFeeWLO })
          });
          const data = await res.json();
          if (data.success) {
            document.getElementById('battleFeeSaveStatus').textContent = 'Saved';
            setTimeout(() => document.getElementById('battleFeeSaveStatus').textContent = '', 1500);
          } else {
            showAlert(data.error || 'Failed to save battle fees', 'error');
          }
        } catch (e) {
          showAlert('Failed to save battle fees: ' + e.message, 'error');
        }
      }

      try {
        switch (section) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'users':
            await loadUsersData();
            break;
          case 'airdrops':
            await loadAirdropsData();
            break;
          case 'battles':
            await loadBattlesData();
            break;
          case 'staking':
            await loadStakingData();
            break;
          case 'security':
            await loadSecurityData();
            break;
          case 'dao':
            await loadDAOData();
            break;
          case 'system':
            await loadSystemData();
            break;
          case 'volumebot':
            await loadVolumeBotData();
            break;
        }
      } catch (error) {
        showAlert(`Error loading ${section}: ${error.message}`, 'error');
      }
    }

    // Load trustline count independently with enhanced error handling
    async function loadTrustlineCount() {
      console.log('üîç Loading trustline count independently...');

      // Show loading state
      const totalUsersElement = document.getElementById('totalUsers');
      totalUsersElement.textContent = '...';
      totalUsersElement.style.color = '#ffd93d';

      try {
        console.log('üì° Making API call to /api/airdrop/trustline-count');
        // Add cache-busting parameter to force fresh data
        const trustlineData = await apiCall(`/api/airdrop/trustline-count?t=${Date.now()}`);
        console.log('‚úÖ Trustline data received:', trustlineData);

        if (trustlineData.success) {
          const count = trustlineData.trustlineCount || '0';
          const walletsWithBalance = trustlineData.walletsWithBalance || '0';
          const totalWaldo = trustlineData.totalWaldoHeld || '0';

          console.log('üìä Setting totalUsers to:', count);
          console.log('üí∞ Wallets with balance:', walletsWithBalance);
          console.log('ü™ô Total WALDO held:', totalWaldo);

          totalUsersElement.textContent = count;
          totalUsersElement.style.color = '#25c2a0';

          // Update tooltip or additional info if available
          totalUsersElement.title = `${count} trustlines total, ${walletsWithBalance} with balance, ${totalWaldo} WALDO held`;

          console.log('‚úÖ totalUsers element now shows:', totalUsersElement.textContent);
          showAlert(`‚úÖ Trustline count updated: ${count} trustlines found`, 'success');
        } else {
          console.log('‚ùå Trustline data not successful:', trustlineData);
          totalUsersElement.textContent = 'Error';
          totalUsersElement.style.color = '#e74c3c';
          showAlert('‚ùå Failed to load trustline count', 'error');
        }
      } catch (trustlineError) {
        console.error('‚ùå Trustline count failed:', trustlineError);
        totalUsersElement.textContent = 'Error';
        totalUsersElement.style.color = '#e74c3c';
        showAlert(`‚ùå Trustline count error: ${trustlineError.message}`, 'error');
      }
    }

    // Dashboard functions - Production Ready with full backend support
    async function loadDashboardData() {
      if (DEBUG_MODE) {
        console.log('üîÑ Loading dashboard data...');
      }

      // Load trustline count first, independently
      await loadTrustlineCount();

      try {

        // Load tokenomics stats for dashboard with error handling
        try {
          if (DEBUG_MODE) {
            console.log('üìä Loading tokenomics stats...');
          }
          const tokenomicsData = await apiCall('/api/tokenomics/stats');
          if (DEBUG_MODE) {
            console.log('üìä Tokenomics data received:', tokenomicsData);
          }
          if (tokenomicsData.success && tokenomicsData.stats) {
            const stats = tokenomicsData.stats;
            if (stats.airdrop) {
              const amount = stats.airdrop.totalDistributed;
              let formatted;
              if (amount >= 1000000) {
                formatted = (amount / 1000000).toFixed(1) + 'M';
              } else if (amount >= 1000) {
                formatted = (amount / 1000).toFixed(1) + 'K';
              } else {
                formatted = amount.toString();
              }
              document.getElementById('totalWaldoDistributed').textContent = formatted;
            }
            if (stats.battles) {
              document.getElementById('activeBattles').textContent = stats.battles.active || '0';
            }
            if (stats.staking) {
              document.getElementById('totalStaked').textContent = (stats.staking?.totalStaked / 1000 || 0).toFixed(1) + 'K';
            }
          } else {
            console.log('‚ö†Ô∏è Tokenomics data not available');
            document.getElementById('totalWaldoDistributed').textContent = 'Loading...';
            document.getElementById('activeBattles').textContent = 'Loading...';
            document.getElementById('totalStaked').textContent = 'Loading...';
          }
        } catch (tokenomicsError) {
          console.error('‚ùå Tokenomics endpoint error:', tokenomicsError);
          // Show loading instead of fake data
          document.getElementById('totalWaldoDistributed').textContent = 'Error';
          document.getElementById('activeBattles').textContent = 'Error';
          document.getElementById('totalStaked').textContent = 'Error';
        }

        // Load battle status for activity
        const battleData = await apiCall('/api/battle/current');
        const activityDiv = document.getElementById('recentActivity');

        let activityHtml = '';
        if (battleData.active) {
          activityHtml += `
            <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
              <div style="font-weight: bold; color: #25c2a0;">‚öîÔ∏è Battle #${battleData.battle.id} Active</div>
              <div style="font-size: 0.9em; opacity: 0.8;">${battleData.battle.totalVotes} total votes</div>
            </div>
          `;
        }

        // Load recent airdrop activity
        try {
          const airdropStatus = await apiCall('/api/airdrop/status');
          if (airdropStatus.success) {
            activityHtml += `
              <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
                <div style="font-weight: bold; color: #25c2a0;">üéÅ Airdrop Status</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${airdropStatus.airdrop.totalClaimed}/1000 claimed</div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('Could not load airdrop status');
        }

        if (!activityHtml) {
          activityHtml = '<div style="color: #666; text-align: center; padding: 20px;">No recent activity</div>';
        }
        activityDiv.innerHTML = activityHtml;

        // System health check
        const alertsDiv = document.getElementById('systemAlerts');
        const healthChecks = await performHealthChecks();
        alertsDiv.innerHTML = healthChecks;

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Error loading dashboard data: ' + error.message, 'error');

        // Show fallback data (but don't override trustline count)
        // document.getElementById('totalUsers').textContent = '-'; // Don't override trustline count
        document.getElementById('totalWaldoDistributed').textContent = '-';
        document.getElementById('activeBattles').textContent = '-';
        document.getElementById('totalStaked').textContent = '-';
      }
    }

    // Production health checks
    async function performHealthChecks() {
      let healthHtml = '';

      try {
        // Check API connectivity using airdrop status endpoint (no auth required)
        const response = await fetch(`${API_BASE}/api/airdrop/status`);
        const data = await response.json();

        if (data.success) {
          healthHtml += '<div class="alert alert-success">‚úÖ Backend API: Online</div>';
        } else {
          healthHtml += '<div class="alert alert-error">‚ùå Backend API: Offline</div>';
        }
      } catch (e) {
        console.error('Backend API health check failed:', e);
        healthHtml += '<div class="alert alert-error">‚ùå Backend API: Offline</div>';
      }

      try {
        // Check battle system (no auth required)
        const battleResponse = await fetch(`${API_BASE}/api/battle/current`);
        if (battleResponse.ok) {
          healthHtml += '<div class="alert alert-success">‚úÖ Battle System: Operational</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Battle System: Issues detected</div>';
        }
      } catch (e) {
        console.error('Battle system health check failed:', e);
        healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Battle System: Issues detected</div>';
      }

      try {
        // Check airdrop system (no auth required)
        const airdropResponse = await fetch(`${API_BASE}/api/airdrop/status`);
        const airdropData = await airdropResponse.json();

        if (airdropData.success && airdropData.airdrop.isActive) {
          healthHtml += '<div class="alert alert-success">‚úÖ Airdrop System: Active</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Airdrop System: Inactive</div>';
        }
      } catch (e) {
        console.error('Airdrop system health check failed:', e);
        healthHtml += '<div class="alert alert-error">‚ùå Airdrop System: Error</div>';
      }

      return healthHtml || '<div class="alert alert-warning">‚ö†Ô∏è Unable to perform health checks</div>';
    }

    // Utility functions
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      // Insert at top of current section
      const currentSectionEl = document.querySelector('.admin-section.active');
      currentSectionEl.insertBefore(alertDiv, currentSectionEl.firstChild);

      // Remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Users functions - Production Ready with full backend support
    async function loadUsersData() {
      try {
        // Get user list from backend (try admin-fixes first, fallback to original)
        let usersData;
        try {
          usersData = await apiCall('/api/admin-fixes/users/list?limit=50');
        } catch (error) {
          console.warn('Admin-fixes endpoint not available, trying original:', error.message);
          usersData = await apiCall('/api/users/list?limit=50');
        }
        const usersDiv = document.getElementById('usersList');
        let usersHtml = '';

        if (usersData.success && usersData.users.length > 0) {
          usersHtml = `
            <div style="margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                <div>
                  <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${usersData.summary.totalUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Total Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #27ae60; font-weight: bold;">${usersData.summary.activeUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Active Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${usersData.summary.stakingUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Staking</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${usersData.summary.blockedUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Blocked</div>
                </div>
              </div>
            </div>

            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #444; position: sticky; top: 0;">
                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #555;">User</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Level</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">WALDO</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Battles</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

          usersData.users.forEach(user => {
            const statusColor = user.security.isBlocked ? '#e74c3c' :
              user.security.isSuspicious ? '#f39c12' : '#27ae60';
            const statusText = user.security.isBlocked ? 'Blocked' :
              user.security.isSuspicious ? 'Suspicious' : 'Active';

            usersHtml += `
              <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 10px;">
                  <div style="font-weight: bold; color: #25c2a0;">${user.username}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.walletAddress.slice(0, 8)}...${user.walletAddress.slice(-6)}</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #25c2a0; font-weight: bold;">Level ${user.xpLevel}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.totalXP} XP</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ffd93d; font-weight: bold;">${user.waldoBalance.toFixed(1)}</div>
                  ${user.staking.active ? '<div style="font-size: 0.8em; color: #25c2a0;">+Staking</div>' : ''}
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ccc;">${user.battles.won}W / ${user.battles.total}T</div>
                  <div style="font-size: 0.8em; color: #666;">${user.battles.votes} votes</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.security.riskLevel}</div>
                </td>
              </tr>
            `;
          });

          usersHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          usersHtml = '<div style="color: #666; text-align: center; padding: 40px;">No users found</div>';
        }

        // Combine data from battle leaderboard (most active users)
        if (battleLeaderboard.status === 'fulfilled' && battleLeaderboard.value.leaderboard) {
          const users = battleLeaderboard.value.leaderboard.slice(0, 50); // Top 50 users

          usersHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Twitter</th>
                  <th>Battle Wins</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
            const isBlocked = securityData.status === 'fulfilled' &&
              securityData.value.blockedUsers?.includes(user.wallet);

            return `
                    <tr>
                      <td><code>${user.wallet.slice(0, 8)}...${user.wallet.slice(-6)}</code></td>
                      <td>${user.twitter ? `@${user.twitter}` : '-'}</td>
                      <td>${user.wins || 0}</td>
                      <td><span class="status-badge status-${isBlocked ? 'blocked' : 'active'}">${isBlocked ? 'BLOCKED' : 'ACTIVE'}</span></td>
                      <td>
                        <button type="button" class="btn" onclick="viewUser('${user.wallet}')">üëÅÔ∏è View</button>
                        <button type="button" class="btn ${isBlocked ? 'btn-warning' : 'btn-danger'}" onclick="${isBlocked ? 'unblockUser' : 'blockUser'}('${user.wallet}')">${isBlocked ? '‚úÖ Unblock' : 'üö´ Block'}</button>
                      </td>
                    </tr>
                  `;
          }).join('')}
              </tbody>
            </table>
          `;
        } else {
          usersHtml = '<div style="text-align: center; color: #666; padding: 40px;">No user data available</div>';
        }

        usersDiv.innerHTML = usersHtml;

      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 40px;">Error loading users: ' + error.message + '</div>';
      }
    }

    // Airdrops functions - Production Ready
    async function loadAirdropsData() {
      try {
        // Load airdrop status
        const airdropData = await apiCall('/api/airdrop/status');

        if (airdropData.success) {
          document.getElementById('airdropsClaimed').textContent = `${airdropData.airdrop.totalClaimed}/1000`;
          document.getElementById('airdropsRemaining').textContent = airdropData.airdrop.remaining;
        }

        // Load current password status
        await getCurrentAirdropPassword();

        // Load tokenomics for airdrop history
        const historyDiv = document.getElementById('airdropHistory');

        try {
          const tokenomicsData = await apiCall('/api/tokenomics/stats');

          if (tokenomicsData.success && tokenomicsData.stats && tokenomicsData.stats.airdrop) {
            const stats = tokenomicsData.stats;
            historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Airdrop Statistics</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="font-weight: bold; color: #fff;">${stats.airdrop.totalClaimed}</div>
                  <div style="color: #ccc; font-size: 0.9em;">Total Claims</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #fff;">${(stats.airdrop.totalDistributed / 1000000).toFixed(2)}M</div>
                  <div style="color: #ccc; font-size: 0.9em;">WALDO Distributed</div>
                </div>
              </div>
            </div>

            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üéØ System Status</h4>
              <div style="color: ${airdropData.airdrop.isActive ? '#27ae60' : '#e74c3c'};">
                ${airdropData.airdrop.isActive ? '‚úÖ Airdrop system is ACTIVE' : '‚ùå Airdrop system is INACTIVE'}
              </div>
              <div style="color: #ccc; margin-top: 5px;">
                ${airdropData.airdrop.remaining} airdrops remaining
              </div>
            </div>
          `;
          } else {
            // Fallback if tokenomics data is missing airdrop info
            historyDiv.innerHTML = `
              <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Airdrop Statistics</h4>
                <div style="color: #ccc;">
                  <div>‚úÖ Airdrop system is operational</div>
                  <div style="margin-top: 5px;">Data loading from multiple sources...</div>
                </div>
              </div>
            `;
          }
        } catch (tokenomicsError) {
          console.error('Error loading tokenomics data:', tokenomicsError);
          // Show fallback airdrop data
          historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Airdrop Statistics</h4>
              <div style="color: #ccc;">
                <div>‚úÖ Airdrop system is operational</div>
                <div style="margin-top: 5px;">Detailed stats temporarily unavailable</div>
              </div>
            </div>
          `;
        }

      } catch (error) {
        console.error('Error loading airdrops:', error);
        document.getElementById('airdropHistory').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading airdrop data: ' + error.message + '</div>';
      }
    }

    // Battle functions - Production Ready
    async function loadBattlesData() {
      try {
        const battle = await apiCall('/api/battle/current');

        const currentDiv = document.getElementById('currentBattle');
        if (battle.active) {
          currentDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <div style="font-weight: bold; color: #25c2a0;">Battle #${battle.id}</div>
              <div style="margin: 10px 0;">
                <div>Meme 1: ${battle.meme1.votes || 0} votes</div>
                <div>Meme 2: ${battle.meme2.votes || 0} votes</div>
              </div>
              <div style="color: #666;">Ends: ${new Date(battle.endTime).toLocaleString()}</div>
            </div>
          `;
        } else {
          currentDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active battle</div>';
        }

        // Load battle history
        const history = await apiCall('/api/battle/history?limit=10');

        const historyDiv = document.getElementById('battleHistory');
        if (history.battles && history.battles.length > 0) {
          historyDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Votes</th>
                  <th>Winner</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${history.battles.slice(0, 10).map(battle => `
                  <tr>
                    <td>#${battle.id}</td>
                    <td>${battle.totalVotes || 0}</td>
                    <td>${battle.winner || '-'}</td>
                    <td><span class="status-badge status-${battle.ended ? 'active' : 'flagged'}">${battle.ended ? 'ENDED' : 'ACTIVE'}</span></td>
                    <td>${new Date(battle.createdAt).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No battle history</div>';
        }
      } catch (error) {
        console.error('Error loading battles:', error);
      }
    }

    // Staking functions - Production Ready
    async function loadStakingData() {
      try {
        const data = await apiCall('/api/staking/positions?limit=100');

        // Organize stakes by status
        const activeStakes = [];
        const pendingStakes = [];
        const redeemedStakes = [];

        if (data.success && data.positions && data.positions.length > 0) {
          data.positions.forEach(pos => {
            if (pos.status === 'active' || pos.status === 'long_term') {
              activeStakes.push(pos);
            } else if (pos.status === 'pending_sig' || pos.status === 'pending') {
              pendingStakes.push(pos);
            } else if (pos.status === 'redeemed' || pos.status === 'completed') {
              redeemedStakes.push(pos);
            }
          });
        }

        // Calculate totals from filtered data
        const totalActive = activeStakes.length;
        const totalValue = activeStakes.reduce((sum, pos) => sum + parseFloat(pos.amount || 0), 0);
        const totalRewards = activeStakes.reduce((sum, pos) => sum + parseFloat(pos.currentRewards || 0), 0);

        if (data.success) {
          document.getElementById('totalStakingPositions').textContent = totalActive;
          document.getElementById('totalStakingValue').textContent = (totalValue / 1000).toFixed(1) + 'K';
          document.getElementById('totalStakingRewards').textContent = (totalRewards / 1000).toFixed(1) + 'K';
        }

        // Helper function to render table
        const renderStakesTable = (stakes) => {
          if (!stakes || stakes.length === 0) {
            return '<div style="color: #666; text-align: center; padding: 10px;">None</div>';
          }
          return `
            <table class="data-table" style="font-size: 0.85em;">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Amount</th>
                  <th>Duration</th>
                  <th>APY</th>
                  <th>Rewards</th>
                  <th>Unlock Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${stakes.map(pos => {
                  try {
                    const apy = parseFloat(pos.apy) || 0;
                    const apyDisplay = apy > 1 ? apy.toFixed(1) : (apy * 100).toFixed(1);
                    const amount = parseFloat(pos.amount) || 0;
                    const rewards = parseFloat(pos.currentRewards) || 0;
                    const unlockDate = new Date(pos.unlockDate);
                    return `
                      <tr>
                        <td><code>${pos.wallet.slice(0, 8)}...${pos.wallet.slice(-6)}</code></td>
                        <td>${amount.toFixed(2)}</td>
                        <td>${pos.duration}d</td>
                        <td>${apyDisplay}%</td>
                        <td>${rewards.toFixed(2)}</td>
                        <td>${unlockDate.toLocaleDateString()}</td>
                        <td><span class="status-badge ${pos.status}">${pos.status}</span></td>
                      </tr>
                    `;
                  } catch (e) {
                    console.error('Error rendering position:', pos, e);
                    return `<tr><td colspan="7" style="color: red;">Error rendering</td></tr>`;
                  }
                }).join('')}
              </tbody>
            </table>
          `;
        };

        // Update sections
        document.getElementById('activeStakesTable').innerHTML = renderStakesTable(activeStakes);
        document.getElementById('pendingStakesTable').innerHTML = renderStakesTable(pendingStakes);
        document.getElementById('redeemedStakesTable').innerHTML = renderStakesTable(redeemedStakes);

        // Hide the old combined table
        document.getElementById('stakingPositions').style.display = 'none';

      } catch (error) {
        console.error('Error loading staking data:', error);
        const positionsDiv = document.getElementById('stakingPositions');
        positionsDiv.innerHTML = `<div style="color: #d32f2f; padding: 20px;">‚ùå Error loading staking positions: ${error.message}</div>`;
      }
    }

    // Manual Unstaking Functions
    async function loadUserStakes() {
      const walletAddress = document.getElementById('unstakeWalletAddress').value.trim();

      if (!walletAddress || !walletAddress.startsWith('r')) {
        showAlert('Please enter a valid XRPL wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/positions/${walletAddress}`);
        const data = await res.json();

        if (data.success && data.positions && data.positions.length > 0) {
          const selector = document.getElementById('stakeSelector');
          selector.innerHTML = '<option value="">Select a stake...</option>';

          data.positions.forEach(stake => {
            const option = document.createElement('option');
            option.value = JSON.stringify(stake);
            option.textContent = `${stake.amount} WALDO (${stake.duration} days) - ${stake.status}`;
            selector.appendChild(option);
          });

          document.getElementById('userStakesContainer').style.display = 'block';
          showAlert(`Found ${data.positions.length} stake(s) for ${walletAddress}`, 'success');
        } else {
          document.getElementById('userStakesContainer').style.display = 'none';
          showAlert('No staking positions found for this wallet', 'error');
        }
      } catch (error) {
        console.error('Error loading user stakes:', error);
        showAlert('Error loading user stakes', 'error');
        document.getElementById('userStakesContainer').style.display = 'none';
      }
    }

    async function executeManualUnstake() {
      const stakeSelector = document.getElementById('stakeSelector');
      const reason = document.getElementById('unstakeReason').value.trim();
      const forceUnstake = document.getElementById('forceUnstake').checked;

      if (!stakeSelector.value) {
        showAlert('Please select a stake to unstake', 'error');
        return;
      }

      if (!reason) {
        showAlert('Please provide a reason for manual unstaking', 'error');
        return;
      }

      const stake = JSON.parse(stakeSelector.value);
      const isMatured = new Date() >= new Date(stake.unlockDate);

      // Confirmation dialog
      const confirmMessage = `üö® MANUAL UNSTAKING OVERRIDE

Wallet: ${stake.wallet}
Amount: ${stake.amount} WALDO
Current Rewards: ${(stake.currentRewards || 0).toFixed(2)} WALDO
Status: ${stake.status}
${!isMatured ? `\n‚ö†Ô∏è EARLY UNSTAKING: 15% penalty will apply` : ''}

Reason: ${reason}

This action cannot be undone. Continue?`;

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/unstake`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            wallet: stake.wallet,
            stakeId: stake.stakeId,
            force: forceUnstake || !isMatured,
            adminOverride: true,
            adminReason: reason,
            adminWallet: ADMIN_WALLET
          })
        });

        const data = await res.json();
        const resultDiv = document.getElementById('unstakeResult');

        if (data.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `
            ‚úÖ <strong>Manual Unstake Successful</strong><br>
            Stake ID: ${stake.stakeId}<br>
            Final Amount: ${data.finalAmount} WALDO<br>
            ${data.penalty > 0 ? `Penalty Applied: ${data.penalty} WALDO<br>` : ''}
            XUMM Transaction: ${data.uuid}<br>
            <small>User will receive XUMM notification to sign the transaction.</small>
          `;

          // Reset form
          document.getElementById('unstakeWalletAddress').value = '';
          document.getElementById('unstakeReason').value = '';
          document.getElementById('userStakesContainer').style.display = 'none';

          // Refresh staking data
          loadStakingData();

        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Unstaking Failed</strong><br>${data.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        console.error('Error executing manual unstake:', error);
        const resultDiv = document.getElementById('unstakeResult');
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Error</strong><br>Failed to execute manual unstake: ${error.message}`;
      }
    }

    // Security functions - Production Ready
    async function loadSecurityData() {
      try {
        const data = await apiCall('/api/security/overview');

        const alertsDiv = document.getElementById('securityAlerts');
        if (data.success) {
          let alertsHtml = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${data.overview.blockedUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Blocked Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${data.overview.suspiciousUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Suspicious Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${data.overview.flaggedTransactions}</div>
                <div style="font-size: 0.9em; color: #ccc;">Flagged Transactions</div>
              </div>
            </div>
          `;

          if (data.overview.recentEvents && data.overview.recentEvents.length > 0) {
            alertsHtml += '<h4 style="margin-bottom: 15px;">Recent Security Events</h4>';
            alertsHtml += '<div style="max-height: 200px; overflow-y: auto;">';

            data.overview.recentEvents.forEach(event => {
              const eventColor = event.type === 'user_blocked' ? '#e74c3c' :
                event.type === 'user_unblocked' ? '#27ae60' : '#f39c12';

              alertsHtml += `
                <div style="padding: 10px; margin-bottom: 8px; background: #333; border-radius: 5px; border-left: 3px solid ${eventColor};">
                  <div style="font-weight: bold; color: ${eventColor};">${event.type.replace('_', ' ').toUpperCase()}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Wallet: ${event.wallet}</div>
                  <div style="font-size: 0.8em; color: #666;">${new Date(event.timestamp).toLocaleString()}</div>
                </div>
              `;
            });

            alertsHtml += '</div>';
          } else {
            alertsHtml += '<div style="color: #666; text-align: center; padding: 20px;">No recent security events</div>';
          }

          alertsDiv.innerHTML = alertsHtml;
        } else {
          alertsDiv.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading security data</div>';
        }
      } catch (error) {
        console.error('Error loading security data:', error);
      }
    }

    async function checkWalletSecurity() {
      const wallet = document.getElementById('securityWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/security/check/${wallet}`);
        const data = await res.json();

        const resultsDiv = document.getElementById('securityResults');
        if (data.success) {
          resultsDiv.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">Security Report for ${wallet.slice(0, 8)}...${wallet.slice(-6)}</h4>
              <div><strong>Status:</strong> <span class="status-badge status-${data.status.toLowerCase()}">${data.status}</span></div>
              <div><strong>Violations:</strong> ${data.violationCount}</div>
              <div><strong>Blocked:</strong> ${data.isBlocked ? 'Yes' : 'No'}</div>
              <div><strong>Last Check:</strong> ${new Date().toLocaleString()}</div>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('securityResults').innerHTML = `<div class="alert alert-error">Network error checking wallet</div>`;
      }
    }

    // Manual security action functions
    async function blockUser() {
      const wallet = document.getElementById('blockWallet').value.trim();
      const reason = document.getElementById('blockReason').value.trim();
      const resultDiv = document.getElementById('blockResult');

      if (!wallet || !reason) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter both wallet address and reason';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Blocking user...';

        const response = await apiCall('/api/security/block', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `‚úÖ <strong>User Blocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason}`;

          // Clear form
          document.getElementById('blockWallet').value = '';
          document.getElementById('blockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Blocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function unblockUser() {
      const wallet = document.getElementById('unblockWallet').value.trim();
      const reason = document.getElementById('unblockReason').value.trim();
      const resultDiv = document.getElementById('unblockResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Unblocking user...';

        const response = await apiCall('/api/security/unblock', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason: reason || 'Admin unblock' })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `‚úÖ <strong>User Unblocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason || 'Admin unblock'}`;

          // Clear form
          document.getElementById('unblockWallet').value = '';
          document.getElementById('unblockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Unblocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function checkUserSecurity() {
      const wallet = document.getElementById('checkWallet').value.trim();
      const resultDiv = document.getElementById('securityCheckResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Checking security status...';

        const response = await apiCall(`/api/security/check/${wallet}`);

        if (response.success) {
          const security = response.security;
          const riskColor = security.riskLevel === 'HIGH' ? '#e74c3c' :
            security.riskLevel === 'MEDIUM' ? '#f39c12' : '#27ae60';

          resultDiv.className = 'info';
          resultDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-top: 10px;">
              <div style="font-weight: bold; color: #25c2a0; margin-bottom: 10px;">Security Report: ${wallet.slice(0, 8)}...${wallet.slice(-6)}</div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Status</div>
                  <div style="color: ${security.isBlocked ? '#e74c3c' : security.isSuspicious ? '#f39c12' : '#27ae60'}; font-weight: bold;">
                    ${security.isBlocked ? 'üö´ BLOCKED' : security.isSuspicious ? '‚ö†Ô∏è SUSPICIOUS' : '‚úÖ ACTIVE'}
                  </div>
                </div>
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Risk Level</div>
                  <div style="color: ${riskColor}; font-weight: bold;">${security.riskLevel} (${security.riskScore}/100)</div>
                </div>
              </div>

              ${security.blockReason ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Block Reason</div>
                  <div style="color: #e74c3c;">${security.blockReason}</div>
                </div>
              ` : ''}

              ${security.riskFactors.length > 0 ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Risk Factors</div>
                  <div style="color: #f39c12;">${security.riskFactors.join(', ')}</div>
                </div>
              ` : ''}

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                <div>
                  <div style="color: #666;">Battles</div>
                  <div style="color: #ccc;">${security.userData.totalBattles}</div>
                </div>
                <div>
                  <div style="color: #666;">Votes</div>
                  <div style="color: #ccc;">${security.userData.totalVotes}</div>
                </div>
                <div>
                  <div style="color: #666;">Last Active</div>
                  <div style="color: #ccc;">${security.userData.lastActive ? new Date(security.userData.lastActive).toLocaleDateString() : 'Never'}</div>
                </div>
              </div>
            </div>
          `;

          // Clear form
          document.getElementById('checkWallet').value = '';
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Security Check Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    // Initialize admin panel - Production Ready
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication first
      if (!checkAdminAuth()) {
        return; // Auth modal will be shown
      }

      // Show admin info
      const adminInfo = document.createElement('div');
      adminInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #333; padding: 10px; border-radius: 5px; font-size: 0.9em; z-index: 1000;';
      adminInfo.innerHTML = `
        <div style="color: #25c2a0;">üîê Admin: ${ADMIN_WALLET.slice(0, 8)}...${ADMIN_WALLET.slice(-6)}</div>
        <button onclick="logout()" style="background: #e74c3c; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Logout</button>
      `;
      document.body.appendChild(adminInfo);

      // Load initial data
      loadDashboardData();

      // Set up form handlers
      document.getElementById('airdropForm').addEventListener('submit', handleAirdropSubmit);
      document.getElementById('daoForm').addEventListener('submit', handleDAOSubmit);

      // Set up periodic refresh
      setInterval(() => {
        if (currentSection === 'dashboard') {
          loadDashboardData();
        }
      }, 30000); // Refresh every 30 seconds

      // Listen for wallet changes (logout detection)
      window.addEventListener('storage', (e) => {
        if (e.key === 'xummWallet' && e.newValue !== ADMIN_WALLET) {
          location.reload();
        }
      });
    });

    // Old logout function removed - using the password-based logout function instead

    // Force refresh password function - bypasses any caching issues
    async function forceRefreshPassword() {
      console.log('üîÑ Force refresh password called');
      showAlert('Refreshing password...', 'info');

      try {
        const url = `https://waldocoin-backend-api.onrender.com/api/airdrop/password-check?_t=${Date.now()}`;
        console.log('üì° Calling:', url);

        const response = await fetch(url, {
          method: 'GET',
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });

        console.log('üì° Response status:', response.status);
        const data = await response.json();
        console.log('üì° Response data:', data);

        if (data.success) {
          // Force update display
          document.getElementById('currentPasswordDisplay').textContent = data.currentPassword;
          document.getElementById('passwordSource').textContent = data.source;

          // Update color
          const passwordDisplay = document.getElementById('currentPasswordDisplay');
          if (data.source === 'Default fallback') {
            passwordDisplay.style.color = '#f39c12';
          } else {
            passwordDisplay.style.color = '#25c2a0';
          }

          showAlert(`‚úÖ Password refreshed: ${data.currentPassword}`, 'success');
        } else {
          showAlert('‚ùå Failed to refresh password', 'error');
        }
      } catch (error) {
        console.error('‚ùå Force refresh error:', error);
        showAlert('‚ùå Connection error', 'error');
      }
    }

    // Airdrop Password Management Functions
    async function getCurrentAirdropPassword() {
      try {
        console.log('üîç Loading current airdrop password...');

        // Use the public endpoint that doesn't require authentication (with cache busting)
        const response = await fetch(`${API_BASE}/api/airdrop/password-check?_t=${Date.now()}`, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        const data = await response.json();

        console.log('üì° Password API response:', data);

        if (data.success) {
          // Update the display elements
          const passwordDisplay = document.getElementById('currentPasswordDisplay');
          const passwordSource = document.getElementById('passwordSource');

          if (passwordDisplay && passwordSource) {
            passwordDisplay.textContent = data.currentPassword;
            passwordSource.textContent = data.source;

            // Show different colors based on source
            if (data.source === 'Default fallback') {
              passwordDisplay.style.color = '#f39c12'; // Orange for default
            } else {
              passwordDisplay.style.color = '#25c2a0'; // Green for custom password
            }

            console.log(`‚úÖ Password loaded: ${data.currentPassword} (${data.source})`);
          } else {
            console.error('‚ùå Could not find password display elements');
          }
        } else {
          console.error('‚ùå API returned error:', data.error);
          document.getElementById('currentPasswordDisplay').textContent = 'Error loading password';
          document.getElementById('passwordSource').textContent = data.error || 'Unknown error';
        }
      } catch (error) {
        console.error('‚ùå Get password error:', error);

        // Update display to show error
        const passwordDisplay = document.getElementById('currentPasswordDisplay');
        const passwordSource = document.getElementById('passwordSource');

        if (passwordDisplay && passwordSource) {
          passwordDisplay.textContent = 'Connection Error';
          passwordDisplay.style.color = '#e74c3c'; // Red for error
          passwordSource.textContent = 'Could not connect to server';
        }
      }
    }

    async function updateAirdropPassword() {
      console.log('üîê Password update function called');

      const adminKey = localStorage.getItem('adminKey');
      const newPassword = document.getElementById('newDailyPassword').value.trim();

      console.log('üìù Password update data:', {
        hasAdminKey: !!adminKey,
        newPassword: newPassword ? `${newPassword.slice(0, 3)}***` : 'empty',
        passwordLength: newPassword.length
      });

      if (!adminKey) {
        console.log('‚ùå No admin key found');
        showAlert('Please enter admin key in the authentication section first', 'error');
        return;
      }

      if (!newPassword || newPassword.length < 3) {
        console.log('‚ùå Invalid password:', { newPassword, length: newPassword.length });
        showAlert('Password must be at least 3 characters long', 'error');
        return;
      }

      try {
        console.log('üì° Making API call to update password...');

        const response = await fetch(`${API_BASE}/api/airdrop/update-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            password: newPassword
          })
        });

        console.log('üì° API response status:', response.status);
        const data = await response.json();
        console.log('üì° API response data:', data);

        if (data.success) {
          // Update result display
          document.getElementById('passwordUpdateResult').innerHTML = `
            <div style="color: #27ae60; padding: 10px;">
              ‚úÖ Password updated successfully to: <strong>${newPassword}</strong>
            </div>
          `;

          // Refresh current password display
          getCurrentAirdropPassword();

          // Clear input
          document.getElementById('newDailyPassword').value = '';

          showAlert(`Password updated successfully to: ${newPassword}`, 'success');
        } else {
          document.getElementById('passwordUpdateResult').innerHTML = `
            <div style="color: #e74c3c; padding: 10px;">
              ‚ùå Failed to update password: ${data.error}
            </div>
          `;
          showAlert(`Failed to update password: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update password error:', error);
        showAlert('Failed to update password', 'error');
      }
    }

    function setQuickAirdropPassword(password) {
      document.getElementById('newDailyPassword').value = password;
    }

    function generateRandomAirdropPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let password = 'WALDO';
      for (let i = 0; i < 4; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated random password: ${password}`, 'info');
    }

    function generateDailyPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let password = 'WALDO';
      for (let i = 0; i < 4; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated random password: ${password}`, 'info');
    }

    function generateDailyAirdropPassword() {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const password = `WALDO${month}${day}`;
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated today's password: ${password}`, 'info');
    }

    async function clearPasswordOverride() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Clear the Redis override by setting it to empty
        const response = await fetch(`${API_BASE}/api/airdrop/set-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            adminKey: adminKey,
            newPassword: '' // This will clear the Redis override
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Password override cleared. Now using default password (WALDOCREW)', 'success');
          getCurrentAirdropPassword(); // Refresh current password display
          document.getElementById('newDailyPassword').value = ''; // Clear input
        } else {
          showAlert(`Failed to clear override: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear override error:', error);
        showAlert('Failed to clear password override', 'error');
      }
    }

    // Form handlers - Production Ready
    async function handleAirdropSubmit(e) {
      e.preventDefault();
      console.log('üöÄ Admin airdrop function called');

      const wallet = document.getElementById('airdropWallet').value.trim();
      const amount = parseFloat(document.getElementById('airdropAmount').value);
      const reason = document.getElementById('airdropReason').value.trim() || 'Admin manual airdrop';

      console.log('üìù Form data:', { wallet, amount, reason });

      // Validation
      if (!wallet || !wallet.match(/^r[a-zA-Z0-9]{24,34}$/)) {
        console.log('‚ùå Wallet validation failed');
        alert('Please enter a valid XRPL wallet address');
        return;
      }

      if (!amount || amount <= 0 || amount > 1000000) {
        console.log('‚ùå Amount validation failed');
        alert('Amount must be between 1 and 1,000,000 WALDO');
        return;
      }

      // Confirm action
      if (!confirm(`Send ${amount} WALDO to ${wallet}?\n\nReason: ${reason}`)) {
        console.log('‚ùå User cancelled');
        return;
      }

      console.log('‚úÖ Starting airdrop request...');

      try {
        // Use the existing airdrop endpoint
        const data = await apiCall('/api/airdrop', {
          method: 'POST',
          body: JSON.stringify({
            wallet,
            amount,
            adminOverride: true,
            reason
          })
        });

        console.log('üì° API Response:', data);

        if (data.success) {
          console.log('‚úÖ Airdrop successful!');
          alert(`‚úÖ Airdrop sent successfully! Transaction: ${data.txHash || 'Pending'}`);
          document.getElementById('airdropForm').reset();
          loadAirdropsData();
        } else {
          console.log('‚ùå Airdrop failed:', data.error);
          alert(`‚ùå ${data.error || 'Failed to send airdrop'}`);
        }
      } catch (error) {
        console.log('‚ùå API Error:', error);
        console.log('‚ùå Error details:', error.message);

        // Show detailed error message
        const errorMsg = error.message || 'Unknown error occurred';
        alert(`‚ùå AIRDROP FAILED\n\nError: ${errorMsg}\n\nCheck console for details.`);

        // Also log to console for debugging
        console.error('Full error object:', error);
      }
    }

    async function handleDAOSubmit(e) {
      e.preventDefault();

      const title = document.getElementById('daoTitle').value.trim();
      const description = document.getElementById('daoDescription').value.trim();
      const options = document.getElementById('daoOptions').value.split(',').map(opt => opt.trim()).filter(Boolean);
      const duration = parseInt(document.getElementById('daoDuration').value);

      try {
        const res = await fetch(`${API_BASE}/api/dao/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, options, durationHours: duration })
        });

        const data = await res.json();

        if (data.success) {
          showAlert('DAO proposal created successfully!', 'success');
          document.getElementById('daoForm').reset();
          loadDAOData();
        } else {
          showAlert(data.error || 'Failed to create proposal', 'error');
        }
      } catch (error) {
        showAlert('Network error creating proposal', 'error');
      }
    }

    // DAO functions - Production Ready
    async function loadDAOData() {
      try {
        const data = await apiCall('/api/dao/proposals?limit=10');
        const daoDiv = document.getElementById('daoProposals');

        if (data.success && data.proposals.length > 0) {
          let daoHtml = `
            <div style="max-height: 400px; overflow-y: auto;">
          `;

          data.proposals.forEach(proposal => {
            const statusColor = proposal.status === 'active' ? '#25c2a0' :
              proposal.status === 'passed' ? '#27ae60' : '#e74c3c';
            const timeRemaining = proposal.timeRemaining > 0 ?
              Math.ceil(proposal.timeRemaining / (24 * 60 * 60 * 1000)) + ' days' : 'Expired';

            daoHtml += `
              <div style="padding: 15px; margin-bottom: 10px; background: #333; border-radius: 8px; border-left: 4px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div>
                    <div style="font-weight: bold; color: #25c2a0; margin-bottom: 5px;">${proposal.title}</div>
                    <div style="font-size: 0.9em; color: #ccc; margin-bottom: 8px;">${proposal.description.substring(0, 100)}${proposal.description.length > 100 ? '...' : ''}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: ${statusColor}; font-weight: bold; text-transform: uppercase;">${proposal.status}</div>
                    <div style="font-size: 0.8em; color: #666;">${timeRemaining}</div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; gap: 20px;">
                    <div style="color: #27ae60;">‚úì ${proposal.votes.yes} Yes</div>
                    <div style="color: #e74c3c;">‚úó ${proposal.votes.no} No</div>
                    <div style="color: #ccc;">Total: ${proposal.votes.total}</div>
                  </div>
                  <div style="font-size: 0.8em; color: #666;">
                    Support: ${(proposal.currentSupport * 100).toFixed(1)}% | Quorum: ${proposal.quorumMet ? '‚úì' : '‚úó'}
                  </div>
                </div>
              </div>
            `;
          });

          daoHtml += '</div>';
          daoDiv.innerHTML = daoHtml;
        } else {
          daoDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active DAO proposals</div>';
        }
      } catch (error) {
        console.error('Error loading DAO data:', error);
        document.getElementById('daoProposals').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading DAO proposals</div>';
      }
    }

    async function loadSystemData() {
      document.getElementById('systemHealth').innerHTML = `
        <div class="alert alert-success">‚úÖ Backend API: Online</div>
        <div class="alert alert-success">‚úÖ Database: Connected</div>
        <div class="alert alert-success">‚úÖ XRPL: Connected</div>
        <div class="alert alert-warning">‚ö†Ô∏è High memory usage: 78%</div>
      `;
    }

    // üîç Duplicate functions removed - using original implementations above

    // Duplicate exportUsersJSON and blockUser functions removed

    // Duplicate unblockUser and checkUserSecurity functions removed

    function viewUser(wallet) {
      // Set the wallet in the security check field and run the check
      document.getElementById('checkWallet').value = wallet;
      checkUserSecurity();
    }

    // Airdrop Password Management Functions


    // Battle Management Functions
    async function endCurrentBattle() {
      const confirm = window.confirm('‚ö†Ô∏è Force end the current battle?\n\nThis will immediately end the battle and trigger payouts.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/battle/force-end`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Battle ended successfully', 'success');
        } else {
          showAlert(`Failed to end battle: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('End battle error:', error);
        showAlert('Error ending battle', 'error');
      }
    }

    async function cancelCurrentBattle() {
      const confirm = window.confirm('‚ö†Ô∏è EMERGENCY CANCEL current battle?\n\nThis will cancel the battle and refund all participants. This action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/battle/emergency-cancel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Battle cancelled and participants refunded', 'success');
        } else {
          showAlert(`Failed to cancel battle: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Cancel battle error:', error);
        showAlert('Error cancelling battle', 'error');
      }
    }



    // System Functions
    async function refreshAllData() {
      showAlert('Refreshing all data...', 'info');
      try {
        // Reload current section data
        const currentSection = document.querySelector('.nav-btn.active').textContent.toLowerCase();
        if (currentSection.includes('dashboard')) {
          loadDashboardData();
          loadActiveBonuses();
          loadAirdropConfig();
          loadConfigHistory();
        }
        showAlert('Data refreshed successfully', 'success');
      } catch (error) {
        console.error('Refresh error:', error);
        showAlert('Error refreshing data', 'error');
      }
    }

    async function clearCache() {
      const confirm = window.confirm('‚ö†Ô∏è Clear all cached data?\n\nThis will clear Redis cache and force fresh data loading.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/clear-cache`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Cache cleared successfully', 'success');
        } else {
          showAlert(`Failed to clear cache: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear cache error:', error);
        showAlert('Error clearing cache', 'error');
      }
    }

    async function emergencyStop() {
      const confirm = window.confirm('üõë EMERGENCY SYSTEM STOP?\n\nThis will disable all user-facing functions:\n- Airdrop claims\n- Battle participation\n- Staking operations\n\nOnly use in critical situations!');
      if (!confirm) return;

      const doubleConfirm = window.confirm('‚ö†Ô∏è FINAL CONFIRMATION\n\nAre you absolutely sure you want to stop the system?\n\nThis will affect all users immediately.');
      if (!doubleConfirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/emergency-stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('üõë EMERGENCY STOP ACTIVATED - All user functions disabled', 'error');
        } else {
          showAlert(`Failed to activate emergency stop: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Emergency stop error:', error);
        showAlert('Error activating emergency stop', 'error');
      }
    }

    // Admin Key Management Functions




    // ü§ñ AI Fraud Detection Functions
    async function loadFraudAnalytics() {
      try {
        const adminKey = localStorage.getItem('adminKey');

        // Load both fraud analytics and AI stats
        const [fraudResponse, aiResponse] = await Promise.all([
          fetch(`${API_BASE}/api/security/fraud-analytics`, {
            headers: { 'x-admin-key': adminKey }
          }),
          fetch(`${API_BASE}/api/security/ai-stats`, {
            headers: { 'x-admin-key': adminKey }
          })
        ]);

        const fraudData = await fraudResponse.json();
        const aiData = await aiResponse.json();
        const analyticsDiv = document.getElementById('fraudAnalytics');

        if (fraudData.success && aiData.success) {
          const stats = fraudData.analytics;
          const aiStats = aiData.aiStats;

          analyticsDiv.innerHTML = `
            <div style="margin-bottom: 20px;">
              <h4 style="color: #9b59b6; margin-bottom: 15px;">üõ°Ô∏è Fraud Prevention Stats</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e74c3c;">
                  <div style="color: #e74c3c; font-weight: bold;">Total Violations</div>
                  <div style="color: #fff; font-size: 1.5em;">${stats.totalViolations || 0}</div>
                  <div style="color: #666; font-size: 0.9em;">Last 24 hours</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #f39c12;">
                  <div style="color: #f39c12; font-weight: bold;">Blocked Wallets</div>
                  <div style="color: #fff; font-size: 1.5em;">${stats.blockedWallets || 0}</div>
                  <div style="color: #666; font-size: 0.9em;">Currently blocked</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #9b59b6;">
                  <div style="color: #9b59b6; font-weight: bold;">Bot Detections</div>
                  <div style="color: #fff; font-size: 1.5em;">${stats.botDetections || 0}</div>
                  <div style="color: #666; font-size: 0.9em;">AI-detected bots</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60;">
                  <div style="color: #27ae60; font-weight: bold;">Clean Requests</div>
                  <div style="color: #fff; font-size: 1.5em;">${stats.cleanRequests || 0}</div>
                  <div style="color: #666; font-size: 0.9em;">Legitimate traffic</div>
                </div>
              </div>
            </div>

            <div>
              <h4 style="color: #25c2a0; margin-bottom: 15px;">ü§ñ AI Content Verification</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #25c2a0;">
                  <div style="color: #25c2a0; font-weight: bold;">Total Verifications</div>
                  <div style="color: #fff; font-size: 1.5em;">${aiStats.totalVerifications || 0}</div>
                  <div style="color: #666; font-size: 0.9em;">Content checked</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60;">
                  <div style="color: #27ae60; font-weight: bold;">Pass Rate</div>
                  <div style="color: #fff; font-size: 1.5em;">${aiStats.passRate || '0%'}</div>
                  <div style="color: #666; font-size: 0.9em;">Content approved</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #3498db;">
                  <div style="color: #3498db; font-weight: bold;">Avg Confidence</div>
                  <div style="color: #fff; font-size: 1.5em;">${aiStats.averageConfidence || 0}%</div>
                  <div style="color: #666; font-size: 0.9em;">AI certainty</div>
                </div>
                <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #f1c40f;">
                  <div style="color: #f1c40f; font-weight: bold;">Method</div>
                  <div style="color: #fff; font-size: 1.2em;">${aiStats.verificationMethod || 'NONE'}</div>
                  <div style="color: #666; font-size: 0.9em;">
                    ${aiStats.verificationMethod === 'FREE' ?
              `üí∞ Saving $${aiStats.monthlyCostSavings}/mo` :
              'Premium AI active'
            }
                  </div>
                </div>
              </div>
            </div>
          `;
        } else {
          analyticsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading fraud analytics or AI stats</div>';
        }
      } catch (error) {
        console.error('Error loading fraud analytics:', error);
        document.getElementById('fraudAnalytics').innerHTML = '<div style="color: #e74c3c;">Error loading analytics</div>';
      }
    }

    async function loadRecentViolations() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        // Try admin-fixes endpoint first
        let response;
        try {
          response = await fetch(`${API_BASE}/api/admin-fixes/security/recent-violations?limit=20`, {
            headers: { 'x-admin-key': adminKey }
          });
        } catch (error) {
          response = await fetch(`${API_BASE}/api/security/recent-violations?limit=20`, {
            headers: { 'x-admin-key': adminKey }
          });
        }

        const data = await response.json();
        const violationsDiv = document.getElementById('recentViolations');

        if (data.success && data.violations && data.violations.length > 0) {
          let violationsHtml = '';
          data.violations.forEach(violation => {
            const time = new Date(violation.timestamp).toLocaleString();
            const severityColor = violation.reason.includes('BOT') ? '#e74c3c' :
              violation.reason.includes('SUSPICIOUS') ? '#f39c12' : '#95a5a6';

            violationsHtml += `
              <div style="background: #2a2a2a; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${severityColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: ${severityColor};">${violation.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">Wallet: ${violation.wallet}</div>
                    ${violation.meta ? `<div style="color: #666; font-size: 0.8em;">${JSON.stringify(violation.meta).substring(0, 100)}...</div>` : ''}
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${time}</div>
                </div>
              </div>
            `;
          });
          violationsDiv.innerHTML = violationsHtml;
        } else {
          violationsDiv.innerHTML = '<div style="color: #27ae60; font-style: italic;">No recent violations - system is clean! üéâ</div>';
        }
      } catch (error) {
        console.error('Error loading violations:', error);
        document.getElementById('recentViolations').innerHTML = '<div style="color: #e74c3c;">Error loading violations</div>';
      }
    }

    async function loadSuspiciousActivity() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/suspicious-activity?limit=15`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const activityDiv = document.getElementById('suspiciousActivity');

        if (data.success && data.activity && data.activity.length > 0) {
          let activityHtml = '';
          data.activity.forEach(activity => {
            const time = new Date(activity.timestamp).toLocaleString();
            const riskColor = activity.riskScore >= 80 ? '#e74c3c' :
              activity.riskScore >= 60 ? '#f39c12' : '#3498db';

            activityHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${riskColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: ${riskColor};">Risk Score: ${activity.riskScore}/100</strong>
                    <div style="color: #ccc; font-size: 0.9em;">Wallet: ${activity.wallet}</div>
                    <div style="color: #666; font-size: 0.8em;">${activity.patterns.join(', ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${time}</div>
                </div>
              </div>
            `;
          });
          activityDiv.innerHTML = activityHtml;
        } else {
          activityDiv.innerHTML = '<div style="color: #27ae60; font-style: italic;">No suspicious activity detected! üõ°Ô∏è</div>';
        }
      } catch (error) {
        console.error('Error loading suspicious activity:', error);
        document.getElementById('suspiciousActivity').innerHTML = '<div style="color: #e74c3c;">Error loading activity</div>';
      }
    }

    function refreshFraudData() {
      showAlert('Refreshing fraud detection data...', 'info');
      loadFraudAnalytics();
      loadRecentViolations();
      loadSuspiciousActivity();
      showAlert('Fraud data refreshed successfully', 'success');
    }

    async function exportViolations() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/export-violations`, {
          headers: { 'x-admin-key': adminKey }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `fraud-violations-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          showAlert('Violations exported successfully', 'success');
        } else {
          showAlert('Failed to export violations', 'error');
        }
      } catch (error) {
        console.error('Export violations error:', error);
        showAlert('Error exporting violations', 'error');
      }
    }

    async function clearOldViolations() {
      const confirm = window.confirm('‚ö†Ô∏è Clear old violation data?\n\nThis will remove violations older than 30 days. Recent violations will be kept for security monitoring.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/clear-old-violations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert(`Cleared ${data.clearedCount || 0} old violation records`, 'success');
          refreshFraudData();
        } else {
          showAlert(`Failed to clear violations: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear violations error:', error);
        showAlert('Error clearing old violations', 'error');
      }
    }

    function adjustSensitivity() {
      showAlert('üéõÔ∏è Fraud detection sensitivity adjustment coming soon! Current settings are optimized for launch.', 'info');
    }

    // üé≠ Daily Meme Limits Control Functions
    async function loadMemeLimits() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-limits`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const limitsDiv = document.getElementById('currentMemeLimits');

        if (data.success) {
          const limits = data.limits;
          limitsDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e67e22;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Standard Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.daily} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">Default limit</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Premium Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.premium} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">10K+ WALDO holders</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">VIP Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.vip} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">50K+ WALDO holders</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Reset Time</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.resetHour}:00 UTC</div>
                  <div style="color: #666; font-size: 0.9em;">Daily reset</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('dailyMemeLimit').placeholder = limits.daily;
          document.getElementById('premiumMemeLimit').placeholder = limits.premium;
          document.getElementById('vipMemeLimit').placeholder = limits.vip;
          document.getElementById('resetHour').placeholder = limits.resetHour;
        } else {
          limitsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading meme limits</div>';
        }
      } catch (error) {
        console.error('Error loading meme limits:', error);
        document.getElementById('currentMemeLimits').innerHTML = '<div style="color: #e74c3c;">Error loading limits</div>';
      }
    }

    async function updateMemeLimits() {
      const dailyLimit = parseInt(document.getElementById('dailyMemeLimit').value);
      const premiumLimit = parseInt(document.getElementById('premiumMemeLimit').value);
      const vipLimit = parseInt(document.getElementById('vipMemeLimit').value);
      const resetHour = parseInt(document.getElementById('resetHour').value);
      const reason = document.getElementById('memeLimitChangeReason').value.trim();

      if (!dailyLimit && !premiumLimit && !vipLimit && !resetHour && resetHour !== 0) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      const resultDiv = document.getElementById('memeLimitResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üé≠ Updating meme limits...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/update-meme-limits`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            daily: dailyLimit || undefined,
            premium: premiumLimit || undefined,
            vip: vipLimit || undefined,
            resetHour: resetHour !== undefined ? resetHour : undefined,
            reason: reason || 'Admin meme limit update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Meme limits updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' ‚Ä¢ ')}
            </div>
          `;

          // Clear form
          document.getElementById('dailyMemeLimit').value = '';
          document.getElementById('premiumMemeLimit').value = '';
          document.getElementById('vipMemeLimit').value = '';
          document.getElementById('resetHour').value = '';
          document.getElementById('memeLimitChangeReason').value = '';

          // Refresh displays
          loadMemeLimits();
          loadMemeLimitHistory();
          showAlert('Meme limits updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update limits: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update meme limits error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error updating limits</div>';
        showAlert('Network error updating meme limits', 'error');
      }
    }

    async function resetMemeLimits() {
      const confirm = window.confirm('‚ö†Ô∏è Reset meme limits to defaults?\n\n‚Ä¢ Standard: 10 memes/day\n‚Ä¢ Premium: 25 memes/day (10K+ WALDO)\n‚Ä¢ VIP: 50 memes/day (50K+ WALDO)\n‚Ä¢ Reset: 0:00 UTC\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/reset-meme-limits`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default meme limits'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('memeLimitResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Meme limits reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              Standard: 10 ‚Ä¢ Premium: 25 ‚Ä¢ VIP: 50 ‚Ä¢ Reset: 0:00 UTC
            </div>
          `;

          loadMemeLimits();
          loadMemeLimitHistory();
          showAlert('Meme limits reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset meme limits error:', error);
        showAlert('Network error resetting meme limits', 'error');
      }
    }

    function setQuickMemeLimit(preset, daily, premium, vip) {
      let eventName;

      switch (preset) {
        case 'strict':
          eventName = 'Strict Quality Control';
          break;
        case 'balanced':
          eventName = 'Balanced Limits';
          break;
        case 'generous':
          eventName = 'Generous Allowance';
          break;
        case 'unlimited':
          eventName = 'Unlimited Mode';
          break;
      }

      // Set the form values
      document.getElementById('dailyMemeLimit').value = daily;
      document.getElementById('premiumMemeLimit').value = premium;
      document.getElementById('vipMemeLimit').value = vip;
      document.getElementById('resetHour').value = 0; // Default to midnight
      document.getElementById('memeLimitChangeReason').value = eventName;

      // Auto-update
      updateMemeLimits();
    }

    async function loadMemeLimitHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-limit-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('memeLimitHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #e67e22;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: #e67e22;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' ‚Ä¢ ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No limit changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading meme limit history:', error);
        document.getElementById('memeLimitHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    async function lookupUserMemeUsage() {
      const wallet = document.getElementById('lookupWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'warning');
        return;
      }

      const resultDiv = document.getElementById('memeUsageResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üîç Looking up meme usage...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/user-meme-usage/${wallet}`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const usage = data.usage;
          const tierInfo = usage.waldoBalance >= 50000 ? 'VIP' :
            usage.waldoBalance >= 10000 ? 'Premium' : 'Standard';
          const tierColor = usage.waldoBalance >= 50000 ? '#9b59b6' :
            usage.waldoBalance >= 10000 ? '#f39c12' : '#3498db';

          resultDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid ${tierColor}; margin-top: 10px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: ${tierColor}; font-weight: bold;">Today's Usage</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${usage.todayCount}/${usage.dailyLimit} memes</div>
                  <div style="color: #666; font-size: 0.9em;">Remaining: ${usage.dailyLimit - usage.todayCount}</div>
                </div>
                <div>
                  <div style="color: ${tierColor}; font-weight: bold;">User Tier</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${tierInfo}</div>
                  <div style="color: #666; font-size: 0.9em;">${usage.waldoBalance.toLocaleString()} WALDO</div>
                </div>
              </div>
              <div style="margin-top: 10px; color: #ccc; font-size: 0.9em;">
                Last reset: ${new Date(usage.lastReset).toLocaleString()} ‚Ä¢
                Next reset: ${new Date(usage.nextReset).toLocaleString()}
              </div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Lookup meme usage error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Error looking up usage</div>';
      }
    }

    async function viewMemeUsage() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-usage-stats`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const stats = data.stats;
          showAlert(`üìä Meme Usage Stats:\n\n‚Ä¢ Total users today: ${stats.totalUsers}\n‚Ä¢ Average memes per user: ${stats.avgMemesPerUser}\n‚Ä¢ Users at limit: ${stats.usersAtLimit}\n‚Ä¢ Total memes today: ${stats.totalMemes}`, 'info');
        } else {
          showAlert(`Failed to get usage stats: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('View meme usage error:', error);
        showAlert('Error getting meme usage stats', 'error');
      }
    }





    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function () {
      if (checkAdminAuth()) {
        loadSectionData('dashboard');
      }

      // Initialize stake selector event listener
      const stakeSelector = document.getElementById('stakeSelector');
      if (stakeSelector) {
        stakeSelector.addEventListener('change', function () {
          const stakeDetails = document.getElementById('stakeDetails');

          if (this.value) {
            const stake = JSON.parse(this.value);
            const unlockDate = new Date(stake.unlockDate).toLocaleDateString();
            const isMatured = new Date() >= new Date(stake.unlockDate);

            document.getElementById('stakeAmount').textContent = `${stake.amount} WALDO`;
            document.getElementById('stakeDuration').textContent = `${stake.duration} days`;
            document.getElementById('stakeAPY').textContent = `${(stake.apy * 100).toFixed(1)}%`;
            document.getElementById('stakeUnlockDate').textContent = unlockDate;
            document.getElementById('stakeRewards').textContent = `${(stake.currentRewards || 0).toFixed(2)} WALDO`;
            document.getElementById('stakeStatus').textContent = stake.status;

            // Show/hide force unstake option based on maturity
            const forceCheckbox = document.getElementById('forceUnstake');
            if (isMatured) {
              forceCheckbox.checked = false;
              forceCheckbox.disabled = true;
              forceCheckbox.parentElement.style.opacity = '0.5';
            } else {
              forceCheckbox.disabled = false;
              forceCheckbox.parentElement.style.opacity = '1';
            }

            stakeDetails.style.display = 'block';
          } else {
            stakeDetails.style.display = 'none';
          }
        });
      }
    });

    // Claimed Wallets Export Functions
    async function exportClaimedWallets() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Preparing CSV export...', 'info');

        // Create a temporary link to download the CSV
        const link = document.createElement('a');
        link.href = `${API_BASE}/api/airdrop/export-claimed`;
        link.style.display = 'none';

        // Set headers for the request
        const response = await fetch(`${API_BASE}/api/airdrop/export-claimed`, {
          method: 'GET',
          headers: {
            'x-admin-key': adminKey
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          link.href = url;
          link.download = `waldo-airdrop-claimed-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);

          showAlert('‚úÖ CSV file downloaded successfully!', 'success');
          updateClaimedWalletsInfo(); // Refresh the info
        } else {
          throw new Error('Export failed');
        }
      } catch (error) {
        console.error('Export error:', error);
        showAlert('‚ùå Failed to export CSV', 'error');
      }
    }

    async function viewClaimedWallets() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading claimed wallets...', 'info');

        // Try admin-fixes endpoint first
        let response;
        try {
          response = await fetch(`${API_BASE}/api/admin-fixes/airdrop/claimed-list`, {
            method: 'GET',
            headers: {
              'x-admin-key': adminKey
            }
          });
        } catch (error) {
          response = await fetch(`${API_BASE}/api/airdrop/claimed-list`, {
            method: 'GET',
            headers: {
              'x-admin-key': adminKey
            }
          });
        }

        const data = await response.json();

        if (data.success) {
          displayClaimedWalletsList(data);
          showAlert(`‚úÖ Loaded ${data.totalWallets} claimed wallets`, 'success');
        } else {
          throw new Error(data.error || 'Failed to load wallets');
        }
      } catch (error) {
        console.error('View wallets error:', error);
        showAlert('‚ùå Failed to load claimed wallets', 'error');
      }
    }

    function displayClaimedWalletsList(data) {
      const container = document.getElementById('walletsTableContainer');
      const listDiv = document.getElementById('claimedWalletsList');

      let html = `
        <div style="margin-bottom: 10px; color: #25c2a0; font-weight: bold;">
          üìä Total: ${data.totalWallets} wallets | Manual: ${data.manualWallets || 0} | Regular: ${data.regularWallets || 0}
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <thead>
            <tr style="background: #333; color: white;">
              <th style="padding: 8px; border: 1px solid #555; text-align: left;">#</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: left;">Wallet Address</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Type</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Amount</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.wallets.forEach((wallet, index) => {
        const isManual = wallet.claimType === 'Manual Airdrop';
        const typeColor = isManual ? '#ff6b6b' : '#25c2a0';
        const typeIcon = isManual ? 'üéØ' : 'üéÅ';

        html += `
          <tr style="background: ${index % 2 === 0 ? '#222' : '#333'};">
            <td style="padding: 6px; border: 1px solid #555; color: #ccc;">${wallet.claimOrder}</td>
            <td style="padding: 6px; border: 1px solid #555; color: #25c2a0; font-family: monospace;">${wallet.wallet}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${typeColor};">${typeIcon} ${wallet.claimType}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: #ffd93d;">${parseInt(wallet.amount).toLocaleString()}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: #0f0;">‚úÖ ${wallet.status}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top: 10px; font-size: 11px; color: #666;">
          Exported at: ${new Date(data.exportedAt).toLocaleString()}
        </div>
      `;

      container.innerHTML = html;
      listDiv.style.display = 'block';

      // Update info display
      updateClaimedWalletsInfo(data);
    }

    async function updateClaimedWalletsInfo(data = null) {
      if (!data) {
        // Fetch fresh data
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) return;

        try {
          const response = await fetch(`${API_BASE}/api/airdrop/claimed-list`, {
            method: 'GET',
            headers: { 'x-admin-key': adminKey }
          });
          data = await response.json();
        } catch (error) {
          console.error('Failed to update claimed wallets info:', error);
          return;
        }
      }

      if (data && data.success) {
        document.getElementById('totalClaimedCount').textContent = data.totalWallets;
        document.getElementById('manualCount').textContent = data.manualWallets || 0;
        document.getElementById('regularCount').textContent = data.regularWallets || 0;
        document.getElementById('remainingCount').textContent = (1000 - data.totalWallets);
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
      }
    }

    async function addMissingWallet() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const walletAddress = document.getElementById('missingWalletAddress').value.trim();
      const reason = document.getElementById('missingWalletReason').value.trim();

      if (!walletAddress) {
        showAlert('Please enter wallet address', 'error');
        return;
      }

      if (!walletAddress.startsWith('r') || walletAddress.length < 25) {
        showAlert('Invalid wallet address format', 'error');
        return;
      }

      try {
        showAlert('Adding wallet to tracking...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/add-missing-wallet`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            wallet: walletAddress,
            reason: reason || 'Added via admin panel'
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ Wallet added to tracking! Total tracked: ${data.totalTracked}`, 'success');

          // Clear inputs
          document.getElementById('missingWalletAddress').value = '';
          document.getElementById('missingWalletReason').value = '';

          // Refresh the claimed wallets list
          updateClaimedWalletsInfo();

          // If the list is currently visible, refresh it
          const listDiv = document.getElementById('claimedWalletsList');
          if (listDiv.style.display !== 'none') {
            viewClaimedWallets();
          }
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Add missing wallet error:', error);
        showAlert('‚ùå Failed to add wallet to tracking', 'error');
      }
    }

    // Airdrop Amount Management Functions
    async function getCurrentAirdropAmount() {
      try {
        const response = await fetch(`${API_BASE}/api/airdrop/get-amount`);
        const data = await response.json();

        if (data.success) {
          const amount = parseFloat(data.amount).toLocaleString();
          document.getElementById('currentAirdropAmount').textContent = `${amount} WALDO`;
          console.log(`‚úÖ Current airdrop amount: ${amount} WALDO`);
        } else {
          document.getElementById('currentAirdropAmount').textContent = '50,000 WALDO (default)';
        }
      } catch (error) {
        console.error('Failed to get current airdrop amount:', error);
        document.getElementById('currentAirdropAmount').textContent = '50,000 WALDO (default)';
      }
    }

    async function updateAirdropAmount() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const newAmount = document.getElementById('newAirdropAmount').value.trim();

      if (!newAmount || isNaN(newAmount) || newAmount <= 0 || newAmount > 1000000) {
        showAlert('Please enter a valid amount between 1 and 1,000,000', 'error');
        return;
      }

      try {
        showAlert('Updating airdrop amount...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/set-amount`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            amount: parseFloat(newAmount)
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ Airdrop amount updated to ${parseFloat(data.newAmount).toLocaleString()} WALDO!`, 'success');

          // Clear input
          document.getElementById('newAirdropAmount').value = '';

          // Refresh current amount display
          getCurrentAirdropAmount();
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Update airdrop amount error:', error);
        showAlert('‚ùå Failed to update airdrop amount', 'error');
      }
    }

    // System Health & Security Functions
    let emergencyStopActive = false;

    async function refreshSystemHealth() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Checking system health...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/system-health`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update system status
          const statusElement = document.getElementById('systemStatus');
          const balanceElement = document.getElementById('distributorBalance');
          const responseTimesElement = document.getElementById('responseTimes');
          const emergencyBtn = document.getElementById('emergencyStopBtn');

          // System status with color coding
          const statusColor = data.overallStatus === 'healthy' ? '#25c2a0' :
            data.overallStatus === 'degraded' ? '#ffd93d' : '#e74c3c';
          statusElement.style.color = statusColor;
          statusElement.textContent = `${data.overallStatus.toUpperCase()} (${data.responseTime}ms)`;

          // Distributor balance with color coding
          const balanceStatus = data.services.distributorWallet.status;
          const balanceColor = balanceStatus === 'healthy' ? '#25c2a0' :
            balanceStatus === 'warning' ? '#ffd93d' : '#e74c3c';
          balanceElement.style.color = balanceColor;
          balanceElement.textContent = `${data.services.distributorWallet.balanceFormatted} WALDO`;

          // Response times
          responseTimesElement.textContent =
            `Redis: ${data.services.redis.responseTime}ms, XRPL: ${data.services.xrpl.responseTime}ms`;

          // Emergency stop button
          emergencyStopActive = data.airdropSystem.emergencyStop;
          if (emergencyStopActive) {
            emergencyBtn.textContent = '‚úÖ Resume Airdrops';
            emergencyBtn.className = 'btn btn-success';
            showAlert(`üö® Emergency stop is ACTIVE: ${data.airdropSystem.emergencyReason}`, 'warning');
          } else {
            emergencyBtn.textContent = 'üö® Emergency Stop';
            emergencyBtn.className = 'btn btn-danger';
          }

          showAlert('‚úÖ System health updated', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('System health check error:', error);
        showAlert('‚ùå Failed to check system health', 'error');
      }
    }

    async function toggleEmergencyStop() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const action = emergencyStopActive ? 'emergency-resume' : 'emergency-stop';
      const reason = prompt(emergencyStopActive ?
        'Enter reason for resuming airdrops:' :
        'Enter reason for emergency stop:'
      );

      if (!reason) return;

      try {
        showAlert(emergencyStopActive ? 'Resuming airdrops...' : 'Activating emergency stop...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/${action}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ reason: reason })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ ${data.message}`, 'success');
          emergencyStopActive = !emergencyStopActive;

          // Update button
          const emergencyBtn = document.getElementById('emergencyStopBtn');
          if (emergencyStopActive) {
            emergencyBtn.textContent = '‚úÖ Resume Airdrops';
            emergencyBtn.className = 'btn btn-success';
          } else {
            emergencyBtn.textContent = 'üö® Emergency Stop';
            emergencyBtn.className = 'btn btn-danger';
          }
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Emergency stop toggle error:', error);
        showAlert('‚ùå Failed to toggle emergency stop', 'error');
      }
    }

    async function loadAdminLogs() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading admin logs...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/admin-logs`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const logsList = document.getElementById('adminLogsList');

          if (data.logs.length === 0) {
            logsList.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No admin activity logs found</div>';
          } else {
            let logsHTML = '<div style="font-size: 12px;">';

            data.logs.forEach(log => {
              const timestamp = new Date(log.timestamp).toLocaleString();
              const actionColor = log.action === 'EMERGENCY_STOP' ? '#e74c3c' :
                log.action === 'EMERGENCY_RESUME' ? '#25c2a0' : '#ffd93d';

              logsHTML += `
                <div style="border-bottom: 1px solid #333; padding: 8px 0; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: ${actionColor}; font-weight: bold;">${log.action}</span>
                    <span style="color: #666; font-size: 10px;">${timestamp}</span>
                  </div>
                  <div style="color: #ccc; font-size: 11px; margin-top: 4px;">
                    IP: ${log.adminIP} | ${JSON.stringify(log.details)}
                  </div>
                </div>
              `;
            });

            logsHTML += '</div>';
            logsList.innerHTML = logsHTML;
          }

          showAlert(`‚úÖ Loaded ${data.logs.length} admin logs`, 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Load admin logs error:', error);
        showAlert('‚ùå Failed to load admin logs', 'error');
      }
    }

    function toggleLogsView() {
      const container = document.getElementById('adminLogsContainer');
      if (container.style.display === 'none') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // Failed Transactions Management
    async function loadFailedTransactions() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading failed transactions...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/failed-transactions`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const failedTxList = document.getElementById('failedTxList');

          if (data.failedTransactions.length === 0) {
            failedTxList.innerHTML = '<div style="color: #25c2a0; text-align: center; padding: 20px;">‚úÖ No failed transactions found!</div>';
          } else {
            let txHTML = '<div style="font-size: 12px;">';

            data.failedTransactions.forEach(tx => {
              const timestamp = new Date(tx.timestamp).toLocaleString();
              const canRetry = parseInt(tx.retryCount) < 3;

              txHTML += `
                <div style="border-bottom: 1px solid #333; padding: 8px 0; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #ffd93d; font-weight: bold;">${tx.wallet.slice(0, 8)}...${tx.wallet.slice(-6)}</span>
                    <span style="color: #666; font-size: 10px;">${timestamp}</span>
                  </div>
                  <div style="color: #ccc; font-size: 11px; margin-top: 4px;">
                    Amount: ${parseFloat(tx.amount).toLocaleString()} WALDO | Error: ${tx.error} | Retries: ${tx.retryCount}/3
                  </div>
                  ${canRetry ? `
                    <button onclick="retryTransaction('${tx.id}')" style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 4px; cursor: pointer;">
                      üîÑ Retry
                    </button>
                  ` : '<span style="color: #e74c3c; font-size: 10px;">Max retries reached</span>'}
                </div>
              `;
            });

            txHTML += '</div>';
            failedTxList.innerHTML = txHTML;
          }

          // Update failed TX count
          document.getElementById('failedTxCount').textContent = data.failedTransactions.length;

          showAlert(`‚úÖ Loaded ${data.failedTransactions.length} failed transactions`, 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Load failed transactions error:', error);
        showAlert('‚ùå Failed to load failed transactions', 'error');
      }
    }

    async function retryTransaction(transactionId) {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Retrying transaction...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/retry-transaction`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ transactionId: transactionId })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ Transaction retry successful! TX: ${data.txHash}`, 'success');
          // Reload failed transactions to update the list
          loadFailedTransactions();
        } else {
          showAlert(`‚ùå Retry failed: ${data.error}`, 'error');
          if (data.canRetry) {
            showAlert(`Retry count: ${data.retryCount}/3`, 'info');
          }
        }

      } catch (error) {
        console.error('Retry transaction error:', error);
        showAlert('‚ùå Failed to retry transaction', 'error');
      }
    }

    function toggleFailedTxView() {
      const container = document.getElementById('failedTxContainer');
      if (container.style.display === 'none') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    // Bulk Wallet Operations
    async function performBulkOperation() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const operation = document.getElementById('bulkOperation').value;
      const reason = document.getElementById('bulkReason').value.trim();
      const walletsText = document.getElementById('bulkWallets').value.trim();

      if (!walletsText) {
        showAlert('Please enter wallet addresses', 'error');
        return;
      }

      if (!reason) {
        showAlert('Please enter a reason for this operation', 'error');
        return;
      }

      // Parse wallets (one per line)
      const wallets = walletsText.split('\n')
        .map(w => w.trim())
        .filter(w => w.length > 0);

      if (wallets.length === 0) {
        showAlert('No valid wallet addresses found', 'error');
        return;
      }

      try {
        showAlert(`Performing ${operation} on ${wallets.length} wallets...`, 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/bulk-wallet-operation`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            operation: operation,
            wallets: wallets,
            reason: reason
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ Bulk operation completed! Success: ${data.successCount}, Errors: ${data.errorCount}`, 'success');

          // Show detailed results
          const resultsDiv = document.getElementById('bulkResults');
          let resultsHTML = `
            <div style="margin-bottom: 10px;">
              <strong>Operation: ${operation.toUpperCase()}</strong><br>
              <span style="color: #25c2a0;">‚úÖ Success: ${data.successCount}</span> |
              <span style="color: #e74c3c;">‚ùå Errors: ${data.errorCount}</span>
            </div>
          `;

          if (data.errorCount > 0) {
            resultsHTML += '<div style="font-size: 12px; max-height: 200px; overflow-y: auto;">';
            data.results.forEach(result => {
              if (!result.success) {
                resultsHTML += `<div style="color: #e74c3c; margin-bottom: 4px;">${result.wallet}: ${result.error}</div>`;
              }
            });
            resultsHTML += '</div>';
          }

          resultsDiv.innerHTML = resultsHTML;
          resultsDiv.style.display = 'block';

          // Clear form
          document.getElementById('bulkWallets').value = '';
          document.getElementById('bulkReason').value = '';

        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Bulk operation error:', error);
        showAlert('‚ùå Failed to perform bulk operation', 'error');
      }
    }

    // Enhanced Analytics Functions
    async function loadEnhancedAnalytics() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading enhanced analytics...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/analytics`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update dashboard elements
          document.getElementById('recentActivity').textContent = `${data.activity.recentClaims24h} claims`;
          document.getElementById('totalDistributed').textContent = data.overview.totalDistributedFormatted;
          document.getElementById('walletStats').textContent = `B:${data.walletManagement.blacklistedWallets} W:${data.walletManagement.whitelistedWallets}`;
          document.getElementById('successRate').textContent = `${data.overview.successRate}%`;
          document.getElementById('failedTxCount').textContent = data.activity.failedTransactions;

          // Show detailed analytics
          const analyticsDiv = document.getElementById('analyticsDetails');
          let analyticsHTML = `
            <div class="grid-3" style="margin-bottom: 15px;">
              <div>
                <strong>Distribution Overview</strong><br>
                <span style="color: #25c2a0;">Total Claims: ${data.overview.totalClaims}</span><br>
                <span style="color: #ffd93d;">Remaining: ${data.overview.remainingClaims}</span><br>
                <span style="color: #25c2a0;">Per Claim: ${data.overview.currentAmountPerClaim.toLocaleString()}</span>
              </div>
              <div>
                <strong>Wallet Management</strong><br>
                <span style="color: #25c2a0;">Regular: ${data.walletManagement.regularClaims}</span><br>
                <span style="color: #ffd93d;">Manual: ${data.walletManagement.manualAirdrops}</span><br>
                <span style="color: #e74c3c;">Blacklisted: ${data.walletManagement.blacklistedWallets}</span>
              </div>
              <div>
                <strong>System Status</strong><br>
                <span style="color: ${data.system.emergencyStop ? '#e74c3c' : '#25c2a0'};">
                  Emergency: ${data.system.emergencyStop ? 'ACTIVE' : 'Normal'}
                </span><br>
                <span style="color: #25c2a0;">Balance: ${data.overview.distributorBalance}</span><br>
                <span style="color: #25c2a0;">Success Rate: ${data.overview.successRate}%</span>
              </div>
            </div>
          `;

          if (data.system.emergencyStop) {
            analyticsHTML += `<div style="background: #e74c3c; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
              üö® Emergency Stop Active: ${data.system.emergencyReason}
            </div>`;
          }

          analyticsDiv.innerHTML = analyticsHTML;
          analyticsDiv.style.display = 'block';

          showAlert('‚úÖ Enhanced analytics loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Enhanced analytics error:', error);
        showAlert('‚ùå Failed to load enhanced analytics', 'error');
      }
    }

    async function loadUserBehavior() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading user behavior analytics...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/user-behavior`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const analyticsDiv = document.getElementById('analyticsDetails');
          let behaviorHTML = `
            <div style="margin-bottom: 15px;">
              <strong>üåê IP Analytics</strong><br>
              <span style="color: #25c2a0;">Total Unique IPs: ${data.ipAnalytics.totalUniqueIPs}</span><br>
              <span style="color: ${data.ipAnalytics.suspiciousIPs.length > 0 ? '#e74c3c' : '#25c2a0'};">
                Suspicious IPs: ${data.ipAnalytics.suspiciousIPs.length}
              </span>
            </div>
          `;

          if (data.ipAnalytics.topIPs.length > 0) {
            behaviorHTML += '<div style="margin-bottom: 15px;"><strong>Top IPs by Attempts:</strong><br>';
            data.ipAnalytics.topIPs.slice(0, 5).forEach(ip => {
              const color = ip.suspicious ? '#e74c3c' : '#25c2a0';
              behaviorHTML += `<span style="color: ${color}; font-size: 12px;">${ip.ip}: ${ip.attempts} attempts${ip.suspicious ? ' (SUSPICIOUS)' : ''}</span><br>`;
            });
            behaviorHTML += '</div>';
          }

          if (Object.keys(data.failurePatterns).length > 0) {
            behaviorHTML += '<div style="margin-bottom: 15px;"><strong>Common Failure Patterns:</strong><br>';
            Object.entries(data.failurePatterns).forEach(([error, count]) => {
              behaviorHTML += `<span style="color: #ffd93d; font-size: 12px;">${error}: ${count} occurrences</span><br>`;
            });
            behaviorHTML += '</div>';
          }

          // Recommendations
          if (data.recommendations.shouldImplementRateLimit) {
            behaviorHTML += `<div style="background: #e74c3c; color: white; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
              ‚ö†Ô∏è Recommendation: Implement rate limiting (${data.recommendations.highVolumeIPs} high-volume IPs detected)
            </div>`;
          }

          analyticsDiv.innerHTML = behaviorHTML;
          analyticsDiv.style.display = 'block';

          showAlert('‚úÖ User behavior analytics loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('User behavior analytics error:', error);
        showAlert('‚ùå Failed to load user behavior analytics', 'error');
      }
    }

    async function showWalletLists() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        // This would require additional endpoints to get blacklist/whitelist
        // For now, show a placeholder
        const resultsDiv = document.getElementById('bulkResults');
        resultsDiv.innerHTML = `
          <div>
            <strong>Wallet Lists Status</strong><br>
            <span style="color: #ffd93d;">Feature coming soon - will show current blacklist and whitelist</span><br>
            <small style="color: #666;">This will display all blacklisted and whitelisted wallets</small>
          </div>
        `;
        resultsDiv.style.display = 'block';

        showAlert('Wallet lists feature coming soon', 'info');
      } catch (error) {
        showAlert('‚ùå Failed to load wallet lists', 'error');
      }
    }

    // Business Intelligence Functions
    async function loadROIAnalytics() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading ROI analytics...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/roi-analytics`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update dashboard elements
          document.getElementById('conversionRate').textContent = `${data.overview.conversionRate}%`;
          document.getElementById('costPerUser').textContent = `${data.overview.averageCostPerUser.toLocaleString()} WALDO`;
          document.getElementById('growthRate').textContent = `${data.growthMetrics.weeklyGrowthRate} claims/week`;
          document.getElementById('roiScore').textContent = `${data.campaignEffectiveness.roi}%`;

          // Show detailed ROI analytics
          const roiDiv = document.getElementById('roiDetails');
          let roiHTML = `
            <div class="grid-3" style="margin-bottom: 15px;">
              <div>
                <strong>üìä Financial Metrics</strong><br>
                <span style="color: #25c2a0;">Total Value: $${data.financialMetrics.totalValueDistributed.toFixed(2)}</span><br>
                <span style="color: #ffd93d;">Cost/Acquisition: $${data.financialMetrics.costPerAcquisition}</span><br>
                <span style="color: #25c2a0;">Monthly Projection: $${data.financialMetrics.projectedMonthlyCost.toFixed(2)}</span>
              </div>
              <div>
                <strong>üìà Growth Metrics</strong><br>
                <span style="color: #25c2a0;">24h Claims: ${data.growthMetrics.claims24h}</span><br>
                <span style="color: #25c2a0;">7d Claims: ${data.growthMetrics.claims7d}</span><br>
                <span style="color: #ffd93d;">Daily Average: ${data.growthMetrics.dailyGrowthRate.toFixed(1)}</span>
              </div>
              <div>
                <strong>üéØ Campaign Performance</strong><br>
                <span style="color: #25c2a0;">Reach: ${data.campaignEffectiveness.reach.toLocaleString()}</span><br>
                <span style="color: #25c2a0;">Engagement: ${data.campaignEffectiveness.engagement}</span><br>
                <span style="color: #ffd93d;">Conversion: ${data.campaignEffectiveness.conversionRate}%</span>
              </div>
            </div>
          `;

          if (data.recommendations) {
            roiHTML += '<div style="background: #333; padding: 10px; border-radius: 4px; margin-bottom: 10px;"><strong>üí° Recommendations:</strong><br>';
            Object.entries(data.recommendations).forEach(([key, value]) => {
              if (value === true) {
                const recommendation = key.replace(/([A-Z])/g, ' $1').toLowerCase();
                roiHTML += `<span style="color: #ffd93d;">‚Ä¢ ${recommendation}</span><br>`;
              }
            });
            roiHTML += '</div>';
          }

          roiDiv.innerHTML = roiHTML;
          roiDiv.style.display = 'block';

          showAlert('‚úÖ ROI analytics loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('ROI analytics error:', error);
        showAlert('‚ùå Failed to load ROI analytics', 'error');
      }
    }

    async function loadTokenDistribution() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading token distribution analysis...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/token-distribution`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const roiDiv = document.getElementById('roiDetails');
          let distributionHTML = `
            <div class="grid-2" style="margin-bottom: 15px;">
              <div>
                <strong>ü™ô Distribution Overview</strong><br>
                <span style="color: #25c2a0;">Total Wallets: ${data.distributionOverview.totalWallets}</span><br>
                <span style="color: #25c2a0;">Total Distributed: ${data.distributionOverview.totalDistributedFormatted}</span><br>
                <span style="color: #ffd93d;">Average Amount: ${data.distributionOverview.averageAmount.toLocaleString()}</span><br>
                <span style="color: #25c2a0;">Amount Levels: ${data.distributionOverview.uniqueAmountLevels}</span>
              </div>
              <div>
                <strong>üìä Wallet Analysis</strong><br>
                <span style="color: #25c2a0;">Current Balance: ${data.walletAnalysis.currentBalanceFormatted}</span><br>
                <span style="color: #ffd93d;">Remaining Capacity: ${data.walletAnalysis.remainingCapacity}</span><br>
                <span style="color: #25c2a0;">Projected Distribution: ${data.walletAnalysis.projectedDistributionFormatted}</span><br>
                <span style="color: #ffd93d;">Efficiency: ${data.insights.distributionEfficiency}%</span>
              </div>
            </div>
          `;

          if (data.concentrationMetrics.mostCommonAmount) {
            distributionHTML += `
              <div style="background: #333; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                <strong>üìà Most Common Amount:</strong>
                ${data.concentrationMetrics.mostCommonAmount.amount.toLocaleString()} WALDO
                (${data.concentrationMetrics.mostCommonAmount.count} wallets, ${data.concentrationMetrics.mostCommonAmount.percentage}%)
              </div>
            `;
          }

          distributionHTML += `
            <div style="background: #222; padding: 10px; border-radius: 4px;">
              <strong>üí° Insights:</strong><br>
              <span style="color: #ffd93d;">‚Ä¢ ${data.insights.recommendedOptimization}</span><br>
              <span style="color: #ffd93d;">‚Ä¢ ${data.insights.concentrationRisk}</span>
            </div>
          `;

          roiDiv.innerHTML = distributionHTML;
          roiDiv.style.display = 'block';

          showAlert('‚úÖ Token distribution analysis loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Token distribution error:', error);
        showAlert('‚ùå Failed to load token distribution', 'error');
      }
    }

    async function loadMarketingPerformance() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading marketing performance...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/marketing-performance`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const roiDiv = document.getElementById('roiDetails');
          let marketingHTML = `
            <div class="grid-3" style="margin-bottom: 15px;">
              <div>
                <strong>üìä Funnel Analysis</strong><br>
                <span style="color: #25c2a0;">Awareness: ${data.funnelAnalysis.awareness.toLocaleString()}</span><br>
                <span style="color: #25c2a0;">Interest: ${data.funnelAnalysis.interest}</span><br>
                <span style="color: #ffd93d;">Conversion: ${data.funnelAnalysis.conversionRate}%</span><br>
                <span style="color: #e74c3c;">Dropoff: ${data.funnelAnalysis.dropoffRate}%</span>
              </div>
              <div>
                <strong>üìà Growth Analysis</strong><br>
                <span style="color: #25c2a0;">Daily Average: ${data.growthAnalysis.dailyAverage}</span><br>
                <span style="color: #25c2a0;">Weekly Average: ${data.growthAnalysis.weeklyAverage}</span><br>
                <span style="color: ${data.growthAnalysis.growthTrend === 'increasing' ? '#25c2a0' : '#e74c3c'};">
                  Trend: ${data.growthAnalysis.growthTrend}
                </span><br>
                <span style="color: #ffd93d;">Velocity: ${data.growthAnalysis.velocityScore}</span>
              </div>
              <div>
                <strong>üéØ KPIs</strong><br>
                <span style="color: #25c2a0;">Total Reach: ${data.kpis.totalReach.toLocaleString()}</span><br>
                <span style="color: #25c2a0;">Engagement: ${data.kpis.totalEngagement}</span><br>
                <span style="color: #ffd93d;">Engagement Rate: ${data.kpis.engagementRate}%</span><br>
                <span style="color: #25c2a0;">Avg Value: ${data.kpis.averageClaimValue.toLocaleString()}</span>
              </div>
            </div>
          `;

          // Channel performance
          marketingHTML += '<div style="background: #333; padding: 10px; border-radius: 4px; margin-bottom: 10px;"><strong>üì¢ Channel Performance (Estimated):</strong><br>';
          Object.entries(data.channelPerformance).forEach(([channel, metrics]) => {
            marketingHTML += `
              <span style="color: #25c2a0;">${channel.toUpperCase()}:</span>
              ${metrics.estimated_conversions} conversions,
              $${metrics.estimated_cost_per_acquisition} CPA<br>
            `;
          });
          marketingHTML += '</div>';

          // Recommendations
          if (data.recommendations.length > 0) {
            marketingHTML += '<div style="background: #222; padding: 10px; border-radius: 4px;"><strong>üí° Recommendations:</strong><br>';
            data.recommendations.forEach(rec => {
              marketingHTML += `<span style="color: #ffd93d;">‚Ä¢ ${rec}</span><br>`;
            });
            marketingHTML += '</div>';
          }

          roiDiv.innerHTML = marketingHTML;
          roiDiv.style.display = 'block';

          showAlert('‚úÖ Marketing performance loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Marketing performance error:', error);
        showAlert('‚ùå Failed to load marketing performance', 'error');
      }
    }

    // Executive Reporting Functions
    async function loadAdvancedReports() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Generating executive report...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/advanced-reports`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update executive dashboard elements
          const healthColor = data.executiveSummary.systemHealth === 'healthy' ? '#25c2a0' :
            data.executiveSummary.systemHealth === 'warning' ? '#ffd93d' : '#e74c3c';
          document.getElementById('executiveSystemHealth').style.color = healthColor;
          document.getElementById('executiveSystemHealth').textContent = data.executiveSummary.systemHealth.toUpperCase();

          const performanceColor = data.executiveSummary.overallPerformance >= 80 ? '#25c2a0' :
            data.executiveSummary.overallPerformance >= 60 ? '#ffd93d' : '#e74c3c';
          document.getElementById('performanceScore').style.color = performanceColor;
          document.getElementById('performanceScore').textContent = `${data.executiveSummary.overallPerformance}%`;

          const riskColor = data.executiveSummary.riskLevel === 'low' ? '#25c2a0' :
            data.executiveSummary.riskLevel === 'medium' ? '#ffd93d' : '#e74c3c';
          document.getElementById('riskLevel').style.color = riskColor;
          document.getElementById('riskLevel').textContent = data.executiveSummary.riskLevel.toUpperCase();

          // Generate comprehensive executive report
          const reportDiv = document.getElementById('executiveReport');
          let reportHTML = `
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #444; padding-bottom: 15px;">
              <h2 style="color: #25c2a0; margin: 0;">WALDOCOIN Airdrop System</h2>
              <h3 style="color: #ffd93d; margin: 5px 0;">Executive Report</h3>
              <p style="color: #666; margin: 0; font-size: 12px;">Generated: ${new Date().toLocaleString()}</p>
            </div>

            <div class="grid-3" style="margin-bottom: 20px;">
              <div style="background: #333; padding: 15px; border-radius: 6px;">
                <h4 style="color: #25c2a0; margin-top: 0;">üìä Executive Summary</h4>
                <p><strong>Total Claims:</strong> ${data.executiveSummary.totalClaims.toLocaleString()}</p>
                <p><strong>Remaining Capacity:</strong> ${data.executiveSummary.remainingCapacity}</p>
                <p><strong>System Health:</strong> <span style="color: ${healthColor};">${data.executiveSummary.systemHealth.toUpperCase()}</span></p>
                <p><strong>Reliability:</strong> ${data.executiveSummary.reliabilityScore}%</p>
                <p><strong>Risk Level:</strong> <span style="color: ${riskColor};">${data.executiveSummary.riskLevel.toUpperCase()}</span></p>
              </div>

              <div style="background: #333; padding: 15px; border-radius: 6px;">
                <h4 style="color: #25c2a0; margin-top: 0;">‚öôÔ∏è Operational Metrics</h4>
                <p><strong>Capacity Utilization:</strong> ${data.operationalMetrics.capacityUtilization}%</p>
                <p><strong>Processing Cost:</strong> $${data.operationalMetrics.averageProcessingCost.toFixed(3)}</p>
                <p><strong>Distributor Balance:</strong> ${data.operationalMetrics.distributorBalanceFormatted}</p>
                <p><strong>Failure Rate:</strong> ${data.operationalMetrics.failureRate}%</p>
              </div>

              <div style="background: #333; padding: 15px; border-radius: 6px;">
                <h4 style="color: #25c2a0; margin-top: 0;">üîí Security Metrics</h4>
                <p><strong>Blacklisted Wallets:</strong> ${data.securityMetrics.blacklistedWallets}</p>
                <p><strong>Whitelisted Wallets:</strong> ${data.securityMetrics.whitelistedWallets}</p>
                <p><strong>Manual Interventions:</strong> ${data.securityMetrics.manualInterventions}</p>
                <p><strong>Security Score:</strong> ${data.securityMetrics.securityScore}%</p>
              </div>
            </div>
          `;

          // Add recommendations if available
          if (data.performanceBenchmarks.recommendations.length > 0) {
            reportHTML += `
              <div style="background: #222; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                <h4 style="color: #ffd93d; margin-top: 0;">üí° Strategic Recommendations</h4>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  ${data.performanceBenchmarks.recommendations.map(rec => `<li style="color: #ffd93d;">${rec}</li>`).join('')}
                </ul>
              </div>
            `;
          }

          reportDiv.innerHTML = reportHTML;

          showAlert('‚úÖ Executive report generated', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Advanced reports error:', error);
        showAlert('‚ùå Failed to generate executive report', 'error');
      }
    }

    function toggleExecutiveView() {
      const container = document.getElementById('executiveReportContainer');
      if (container.style.display === 'none') {
        container.style.display = 'block';
      } else {
        container.style.display = 'none';
      }
    }

    function exportExecutiveReport() {
      const reportContent = document.getElementById('executiveReport').innerHTML;
      if (!reportContent || reportContent.includes('Click "Generate Executive Report"')) {
        showAlert('Please generate the executive report first', 'error');
        return;
      }

      // Create a simple HTML export
      const exportHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>WALDOCOIN Executive Report</title>
          <style>
            body { font-family: Arial, sans-serif; background: #1a1a1a; color: #fff; padding: 20px; }
            .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
            h2, h3, h4 { color: #25c2a0; }
            p { margin: 8px 0; }
            ul { margin: 5px 0; padding-left: 20px; }
          </style>
        </head>
        <body>
          ${reportContent}
        </body>
        </html>
      `;

      const blob = new Blob([exportHTML], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `WALDOCOIN_Executive_Report_${new Date().toISOString().split('T')[0]}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showAlert('‚úÖ Executive report exported', 'success');
    }

    // Presale Analytics Functions
    async function loadPresaleAnalytics() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading presale analytics...', 'info');

        const response = await fetch(`${API_BASE}/api/presale/analytics`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update dashboard elements
          document.getElementById('presaleTotalSold').textContent = data.overview.totalWALDO.toLocaleString();
          document.getElementById('presaleTotalXRP').textContent = `${data.overview.totalXRP.toLocaleString()} XRP`;
          document.getElementById('presaleTotalPurchases').textContent = data.overview.totalPurchases.toLocaleString();
          document.getElementById('presaleRecentActivity').textContent = `${data.timeBasedMetrics.purchases24h} purchases`;

          // Show detailed presale analytics
          const presaleDiv = document.getElementById('presaleDetails');
          let presaleHTML = `
            <div class="grid-3" style="margin-bottom: 15px;">
              <div>
                <strong>üìä Purchase Metrics</strong><br>
                <span style="color: #25c2a0;">Avg XRP/Purchase: ${data.overview.averageXRPPerPurchase}</span><br>
                <span style="color: #25c2a0;">Avg WALDO/Purchase: ${data.overview.averageWALDOPerPurchase.toLocaleString()}</span><br>
                <span style="color: #ffd93d;">Daily Average: ${data.timeBasedMetrics.dailyAverage}</span>
              </div>
              <div>
                <strong>üéÅ Bonus Tier Analysis</strong><br>
                <span style="color: #25c2a0;">No Bonus: ${data.bonusAnalysis.no_bonus}</span><br>
                <span style="color: #ffd93d;">15% Bonus: ${data.bonusAnalysis.tier_15}</span><br>
                <span style="color: #ff6b6b;">22% Bonus: ${data.bonusAnalysis.tier_22}</span><br>
                <span style="color: #e74c3c;">30% Bonus: ${data.bonusAnalysis.tier_30}</span>
              </div>
              <div>
                <strong>üìà Recent Activity</strong><br>
                <span style="color: #25c2a0;">24h Purchases: ${data.timeBasedMetrics.purchases24h}</span><br>
                <span style="color: #25c2a0;">24h XRP: ${data.timeBasedMetrics.xrp24h.toFixed(2)}</span><br>
                <span style="color: #ffd93d;">7d Purchases: ${data.timeBasedMetrics.purchases7d}</span><br>
                <span style="color: ${data.timeBasedMetrics.weeklyTrend === 'increasing' ? '#25c2a0' : '#ffd93d'};">
                  Trend: ${data.timeBasedMetrics.weeklyTrend}
                </span>
              </div>
            </div>
          `;

          // Top purchasers
          if (data.topPurchasers.length > 0) {
            presaleHTML += '<div style="background: #333; padding: 10px; border-radius: 4px; margin-bottom: 10px;"><strong>üèÜ Top Purchasers:</strong><br>';
            data.topPurchasers.slice(0, 5).forEach((purchaser, index) => {
              presaleHTML += `
                <span style="color: #25c2a0; font-size: 12px;">
                  ${index + 1}. ${purchaser.wallet}: ${purchaser.xrpTotal} XRP (${purchaser.purchaseCount} purchases)
                </span><br>
              `;
            });
            presaleHTML += '</div>';
          }

          presaleDiv.innerHTML = presaleHTML;
          presaleDiv.style.display = 'block';

          showAlert('‚úÖ Presale analytics loaded', 'success');
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Presale analytics error:', error);
        showAlert('‚ùå Failed to load presale analytics', 'error');
      }
    }

    async function loadPresalePurchases() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading recent presale purchases...', 'info');

        const response = await fetch(`${API_BASE}/api/presale/analytics`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success && data.recentPurchases) {
          const presaleDiv = document.getElementById('presaleDetails');
          let purchasesHTML = '<div style="margin-bottom: 15px;"><strong>üìã Recent Purchases (Last 20):</strong></div>';

          if (data.recentPurchases.length === 0) {
            purchasesHTML += '<div style="color: #666; text-align: center; padding: 20px;">No recent purchases found</div>';
          } else {
            purchasesHTML += '<div style="max-height: 400px; overflow-y: auto; font-size: 12px;">';

            data.recentPurchases.forEach(purchase => {
              const timestamp = new Date(purchase.timestamp).toLocaleString();
              const bonusText = purchase.bonusPercent > 0 ? ` (+${purchase.bonusPercent}% bonus)` : '';

              purchasesHTML += `
                <div style="border-bottom: 1px solid #333; padding: 8px 0; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span style="color: #25c2a0; font-weight: bold;">${purchase.wallet}</span>
                    <span style="color: #666; font-size: 10px;">${timestamp}</span>
                  </div>
                  <div style="color: #ccc; margin-top: 4px;">
                    ${purchase.xrpAmount} XRP ‚Üí ${purchase.waldoAmount.toLocaleString()} WALDO${bonusText}
                  </div>
                  ${purchase.txHash ? `<div style="color: #666; font-size: 10px; margin-top: 2px;">TX: ${purchase.txHash}</div>` : ''}
                </div>
              `;
            });

            purchasesHTML += '</div>';
          }

          presaleDiv.innerHTML = purchasesHTML;
          presaleDiv.style.display = 'block';

          showAlert(`‚úÖ Loaded ${data.recentPurchases.length} recent purchases`, 'success');
        } else {
          showAlert(`‚ùå ${data.error || 'No purchase data available'}`, 'error');
        }

      } catch (error) {
        console.error('Load presale purchases error:', error);
        showAlert('‚ùå Failed to load presale purchases', 'error');
      }
    }

    async function loadPresaleSummary() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) return;

      try {
        const response = await fetch(`${API_BASE}/api/presale/admin-summary`, {
          method: 'GET',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('presaleTotalSold').textContent = data.formatted.totalSold;
          document.getElementById('presaleTotalXRP').textContent = `${data.formatted.totalXRP} XRP`;
          document.getElementById('presaleTotalPurchases').textContent = data.formatted.totalPurchases;
          document.getElementById('presaleRecentActivity').textContent = `${data.recentActivity.purchases24h} purchases`;
        }
      } catch (error) {
        console.error('Failed to load presale summary:', error);
      }
    }

    function exportPresaleData() {
      showAlert('Presale data export feature coming soon', 'info');
    }

    // Presale Countdown Management Functions
    async function loadCurrentCountdown() {
      try {
        const response = await fetch(`${API_BASE}/api/presale/countdown`);
        const data = await response.json();

        if (data.success) {
          const endDateElement = document.getElementById('currentEndDate');
          const timeRemainingElement = document.getElementById('timeRemaining');

          if (data.endDate) {
            const endDate = new Date(data.endDate);
            endDateElement.textContent = endDate.toLocaleString();
            endDateElement.style.color = '#25c2a0';

            // Calculate and display time remaining
            const now = new Date();
            const diff = endDate - now;

            if (diff > 0) {
              const days = Math.floor(diff / (1000 * 60 * 60 * 24));
              const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
              const minutes = Math.floor((diff / (1000 * 60)) % 60);

              timeRemainingElement.textContent = `${days}d ${hours}h ${minutes}m`;
              timeRemainingElement.style.color = '#25c2a0';
            } else {
              timeRemainingElement.textContent = 'EXPIRED';
              timeRemainingElement.style.color = '#e74c3c';
            }
          } else {
            endDateElement.textContent = 'Not Set';
            endDateElement.style.color = '#666';
            timeRemainingElement.textContent = 'No countdown active';
            timeRemainingElement.style.color = '#666';
          }
        } else {
          document.getElementById('currentEndDate').textContent = 'Error loading';
          document.getElementById('timeRemaining').textContent = 'Error loading';
        }
      } catch (error) {
        console.error('Failed to load countdown:', error);
        document.getElementById('currentEndDate').textContent = 'Load failed';
        document.getElementById('timeRemaining').textContent = 'Load failed';
      }
    }

    async function updatePresaleCountdown() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const newEndDate = document.getElementById('newEndDate').value;
      if (!newEndDate) {
        showAlert('Please select an end date and time', 'error');
        return;
      }

      try {
        showAlert('Updating presale countdown...', 'info');

        const response = await fetch(`${API_BASE}/api/presale/set-countdown`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            endDate: new Date(newEndDate).toISOString()
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('‚úÖ Presale countdown updated successfully', 'success');

          // Show status message
          const statusDiv = document.getElementById('countdownStatus');
          statusDiv.innerHTML = `
            <div style="color: #25c2a0; font-weight: bold;">
              ‚úÖ Countdown Updated Successfully
            </div>
            <div style="color: #ccc; font-size: 12px; margin-top: 5px;">
              New end date: ${new Date(data.endDate).toLocaleString()}
            </div>
          `;
          statusDiv.style.display = 'block';

          // Refresh the display
          loadCurrentCountdown();

          // Clear the input
          document.getElementById('newEndDate').value = '';
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Update countdown error:', error);
        showAlert('‚ùå Failed to update countdown', 'error');
      }
    }

    async function clearPresaleCountdown() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      if (!confirm('Are you sure you want to clear the presale countdown? This will remove the countdown from all displays.')) {
        return;
      }

      try {
        showAlert('Clearing presale countdown...', 'info');

        const response = await fetch(`${API_BASE}/api/presale/set-countdown`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            action: 'clear'
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('‚úÖ Presale countdown cleared', 'success');

          // Show status message
          const statusDiv = document.getElementById('countdownStatus');
          statusDiv.innerHTML = `
            <div style="color: #ffd93d; font-weight: bold;">
              üóëÔ∏è Countdown Cleared
            </div>
            <div style="color: #ccc; font-size: 12px; margin-top: 5px;">
              The presale countdown has been removed from all displays
            </div>
          `;
          statusDiv.style.display = 'block';

          // Refresh the display
          loadCurrentCountdown();
        } else {
          showAlert(`‚ùå ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Clear countdown error:', error);
        showAlert('‚ùå Failed to clear countdown', 'error');
      }
    }

    function setCountdownQuick(hours) {
      const now = new Date();
      const futureDate = new Date(now.getTime() + (hours * 60 * 60 * 1000));

      // Format for datetime-local input (YYYY-MM-DDTHH:MM)
      const year = futureDate.getFullYear();
      const month = String(futureDate.getMonth() + 1).padStart(2, '0');
      const day = String(futureDate.getDate()).padStart(2, '0');
      const hour = String(futureDate.getHours()).padStart(2, '0');
      const minute = String(futureDate.getMinutes()).padStart(2, '0');

      const formattedDate = `${year}-${month}-${day}T${hour}:${minute}`;
      document.getElementById('newEndDate').value = formattedDate;

      showAlert(`Set to ${hours} hours from now`, 'info');
    }

    // ===== SIMPLE BOT SWITCHING =====
    let currentBotSelected = 'bot1';

    function switchBot(botId) {
      console.log('üîÑ Switching to bot:', botId);
      currentBotSelected = botId;
      const bot1Controls = document.getElementById('bot1ControlsSection');
      const bot2Controls = document.getElementById('bot2ControlsCard');

      console.log('Bot 1 Controls found:', !!bot1Controls);
      console.log('Bot 2 Controls found:', !!bot2Controls);

      if (botId === 'bot1') {
        if (bot1Controls) bot1Controls.style.display = 'block';
        if (bot2Controls) bot2Controls.style.display = 'none';
      } else {
        if (bot1Controls) bot1Controls.style.display = 'none';
        if (bot2Controls) bot2Controls.style.display = 'block';
      }
    }

    // ===== VOLUME BOT FUNCTIONS (REDIRECTS TO TRADING BOT) =====
    async function loadVolumeBotData() {
      // The "volumebot" section now shows the Trading Bot
      // Redirect to the correct trading bot functions
      await loadTradingBotStatus();
      await loadTradingBotTrades();
    }





    // ===== TRADING BOT FUNCTIONS =====
    async function loadTradingBotStatus() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/status`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Update status displays - use correct element IDs
          const botStatusEl = document.getElementById('botStatus');
          const botBalanceEl = document.getElementById('botBalance');
          const botTradesEl = document.getElementById('botTrades');
          const botVolumeEl = document.getElementById('botVolume');

          if (botStatusEl) botStatusEl.textContent = data.status || 'Unknown';
          if (botBalanceEl) botBalanceEl.textContent = `${data.balance?.xrp || '0'} XRP`;
          if (botTradesEl) botTradesEl.textContent = data.activity?.tradesCount || '0';
          if (botVolumeEl) botVolumeEl.textContent = data.activity?.volume24h || '0 XRP';

          // Update profit and WLO displays
          const profitEl = document.getElementById('tradingBotProfit');
          const wloEl = document.getElementById('tradingBotWLO');
          if (profitEl) profitEl.textContent = `${data.profit?.xrp || '0'} XRP (${data.profit?.percentage || '0'}%)`;
          if (wloEl) wloEl.textContent = `${data.balance?.wlo || '0'} WLO`;

          // Display trading wallet addresses
          if (data.tradingWallet) {
            const walletEl = document.getElementById('tradingWalletAddress');
            if (walletEl) walletEl.textContent = data.tradingWallet;
          }

          // Display second wallet if available
          if (data.tradingWallet2) {
            const wallet2El = document.getElementById('tradingWalletAddress2');
            if (wallet2El) wallet2El.textContent = data.tradingWallet2;
          }

          // Update active bots count
          const botsCount = data.tradingWallet2 ? '2 Bots' : '1 Bot';
          const botsEl = document.getElementById('activeBots');
          if (botsEl) botsEl.textContent = botsCount;

          // Show Bot 2 option in dropdown if Bot 2 is configured
          console.log('üìä Trading Bot Status Response:', data);
          console.log('ü§ñ Trading Wallet 2:', data.tradingWallet2);

          const bot2Option = document.getElementById('bot2Option');
          if (data.tradingWallet2) {
            console.log('‚úÖ Bot 2 is configured, showing option');
            if (bot2Option) bot2Option.style.display = 'block';
          } else {
            console.log('‚ùå Bot 2 is NOT configured');
            if (bot2Option) bot2Option.style.display = 'none';
          }

          // Display Bot 1 metrics
          if (data.bot1) {
            const bot1BalanceEl = document.getElementById('bot1Balance');
            const bot1TradesEl = document.getElementById('bot1Trades');
            if (bot1BalanceEl) bot1BalanceEl.textContent = `${data.bot1.balance.xrp} XRP + ${data.bot1.balance.wlo} WLO`;
            if (bot1TradesEl) bot1TradesEl.textContent = data.bot1.trades || '0';
          }

          // Display Bot 2 metrics if available
          if (data.bot2) {
            const bot2BalanceEl = document.getElementById('bot2Balance');
            const bot2TradesEl = document.getElementById('bot2Trades');
            if (bot2BalanceEl) bot2BalanceEl.textContent = `${data.bot2.balance.xrp} XRP + ${data.bot2.balance.wlo} WLO`;
            if (bot2TradesEl) bot2TradesEl.textContent = data.bot2.trades || '0';
          }

          // Show/hide Bot 2 controls based on whether Bot 2 is configured
          const bot2ControlsCard = document.getElementById('bot2ControlsCard');
          if (DEBUG_MODE) {
            console.log('ü§ñ Bot 2 Debug:', {
              tradingWallet2: data.tradingWallet2,
              bot2ControlsCard: !!bot2ControlsCard,
              bot2Data: data.bot2
            });
          }
          if (bot2ControlsCard) {
            if (data.tradingWallet2) {
              bot2ControlsCard.style.display = 'block';
              // Update Bot 2 status display
              const bot2StatusDisplay = document.getElementById('bot2StatusDisplay');
              if (bot2StatusDisplay) {
                const bot2Status = data.settings?.bot2Enabled ? '‚úÖ Enabled' : '‚ùå Disabled';
                bot2StatusDisplay.textContent = bot2Status;
              }
              if (DEBUG_MODE) console.log('‚úÖ Bot 2 controls shown');
            } else {
              bot2ControlsCard.style.display = 'none';
              if (DEBUG_MODE) console.log('‚ùå Bot 2 controls hidden - tradingWallet2 not configured');
            }
          }

          // Update form fields with current settings
          if (data.settings) {
            const tradingMode = data.settings.tradingMode || 'automated';
            const modeEl = document.getElementById('tbTradingMode');
            const freqEl = document.getElementById('tbTradingFrequency');
            const minEl = document.getElementById('tbMinTradeSize');
            const maxEl = document.getElementById('tbMaxTradeSize');
            const spreadEl = document.getElementById('tbPriceSpread');
            const volumeEl = document.getElementById('tbMaxDailyVolume');

            if (modeEl) modeEl.value = tradingMode;
            if (freqEl) freqEl.value = data.settings.frequency || '30';
            if (minEl) minEl.value = data.settings.minTradeSize || '0.5';
            if (maxEl) maxEl.value = data.settings.maxTradeSize || '2.0';
            if (spreadEl) spreadEl.value = data.settings.priceSpread || '0';
            if (volumeEl) volumeEl.value = data.settings.maxDailyVolume || '500';

            // Display current trading mode in readable format
            const modeLabels = {
              'automated': 'ü§ñ Automated (Smart Emergency Detection)',
              'perpetual': '‚ôæÔ∏è Perpetual (Weighted Balance)',
              'buy_only': 'üìà Buy Only',
              'sell_only': 'üìâ Sell Only',
              'buy_sell': '‚ÜîÔ∏è Buy & Sell (Balanced)'
            };
            const modeDisplayEl = document.getElementById('currentTradingMode');
            if (modeDisplayEl) modeDisplayEl.textContent = modeLabels[tradingMode] || tradingMode;
          }
        } else {
          showAlert(`Error loading trading bot status: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error loading trading bot status:', error);
        showAlert('Network error loading trading bot status', 'error');
      }
    }

    async function pauseTradingBot() {
      if (!confirm('‚è∏Ô∏è Pause Trading Bot?\n\nThis will stop all trading activity until resumed.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/pause`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Trading bot paused successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to pause trading bot: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error pausing trading bot:', error);
        showAlert('Network error pausing trading bot', 'error');
      }
    }

    async function resumeTradingBot() {
      if (!confirm('‚ñ∂Ô∏è Resume Trading Bot?\n\nThis will restart trading activity.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/resume`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Trading bot resumed successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to resume trading bot: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error resuming trading bot:', error);
        showAlert('Network error resuming trading bot', 'error');
      }
    }

    async function emergencyStopTradingBot() {
      if (!confirm('üõë EMERGENCY STOP TRADING BOT\n\nThis will immediately halt all trading activity.\n\nAre you sure?')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/emergency-stop`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Emergency stop activated - all trading halted', 'warning');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to emergency stop: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error executing emergency stop:', error);
        showAlert('Network error executing emergency stop', 'error');
      }
    }

    async function updateTradingBotSettings() {
      try {
        const settings = {
          tradingMode: document.getElementById('tbTradingMode').value,
          frequency: parseInt(document.getElementById('tbTradingFrequency').value),
          minTradeSize: parseFloat(document.getElementById('tbMinTradeSize').value),
          maxTradeSize: parseFloat(document.getElementById('tbMaxTradeSize').value),
          priceSpread: parseFloat(document.getElementById('tbPriceSpread').value),
          maxDailyVolume: parseInt(document.getElementById('tbMaxDailyVolume').value)
        };

        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify(settings)
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Trading bot settings updated successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to update settings: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error updating trading bot settings:', error);
        showAlert('Network error updating settings', 'error');
      }
    }

    // ===== BOT 2 CONTROL FUNCTIONS =====
    async function enableBot2() {
      if (!confirm('‚úÖ Enable Bot 2?\n\nThis will start the second trading wallet.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/bot2/enable`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Bot 2 enabled successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to enable Bot 2: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error enabling Bot 2:', error);
        showAlert('Network error enabling Bot 2', 'error');
      }
    }

    async function disableBot2() {
      if (!confirm('‚ùå Disable Bot 2?\n\nThis will stop the second trading wallet.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/bot2/disable`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Bot 2 disabled successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to disable Bot 2: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error disabling Bot 2:', error);
        showAlert('Network error disabling Bot 2', 'error');
      }
    }

    async function pauseBot2() {
      if (!confirm('‚è∏Ô∏è Pause Bot 2?\n\nThis will stop Bot 2 trading until resumed.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/bot2/pause`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Bot 2 paused successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to pause Bot 2: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error pausing Bot 2:', error);
        showAlert('Network error pausing Bot 2', 'error');
      }
    }

    async function resumeBot2() {
      if (!confirm('‚ñ∂Ô∏è Resume Bot 2?\n\nThis will resume Bot 2 trading.')) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/bot2/resume`, {
          method: 'POST',
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Bot 2 resumed successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to resume Bot 2: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error resuming Bot 2:', error);
        showAlert('Network error resuming Bot 2', 'error');
      }
    }

    async function updateBot2Settings() {
      try {
        const settings = {
          bot2TradingMode: document.getElementById('tbBot2TradingMode').value,
          bot2MinTradeSize: parseFloat(document.getElementById('tbBot2MinTradeSize').value),
          bot2MaxTradeSize: parseFloat(document.getElementById('tbBot2MaxTradeSize').value)
        };

        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/bot2/settings`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify(settings)
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Bot 2 settings updated successfully', 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to update Bot 2 settings: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error updating Bot 2 settings:', error);
        showAlert('Network error updating Bot 2 settings', 'error');
      }
    }

    async function loadTradingBotTrades() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/trades`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const tradesDiv = document.getElementById('tradingBotTradesList');

        if (data.success && data.trades && data.trades.length > 0) {
          let tradesHtml = '';
          data.trades.forEach(trade => {
            const timestamp = new Date(trade.timestamp).toLocaleString();
            const typeColor = trade.type === 'BUY' ? '#27ae60' : '#e74c3c';
            const typeIcon = trade.type === 'BUY' ? 'üìà' : 'üìâ';

            tradesHtml += `
              <div style="background: #333; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid ${typeColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="color: ${typeColor}; font-weight: bold;">${typeIcon} ${trade.type}</div>
                    <div style="color: #ccc; font-size: 0.9em;">${trade.amount} ${trade.currency || 'WLO'}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: #fff; font-weight: bold;">${trade.price} XRP</div>
                    <div style="color: #666; font-size: 0.8em;">${timestamp}</div>
                  </div>
                </div>
                ${trade.hash ? `<div style="color: #3498db; font-size: 0.8em; margin-top: 5px;">TX: ${trade.hash.substring(0, 16)}...</div>` : ''}
              </div>
            `;
          });
          tradesDiv.innerHTML = tradesHtml;
        } else {
          tradesDiv.innerHTML = '<div style="color: #666; font-style: italic; text-align: center; padding: 20px;">No recent trades found</div>';
        }
      } catch (error) {
        console.error('Error loading trading bot trades:', error);
        document.getElementById('tradingBotTradesList').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading trades</div>';
      }
    }

    async function resetTradingBotProfit() {
      const newBalance = prompt('üîÑ Reset Profit Tracking\n\nEnter new starting balance (XRP):', '70');
      if (!newBalance || isNaN(newBalance)) return;

      if (!confirm(`Reset profit tracking with starting balance: ${newBalance} XRP?`)) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/admin/trading-bot/reset-profit`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ newStartingBalance: parseFloat(newBalance) })
        });

        const data = await response.json();
        if (data.success) {
          showAlert(`Profit tracking reset with starting balance: ${newBalance} XRP`, 'success');
          await loadTradingBotStatus();
        } else {
          showAlert(`Failed to reset profit tracking: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Error resetting profit tracking:', error);
        showAlert('Network error resetting profit tracking', 'error');
      }
    }
  </script>

  </div> <!-- Close adminPanel -->
</body>

</html>