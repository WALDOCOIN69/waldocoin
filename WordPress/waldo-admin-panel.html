<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALDO Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
    }
    
    .admin-header {
      background: linear-gradient(90deg, #25c2a0, #1ea085);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .admin-title {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .admin-subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .admin-nav {
      background: #111;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
      background: #25c2a0;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #25c2a0;
      box-shadow: 0 0 10px rgba(37, 194, 160, 0.3);
    }
    
    .admin-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .admin-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .admin-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #222 0%, #333 100%);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #25c2a0;
      margin-bottom: 10px;
    }
    
    .stat-label {
      font-size: 1.1em;
      opacity: 0.8;
    }
    
    .admin-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .card-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #25c2a0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #ccc;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 15px;
      background: #333;
      border: 1px solid #555;
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #25c2a0;
      box-shadow: 0 0 0 2px rgba(37, 194, 160, 0.2);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      background: linear-gradient(135deg, #25c2a0, #1ea085);
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 194, 160, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #666, #555);
      color: #fff;
    }

    /* Password Management Styles */
    .password-display {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #25c2a0;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      color: #25c2a0;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }

    .password-source {
      background: rgba(255, 217, 61, 0.1);
      border: 1px solid #ffd93d;
      color: #ffd93d;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      text-align: center;
    }

    .quick-passwords {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }

    .quick-btn {
      background: #444;
      color: white;
      border: 1px solid #666;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      text-align: center;
    }

    .quick-btn:hover {
      background: #555;
      border-color: #25c2a0;
      transform: translateY(-1px);
    }

    /* Environment Status Styles */
    .env-status {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .env-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }

    .env-item:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    .env-label {
      color: #ccc;
      font-size: 0.9em;
    }

    .env-value {
      color: #25c2a0;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: #111;
      border: 2px solid #25c2a0;
      border-radius: 18px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 30px rgba(37, 194, 160, 0.3);
      text-align: center;
    }

    .login-header h1 {
      color: #25c2a0;
      margin: 0 0 10px 0;
      font-size: 2.2em;
    }

    .login-header p {
      color: #ccc;
      margin: 0 0 30px 0;
      font-size: 1.1em;
    }

    .login-form {
      text-align: left;
    }

    .login-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
    }

    .login-info {
      background: rgba(37, 194, 160, 0.1);
      border: 1px solid #25c2a0;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }

    .login-info p {
      color: #25c2a0;
      margin: 5px 0;
      font-size: 0.9em;
    }

    .header-with-logout {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Utility Classes */
    .hidden { display: none !important; }
    .margin-bottom-30 { margin-bottom: 30px; }
    .margin-bottom-20 { margin-bottom: 20px; }
    .margin-bottom-15 { margin-bottom: 15px; }
    .margin-bottom-10 { margin-bottom: 10px; }
    .margin-top-15 { margin-top: 15px; }
    .margin-top-10 { margin-top: 10px; }
    .text-center { text-align: center; }
    .text-muted { color: #666; }
    .text-success { color: #27ae60; }
    .text-error { color: #e74c3c; }
    .text-warning { color: #f39c12; }
    .text-primary { color: #25c2a0; }
    .padding-20 { padding: 20px; }
    .width-100 { width: 100%; }
    .font-small { font-size: 0.9em; }
    .font-bold { font-weight: bold; }
    .opacity-80 { opacity: 0.8; }

    .status-container {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .stat-box {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .help-text {
      color: #666;
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
    }

    /* Additional utility classes */
    .section-title {
      color: #25c2a0;
      margin-bottom: 15px;
    }

    .section-title-spaced {
      color: #25c2a0;
      margin: 25px 0 15px 0;
    }

    .stake-details {
      display: none;
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .emergency-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .checkbox-margin {
      margin-right: 8px;
    }

    .alert-small {
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .data-table {
      width: 100%;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    
    .data-table th {
      background: #333;
      padding: 15px;
      text-align: left;
      font-weight: bold;
      color: #25c2a0;
      border-bottom: 1px solid #444;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
    }
    
    .data-table tr:hover {
      background: #2a2a2a;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .status-active {
      background: #27ae60;
      color: #fff;
    }
    
    .status-blocked {
      background: #e74c3c;
      color: #fff;
    }
    
    .status-flagged {
      background: #f39c12;
      color: #fff;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      border: 1px solid #27ae60;
      color: #2ecc71;
    }
    
    .alert-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
    }
    
    .alert-warning {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid #f39c12;
      color: #f39c12;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #25c2a0;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    /* Staking Admin Styles */
    .stake-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .stake-detail-row:last-child {
      border-bottom: none;
    }

    .stake-detail-row span:first-child {
      color: #aaa;
      font-weight: 500;
    }

    .stake-detail-row span:last-child {
      color: #25c2a0;
      font-weight: bold;
    }

    #stakeSelector {
      margin-bottom: 15px;
    }

    #unstakeResult {
      padding: 10px;
      border-radius: 6px;
      display: none;
    }

    #unstakeResult.success {
      background: #25c2a020;
      border: 1px solid #25c2a0;
      color: #25c2a0;
      display: block;
    }

    #unstakeResult.error {
      background: #ff6b6b20;
      border: 1px solid #ff6b6b;
      color: #ff6b6b;
      display: block;
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }

      .nav-buttons {
        flex-direction: column;
      }

      .admin-content {
        padding: 20px;
      }
    }

    /* New Layout Styles */
    .auth-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .auth-input-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .input-button-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-button-row .form-input {
      flex: 1;
      min-width: 250px;
    }

    .auth-status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .password-control-section {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    .current-password-display {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #2a2a2a;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .password-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .current-password {
      font-size: 24px;
      font-weight: bold;
      color: #25c2a0;
      font-family: monospace;
      letter-spacing: 2px;
    }

    .password-source {
      font-size: 12px;
      color: #888;
      font-style: italic;
    }

    .password-change-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .password-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .result-display {
      min-height: 40px;
      padding: 10px;
      border-radius: 6px;
      background: #2a2a2a;
      border: 1px solid #444;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>🔒 WALDO Admin Panel</h1>
        <p>Enter admin password to access system controls</p>
      </div>

      <div class="login-form">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="Enter admin password" onkeypress="handleLoginKeypress(event)">
        </div>

        <button type="button" class="btn btn-primary" onclick="attemptLogin()">
          🔓 Access Admin Panel
        </button>

        <div id="loginError" class="login-error hidden"></div>

        <div class="login-info">
          <p>💡 Use the X_ADMIN_KEY environment variable password</p>
          <p>🔐 This password is for admin panel access only</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Admin Panel (Hidden by default) -->
  <div id="adminPanel" class="hidden">
    <!-- Admin Header -->
    <div class="admin-header">
      <div class="header-with-logout">
        <div>
          <div class="admin-title">🛠️ WALDO Emergency Admin Panel</div>
          <div class="admin-subtitle">Backup controls and manual overrides for automated systems</div>
        </div>
        <button type="button" class="btn btn-danger" onclick="logout()">
          🚪 Logout
        </button>
      </div>
    </div>

  <!-- Navigation -->
  <div class="admin-nav">
    <div class="nav-buttons">
      <button type="button" class="nav-btn active" onclick="showSection('dashboard')">📊 System Status</button>
      <button type="button" class="nav-btn" onclick="showSection('users')">👥 User Override</button>
      <button type="button" class="nav-btn" onclick="showSection('airdrops')">🎁 Manual Airdrop</button>
      <button type="button" class="nav-btn" onclick="showSection('battles')">⚔️ Battle Override</button>
      <button type="button" class="nav-btn" onclick="showSection('staking')">🏦 Staking Monitor</button>
      <button type="button" class="nav-btn" onclick="showSection('security')">🛡️ Security Override</button>
      <button type="button" class="nav-btn" onclick="showSection('dao')">🗳️ DAO Override</button>
      <button type="button" class="nav-btn" onclick="showSection('system')">⚙️ Emergency Controls</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Dashboard Section -->
    <div id="dashboard" class="admin-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">WALDO Trustlines</div>
          <button onclick="loadTrustlineCount()" style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">🔄 Refresh</button>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWaldoDistributed">-</div>
          <div class="stat-label">WALDO Distributed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeBattles">-</div>
          <div class="stat-label">Active Battles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStaked">-</div>
          <div class="stat-label">Total Staked</div>
        </div>
      </div>

      <!-- Admin Key Configuration -->
      <!-- 🔑 Admin Authentication Section -->
      <div class="admin-card margin-bottom-30">
        <div class="card-title">🔑 Admin Authentication</div>
        <p class="text-muted margin-bottom-20">Set your admin key to access all admin functions (from X_ADMIN_KEY environment variable)</p>

        <div class="auth-section">
          <div class="auth-input-group">
            <label class="form-label">Admin Key</label>
            <div class="input-button-row">
              <input type="password" id="adminKeyInput" class="form-input" placeholder="Enter your admin key">
              <button type="button" class="btn btn-primary" onclick="saveAdminKey()">
                💾 Save
              </button>
              <button type="button" class="btn btn-secondary" onclick="clearAdminKey()">
                🗑️ Clear
              </button>
            </div>
          </div>

          <div class="auth-status-row">
            <div id="adminKeyStatus" class="status-indicator">
              <span id="keyStatusText" class="text-muted">❌ No admin key stored</span>
            </div>
            <button type="button" class="btn btn-info btn-small" onclick="testEnvironmentKeys()">
              🧪 Test Connection
            </button>
          </div>
        </div>
      </div>

      <!-- 🔐 Airdrop Password Control Section -->
      <div class="admin-card margin-bottom-30">
        <div class="card-title">🔐 Daily Airdrop Password</div>
        <p class="text-muted margin-bottom-20">Control the password users need to claim airdrops (separate from admin key)</p>

        <div class="password-control-section">
          <div class="current-password-display">
            <div class="password-info">
              <label class="form-label">Current Airdrop Password</label>
              <div id="currentPasswordDisplay" class="current-password" style="color: #25c2a0;">TODAMOON</div>
              <div id="passwordSource" class="password-source">Redis override</div>
            </div>
            <button type="button" class="btn btn-info" onclick="forceRefreshPassword();">
              🔄 Refresh
            </button>
          </div>

          <div class="password-change-group">
            <label class="form-label">Change Airdrop Password</label>
            <div class="input-button-row">
              <input type="text" id="newDailyPassword" class="form-input" placeholder="Enter new password for users">
              <button type="button" class="btn btn-primary" onclick="updateAirdropPassword()">
                ✅ Update
              </button>
            </div>
            <div class="password-actions">
              <button type="button" class="btn btn-secondary btn-small" onclick="generateDailyPassword()">
                🎲 Generate Random
              </button>
              <button type="button" class="btn btn-warning btn-small" onclick="clearPasswordOverride()">
                🔄 Reset to Default
              </button>
            </div>
          </div>

          <div id="passwordUpdateResult" class="result-display"></div>
        </div>
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">📈 Recent Activity</div>
          <div id="recentActivity" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
        <div class="admin-card">
          <div class="card-title">🚨 System Alerts</div>
          <div id="systemAlerts" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ⚠️ <strong>User Security Override</strong><br>
        Manual user blocking/unblocking for when automated fraud detection needs intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">👥 User Security Controls</div>

        <!-- Export Users Section -->
        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #25c2a0; margin-bottom: 10px;">📊 Export User Data</h4>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="exportUsersCSV()" class="btn btn-secondary">
              📥 Download CSV
            </button>
            <button onclick="exportUsersJSON()" class="btn btn-secondary">
              📥 Download JSON
            </button>
            <span style="color: #666; font-size: 0.9em;">Export all user data before reset</span>
          </div>
          <div id="exportResult" class="margin-top-10"></div>
        </div>

        <div class="form-group">
          <input type="text" id="userSearch" class="form-input" placeholder="Search by wallet address or Twitter handle...">
        </div>

        <div id="usersList" class="loading">
          <div class="spinner"></div> Loading users...
        </div>
      </div>

      <!-- Manual Security Actions -->
      <div class="admin-card margin-top-20">
        <div class="card-title">🛡️ Manual Security Actions</div>

        <div class="grid-2">
          <!-- Block User -->
          <div>
            <h4 style="color: #e74c3c; margin-bottom: 15px;">🚫 Block User</h4>
            <div class="form-group">
              <input type="text" id="blockWallet" class="form-input" placeholder="Wallet address to block">
            </div>
            <div class="form-group">
              <input type="text" id="blockReason" class="form-input" placeholder="Reason for blocking">
            </div>
            <button onclick="blockUser()" class="btn btn-danger">Block User</button>
            <div id="blockResult" class="result-message"></div>
          </div>

          <!-- Unblock User -->
          <div>
            <h4 style="color: #27ae60; margin-bottom: 15px;">✅ Unblock User</h4>
            <div class="form-group">
              <input type="text" id="unblockWallet" class="form-input" placeholder="Wallet address to unblock">
            </div>
            <div class="form-group">
              <input type="text" id="unblockReason" class="form-input" placeholder="Reason for unblocking">
            </div>
            <button onclick="unblockUser()" class="btn btn-success">Unblock User</button>
            <div id="unblockResult" class="result-message"></div>
          </div>
        </div>

        <!-- Security Check -->
        <div class="margin-top-20">
          <h4 style="color: #f39c12; margin-bottom: 15px;">🔍 Security Check</h4>
          <div class="form-group">
            <input type="text" id="checkWallet" class="form-input" placeholder="Wallet address to check">
          </div>
          <button onclick="checkUserSecurity()" class="btn btn-warning">Check Security Status</button>
          <div id="securityCheckResult" class="result-message"></div>
        </div>
      </div>
    </div>

    <!-- Airdrops Section -->
    <div id="airdrops" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ⚠️ <strong>Manual Airdrop Override</strong><br>
        Use this only when automated airdrop system fails or for emergency distributions.
      </div>

      <!-- Claimed Wallets Export -->
      <div class="admin-card margin-bottom-30">
        <div class="card-title">📊 Claimed Wallets Export</div>

        <div class="grid-2">
          <div>
            <div class="form-group">
              <label class="form-label">Export Options</label>
              <div class="button-group">
                <button type="button" class="btn btn-primary" onclick="exportClaimedWallets()">
                  📥 Download CSV Spreadsheet
                </button>
                <button type="button" class="btn btn-secondary" onclick="viewClaimedWallets()">
                  👁️ View Claimed List
                </button>
              </div>
              <small class="help-text">
                Export all wallets that have claimed airdrops for analysis
              </small>
            </div>
          </div>

          <div>
            <div id="claimedWalletsInfo" class="info-display">
              <div class="stat-item">
                <span class="stat-label">Total Claimed:</span>
                <span id="totalClaimedCount" class="stat-value">Loading...</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Manual Airdrops:</span>
                <span id="manualCount" class="stat-value">Loading...</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Regular Claims:</span>
                <span id="regularCount" class="stat-value">Loading...</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Remaining:</span>
                <span id="remainingCount" class="stat-value">Loading...</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Last Updated:</span>
                <span id="lastUpdated" class="stat-value">Never</span>
              </div>
            </div>
          </div>
        </div>

        <div id="claimedWalletsList" style="display:none; margin-top:20px;">
          <div class="card-title">📋 Claimed Wallets List</div>

          <!-- Add Missing Wallet Section -->
          <div style="margin-bottom:15px; padding:10px; background:#333; border-radius:6px;">
            <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">➕ Add Missing Wallet</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <input type="text" id="missingWalletAddress" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
                     style="flex:1; padding:6px; background:#222; border:1px solid #555; color:white; border-radius:4px; font-family:monospace; font-size:12px;">
              <input type="text" id="missingWalletReason" placeholder="Reason (e.g., tracking failed yesterday)"
                     style="flex:1; padding:6px; background:#222; border:1px solid #555; color:white; border-radius:4px; font-size:12px;">
              <button type="button" onclick="addMissingWallet()"
                      style="padding:6px 12px; background:#25c2a0; color:white; border:none; border-radius:4px; font-size:12px; cursor:pointer;">
                Add to Tracking
              </button>
            </div>
            <div style="font-size:10px; color:#666; margin-top:5px;">
              Use this to add wallets that received airdrops but aren't in the tracking system
            </div>
          </div>

          <div id="walletsTableContainer" style="max-height:300px; overflow-y:auto; border:1px solid #444; border-radius:6px; padding:10px;">
            <!-- Wallets list will be populated here -->
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">🎁 Emergency Airdrop</div>

          <form id="airdropForm">
            <div class="form-group">
              <label class="form-label">Wallet Address</label>
              <input type="text" id="airdropWallet" class="form-input" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" required>
            </div>

            <div class="form-group">
              <label class="form-label">Amount (WALDO)</label>
              <input type="number" id="airdropAmount" class="form-input" placeholder="1000" min="1" max="1000000" required>
            </div>

            <div class="form-group">
              <label class="form-label">Reason (Required for manual override)</label>
              <input type="text" id="airdropReason" class="form-input" placeholder="e.g., Automated system failed, emergency distribution" required>
            </div>

            <button type="submit" class="btn btn-warning">⚠️ Manual Override Send</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">📊 Airdrop Statistics</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="airdropsClaimed">-</div>
              <div class="stat-label">Claims / 1000</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="airdropsRemaining">-</div>
              <div class="stat-label">Remaining</div>
            </div>
          </div>

          <div id="airdropHistory" class="loading">
            <div class="spinner"></div> Loading history...
          </div>
        </div>
      </div>

      <!-- Reset Airdrop Section -->
      <div class="admin-card" style="border: 2px solid #e74c3c; background: #2a1f1f;">
        <div class="card-title" style="color: #e74c3c;">🔄 Reset Airdrop System</div>

        <div class="alert alert-warning margin-bottom-15">
          ⚠️ <strong>DANGER:</strong> This will reset the airdrop counter to 0/1000 and clear all claimed wallets. Use only for testing or official launch preparation.
        </div>

        <div class="margin-bottom-15">
          <strong>What gets reset:</strong>
          <ul style="margin: 10px 0; padding-left: 20px; color: #ccc;">
            <li>Airdrop counter: Reset to 0/1000</li>
            <li>Claimed wallets: All cleared</li>
            <li>Password override: Cleared (back to WALDOCREW)</li>
          </ul>
        </div>

        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <button onclick="resetAirdropSystem()" class="btn" style="background: #e74c3c; color: white; border: none;">
            🔄 Reset Airdrop System
          </button>
          <span style="color: #ff6b6b; font-size: 0.9em; font-weight: bold;">⚠️ This action cannot be undone!</span>
        </div>

        <div id="resetResult" class="margin-top-15"></div>
      </div>

      <!-- Airdrop Configuration Controls -->
      <div class="admin-card" style="border: 2px solid #3498db; background: #1a2332;">
        <div class="card-title" style="color: #3498db;">⚙️ Airdrop Configuration Controls</div>

        <div class="margin-bottom-20">
          <h4 style="color: #3498db; margin-bottom: 10px;">📊 Current Airdrop Settings</h4>
          <div id="currentAirdropConfig" class="margin-bottom-15">
            <div style="color: #666; font-style: italic;">Loading current configuration...</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #3498db; margin-bottom: 15px;">🔧 Update Airdrop Limits</h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Maximum Wallets:</label>
              <input type="number" id="maxWallets" class="form-input" min="100" max="100000" step="100" placeholder="1000">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 1000 wallets</div>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Duration (days):</label>
              <input type="number" id="airdropDays" class="form-input" min="1" max="365" step="1" placeholder="5">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 5 days</div>
            </div>
          </div>

          <div class="margin-bottom-15">
            <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for Change:</label>
            <input type="text" id="configChangeReason" class="form-input" placeholder="e.g., High demand, Extended promotion, Contest event" maxlength="100">
          </div>

          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="updateAirdropConfig()" class="btn" style="background: #3498db; color: white;">
              ⚙️ Update Configuration
            </button>
            <button onclick="resetToDefaults()" class="btn" style="background: #95a5a6; color: white;">
              🔄 Reset to Defaults
            </button>
          </div>

          <div id="configResult" class="margin-top-15"></div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #3498db; margin-bottom: 10px;">🚀 Quick Configuration Presets</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="setQuickConfig(2000, 10, 'Extended Launch')" class="btn btn-secondary" style="font-size: 0.9em;">
              🚀 Extended Launch (2K wallets, 10 days)
            </button>
            <button onclick="setQuickConfig(5000, 14, 'Major Promotion')" class="btn btn-secondary" style="font-size: 0.9em;">
              🎯 Major Promo (5K wallets, 14 days)
            </button>
            <button onclick="setQuickConfig(10000, 30, 'Mega Campaign')" class="btn btn-secondary" style="font-size: 0.9em;">
              💎 Mega Campaign (10K wallets, 30 days)
            </button>
            <button onclick="setQuickConfig(500, 3, 'Limited Flash')" class="btn btn-secondary" style="font-size: 0.9em;">
              ⚡ Flash Drop (500 wallets, 3 days)
            </button>
          </div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #3498db; margin-bottom: 10px;">📈 Configuration History</h4>
          <div id="configHistory" style="max-height: 200px; overflow-y: auto;">
            <div style="color: #666; font-style: italic;">No configuration changes yet</div>
          </div>
        </div>

        <div class="alert alert-info">
          💡 <strong>Note:</strong> Configuration changes take effect immediately. Users will see updated limits in real-time. All changes are logged for audit purposes.
        </div>
      </div>

      <!-- Minimum WALDO Requirements Control -->
      <div class="admin-card" style="border: 2px solid #e74c3c; background: #2a1616;">
        <div class="card-title" style="color: #e74c3c;">💰 Minimum WALDO Requirements</div>

        <div class="margin-bottom-20">
          <h4 style="color: #e74c3c; margin-bottom: 10px;">📊 Current Requirements</h4>
          <div id="currentWaldoRequirements" class="margin-bottom-15">
            <div style="color: #666; font-style: italic;">Loading current requirements...</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #e74c3c; margin-bottom: 15px;">⚙️ Update Minimum Requirements</h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for Meme Rewards:</label>
              <input type="number" id="minWaldoMemes" class="form-input" min="0" max="100000" step="100" placeholder="6000">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 6000 WALDO (6 XRP worth)</div>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for Battles:</label>
              <input type="number" id="minWaldoBattles" class="form-input" min="0" max="100000" step="100" placeholder="6000">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 6000 WALDO (6 XRP worth)</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Minimum WALDO for DAO Voting:</label>
              <input type="number" id="minWaldoDAO" class="form-input" min="0" max="100000" step="100" placeholder="100">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 100 WALDO</div>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">WALDO per XRP Rate:</label>
              <input type="number" id="waldoPerXrp" class="form-input" min="1" max="10000" step="1" placeholder="1000">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 1000 WALDO per XRP</div>
            </div>
          </div>

          <div class="margin-bottom-15">
            <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for Change:</label>
            <input type="text" id="requirementChangeReason" class="form-input" placeholder="e.g., Market adjustment, Anti-spam measure, Economic rebalancing" maxlength="100">
          </div>

          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="updateWaldoRequirements()" class="btn" style="background: #e74c3c; color: white;">
              💰 Update Requirements
            </button>
            <button onclick="resetWaldoRequirements()" class="btn" style="background: #95a5a6; color: white;">
              🔄 Reset to Defaults
            </button>
          </div>

          <div id="requirementResult" class="margin-top-15"></div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #e74c3c; margin-bottom: 10px;">🚀 Quick Requirement Presets</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="setQuickRequirement('launch', 6000, 6000, 100)" class="btn btn-secondary" style="font-size: 0.9em;">
              🚀 Launch (6K WALDO)
            </button>
            <button onclick="setQuickRequirement('growth', 3000, 3000, 50)" class="btn btn-secondary" style="font-size: 0.9em;">
              📈 Growth (3K WALDO)
            </button>
            <button onclick="setQuickRequirement('premium', 10000, 10000, 500)" class="btn btn-secondary" style="font-size: 0.9em;">
              💎 Premium (10K WALDO)
            </button>
            <button onclick="setQuickRequirement('open', 0, 0, 0)" class="btn btn-secondary" style="font-size: 0.9em;">
              🌍 Open Access (No Min)
            </button>
          </div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #e74c3c; margin-bottom: 10px;">📈 Requirement History</h4>
          <div id="requirementHistory" style="max-height: 200px; overflow-y: auto;">
            <div style="color: #666; font-style: italic;">No requirement changes yet</div>
          </div>
        </div>

        <div class="alert alert-info">
          💡 <strong>How it works:</strong> Users need minimum WALDO balance to claim meme rewards, start battles, and vote in DAO. Airdrop users get 50,000 WALDO (well above minimums). Changes apply immediately.
        </div>
      </div>

      <!-- Daily Meme Limits Control -->
      <div class="admin-card" style="border: 2px solid #e67e22; background: #2a1f16;">
        <div class="card-title" style="color: #e67e22;">🎭 Daily Meme Limits Control</div>

        <div class="margin-bottom-20">
          <h4 style="color: #e67e22; margin-bottom: 10px;">📊 Current Meme Limits</h4>
          <div id="currentMemeLimits" class="margin-bottom-15">
            <div style="color: #666; font-style: italic;">Loading current meme limits...</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #e67e22; margin-bottom: 15px;">⚙️ Update Meme Limits</h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Daily Memes per User:</label>
              <input type="number" id="dailyMemeLimit" class="form-input" min="1" max="100" step="1" placeholder="10">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 10 memes per day</div>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Premium User Limit:</label>
              <input type="number" id="premiumMemeLimit" class="form-input" min="1" max="200" step="1" placeholder="25">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 25 memes per day (10K+ WALDO holders)</div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">VIP User Limit:</label>
              <input type="number" id="vipMemeLimit" class="form-input" min="1" max="500" step="1" placeholder="50">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 50 memes per day (50K+ WALDO holders)</div>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reset Time (UTC Hour):</label>
              <input type="number" id="resetHour" class="form-input" min="0" max="23" step="1" placeholder="0">
              <div style="color: #666; font-size: 0.8em; margin-top: 3px;">Current: 0 (midnight UTC)</div>
            </div>
          </div>

          <div class="margin-bottom-15">
            <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Reason for Change:</label>
            <input type="text" id="memeLimitChangeReason" class="form-input" placeholder="e.g., Spam prevention, Quality control, Event adjustment" maxlength="100">
          </div>

          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="updateMemeLimits()" class="btn" style="background: #e67e22; color: white;">
              🎭 Update Limits
            </button>
            <button onclick="resetMemeLimits()" class="btn" style="background: #95a5a6; color: white;">
              🔄 Reset to Defaults
            </button>
            <button onclick="viewMemeUsage()" class="btn btn-secondary">
              📊 View Usage Stats
            </button>
          </div>

          <div id="memeLimitResult" class="margin-top-15"></div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #e67e22; margin-bottom: 10px;">🚀 Quick Limit Presets</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="setQuickMemeLimit('strict', 5, 15, 30)" class="btn btn-secondary" style="font-size: 0.9em;">
              🔒 Strict (5/15/30)
            </button>
            <button onclick="setQuickMemeLimit('balanced', 10, 25, 50)" class="btn btn-secondary" style="font-size: 0.9em;">
              ⚖️ Balanced (10/25/50)
            </button>
            <button onclick="setQuickMemeLimit('generous', 20, 50, 100)" class="btn btn-secondary" style="font-size: 0.9em;">
              🎉 Generous (20/50/100)
            </button>
            <button onclick="setQuickMemeLimit('unlimited', 1000, 1000, 1000)" class="btn btn-secondary" style="font-size: 0.9em;">
              ♾️ Unlimited (1000 each)
            </button>
          </div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #e67e22; margin-bottom: 10px;">📈 Recent Limit Changes</h4>
          <div id="memeLimitHistory" style="max-height: 200px; overflow-y: auto;">
            <div style="color: #666; font-style: italic;">No limit changes yet</div>
          </div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #e67e22; margin-bottom: 10px;">🔍 User Meme Usage Lookup</h4>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="lookupWallet" class="form-input" placeholder="Enter wallet address" style="flex: 1;">
            <button onclick="lookupUserMemeUsage()" class="btn btn-secondary">
              🔍 Check Usage
            </button>
          </div>
          <div id="memeUsageResult" class="margin-top-10"></div>
        </div>

        <div class="alert alert-info">
          🎭 <strong>How it works:</strong> Users can post limited memes per day based on their WALDO holdings. Limits reset at midnight UTC. Premium/VIP users get higher limits for holding more WALDO.
        </div>
      </div>

      <!-- AI Fraud Detection System -->
      <div class="admin-card" style="border: 2px solid #9b59b6; background: #2a1a2a;">
        <div class="card-title" style="color: #9b59b6;">🤖 AI Fraud Detection System</div>

        <div class="margin-bottom-20">
          <h4 style="color: #9b59b6; margin-bottom: 10px;">📊 Real-Time Fraud Analytics</h4>
          <div id="fraudAnalytics" class="margin-bottom-15">
            <div style="color: #666; font-style: italic;">Loading fraud detection analytics...</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #9b59b6; margin-bottom: 15px;">🚨 Recent Violations</h4>
          <div id="recentViolations" style="max-height: 300px; overflow-y: auto;">
            <div style="color: #666; font-style: italic;">Loading recent violations...</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #9b59b6; margin-bottom: 15px;">🔍 Suspicious Activity Monitor</h4>
          <div id="suspiciousActivity" style="max-height: 250px; overflow-y: auto;">
            <div style="color: #666; font-style: italic;">Loading suspicious activity...</div>
          </div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #9b59b6; margin-bottom: 10px;">⚙️ Fraud Detection Controls</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="refreshFraudData()" class="btn" style="background: #9b59b6; color: white;">
              🔄 Refresh Data
            </button>
            <button onclick="exportViolations()" class="btn btn-secondary">
              📥 Export Violations
            </button>
            <button onclick="clearOldViolations()" class="btn" style="background: #e67e22; color: white;">
              🗑️ Clear Old Data
            </button>
            <button onclick="adjustSensitivity()" class="btn btn-secondary">
              🎛️ Adjust Sensitivity
            </button>
          </div>
        </div>

        <div class="alert alert-info">
          🤖 <strong>AI System Active:</strong> Advanced bot detection, behavioral analysis, timing patterns, IP reputation, and automated blocking. 3 violations = 7-day auto-block.
        </div>
      </div>

      <!-- Bonus Control System -->
      <div class="admin-card" style="border: 2px solid #f39c12; background: #2a2416;">
        <div class="card-title" style="color: #f39c12;">🎁 Reward Bonus Control System</div>

        <div class="margin-bottom-20">
          <h4 style="color: #f39c12; margin-bottom: 10px;">🚀 Active Bonus Multipliers</h4>
          <div id="activeBonuses" class="margin-bottom-15">
            <div style="color: #666; font-style: italic;">No active bonuses - all rewards at base rates</div>
          </div>
        </div>

        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #f39c12; margin-bottom: 15px;">⚡ Set New Bonus</h4>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Bonus Type:</label>
              <select id="bonusType" class="form-input">
                <option value="all">All Rewards (Global)</option>
                <option value="meme">Meme Rewards Only</option>
                <option value="battle">Battle Rewards Only</option>
                <option value="referral">Referral Rewards Only</option>
                <option value="staking">Staking Rewards Only</option>
              </select>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Multiplier:</label>
              <select id="bonusMultiplier" class="form-input">
                <option value="1.5">1.5x (50% bonus)</option>
                <option value="2">2x (Double rewards)</option>
                <option value="2.5">2.5x (150% bonus)</option>
                <option value="3">3x (Triple rewards)</option>
                <option value="5">5x (500% bonus)</option>
                <option value="10">10x (1000% bonus)</option>
              </select>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Duration (hours):</label>
              <select id="bonusDuration" class="form-input">
                <option value="1">1 Hour</option>
                <option value="6">6 Hours</option>
                <option value="12">12 Hours</option>
                <option value="24">24 Hours (1 Day)</option>
                <option value="48">48 Hours (2 Days)</option>
                <option value="72">72 Hours (3 Days)</option>
                <option value="168">168 Hours (1 Week)</option>
                <option value="0">Permanent (until manually removed)</option>
              </select>
            </div>

            <div>
              <label style="color: #ccc; font-size: 0.9em; margin-bottom: 5px; display: block;">Event Name:</label>
              <input type="text" id="bonusName" class="form-input" placeholder="e.g., Weekend Bonus, Contest Event" maxlength="50">
            </div>
          </div>

          <div style="display: flex; gap: 10px; align-items: center;">
            <button onclick="setBonusMultiplier()" class="btn" style="background: #f39c12; color: white;">
              🚀 Activate Bonus
            </button>
            <button onclick="clearAllBonuses()" class="btn" style="background: #e74c3c; color: white;">
              🗑️ Clear All Bonuses
            </button>
          </div>

          <div id="bonusResult" class="margin-top-15"></div>
        </div>

        <div class="margin-bottom-15">
          <h4 style="color: #f39c12; margin-bottom: 10px;">📊 Quick Bonus Presets</h4>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="setQuickBonus('weekend', 2, 48)" class="btn btn-secondary" style="font-size: 0.9em;">
              🌟 Weekend 2x (48h)
            </button>
            <button onclick="setQuickBonus('contest', 5, 24)" class="btn btn-secondary" style="font-size: 0.9em;">
              🏆 Contest 5x (24h)
            </button>
            <button onclick="setQuickBonus('flash', 10, 1)" class="btn btn-secondary" style="font-size: 0.9em;">
              ⚡ Flash 10x (1h)
            </button>
            <button onclick="setQuickBonus('launch', 3, 72)" class="btn btn-secondary" style="font-size: 0.9em;">
              🚀 Launch 3x (72h)
            </button>
          </div>
        </div>

        <div class="alert alert-info">
          💡 <strong>How it works:</strong> Bonuses multiply the base reward amounts. Users will see the bonus in their reward notifications. All bonuses are logged and can be reverted instantly.
        </div>
      </div>
    </div>

    <!-- Battles Section -->
    <div id="battles" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ⚠️ <strong>Battle Emergency Controls</strong><br>
        Use these controls only when automated battle system malfunctions or requires manual intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">⚔️ Battle Override Controls</div>

        <div class="grid-2">
          <div>
            <h3 class="section-title">Current Battle Status</h3>
            <div id="currentBattle" class="loading">
              <div class="spinner"></div> Loading...
            </div>
          </div>

          <div>
            <h3 class="section-title">Emergency Controls</h3>
            <div class="alert alert-error alert-small">
              ⚠️ These actions cannot be undone and will affect active users
            </div>
            <button type="button" class="btn btn-warning" onclick="endCurrentBattle()">⏹️ Force End Battle</button>
            <button type="button" class="btn btn-danger" onclick="cancelCurrentBattle()">❌ Emergency Cancel</button>
          </div>
        </div>

        <h3 class="section-title-spaced">Recent Battles</h3>
        <div id="battleHistory" class="loading">
          <div class="spinner"></div> Loading battle history...
        </div>
      </div>
    </div>

    <!-- Staking Section -->
    <div id="staking" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ⚠️ <strong>Staking Emergency Controls</strong><br>
        Manual unstaking is a backup mechanism for when automated functions fail. Use with caution.
      </div>

      <div class="grid-2">
        <!-- Staking Overview -->
        <div class="admin-card">
          <div class="card-title">🏦 Staking Overview</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalStakingPositions">-</div>
              <div class="stat-label">Active Stakes</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalStakingValue">-</div>
              <div class="stat-label">Total Value</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalStakingRewards">-</div>
              <div class="stat-label">Total Rewards</div>
            </div>
          </div>

          <div id="stakingPositions" class="loading">
            <div class="spinner"></div> Loading staking positions...
          </div>
        </div>

        <!-- Manual Unstaking Controls -->
        <div class="admin-card">
          <div class="card-title">🔓 Manual Unstaking</div>

          <div class="margin-bottom-20">
            <label class="form-label">User Wallet Address</label>
            <input type="text" id="unstakeWalletAddress" class="form-input margin-bottom-10"
                   placeholder="rWalletAddress...">
            <button type="button" onclick="loadUserStakes()" class="btn btn-secondary width-100">
              🔍 Load User Stakes
            </button>
          </div>

          <div id="userStakesContainer" style="display: none;">
            <div class="form-group">
              <label class="form-label">Select Stake to Unstake</label>
              <select id="stakeSelector" class="form-input">
                <option value="">Select a stake...</option>
              </select>
            </div>

            <div id="stakeDetails" class="stake-details">
              <div class="stake-detail-row">
                <span>Amount:</span>
                <span id="stakeAmount">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Duration:</span>
                <span id="stakeDuration">-</span>
              </div>
              <div class="stake-detail-row">
                <span>APY:</span>
                <span id="stakeAPY">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Unlock Date:</span>
                <span id="stakeUnlockDate">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Current Rewards:</span>
                <span id="stakeRewards">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Status:</span>
                <span id="stakeStatus">-</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="forceUnstake" class="checkbox-margin">
                Force Early Unstaking (15% penalty will apply)
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">Admin Reason (Required)</label>
              <textarea id="unstakeReason" class="form-input" rows="3"
                        placeholder="Explain why manual unstaking is necessary..."></textarea>
            </div>

            <button type="button" onclick="executeManualUnstake()" class="btn btn-danger width-100">
              🔓 Execute Manual Unstake
            </button>
          </div>

          <div id="unstakeResult" class="margin-top-15"></div>
        </div>
      </div>
    </div>

    <!-- Security Section -->
    <div id="security" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">🛡️ Security Monitoring</div>

          <div id="securityAlerts" class="loading">
            <div class="spinner"></div> Loading security data...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">🚨 Fraud Detection</div>

          <div class="form-group">
            <label class="form-label">Check Wallet</label>
            <input type="text" id="securityWallet" class="form-input" placeholder="Enter wallet address">
            <button type="button" class="btn margin-top-10" onclick="checkWalletSecurity()">🔍 Check Security</button>
          </div>

          <div id="securityResults"></div>
        </div>
      </div>
    </div>

    <!-- DAO Section -->
    <div id="dao" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">🗳️ Create DAO Proposal</div>

          <form id="daoForm">
            <div class="form-group">
              <label class="form-label">Proposal Title</label>
              <input type="text" id="daoTitle" class="form-input" placeholder="Enter proposal title" required>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea id="daoDescription" class="form-input form-textarea" placeholder="Describe the proposal..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Options (comma-separated)</label>
              <input type="text" id="daoOptions" class="form-input" placeholder="Yes, No" required>
            </div>

            <div class="form-group">
              <label class="form-label">Duration (hours)</label>
              <input type="number" id="daoDuration" class="form-input" placeholder="72" min="1" required>
            </div>

            <button type="submit" class="btn">📨 Create Proposal</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">📋 Active Proposals</div>

          <div id="daoProposals" class="loading">
            <div class="spinner"></div> Loading proposals...
          </div>
        </div>
      </div>
    </div>

    <!-- System Section -->
    <div id="system" class="admin-section">
      <div class="alert alert-error margin-bottom-20">
        🚨 <strong>EMERGENCY SYSTEM CONTROLS</strong><br>
        These controls can affect the entire WALDOCOIN system. Use only in critical situations.
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">⚙️ System Health Monitor</div>

          <div id="systemHealth" class="loading">
            <div class="spinner"></div> Checking system health...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">🚨 Emergency Controls</div>

          <div class="alert alert-warning alert-small">
            ⚠️ These actions affect all users and cannot be easily undone
          </div>

          <div class="emergency-controls">
            <button type="button" class="btn" onclick="refreshAllData()">🔄 Force Data Refresh</button>
            <button type="button" class="btn btn-warning" onclick="clearCache()">🗑️ Emergency Cache Clear</button>
            <button type="button" class="btn btn-danger" onclick="emergencyStop()">🛑 SYSTEM EMERGENCY STOP</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Production Configuration
    const API_BASE = "https://waldocoin-backend-api.onrender.com";
    const ADMIN_WALLET = "rJGYLktGg1FgAa4t2yfA8tnyMUGsyxofUC"; // WALDO distributor wallet (matches backend)
    let currentSection = 'dashboard';
    let isAuthenticated = false;

    // Login Functions
    async function attemptLogin() {
      const password = document.getElementById('loginPassword').value.trim();
      const loginError = document.getElementById('loginError');

      if (!password) {
        showLoginError('Please enter a password');
        return;
      }

      try {
        // Debug: Log the password being sent
        console.log('Attempting login with password:', password);
        console.log('API_BASE:', API_BASE);

        // Use verify-admin endpoint for authentication
        const response = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          method: 'GET',
          headers: {
            'x-admin-key': password,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.log('Error response:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('Login response:', data);

        if (data.success) {
          // Admin authentication successful
          localStorage.setItem('adminKey', password);
          isAuthenticated = true;

          // Hide login screen and show admin panel
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('adminPanel').classList.remove('hidden');

          // Load dashboard by default
          showSection('dashboard', null);

          hideLoginError();

          // Show success message
          console.log('Admin login successful!', data.message);
        } else {
          showLoginError(`Invalid admin password. Error: ${data.error || 'Unknown error'}`);
          console.log('Login failed:', data);
        }
      } catch (error) {
        console.error('Login error:', error);
        showLoginError(`Connection failed: ${error.message}. Check if backend is running.`);
      }
    }

    function handleLoginKeypress(event) {
      if (event.key === 'Enter') {
        attemptLogin();
      }
    }

    // 💰 WALDO Requirements Control Functions
    async function loadWaldoRequirements() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/waldo-requirements`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const requirementsDiv = document.getElementById('currentWaldoRequirements');

        if (data.success) {
          const req = data.requirements;
          requirementsDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e74c3c;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Meme Rewards</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.memeRewards.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.memeRewards / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Battle Participation</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.battles.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.battles / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
              </div>
              <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">DAO Voting</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.daoVoting.toLocaleString()} WALDO</div>
                  <div style="color: #666; font-size: 0.9em;">${(req.daoVoting / req.waldoPerXrp).toFixed(1)} XRP worth</div>
                </div>
                <div>
                  <div style="color: #e74c3c; font-weight: bold;">Exchange Rate</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${req.waldoPerXrp.toLocaleString()} WALDO/XRP</div>
                  <div style="color: #666; font-size: 0.9em;">1 XRP = ${req.waldoPerXrp} WALDO</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('minWaldoMemes').placeholder = req.memeRewards;
          document.getElementById('minWaldoBattles').placeholder = req.battles;
          document.getElementById('minWaldoDAO').placeholder = req.daoVoting;
          document.getElementById('waldoPerXrp').placeholder = req.waldoPerXrp;
        } else {
          requirementsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading requirements</div>';
        }
      } catch (error) {
        console.error('Error loading WALDO requirements:', error);
        document.getElementById('currentWaldoRequirements').innerHTML = '<div style="color: #e74c3c;">Error loading requirements</div>';
      }
    }

    async function updateWaldoRequirements() {
      const minWaldoMemes = parseInt(document.getElementById('minWaldoMemes').value);
      const minWaldoBattles = parseInt(document.getElementById('minWaldoBattles').value);
      const minWaldoDAO = parseInt(document.getElementById('minWaldoDAO').value);
      const waldoPerXrp = parseInt(document.getElementById('waldoPerXrp').value);
      const reason = document.getElementById('requirementChangeReason').value.trim();

      if (!minWaldoMemes && !minWaldoBattles && !minWaldoDAO && !waldoPerXrp) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      const resultDiv = document.getElementById('requirementResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">💰 Updating WALDO requirements...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/update-waldo-requirements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            memeRewards: minWaldoMemes || undefined,
            battles: minWaldoBattles || undefined,
            daoVoting: minWaldoDAO || undefined,
            waldoPerXrp: waldoPerXrp || undefined,
            reason: reason || 'Admin requirement update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Requirements updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' • ')}
            </div>
          `;

          // Clear form
          document.getElementById('minWaldoMemes').value = '';
          document.getElementById('minWaldoBattles').value = '';
          document.getElementById('minWaldoDAO').value = '';
          document.getElementById('waldoPerXrp').value = '';
          document.getElementById('requirementChangeReason').value = '';

          // Refresh displays
          loadWaldoRequirements();
          loadRequirementHistory();
          showAlert('WALDO requirements updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update requirements: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update requirements error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error updating requirements</div>';
        showAlert('Network error updating requirements', 'error');
      }
    }

    async function resetWaldoRequirements() {
      const confirm = window.confirm('⚠️ Reset WALDO requirements to defaults?\n\n• Meme Rewards: 6000 WALDO (6 XRP)\n• Battles: 6000 WALDO (6 XRP)\n• DAO Voting: 100 WALDO\n• Rate: 1000 WALDO per XRP\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/reset-waldo-requirements`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default requirements'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('requirementResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Requirements reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              6000 WALDO for memes/battles • 100 WALDO for DAO • 1000 WALDO/XRP
            </div>
          `;

          loadWaldoRequirements();
          loadRequirementHistory();
          showAlert('Requirements reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset requirements error:', error);
        showAlert('Network error resetting requirements', 'error');
      }
    }

    function setQuickRequirement(preset, memes, battles, dao) {
      let eventName, waldoPerXrp = 1000;

      switch(preset) {
        case 'launch':
          eventName = 'Launch Configuration';
          break;
        case 'growth':
          eventName = 'Growth Phase';
          break;
        case 'premium':
          eventName = 'Premium Access';
          break;
        case 'open':
          eventName = 'Open Access';
          break;
      }

      // Set the form values
      document.getElementById('minWaldoMemes').value = memes;
      document.getElementById('minWaldoBattles').value = battles;
      document.getElementById('minWaldoDAO').value = dao;
      document.getElementById('waldoPerXrp').value = waldoPerXrp;
      document.getElementById('requirementChangeReason').value = eventName;

      // Auto-update
      updateWaldoRequirements();
    }

    async function loadRequirementHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/requirement-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('requirementHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #e74c3c;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #e74c3c;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' • ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No requirement changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading requirement history:', error);
        document.getElementById('requirementHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    // ⚙️ Airdrop Configuration Functions
    async function loadAirdropConfig() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/config`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const configDiv = document.getElementById('currentAirdropConfig');

        if (data.success) {
          const config = data.config;
          const endDate = new Date(config.endDate).toLocaleDateString();
          const daysRemaining = Math.ceil((new Date(config.endDate) - new Date()) / (1000 * 60 * 60 * 24));

          configDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #3498db;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: #3498db; font-weight: bold;">Wallet Limit</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${config.claimed}/${config.maxWallets}</div>
                  <div style="color: #666; font-size: 0.9em;">${config.maxWallets - config.claimed} remaining</div>
                </div>
                <div>
                  <div style="color: #3498db; font-weight: bold;">Duration</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${daysRemaining} days left</div>
                  <div style="color: #666; font-size: 0.9em;">Ends: ${endDate}</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('maxWallets').placeholder = config.maxWallets;
          document.getElementById('airdropDays').placeholder = Math.ceil(config.durationDays);
        } else {
          configDiv.innerHTML = '<div style="color: #e74c3c;">Error loading configuration</div>';
        }
      } catch (error) {
        console.error('Error loading airdrop config:', error);
        document.getElementById('currentAirdropConfig').innerHTML = '<div style="color: #e74c3c;">Error loading configuration</div>';
      }
    }

    async function updateAirdropConfig() {
      const maxWallets = parseInt(document.getElementById('maxWallets').value);
      const airdropDays = parseInt(document.getElementById('airdropDays').value);
      const reason = document.getElementById('configChangeReason').value.trim();

      if (!maxWallets && !airdropDays) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      if (maxWallets && (maxWallets < 100 || maxWallets > 100000)) {
        showAlert('Wallet limit must be between 100 and 100,000', 'error');
        return;
      }

      if (airdropDays && (airdropDays < 1 || airdropDays > 365)) {
        showAlert('Duration must be between 1 and 365 days', 'error');
        return;
      }

      const resultDiv = document.getElementById('configResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">⚙️ Updating airdrop configuration...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/update-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            maxWallets: maxWallets || undefined,
            durationDays: airdropDays || undefined,
            reason: reason || 'Admin configuration update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Configuration updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' • ')}
            </div>
          `;

          // Clear form
          document.getElementById('maxWallets').value = '';
          document.getElementById('airdropDays').value = '';
          document.getElementById('configChangeReason').value = '';

          // Refresh displays
          loadAirdropConfig();
          loadConfigHistory();
          showAlert('Airdrop configuration updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update configuration: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Config update error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error updating configuration</div>';
        showAlert('Network error updating configuration', 'error');
      }
    }

    async function resetToDefaults() {
      const confirm = window.confirm('⚠️ Reset airdrop configuration to defaults?\n\n• 1000 wallet limit\n• 5 day duration\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset-config`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default configuration'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('configResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Configuration reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              1000 wallet limit • 5 day duration
            </div>
          `;

          loadAirdropConfig();
          loadConfigHistory();
          showAlert('Configuration reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset config error:', error);
        showAlert('Network error resetting configuration', 'error');
      }
    }

    function setQuickConfig(wallets, days, eventName) {
      // Set the form values
      document.getElementById('maxWallets').value = wallets;
      document.getElementById('airdropDays').value = days;
      document.getElementById('configChangeReason').value = eventName;

      // Auto-update
      updateAirdropConfig();
    }

    async function loadConfigHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/config-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('configHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #3498db;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #3498db;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' • ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No configuration changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading config history:', error);
        document.getElementById('configHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    // 🎁 Bonus Control System Functions
    async function setBonusMultiplier() {
      const bonusType = document.getElementById('bonusType').value;
      const multiplier = parseFloat(document.getElementById('bonusMultiplier').value);
      const duration = parseInt(document.getElementById('bonusDuration').value);
      const eventName = document.getElementById('bonusName').value.trim() || 'Admin Bonus';

      const resultDiv = document.getElementById('bonusResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">🚀 Setting bonus multiplier...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/set-bonus`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            type: bonusType,
            multiplier: multiplier,
            duration: duration,
            eventName: eventName
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Bonus activated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${eventName}: ${multiplier}x multiplier for ${bonusType} rewards
              ${duration > 0 ? `(expires in ${duration} hours)` : '(permanent)'}
            </div>
          `;

          // Refresh active bonuses display
          loadActiveBonuses();
          showAlert(`Bonus activated: ${eventName} (${multiplier}x)`, 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Failed to set bonus: ${data.error}</div>`;
          showAlert(`Failed to set bonus: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Bonus error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error setting bonus</div>';
        showAlert('Network error setting bonus', 'error');
      }
    }

    async function clearAllBonuses() {
      const confirm = window.confirm('⚠️ Are you sure you want to clear ALL active bonuses?\n\nThis will revert all rewards back to base rates.');
      if (!confirm) return;

      const resultDiv = document.getElementById('bonusResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">🗑️ Clearing all bonuses...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/clear-bonuses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ All bonuses cleared!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              All rewards reverted to base rates. ${data.clearedCount || 0} bonuses removed.
            </div>
          `;

          // Refresh active bonuses display
          loadActiveBonuses();
          showAlert('All bonuses cleared - back to base rates', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Failed to clear bonuses: ${data.error}</div>`;
          showAlert(`Failed to clear bonuses: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear bonuses error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error clearing bonuses</div>';
        showAlert('Network error clearing bonuses', 'error');
      }
    }

    function setQuickBonus(preset, multiplier, duration) {
      let eventName, bonusType;

      switch(preset) {
        case 'weekend':
          eventName = 'Weekend Bonus';
          bonusType = 'all';
          break;
        case 'contest':
          eventName = 'Contest Event';
          bonusType = 'meme';
          break;
        case 'flash':
          eventName = 'Flash Bonus';
          bonusType = 'all';
          break;
        case 'launch':
          eventName = 'Launch Celebration';
          bonusType = 'all';
          break;
      }

      // Set the form values
      document.getElementById('bonusType').value = bonusType;
      document.getElementById('bonusMultiplier').value = multiplier.toString();
      document.getElementById('bonusDuration').value = duration.toString();
      document.getElementById('bonusName').value = eventName;

      // Activate the bonus
      setBonusMultiplier();
    }

    async function loadActiveBonuses() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/active-bonuses`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const bonusesDiv = document.getElementById('activeBonuses');

        if (data.success && data.bonuses && data.bonuses.length > 0) {
          let bonusesHtml = '';
          data.bonuses.forEach(bonus => {
            const expiresText = bonus.permanent ? 'Permanent' :
              `Expires: ${new Date(bonus.expiresAt).toLocaleString()}`;

            bonusesHtml += `
              <div style="background: #333; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #f39c12;">
                <div style="display: flex; justify-content: between; align-items: center;">
                  <div>
                    <strong style="color: #f39c12;">${bonus.eventName}</strong>
                    <span style="color: #27ae60; margin-left: 10px;">${bonus.multiplier}x ${bonus.type} rewards</span>
                  </div>
                  <button onclick="removeBonus('${bonus.id}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                    Remove
                  </button>
                </div>
                <div style="color: #666; font-size: 0.9em; margin-top: 5px;">${expiresText}</div>
              </div>
            `;
          });
          bonusesDiv.innerHTML = bonusesHtml;
        } else {
          bonusesDiv.innerHTML = '<div style="color: #666; font-style: italic;">No active bonuses - all rewards at base rates</div>';
        }
      } catch (error) {
        console.error('Error loading active bonuses:', error);
        document.getElementById('activeBonuses').innerHTML = '<div style="color: #e74c3c;">Error loading bonuses</div>';
      }
    }

    async function removeBonus(bonusId) {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/rewards/remove-bonus`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ bonusId: bonusId })
        });

        const data = await response.json();

        if (data.success) {
          loadActiveBonuses(); // Refresh the display
          showAlert('Bonus removed successfully', 'success');
        } else {
          showAlert(`Failed to remove bonus: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Remove bonus error:', error);
        showAlert('Network error removing bonus', 'error');
      }
    }

    // 📥 Export Users as CSV
    async function exportUsersCSV() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">📥 Exporting users to CSV...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success && data.users) {
          // Create CSV content
          const headers = [
            'Wallet Address', 'Username', 'Twitter Handle', 'XP Level', 'Total XP',
            'WALDO Balance', 'Last Active', 'Joined At', 'Battles Total', 'Battles Won',
            'Battle Votes', 'Staking Active', 'Total Staked', 'Staking Positions'
          ];

          let csvContent = headers.join(',') + '\n';

          data.users.forEach(user => {
            const row = [
              `"${user.walletAddress}"`,
              `"${user.username}"`,
              `"${user.twitterHandle || ''}"`,
              user.xpLevel,
              user.totalXP,
              user.waldoBalance,
              `"${user.lastActive}"`,
              `"${user.joinedAt}"`,
              user.battles.total,
              user.battles.won,
              user.battles.votes,
              user.staking.active,
              user.staking.totalStaked,
              user.staking.positions
            ];
            csvContent += row.join(',') + '\n';
          });

          // Download CSV
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">✅ CSV exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error during export</div>';
      }
    }

    // 📥 Export Users as JSON
    async function exportUsersJSON() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">📥 Exporting users to JSON...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Download JSON
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">✅ JSON exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error during export</div>';
      }
    }

    // 🔄 Reset Airdrop System
    async function resetAirdropSystem() {
      // Double confirmation for safety
      const firstConfirm = confirm(
        "⚠️ DANGER: This will reset the airdrop system!\n\n" +
        "• Counter will reset to 0/1000\n" +
        "• All claimed wallets will be cleared\n" +
        "• Password override will be cleared\n\n" +
        "Are you sure you want to continue?"
      );

      if (!firstConfirm) return;

      const secondConfirm = confirm(
        "🚨 FINAL WARNING!\n\n" +
        "This action CANNOT be undone!\n" +
        "All airdrop progress will be lost!\n\n" +
        "Type 'RESET' in the next dialog to confirm."
      );

      if (!secondConfirm) return;

      const typeConfirm = prompt("Type 'RESET' to confirm (case sensitive):");
      if (typeConfirm !== 'RESET') {
        showAlert('Reset cancelled - confirmation text did not match', 'warning');
        return;
      }

      const resultDiv = document.getElementById('resetResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">🔄 Resetting airdrop system...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Airdrop system reset successfully!</div>
            <div style="color: #ccc; margin-top: 10px; font-size: 0.9em;">
              • Counter: ${data.details.counter}<br>
              • Claimed wallets: ${data.details.claimedWallets}<br>
              • Password: ${data.details.passwordOverride}<br>
              • Total limit: ${data.details.totalLimit}
            </div>
          `;

          // Refresh airdrop status
          setTimeout(() => {
            loadAirdropData();
          }, 1000);

          showAlert('Airdrop system reset successfully! Ready for fresh launch.', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Reset failed: ${data.error}</div>`;
          showAlert(`Reset failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error during reset</div>';
        showAlert('Network error during reset', 'error');
      }
    }

    function showLoginError(message) {
      const loginError = document.getElementById('loginError');
      loginError.textContent = message;
      loginError.classList.remove('hidden');
    }

    function hideLoginError() {
      const loginError = document.getElementById('loginError');
      loginError.classList.add('hidden');
    }

    function logout() {
      if (confirm('Are you sure you want to logout from the admin panel?')) {
        // Clear all stored authentication data
        localStorage.removeItem('adminKey');
        localStorage.removeItem('xummWallet'); // Clear any old wallet data
        sessionStorage.clear(); // Clear session data
        isAuthenticated = false;

        // Show login screen and hide admin panel
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');

        // Clear password field and any error messages
        document.getElementById('loginPassword').value = '';
        hideLoginError();

        // Clear any test results
        const testDiv = document.getElementById('connectionTest');
        if (testDiv) testDiv.innerHTML = '';

        console.log('Logged out successfully');
      }
    }

    // Check if user is already logged in on page load
    function checkExistingLogin() {
      const savedKey = localStorage.getItem('adminKey');
      if (savedKey) {
        // Auto-login with saved key
        document.getElementById('loginPassword').value = savedKey;
        attemptLogin();
      } else {
        // Show login screen by default
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
      }
    }

    // Test backend connection
    async function testConnection() {
      const testDiv = document.getElementById('connectionTest');
      testDiv.innerHTML = '<div style="color: #f39c12;">🔄 Testing connection...</div>';

      // Test 1: Basic API connection
      try {
        const response1 = await fetch(`${API_BASE}/api/airdrop/status`);
        testDiv.innerHTML += `<div style="color: #666;">Status endpoint: ${response1.status}</div>`;

        if (response1.ok) {
          const data1 = await response1.json();
          if (data1.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">✅ Backend API: Connected</div>';
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">❌ Backend API: Error in response</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Backend API: HTTP ${response1.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Backend API: ${error.message}</div>`;
      }

      // Test 2: Try current-password endpoint
      try {
        const response2 = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Password endpoint: ${response2.status}</div>`;

        if (response2.ok) {
          const data2 = await response2.json();
          if (data2.success) {
            testDiv.innerHTML += `<div style="color: #27ae60;">✅ Password 'waldogod2025': Works</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Current password: ${data2.currentPassword}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Source: ${data2.source}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Password failed: ${data2.error}</div>`;
          }
        } else {
          const text = await response2.text();
          testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Password endpoint: HTTP ${response2.status}</div>`;
          testDiv.innerHTML += `<div style="color: #666;">Response: ${text.substring(0, 100)}...</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Password test: ${error.message}</div>`;
      }

      // Test 3: Try verify-admin endpoint
      try {
        const response3 = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Verify endpoint: ${response3.status}</div>`;

        if (response3.ok) {
          const data3 = await response3.json();
          if (data3.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">✅ Admin verification: Success</div>';
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Admin verification: ${data3.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Verify endpoint: HTTP ${response3.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Verify test: ${error.message}</div>`;
      }

      // Test 4: Debug environment variables
      try {
        const response4 = await fetch(`${API_BASE}/api/airdrop/debug-env`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });

        if (response4.ok) {
          const data4 = await response4.json();
          if (data4.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">✅ Environment debug: Success</div>';
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY set: ${data4.environment.X_ADMIN_KEY_SET}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY value: ${data4.environment.X_ADMIN_KEY_VALUE}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Environment debug: ${data4.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Debug endpoint: HTTP ${response4.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Debug test: ${error.message}</div>`;
      }

      // Test 5: Check available routes
      try {
        const response5 = await fetch(`${API_BASE}/api/routes`);

        if (response5.ok) {
          const routes = await response5.json();
          testDiv.innerHTML += '<div style="color: #27ae60;">✅ Available routes loaded</div>';

          const airdropRoutes = routes.filter(r => r.path && r.path.includes('airdrop'));
          if (airdropRoutes.length > 0) {
            testDiv.innerHTML += '<div style="color: #25c2a0;">Airdrop routes found:</div>';
            airdropRoutes.forEach(route => {
              testDiv.innerHTML += `<div style="color: #666; font-size: 0.9em;">${route.method} ${route.path}</div>`;
            });
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">❌ No airdrop routes found in backend</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Routes endpoint: HTTP ${response5.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">❌ Routes test: ${error.message}</div>`;
      }
    }

    // Authentication check - now uses password-based login
    function checkAdminAuth() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        // Show login screen instead of old modal
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
        return false;
      }
      isAuthenticated = true;
      updateAdminKeyStatus(); // Update admin key status on auth
      return true;
    }

    // Admin Key Management
    function saveAdminKey() {
      const adminKey = document.getElementById('adminKeyInput').value.trim();
      if (!adminKey) {
        showAlert('Please enter an admin key', 'error');
        return;
      }

      localStorage.setItem('adminKey', adminKey);
      document.getElementById('adminKeyInput').value = ''; // Clear input for security
      updateAdminKeyStatus();
      showAlert('Admin key saved successfully', 'success');

      // Auto-load current password when admin key is saved
      getCurrentAirdropPassword();
    }

    function clearAdminKey() {
      localStorage.removeItem('adminKey');
      updateAdminKeyStatus();
      showAlert('Admin key cleared', 'info');
    }

    function updateAdminKeyStatus() {
      const adminKey = localStorage.getItem('adminKey');
      const statusText = document.getElementById('keyStatusText');

      if (adminKey) {
        statusText.textContent = '✅ Admin key stored and ready';
        statusText.className = 'text-success';
        statusText.style.color = '#27ae60';
      } else {
        statusText.textContent = '❌ No admin key stored';
        statusText.className = 'text-muted';
        statusText.style.color = '#e74c3c';
      }
    }

    async function testEnvironmentKeys() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Test current airdrop password (should be WALDOCREW or admin override)
        const response = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: {
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('envAdminKey').textContent = data.currentPassword;
          showAlert(`Environment test successful! Current airdrop password: ${data.currentPassword}`, 'success');
        } else {
          showAlert(`Environment test failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Environment test error:', error);
        showAlert('Failed to test environment keys', 'error');
      }
    }

    // Old authentication functions removed - now using password-based login screen

    // Navigation
    function showSection(sectionName, clickedElement = null) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionName).classList.add('active');

      // Add active class to clicked button (if provided)
      if (clickedElement) {
        clickedElement.classList.add('active');
      } else {
        // Fallback: find the nav button for this section
        const navBtn = document.querySelector(`[onclick*="${sectionName}"]`);
        if (navBtn) {
          navBtn.classList.add('active');
        }
      }

      currentSection = sectionName;

      // Load section data
      loadSectionData(sectionName);

      // Load active bonuses, airdrop config, WALDO requirements, fraud data, and meme limits if on dashboard
      if (sectionName === 'dashboard') {
        loadActiveBonuses();
        loadAirdropConfig();
        loadConfigHistory();
        loadWaldoRequirements();
        loadRequirementHistory();
        loadMemeLimits();
        loadMemeLimitHistory();
        loadFraudAnalytics();
        loadRecentViolations();
        loadSuspiciousActivity();
      }
    }

    // Production-ready API call wrapper
    async function apiCall(endpoint, options = {}) {
      if (!isAuthenticated) {
        throw new Error('Authentication required');
      }

      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        throw new Error('Admin key not found');
      }

      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'x-admin-key': adminKey,
          'x-admin-wallet': ADMIN_WALLET,
          ...options.headers
        }
      };

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...defaultOptions,
          ...options
        });

        const data = await response.json();

        if (!response.ok) {
          // If backend returns error details, use them
          const errorMessage = data.error || `HTTP ${response.status}: ${response.statusText}`;
          throw new Error(errorMessage);
        }

        return data;
      } catch (error) {
        console.error(`API Error [${endpoint}]:`, error);
        throw error;
      }
    }

    // Load data for specific section with error handling
    async function loadSectionData(section) {
      if (!checkAdminAuth()) return;

      try {
        switch(section) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'users':
            await loadUsersData();
            break;
          case 'airdrops':
            await loadAirdropsData();
            break;
          case 'battles':
            await loadBattlesData();
            break;
          case 'staking':
            await loadStakingData();
            break;
          case 'security':
            await loadSecurityData();
            break;
          case 'dao':
            await loadDAOData();
            break;
          case 'system':
            await loadSystemData();
            break;
        }
      } catch (error) {
        showAlert(`Error loading ${section}: ${error.message}`, 'error');
      }
    }

    // Load trustline count independently with enhanced error handling
    async function loadTrustlineCount() {
      console.log('🔍 Loading trustline count independently...');

      // Show loading state
      const totalUsersElement = document.getElementById('totalUsers');
      totalUsersElement.textContent = '...';
      totalUsersElement.style.color = '#ffd93d';

      try {
        console.log('📡 Making API call to /api/airdrop/trustline-count');
        const trustlineData = await apiCall('/api/airdrop/trustline-count');
        console.log('✅ Trustline data received:', trustlineData);

        if (trustlineData.success) {
          const count = trustlineData.trustlineCount || '0';
          const walletsWithBalance = trustlineData.walletsWithBalance || '0';
          const totalWaldo = trustlineData.totalWaldoHeld || '0';

          console.log('📊 Setting totalUsers to:', count);
          console.log('💰 Wallets with balance:', walletsWithBalance);
          console.log('🪙 Total WALDO held:', totalWaldo);

          totalUsersElement.textContent = count;
          totalUsersElement.style.color = '#25c2a0';

          // Update tooltip or additional info if available
          totalUsersElement.title = `${count} trustlines total, ${walletsWithBalance} with balance, ${totalWaldo} WALDO held`;

          console.log('✅ totalUsers element now shows:', totalUsersElement.textContent);
          showAlert(`✅ Trustline count updated: ${count} trustlines found`, 'success');
        } else {
          console.log('❌ Trustline data not successful:', trustlineData);
          totalUsersElement.textContent = 'Error';
          totalUsersElement.style.color = '#e74c3c';
          showAlert('❌ Failed to load trustline count', 'error');
        }
      } catch (trustlineError) {
        console.error('❌ Trustline count failed:', trustlineError);
        totalUsersElement.textContent = 'Error';
        totalUsersElement.style.color = '#e74c3c';
        showAlert(`❌ Trustline count error: ${trustlineError.message}`, 'error');
      }
    }

    // Dashboard functions - Production Ready with full backend support
    async function loadDashboardData() {
      // Load trustline count first, independently
      await loadTrustlineCount();

      try {

        // Load tokenomics stats for dashboard with error handling
        try {
          const tokenomicsData = await apiCall('/api/tokenomics/stats');
          if (tokenomicsData.success && tokenomicsData.stats) {
            const stats = tokenomicsData.stats;
            if (stats.airdrop) {
              const amount = stats.airdrop.totalDistributed;
              let formatted;
              if (amount >= 1000000) {
                formatted = (amount / 1000000).toFixed(1) + 'M';
              } else if (amount >= 1000) {
                formatted = (amount / 1000).toFixed(1) + 'K';
              } else {
                formatted = amount.toString();
              }
              document.getElementById('totalWaldoDistributed').textContent = formatted;
            }
            if (stats.battles) {
              document.getElementById('activeBattles').textContent = stats.battles.active || '0';
            }
            if (stats.staking) {
              document.getElementById('totalStaked').textContent = (stats.staking?.totalStaked / 1000 || 0).toFixed(1) + 'K';
            }
          } else {
            console.log('⚠️ Tokenomics data not available');
            document.getElementById('totalWaldoDistributed').textContent = 'Loading...';
            document.getElementById('activeBattles').textContent = 'Loading...';
            document.getElementById('totalStaked').textContent = 'Loading...';
          }
        } catch (tokenomicsError) {
          console.error('❌ Tokenomics endpoint error:', tokenomicsError);
          // Show loading instead of fake data
          document.getElementById('totalWaldoDistributed').textContent = 'Error';
          document.getElementById('activeBattles').textContent = 'Error';
          document.getElementById('totalStaked').textContent = 'Error';
        }

        // Load battle status for activity
        const battleData = await apiCall('/api/battle/current');
        const activityDiv = document.getElementById('recentActivity');

        let activityHtml = '';
        if (battleData.active) {
          activityHtml += `
            <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
              <div style="font-weight: bold; color: #25c2a0;">⚔️ Battle #${battleData.battle.id} Active</div>
              <div style="font-size: 0.9em; opacity: 0.8;">${battleData.battle.totalVotes} total votes</div>
            </div>
          `;
        }

        // Load recent airdrop activity
        try {
          const airdropStatus = await apiCall('/api/airdrop/status');
          if (airdropStatus.success) {
            activityHtml += `
              <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
                <div style="font-weight: bold; color: #25c2a0;">🎁 Airdrop Status</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${airdropStatus.airdrop.totalClaimed}/1000 claimed</div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('Could not load airdrop status');
        }

        if (!activityHtml) {
          activityHtml = '<div style="color: #666; text-align: center; padding: 20px;">No recent activity</div>';
        }
        activityDiv.innerHTML = activityHtml;

        // System health check
        const alertsDiv = document.getElementById('systemAlerts');
        const healthChecks = await performHealthChecks();
        alertsDiv.innerHTML = healthChecks;

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Error loading dashboard data: ' + error.message, 'error');

        // Show fallback data (but don't override trustline count)
        // document.getElementById('totalUsers').textContent = '-'; // Don't override trustline count
        document.getElementById('totalWaldoDistributed').textContent = '-';
        document.getElementById('activeBattles').textContent = '-';
        document.getElementById('totalStaked').textContent = '-';
      }
    }

    // Production health checks
    async function performHealthChecks() {
      let healthHtml = '';

      try {
        // Check API connectivity using airdrop status endpoint (no auth required)
        const response = await fetch(`${API_BASE}/api/airdrop/status`);
        const data = await response.json();

        if (data.success) {
          healthHtml += '<div class="alert alert-success">✅ Backend API: Online</div>';
        } else {
          healthHtml += '<div class="alert alert-error">❌ Backend API: Offline</div>';
        }
      } catch (e) {
        console.error('Backend API health check failed:', e);
        healthHtml += '<div class="alert alert-error">❌ Backend API: Offline</div>';
      }

      try {
        // Check battle system (no auth required)
        const battleResponse = await fetch(`${API_BASE}/api/battle/current`);
        if (battleResponse.ok) {
          healthHtml += '<div class="alert alert-success">✅ Battle System: Operational</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">⚠️ Battle System: Issues detected</div>';
        }
      } catch (e) {
        console.error('Battle system health check failed:', e);
        healthHtml += '<div class="alert alert-warning">⚠️ Battle System: Issues detected</div>';
      }

      try {
        // Check airdrop system (no auth required)
        const airdropResponse = await fetch(`${API_BASE}/api/airdrop/status`);
        const airdropData = await airdropResponse.json();

        if (airdropData.success && airdropData.airdrop.isActive) {
          healthHtml += '<div class="alert alert-success">✅ Airdrop System: Active</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">⚠️ Airdrop System: Inactive</div>';
        }
      } catch (e) {
        console.error('Airdrop system health check failed:', e);
        healthHtml += '<div class="alert alert-error">❌ Airdrop System: Error</div>';
      }

      return healthHtml || '<div class="alert alert-warning">⚠️ Unable to perform health checks</div>';
    }

    // Utility functions
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      // Insert at top of current section
      const currentSectionEl = document.querySelector('.admin-section.active');
      currentSectionEl.insertBefore(alertDiv, currentSectionEl.firstChild);

      // Remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Users functions - Production Ready with full backend support
    async function loadUsersData() {
      try {
        // Get user list from backend
        const usersData = await apiCall('/api/users/list?limit=50');
        const usersDiv = document.getElementById('usersList');
        let usersHtml = '';

        if (usersData.success && usersData.users.length > 0) {
          usersHtml = `
            <div style="margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                <div>
                  <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${usersData.summary.totalUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Total Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #27ae60; font-weight: bold;">${usersData.summary.activeUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Active Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${usersData.summary.stakingUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Staking</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${usersData.summary.blockedUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Blocked</div>
                </div>
              </div>
            </div>

            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #444; position: sticky; top: 0;">
                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #555;">User</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Level</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">WALDO</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Battles</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

          usersData.users.forEach(user => {
            const statusColor = user.security.isBlocked ? '#e74c3c' :
                               user.security.isSuspicious ? '#f39c12' : '#27ae60';
            const statusText = user.security.isBlocked ? 'Blocked' :
                              user.security.isSuspicious ? 'Suspicious' : 'Active';

            usersHtml += `
              <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 10px;">
                  <div style="font-weight: bold; color: #25c2a0;">${user.username}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.walletAddress.slice(0, 8)}...${user.walletAddress.slice(-6)}</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #25c2a0; font-weight: bold;">Level ${user.xpLevel}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.totalXP} XP</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ffd93d; font-weight: bold;">${user.waldoBalance.toFixed(1)}</div>
                  ${user.staking.active ? '<div style="font-size: 0.8em; color: #25c2a0;">+Staking</div>' : ''}
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ccc;">${user.battles.won}W / ${user.battles.total}T</div>
                  <div style="font-size: 0.8em; color: #666;">${user.battles.votes} votes</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.security.riskLevel}</div>
                </td>
              </tr>
            `;
          });

          usersHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          usersHtml = '<div style="color: #666; text-align: center; padding: 40px;">No users found</div>';
        }

        // Combine data from battle leaderboard (most active users)
        if (battleLeaderboard.status === 'fulfilled' && battleLeaderboard.value.leaderboard) {
          const users = battleLeaderboard.value.leaderboard.slice(0, 50); // Top 50 users

          usersHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Twitter</th>
                  <th>Battle Wins</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
                  const isBlocked = securityData.status === 'fulfilled' &&
                    securityData.value.blockedUsers?.includes(user.wallet);

                  return `
                    <tr>
                      <td><code>${user.wallet.slice(0, 8)}...${user.wallet.slice(-6)}</code></td>
                      <td>${user.twitter ? `@${user.twitter}` : '-'}</td>
                      <td>${user.wins || 0}</td>
                      <td><span class="status-badge status-${isBlocked ? 'blocked' : 'active'}">${isBlocked ? 'BLOCKED' : 'ACTIVE'}</span></td>
                      <td>
                        <button type="button" class="btn" onclick="viewUser('${user.wallet}')">👁️ View</button>
                        <button type="button" class="btn ${isBlocked ? 'btn-warning' : 'btn-danger'}" onclick="${isBlocked ? 'unblockUser' : 'blockUser'}('${user.wallet}')">${isBlocked ? '✅ Unblock' : '🚫 Block'}</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        } else {
          usersHtml = '<div style="text-align: center; color: #666; padding: 40px;">No user data available</div>';
        }

        usersDiv.innerHTML = usersHtml;

      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 40px;">Error loading users: ' + error.message + '</div>';
      }
    }

    // Airdrops functions - Production Ready
    async function loadAirdropsData() {
      try {
        // Load airdrop status
        const airdropData = await apiCall('/api/airdrop/status');

        if (airdropData.success) {
          document.getElementById('airdropsClaimed').textContent = `${airdropData.airdrop.totalClaimed}/1000`;
          document.getElementById('airdropsRemaining').textContent = airdropData.airdrop.remaining;
        }

        // Load current password status
        await getCurrentAirdropPassword();

        // Load tokenomics for airdrop history
        const historyDiv = document.getElementById('airdropHistory');

        try {
          const tokenomicsData = await apiCall('/api/tokenomics/stats');

          if (tokenomicsData.success && tokenomicsData.stats && tokenomicsData.stats.airdrop) {
            const stats = tokenomicsData.stats;
          historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">📊 Airdrop Statistics</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="font-weight: bold; color: #fff;">${stats.airdrop.totalClaimed}</div>
                  <div style="color: #ccc; font-size: 0.9em;">Total Claims</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #fff;">${(stats.airdrop.totalDistributed / 1000000).toFixed(2)}M</div>
                  <div style="color: #ccc; font-size: 0.9em;">WALDO Distributed</div>
                </div>
              </div>
            </div>

            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">🎯 System Status</h4>
              <div style="color: ${airdropData.airdrop.isActive ? '#27ae60' : '#e74c3c'};">
                ${airdropData.airdrop.isActive ? '✅ Airdrop system is ACTIVE' : '❌ Airdrop system is INACTIVE'}
              </div>
              <div style="color: #ccc; margin-top: 5px;">
                ${airdropData.airdrop.remaining} airdrops remaining
              </div>
            </div>
          `;
          } else {
            // Fallback if tokenomics data is missing airdrop info
            historyDiv.innerHTML = `
              <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h4 style="color: #25c2a0; margin-bottom: 10px;">📊 Airdrop Statistics</h4>
                <div style="color: #ccc;">
                  <div>✅ Airdrop system is operational</div>
                  <div style="margin-top: 5px;">Data loading from multiple sources...</div>
                </div>
              </div>
            `;
          }
        } catch (tokenomicsError) {
          console.error('Error loading tokenomics data:', tokenomicsError);
          // Show fallback airdrop data
          historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">📊 Airdrop Statistics</h4>
              <div style="color: #ccc;">
                <div>✅ Airdrop system is operational</div>
                <div style="margin-top: 5px;">Detailed stats temporarily unavailable</div>
              </div>
            </div>
          `;
        }

      } catch (error) {
        console.error('Error loading airdrops:', error);
        document.getElementById('airdropHistory').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading airdrop data: ' + error.message + '</div>';
      }
    }

    // Battle functions - Production Ready
    async function loadBattlesData() {
      try {
        const battle = await apiCall('/api/battle/current');

        const currentDiv = document.getElementById('currentBattle');
        if (battle.active) {
          currentDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <div style="font-weight: bold; color: #25c2a0;">Battle #${battle.id}</div>
              <div style="margin: 10px 0;">
                <div>Meme 1: ${battle.meme1.votes || 0} votes</div>
                <div>Meme 2: ${battle.meme2.votes || 0} votes</div>
              </div>
              <div style="color: #666;">Ends: ${new Date(battle.endTime).toLocaleString()}</div>
            </div>
          `;
        } else {
          currentDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active battle</div>';
        }

        // Load battle history
        const history = await apiCall('/api/battle/history?limit=10');

        const historyDiv = document.getElementById('battleHistory');
        if (history.battles && history.battles.length > 0) {
          historyDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Votes</th>
                  <th>Winner</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${history.battles.slice(0, 10).map(battle => `
                  <tr>
                    <td>#${battle.id}</td>
                    <td>${battle.totalVotes || 0}</td>
                    <td>${battle.winner || '-'}</td>
                    <td><span class="status-badge status-${battle.ended ? 'active' : 'flagged'}">${battle.ended ? 'ENDED' : 'ACTIVE'}</span></td>
                    <td>${new Date(battle.createdAt).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No battle history</div>';
        }
      } catch (error) {
        console.error('Error loading battles:', error);
      }
    }

    // Staking functions - Production Ready
    async function loadStakingData() {
      try {
        const data = await apiCall('/api/staking/positions?limit=20');

        if (data.success) {
          document.getElementById('totalStakingPositions').textContent = data.data.totalPositions || '0';
          document.getElementById('totalStakingValue').textContent = (data.data.totalValue / 1000).toFixed(1) + 'K';
          document.getElementById('totalStakingRewards').textContent = (data.data.totalRewards / 1000).toFixed(1) + 'K';
        }

        const positionsDiv = document.getElementById('stakingPositions');
        if (data.success && data.data.positions.length > 0) {
          positionsDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Amount</th>
                  <th>Duration</th>
                  <th>APY</th>
                  <th>Rewards</th>
                  <th>Unlock Date</th>
                </tr>
              </thead>
              <tbody>
                ${data.data.positions.slice(0, 20).map(pos => `
                  <tr>
                    <td><code>${pos.wallet.slice(0, 8)}...${pos.wallet.slice(-6)}</code></td>
                    <td>${pos.amount} WALDO</td>
                    <td>${pos.duration} days</td>
                    <td>${(pos.apy * 100).toFixed(1)}%</td>
                    <td>${pos.currentRewards.toFixed(2)} WALDO</td>
                    <td>${new Date(pos.unlockDate).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          positionsDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No staking positions</div>';
        }
      } catch (error) {
        console.error('Error loading staking data:', error);
      }
    }

    // Manual Unstaking Functions
    async function loadUserStakes() {
      const walletAddress = document.getElementById('unstakeWalletAddress').value.trim();

      if (!walletAddress || !walletAddress.startsWith('r')) {
        showAlert('Please enter a valid XRPL wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/positions/${walletAddress}`);
        const data = await res.json();

        if (data.success && data.positions && data.positions.length > 0) {
          const selector = document.getElementById('stakeSelector');
          selector.innerHTML = '<option value="">Select a stake...</option>';

          data.positions.forEach(stake => {
            const option = document.createElement('option');
            option.value = JSON.stringify(stake);
            option.textContent = `${stake.amount} WALDO (${stake.duration} days) - ${stake.status}`;
            selector.appendChild(option);
          });

          document.getElementById('userStakesContainer').style.display = 'block';
          showAlert(`Found ${data.positions.length} stake(s) for ${walletAddress}`, 'success');
        } else {
          document.getElementById('userStakesContainer').style.display = 'none';
          showAlert('No staking positions found for this wallet', 'error');
        }
      } catch (error) {
        console.error('Error loading user stakes:', error);
        showAlert('Error loading user stakes', 'error');
        document.getElementById('userStakesContainer').style.display = 'none';
      }
    }

    async function executeManualUnstake() {
      const stakeSelector = document.getElementById('stakeSelector');
      const reason = document.getElementById('unstakeReason').value.trim();
      const forceUnstake = document.getElementById('forceUnstake').checked;

      if (!stakeSelector.value) {
        showAlert('Please select a stake to unstake', 'error');
        return;
      }

      if (!reason) {
        showAlert('Please provide a reason for manual unstaking', 'error');
        return;
      }

      const stake = JSON.parse(stakeSelector.value);
      const isMatured = new Date() >= new Date(stake.unlockDate);

      // Confirmation dialog
      const confirmMessage = `🚨 MANUAL UNSTAKING OVERRIDE

Wallet: ${stake.wallet}
Amount: ${stake.amount} WALDO
Current Rewards: ${(stake.currentRewards || 0).toFixed(2)} WALDO
Status: ${stake.status}
${!isMatured ? `\n⚠️ EARLY UNSTAKING: 15% penalty will apply` : ''}

Reason: ${reason}

This action cannot be undone. Continue?`;

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/unstake`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            wallet: stake.wallet,
            stakeId: stake.stakeId,
            force: forceUnstake || !isMatured,
            adminOverride: true,
            adminReason: reason,
            adminWallet: ADMIN_WALLET
          })
        });

        const data = await res.json();
        const resultDiv = document.getElementById('unstakeResult');

        if (data.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `
            ✅ <strong>Manual Unstake Successful</strong><br>
            Stake ID: ${stake.stakeId}<br>
            Final Amount: ${data.finalAmount} WALDO<br>
            ${data.penalty > 0 ? `Penalty Applied: ${data.penalty} WALDO<br>` : ''}
            XUMM Transaction: ${data.uuid}<br>
            <small>User will receive XUMM notification to sign the transaction.</small>
          `;

          // Reset form
          document.getElementById('unstakeWalletAddress').value = '';
          document.getElementById('unstakeReason').value = '';
          document.getElementById('userStakesContainer').style.display = 'none';

          // Refresh staking data
          loadStakingData();

        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `❌ <strong>Unstaking Failed</strong><br>${data.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        console.error('Error executing manual unstake:', error);
        const resultDiv = document.getElementById('unstakeResult');
        resultDiv.className = 'error';
        resultDiv.innerHTML = `❌ <strong>Error</strong><br>Failed to execute manual unstake: ${error.message}`;
      }
    }

    // Security functions - Production Ready
    async function loadSecurityData() {
      try {
        const data = await apiCall('/api/security/overview');

        const alertsDiv = document.getElementById('securityAlerts');
        if (data.success) {
          let alertsHtml = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${data.overview.blockedUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Blocked Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${data.overview.suspiciousUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Suspicious Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${data.overview.flaggedTransactions}</div>
                <div style="font-size: 0.9em; color: #ccc;">Flagged Transactions</div>
              </div>
            </div>
          `;

          if (data.overview.recentEvents && data.overview.recentEvents.length > 0) {
            alertsHtml += '<h4 style="margin-bottom: 15px;">Recent Security Events</h4>';
            alertsHtml += '<div style="max-height: 200px; overflow-y: auto;">';

            data.overview.recentEvents.forEach(event => {
              const eventColor = event.type === 'user_blocked' ? '#e74c3c' :
                                event.type === 'user_unblocked' ? '#27ae60' : '#f39c12';

              alertsHtml += `
                <div style="padding: 10px; margin-bottom: 8px; background: #333; border-radius: 5px; border-left: 3px solid ${eventColor};">
                  <div style="font-weight: bold; color: ${eventColor};">${event.type.replace('_', ' ').toUpperCase()}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Wallet: ${event.wallet}</div>
                  <div style="font-size: 0.8em; color: #666;">${new Date(event.timestamp).toLocaleString()}</div>
                </div>
              `;
            });

            alertsHtml += '</div>';
          } else {
            alertsHtml += '<div style="color: #666; text-align: center; padding: 20px;">No recent security events</div>';
          }

          alertsDiv.innerHTML = alertsHtml;
        } else {
          alertsDiv.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading security data</div>';
        }
      } catch (error) {
        console.error('Error loading security data:', error);
      }
    }

    async function checkWalletSecurity() {
      const wallet = document.getElementById('securityWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/security/check/${wallet}`);
        const data = await res.json();

        const resultsDiv = document.getElementById('securityResults');
        if (data.success) {
          resultsDiv.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">Security Report for ${wallet.slice(0, 8)}...${wallet.slice(-6)}</h4>
              <div><strong>Status:</strong> <span class="status-badge status-${data.status.toLowerCase()}">${data.status}</span></div>
              <div><strong>Violations:</strong> ${data.violationCount}</div>
              <div><strong>Blocked:</strong> ${data.isBlocked ? 'Yes' : 'No'}</div>
              <div><strong>Last Check:</strong> ${new Date().toLocaleString()}</div>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('securityResults').innerHTML = `<div class="alert alert-error">Network error checking wallet</div>`;
      }
    }

    // Manual security action functions
    async function blockUser() {
      const wallet = document.getElementById('blockWallet').value.trim();
      const reason = document.getElementById('blockReason').value.trim();
      const resultDiv = document.getElementById('blockResult');

      if (!wallet || !reason) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Please enter both wallet address and reason';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '⏳ Blocking user...';

        const response = await apiCall('/api/security/block', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `✅ <strong>User Blocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason}`;

          // Clear form
          document.getElementById('blockWallet').value = '';
          document.getElementById('blockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `❌ <strong>Blocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `❌ <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function unblockUser() {
      const wallet = document.getElementById('unblockWallet').value.trim();
      const reason = document.getElementById('unblockReason').value.trim();
      const resultDiv = document.getElementById('unblockResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '⏳ Unblocking user...';

        const response = await apiCall('/api/security/unblock', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason: reason || 'Admin unblock' })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `✅ <strong>User Unblocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason || 'Admin unblock'}`;

          // Clear form
          document.getElementById('unblockWallet').value = '';
          document.getElementById('unblockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `❌ <strong>Unblocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `❌ <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function checkUserSecurity() {
      const wallet = document.getElementById('checkWallet').value.trim();
      const resultDiv = document.getElementById('securityCheckResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '❌ Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '⏳ Checking security status...';

        const response = await apiCall(`/api/security/check/${wallet}`);

        if (response.success) {
          const security = response.security;
          const riskColor = security.riskLevel === 'HIGH' ? '#e74c3c' :
                           security.riskLevel === 'MEDIUM' ? '#f39c12' : '#27ae60';

          resultDiv.className = 'info';
          resultDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-top: 10px;">
              <div style="font-weight: bold; color: #25c2a0; margin-bottom: 10px;">Security Report: ${wallet.slice(0, 8)}...${wallet.slice(-6)}</div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Status</div>
                  <div style="color: ${security.isBlocked ? '#e74c3c' : security.isSuspicious ? '#f39c12' : '#27ae60'}; font-weight: bold;">
                    ${security.isBlocked ? '🚫 BLOCKED' : security.isSuspicious ? '⚠️ SUSPICIOUS' : '✅ ACTIVE'}
                  </div>
                </div>
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Risk Level</div>
                  <div style="color: ${riskColor}; font-weight: bold;">${security.riskLevel} (${security.riskScore}/100)</div>
                </div>
              </div>

              ${security.blockReason ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Block Reason</div>
                  <div style="color: #e74c3c;">${security.blockReason}</div>
                </div>
              ` : ''}

              ${security.riskFactors.length > 0 ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Risk Factors</div>
                  <div style="color: #f39c12;">${security.riskFactors.join(', ')}</div>
                </div>
              ` : ''}

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                <div>
                  <div style="color: #666;">Battles</div>
                  <div style="color: #ccc;">${security.userData.totalBattles}</div>
                </div>
                <div>
                  <div style="color: #666;">Votes</div>
                  <div style="color: #ccc;">${security.userData.totalVotes}</div>
                </div>
                <div>
                  <div style="color: #666;">Last Active</div>
                  <div style="color: #ccc;">${security.userData.lastActive ? new Date(security.userData.lastActive).toLocaleDateString() : 'Never'}</div>
                </div>
              </div>
            </div>
          `;

          // Clear form
          document.getElementById('checkWallet').value = '';
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `❌ <strong>Security Check Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `❌ <strong>Network Error</strong><br>${error.message}`;
      }
    }

    // Initialize admin panel - Production Ready
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication first
      if (!checkAdminAuth()) {
        return; // Auth modal will be shown
      }

      // Show admin info
      const adminInfo = document.createElement('div');
      adminInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #333; padding: 10px; border-radius: 5px; font-size: 0.9em; z-index: 1000;';
      adminInfo.innerHTML = `
        <div style="color: #25c2a0;">🔐 Admin: ${ADMIN_WALLET.slice(0, 8)}...${ADMIN_WALLET.slice(-6)}</div>
        <button onclick="logout()" style="background: #e74c3c; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Logout</button>
      `;
      document.body.appendChild(adminInfo);

      // Load initial data
      loadDashboardData();

      // Set up form handlers
      document.getElementById('airdropForm').addEventListener('submit', handleAirdropSubmit);
      document.getElementById('daoForm').addEventListener('submit', handleDAOSubmit);

      // Set up periodic refresh
      setInterval(() => {
        if (currentSection === 'dashboard') {
          loadDashboardData();
        }
      }, 30000); // Refresh every 30 seconds

      // Listen for wallet changes (logout detection)
      window.addEventListener('storage', (e) => {
        if (e.key === 'xummWallet' && e.newValue !== ADMIN_WALLET) {
          location.reload();
        }
      });
    });

    // Old logout function removed - using the password-based logout function instead

    // Force refresh password function - bypasses any caching issues
    async function forceRefreshPassword() {
      console.log('🔄 Force refresh password called');
      showAlert('Refreshing password...', 'info');

      try {
        const url = `https://waldocoin-backend-api.onrender.com/api/airdrop/password-check?_t=${Date.now()}`;
        console.log('📡 Calling:', url);

        const response = await fetch(url, {
          method: 'GET',
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache',
            'Expires': '0'
          }
        });

        console.log('📡 Response status:', response.status);
        const data = await response.json();
        console.log('📡 Response data:', data);

        if (data.success) {
          // Force update display
          document.getElementById('currentPasswordDisplay').textContent = data.currentPassword;
          document.getElementById('passwordSource').textContent = data.source;

          // Update color
          const passwordDisplay = document.getElementById('currentPasswordDisplay');
          if (data.source === 'Default fallback') {
            passwordDisplay.style.color = '#f39c12';
          } else {
            passwordDisplay.style.color = '#25c2a0';
          }

          showAlert(`✅ Password refreshed: ${data.currentPassword}`, 'success');
        } else {
          showAlert('❌ Failed to refresh password', 'error');
        }
      } catch (error) {
        console.error('❌ Force refresh error:', error);
        showAlert('❌ Connection error', 'error');
      }
    }

    // Airdrop Password Management Functions
    async function getCurrentAirdropPassword() {
      try {
        console.log('🔍 Loading current airdrop password...');

        // Use the public endpoint that doesn't require authentication (with cache busting)
        const response = await fetch(`${API_BASE}/api/airdrop/password-check?_t=${Date.now()}`, {
          cache: 'no-cache',
          headers: {
            'Cache-Control': 'no-cache',
            'Pragma': 'no-cache'
          }
        });
        const data = await response.json();

        console.log('📡 Password API response:', data);

        if (data.success) {
          // Update the display elements
          const passwordDisplay = document.getElementById('currentPasswordDisplay');
          const passwordSource = document.getElementById('passwordSource');

          if (passwordDisplay && passwordSource) {
            passwordDisplay.textContent = data.currentPassword;
            passwordSource.textContent = data.source;

            // Show different colors based on source
            if (data.source === 'Default fallback') {
              passwordDisplay.style.color = '#f39c12'; // Orange for default
            } else {
              passwordDisplay.style.color = '#25c2a0'; // Green for custom password
            }

            console.log(`✅ Password loaded: ${data.currentPassword} (${data.source})`);
          } else {
            console.error('❌ Could not find password display elements');
          }
        } else {
          console.error('❌ API returned error:', data.error);
          document.getElementById('currentPasswordDisplay').textContent = 'Error loading password';
          document.getElementById('passwordSource').textContent = data.error || 'Unknown error';
        }
      } catch (error) {
        console.error('❌ Get password error:', error);

        // Update display to show error
        const passwordDisplay = document.getElementById('currentPasswordDisplay');
        const passwordSource = document.getElementById('passwordSource');

        if (passwordDisplay && passwordSource) {
          passwordDisplay.textContent = 'Connection Error';
          passwordDisplay.style.color = '#e74c3c'; // Red for error
          passwordSource.textContent = 'Could not connect to server';
        }
      }
    }

    async function updateAirdropPassword() {
      console.log('🔐 Password update function called');

      const adminKey = localStorage.getItem('adminKey');
      const newPassword = document.getElementById('newDailyPassword').value.trim();

      console.log('📝 Password update data:', {
        hasAdminKey: !!adminKey,
        newPassword: newPassword ? `${newPassword.slice(0,3)}***` : 'empty',
        passwordLength: newPassword.length
      });

      if (!adminKey) {
        console.log('❌ No admin key found');
        showAlert('Please enter admin key in the authentication section first', 'error');
        return;
      }

      if (!newPassword || newPassword.length < 3) {
        console.log('❌ Invalid password:', { newPassword, length: newPassword.length });
        showAlert('Password must be at least 3 characters long', 'error');
        return;
      }

      try {
        console.log('📡 Making API call to update password...');

        const response = await fetch(`${API_BASE}/api/airdrop/update-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            password: newPassword
          })
        });

        console.log('📡 API response status:', response.status);
        const data = await response.json();
        console.log('📡 API response data:', data);

        if (data.success) {
          // Update result display
          document.getElementById('passwordUpdateResult').innerHTML = `
            <div style="color: #27ae60; padding: 10px;">
              ✅ Password updated successfully to: <strong>${newPassword}</strong>
            </div>
          `;

          // Refresh current password display
          getCurrentAirdropPassword();

          // Clear input
          document.getElementById('newDailyPassword').value = '';

          showAlert(`Password updated successfully to: ${newPassword}`, 'success');
        } else {
          document.getElementById('passwordUpdateResult').innerHTML = `
            <div style="color: #e74c3c; padding: 10px;">
              ❌ Failed to update password: ${data.error}
            </div>
          `;
          showAlert(`Failed to update password: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update password error:', error);
        showAlert('Failed to update password', 'error');
      }
    }

    function setQuickAirdropPassword(password) {
      document.getElementById('newDailyPassword').value = password;
    }

    function generateRandomAirdropPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let password = 'WALDO';
      for (let i = 0; i < 4; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated random password: ${password}`, 'info');
    }

    function generateDailyPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let password = 'WALDO';
      for (let i = 0; i < 4; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated random password: ${password}`, 'info');
    }

    function generateDailyAirdropPassword() {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const password = `WALDO${month}${day}`;
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated today's password: ${password}`, 'info');
    }

    async function clearPasswordOverride() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Clear the Redis override by setting it to empty
        const response = await fetch(`${API_BASE}/api/airdrop/set-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            adminKey: adminKey,
            newPassword: '' // This will clear the Redis override
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Password override cleared. Now using default password (WALDOCREW)', 'success');
          getCurrentAirdropPassword(); // Refresh current password display
          document.getElementById('newDailyPassword').value = ''; // Clear input
        } else {
          showAlert(`Failed to clear override: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear override error:', error);
        showAlert('Failed to clear password override', 'error');
      }
    }

    // Form handlers - Production Ready
    async function handleAirdropSubmit(e) {
      e.preventDefault();
      console.log('🚀 Admin airdrop function called');

      const wallet = document.getElementById('airdropWallet').value.trim();
      const amount = parseFloat(document.getElementById('airdropAmount').value);
      const reason = document.getElementById('airdropReason').value.trim() || 'Admin manual airdrop';

      console.log('📝 Form data:', { wallet, amount, reason });

      // Validation
      if (!wallet || !wallet.match(/^r[a-zA-Z0-9]{24,34}$/)) {
        console.log('❌ Wallet validation failed');
        alert('Please enter a valid XRPL wallet address');
        return;
      }

      if (!amount || amount <= 0 || amount > 1000000) {
        console.log('❌ Amount validation failed');
        alert('Amount must be between 1 and 1,000,000 WALDO');
        return;
      }

      // Confirm action
      if (!confirm(`Send ${amount} WALDO to ${wallet}?\n\nReason: ${reason}`)) {
        console.log('❌ User cancelled');
        return;
      }

      console.log('✅ Starting airdrop request...');

      try {
        // Use the existing airdrop endpoint
        const data = await apiCall('/api/airdrop', {
          method: 'POST',
          body: JSON.stringify({
            wallet,
            amount,
            adminOverride: true,
            reason
          })
        });

        console.log('📡 API Response:', data);

        if (data.success) {
          console.log('✅ Airdrop successful!');
          alert(`✅ Airdrop sent successfully! Transaction: ${data.txHash || 'Pending'}`);
          document.getElementById('airdropForm').reset();
          loadAirdropsData();
        } else {
          console.log('❌ Airdrop failed:', data.error);
          alert(`❌ ${data.error || 'Failed to send airdrop'}`);
        }
      } catch (error) {
        console.log('❌ API Error:', error);
        console.log('❌ Error details:', error.message);

        // Show detailed error message
        const errorMsg = error.message || 'Unknown error occurred';
        alert(`❌ AIRDROP FAILED\n\nError: ${errorMsg}\n\nCheck console for details.`);

        // Also log to console for debugging
        console.error('Full error object:', error);
      }
    }

    async function handleDAOSubmit(e) {
      e.preventDefault();

      const title = document.getElementById('daoTitle').value.trim();
      const description = document.getElementById('daoDescription').value.trim();
      const options = document.getElementById('daoOptions').value.split(',').map(opt => opt.trim()).filter(Boolean);
      const duration = parseInt(document.getElementById('daoDuration').value);

      try {
        const res = await fetch(`${API_BASE}/api/dao/proposals/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, options, durationHours: duration })
        });

        const data = await res.json();

        if (data.success) {
          showAlert('DAO proposal created successfully!', 'success');
          document.getElementById('daoForm').reset();
          loadDAOData();
        } else {
          showAlert(data.error || 'Failed to create proposal', 'error');
        }
      } catch (error) {
        showAlert('Network error creating proposal', 'error');
      }
    }

    // DAO functions - Production Ready
    async function loadDAOData() {
      try {
        const data = await apiCall('/api/dao/proposals?limit=10');
        const daoDiv = document.getElementById('daoProposals');

        if (data.success && data.proposals.length > 0) {
          let daoHtml = `
            <div style="max-height: 400px; overflow-y: auto;">
          `;

          data.proposals.forEach(proposal => {
            const statusColor = proposal.status === 'active' ? '#25c2a0' :
                               proposal.status === 'passed' ? '#27ae60' : '#e74c3c';
            const timeRemaining = proposal.timeRemaining > 0 ?
              Math.ceil(proposal.timeRemaining / (24 * 60 * 60 * 1000)) + ' days' : 'Expired';

            daoHtml += `
              <div style="padding: 15px; margin-bottom: 10px; background: #333; border-radius: 8px; border-left: 4px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div>
                    <div style="font-weight: bold; color: #25c2a0; margin-bottom: 5px;">${proposal.title}</div>
                    <div style="font-size: 0.9em; color: #ccc; margin-bottom: 8px;">${proposal.description.substring(0, 100)}${proposal.description.length > 100 ? '...' : ''}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: ${statusColor}; font-weight: bold; text-transform: uppercase;">${proposal.status}</div>
                    <div style="font-size: 0.8em; color: #666;">${timeRemaining}</div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; gap: 20px;">
                    <div style="color: #27ae60;">✓ ${proposal.votes.yes} Yes</div>
                    <div style="color: #e74c3c;">✗ ${proposal.votes.no} No</div>
                    <div style="color: #ccc;">Total: ${proposal.votes.total}</div>
                  </div>
                  <div style="font-size: 0.8em; color: #666;">
                    Support: ${(proposal.currentSupport * 100).toFixed(1)}% | Quorum: ${proposal.quorumMet ? '✓' : '✗'}
                  </div>
                </div>
              </div>
            `;
          });

          daoHtml += '</div>';
          daoDiv.innerHTML = daoHtml;
        } else {
          daoDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active DAO proposals</div>';
        }
      } catch (error) {
        console.error('Error loading DAO data:', error);
        document.getElementById('daoProposals').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading DAO proposals</div>';
      }
    }

    async function loadSystemData() {
      document.getElementById('systemHealth').innerHTML = `
        <div class="alert alert-success">✅ Backend API: Online</div>
        <div class="alert alert-success">✅ Database: Connected</div>
        <div class="alert alert-success">✅ XRPL: Connected</div>
        <div class="alert alert-warning">⚠️ High memory usage: 78%</div>
      `;
    }

    // 🔍 Duplicate functions removed - using original implementations above

    // Duplicate exportUsersJSON and blockUser functions removed

    // Duplicate unblockUser and checkUserSecurity functions removed

    function viewUser(wallet) {
      // Set the wallet in the security check field and run the check
      document.getElementById('checkWallet').value = wallet;
      checkUserSecurity();
    }

    // Airdrop Password Management Functions
    async function getCurrentAirdropPassword() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert(`Current password: ${data.password}`, 'info');
        } else {
          showAlert(`Failed to get password: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Get password error:', error);
        showAlert('Error getting current password', 'error');
      }
    }

    // Duplicate functions removed - using original implementations above

    async function clearPasswordOverride() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/clear-password-override`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          document.getElementById('newDailyPassword').value = '';
          showAlert('Password override cleared', 'success');
        } else {
          showAlert(`Failed to clear override: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear override error:', error);
        showAlert('Error clearing password override', 'error');
      }
    }

    // Duplicate updateAirdropPassword function removed - using enhanced version above

    // Battle Management Functions
    async function endCurrentBattle() {
      const confirm = window.confirm('⚠️ Force end the current battle?\n\nThis will immediately end the battle and trigger payouts.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/battle/force-end`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Battle ended successfully', 'success');
        } else {
          showAlert(`Failed to end battle: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('End battle error:', error);
        showAlert('Error ending battle', 'error');
      }
    }

    async function cancelCurrentBattle() {
      const confirm = window.confirm('⚠️ EMERGENCY CANCEL current battle?\n\nThis will cancel the battle and refund all participants. This action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/battle/emergency-cancel`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Battle cancelled and participants refunded', 'success');
        } else {
          showAlert(`Failed to cancel battle: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Cancel battle error:', error);
        showAlert('Error cancelling battle', 'error');
      }
    }

    // Staking Management Functions
    async function loadUserStakes() {
      const wallet = document.getElementById('unstakeWalletAddress').value.trim();

      if (!wallet) {
        showAlert('Please enter a wallet address', 'warning');
        return;
      }

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/staking/user-stakes?wallet=${wallet}`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const stakesDiv = document.getElementById('userStakesList');

        if (data.success && data.stakes && data.stakes.length > 0) {
          let stakesHtml = '<div style="margin-top: 15px;"><h5>Active Stakes:</h5>';
          data.stakes.forEach((stake, index) => {
            stakesHtml += `
              <div style="background: #333; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                <div><strong>Stake ${index + 1}:</strong> ${stake.amount} WALDO</div>
                <div>Duration: ${stake.duration} days</div>
                <div>Started: ${new Date(stake.startDate).toLocaleDateString()}</div>
                <div>Ends: ${new Date(stake.endDate).toLocaleDateString()}</div>
                <div>Status: <span style="color: ${stake.active ? '#27ae60' : '#e74c3c'}">${stake.active ? 'Active' : 'Completed'}</span></div>
              </div>
            `;
          });
          stakesHtml += '</div>';
          stakesDiv.innerHTML = stakesHtml;
        } else {
          stakesDiv.innerHTML = '<div style="color: #666; margin-top: 15px;">No active stakes found for this wallet</div>';
        }
      } catch (error) {
        console.error('Load stakes error:', error);
        document.getElementById('userStakesList').innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">Error loading stakes</div>';
        showAlert('Error loading user stakes', 'error');
      }
    }

    async function executeManualUnstake() {
      const wallet = document.getElementById('unstakeWalletAddress').value.trim();
      const reason = document.getElementById('unstakeReason').value.trim();

      if (!wallet || !reason) {
        showAlert('Please enter both wallet address and reason', 'warning');
        return;
      }

      const confirm = window.confirm(`⚠️ Manually unstake all positions for ${wallet}?\n\nReason: ${reason}\n\nThis action cannot be undone.`);
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/staking/manual-unstake`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({ wallet, reason })
        });

        const data = await response.json();
        if (data.success) {
          showAlert(`Manual unstake completed: ${data.unstakedAmount} WALDO returned`, 'success');
          document.getElementById('unstakeWalletAddress').value = '';
          document.getElementById('unstakeReason').value = '';
          document.getElementById('userStakesList').innerHTML = '';
        } else {
          showAlert(`Failed to unstake: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Manual unstake error:', error);
        showAlert('Error executing manual unstake', 'error');
      }
    }

    // Security Functions
    async function checkWalletSecurity() {
      const wallet = document.getElementById('securityWallet').value.trim();

      if (!wallet) {
        showAlert('Please enter a wallet address', 'warning');
        return;
      }

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/wallet-check?wallet=${wallet}`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const resultsDiv = document.getElementById('securityResults');

        if (data.success) {
          const security = data.security;
          resultsDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 6px; margin-top: 15px;">
              <h5 style="color: #25c2a0;">Security Analysis for ${wallet}</h5>
              <div style="margin-top: 10px;">
                <div>Risk Level: <span style="color: ${security.riskLevel === 'HIGH' ? '#e74c3c' : security.riskLevel === 'MEDIUM' ? '#f39c12' : '#27ae60'}">${security.riskLevel}</span></div>
                <div>Fraud Score: ${security.fraudScore}/100</div>
                <div>Suspicious Activities: ${security.suspiciousActivities || 0}</div>
                <div>Last Violation: ${security.lastViolation ? new Date(security.lastViolation).toLocaleString() : 'None'}</div>
                <div>Account Status: <span style="color: ${security.blocked ? '#e74c3c' : '#27ae60'}">${security.blocked ? 'BLOCKED' : 'ACTIVE'}</span></div>
              </div>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `<div style="color: #e74c3c; margin-top: 15px;">Error: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Security check error:', error);
        document.getElementById('securityResults').innerHTML = '<div style="color: #e74c3c; margin-top: 15px;">Network error</div>';
        showAlert('Error checking wallet security', 'error');
      }
    }

    // System Functions
    async function refreshAllData() {
      showAlert('Refreshing all data...', 'info');
      try {
        // Reload current section data
        const currentSection = document.querySelector('.nav-btn.active').textContent.toLowerCase();
        if (currentSection.includes('dashboard')) {
          loadDashboardData();
          loadActiveBonuses();
          loadAirdropConfig();
          loadConfigHistory();
        }
        showAlert('Data refreshed successfully', 'success');
      } catch (error) {
        console.error('Refresh error:', error);
        showAlert('Error refreshing data', 'error');
      }
    }

    async function clearCache() {
      const confirm = window.confirm('⚠️ Clear all cached data?\n\nThis will clear Redis cache and force fresh data loading.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/clear-cache`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('Cache cleared successfully', 'success');
        } else {
          showAlert(`Failed to clear cache: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear cache error:', error);
        showAlert('Error clearing cache', 'error');
      }
    }

    async function emergencyStop() {
      const confirm = window.confirm('🛑 EMERGENCY SYSTEM STOP?\n\nThis will disable all user-facing functions:\n- Airdrop claims\n- Battle participation\n- Staking operations\n\nOnly use in critical situations!');
      if (!confirm) return;

      const doubleConfirm = window.confirm('⚠️ FINAL CONFIRMATION\n\nAre you absolutely sure you want to stop the system?\n\nThis will affect all users immediately.');
      if (!doubleConfirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/emergency-stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('🛑 EMERGENCY STOP ACTIVATED - All user functions disabled', 'error');
        } else {
          showAlert(`Failed to activate emergency stop: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Emergency stop error:', error);
        showAlert('Error activating emergency stop', 'error');
      }
    }

    // Admin Key Management Functions
    function saveAdminKey() {
      const adminKey = document.getElementById('adminKeyInput').value.trim();

      if (!adminKey) {
        showAlert('Please enter an admin key', 'warning');
        return;
      }

      localStorage.setItem('adminKey', adminKey);
      showAlert('Admin key saved successfully', 'success');
      document.getElementById('adminKeyInput').value = '';
    }

    function clearAdminKey() {
      const confirm = window.confirm('⚠️ Clear stored admin key?\n\nYou will need to re-enter it to access admin functions.');
      if (!confirm) return;

      localStorage.removeItem('adminKey');
      showAlert('Admin key cleared', 'success');
    }

    async function testEnvironmentKeys() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save an admin key first', 'warning');
          return;
        }

        const response = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('✅ Admin key is valid and working', 'success');
        } else {
          showAlert('❌ Admin key validation failed', 'error');
        }
      } catch (error) {
        console.error('Test keys error:', error);
        showAlert('Error testing admin key', 'error');
      }
    }

    // Reset System Function
    async function resetAirdropSystem() {
      const confirm = window.confirm('⚠️ RESET AIRDROP SYSTEM?\n\nThis will:\n- Reset claim counter to 0\n- Clear all claimed wallets\n- Reset to default configuration\n\nThis action CANNOT be undone!');
      if (!confirm) return;

      const doubleConfirm = window.confirm('🚨 FINAL CONFIRMATION\n\nAre you absolutely sure?\n\nAll airdrop progress will be lost!');
      if (!doubleConfirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset-system`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert('🔄 Airdrop system reset successfully', 'success');
          // Refresh dashboard data
          loadDashboardData();
          loadAirdropConfig();
        } else {
          showAlert(`Failed to reset system: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset system error:', error);
        showAlert('Error resetting airdrop system', 'error');
      }
    }

    // 🤖 AI Fraud Detection Functions
    async function loadFraudAnalytics() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/fraud-analytics`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const analyticsDiv = document.getElementById('fraudAnalytics');

        if (data.success) {
          const stats = data.analytics;
          analyticsDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
              <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e74c3c;">
                <div style="color: #e74c3c; font-weight: bold;">Total Violations</div>
                <div style="color: #fff; font-size: 1.5em;">${stats.totalViolations || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Last 24 hours</div>
              </div>
              <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #f39c12;">
                <div style="color: #f39c12; font-weight: bold;">Blocked Wallets</div>
                <div style="color: #fff; font-size: 1.5em;">${stats.blockedWallets || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Currently blocked</div>
              </div>
              <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #9b59b6;">
                <div style="color: #9b59b6; font-weight: bold;">Bot Detections</div>
                <div style="color: #fff; font-size: 1.5em;">${stats.botDetections || 0}</div>
                <div style="color: #666; font-size: 0.9em;">AI-detected bots</div>
              </div>
              <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #27ae60;">
                <div style="color: #27ae60; font-weight: bold;">Clean Requests</div>
                <div style="color: #fff; font-size: 1.5em;">${stats.cleanRequests || 0}</div>
                <div style="color: #666; font-size: 0.9em;">Legitimate traffic</div>
              </div>
            </div>
          `;
        } else {
          analyticsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading fraud analytics</div>';
        }
      } catch (error) {
        console.error('Error loading fraud analytics:', error);
        document.getElementById('fraudAnalytics').innerHTML = '<div style="color: #e74c3c;">Error loading analytics</div>';
      }
    }

    async function loadRecentViolations() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/recent-violations?limit=20`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const violationsDiv = document.getElementById('recentViolations');

        if (data.success && data.violations && data.violations.length > 0) {
          let violationsHtml = '';
          data.violations.forEach(violation => {
            const time = new Date(violation.timestamp).toLocaleString();
            const severityColor = violation.reason.includes('BOT') ? '#e74c3c' :
                                 violation.reason.includes('SUSPICIOUS') ? '#f39c12' : '#95a5a6';

            violationsHtml += `
              <div style="background: #2a2a2a; padding: 10px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid ${severityColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: ${severityColor};">${violation.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">Wallet: ${violation.wallet}</div>
                    ${violation.meta ? `<div style="color: #666; font-size: 0.8em;">${JSON.stringify(violation.meta).substring(0, 100)}...</div>` : ''}
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${time}</div>
                </div>
              </div>
            `;
          });
          violationsDiv.innerHTML = violationsHtml;
        } else {
          violationsDiv.innerHTML = '<div style="color: #27ae60; font-style: italic;">No recent violations - system is clean! 🎉</div>';
        }
      } catch (error) {
        console.error('Error loading violations:', error);
        document.getElementById('recentViolations').innerHTML = '<div style="color: #e74c3c;">Error loading violations</div>';
      }
    }

    async function loadSuspiciousActivity() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/suspicious-activity?limit=15`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const activityDiv = document.getElementById('suspiciousActivity');

        if (data.success && data.activity && data.activity.length > 0) {
          let activityHtml = '';
          data.activity.forEach(activity => {
            const time = new Date(activity.timestamp).toLocaleString();
            const riskColor = activity.riskScore >= 80 ? '#e74c3c' :
                             activity.riskScore >= 60 ? '#f39c12' : '#3498db';

            activityHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid ${riskColor};">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: ${riskColor};">Risk Score: ${activity.riskScore}/100</strong>
                    <div style="color: #ccc; font-size: 0.9em;">Wallet: ${activity.wallet}</div>
                    <div style="color: #666; font-size: 0.8em;">${activity.patterns.join(', ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${time}</div>
                </div>
              </div>
            `;
          });
          activityDiv.innerHTML = activityHtml;
        } else {
          activityDiv.innerHTML = '<div style="color: #27ae60; font-style: italic;">No suspicious activity detected! 🛡️</div>';
        }
      } catch (error) {
        console.error('Error loading suspicious activity:', error);
        document.getElementById('suspiciousActivity').innerHTML = '<div style="color: #e74c3c;">Error loading activity</div>';
      }
    }

    function refreshFraudData() {
      showAlert('Refreshing fraud detection data...', 'info');
      loadFraudAnalytics();
      loadRecentViolations();
      loadSuspiciousActivity();
      showAlert('Fraud data refreshed successfully', 'success');
    }

    async function exportViolations() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/export-violations`, {
          headers: { 'x-admin-key': adminKey }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `fraud-violations-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
          showAlert('Violations exported successfully', 'success');
        } else {
          showAlert('Failed to export violations', 'error');
        }
      } catch (error) {
        console.error('Export violations error:', error);
        showAlert('Error exporting violations', 'error');
      }
    }

    async function clearOldViolations() {
      const confirm = window.confirm('⚠️ Clear old violation data?\n\nThis will remove violations older than 30 days. Recent violations will be kept for security monitoring.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/security/clear-old-violations`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();
        if (data.success) {
          showAlert(`Cleared ${data.clearedCount || 0} old violation records`, 'success');
          refreshFraudData();
        } else {
          showAlert(`Failed to clear violations: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear violations error:', error);
        showAlert('Error clearing old violations', 'error');
      }
    }

    function adjustSensitivity() {
      showAlert('🎛️ Fraud detection sensitivity adjustment coming soon! Current settings are optimized for launch.', 'info');
    }

    // 🎭 Daily Meme Limits Control Functions
    async function loadMemeLimits() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-limits`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const limitsDiv = document.getElementById('currentMemeLimits');

        if (data.success) {
          const limits = data.limits;
          limitsDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid #e67e22;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Standard Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.daily} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">Default limit</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Premium Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.premium} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">10K+ WALDO holders</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">VIP Users</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.vip} memes/day</div>
                  <div style="color: #666; font-size: 0.9em;">50K+ WALDO holders</div>
                </div>
                <div>
                  <div style="color: #e67e22; font-weight: bold;">Reset Time</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${limits.resetHour}:00 UTC</div>
                  <div style="color: #666; font-size: 0.9em;">Daily reset</div>
                </div>
              </div>
            </div>
          `;

          // Update form placeholders
          document.getElementById('dailyMemeLimit').placeholder = limits.daily;
          document.getElementById('premiumMemeLimit').placeholder = limits.premium;
          document.getElementById('vipMemeLimit').placeholder = limits.vip;
          document.getElementById('resetHour').placeholder = limits.resetHour;
        } else {
          limitsDiv.innerHTML = '<div style="color: #e74c3c;">Error loading meme limits</div>';
        }
      } catch (error) {
        console.error('Error loading meme limits:', error);
        document.getElementById('currentMemeLimits').innerHTML = '<div style="color: #e74c3c;">Error loading limits</div>';
      }
    }

    async function updateMemeLimits() {
      const dailyLimit = parseInt(document.getElementById('dailyMemeLimit').value);
      const premiumLimit = parseInt(document.getElementById('premiumMemeLimit').value);
      const vipLimit = parseInt(document.getElementById('vipMemeLimit').value);
      const resetHour = parseInt(document.getElementById('resetHour').value);
      const reason = document.getElementById('memeLimitChangeReason').value.trim();

      if (!dailyLimit && !premiumLimit && !vipLimit && !resetHour && resetHour !== 0) {
        showAlert('Please enter at least one value to update', 'warning');
        return;
      }

      const resultDiv = document.getElementById('memeLimitResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">🎭 Updating meme limits...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/update-meme-limits`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            daily: dailyLimit || undefined,
            premium: premiumLimit || undefined,
            vip: vipLimit || undefined,
            resetHour: resetHour !== undefined ? resetHour : undefined,
            reason: reason || 'Admin meme limit update'
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Meme limits updated successfully!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              ${data.changes.join(' • ')}
            </div>
          `;

          // Clear form
          document.getElementById('dailyMemeLimit').value = '';
          document.getElementById('premiumMemeLimit').value = '';
          document.getElementById('vipMemeLimit').value = '';
          document.getElementById('resetHour').value = '';
          document.getElementById('memeLimitChangeReason').value = '';

          // Refresh displays
          loadMemeLimits();
          loadMemeLimitHistory();
          showAlert('Meme limits updated successfully', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ Failed to update: ${data.error}</div>`;
          showAlert(`Failed to update limits: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update meme limits error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Network error updating limits</div>';
        showAlert('Network error updating meme limits', 'error');
      }
    }

    async function resetMemeLimits() {
      const confirm = window.confirm('⚠️ Reset meme limits to defaults?\n\n• Standard: 10 memes/day\n• Premium: 25 memes/day (10K+ WALDO)\n• VIP: 50 memes/day (50K+ WALDO)\n• Reset: 0:00 UTC\n\nThis action cannot be undone.');
      if (!confirm) return;

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/reset-meme-limits`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            reason: 'Reset to default meme limits'
          })
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('memeLimitResult').innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">✅ Meme limits reset to defaults!</div>
            <div style="color: #ccc; margin-top: 5px; font-size: 0.9em;">
              Standard: 10 • Premium: 25 • VIP: 50 • Reset: 0:00 UTC
            </div>
          `;

          loadMemeLimits();
          loadMemeLimitHistory();
          showAlert('Meme limits reset to defaults', 'success');
        } else {
          showAlert(`Failed to reset: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset meme limits error:', error);
        showAlert('Network error resetting meme limits', 'error');
      }
    }

    function setQuickMemeLimit(preset, daily, premium, vip) {
      let eventName;

      switch(preset) {
        case 'strict':
          eventName = 'Strict Quality Control';
          break;
        case 'balanced':
          eventName = 'Balanced Limits';
          break;
        case 'generous':
          eventName = 'Generous Allowance';
          break;
        case 'unlimited':
          eventName = 'Unlimited Mode';
          break;
      }

      // Set the form values
      document.getElementById('dailyMemeLimit').value = daily;
      document.getElementById('premiumMemeLimit').value = premium;
      document.getElementById('vipMemeLimit').value = vip;
      document.getElementById('resetHour').value = 0; // Default to midnight
      document.getElementById('memeLimitChangeReason').value = eventName;

      // Auto-update
      updateMemeLimits();
    }

    async function loadMemeLimitHistory() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-limit-history`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();
        const historyDiv = document.getElementById('memeLimitHistory');

        if (data.success && data.history && data.history.length > 0) {
          let historyHtml = '';
          data.history.slice(0, 10).forEach(entry => { // Show last 10 changes
            const date = new Date(entry.timestamp).toLocaleString();
            historyHtml += `
              <div style="background: #2a2a2a; padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid #e67e22;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong style="color: #e67e22;">${entry.reason}</strong>
                    <div style="color: #ccc; font-size: 0.9em;">${entry.changes.join(' • ')}</div>
                  </div>
                  <div style="color: #666; font-size: 0.8em;">${date}</div>
                </div>
              </div>
            `;
          });
          historyDiv.innerHTML = historyHtml;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; font-style: italic;">No limit changes yet</div>';
        }
      } catch (error) {
        console.error('Error loading meme limit history:', error);
        document.getElementById('memeLimitHistory').innerHTML = '<div style="color: #e74c3c;">Error loading history</div>';
      }
    }

    async function lookupUserMemeUsage() {
      const wallet = document.getElementById('lookupWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'warning');
        return;
      }

      const resultDiv = document.getElementById('memeUsageResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">🔍 Looking up meme usage...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/user-meme-usage/${wallet}`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const usage = data.usage;
          const tierInfo = usage.waldoBalance >= 50000 ? 'VIP' :
                          usage.waldoBalance >= 10000 ? 'Premium' : 'Standard';
          const tierColor = usage.waldoBalance >= 50000 ? '#9b59b6' :
                           usage.waldoBalance >= 10000 ? '#f39c12' : '#3498db';

          resultDiv.innerHTML = `
            <div style="background: #333; padding: 12px; border-radius: 6px; border-left: 4px solid ${tierColor}; margin-top: 10px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="color: ${tierColor}; font-weight: bold;">Today's Usage</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${usage.todayCount}/${usage.dailyLimit} memes</div>
                  <div style="color: #666; font-size: 0.9em;">Remaining: ${usage.dailyLimit - usage.todayCount}</div>
                </div>
                <div>
                  <div style="color: ${tierColor}; font-weight: bold;">User Tier</div>
                  <div style="color: #27ae60; font-size: 1.2em;">${tierInfo}</div>
                  <div style="color: #666; font-size: 0.9em;">${usage.waldoBalance.toLocaleString()} WALDO</div>
                </div>
              </div>
              <div style="margin-top: 10px; color: #ccc; font-size: 0.9em;">
                Last reset: ${new Date(usage.lastReset).toLocaleString()} •
                Next reset: ${new Date(usage.nextReset).toLocaleString()}
              </div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">❌ ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Lookup meme usage error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">❌ Error looking up usage</div>';
      }
    }

    async function viewMemeUsage() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/system/meme-usage-stats`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          const stats = data.stats;
          showAlert(`📊 Meme Usage Stats:\n\n• Total users today: ${stats.totalUsers}\n• Average memes per user: ${stats.avgMemesPerUser}\n• Users at limit: ${stats.usersAtLimit}\n• Total memes today: ${stats.totalMemes}`, 'info');
        } else {
          showAlert(`Failed to get usage stats: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('View meme usage error:', error);
        showAlert('Error getting meme usage stats', 'error');
      }
    }

    function blockUser(wallet) {
      if (confirm(`🚨 SECURITY OVERRIDE: Block user ${wallet}?\n\nThis will immediately prevent them from:\n- Claiming rewards\n- Participating in battles\n- Receiving airdrops\n\nUse only if automated fraud detection failed.`)) {
        showAlert(`🚫 User ${wallet} blocked via manual override`, 'warning');
        // In production, this would call the security API
      }
    }

    function unblockUser(wallet) {
      if (confirm(`🔓 SECURITY OVERRIDE: Unblock user ${wallet}?\n\nThis will restore their access to all WALDO features.\n\nOnly unblock if you're certain they're legitimate.`)) {
        showAlert(`✅ User ${wallet} unblocked via manual override`, 'success');
        // In production, this would call the security API
      }
    }

    function endCurrentBattle() {
      if (confirm('🚨 BATTLE EMERGENCY OVERRIDE\n\nForce end the current battle?\n\nThis will:\n- Immediately end voting\n- Calculate winner based on current votes\n- Distribute rewards\n- Affect all active participants\n\nUse only if automated battle system failed.')) {
        showAlert('⚔️ Battle force-ended via emergency override', 'warning');
        // In production, this would call the battle API
      }
    }

    function cancelCurrentBattle() {
      if (confirm('🚨 BATTLE EMERGENCY CANCEL\n\nCancel the current battle entirely?\n\nThis will:\n- Cancel the battle without a winner\n- Refund all participants\n- Cannot be undone\n\nUse only in critical situations.')) {
        showAlert('❌ Battle cancelled via emergency override', 'error');
        // In production, this would call the battle API
      }
    }

    function refreshAllData() {
      if (confirm('🔄 FORCE DATA REFRESH\n\nThis will reload all dashboard data and may cause temporary slowdowns.\n\nContinue?')) {
        showAlert('🔄 Forcing data refresh...', 'success');
        loadSectionData(currentSection);
      }
    }

    function clearCache() {
      if (confirm('🗑️ EMERGENCY CACHE CLEAR\n\nThis will clear all system caches and may cause temporary performance issues.\n\nUse only if system is behaving unexpectedly.\n\nContinue?')) {
        showAlert('🗑️ Emergency cache clear initiated', 'warning');
        // In production, this would call the cache clear API
      }
    }

    function emergencyStop() {
      const confirmation = prompt('🚨 SYSTEM EMERGENCY STOP\n\nThis will halt ALL WALDOCOIN operations:\n- Stop all battles\n- Disable airdrops\n- Block all transactions\n- Affect all users\n\nType "EMERGENCY STOP" to confirm:');

      if (confirmation === 'EMERGENCY STOP') {
        showAlert('🛑 SYSTEM EMERGENCY STOP ACTIVATED', 'error');
        // In production, this would call the emergency stop API
      } else if (confirmation !== null) {
        showAlert('❌ Emergency stop cancelled - incorrect confirmation', 'warning');
      }
    }

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAdminAuth()) {
        loadSectionData('dashboard');
      }

      // Initialize stake selector event listener
      const stakeSelector = document.getElementById('stakeSelector');
      if (stakeSelector) {
        stakeSelector.addEventListener('change', function() {
          const stakeDetails = document.getElementById('stakeDetails');

          if (this.value) {
            const stake = JSON.parse(this.value);
            const unlockDate = new Date(stake.unlockDate).toLocaleDateString();
            const isMatured = new Date() >= new Date(stake.unlockDate);

            document.getElementById('stakeAmount').textContent = `${stake.amount} WALDO`;
            document.getElementById('stakeDuration').textContent = `${stake.duration} days`;
            document.getElementById('stakeAPY').textContent = `${(stake.apy * 100).toFixed(1)}%`;
            document.getElementById('stakeUnlockDate').textContent = unlockDate;
            document.getElementById('stakeRewards').textContent = `${(stake.currentRewards || 0).toFixed(2)} WALDO`;
            document.getElementById('stakeStatus').textContent = stake.status;

            // Show/hide force unstake option based on maturity
            const forceCheckbox = document.getElementById('forceUnstake');
            if (isMatured) {
              forceCheckbox.checked = false;
              forceCheckbox.disabled = true;
              forceCheckbox.parentElement.style.opacity = '0.5';
            } else {
              forceCheckbox.disabled = false;
              forceCheckbox.parentElement.style.opacity = '1';
            }

            stakeDetails.style.display = 'block';
          } else {
            stakeDetails.style.display = 'none';
          }
        });
      }
    });

    // Claimed Wallets Export Functions
    async function exportClaimedWallets() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Preparing CSV export...', 'info');

        // Create a temporary link to download the CSV
        const link = document.createElement('a');
        link.href = `${API_BASE}/api/airdrop/export-claimed`;
        link.style.display = 'none';

        // Set headers for the request
        const response = await fetch(`${API_BASE}/api/airdrop/export-claimed`, {
          method: 'GET',
          headers: {
            'x-admin-key': adminKey
          }
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          link.href = url;
          link.download = `waldo-airdrop-claimed-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);

          showAlert('✅ CSV file downloaded successfully!', 'success');
          updateClaimedWalletsInfo(); // Refresh the info
        } else {
          throw new Error('Export failed');
        }
      } catch (error) {
        console.error('Export error:', error);
        showAlert('❌ Failed to export CSV', 'error');
      }
    }

    async function viewClaimedWallets() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      try {
        showAlert('Loading claimed wallets...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/claimed-list`, {
          method: 'GET',
          headers: {
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          displayClaimedWalletsList(data);
          showAlert(`✅ Loaded ${data.totalWallets} claimed wallets`, 'success');
        } else {
          throw new Error(data.error || 'Failed to load wallets');
        }
      } catch (error) {
        console.error('View wallets error:', error);
        showAlert('❌ Failed to load claimed wallets', 'error');
      }
    }

    function displayClaimedWalletsList(data) {
      const container = document.getElementById('walletsTableContainer');
      const listDiv = document.getElementById('claimedWalletsList');

      let html = `
        <div style="margin-bottom: 10px; color: #25c2a0; font-weight: bold;">
          📊 Total: ${data.totalWallets} wallets | Manual: ${data.manualWallets || 0} | Regular: ${data.regularWallets || 0}
        </div>
        <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
          <thead>
            <tr style="background: #333; color: white;">
              <th style="padding: 8px; border: 1px solid #555; text-align: left;">#</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: left;">Wallet Address</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Type</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Amount</th>
              <th style="padding: 8px; border: 1px solid #555; text-align: center;">Status</th>
            </tr>
          </thead>
          <tbody>
      `;

      data.wallets.forEach((wallet, index) => {
        const isManual = wallet.claimType === 'Manual Airdrop';
        const typeColor = isManual ? '#ff6b6b' : '#25c2a0';
        const typeIcon = isManual ? '🎯' : '🎁';

        html += `
          <tr style="background: ${index % 2 === 0 ? '#222' : '#333'};">
            <td style="padding: 6px; border: 1px solid #555; color: #ccc;">${wallet.claimOrder}</td>
            <td style="padding: 6px; border: 1px solid #555; color: #25c2a0; font-family: monospace;">${wallet.wallet}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: ${typeColor};">${typeIcon} ${wallet.claimType}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: #ffd93d;">${parseInt(wallet.amount).toLocaleString()}</td>
            <td style="padding: 6px; border: 1px solid #555; text-align: center; color: #0f0;">✅ ${wallet.status}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top: 10px; font-size: 11px; color: #666;">
          Exported at: ${new Date(data.exportedAt).toLocaleString()}
        </div>
      `;

      container.innerHTML = html;
      listDiv.style.display = 'block';

      // Update info display
      updateClaimedWalletsInfo(data);
    }

    async function updateClaimedWalletsInfo(data = null) {
      if (!data) {
        // Fetch fresh data
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) return;

        try {
          const response = await fetch(`${API_BASE}/api/airdrop/claimed-list`, {
            method: 'GET',
            headers: { 'x-admin-key': adminKey }
          });
          data = await response.json();
        } catch (error) {
          console.error('Failed to update claimed wallets info:', error);
          return;
        }
      }

      if (data && data.success) {
        document.getElementById('totalClaimedCount').textContent = data.totalWallets;
        document.getElementById('manualCount').textContent = data.manualWallets || 0;
        document.getElementById('regularCount').textContent = data.regularWallets || 0;
        document.getElementById('remainingCount').textContent = (1000 - data.totalWallets);
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
      }
    }

    async function addMissingWallet() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        showAlert('Please enter admin key first', 'error');
        return;
      }

      const walletAddress = document.getElementById('missingWalletAddress').value.trim();
      const reason = document.getElementById('missingWalletReason').value.trim();

      if (!walletAddress) {
        showAlert('Please enter wallet address', 'error');
        return;
      }

      if (!walletAddress.startsWith('r') || walletAddress.length < 25) {
        showAlert('Invalid wallet address format', 'error');
        return;
      }

      try {
        showAlert('Adding wallet to tracking...', 'info');

        const response = await fetch(`${API_BASE}/api/airdrop/add-missing-wallet`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            wallet: walletAddress,
            reason: reason || 'Added via admin panel'
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`✅ Wallet added to tracking! Total tracked: ${data.totalTracked}`, 'success');

          // Clear inputs
          document.getElementById('missingWalletAddress').value = '';
          document.getElementById('missingWalletReason').value = '';

          // Refresh the claimed wallets list
          updateClaimedWalletsInfo();

          // If the list is currently visible, refresh it
          const listDiv = document.getElementById('claimedWalletsList');
          if (listDiv.style.display !== 'none') {
            viewClaimedWallets();
          }
        } else {
          showAlert(`❌ ${data.error}`, 'error');
        }

      } catch (error) {
        console.error('Add missing wallet error:', error);
        showAlert('❌ Failed to add wallet to tracking', 'error');
      }
    }

    // Initialize login check when page loads
    document.addEventListener('DOMContentLoaded', function() {
      checkExistingLogin();
      // Auto-load current password when page loads (with small delay to ensure DOM is ready)
      setTimeout(function() {
        getCurrentAirdropPassword();
        // Also auto-refresh trustline count to get latest data
        loadTrustlineCount();
        // Load claimed wallets info
        updateClaimedWalletsInfo();
      }, 1000);
    });
  </script>

  </div> <!-- Close adminPanel -->
</body>
</html>
