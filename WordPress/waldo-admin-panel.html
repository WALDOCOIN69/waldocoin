<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALDO Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
    }
    
    .admin-header {
      background: linear-gradient(90deg, #25c2a0, #1ea085);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .admin-title {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .admin-subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .admin-nav {
      background: #111;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
      background: #25c2a0;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #25c2a0;
      box-shadow: 0 0 10px rgba(37, 194, 160, 0.3);
    }
    
    .admin-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .admin-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .admin-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #222 0%, #333 100%);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #25c2a0;
      margin-bottom: 10px;
    }
    
    .stat-label {
      font-size: 1.1em;
      opacity: 0.8;
    }
    
    .admin-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .card-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #25c2a0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #ccc;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 15px;
      background: #333;
      border: 1px solid #555;
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #25c2a0;
      box-shadow: 0 0 0 2px rgba(37, 194, 160, 0.2);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      background: linear-gradient(135deg, #25c2a0, #1ea085);
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 194, 160, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }
    
    .data-table {
      width: 100%;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    
    .data-table th {
      background: #333;
      padding: 15px;
      text-align: left;
      font-weight: bold;
      color: #25c2a0;
      border-bottom: 1px solid #444;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
    }
    
    .data-table tr:hover {
      background: #2a2a2a;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .status-active {
      background: #27ae60;
      color: #fff;
    }
    
    .status-blocked {
      background: #e74c3c;
      color: #fff;
    }
    
    .status-flagged {
      background: #f39c12;
      color: #fff;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      border: 1px solid #27ae60;
      color: #2ecc71;
    }
    
    .alert-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
    }
    
    .alert-warning {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid #f39c12;
      color: #f39c12;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #25c2a0;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .nav-buttons {
        flex-direction: column;
      }
      
      .admin-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Admin Header -->
  <div class="admin-header">
    <div class="admin-title">üõ†Ô∏è WALDO Emergency Admin Panel</div>
    <div class="admin-subtitle">Backup controls and manual overrides for automated systems</div>
  </div>

  <!-- Navigation -->
  <div class="admin-nav">
    <div class="nav-buttons">
      <button class="nav-btn active" onclick="showSection('dashboard')">üìä System Status</button>
      <button class="nav-btn" onclick="showSection('users')">üë• User Override</button>
      <button class="nav-btn" onclick="showSection('airdrops')">üéÅ Manual Airdrop</button>
      <button class="nav-btn" onclick="showSection('battles')">‚öîÔ∏è Battle Override</button>
      <button class="nav-btn" onclick="showSection('staking')">üè¶ Staking Monitor</button>
      <button class="nav-btn" onclick="showSection('security')">üõ°Ô∏è Security Override</button>
      <button class="nav-btn" onclick="showSection('dao')">üó≥Ô∏è DAO Override</button>
      <button class="nav-btn" onclick="showSection('system')">‚öôÔ∏è Emergency Controls</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Dashboard Section -->
    <div id="dashboard" class="admin-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWaldoDistributed">-</div>
          <div class="stat-label">WALDO Distributed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeBattles">-</div>
          <div class="stat-label">Active Battles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStaked">-</div>
          <div class="stat-label">Total Staked</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üìà Recent Activity</div>
          <div id="recentActivity" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
        
        <div class="admin-card">
          <div class="card-title">üö® System Alerts</div>
          <div id="systemAlerts" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users" class="admin-section">
      <div class="alert alert-warning" style="margin-bottom: 20px;">
        ‚ö†Ô∏è <strong>User Security Override</strong><br>
        Manual user blocking/unblocking for when automated fraud detection needs intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">üë• User Security Controls</div>

        <div class="form-group">
          <input type="text" id="userSearch" class="form-input" placeholder="Search by wallet address or Twitter handle...">
        </div>

        <div id="usersList" class="loading">
          <div class="spinner"></div> Loading users...
        </div>
      </div>
    </div>

    <!-- Airdrops Section -->
    <div id="airdrops" class="admin-section">
      <div class="alert alert-warning" style="margin-bottom: 20px;">
        ‚ö†Ô∏è <strong>Manual Airdrop Override</strong><br>
        Use this only when automated airdrop system fails or for emergency distributions.
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üéÅ Emergency Airdrop</div>

          <form id="airdropForm">
            <div class="form-group">
              <label class="form-label">Wallet Address</label>
              <input type="text" id="airdropWallet" class="form-input" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" required>
            </div>

            <div class="form-group">
              <label class="form-label">Amount (WALDO)</label>
              <input type="number" id="airdropAmount" class="form-input" placeholder="1000" min="1" max="10000" required>
            </div>

            <div class="form-group">
              <label class="form-label">Reason (Required for manual override)</label>
              <input type="text" id="airdropReason" class="form-input" placeholder="e.g., Automated system failed, emergency distribution" required>
            </div>

            <button type="submit" class="btn btn-warning">‚ö†Ô∏è Manual Override Send</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">üìä Airdrop Statistics</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="airdropsClaimed">-</div>
              <div class="stat-label">Claims / 1000</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="airdropsRemaining">-</div>
              <div class="stat-label">Remaining</div>
            </div>
          </div>

          <div id="airdropHistory" class="loading">
            <div class="spinner"></div> Loading history...
          </div>
        </div>
      </div>
    </div>

    <!-- Battles Section -->
    <div id="battles" class="admin-section">
      <div class="alert alert-warning" style="margin-bottom: 20px;">
        ‚ö†Ô∏è <strong>Battle Emergency Controls</strong><br>
        Use these controls only when automated battle system malfunctions or requires manual intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">‚öîÔ∏è Battle Override Controls</div>

        <div class="grid-2">
          <div>
            <h3 style="color: #25c2a0; margin-bottom: 15px;">Current Battle Status</h3>
            <div id="currentBattle" class="loading">
              <div class="spinner"></div> Loading...
            </div>
          </div>

          <div>
            <h3 style="color: #25c2a0; margin-bottom: 15px;">Emergency Controls</h3>
            <div class="alert alert-error" style="margin-bottom: 15px; font-size: 0.9em;">
              ‚ö†Ô∏è These actions cannot be undone and will affect active users
            </div>
            <button class="btn btn-warning" onclick="endCurrentBattle()">‚èπÔ∏è Force End Battle</button>
            <button class="btn btn-danger" onclick="cancelCurrentBattle()">‚ùå Emergency Cancel</button>
          </div>
        </div>

        <h3 style="color: #25c2a0; margin: 25px 0 15px 0;">Recent Battles</h3>
        <div id="battleHistory" class="loading">
          <div class="spinner"></div> Loading battle history...
        </div>
      </div>
    </div>

    <!-- Staking Section -->
    <div id="staking" class="admin-section">
      <div class="admin-card">
        <div class="card-title">üè¶ Staking Overview</div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalStakingPositions">-</div>
            <div class="stat-label">Active Stakes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalStakingValue">-</div>
            <div class="stat-label">Total Value</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalStakingRewards">-</div>
            <div class="stat-label">Total Rewards</div>
          </div>
        </div>

        <div id="stakingPositions" class="loading">
          <div class="spinner"></div> Loading staking positions...
        </div>
      </div>
    </div>

    <!-- Security Section -->
    <div id="security" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üõ°Ô∏è Security Monitoring</div>

          <div id="securityAlerts" class="loading">
            <div class="spinner"></div> Loading security data...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">üö® Fraud Detection</div>

          <div class="form-group">
            <label class="form-label">Check Wallet</label>
            <input type="text" id="securityWallet" class="form-input" placeholder="Enter wallet address">
            <button class="btn" onclick="checkWalletSecurity()" style="margin-top: 10px;">üîç Check Security</button>
          </div>

          <div id="securityResults"></div>
        </div>
      </div>
    </div>

    <!-- DAO Section -->
    <div id="dao" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üó≥Ô∏è Create DAO Proposal</div>

          <form id="daoForm">
            <div class="form-group">
              <label class="form-label">Proposal Title</label>
              <input type="text" id="daoTitle" class="form-input" placeholder="Enter proposal title" required>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea id="daoDescription" class="form-input form-textarea" placeholder="Describe the proposal..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Options (comma-separated)</label>
              <input type="text" id="daoOptions" class="form-input" placeholder="Yes, No" required>
            </div>

            <div class="form-group">
              <label class="form-label">Duration (hours)</label>
              <input type="number" id="daoDuration" class="form-input" placeholder="72" min="1" required>
            </div>

            <button type="submit" class="btn">üì® Create Proposal</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">üìã Active Proposals</div>

          <div id="daoProposals" class="loading">
            <div class="spinner"></div> Loading proposals...
          </div>
        </div>
      </div>
    </div>

    <!-- System Section -->
    <div id="system" class="admin-section">
      <div class="alert alert-error" style="margin-bottom: 20px;">
        üö® <strong>EMERGENCY SYSTEM CONTROLS</strong><br>
        These controls can affect the entire WALDOCOIN system. Use only in critical situations.
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">‚öôÔ∏è System Health Monitor</div>

          <div id="systemHealth" class="loading">
            <div class="spinner"></div> Checking system health...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">üö® Emergency Controls</div>

          <div class="alert alert-warning" style="margin-bottom: 15px; font-size: 0.9em;">
            ‚ö†Ô∏è These actions affect all users and cannot be easily undone
          </div>

          <div style="display: flex; flex-direction: column; gap: 15px;">
            <button class="btn" onclick="refreshAllData()">üîÑ Force Data Refresh</button>
            <button class="btn btn-warning" onclick="clearCache()">üóëÔ∏è Emergency Cache Clear</button>
            <button class="btn btn-danger" onclick="emergencyStop()">üõë SYSTEM EMERGENCY STOP</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Production Configuration
    const API_BASE = "https://waldocoin-backend-api.onrender.com";
    const ADMIN_WALLET = "rMJMw3i7W4dxTBkLKSnkNETCGPeons2MVt"; // WALDO distributor wallet
    let currentSection = 'dashboard';
    let isAuthenticated = false;

    // Authentication check
    function checkAdminAuth() {
      const wallet = localStorage.getItem("xummWallet");
      if (!wallet || wallet !== ADMIN_WALLET) {
        showAuthModal();
        return false;
      }
      isAuthenticated = true;
      return true;
    }

    // Show authentication modal
    function showAuthModal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
      `;
      modal.innerHTML = `
        <div style="background: #111; padding: 40px; border-radius: 15px; text-align: center; max-width: 400px;">
          <h2 style="color: #25c2a0; margin-bottom: 20px;">üîê Admin Access Required</h2>
          <p style="color: #ccc; margin-bottom: 30px;">Only authorized WALDO administrators can access this panel.</p>
          <button onclick="redirectToLogin()" style="background: #25c2a0; color: #000; border: none; padding: 15px 30px; border-radius: 8px; font-weight: bold; cursor: pointer;">
            üîë Login with WALDO Wallet
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    // Redirect to login
    function redirectToLogin() {
      window.location.href = "https://waldocoin.live/connect-waldo-wallet/";
    }

    // Navigation
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionName).classList.add('active');

      // Add active class to clicked button
      event.target.classList.add('active');

      currentSection = sectionName;

      // Load section data
      loadSectionData(sectionName);
    }

    // Production-ready API call wrapper
    async function apiCall(endpoint, options = {}) {
      if (!isAuthenticated) {
        throw new Error('Authentication required');
      }

      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'X-Admin-Wallet': ADMIN_WALLET,
          ...options.headers
        }
      };

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...defaultOptions,
          ...options
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`API Error [${endpoint}]:`, error);
        throw error;
      }
    }

    // Load data for specific section with error handling
    async function loadSectionData(section) {
      if (!checkAdminAuth()) return;

      try {
        switch(section) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'users':
            await loadUsersData();
            break;
          case 'airdrops':
            await loadAirdropsData();
            break;
          case 'battles':
            await loadBattlesData();
            break;
          case 'staking':
            await loadStakingData();
            break;
          case 'security':
            await loadSecurityData();
            break;
          case 'dao':
            await loadDAOData();
            break;
          case 'system':
            await loadSystemData();
            break;
        }
      } catch (error) {
        showAlert(`Error loading ${section}: ${error.message}`, 'error');
      }
    }

    // Dashboard functions - Production Ready
    async function loadDashboardData() {
      try {
        // Load tokenomics stats for dashboard
        const tokenomicsData = await apiCall('/api/tokenomics/stats');
        if (tokenomicsData.success) {
          const stats = tokenomicsData.stats;
          document.getElementById('totalUsers').textContent = stats.totalUsers || '0';
          document.getElementById('totalWaldoDistributed').textContent = (stats.airdrop.totalDistributed / 1000000).toFixed(1) + 'M';
          document.getElementById('activeBattles').textContent = stats.battles.active || '0';
          document.getElementById('totalStaked').textContent = (stats.staking?.totalStaked / 1000 || 0).toFixed(1) + 'K';
        }

        // Load battle status for activity
        const battleData = await apiCall('/api/battle/current');
        const activityDiv = document.getElementById('recentActivity');

        let activityHtml = '';
        if (battleData.active) {
          activityHtml += `
            <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
              <div style="font-weight: bold; color: #25c2a0;">‚öîÔ∏è Battle #${battleData.id} Active</div>
              <div style="font-size: 0.9em; opacity: 0.8;">${battleData.meme1.votes + battleData.meme2.votes} total votes</div>
            </div>
          `;
        }

        // Load recent airdrop activity
        try {
          const airdropStatus = await apiCall('/api/airdrop/status');
          if (airdropStatus.success) {
            activityHtml += `
              <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
                <div style="font-weight: bold; color: #25c2a0;">üéÅ Airdrop Status</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${airdropStatus.airdrop.totalClaimed}/1000 claimed</div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('Could not load airdrop status');
        }

        if (!activityHtml) {
          activityHtml = '<div style="color: #666; text-align: center; padding: 20px;">No recent activity</div>';
        }
        activityDiv.innerHTML = activityHtml;

        // System health check
        const alertsDiv = document.getElementById('systemAlerts');
        const healthChecks = await performHealthChecks();
        alertsDiv.innerHTML = healthChecks;

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Error loading dashboard data: ' + error.message, 'error');

        // Show fallback data
        document.getElementById('totalUsers').textContent = '-';
        document.getElementById('totalWaldoDistributed').textContent = '-';
        document.getElementById('activeBattles').textContent = '-';
        document.getElementById('totalStaked').textContent = '-';
      }
    }

    // Production health checks
    async function performHealthChecks() {
      let healthHtml = '';

      try {
        // Check API connectivity
        await apiCall('/api/health');
        healthHtml += '<div class="alert alert-success">‚úÖ Backend API: Online</div>';
      } catch (e) {
        healthHtml += '<div class="alert alert-error">‚ùå Backend API: Offline</div>';
      }

      try {
        // Check battle system
        await apiCall('/api/battle/current');
        healthHtml += '<div class="alert alert-success">‚úÖ Battle System: Operational</div>';
      } catch (e) {
        healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Battle System: Issues detected</div>';
      }

      try {
        // Check airdrop system
        const airdropData = await apiCall('/api/airdrop/status');
        if (airdropData.success && airdropData.airdrop.isActive) {
          healthHtml += '<div class="alert alert-success">‚úÖ Airdrop System: Active</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Airdrop System: Inactive</div>';
        }
      } catch (e) {
        healthHtml += '<div class="alert alert-error">‚ùå Airdrop System: Error</div>';
      }

      return healthHtml || '<div class="alert alert-warning">‚ö†Ô∏è Unable to perform health checks</div>';
    }

    // Utility functions
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      // Insert at top of current section
      const currentSectionEl = document.querySelector('.admin-section.active');
      currentSectionEl.insertBefore(alertDiv, currentSectionEl.firstChild);

      // Remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Users functions - Production Ready
    async function loadUsersData() {
      try {
        // Get user stats from multiple endpoints
        const [battleLeaderboard, securityData] = await Promise.allSettled([
          apiCall('/api/battle/leaderboard'),
          apiCall('/api/security/overview')
        ]);

        const usersDiv = document.getElementById('usersList');
        let usersHtml = '';

        // Combine data from battle leaderboard (most active users)
        if (battleLeaderboard.status === 'fulfilled' && battleLeaderboard.value.leaderboard) {
          const users = battleLeaderboard.value.leaderboard.slice(0, 50); // Top 50 users

          usersHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Twitter</th>
                  <th>Battle Wins</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
                  const isBlocked = securityData.status === 'fulfilled' &&
                    securityData.value.blockedUsers?.includes(user.wallet);

                  return `
                    <tr>
                      <td><code>${user.wallet.slice(0, 8)}...${user.wallet.slice(-6)}</code></td>
                      <td>${user.twitter ? `@${user.twitter}` : '-'}</td>
                      <td>${user.wins || 0}</td>
                      <td><span class="status-badge status-${isBlocked ? 'blocked' : 'active'}">${isBlocked ? 'BLOCKED' : 'ACTIVE'}</span></td>
                      <td>
                        <button type="button" class="btn" onclick="viewUser('${user.wallet}')">üëÅÔ∏è View</button>
                        <button type="button" class="btn ${isBlocked ? 'btn-warning' : 'btn-danger'}" onclick="${isBlocked ? 'unblockUser' : 'blockUser'}('${user.wallet}')">${isBlocked ? '‚úÖ Unblock' : 'üö´ Block'}</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        } else {
          usersHtml = '<div style="text-align: center; color: #666; padding: 40px;">No user data available</div>';
        }

        usersDiv.innerHTML = usersHtml;

      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 40px;">Error loading users: ' + error.message + '</div>';
      }
    }

    // Airdrops functions - Production Ready
    async function loadAirdropsData() {
      try {
        // Load airdrop status
        const airdropData = await apiCall('/api/airdrop/status');

        if (airdropData.success) {
          document.getElementById('airdropsClaimed').textContent = `${airdropData.airdrop.totalClaimed}/1000`;
          document.getElementById('airdropsRemaining').textContent = airdropData.airdrop.remaining;
        }

        // Load tokenomics for airdrop history
        const tokenomicsData = await apiCall('/api/tokenomics/stats');
        const historyDiv = document.getElementById('airdropHistory');

        if (tokenomicsData.success) {
          const stats = tokenomicsData.stats;
          historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Airdrop Statistics</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="font-weight: bold; color: #fff;">${stats.airdrop.totalClaimed}</div>
                  <div style="color: #ccc; font-size: 0.9em;">Total Claims</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #fff;">${(stats.airdrop.totalDistributed / 1000000).toFixed(2)}M</div>
                  <div style="color: #ccc; font-size: 0.9em;">WALDO Distributed</div>
                </div>
              </div>
            </div>

            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üéØ System Status</h4>
              <div style="color: ${airdropData.airdrop.isActive ? '#27ae60' : '#e74c3c'};">
                ${airdropData.airdrop.isActive ? '‚úÖ Airdrop system is ACTIVE' : '‚ùå Airdrop system is INACTIVE'}
              </div>
              <div style="color: #ccc; margin-top: 5px;">
                ${airdropData.airdrop.remaining} airdrops remaining
              </div>
            </div>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Unable to load airdrop data</div>';
        }

      } catch (error) {
        console.error('Error loading airdrops:', error);
        document.getElementById('airdropHistory').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading airdrop data: ' + error.message + '</div>';
      }
    }

    // Battle functions
    async function loadBattlesData() {
      try {
        const res = await fetch(`${API_BASE}/api/battle/current`);
        const battle = await res.json();

        const currentDiv = document.getElementById('currentBattle');
        if (battle.active) {
          currentDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <div style="font-weight: bold; color: #25c2a0;">Battle #${battle.id}</div>
              <div style="margin: 10px 0;">
                <div>Meme 1: ${battle.meme1.votes || 0} votes</div>
                <div>Meme 2: ${battle.meme2.votes || 0} votes</div>
              </div>
              <div style="color: #666;">Ends: ${new Date(battle.endTime).toLocaleString()}</div>
            </div>
          `;
        } else {
          currentDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active battle</div>';
        }

        // Load battle history
        const historyRes = await fetch(`${API_BASE}/api/battle/history`);
        const history = await historyRes.json();

        const historyDiv = document.getElementById('battleHistory');
        if (history.battles && history.battles.length > 0) {
          historyDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Votes</th>
                  <th>Winner</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${history.battles.slice(0, 10).map(battle => `
                  <tr>
                    <td>#${battle.id}</td>
                    <td>${battle.totalVotes || 0}</td>
                    <td>${battle.winner || '-'}</td>
                    <td><span class="status-badge status-${battle.ended ? 'active' : 'flagged'}">${battle.ended ? 'ENDED' : 'ACTIVE'}</span></td>
                    <td>${new Date(battle.createdAt).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No battle history</div>';
        }
      } catch (error) {
        console.error('Error loading battles:', error);
      }
    }

    // Staking functions
    async function loadStakingData() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/staking-overview`);
        const data = await res.json();

        if (data.success) {
          document.getElementById('totalStakingPositions').textContent = data.data.totalPositions || '0';
          document.getElementById('totalStakingValue').textContent = (data.data.totalValue / 1000).toFixed(1) + 'K';
          document.getElementById('totalStakingRewards').textContent = (data.data.totalRewards / 1000).toFixed(1) + 'K';
        }

        const positionsDiv = document.getElementById('stakingPositions');
        if (data.success && data.data.positions.length > 0) {
          positionsDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Amount</th>
                  <th>Duration</th>
                  <th>APY</th>
                  <th>Rewards</th>
                  <th>Unlock Date</th>
                </tr>
              </thead>
              <tbody>
                ${data.data.positions.slice(0, 20).map(pos => `
                  <tr>
                    <td><code>${pos.wallet.slice(0, 8)}...${pos.wallet.slice(-6)}</code></td>
                    <td>${pos.amount} WALDO</td>
                    <td>${pos.duration} days</td>
                    <td>${(pos.apy * 100).toFixed(1)}%</td>
                    <td>${pos.currentRewards.toFixed(2)} WALDO</td>
                    <td>${new Date(pos.unlockDate).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          positionsDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No staking positions</div>';
        }
      } catch (error) {
        console.error('Error loading staking data:', error);
      }
    }

    // Security functions
    async function loadSecurityData() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/security-overview`);
        const data = await res.json();

        const alertsDiv = document.getElementById('securityAlerts');
        if (data.success) {
          alertsDiv.innerHTML = `
            <div style="margin-bottom: 20px;">
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${data.data.blockedUsers || 0}</div>
                  <div style="color: #ccc;">Blocked Users</div>
                </div>
                <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${data.data.flaggedUsers || 0}</div>
                  <div style="color: #ccc;">Flagged Users</div>
                </div>
                <div style="background: #333; padding: 15px; border-radius: 8px; text-align: center;">
                  <div style="font-size: 1.5em; color: #27ae60; font-weight: bold;">${data.data.totalViolations || 0}</div>
                  <div style="color: #ccc;">Total Violations</div>
                </div>
              </div>
            </div>

            ${data.data.recentAlerts && data.data.recentAlerts.length > 0 ?
              data.data.recentAlerts.map(alert => `
                <div class="alert alert-${alert.type}">
                  <strong>${alert.title}</strong><br>
                  ${alert.message}
                  <div style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">${new Date(alert.timestamp).toLocaleString()}</div>
                </div>
              `).join('') :
              '<div style="color: #27ae60; text-align: center; padding: 20px;">‚úÖ No security alerts</div>'
            }
          `;
        }
      } catch (error) {
        console.error('Error loading security data:', error);
      }
    }

    async function checkWalletSecurity() {
      const wallet = document.getElementById('securityWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/security/check/${wallet}`);
        const data = await res.json();

        const resultsDiv = document.getElementById('securityResults');
        if (data.success) {
          resultsDiv.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">Security Report for ${wallet.slice(0, 8)}...${wallet.slice(-6)}</h4>
              <div><strong>Status:</strong> <span class="status-badge status-${data.status.toLowerCase()}">${data.status}</span></div>
              <div><strong>Violations:</strong> ${data.violationCount}</div>
              <div><strong>Blocked:</strong> ${data.isBlocked ? 'Yes' : 'No'}</div>
              <div><strong>Last Check:</strong> ${new Date().toLocaleString()}</div>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('securityResults').innerHTML = `<div class="alert alert-error">Network error checking wallet</div>`;
      }
    }

    // Initialize admin panel - Production Ready
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication first
      if (!checkAdminAuth()) {
        return; // Auth modal will be shown
      }

      // Show admin info
      const adminInfo = document.createElement('div');
      adminInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #333; padding: 10px; border-radius: 5px; font-size: 0.9em; z-index: 1000;';
      adminInfo.innerHTML = `
        <div style="color: #25c2a0;">üîê Admin: ${ADMIN_WALLET.slice(0, 8)}...${ADMIN_WALLET.slice(-6)}</div>
        <button onclick="logout()" style="background: #e74c3c; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Logout</button>
      `;
      document.body.appendChild(adminInfo);

      // Load initial data
      loadDashboardData();

      // Set up form handlers
      document.getElementById('airdropForm').addEventListener('submit', handleAirdropSubmit);
      document.getElementById('daoForm').addEventListener('submit', handleDAOSubmit);

      // Set up periodic refresh
      setInterval(() => {
        if (currentSection === 'dashboard') {
          loadDashboardData();
        }
      }, 30000); // Refresh every 30 seconds

      // Listen for wallet changes (logout detection)
      window.addEventListener('storage', (e) => {
        if (e.key === 'xummWallet' && e.newValue !== ADMIN_WALLET) {
          location.reload();
        }
      });
    });

    // Logout function
    function logout() {
      if (confirm('Logout from admin panel?')) {
        localStorage.removeItem('xummWallet');
        sessionStorage.removeItem('waldoLoginDesktop');
        window.location.href = 'https://waldocoin.live/';
      }
    }

    // Form handlers - Production Ready
    async function handleAirdropSubmit(e) {
      e.preventDefault();

      const wallet = document.getElementById('airdropWallet').value.trim();
      const amount = parseFloat(document.getElementById('airdropAmount').value);
      const reason = document.getElementById('airdropReason').value.trim() || 'Admin manual airdrop';

      // Validation
      if (!wallet || !wallet.match(/^r[a-zA-Z0-9]{24,34}$/)) {
        showAlert('Please enter a valid XRPL wallet address', 'error');
        return;
      }

      if (!amount || amount <= 0 || amount > 10000) {
        showAlert('Amount must be between 1 and 10,000 WALDO', 'error');
        return;
      }

      // Confirm action
      if (!confirm(`Send ${amount} WALDO to ${wallet}?\n\nReason: ${reason}`)) {
        return;
      }

      try {
        // Use the existing airdrop endpoint
        const data = await apiCall('/api/airdrop', {
          method: 'POST',
          body: JSON.stringify({
            wallet,
            amount,
            adminOverride: true,
            reason
          })
        });

        if (data.success) {
          showAlert(`‚úÖ Airdrop sent successfully! Transaction: ${data.txHash || 'Pending'}`, 'success');
          document.getElementById('airdropForm').reset();
          loadAirdropsData();
        } else {
          showAlert(`‚ùå ${data.error || 'Failed to send airdrop'}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Error sending airdrop: ${error.message}`, 'error');
      }
    }

    async function handleDAOSubmit(e) {
      e.preventDefault();

      const title = document.getElementById('daoTitle').value.trim();
      const description = document.getElementById('daoDescription').value.trim();
      const options = document.getElementById('daoOptions').value.split(',').map(opt => opt.trim()).filter(Boolean);
      const duration = parseInt(document.getElementById('daoDuration').value);

      try {
        const res = await fetch(`${API_BASE}/api/dao/proposals/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, options, durationHours: duration })
        });

        const data = await res.json();

        if (data.success) {
          showAlert('DAO proposal created successfully!', 'success');
          document.getElementById('daoForm').reset();
          loadDAOData();
        } else {
          showAlert(data.error || 'Failed to create proposal', 'error');
        }
      } catch (error) {
        showAlert('Network error creating proposal', 'error');
      }
    }

    // Placeholder functions for remaining features
    async function loadDAOData() {
      document.getElementById('daoProposals').innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">DAO features coming soon...</div>';
    }

    async function loadSystemData() {
      document.getElementById('systemHealth').innerHTML = `
        <div class="alert alert-success">‚úÖ Backend API: Online</div>
        <div class="alert alert-success">‚úÖ Database: Connected</div>
        <div class="alert alert-success">‚úÖ XRPL: Connected</div>
        <div class="alert alert-warning">‚ö†Ô∏è High memory usage: 78%</div>
      `;
    }

    // Emergency Action Functions
    function viewUser(wallet) {
      showAlert(`Viewing security details for: ${wallet}`, 'success');
      // In production, this would show detailed user security info
    }

    function blockUser(wallet) {
      if (confirm(`üö® SECURITY OVERRIDE: Block user ${wallet}?\n\nThis will immediately prevent them from:\n- Claiming rewards\n- Participating in battles\n- Receiving airdrops\n\nUse only if automated fraud detection failed.`)) {
        showAlert(`üö´ User ${wallet} blocked via manual override`, 'warning');
        // In production, this would call the security API
      }
    }

    function unblockUser(wallet) {
      if (confirm(`üîì SECURITY OVERRIDE: Unblock user ${wallet}?\n\nThis will restore their access to all WALDO features.\n\nOnly unblock if you're certain they're legitimate.`)) {
        showAlert(`‚úÖ User ${wallet} unblocked via manual override`, 'success');
        // In production, this would call the security API
      }
    }

    function endCurrentBattle() {
      if (confirm('üö® BATTLE EMERGENCY OVERRIDE\n\nForce end the current battle?\n\nThis will:\n- Immediately end voting\n- Calculate winner based on current votes\n- Distribute rewards\n- Affect all active participants\n\nUse only if automated battle system failed.')) {
        showAlert('‚öîÔ∏è Battle force-ended via emergency override', 'warning');
        // In production, this would call the battle API
      }
    }

    function cancelCurrentBattle() {
      if (confirm('üö® BATTLE EMERGENCY CANCEL\n\nCancel the current battle entirely?\n\nThis will:\n- Cancel the battle without a winner\n- Refund all participants\n- Cannot be undone\n\nUse only in critical situations.')) {
        showAlert('‚ùå Battle cancelled via emergency override', 'error');
        // In production, this would call the battle API
      }
    }

    function refreshAllData() {
      if (confirm('üîÑ FORCE DATA REFRESH\n\nThis will reload all dashboard data and may cause temporary slowdowns.\n\nContinue?')) {
        showAlert('üîÑ Forcing data refresh...', 'success');
        loadSectionData(currentSection);
      }
    }

    function clearCache() {
      if (confirm('üóëÔ∏è EMERGENCY CACHE CLEAR\n\nThis will clear all system caches and may cause temporary performance issues.\n\nUse only if system is behaving unexpectedly.\n\nContinue?')) {
        showAlert('üóëÔ∏è Emergency cache clear initiated', 'warning');
        // In production, this would call the cache clear API
      }
    }

    function emergencyStop() {
      const confirmation = prompt('üö® SYSTEM EMERGENCY STOP\n\nThis will halt ALL WALDOCOIN operations:\n- Stop all battles\n- Disable airdrops\n- Block all transactions\n- Affect all users\n\nType "EMERGENCY STOP" to confirm:');

      if (confirmation === 'EMERGENCY STOP') {
        showAlert('üõë SYSTEM EMERGENCY STOP ACTIVATED', 'error');
        // In production, this would call the emergency stop API
      } else if (confirmation !== null) {
        showAlert('‚ùå Emergency stop cancelled - incorrect confirmation', 'warning');
      }
    }
  </script>
</body>
</html>
