<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WALDO Admin Panel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      color: #fff;
      min-height: 100vh;
    }
    
    .admin-header {
      background: linear-gradient(90deg, #25c2a0, #1ea085);
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .admin-title {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .admin-subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }
    
    .admin-nav {
      background: #111;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
    }
    
    .nav-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      background: #333;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .nav-btn:hover {
      background: #25c2a0;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #25c2a0;
      box-shadow: 0 0 10px rgba(37, 194, 160, 0.3);
    }
    
    .admin-content {
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .admin-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    .admin-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #222 0%, #333 100%);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid #444;
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      color: #25c2a0;
      margin-bottom: 10px;
    }
    
    .stat-label {
      font-size: 1.1em;
      opacity: 0.8;
    }
    
    .admin-card {
      background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .card-title {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #25c2a0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #ccc;
    }
    
    .form-input {
      width: 100%;
      padding: 12px 15px;
      background: #333;
      border: 1px solid #555;
      border-radius: 8px;
      color: #fff;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #25c2a0;
      box-shadow: 0 0 0 2px rgba(37, 194, 160, 0.2);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      background: linear-gradient(135deg, #25c2a0, #1ea085);
      color: #000;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 1em;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(37, 194, 160, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: #fff;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #666, #555);
      color: #fff;
    }

    /* Password Management Styles */
    .password-display {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #25c2a0;
      text-align: center;
      font-size: 1.2em;
      font-weight: bold;
      color: #25c2a0;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
    }

    .password-source {
      background: rgba(255, 217, 61, 0.1);
      border: 1px solid #ffd93d;
      color: #ffd93d;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      text-align: center;
    }

    .quick-passwords {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }

    .quick-btn {
      background: #444;
      color: white;
      border: 1px solid #666;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      text-align: center;
    }

    .quick-btn:hover {
      background: #555;
      border-color: #25c2a0;
      transform: translateY(-1px);
    }

    /* Environment Status Styles */
    .env-status {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #444;
    }

    .env-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px 0;
      border-bottom: 1px solid #444;
    }

    .env-item:last-child {
      margin-bottom: 0;
      border-bottom: none;
    }

    .env-label {
      color: #ccc;
      font-size: 0.9em;
    }

    .env-value {
      color: #25c2a0;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }

    /* Login Screen Styles */
    .login-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .login-container {
      background: #111;
      border: 2px solid #25c2a0;
      border-radius: 18px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 0 30px rgba(37, 194, 160, 0.3);
      text-align: center;
    }

    .login-header h1 {
      color: #25c2a0;
      margin: 0 0 10px 0;
      font-size: 2.2em;
    }

    .login-header p {
      color: #ccc;
      margin: 0 0 30px 0;
      font-size: 1.1em;
    }

    .login-form {
      text-align: left;
    }

    .login-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
      font-weight: bold;
    }

    .login-info {
      background: rgba(37, 194, 160, 0.1);
      border: 1px solid #25c2a0;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }

    .login-info p {
      color: #25c2a0;
      margin: 5px 0;
      font-size: 0.9em;
    }

    .header-with-logout {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    /* Utility Classes */
    .hidden { display: none !important; }
    .margin-bottom-30 { margin-bottom: 30px; }
    .margin-bottom-20 { margin-bottom: 20px; }
    .margin-bottom-15 { margin-bottom: 15px; }
    .margin-bottom-10 { margin-bottom: 10px; }
    .margin-top-15 { margin-top: 15px; }
    .margin-top-10 { margin-top: 10px; }
    .text-center { text-align: center; }
    .text-muted { color: #666; }
    .text-success { color: #27ae60; }
    .text-error { color: #e74c3c; }
    .text-warning { color: #f39c12; }
    .text-primary { color: #25c2a0; }
    .padding-20 { padding: 20px; }
    .width-100 { width: 100%; }
    .font-small { font-size: 0.9em; }
    .font-bold { font-weight: bold; }
    .opacity-80 { opacity: 0.8; }

    .status-container {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }

    .stat-box {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-number {
      font-size: 1.5em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .help-text {
      color: #666;
      display: block;
      margin-top: 5px;
      font-size: 0.9em;
    }

    /* Additional utility classes */
    .section-title {
      color: #25c2a0;
      margin-bottom: 15px;
    }

    .section-title-spaced {
      color: #25c2a0;
      margin: 25px 0 15px 0;
    }

    .stake-details {
      display: none;
      background: #222;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .emergency-controls {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .checkbox-margin {
      margin-right: 8px;
    }

    .alert-small {
      margin-bottom: 15px;
      font-size: 0.9em;
    }
    
    .data-table {
      width: 100%;
      background: #222;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #333;
    }
    
    .data-table th {
      background: #333;
      padding: 15px;
      text-align: left;
      font-weight: bold;
      color: #25c2a0;
      border-bottom: 1px solid #444;
    }
    
    .data-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #333;
    }
    
    .data-table tr:hover {
      background: #2a2a2a;
    }
    
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
    }
    
    .status-active {
      background: #27ae60;
      color: #fff;
    }
    
    .status-blocked {
      background: #e74c3c;
      color: #fff;
    }
    
    .status-flagged {
      background: #f39c12;
      color: #fff;
    }
    
    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      border: 1px solid #27ae60;
      color: #2ecc71;
    }
    
    .alert-error {
      background: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
    }
    
    .alert-warning {
      background: rgba(243, 156, 18, 0.2);
      border: 1px solid #f39c12;
      color: #f39c12;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #333;
      border-radius: 50%;
      border-top-color: #25c2a0;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
    }
    
    /* Staking Admin Styles */
    .stake-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #333;
    }

    .stake-detail-row:last-child {
      border-bottom: none;
    }

    .stake-detail-row span:first-child {
      color: #aaa;
      font-weight: 500;
    }

    .stake-detail-row span:last-child {
      color: #25c2a0;
      font-weight: bold;
    }

    #stakeSelector {
      margin-bottom: 15px;
    }

    #unstakeResult {
      padding: 10px;
      border-radius: 6px;
      display: none;
    }

    #unstakeResult.success {
      background: #25c2a020;
      border: 1px solid #25c2a0;
      color: #25c2a0;
      display: block;
    }

    #unstakeResult.error {
      background: #ff6b6b20;
      border: 1px solid #ff6b6b;
      color: #ff6b6b;
      display: block;
    }

    @media (max-width: 768px) {
      .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }

      .nav-buttons {
        flex-direction: column;
      }

      .admin-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>üîí WALDO Admin Panel</h1>
        <p>Enter admin password to access system controls</p>
      </div>

      <div class="login-form">
        <div class="form-group">
          <label class="form-label">Admin Password</label>
          <input type="password" id="loginPassword" class="form-input" placeholder="Enter admin password" onkeypress="handleLoginKeypress(event)">
        </div>

        <button type="button" class="btn btn-primary" onclick="attemptLogin()">
          üîì Access Admin Panel
        </button>

        <div id="loginError" class="login-error hidden"></div>

        <div class="login-info">
          <p>üí° Use the X_ADMIN_KEY environment variable password</p>
          <p>üîê This password is for admin panel access only</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Admin Panel (Hidden by default) -->
  <div id="adminPanel" class="hidden">
    <!-- Admin Header -->
    <div class="admin-header">
      <div class="header-with-logout">
        <div>
          <div class="admin-title">üõ†Ô∏è WALDO Emergency Admin Panel</div>
          <div class="admin-subtitle">Backup controls and manual overrides for automated systems</div>
        </div>
        <button type="button" class="btn btn-danger" onclick="logout()">
          üö™ Logout
        </button>
      </div>
    </div>

  <!-- Navigation -->
  <div class="admin-nav">
    <div class="nav-buttons">
      <button type="button" class="nav-btn active" onclick="showSection('dashboard')">üìä System Status</button>
      <button type="button" class="nav-btn" onclick="showSection('users')">üë• User Override</button>
      <button type="button" class="nav-btn" onclick="showSection('airdrops')">üéÅ Manual Airdrop</button>
      <button type="button" class="nav-btn" onclick="showSection('battles')">‚öîÔ∏è Battle Override</button>
      <button type="button" class="nav-btn" onclick="showSection('staking')">üè¶ Staking Monitor</button>
      <button type="button" class="nav-btn" onclick="showSection('security')">üõ°Ô∏è Security Override</button>
      <button type="button" class="nav-btn" onclick="showSection('dao')">üó≥Ô∏è DAO Override</button>
      <button type="button" class="nav-btn" onclick="showSection('system')">‚öôÔ∏è Emergency Controls</button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="admin-content">
    <!-- Dashboard Section -->
    <div id="dashboard" class="admin-section active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">WALDO Trustlines</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalWaldoDistributed">-</div>
          <div class="stat-label">WALDO Distributed</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="activeBattles">-</div>
          <div class="stat-label">Active Battles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStaked">-</div>
          <div class="stat-label">Total Staked</div>
        </div>
      </div>

      <!-- Admin Key Configuration -->
      <div class="admin-card margin-bottom-30">
        <div class="card-title">üîë Admin Key Configuration</div>
        <p class="text-muted margin-bottom-20">Enter your admin key to access advanced features. Current airdrop password is set via X_ADMIN_KEY environment variable.</p>

        <div class="grid-2">
          <div>
            <div class="form-group">
              <label class="form-label">Admin Key</label>
              <input type="password" id="adminKeyInput" class="form-input" placeholder="Enter admin key">
            </div>

            <button type="button" class="btn btn-primary" onclick="saveAdminKey()">
              üíæ Save Admin Key
            </button>
            <button type="button" class="btn btn-secondary" onclick="clearAdminKey()">
              üóëÔ∏è Clear Key
            </button>

            <div id="adminKeyStatus" class="margin-top-15">
              <span id="keyStatusText" class="text-muted">No admin key stored</span>
            </div>
          </div>

          <div>
            <div class="form-group">
              <label class="form-label">Environment Status</label>
              <div class="env-status">
                <div class="env-item">
                  <span class="env-label">X_ADMIN_KEY (Admin Access):</span>
                  <span class="env-value" id="envAdminKey">waldogod2025</span>
                </div>
                <div class="env-item">
                  <span class="env-label">ADMIN_KEY (API Access):</span>
                  <span class="env-value" id="envApiKey">Set in Render</span>
                </div>
              </div>
            </div>

            <button type="button" class="btn btn-secondary" onclick="testEnvironmentKeys()">
              üß™ Test Environment Keys
            </button>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üìà Recent Activity</div>
          <div id="recentActivity" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
        <div class="admin-card">
          <div class="card-title">üö® System Alerts</div>
          <div id="systemAlerts" class="loading">
            <div class="spinner"></div> Loading...
          </div>
        </div>
      </div>
    </div>

    <!-- Users Section -->
    <div id="users" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ‚ö†Ô∏è <strong>User Security Override</strong><br>
        Manual user blocking/unblocking for when automated fraud detection needs intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">üë• User Security Controls</div>

        <!-- Export Users Section -->
        <div class="margin-bottom-20" style="border-bottom: 1px solid #444; padding-bottom: 15px;">
          <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Export User Data</h4>
          <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button onclick="exportUsersCSV()" class="btn btn-secondary">
              üì• Download CSV
            </button>
            <button onclick="exportUsersJSON()" class="btn btn-secondary">
              üì• Download JSON
            </button>
            <span style="color: #666; font-size: 0.9em;">Export all user data before reset</span>
          </div>
          <div id="exportResult" class="margin-top-10"></div>
        </div>

        <div class="form-group">
          <input type="text" id="userSearch" class="form-input" placeholder="Search by wallet address or Twitter handle...">
        </div>

        <div id="usersList" class="loading">
          <div class="spinner"></div> Loading users...
        </div>
      </div>

      <!-- Manual Security Actions -->
      <div class="admin-card margin-top-20">
        <div class="card-title">üõ°Ô∏è Manual Security Actions</div>

        <div class="grid-2">
          <!-- Block User -->
          <div>
            <h4 style="color: #e74c3c; margin-bottom: 15px;">üö´ Block User</h4>
            <div class="form-group">
              <input type="text" id="blockWallet" class="form-input" placeholder="Wallet address to block">
            </div>
            <div class="form-group">
              <input type="text" id="blockReason" class="form-input" placeholder="Reason for blocking">
            </div>
            <button onclick="blockUser()" class="btn btn-danger">Block User</button>
            <div id="blockResult" class="result-message"></div>
          </div>

          <!-- Unblock User -->
          <div>
            <h4 style="color: #27ae60; margin-bottom: 15px;">‚úÖ Unblock User</h4>
            <div class="form-group">
              <input type="text" id="unblockWallet" class="form-input" placeholder="Wallet address to unblock">
            </div>
            <div class="form-group">
              <input type="text" id="unblockReason" class="form-input" placeholder="Reason for unblocking">
            </div>
            <button onclick="unblockUser()" class="btn btn-success">Unblock User</button>
            <div id="unblockResult" class="result-message"></div>
          </div>
        </div>

        <!-- Security Check -->
        <div class="margin-top-20">
          <h4 style="color: #f39c12; margin-bottom: 15px;">üîç Security Check</h4>
          <div class="form-group">
            <input type="text" id="checkWallet" class="form-input" placeholder="Wallet address to check">
          </div>
          <button onclick="checkUserSecurity()" class="btn btn-warning">Check Security Status</button>
          <div id="securityCheckResult" class="result-message"></div>
        </div>
      </div>
    </div>

    <!-- Airdrops Section -->
    <div id="airdrops" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ‚ö†Ô∏è <strong>Manual Airdrop Override</strong><br>
        Use this only when automated airdrop system fails or for emergency distributions.
      </div>

      <!-- Daily Password Management -->
      <div class="admin-card margin-bottom-30">
        <div class="card-title">üîê Airdrop Password Management</div>

        <div class="alert alert-info margin-bottom-20">
          ‚ÑπÔ∏è <strong>Password Priority:</strong> Redis Override (Admin Set) ‚Üí Default (WALDOCREW)
        </div>

        <div class="grid-2">
          <div>
            <div class="form-group">
              <label class="form-label">Current Active Password</label>
              <div id="currentPasswordDisplay" class="password-display">
                WALDOCREW (default)
              </div>
              <div id="passwordSource" class="password-source">
                Source: <span id="sourceText">default</span>
              </div>
              <button type="button" class="btn btn-secondary margin-top-10" onclick="getCurrentAirdropPassword()">
                üîÑ Refresh Current Password
              </button>
            </div>
          </div>

          <div>
            <div class="form-group">
              <label class="form-label">Override Password (Redis)</label>
              <input type="text" id="newDailyPassword" class="form-input" placeholder="Enter override password">
              <small class="help-text">
                This will temporarily override the X_ADMIN_KEY environment variable
              </small>
            </div>

            <div class="quick-passwords margin-top-10 margin-bottom-10">
              <button type="button" class="quick-btn" onclick="setQuickAirdropPassword('WALDOCREW')">WALDOCREW</button>
              <button type="button" class="quick-btn" onclick="setQuickAirdropPassword('WALDO2025')">WALDO2025</button>
              <button type="button" class="quick-btn" onclick="setQuickAirdropPassword('MOONWALDO')">MOONWALDO</button>
              <button type="button" class="quick-btn" onclick="generateDailyAirdropPassword()">üìÖ Today's Password</button>
              <button type="button" class="quick-btn" onclick="generateRandomAirdropPassword()">üé≤ Random</button>
              <button type="button" class="quick-btn" onclick="clearPasswordOverride()">üóëÔ∏è Clear Override</button>
            </div>

            <button type="button" class="btn btn-primary" onclick="updateAirdropPassword()">
              üîê Set Override Password
            </button>
            <div id="passwordUpdateStatus" class="margin-top-10"></div>
          </div>
        </div>
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üéÅ Emergency Airdrop</div>

          <form id="airdropForm">
            <div class="form-group">
              <label class="form-label">Wallet Address</label>
              <input type="text" id="airdropWallet" class="form-input" placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX" required>
            </div>

            <div class="form-group">
              <label class="form-label">Amount (WALDO)</label>
              <input type="number" id="airdropAmount" class="form-input" placeholder="1000" min="1" max="10000" required>
            </div>

            <div class="form-group">
              <label class="form-label">Reason (Required for manual override)</label>
              <input type="text" id="airdropReason" class="form-input" placeholder="e.g., Automated system failed, emergency distribution" required>
            </div>

            <button type="submit" class="btn btn-warning">‚ö†Ô∏è Manual Override Send</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">üìä Airdrop Statistics</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="airdropsClaimed">-</div>
              <div class="stat-label">Claims / 1000</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="airdropsRemaining">-</div>
              <div class="stat-label">Remaining</div>
            </div>
          </div>

          <div id="airdropHistory" class="loading">
            <div class="spinner"></div> Loading history...
          </div>
        </div>
      </div>

      <!-- Reset Airdrop Section -->
      <div class="admin-card" style="border: 2px solid #e74c3c; background: #2a1f1f;">
        <div class="card-title" style="color: #e74c3c;">üîÑ Reset Airdrop System</div>

        <div class="alert alert-warning margin-bottom-15">
          ‚ö†Ô∏è <strong>DANGER:</strong> This will reset the airdrop counter to 0/1000 and clear all claimed wallets. Use only for testing or official launch preparation.
        </div>

        <div class="margin-bottom-15">
          <strong>What gets reset:</strong>
          <ul style="margin: 10px 0; padding-left: 20px; color: #ccc;">
            <li>Airdrop counter: Reset to 0/1000</li>
            <li>Claimed wallets: All cleared</li>
            <li>Password override: Cleared (back to WALDOCREW)</li>
          </ul>
        </div>

        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <button onclick="resetAirdropSystem()" class="btn" style="background: #e74c3c; color: white; border: none;">
            üîÑ Reset Airdrop System
          </button>
          <span style="color: #ff6b6b; font-size: 0.9em; font-weight: bold;">‚ö†Ô∏è This action cannot be undone!</span>
        </div>

        <div id="resetResult" class="margin-top-15"></div>
      </div>
    </div>

    <!-- Battles Section -->
    <div id="battles" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ‚ö†Ô∏è <strong>Battle Emergency Controls</strong><br>
        Use these controls only when automated battle system malfunctions or requires manual intervention.
      </div>

      <div class="admin-card">
        <div class="card-title">‚öîÔ∏è Battle Override Controls</div>

        <div class="grid-2">
          <div>
            <h3 class="section-title">Current Battle Status</h3>
            <div id="currentBattle" class="loading">
              <div class="spinner"></div> Loading...
            </div>
          </div>

          <div>
            <h3 class="section-title">Emergency Controls</h3>
            <div class="alert alert-error alert-small">
              ‚ö†Ô∏è These actions cannot be undone and will affect active users
            </div>
            <button type="button" class="btn btn-warning" onclick="endCurrentBattle()">‚èπÔ∏è Force End Battle</button>
            <button type="button" class="btn btn-danger" onclick="cancelCurrentBattle()">‚ùå Emergency Cancel</button>
          </div>
        </div>

        <h3 class="section-title-spaced">Recent Battles</h3>
        <div id="battleHistory" class="loading">
          <div class="spinner"></div> Loading battle history...
        </div>
      </div>
    </div>

    <!-- Staking Section -->
    <div id="staking" class="admin-section">
      <div class="alert alert-warning margin-bottom-20">
        ‚ö†Ô∏è <strong>Staking Emergency Controls</strong><br>
        Manual unstaking is a backup mechanism for when automated functions fail. Use with caution.
      </div>

      <div class="grid-2">
        <!-- Staking Overview -->
        <div class="admin-card">
          <div class="card-title">üè¶ Staking Overview</div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalStakingPositions">-</div>
              <div class="stat-label">Active Stakes</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalStakingValue">-</div>
              <div class="stat-label">Total Value</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalStakingRewards">-</div>
              <div class="stat-label">Total Rewards</div>
            </div>
          </div>

          <div id="stakingPositions" class="loading">
            <div class="spinner"></div> Loading staking positions...
          </div>
        </div>

        <!-- Manual Unstaking Controls -->
        <div class="admin-card">
          <div class="card-title">üîì Manual Unstaking</div>

          <div class="margin-bottom-20">
            <label class="form-label">User Wallet Address</label>
            <input type="text" id="unstakeWalletAddress" class="form-input margin-bottom-10"
                   placeholder="rWalletAddress...">
            <button type="button" onclick="loadUserStakes()" class="btn btn-secondary width-100">
              üîç Load User Stakes
            </button>
          </div>

          <div id="userStakesContainer" style="display: none;">
            <div class="form-group">
              <label class="form-label">Select Stake to Unstake</label>
              <select id="stakeSelector" class="form-input">
                <option value="">Select a stake...</option>
              </select>
            </div>

            <div id="stakeDetails" class="stake-details">
              <div class="stake-detail-row">
                <span>Amount:</span>
                <span id="stakeAmount">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Duration:</span>
                <span id="stakeDuration">-</span>
              </div>
              <div class="stake-detail-row">
                <span>APY:</span>
                <span id="stakeAPY">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Unlock Date:</span>
                <span id="stakeUnlockDate">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Current Rewards:</span>
                <span id="stakeRewards">-</span>
              </div>
              <div class="stake-detail-row">
                <span>Status:</span>
                <span id="stakeStatus">-</span>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="forceUnstake" class="checkbox-margin">
                Force Early Unstaking (15% penalty will apply)
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">Admin Reason (Required)</label>
              <textarea id="unstakeReason" class="form-input" rows="3"
                        placeholder="Explain why manual unstaking is necessary..."></textarea>
            </div>

            <button type="button" onclick="executeManualUnstake()" class="btn btn-danger width-100">
              üîì Execute Manual Unstake
            </button>
          </div>

          <div id="unstakeResult" class="margin-top-15"></div>
        </div>
      </div>
    </div>

    <!-- Security Section -->
    <div id="security" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üõ°Ô∏è Security Monitoring</div>

          <div id="securityAlerts" class="loading">
            <div class="spinner"></div> Loading security data...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">üö® Fraud Detection</div>

          <div class="form-group">
            <label class="form-label">Check Wallet</label>
            <input type="text" id="securityWallet" class="form-input" placeholder="Enter wallet address">
            <button type="button" class="btn margin-top-10" onclick="checkWalletSecurity()">üîç Check Security</button>
          </div>

          <div id="securityResults"></div>
        </div>
      </div>
    </div>

    <!-- DAO Section -->
    <div id="dao" class="admin-section">
      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">üó≥Ô∏è Create DAO Proposal</div>

          <form id="daoForm">
            <div class="form-group">
              <label class="form-label">Proposal Title</label>
              <input type="text" id="daoTitle" class="form-input" placeholder="Enter proposal title" required>
            </div>

            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea id="daoDescription" class="form-input form-textarea" placeholder="Describe the proposal..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label">Options (comma-separated)</label>
              <input type="text" id="daoOptions" class="form-input" placeholder="Yes, No" required>
            </div>

            <div class="form-group">
              <label class="form-label">Duration (hours)</label>
              <input type="number" id="daoDuration" class="form-input" placeholder="72" min="1" required>
            </div>

            <button type="submit" class="btn">üì® Create Proposal</button>
          </form>
        </div>

        <div class="admin-card">
          <div class="card-title">üìã Active Proposals</div>

          <div id="daoProposals" class="loading">
            <div class="spinner"></div> Loading proposals...
          </div>
        </div>
      </div>
    </div>

    <!-- System Section -->
    <div id="system" class="admin-section">
      <div class="alert alert-error margin-bottom-20">
        üö® <strong>EMERGENCY SYSTEM CONTROLS</strong><br>
        These controls can affect the entire WALDOCOIN system. Use only in critical situations.
      </div>

      <div class="grid-2">
        <div class="admin-card">
          <div class="card-title">‚öôÔ∏è System Health Monitor</div>

          <div id="systemHealth" class="loading">
            <div class="spinner"></div> Checking system health...
          </div>
        </div>

        <div class="admin-card">
          <div class="card-title">üö® Emergency Controls</div>

          <div class="alert alert-warning alert-small">
            ‚ö†Ô∏è These actions affect all users and cannot be easily undone
          </div>

          <div class="emergency-controls">
            <button type="button" class="btn" onclick="refreshAllData()">üîÑ Force Data Refresh</button>
            <button type="button" class="btn btn-warning" onclick="clearCache()">üóëÔ∏è Emergency Cache Clear</button>
            <button type="button" class="btn btn-danger" onclick="emergencyStop()">üõë SYSTEM EMERGENCY STOP</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Production Configuration
    const API_BASE = "https://waldocoin-backend-api.onrender.com";
    const ADMIN_WALLET = "rMJMw3i7W4dxTBkLKSnkNETCGPeons2MVt"; // WALDO distributor wallet
    let currentSection = 'dashboard';
    let isAuthenticated = false;

    // Login Functions
    async function attemptLogin() {
      const password = document.getElementById('loginPassword').value.trim();
      const loginError = document.getElementById('loginError');

      if (!password) {
        showLoginError('Please enter a password');
        return;
      }

      try {
        // Debug: Log the password being sent
        console.log('Attempting login with password:', password);
        console.log('API_BASE:', API_BASE);

        // Use verify-admin endpoint for authentication
        const response = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          method: 'GET',
          headers: {
            'x-admin-key': password,
            'Content-Type': 'application/json'
          }
        });

        console.log('Response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.log('Error response:', errorText);
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('Login response:', data);

        if (data.success) {
          // Admin authentication successful
          localStorage.setItem('adminKey', password);
          isAuthenticated = true;

          // Hide login screen and show admin panel
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('adminPanel').classList.remove('hidden');

          // Load dashboard by default
          showSection('dashboard', null);

          hideLoginError();

          // Show success message
          console.log('Admin login successful!', data.message);
        } else {
          showLoginError(`Invalid admin password. Error: ${data.error || 'Unknown error'}`);
          console.log('Login failed:', data);
        }
      } catch (error) {
        console.error('Login error:', error);
        showLoginError(`Connection failed: ${error.message}. Check if backend is running.`);
      }
    }

    function handleLoginKeypress(event) {
      if (event.key === 'Enter') {
        attemptLogin();
      }
    }

    // üì• Export Users as CSV
    async function exportUsersCSV() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üì• Exporting users to CSV...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success && data.users) {
          // Create CSV content
          const headers = [
            'Wallet Address', 'Username', 'Twitter Handle', 'XP Level', 'Total XP',
            'WALDO Balance', 'Last Active', 'Joined At', 'Battles Total', 'Battles Won',
            'Battle Votes', 'Staking Active', 'Total Staked', 'Staking Positions'
          ];

          let csvContent = headers.join(',') + '\n';

          data.users.forEach(user => {
            const row = [
              `"${user.walletAddress}"`,
              `"${user.username}"`,
              `"${user.twitterHandle || ''}"`,
              user.xpLevel,
              user.totalXP,
              user.waldoBalance,
              `"${user.lastActive}"`,
              `"${user.joinedAt}"`,
              user.battles.total,
              user.battles.won,
              user.battles.votes,
              user.staking.active,
              user.staking.totalStaked,
              user.staking.positions
            ];
            csvContent += row.join(',') + '\n';
          });

          // Download CSV
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ CSV exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during export</div>';
      }
    }

    // üì• Export Users as JSON
    async function exportUsersJSON() {
      const resultDiv = document.getElementById('exportResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üì• Exporting users to JSON...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/users/list?limit=1000`, {
          headers: { 'x-admin-key': adminKey }
        });

        const data = await response.json();

        if (data.success) {
          // Download JSON
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `waldocoin-users-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          resultDiv.innerHTML = `<div style="color: #27ae60;">‚úÖ JSON exported: ${data.users.length} users</div>`;
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Export failed: ${data.error}</div>`;
        }
      } catch (error) {
        console.error('Export error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during export</div>';
      }
    }

    // üîÑ Reset Airdrop System
    async function resetAirdropSystem() {
      // Double confirmation for safety
      const firstConfirm = confirm(
        "‚ö†Ô∏è DANGER: This will reset the airdrop system!\n\n" +
        "‚Ä¢ Counter will reset to 0/1000\n" +
        "‚Ä¢ All claimed wallets will be cleared\n" +
        "‚Ä¢ Password override will be cleared\n\n" +
        "Are you sure you want to continue?"
      );

      if (!firstConfirm) return;

      const secondConfirm = confirm(
        "üö® FINAL WARNING!\n\n" +
        "This action CANNOT be undone!\n" +
        "All airdrop progress will be lost!\n\n" +
        "Type 'RESET' in the next dialog to confirm."
      );

      if (!secondConfirm) return;

      const typeConfirm = prompt("Type 'RESET' to confirm (case sensitive):");
      if (typeConfirm !== 'RESET') {
        showAlert('Reset cancelled - confirmation text did not match', 'warning');
        return;
      }

      const resultDiv = document.getElementById('resetResult');
      resultDiv.innerHTML = '<div style="color: #ffd93d;">üîÑ Resetting airdrop system...</div>';

      try {
        const adminKey = localStorage.getItem('adminKey');
        const response = await fetch(`${API_BASE}/api/airdrop/reset`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div style="color: #27ae60; font-weight: bold;">‚úÖ Airdrop system reset successfully!</div>
            <div style="color: #ccc; margin-top: 10px; font-size: 0.9em;">
              ‚Ä¢ Counter: ${data.details.counter}<br>
              ‚Ä¢ Claimed wallets: ${data.details.claimedWallets}<br>
              ‚Ä¢ Password: ${data.details.passwordOverride}<br>
              ‚Ä¢ Total limit: ${data.details.totalLimit}
            </div>
          `;

          // Refresh airdrop status
          setTimeout(() => {
            loadAirdropData();
          }, 1000);

          showAlert('Airdrop system reset successfully! Ready for fresh launch.', 'success');
        } else {
          resultDiv.innerHTML = `<div style="color: #e74c3c;">‚ùå Reset failed: ${data.error}</div>`;
          showAlert(`Reset failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Reset error:', error);
        resultDiv.innerHTML = '<div style="color: #e74c3c;">‚ùå Network error during reset</div>';
        showAlert('Network error during reset', 'error');
      }
    }

    function showLoginError(message) {
      const loginError = document.getElementById('loginError');
      loginError.textContent = message;
      loginError.classList.remove('hidden');
    }

    function hideLoginError() {
      const loginError = document.getElementById('loginError');
      loginError.classList.add('hidden');
    }

    function logout() {
      if (confirm('Are you sure you want to logout from the admin panel?')) {
        // Clear all stored authentication data
        localStorage.removeItem('adminKey');
        localStorage.removeItem('xummWallet'); // Clear any old wallet data
        sessionStorage.clear(); // Clear session data
        isAuthenticated = false;

        // Show login screen and hide admin panel
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');

        // Clear password field and any error messages
        document.getElementById('loginPassword').value = '';
        hideLoginError();

        // Clear any test results
        const testDiv = document.getElementById('connectionTest');
        if (testDiv) testDiv.innerHTML = '';

        console.log('Logged out successfully');
      }
    }

    // Check if user is already logged in on page load
    function checkExistingLogin() {
      const savedKey = localStorage.getItem('adminKey');
      if (savedKey) {
        // Auto-login with saved key
        document.getElementById('loginPassword').value = savedKey;
        attemptLogin();
      } else {
        // Show login screen by default
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
      }
    }

    // Test backend connection
    async function testConnection() {
      const testDiv = document.getElementById('connectionTest');
      testDiv.innerHTML = '<div style="color: #f39c12;">üîÑ Testing connection...</div>';

      // Test 1: Basic API connection
      try {
        const response1 = await fetch(`${API_BASE}/api/airdrop/status`);
        testDiv.innerHTML += `<div style="color: #666;">Status endpoint: ${response1.status}</div>`;

        if (response1.ok) {
          const data1 = await response1.json();
          if (data1.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Backend API: Connected</div>';
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">‚ùå Backend API: Error in response</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Backend API: HTTP ${response1.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Backend API: ${error.message}</div>`;
      }

      // Test 2: Try current-password endpoint
      try {
        const response2 = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Password endpoint: ${response2.status}</div>`;

        if (response2.ok) {
          const data2 = await response2.json();
          if (data2.success) {
            testDiv.innerHTML += `<div style="color: #27ae60;">‚úÖ Password 'waldogod2025': Works</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Current password: ${data2.currentPassword}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">Source: ${data2.source}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password failed: ${data2.error}</div>`;
          }
        } else {
          const text = await response2.text();
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password endpoint: HTTP ${response2.status}</div>`;
          testDiv.innerHTML += `<div style="color: #666;">Response: ${text.substring(0, 100)}...</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Password test: ${error.message}</div>`;
      }

      // Test 3: Try verify-admin endpoint
      try {
        const response3 = await fetch(`${API_BASE}/api/airdrop/verify-admin`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });
        testDiv.innerHTML += `<div style="color: #666;">Verify endpoint: ${response3.status}</div>`;

        if (response3.ok) {
          const data3 = await response3.json();
          if (data3.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Admin verification: Success</div>';
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Admin verification: ${data3.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Verify endpoint: HTTP ${response3.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Verify test: ${error.message}</div>`;
      }

      // Test 4: Debug environment variables
      try {
        const response4 = await fetch(`${API_BASE}/api/airdrop/debug-env`, {
          headers: { 'x-admin-key': 'waldogod2025' }
        });

        if (response4.ok) {
          const data4 = await response4.json();
          if (data4.success) {
            testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Environment debug: Success</div>';
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY set: ${data4.environment.X_ADMIN_KEY_SET}</div>`;
            testDiv.innerHTML += `<div style="color: #25c2a0;">X_ADMIN_KEY value: ${data4.environment.X_ADMIN_KEY_VALUE}</div>`;
          } else {
            testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Environment debug: ${data4.error}</div>`;
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Debug endpoint: HTTP ${response4.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Debug test: ${error.message}</div>`;
      }

      // Test 5: Check available routes
      try {
        const response5 = await fetch(`${API_BASE}/api/routes`);

        if (response5.ok) {
          const routes = await response5.json();
          testDiv.innerHTML += '<div style="color: #27ae60;">‚úÖ Available routes loaded</div>';

          const airdropRoutes = routes.filter(r => r.path && r.path.includes('airdrop'));
          if (airdropRoutes.length > 0) {
            testDiv.innerHTML += '<div style="color: #25c2a0;">Airdrop routes found:</div>';
            airdropRoutes.forEach(route => {
              testDiv.innerHTML += `<div style="color: #666; font-size: 0.9em;">${route.method} ${route.path}</div>`;
            });
          } else {
            testDiv.innerHTML += '<div style="color: #e74c3c;">‚ùå No airdrop routes found in backend</div>';
          }
        } else {
          testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Routes endpoint: HTTP ${response5.status}</div>`;
        }
      } catch (error) {
        testDiv.innerHTML += `<div style="color: #e74c3c;">‚ùå Routes test: ${error.message}</div>`;
      }
    }

    // Authentication check - now uses password-based login
    function checkAdminAuth() {
      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        // Show login screen instead of old modal
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('adminPanel').classList.add('hidden');
        return false;
      }
      isAuthenticated = true;
      updateAdminKeyStatus(); // Update admin key status on auth
      return true;
    }

    // Admin Key Management
    function saveAdminKey() {
      const adminKey = document.getElementById('adminKeyInput').value.trim();
      if (!adminKey) {
        showAlert('Please enter an admin key', 'error');
        return;
      }

      localStorage.setItem('adminKey', adminKey);
      document.getElementById('adminKeyInput').value = ''; // Clear input for security
      updateAdminKeyStatus();
      showAlert('Admin key saved successfully', 'success');
    }

    function clearAdminKey() {
      localStorage.removeItem('adminKey');
      updateAdminKeyStatus();
      showAlert('Admin key cleared', 'info');
    }

    function updateAdminKeyStatus() {
      const adminKey = localStorage.getItem('adminKey');
      const statusText = document.getElementById('keyStatusText');

      if (adminKey) {
        statusText.textContent = '‚úÖ Admin key is stored and ready';
        statusText.className = 'text-primary';
      } else {
        statusText.textContent = '‚ùå No admin key stored';
        statusText.className = 'text-muted';
      }
    }

    async function testEnvironmentKeys() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Test current airdrop password (should be WALDOCREW or admin override)
        const response = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: {
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('envAdminKey').textContent = data.currentPassword;
          showAlert(`Environment test successful! Current airdrop password: ${data.currentPassword}`, 'success');
        } else {
          showAlert(`Environment test failed: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Environment test error:', error);
        showAlert('Failed to test environment keys', 'error');
      }
    }

    // Old authentication functions removed - now using password-based login screen

    // Navigation
    function showSection(sectionName, clickedElement = null) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionName).classList.add('active');

      // Add active class to clicked button (if provided)
      if (clickedElement) {
        clickedElement.classList.add('active');
      } else {
        // Fallback: find the nav button for this section
        const navBtn = document.querySelector(`[onclick*="${sectionName}"]`);
        if (navBtn) {
          navBtn.classList.add('active');
        }
      }

      currentSection = sectionName;

      // Load section data
      loadSectionData(sectionName);
    }

    // Production-ready API call wrapper
    async function apiCall(endpoint, options = {}) {
      if (!isAuthenticated) {
        throw new Error('Authentication required');
      }

      const adminKey = localStorage.getItem('adminKey');
      if (!adminKey) {
        throw new Error('Admin key not found');
      }

      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'x-admin-key': adminKey,
          ...options.headers
        }
      };

      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...defaultOptions,
          ...options
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return data;
      } catch (error) {
        console.error(`API Error [${endpoint}]:`, error);
        throw error;
      }
    }

    // Load data for specific section with error handling
    async function loadSectionData(section) {
      if (!checkAdminAuth()) return;

      try {
        switch(section) {
          case 'dashboard':
            await loadDashboardData();
            break;
          case 'users':
            await loadUsersData();
            break;
          case 'airdrops':
            await loadAirdropsData();
            break;
          case 'battles':
            await loadBattlesData();
            break;
          case 'staking':
            await loadStakingData();
            break;
          case 'security':
            await loadSecurityData();
            break;
          case 'dao':
            await loadDAOData();
            break;
          case 'system':
            await loadSystemData();
            break;
        }
      } catch (error) {
        showAlert(`Error loading ${section}: ${error.message}`, 'error');
      }
    }

    // Load trustline count independently
    async function loadTrustlineCount() {
      console.log('üîç Loading trustline count independently...');
      try {
        const trustlineData = await apiCall('/api/airdrop/trustline-count');
        console.log('‚úÖ Trustline data received:', trustlineData);
        if (trustlineData.success) {
          const count = trustlineData.trustlineCount || '0';
          console.log('üìä Setting totalUsers to:', count);
          document.getElementById('totalUsers').textContent = count;
          console.log('‚úÖ totalUsers element now shows:', document.getElementById('totalUsers').textContent);
        } else {
          console.log('‚ùå Trustline data not successful:', trustlineData);
          document.getElementById('totalUsers').textContent = '0';
        }
      } catch (trustlineError) {
        console.log('‚ùå Trustline count failed:', trustlineError);
        document.getElementById('totalUsers').textContent = '0';
      }
    }

    // Dashboard functions - Production Ready with full backend support
    async function loadDashboardData() {
      // Load trustline count first, independently
      await loadTrustlineCount();

      try {

        // Load tokenomics stats for dashboard
        const tokenomicsData = await apiCall('/api/tokenomics/stats');
        if (tokenomicsData.success) {
          const stats = tokenomicsData.stats;
          document.getElementById('totalWaldoDistributed').textContent = (stats.airdrop.totalDistributed / 1000).toFixed(1) + 'K';
          document.getElementById('activeBattles').textContent = stats.battles.active || '0';
          document.getElementById('totalStaked').textContent = (stats.staking?.totalStaked / 1000 || 0).toFixed(1) + 'K';
        }

        // Load battle status for activity
        const battleData = await apiCall('/api/battle/current');
        const activityDiv = document.getElementById('recentActivity');

        let activityHtml = '';
        if (battleData.active) {
          activityHtml += `
            <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
              <div style="font-weight: bold; color: #25c2a0;">‚öîÔ∏è Battle #${battleData.battle.id} Active</div>
              <div style="font-size: 0.9em; opacity: 0.8;">${battleData.battle.totalVotes} total votes</div>
            </div>
          `;
        }

        // Load recent airdrop activity
        try {
          const airdropStatus = await apiCall('/api/airdrop/status');
          if (airdropStatus.success) {
            activityHtml += `
              <div style="padding: 10px; border-bottom: 1px solid #333; color: #ccc;">
                <div style="font-weight: bold; color: #25c2a0;">üéÅ Airdrop Status</div>
                <div style="font-size: 0.9em; opacity: 0.8;">${airdropStatus.airdrop.totalClaimed}/1000 claimed</div>
              </div>
            `;
          }
        } catch (e) {
          console.warn('Could not load airdrop status');
        }

        if (!activityHtml) {
          activityHtml = '<div style="color: #666; text-align: center; padding: 20px;">No recent activity</div>';
        }
        activityDiv.innerHTML = activityHtml;

        // System health check
        const alertsDiv = document.getElementById('systemAlerts');
        const healthChecks = await performHealthChecks();
        alertsDiv.innerHTML = healthChecks;

      } catch (error) {
        console.error('Error loading dashboard:', error);
        showAlert('Error loading dashboard data: ' + error.message, 'error');

        // Show fallback data (but don't override trustline count)
        // document.getElementById('totalUsers').textContent = '-'; // Don't override trustline count
        document.getElementById('totalWaldoDistributed').textContent = '-';
        document.getElementById('activeBattles').textContent = '-';
        document.getElementById('totalStaked').textContent = '-';
      }
    }

    // Production health checks
    async function performHealthChecks() {
      let healthHtml = '';

      try {
        // Check API connectivity using airdrop status endpoint (no auth required)
        const response = await fetch(`${API_BASE}/api/airdrop/status`);
        const data = await response.json();

        if (data.success) {
          healthHtml += '<div class="alert alert-success">‚úÖ Backend API: Online</div>';
        } else {
          healthHtml += '<div class="alert alert-error">‚ùå Backend API: Offline</div>';
        }
      } catch (e) {
        console.error('Backend API health check failed:', e);
        healthHtml += '<div class="alert alert-error">‚ùå Backend API: Offline</div>';
      }

      try {
        // Check battle system (no auth required)
        const battleResponse = await fetch(`${API_BASE}/api/battle/current`);
        if (battleResponse.ok) {
          healthHtml += '<div class="alert alert-success">‚úÖ Battle System: Operational</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Battle System: Issues detected</div>';
        }
      } catch (e) {
        console.error('Battle system health check failed:', e);
        healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Battle System: Issues detected</div>';
      }

      try {
        // Check airdrop system (no auth required)
        const airdropResponse = await fetch(`${API_BASE}/api/airdrop/status`);
        const airdropData = await airdropResponse.json();

        if (airdropData.success && airdropData.airdrop.isActive) {
          healthHtml += '<div class="alert alert-success">‚úÖ Airdrop System: Active</div>';
        } else {
          healthHtml += '<div class="alert alert-warning">‚ö†Ô∏è Airdrop System: Inactive</div>';
        }
      } catch (e) {
        console.error('Airdrop system health check failed:', e);
        healthHtml += '<div class="alert alert-error">‚ùå Airdrop System: Error</div>';
      }

      return healthHtml || '<div class="alert alert-warning">‚ö†Ô∏è Unable to perform health checks</div>';
    }

    // Utility functions
    function showAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;

      // Insert at top of current section
      const currentSectionEl = document.querySelector('.admin-section.active');
      currentSectionEl.insertBefore(alertDiv, currentSectionEl.firstChild);

      // Remove after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

    // Users functions - Production Ready with full backend support
    async function loadUsersData() {
      try {
        // Get user list from backend
        const usersData = await apiCall('/api/users/list?limit=50');
        const usersDiv = document.getElementById('usersList');
        let usersHtml = '';

        if (usersData.success && usersData.users.length > 0) {
          usersHtml = `
            <div style="margin-bottom: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center;">
                <div>
                  <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${usersData.summary.totalUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Total Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #27ae60; font-weight: bold;">${usersData.summary.activeUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Active Users</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${usersData.summary.stakingUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Staking</div>
                </div>
                <div>
                  <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${usersData.summary.blockedUsers}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Blocked</div>
                </div>
              </div>
            </div>

            <div style="max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #444; position: sticky; top: 0;">
                    <th style="padding: 10px; text-align: left; border-bottom: 1px solid #555;">User</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Level</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">WALDO</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Battles</th>
                    <th style="padding: 10px; text-align: center; border-bottom: 1px solid #555;">Status</th>
                  </tr>
                </thead>
                <tbody>
          `;

          usersData.users.forEach(user => {
            const statusColor = user.security.isBlocked ? '#e74c3c' :
                               user.security.isSuspicious ? '#f39c12' : '#27ae60';
            const statusText = user.security.isBlocked ? 'Blocked' :
                              user.security.isSuspicious ? 'Suspicious' : 'Active';

            usersHtml += `
              <tr style="border-bottom: 1px solid #333;">
                <td style="padding: 10px;">
                  <div style="font-weight: bold; color: #25c2a0;">${user.username}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.walletAddress.slice(0, 8)}...${user.walletAddress.slice(-6)}</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #25c2a0; font-weight: bold;">Level ${user.xpLevel}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.totalXP} XP</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ffd93d; font-weight: bold;">${user.waldoBalance.toFixed(1)}</div>
                  ${user.staking.active ? '<div style="font-size: 0.8em; color: #25c2a0;">+Staking</div>' : ''}
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: #ccc;">${user.battles.won}W / ${user.battles.total}T</div>
                  <div style="font-size: 0.8em; color: #666;">${user.battles.votes} votes</div>
                </td>
                <td style="padding: 10px; text-align: center;">
                  <div style="color: ${statusColor}; font-weight: bold;">${statusText}</div>
                  <div style="font-size: 0.8em; color: #666;">${user.security.riskLevel}</div>
                </td>
              </tr>
            `;
          });

          usersHtml += `
                </tbody>
              </table>
            </div>
          `;
        } else {
          usersHtml = '<div style="color: #666; text-align: center; padding: 40px;">No users found</div>';
        }

        // Combine data from battle leaderboard (most active users)
        if (battleLeaderboard.status === 'fulfilled' && battleLeaderboard.value.leaderboard) {
          const users = battleLeaderboard.value.leaderboard.slice(0, 50); // Top 50 users

          usersHtml = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Twitter</th>
                  <th>Battle Wins</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${users.map(user => {
                  const isBlocked = securityData.status === 'fulfilled' &&
                    securityData.value.blockedUsers?.includes(user.wallet);

                  return `
                    <tr>
                      <td><code>${user.wallet.slice(0, 8)}...${user.wallet.slice(-6)}</code></td>
                      <td>${user.twitter ? `@${user.twitter}` : '-'}</td>
                      <td>${user.wins || 0}</td>
                      <td><span class="status-badge status-${isBlocked ? 'blocked' : 'active'}">${isBlocked ? 'BLOCKED' : 'ACTIVE'}</span></td>
                      <td>
                        <button type="button" class="btn" onclick="viewUser('${user.wallet}')">üëÅÔ∏è View</button>
                        <button type="button" class="btn ${isBlocked ? 'btn-warning' : 'btn-danger'}" onclick="${isBlocked ? 'unblockUser' : 'blockUser'}('${user.wallet}')">${isBlocked ? '‚úÖ Unblock' : 'üö´ Block'}</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        } else {
          usersHtml = '<div style="text-align: center; color: #666; padding: 40px;">No user data available</div>';
        }

        usersDiv.innerHTML = usersHtml;

      } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('usersList').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 40px;">Error loading users: ' + error.message + '</div>';
      }
    }

    // Airdrops functions - Production Ready
    async function loadAirdropsData() {
      try {
        // Load airdrop status
        const airdropData = await apiCall('/api/airdrop/status');

        if (airdropData.success) {
          document.getElementById('airdropsClaimed').textContent = `${airdropData.airdrop.totalClaimed}/1000`;
          document.getElementById('airdropsRemaining').textContent = airdropData.airdrop.remaining;
        }

        // Load current password status
        await getCurrentAirdropPassword();

        // Load tokenomics for airdrop history
        const tokenomicsData = await apiCall('/api/tokenomics/stats');
        const historyDiv = document.getElementById('airdropHistory');

        if (tokenomicsData.success) {
          const stats = tokenomicsData.stats;
          historyDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üìä Airdrop Statistics</h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <div style="font-weight: bold; color: #fff;">${stats.airdrop.totalClaimed}</div>
                  <div style="color: #ccc; font-size: 0.9em;">Total Claims</div>
                </div>
                <div>
                  <div style="font-weight: bold; color: #fff;">${(stats.airdrop.totalDistributed / 1000000).toFixed(2)}M</div>
                  <div style="color: #ccc; font-size: 0.9em;">WALDO Distributed</div>
                </div>
              </div>
            </div>

            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">üéØ System Status</h4>
              <div style="color: ${airdropData.airdrop.isActive ? '#27ae60' : '#e74c3c'};">
                ${airdropData.airdrop.isActive ? '‚úÖ Airdrop system is ACTIVE' : '‚ùå Airdrop system is INACTIVE'}
              </div>
              <div style="color: #ccc; margin-top: 5px;">
                ${airdropData.airdrop.remaining} airdrops remaining
              </div>
            </div>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Unable to load airdrop data</div>';
        }

      } catch (error) {
        console.error('Error loading airdrops:', error);
        document.getElementById('airdropHistory').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading airdrop data: ' + error.message + '</div>';
      }
    }

    // Battle functions - Production Ready
    async function loadBattlesData() {
      try {
        const battle = await apiCall('/api/battle/current');

        const currentDiv = document.getElementById('currentBattle');
        if (battle.active) {
          currentDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px;">
              <div style="font-weight: bold; color: #25c2a0;">Battle #${battle.id}</div>
              <div style="margin: 10px 0;">
                <div>Meme 1: ${battle.meme1.votes || 0} votes</div>
                <div>Meme 2: ${battle.meme2.votes || 0} votes</div>
              </div>
              <div style="color: #666;">Ends: ${new Date(battle.endTime).toLocaleString()}</div>
            </div>
          `;
        } else {
          currentDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active battle</div>';
        }

        // Load battle history
        const history = await apiCall('/api/battle/history?limit=10');

        const historyDiv = document.getElementById('battleHistory');
        if (history.battles && history.battles.length > 0) {
          historyDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Votes</th>
                  <th>Winner</th>
                  <th>Status</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                ${history.battles.slice(0, 10).map(battle => `
                  <tr>
                    <td>#${battle.id}</td>
                    <td>${battle.totalVotes || 0}</td>
                    <td>${battle.winner || '-'}</td>
                    <td><span class="status-badge status-${battle.ended ? 'active' : 'flagged'}">${battle.ended ? 'ENDED' : 'ACTIVE'}</span></td>
                    <td>${new Date(battle.createdAt).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          historyDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No battle history</div>';
        }
      } catch (error) {
        console.error('Error loading battles:', error);
      }
    }

    // Staking functions - Production Ready
    async function loadStakingData() {
      try {
        const data = await apiCall('/api/staking/positions?limit=20');

        if (data.success) {
          document.getElementById('totalStakingPositions').textContent = data.data.totalPositions || '0';
          document.getElementById('totalStakingValue').textContent = (data.data.totalValue / 1000).toFixed(1) + 'K';
          document.getElementById('totalStakingRewards').textContent = (data.data.totalRewards / 1000).toFixed(1) + 'K';
        }

        const positionsDiv = document.getElementById('stakingPositions');
        if (data.success && data.data.positions.length > 0) {
          positionsDiv.innerHTML = `
            <table class="data-table">
              <thead>
                <tr>
                  <th>Wallet</th>
                  <th>Amount</th>
                  <th>Duration</th>
                  <th>APY</th>
                  <th>Rewards</th>
                  <th>Unlock Date</th>
                </tr>
              </thead>
              <tbody>
                ${data.data.positions.slice(0, 20).map(pos => `
                  <tr>
                    <td><code>${pos.wallet.slice(0, 8)}...${pos.wallet.slice(-6)}</code></td>
                    <td>${pos.amount} WALDO</td>
                    <td>${pos.duration} days</td>
                    <td>${(pos.apy * 100).toFixed(1)}%</td>
                    <td>${pos.currentRewards.toFixed(2)} WALDO</td>
                    <td>${new Date(pos.unlockDate).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          positionsDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No staking positions</div>';
        }
      } catch (error) {
        console.error('Error loading staking data:', error);
      }
    }

    // Manual Unstaking Functions
    async function loadUserStakes() {
      const walletAddress = document.getElementById('unstakeWalletAddress').value.trim();

      if (!walletAddress || !walletAddress.startsWith('r')) {
        showAlert('Please enter a valid XRPL wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/positions/${walletAddress}`);
        const data = await res.json();

        if (data.success && data.positions && data.positions.length > 0) {
          const selector = document.getElementById('stakeSelector');
          selector.innerHTML = '<option value="">Select a stake...</option>';

          data.positions.forEach(stake => {
            const option = document.createElement('option');
            option.value = JSON.stringify(stake);
            option.textContent = `${stake.amount} WALDO (${stake.duration} days) - ${stake.status}`;
            selector.appendChild(option);
          });

          document.getElementById('userStakesContainer').style.display = 'block';
          showAlert(`Found ${data.positions.length} stake(s) for ${walletAddress}`, 'success');
        } else {
          document.getElementById('userStakesContainer').style.display = 'none';
          showAlert('No staking positions found for this wallet', 'error');
        }
      } catch (error) {
        console.error('Error loading user stakes:', error);
        showAlert('Error loading user stakes', 'error');
        document.getElementById('userStakesContainer').style.display = 'none';
      }
    }

    async function executeManualUnstake() {
      const stakeSelector = document.getElementById('stakeSelector');
      const reason = document.getElementById('unstakeReason').value.trim();
      const forceUnstake = document.getElementById('forceUnstake').checked;

      if (!stakeSelector.value) {
        showAlert('Please select a stake to unstake', 'error');
        return;
      }

      if (!reason) {
        showAlert('Please provide a reason for manual unstaking', 'error');
        return;
      }

      const stake = JSON.parse(stakeSelector.value);
      const isMatured = new Date() >= new Date(stake.unlockDate);

      // Confirmation dialog
      const confirmMessage = `üö® MANUAL UNSTAKING OVERRIDE

Wallet: ${stake.wallet}
Amount: ${stake.amount} WALDO
Current Rewards: ${(stake.currentRewards || 0).toFixed(2)} WALDO
Status: ${stake.status}
${!isMatured ? `\n‚ö†Ô∏è EARLY UNSTAKING: 15% penalty will apply` : ''}

Reason: ${reason}

This action cannot be undone. Continue?`;

      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/staking/unstake`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            wallet: stake.wallet,
            stakeId: stake.stakeId,
            force: forceUnstake || !isMatured,
            adminOverride: true,
            adminReason: reason,
            adminWallet: ADMIN_WALLET
          })
        });

        const data = await res.json();
        const resultDiv = document.getElementById('unstakeResult');

        if (data.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `
            ‚úÖ <strong>Manual Unstake Successful</strong><br>
            Stake ID: ${stake.stakeId}<br>
            Final Amount: ${data.finalAmount} WALDO<br>
            ${data.penalty > 0 ? `Penalty Applied: ${data.penalty} WALDO<br>` : ''}
            XUMM Transaction: ${data.uuid}<br>
            <small>User will receive XUMM notification to sign the transaction.</small>
          `;

          // Reset form
          document.getElementById('unstakeWalletAddress').value = '';
          document.getElementById('unstakeReason').value = '';
          document.getElementById('userStakesContainer').style.display = 'none';

          // Refresh staking data
          loadStakingData();

        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Unstaking Failed</strong><br>${data.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        console.error('Error executing manual unstake:', error);
        const resultDiv = document.getElementById('unstakeResult');
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Error</strong><br>Failed to execute manual unstake: ${error.message}`;
      }
    }

    // Security functions - Production Ready
    async function loadSecurityData() {
      try {
        const data = await apiCall('/api/security/overview');

        const alertsDiv = document.getElementById('securityAlerts');
        if (data.success) {
          let alertsHtml = `
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #e74c3c; font-weight: bold;">${data.overview.blockedUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Blocked Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #f39c12; font-weight: bold;">${data.overview.suspiciousUsers}</div>
                <div style="font-size: 0.9em; color: #ccc;">Suspicious Users</div>
              </div>
              <div style="text-align: center; padding: 15px; background: #333; border-radius: 8px;">
                <div style="font-size: 1.5em; color: #25c2a0; font-weight: bold;">${data.overview.flaggedTransactions}</div>
                <div style="font-size: 0.9em; color: #ccc;">Flagged Transactions</div>
              </div>
            </div>
          `;

          if (data.overview.recentEvents && data.overview.recentEvents.length > 0) {
            alertsHtml += '<h4 style="margin-bottom: 15px;">Recent Security Events</h4>';
            alertsHtml += '<div style="max-height: 200px; overflow-y: auto;">';

            data.overview.recentEvents.forEach(event => {
              const eventColor = event.type === 'user_blocked' ? '#e74c3c' :
                                event.type === 'user_unblocked' ? '#27ae60' : '#f39c12';

              alertsHtml += `
                <div style="padding: 10px; margin-bottom: 8px; background: #333; border-radius: 5px; border-left: 3px solid ${eventColor};">
                  <div style="font-weight: bold; color: ${eventColor};">${event.type.replace('_', ' ').toUpperCase()}</div>
                  <div style="font-size: 0.9em; color: #ccc;">Wallet: ${event.wallet}</div>
                  <div style="font-size: 0.8em; color: #666;">${new Date(event.timestamp).toLocaleString()}</div>
                </div>
              `;
            });

            alertsHtml += '</div>';
          } else {
            alertsHtml += '<div style="color: #666; text-align: center; padding: 20px;">No recent security events</div>';
          }

          alertsDiv.innerHTML = alertsHtml;
        } else {
          alertsDiv.innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading security data</div>';
        }
      } catch (error) {
        console.error('Error loading security data:', error);
      }
    }

    async function checkWalletSecurity() {
      const wallet = document.getElementById('securityWallet').value.trim();
      if (!wallet) {
        showAlert('Please enter a wallet address', 'error');
        return;
      }

      try {
        const res = await fetch(`${API_BASE}/api/security/check/${wallet}`);
        const data = await res.json();

        const resultsDiv = document.getElementById('securityResults');
        if (data.success) {
          resultsDiv.innerHTML = `
            <div style="margin-top: 20px; padding: 15px; background: #333; border-radius: 8px;">
              <h4 style="color: #25c2a0; margin-bottom: 10px;">Security Report for ${wallet.slice(0, 8)}...${wallet.slice(-6)}</h4>
              <div><strong>Status:</strong> <span class="status-badge status-${data.status.toLowerCase()}">${data.status}</span></div>
              <div><strong>Violations:</strong> ${data.violationCount}</div>
              <div><strong>Blocked:</strong> ${data.isBlocked ? 'Yes' : 'No'}</div>
              <div><strong>Last Check:</strong> ${new Date().toLocaleString()}</div>
            </div>
          `;
        } else {
          resultsDiv.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('securityResults').innerHTML = `<div class="alert alert-error">Network error checking wallet</div>`;
      }
    }

    // Manual security action functions
    async function blockUser() {
      const wallet = document.getElementById('blockWallet').value.trim();
      const reason = document.getElementById('blockReason').value.trim();
      const resultDiv = document.getElementById('blockResult');

      if (!wallet || !reason) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter both wallet address and reason';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Blocking user...';

        const response = await apiCall('/api/security/block', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `‚úÖ <strong>User Blocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason}`;

          // Clear form
          document.getElementById('blockWallet').value = '';
          document.getElementById('blockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Blocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function unblockUser() {
      const wallet = document.getElementById('unblockWallet').value.trim();
      const reason = document.getElementById('unblockReason').value.trim();
      const resultDiv = document.getElementById('unblockResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Unblocking user...';

        const response = await apiCall('/api/security/unblock', {
          method: 'POST',
          body: JSON.stringify({ wallet, reason: reason || 'Admin unblock' })
        });

        if (response.success) {
          resultDiv.className = 'success';
          resultDiv.innerHTML = `‚úÖ <strong>User Unblocked Successfully</strong><br>Wallet: ${wallet}<br>Reason: ${reason || 'Admin unblock'}`;

          // Clear form
          document.getElementById('unblockWallet').value = '';
          document.getElementById('unblockReason').value = '';

          // Refresh security data
          loadSecurityData();
          loadUsersData();
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Unblocking Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    async function checkUserSecurity() {
      const wallet = document.getElementById('checkWallet').value.trim();
      const resultDiv = document.getElementById('securityCheckResult');

      if (!wallet) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Please enter wallet address';
        return;
      }

      if (!wallet.startsWith('r') || wallet.length < 25) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = '‚ùå Invalid wallet address format';
        return;
      }

      try {
        resultDiv.className = 'loading';
        resultDiv.innerHTML = '‚è≥ Checking security status...';

        const response = await apiCall(`/api/security/check/${wallet}`);

        if (response.success) {
          const security = response.security;
          const riskColor = security.riskLevel === 'HIGH' ? '#e74c3c' :
                           security.riskLevel === 'MEDIUM' ? '#f39c12' : '#27ae60';

          resultDiv.className = 'info';
          resultDiv.innerHTML = `
            <div style="background: #333; padding: 15px; border-radius: 8px; margin-top: 10px;">
              <div style="font-weight: bold; color: #25c2a0; margin-bottom: 10px;">Security Report: ${wallet.slice(0, 8)}...${wallet.slice(-6)}</div>

              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Status</div>
                  <div style="color: ${security.isBlocked ? '#e74c3c' : security.isSuspicious ? '#f39c12' : '#27ae60'}; font-weight: bold;">
                    ${security.isBlocked ? 'üö´ BLOCKED' : security.isSuspicious ? '‚ö†Ô∏è SUSPICIOUS' : '‚úÖ ACTIVE'}
                  </div>
                </div>
                <div>
                  <div style="color: #ccc; font-size: 0.9em;">Risk Level</div>
                  <div style="color: ${riskColor}; font-weight: bold;">${security.riskLevel} (${security.riskScore}/100)</div>
                </div>
              </div>

              ${security.blockReason ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Block Reason</div>
                  <div style="color: #e74c3c;">${security.blockReason}</div>
                </div>
              ` : ''}

              ${security.riskFactors.length > 0 ? `
                <div style="margin-bottom: 10px;">
                  <div style="color: #ccc; font-size: 0.9em;">Risk Factors</div>
                  <div style="color: #f39c12;">${security.riskFactors.join(', ')}</div>
                </div>
              ` : ''}

              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.9em;">
                <div>
                  <div style="color: #666;">Battles</div>
                  <div style="color: #ccc;">${security.userData.totalBattles}</div>
                </div>
                <div>
                  <div style="color: #666;">Votes</div>
                  <div style="color: #ccc;">${security.userData.totalVotes}</div>
                </div>
                <div>
                  <div style="color: #666;">Last Active</div>
                  <div style="color: #ccc;">${security.userData.lastActive ? new Date(security.userData.lastActive).toLocaleDateString() : 'Never'}</div>
                </div>
              </div>
            </div>
          `;

          // Clear form
          document.getElementById('checkWallet').value = '';
        } else {
          resultDiv.className = 'error';
          resultDiv.innerHTML = `‚ùå <strong>Security Check Failed</strong><br>${response.error || 'Unknown error occurred'}`;
        }
      } catch (error) {
        resultDiv.className = 'error';
        resultDiv.innerHTML = `‚ùå <strong>Network Error</strong><br>${error.message}`;
      }
    }

    // Initialize admin panel - Production Ready
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication first
      if (!checkAdminAuth()) {
        return; // Auth modal will be shown
      }

      // Show admin info
      const adminInfo = document.createElement('div');
      adminInfo.style.cssText = 'position: fixed; top: 10px; right: 10px; background: #333; padding: 10px; border-radius: 5px; font-size: 0.9em; z-index: 1000;';
      adminInfo.innerHTML = `
        <div style="color: #25c2a0;">üîê Admin: ${ADMIN_WALLET.slice(0, 8)}...${ADMIN_WALLET.slice(-6)}</div>
        <button onclick="logout()" style="background: #e74c3c; color: #fff; border: none; padding: 5px 10px; border-radius: 3px; margin-top: 5px; cursor: pointer;">Logout</button>
      `;
      document.body.appendChild(adminInfo);

      // Load initial data
      loadDashboardData();

      // Set up form handlers
      document.getElementById('airdropForm').addEventListener('submit', handleAirdropSubmit);
      document.getElementById('daoForm').addEventListener('submit', handleDAOSubmit);

      // Set up periodic refresh
      setInterval(() => {
        if (currentSection === 'dashboard') {
          loadDashboardData();
        }
      }, 30000); // Refresh every 30 seconds

      // Listen for wallet changes (logout detection)
      window.addEventListener('storage', (e) => {
        if (e.key === 'xummWallet' && e.newValue !== ADMIN_WALLET) {
          location.reload();
        }
      });
    });

    // Old logout function removed - using the password-based logout function instead

    // Airdrop Password Management Functions
    async function getCurrentAirdropPassword() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please enter admin key in the authentication section first', 'error');
          return;
        }

        const response = await fetch(`${API_BASE}/api/airdrop/current-password`, {
          headers: {
            'x-admin-key': adminKey
          }
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById('currentPasswordDisplay').textContent = data.currentPassword;
          document.getElementById('sourceText').textContent = data.source;
          document.getElementById('passwordSource').style.display = 'block';
          showAlert('Current password loaded successfully', 'success');
        } else {
          showAlert(`Failed to get current password: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Get password error:', error);
        showAlert('Failed to get current password', 'error');
      }
    }

    async function updateAirdropPassword() {
      const adminKey = localStorage.getItem('adminKey');
      const newPassword = document.getElementById('newDailyPassword').value.trim();

      if (!adminKey) {
        showAlert('Please enter admin key in the authentication section first', 'error');
        return;
      }

      if (!newPassword || newPassword.length < 3) {
        showAlert('Password must be at least 3 characters long', 'error');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/airdrop/set-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-key': adminKey
          },
          body: JSON.stringify({
            newPassword: newPassword
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`Password updated successfully to: ${data.newPassword}`, 'success');
          getCurrentAirdropPassword(); // Refresh current password display
          document.getElementById('newDailyPassword').value = ''; // Clear input
        } else {
          showAlert(`Failed to update password: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Update password error:', error);
        showAlert('Failed to update password', 'error');
      }
    }

    function setQuickAirdropPassword(password) {
      document.getElementById('newDailyPassword').value = password;
    }

    function generateRandomAirdropPassword() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let password = 'WALDO';
      for (let i = 0; i < 4; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated random password: ${password}`, 'info');
    }

    function generateDailyAirdropPassword() {
      const today = new Date();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      const password = `WALDO${month}${day}`;
      document.getElementById('newDailyPassword').value = password;
      showAlert(`Generated today's password: ${password}`, 'info');
    }

    async function clearPasswordOverride() {
      try {
        const adminKey = localStorage.getItem('adminKey');
        if (!adminKey) {
          showAlert('Please save your admin key first', 'error');
          return;
        }

        // Clear the Redis override by setting it to empty
        const response = await fetch(`${API_BASE}/api/airdrop/set-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            adminKey: adminKey,
            newPassword: '' // This will clear the Redis override
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('Password override cleared. Now using default password (WALDOCREW)', 'success');
          getCurrentAirdropPassword(); // Refresh current password display
          document.getElementById('newDailyPassword').value = ''; // Clear input
        } else {
          showAlert(`Failed to clear override: ${data.error}`, 'error');
        }
      } catch (error) {
        console.error('Clear override error:', error);
        showAlert('Failed to clear password override', 'error');
      }
    }

    // Form handlers - Production Ready
    async function handleAirdropSubmit(e) {
      e.preventDefault();

      const wallet = document.getElementById('airdropWallet').value.trim();
      const amount = parseFloat(document.getElementById('airdropAmount').value);
      const reason = document.getElementById('airdropReason').value.trim() || 'Admin manual airdrop';

      // Validation
      if (!wallet || !wallet.match(/^r[a-zA-Z0-9]{24,34}$/)) {
        showAlert('Please enter a valid XRPL wallet address', 'error');
        return;
      }

      if (!amount || amount <= 0 || amount > 10000) {
        showAlert('Amount must be between 1 and 10,000 WALDO', 'error');
        return;
      }

      // Confirm action
      if (!confirm(`Send ${amount} WALDO to ${wallet}?\n\nReason: ${reason}`)) {
        return;
      }

      try {
        // Use the existing airdrop endpoint
        const data = await apiCall('/api/airdrop', {
          method: 'POST',
          body: JSON.stringify({
            wallet,
            amount,
            adminOverride: true,
            reason
          })
        });

        if (data.success) {
          showAlert(`‚úÖ Airdrop sent successfully! Transaction: ${data.txHash || 'Pending'}`, 'success');
          document.getElementById('airdropForm').reset();
          loadAirdropsData();
        } else {
          showAlert(`‚ùå ${data.error || 'Failed to send airdrop'}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Error sending airdrop: ${error.message}`, 'error');
      }
    }

    async function handleDAOSubmit(e) {
      e.preventDefault();

      const title = document.getElementById('daoTitle').value.trim();
      const description = document.getElementById('daoDescription').value.trim();
      const options = document.getElementById('daoOptions').value.split(',').map(opt => opt.trim()).filter(Boolean);
      const duration = parseInt(document.getElementById('daoDuration').value);

      try {
        const res = await fetch(`${API_BASE}/api/dao/proposals/create`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, options, durationHours: duration })
        });

        const data = await res.json();

        if (data.success) {
          showAlert('DAO proposal created successfully!', 'success');
          document.getElementById('daoForm').reset();
          loadDAOData();
        } else {
          showAlert(data.error || 'Failed to create proposal', 'error');
        }
      } catch (error) {
        showAlert('Network error creating proposal', 'error');
      }
    }

    // DAO functions - Production Ready
    async function loadDAOData() {
      try {
        const data = await apiCall('/api/dao/proposals?limit=10');
        const daoDiv = document.getElementById('daoProposals');

        if (data.success && data.proposals.length > 0) {
          let daoHtml = `
            <div style="max-height: 400px; overflow-y: auto;">
          `;

          data.proposals.forEach(proposal => {
            const statusColor = proposal.status === 'active' ? '#25c2a0' :
                               proposal.status === 'passed' ? '#27ae60' : '#e74c3c';
            const timeRemaining = proposal.timeRemaining > 0 ?
              Math.ceil(proposal.timeRemaining / (24 * 60 * 60 * 1000)) + ' days' : 'Expired';

            daoHtml += `
              <div style="padding: 15px; margin-bottom: 10px; background: #333; border-radius: 8px; border-left: 4px solid ${statusColor};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                  <div>
                    <div style="font-weight: bold; color: #25c2a0; margin-bottom: 5px;">${proposal.title}</div>
                    <div style="font-size: 0.9em; color: #ccc; margin-bottom: 8px;">${proposal.description.substring(0, 100)}${proposal.description.length > 100 ? '...' : ''}</div>
                  </div>
                  <div style="text-align: right;">
                    <div style="color: ${statusColor}; font-weight: bold; text-transform: uppercase;">${proposal.status}</div>
                    <div style="font-size: 0.8em; color: #666;">${timeRemaining}</div>
                  </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; gap: 20px;">
                    <div style="color: #27ae60;">‚úì ${proposal.votes.yes} Yes</div>
                    <div style="color: #e74c3c;">‚úó ${proposal.votes.no} No</div>
                    <div style="color: #ccc;">Total: ${proposal.votes.total}</div>
                  </div>
                  <div style="font-size: 0.8em; color: #666;">
                    Support: ${(proposal.currentSupport * 100).toFixed(1)}% | Quorum: ${proposal.quorumMet ? '‚úì' : '‚úó'}
                  </div>
                </div>
              </div>
            `;
          });

          daoHtml += '</div>';
          daoDiv.innerHTML = daoHtml;
        } else {
          daoDiv.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No active DAO proposals</div>';
        }
      } catch (error) {
        console.error('Error loading DAO data:', error);
        document.getElementById('daoProposals').innerHTML = '<div style="color: #e74c3c; text-align: center; padding: 20px;">Error loading DAO proposals</div>';
      }
    }

    async function loadSystemData() {
      document.getElementById('systemHealth').innerHTML = `
        <div class="alert alert-success">‚úÖ Backend API: Online</div>
        <div class="alert alert-success">‚úÖ Database: Connected</div>
        <div class="alert alert-success">‚úÖ XRPL: Connected</div>
        <div class="alert alert-warning">‚ö†Ô∏è High memory usage: 78%</div>
      `;
    }

    // Emergency Action Functions
    function viewUser(wallet) {
      showAlert(`Viewing security details for: ${wallet}`, 'success');
      // In production, this would show detailed user security info
    }

    function blockUser(wallet) {
      if (confirm(`üö® SECURITY OVERRIDE: Block user ${wallet}?\n\nThis will immediately prevent them from:\n- Claiming rewards\n- Participating in battles\n- Receiving airdrops\n\nUse only if automated fraud detection failed.`)) {
        showAlert(`üö´ User ${wallet} blocked via manual override`, 'warning');
        // In production, this would call the security API
      }
    }

    function unblockUser(wallet) {
      if (confirm(`üîì SECURITY OVERRIDE: Unblock user ${wallet}?\n\nThis will restore their access to all WALDO features.\n\nOnly unblock if you're certain they're legitimate.`)) {
        showAlert(`‚úÖ User ${wallet} unblocked via manual override`, 'success');
        // In production, this would call the security API
      }
    }

    function endCurrentBattle() {
      if (confirm('üö® BATTLE EMERGENCY OVERRIDE\n\nForce end the current battle?\n\nThis will:\n- Immediately end voting\n- Calculate winner based on current votes\n- Distribute rewards\n- Affect all active participants\n\nUse only if automated battle system failed.')) {
        showAlert('‚öîÔ∏è Battle force-ended via emergency override', 'warning');
        // In production, this would call the battle API
      }
    }

    function cancelCurrentBattle() {
      if (confirm('üö® BATTLE EMERGENCY CANCEL\n\nCancel the current battle entirely?\n\nThis will:\n- Cancel the battle without a winner\n- Refund all participants\n- Cannot be undone\n\nUse only in critical situations.')) {
        showAlert('‚ùå Battle cancelled via emergency override', 'error');
        // In production, this would call the battle API
      }
    }

    function refreshAllData() {
      if (confirm('üîÑ FORCE DATA REFRESH\n\nThis will reload all dashboard data and may cause temporary slowdowns.\n\nContinue?')) {
        showAlert('üîÑ Forcing data refresh...', 'success');
        loadSectionData(currentSection);
      }
    }

    function clearCache() {
      if (confirm('üóëÔ∏è EMERGENCY CACHE CLEAR\n\nThis will clear all system caches and may cause temporary performance issues.\n\nUse only if system is behaving unexpectedly.\n\nContinue?')) {
        showAlert('üóëÔ∏è Emergency cache clear initiated', 'warning');
        // In production, this would call the cache clear API
      }
    }

    function emergencyStop() {
      const confirmation = prompt('üö® SYSTEM EMERGENCY STOP\n\nThis will halt ALL WALDOCOIN operations:\n- Stop all battles\n- Disable airdrops\n- Block all transactions\n- Affect all users\n\nType "EMERGENCY STOP" to confirm:');

      if (confirmation === 'EMERGENCY STOP') {
        showAlert('üõë SYSTEM EMERGENCY STOP ACTIVATED', 'error');
        // In production, this would call the emergency stop API
      } else if (confirmation !== null) {
        showAlert('‚ùå Emergency stop cancelled - incorrect confirmation', 'warning');
      }
    }

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', function() {
      if (checkAdminAuth()) {
        loadSectionData('dashboard');
      }

      // Initialize stake selector event listener
      const stakeSelector = document.getElementById('stakeSelector');
      if (stakeSelector) {
        stakeSelector.addEventListener('change', function() {
          const stakeDetails = document.getElementById('stakeDetails');

          if (this.value) {
            const stake = JSON.parse(this.value);
            const unlockDate = new Date(stake.unlockDate).toLocaleDateString();
            const isMatured = new Date() >= new Date(stake.unlockDate);

            document.getElementById('stakeAmount').textContent = `${stake.amount} WALDO`;
            document.getElementById('stakeDuration').textContent = `${stake.duration} days`;
            document.getElementById('stakeAPY').textContent = `${(stake.apy * 100).toFixed(1)}%`;
            document.getElementById('stakeUnlockDate').textContent = unlockDate;
            document.getElementById('stakeRewards').textContent = `${(stake.currentRewards || 0).toFixed(2)} WALDO`;
            document.getElementById('stakeStatus').textContent = stake.status;

            // Show/hide force unstake option based on maturity
            const forceCheckbox = document.getElementById('forceUnstake');
            if (isMatured) {
              forceCheckbox.checked = false;
              forceCheckbox.disabled = true;
              forceCheckbox.parentElement.style.opacity = '0.5';
            } else {
              forceCheckbox.disabled = false;
              forceCheckbox.parentElement.style.opacity = '1';
            }

            stakeDetails.style.display = 'block';
          } else {
            stakeDetails.style.display = 'none';
          }
        });
      }
    });

    // Initialize login check when page loads
    document.addEventListener('DOMContentLoaded', function() {
      checkExistingLogin();
    });
  </script>

  </div> <!-- Close adminPanel -->
</body>
</html>
