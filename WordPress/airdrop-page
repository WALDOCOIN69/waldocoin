<!-- 🎁 WALDO Airdrop Claim (WordPress HTML Block) -->
<div class="airdrop-box" style="background:#111; border:2px solid red; padding:30px; border-radius:18px; max-width:500px; margin:auto; color:white; font-family:'Arial Black', sans-serif; text-align:center;">

  <h2 style="color:#ffea00; margin-bottom:10px;">🎁 WALDO Airdrop</h2>

  <p style="font-size:14px; margin-bottom:20px;">
    🔐 Enter the secret password from our Telegram group to claim your free <strong>20,000 WALDO</strong>.
  </p>

  <input type="password" id="airdropPassword" placeholder="Enter Password" style="padding:10px; width:80%; border-radius:8px; border:none; margin-bottom:15px;" />

  <div style="margin-bottom:20px;">
    <button onclick="connectXummWallet()" style="background:#ffea00; color:black; padding:10px 18px; border:none; border-radius:10px; font-weight:bold; margin:6px;">🔌 Connect Wallet</button>
    <button onclick="claimWaldoAirdrop()" style="background:red; color:white; padding:10px 18px; border:none; border-radius:10px; font-weight:bold; margin:6px;">🎯 Claim Airdrop</button>
  </div>

  <p id="walletStatus" style="font-size:13px; color:#ff0;">Wallet: Not Connected</p>

  <!-- QR Login -->
  <div id="xummLoginBox" style="margin-top:10px;">
    <div style="display:flex; align-items:center; justify-content:center; gap:14px; margin-top:12px;">
      <img id="xummQR" src="" style="width:100px; display:none; border:2px solid #ccc; border-radius:12px; background:#000;" />
      <div id="xummQRLabel" style="color:#00ffff; font-size:13px; display:none;">🔌 Connect XAMAN Wallet</div>
    </div>
    <div id="xummMobileLink" style="margin-top:6px; display:none;">
      <a id="xummDeepLink" href="#" style="color:#00ffff; font-size:12px;">📲 Tap here to open in XAMAN app</a>
    </div>
  </div>

  <p id="airdropResult" style="color:#0f0; font-weight:bold; margin-top:16px;"></p>

  <!-- Trustline QR (hidden by default) -->
  <div id="trustlineBox" style="display:none; margin-top:20px;">
    <p style="color:red; font-weight:bold;">🚫 WALDO Trustline Not Found</p>
    <p style="font-size:13px; margin-bottom:8px;">You need to add the WALDO trustline before claiming.</p>
    <img src="https://xrpl.services/xumm/tx/TrustSet?r=rf97bQQbqztUnL1BYB5ti4rC691e7u5C8F&amp;c=WLO&amp;l=1000000000" alt="Add Trustline" style="width:120px; border-radius:10px; border:2px solid #fff;" />
    <p style="font-size:12px; margin-top:8px;">Scan with XAMAN or <a href="https://xrpl.services/xumm/tx/TrustSet?r=rf97bQQbqztUnL1BYB5ti4rC691e7u5C8F&c=WLO&l=1000000000" target="_blank" style="color:cyan;">click here</a></p>
  </div>
</div>

<script>
async function connectXummWallet() {
  try {
    const res = await fetch("https://waldocoin-backend-api.onrender.com/api/login");
    const data = await res.json();

    if (!data.qr || !data.uuid) return alert("❌ Failed to generate wallet login.");

    document.getElementById("xummQR").src = data.qr;
    document.getElementById("xummQR").style.display = "block";
    document.getElementById("xummQRLabel").style.display = "block";
    localStorage.setItem("xummUUID", data.uuid);

    if (/Mobi|Android/i.test(navigator.userAgent) && data.refs?.xapp) {
      document.getElementById("xummDeepLink").href = data.refs.xapp;
      document.getElementById("xummMobileLink").style.display = "block";
    }

    const interval = setInterval(async () => {
      const statusRes = await fetch(`https://waldocoin-backend-api.onrender.com/api/login/status?uuid=${data.uuid}`);
      const status = await statusRes.json();

      if (status?.signed && status?.account) {
        clearInterval(interval);
        localStorage.setItem("xummWallet", status.account);
        document.getElementById("walletStatus").innerText = `Wallet: ${status.account}`;
      }
    }, 2000);
  } catch (err) {
    console.error(err);
    alert("❌ Error connecting to XUMM.");
  }
}

async function claimWaldoAirdrop() {
  const password = document.getElementById("airdropPassword").value.trim();
  const wallet = localStorage.getItem("xummWallet");

  document.getElementById("trustlineBox").style.display = "none";
  document.getElementById("airdropResult").innerText = "";

  if (!wallet) return alert("Please connect your wallet.");
  if (!password) return alert("Please enter the password.");

  const res = await fetch("https://waldocoin-backend-api.onrender.com/api/airdrop/claim", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ wallet, passcode: password })
  });

  const data = await res.json();

  if (data.success) {
    document.getElementById("airdropResult").innerText = "✅ Airdrop claimed! Check your wallet.";
  } else {
    if ((data.error || "").toLowerCase().includes("trustline")) {
      document.getElementById("trustlineBox").style.display = "block";
    }
    document.getElementById("airdropResult").innerText = `❌ ${data.error || "Error claiming airdrop."}`;
  }
}
</script>

