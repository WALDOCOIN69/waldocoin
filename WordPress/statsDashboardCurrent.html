
  <!DOCTYPE html>
  <html lang="en">
    <head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>WALDOcoin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/chart.js/dist/Chart.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  <style>
html, body {
  font-family: 'Inter', sans-serif;
  background-image: url("https://waldocoin.live/wp-content/uploads/2025/05/1737843965137.jpg") !important;
  background-color: #000 !important;
  background-size: 200px 200px !important;
  background-repeat: repeat !important;
  background-attachment: fixed !important;
  margin: 0;
  padding: 0;
  height: auto;
  min-height: 100vh;
  overflow-y: auto !important;
  overflow-x: hidden;
  position: relative;
}

.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 30px;
  width: 100vw;
  max-width: 100vw;
  margin: 0;
  padding: 40px 10px;
  box-sizing: border-box;
}
    .card {
      background: #111;
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      animation: fadeInUp 0.8s ease;
      position: relative;
    }
    .big-card {
      grid-column: 1 / -1;
      padding: 30px;
      font-size: 1.1rem;
    }
    
    .card h1, .card h2, .card h3 {
      color: white;
      text-align: center;
    }
    .level-title {
      margin: 10px 0;
      font-weight: bold;
      color: #25c2a0;
    }
.level-icon {
  width: 80px;
  height: auto;
  display: block;
  margin: 10px auto;
  border-radius: 8px; /* Optional for rounded corners */
}

/* Added for #userLevelIcon to match removed inline style */
#userLevelIcon {
  width: 100px;
  height: auto;
  margin: 10px auto;
  display: block;
}

    .level-title.level-1 { color: #ff2626; }   
    .level-title.level-2 { color: #298cf5; }   
    .level-title.level-3 { color: #ff930e; }   
    .level-title.level-4 { color: #63f707; }   
    .level-title.level-5 { color: rgb(255, 196, 0); }      
    
    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #333;
    }
    thead th {
      background: #222;
      color: #25c2a0;
      font-weight: bold;
    }
    
    .tooltip-wrapper {
      position: relative;
      display: inline-block;
    }
    .tooltip-icon {
      background: #25c2a0;
      color: black;
      font-size: 14px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 50%;
      cursor: pointer;
      line-height: 1;
    }
    .tooltip-text {
      visibility: hidden;
      width: 240px;
      background-color: #111;
      color: #25c2a0;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -120px;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 0 10px #25c2a0;
    }
    .tooltip-wrapper:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    .disconnect-btn {
      display: block;
      margin: 0 auto 20px;
      background: red;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .meme-thumb {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .meme-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px #fb2f2f;
    }
    
    .flip-card {
      background-color: transparent;
      width: 200px;
      height: 280px;
      perspective: 1000px;
      cursor: pointer;
    }
    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.8s;
      transform-style: preserve-3d;
    }
    .flip-card:hover .flip-card-inner {
      transform: rotateY(180deg);
    }
    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 12px;
      box-shadow: 0 0 10px #ff5252;
      background: #111;
      color: white;
    }
    .flip-card-back {
      transform: rotateY(180deg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      padding: 15px;
    }
    .flip-card img {
      width: 100%;
      height: auto;
      border-radius: 10px;
    }
    
    .battle-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-top: 10px;
      animation: pulse 1.5s infinite;
    }
    .badge-open { background: #25c2a0; color: black; box-shadow: 0 0 10px #25c2a0; }
    .badge-expired { background: #ff4136; color: white; box-shadow: 0 0 10px #ff4136; }
    .badge-complete { background: #0074D9; color: white; box-shadow: 0 0 10px #0074D9; }
    .badge-waiting { background: #FFDC00; color: black; box-shadow: 0 0 10px #FFDC00; }
    
    #waldoNotification {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 0 20px #25c2a0;
      z-index: 9999;
      font-weight: bold;
      text-align: center;
      animation: pulseBanner 2s infinite;
      max-width: 90%;
    }
    @keyframes pulseBanner {
      0% { box-shadow: 0 0 10px #25c2a0; }
      50% { box-shadow: 0 0 20px #25c2a0; }
      100% { box-shadow: 0 0 10px #25c2a0; }
    }
    
    .dismiss-btn {
      margin-left: 20px;
      background: transparent;
      border: 1px solid #25c2a0;
      color: #25c2a0;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .center-text {
      text-align: center;
    }
    
    .wallet-address {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .flex-column-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    
    .xp-stats-card {
      background: #111;
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }
    
    .nft-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .close-nft-modal {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 30px;
      color: white;
      cursor: pointer;
    }
    
    .waldo-total-earned-display {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
    }
    
    .waldo-promo-img {
      width: 100%;
      border-radius: 8px;
    }
    
    .button-style {
      width: 100%;
      max-width: 400px;
      padding: 10px 14px;
      border-radius: 6px;
      background: #25c2a0;
      color: black;
      font-weight: bold;
      font-size: 16px;
      border: none;
      cursor: pointer;
    }
    
    .input-style {
      width: 100%;
      max-width: 400px;
      padding: 10px 14px;
      border-radius: 6px;
      background: #222;
      color: white;
      border: 1px solid #444;
      font-size: 16px;
    }
    
    .minted-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .xrpl-link-red {
      color: #ff5252;
      text-decoration: none;
    }
    .xrpl-link-green {
  color: #25c2a0;
  text-decoration: none;
    }
    
    .twitter-link-status {
      margin-top: 6px;
      color: #25c2a0;
      text-align: center;
    }
    
    .activity-feed {
      list-style: none;
      padding: 0;
    }
    
    .leaderboard-list {
      list-style: none;
      padding: 0;
      font-size: 16px;
    }
    
    .leaderboard-container {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    
    .flex-item {
      flex: 1;
      min-width: 300px;
    }
    
    .info-text {
      font-size: 14px;
      color: #aaa;
      margin-top: 10px;
    }
    
    .margin-top-0 {
      margin-top: 0;
    }
    
    .margin-top-20 {
      margin-top: 20px;
    }
    .battle-notification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #fb2f2f;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(251, 47, 47, 0.6);
      z-index: 999;
      animation: pulse 2s infinite;
      cursor: pointer;
    }
    
   .battle-memes-container {
  display: flex;
  justify-content: space-between;
  gap: 36px;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.battle-memes-container .flex-item {
  flex: 1;
  min-width: 180px;
  max-width: 280px;
  background: #191919;
  border-radius: 12px;
  padding: 16px;
  margin: 0 12px;
  box-shadow: 0 0 12px #222;
  text-align: center;
}
@media (max-width: 850px) {
  .battle-memes-container {
    flex-direction: column;
    align-items: center;
  }
  .battle-memes-container .flex-item {
    max-width: 95vw;
    margin: 10px 0;
  }
}

    
    .battle-timer {
      margin-top: 20px;
      font-weight: bold;
      font-size: 18px;
    }
    
    .battle-result {
      font-weight: bold;
      font-size: 16px;
      color: gold;
      margin-top: 10px;
    }
    
    .centered-column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    
    .centered-flex-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .overflow-auto {
      overflow-x: auto;
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 15px;
    }
    
    .pagination button {
      padding: 5px 10px;
      border: none;
      background: transparent;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .meme-score {
      font-size: 60px;
      font-weight: bold;
      color: #25c2a0;
      transition: all 0.5s ease;
  }
  .reward-logic-table {
  grid-column: 1 / -1;
  max-width: 800px;
    margin: 0 auto;
  }
    .progress-bar {
      width: 100%;
      height: 12px;
    }
    #levelProgress {
      width: 100%;
      height: 20px;
    }
    
    .nft-modal-image {
      max-width: 90%;
      max-height: 90%;
      border-radius: 12px;
      box-shadow: 0 0 20px #fb2f2f;
    }
    .dao-voting-card {
  box-shadow: 0 0 12px #ffcc00;
}

      .nft-modal {
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.nft-modal.show {
  opacity: 1;
  pointer-events: all;
}

.nft-modal-image {
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.nft-modal.show .nft-modal-image {
  transform: scale(1);
}
.twitter-link-container {
  display: flex;
  flex-direction: column;   /* stack vertically */
  justify-content: center;
  align-items: center;
  gap: 12px;                /* space between input and button */
  margin-bottom: 18px;
  margin-top: 8px;
  width: 100%;
}


.input-style {
  width: 220px;
  max-width: 100%;
  padding: 10px 14px;
  border-radius: 6px;
  background: #222;
  color: white;
  border: 1px solid #444;
  font-size: 16px;
}

.button-style, .start-battle-btn, .accept-battle-btn {
  width: 100%;
  max-width: 370px;
  padding: 12px 18px;
  border-radius: 8px;
  background: #25c2a0;
  color: #191919;
  font-weight: bold;
  font-size: 17px;
  border: none;
  margin: 8px 0;
  cursor: pointer;
  box-shadow: 0 0 8px #25c2a0aa;
  transition: background 0.2s, box-shadow 0.2s;
}
.button-style:hover, .start-battle-btn:hover, .accept-battle-btn:hover {
  background: #23ad91;
  color: #fff;
  box-shadow: 0 0 16px #25c2a0;
}
.card h2, .battle-arena h2 {
  color: #25c2a0;
  font-size: 2.1rem;
  font-weight: bold;
  letter-spacing: 1px;
  margin-bottom: 16px;
  text-align: center;
}

.instruction-card {
  background: #111 !important;   /* Solid black background */
  color: #fff;
  padding: 24px 18px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.4);
  margin-bottom: 24px;
  font-size: 1.1rem;
  animation: fadeInUp 0.7s ease;
}
.instruction-card h2 {
  color: #25c2a0;
  margin-top: 0;
}
.instruction-card ul {
  padding-left: 18px;
}
.instruction-card li {
  margin-bottom: 8px;
  line-height: 1.6;
}
.dashboard-title-card {
  background: #000;
  border-radius: 18px;
  box-shadow: 0 0 18px rgba(0,0,0,0.8);
  max-width: 520px;
  margin: 32px auto 24px auto;
  padding: 24px 0 18px 0;
  text-align: center;
}

.dashboard-title {
  font-size: 2.5rem;
  color: #25c2a0;
  font-weight: bold;
  letter-spacing: 2px;
  margin: 0;
}

.battle-arena {
  grid-column: 1 / -1;
  width: 100vw;
  max-width: 100vw;
  margin: 0 -10vw 36px -10vw;
  background: #111;
  border-radius: 18px;
  box-shadow: 0 0 18px #25c2a0;
  padding: 40px 24px 30px 24px;
}

.battle-bottom-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 32px;
  justify-content: center;
  align-items: stretch;
  margin: 36px -10vw 0 -10vw;
  box-sizing: border-box;
}

.battle-bottom-row .card {
  background: #111;
  color: #25c2a0;
  border-radius: 18px;
  box-shadow: 0 0 18px #25c2a0;
  font-size: 2rem;
  padding: 38px 28px;
  min-width: 0;
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;      /* <--- THIS CENTERS CARD CONTENT */
  justify-content: flex-start;
  box-sizing: border-box;
  margin: 0;
}

.battle-bottom-row .card h2 {
  font-size: 2.1rem;
  color: #25c2a0;
  margin-bottom: 14px;
  text-align: center;
}

@media (max-width: 1000px) {
  .battle-bottom-row {
    grid-template-columns: 1fr;
    margin: 36px 0 0 0;
  }
  .battle-bottom-row .card {
    font-size: 1.3rem;
    padding: 28px 12px;
  }
}
.dashboard-stats-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 36px;
  width: 100%;
  margin-bottom: 36px;
}
.big-stats-card {
  background: #111;
  color: #fff;
  border-radius: 18px;
  box-shadow: 0 0 18px #25c2a0;
  padding: 42px 36px 38px 36px;
  min-width: 0;
  min-height: 340px;
  font-size: 1.4rem;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: flex-start;
}
.big-stats-card h2 {
  width: 100%;
  text-align: left;
  font-size: 2.1rem;
  color: #25c2a0;
  margin-bottom: 14px;
}
@media (max-width: 900px) {
  .dashboard-stats-row {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  .big-stats-card {
    font-size: 1rem;
    padding: 28px 10px;
    min-height: 0;
  }
}


</style>
    </head>
<body>
<div class="dashboard-title-card">
  <h1 class="dashboard-title">WALDOcoin Dashboard</h1>
</div>
  <!-- Notification bar OUTSIDE grid container -->
  <div id="waldoNotification">
    <span id="waldoMessage">👋 Welcome back! Ready to earn some WALDO?</span>
    <button type="button" onclick="dismissWaldoNotification()" class="dismiss-btn">Dismiss</button>
  </div>
  <div class="container">
    </div>
    <div id="linkResponse" class="link-response"></div>
    <div class="instruction-card">
      <h2>🚀 How to Earn WALDO</h2>
      <ul>
        <li>🖼 Post a meme on Twitter with the hashtag <strong>#WaldoMeme</strong></li>
        <li>🔗 Link your Twitter handle to your WALDO wallet</li>
        <li>📊 Watch your meme earn XP and rewards</li>
        <li>🏆 Claim or stake your rewards on the dashboard</li>
        <li>🔥 Mint your meme as an NFT when it hits 60 XP</li>
      </ul>
    </div>
<!-- WELCOME CARD -->
<div class="card big-card">
  <button type="button" onclick="logoutWallet()" class="disconnect-btn">🔌 Disconnect</button>
  <p id="walletAddress" class="wallet-address">Wallet: Loading...</p>
  <h3 class="center-text">🔗 Link Twitter Account</h3>
<div class="twitter-link-container">
  <input type="text" id="twitterHandleInput" class="input-style" placeholder="Enter Twitter handle">
  <button id="linkButton" type="button" class="button-style">Link Twitter</button>
</div>
  <h2>🎮 Member Level</h2>
  <img id="userLevelIcon" alt="Level Icon" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png">
  <p id="userLevelTitle" class="center-text level-title">Loading...</p>
  <progress id="levelProgress" max="100" value="0"></progress>
  <p id="xpToNextLevel" class="center-text">...</p>
</div>
<!-- XP Trends -->
<div class="dashboard-stats-row">
  <div class="card big-stats-card">
    <h2>📊 Meme XP Trends</h2>
    <canvas height="200" id="xpChart"></canvas>
  </div>
</div>
<!-- Social Stats -->
<div class="card big-stats-card">
  <h2>📱 Social Stats</h2>
  <p><strong>🔥 Top Meme:</strong> <span id="socialHandle">Loading...</span></p>
  <p><strong>👥 Followers:</strong> <span id="socialFollowers">—</span></p>
  <p><strong>🔥 Total Likes:</strong> <span id="totalLikes">Loading...</span></p>
  <p><strong>🏆 Top Meme Likes:</strong> <span id="topMemeLikes">Loading...</span></p>
  <p><strong>🖼️ Top Meme Preview:</strong></p>
  <img id="topMemeImage" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="Top Meme" class="meme-thumb">
    <p><a id="topMemeLink" href="#" target="_blank" class="xrpl-link-green">🔗 View Meme</a></p>
  </div>
<!-- XP Stats -->
<div class="card xp-stats-card">
  <h3>🧠 WALDO XP Stats</h3>
  <p><strong>Level:</strong> <span id="waldoLevel">Loading...</span></p>
  <p><strong>Title:</strong> <span id="waldoTitle">Loading...</span></p>
  <p><strong>XP:</strong> <span id="waldoXP">Loading...</span></p>
  <p><strong>Likes:</strong> <span id="waldoLikes">Loading...</span></p>
  <p><strong>Retweets:</strong> <span id="waldoRetweets">Loading...</span></p>
  <p><strong>Minted Memes:</strong> <span id="waldoMemes">Loading...</span></p>
  <p><strong>Battles Won:</strong> <span id="waldoBattles">Loading...</span></p>
  <p><strong>Referrals:</strong> <span id="waldoReferrals">Loading...</span></p>
  <p><strong>Next Level In:</strong> <span id="xpToNextLevelStats">Loading...</span></p>
</div>
<!-- Total WALDO Earned -->
<div class="card">
  <h2>💰 Total WALDO Earned</h2>
  <p id="waldoTotalEarnedDisplay" class="waldo-total-earned-display">Loading...</p>
</div>
<!-- WALDO Promo Media -->
<div class="card">
  <img alt="WALDO Promo" src="https://waldocoin.live/wp-content/uploads/2025/03/1737843965515-1.webp" class="waldo-promo-img">
  <h1>Use #WaldoMeme on Tweets for Rewards.</h1>
</div>
<!-- Meme XP Score -->
<div class="card full-width-card center-text">
  <h2>🎯 Your Meme XP Score</h2>
  <p id="memeScoreDisplay" class="meme-score">0</p>
</div>
<!-- WALDO Conversion Rate -->
<div class="card">
  <h2>💸 WALDO Conversion Rate</h2>
  <p id="waldoConversion" class="waldoConversionRate text-center">Loading...</p>
  <p id="waldoEarnings" class="text-center">Loading...</p>
  <img id="topMemeImg" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png" alt="Top Meme">
</div>
<!-- Referral Program -->
<div class="card">
  <h2>🤝 Referral Program</h2>
  <p class="center-text">Share your referral link to earn rewards when friends use #WaldoMeme.</p>
  <div class="flex-column-center">
    <input id="referralLink" readonly type="text" class="input-style">
    <button type="button" onclick="copyReferral()" class="button-style">Copy Referral Link</button>
    <p id="copyStatus" class="twitter-link-status"></p>
    <p class="centered-text">👥 Referrals: <strong id="refCount">0</strong></p>
  </div>
</div>
<!-- Recent Activity -->
<div class="card">
  <h2>📰 Recent Activity</h2>
  <ul id="activityFeed" class="activity-feed"></ul>
</div>
<!-- WALDO/USD Trend -->
<div class="card">
  <h2>📈 WALDO/USD Trend (7 Days)</h2>
  <canvas height="200" id="waldoPriceChart"></canvas>
</div>
<!-- WALDO Promo Media 2 -->
<div class="card">
  <img alt="WALDO Promo" src="https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg" class="waldo-promo-img">
  <h1>Use #WaldoMeme on Tweets for Rewards.</h1>
</div>
<!-- XP Gain Breakdown -->
<div class="card">
  <h2>🧠 XP Gain Breakdown</h2>
  <table>
    <tbody id="xpBreakdownTable">
      <tr><td>❤️ Likes</td><td><strong id="xpLikes">0 XP</strong></td></tr>
      <tr><td>🔁 Retweets</td><td><strong id="xpRetweets">0 XP</strong></td></tr>
      <tr><td>⚔️ Battle Wins</td><td><strong id="xpBattles">0 XP</strong></td></tr>
      <tr><td>📣 Referrals</td><td><strong id="xpReferrals">0 XP</strong></td></tr>
      <tr><td>🗳 Meme Voting</td><td><strong id="xpVoting">0 XP</strong></td></tr>
      <tr><td>⏳ Staking Bonus</td><td><strong id="xpStakingBonus">0%</strong></td></tr>
    </tbody>
  </table>
</div>
<!-- Reward Tiers Card -->
<div class="card reward-logic-table">
  <h2>💎 Reward Tiers</h2>
  <div class="overflow-auto">
    <table>
      <thead>
        <tr>
          <th scope="col">Tier</th>
          <th scope="col">Likes</th>
          <th scope="col">Retweets</th>
          <th scope="col">Base</th>
          <th scope="col">Instant Payout</th>
          <th scope="col">Stake Payout</th>
          <th scope="col">Max No-Stake (x40)</th>
          <th scope="col">Max Stake (x40)</th>
        </tr>
      </thead>
      <tbody id="rewardTierBody"></tbody>
    </table>
  </div>
</div>
<!-- Meme Table with Pagination, XP, Claim/Stake/Mint -->
<div class="card big-card">
  <div class="centered-flex-container">
    <h2 class="margin-top-0">📸 My Memes</h2>
    <div class="tooltip-wrapper">
      <span class="tooltip-icon">i</span>
      <span class="tooltip-text">Each meme must reach 60 XP to be eligible for minting as an NFT.</span>
    </div>
  </div>
  <div class="overflow-auto">
    <table>
      <thead>
        <tr>
          <th scope="col">Thumbnail</th>
          <th scope="col">Retweets</th>
          <th scope="col">Likes</th>
          <th scope="col">XP</th>
          <th scope="col">Tier</th>
          <th scope="col">Claim</th>
          <th scope="col">Stake</th>
          <th scope="col">Mint</th>
        </tr>
      </thead>
      <tbody id="memeTableBody"></tbody>
    </table>
    <div class="pagination" id="pagination"></div>
  </div>
</div>
<!-- WALDOcoin Battle Arena Notification -->
<div class="notification-banner">
  📢 Welcome to the Meme Battle Arena! Paste a meme tweet link, start a battle, or accept one to begin voting.
</div>
<div id="battleNotification" class="battle-notification">
  ⚔️ Battle has started! Join now and vote for your favorite meme!
</div>
<!-- WALDOcoin Battle Arena -->
<div class="card big-card battle-arena">
  <h2>🔥 Meme Battle Arena</h2>
  <div id="battleStatus">Loading current battle...</div>
  <div id="battleContent" style="display: none;">
    <div class="battle-memes-container">
      <div class="flex-item">
        <h3>Meme 1</h3>
        <a id="meme1Link" href="#" target="_blank">
          <img alt="Meme 1" class="meme-thumb" id="meme1Img" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/300x300?text=Meme+1">
        </a>
        <button type="button" onclick="voteBattle('meme1')">Vote for Meme 1</button>
      </div>
      <div class="battle-controls" data-tweetid="" data-status="open" data-canaccept="false" id="battle-wrapper">
        <button id="start-btn" class="start-battle-btn" type="button">Start Battle</button>
        <button id="accept-btn" class="accept-battle-btn" type="button">Accept Battle</button>
      </div>
      <div class="flex-item">
        <h3>Meme 2</h3>
        <a id="meme2Link" href="#" target="_blank">
          <img alt="Meme 2" class="meme-thumb" id="meme2Img" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/300x300?text=Meme+2">
        </a>
        <button type="button" onclick="voteBattle('meme2')">Vote for Meme 2</button>
      </div>
    </div>
    <p id="battleTimer" class="battle-timer"></p>
    <p id="battleVoteStatus" class="twitter-link-status"></p>
    <div class="margin-top-20">
      <p id="battleFinalResult" class="battle-result"></p>
    </div>
    <div class="margin-top-20">
      <h3 class="centered-text">🚀 Launch or Accept a Battle</h3>
      <div class="centered-column">
        <input id="memeTweetId" onblur="extractTweetId(this.value)" placeholder="Paste Meme Tweet Link (e.g. https://x.com/user/status/1234567890)" class="input-style" type="text">
        <button id="start-battle-btn" type="button" class="button-style">🧠 Start New Battle (100 WALDO)</button>
        <button id="accept-battle-btn" type="button" class="button-style">🤜 Accept Current Battle (50 WALDO)</button>
      </div>
      <div id="toast" class="toast hidden"></div>
    </div>
  </div>
</div>
<!-- Past Meme Battles -->
<div class="battle-bottom-row">
  <div class="card battle-history-card">
    <h2>📜 Past Meme Battles</h2>
    <div id="battleHistoryStatus">Loading battle history...</div>
    <div id="battleHistoryTableContainer" style="display: none;">
    <table class="battle-history-table">
      <thead>
        <tr>
          <th>🆔</th>
          <th>Meme 1</th>
          <th>Meme 2</th>
          <th>Votes</th>
          <th>Winner</th>
          <th>Ended</th>
        </tr>
      </thead>
      <tbody id="battleHistoryTable"></tbody>
    </table>
  </div>
</div>
<!-- Meme Battle Leaderboard -->
  <div class="card battle-leaderboard-card">
    <h2>🏆 Meme Battle Leaderboard</h2>
    <div id="battleLeaderboardStatus">Loading leaderboard...</div>
    <div id="battleLeaderboardContainer" style="display: none;">
    <table class="battle-leaderboard-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Meme ID</th>
          <th>Wins</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody id="battleLeaderboardTable"></tbody>
    </table>
  </div>
</div>
<!-- NFT Modal -->
<div id="nftModal" class="nft-modal">
  <span onclick="closeNFTModal()" class="close-nft-modal">&times;</span>
  <img id="nftModalImg" src="https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png/600x400.png?text=NFT+Preview" alt="NFT Preview" class="nft-modal-image">
</div>
<!-- WALDO DAO Voting Card -->
<div class="card big-card dao-voting-card" id="daoVotingCard">
  <h2>🗳 WALDOcoin DAO Voting</h2>
  <div id="proposalContainer">COMMING SOON...</div>
</div>
</div>
<script>
/** === CONFIG === **/
const baseURL = "https://waldocoin-backend-api.onrender.com";
const statsPage = "/your-waldocoin-stats/";
const loginPage = "/connect-waldo-wallet/";

/** === UTILS === **/
function $(id) { return document.getElementById(id); }
function getWallet() { return localStorage.getItem("xummWallet") || null; }
function logoutWallet() {
  localStorage.removeItem("xummWallet");
  window.location.replace(loginPage);
}

/** === LEVELS === **/
const levelTitles = {
  1: "Fresh Poster", 2: "Shitposter", 3: "Meme Dealer", 4: "OG Degen", 5: "WALDO Master"
};
const levelThresholds = [0, 250, 850, 1750, 3000];
const levelImages = {
  1: "https://waldocoin.live/wp-content/uploads/2025/04/1737843965114.jpg",
  2: "https://waldocoin.live/wp-content/uploads/2025/03/1737843965414.jpeg",
  3: "https://waldocoin.live/wp-content/uploads/2025/03/F.A.F.O.png",
  4: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.52.10.jpeg",
  5: "https://waldocoin.live/wp-content/uploads/2025/04/WhatsApp-Image-2025-04-03-at-22.53.38.jpeg"
};
const rewardTiers = [
  { tier: 1, likes: 25, retweets: 0, base: 1 },
  { tier: 2, likes: 50, retweets: 5, base: 2 },
  { tier: 3, likes: 100, retweets: 10, base: 5 },
  { tier: 4, likes: 500, retweets: 50, base: 25 },
  { tier: 5, likes: 1000, retweets: 100, base: 50 }
];

/** === NOTIFICATIONS === **/
function showWaldoNotification(msg, timeout = 5000) {
  const n = $("waldoNotification"), m = $("waldoMessage");
  if (!n || !m) return;
  m.textContent = msg;
  n.style.display = "flex";
  if (timeout) setTimeout(() => { n.style.display = "none"; }, timeout);
}
function dismissWaldoNotification() { $("waldoNotification")?.style && ($("waldoNotification").style.display = "none"); }

/** === TOASTS === **/
function showToast(message, type = "info", duration = 3500) {
  const toast = document.createElement("div");
  toast.className = "toast";
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed; bottom:30px; left:50%; transform:translateX(-50%);
    background: ${type === "error" ? "#e63e3e" : type === "success" ? "#2ecc71" : "#222"};
    color:white; padding:12px 20px; border-radius:8px; font-weight:600;
    z-index:99999; box-shadow:0 0 12px rgba(0,0,0,0.28);
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), duration);
}

/** === COPY REFERRAL === **/
function copyReferral() {
  const input = $("referralLink");
  if (!input) return;
  input.select();
navigator.clipboard.writeText(input.value)
  .then(() => $("copyStatus").textContent = "📋 Copied!")
  .catch(() => $("copyStatus").textContent = "Copy failed.");
}

/** === REWARD TIERS === **/
function generateRewardTable() {
  const table = $("rewardTierBody");
  if (!table) return;
  table.innerHTML = "";
  rewardTiers.forEach(t => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>Tier ${t.tier}</td>
      <td>${t.likes}+</td>
      <td>${t.retweets}+</td>
      <td>${t.base.toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9).toFixed(2)} WALDO</td>
      <td>${(t.base * 1.15 * 0.95).toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9 * 40).toFixed(2)}</td>
      <td>${(t.base * 1.15 * 0.95 * 40).toFixed(2)}</td>
    `;
    table.appendChild(row);
  });
}

/** === XP CALC === **/
function calculateXPToNextLevel(xp) {
  for (let i = 0; i < levelThresholds.length; i++)
    if (xp < levelThresholds[i]) return levelThresholds[i] - xp;
  return 0;
}

/** === CHARTS === **/
function renderXPTrendChart(xpTrend) {
  const el = $("xpChart");
  if (!el || !window.Chart) return;
  const ctx = el.getContext("2d");
  if (xpChartInstance) xpChartInstance.destroy();
  xpChartInstance = new Chart(ctx, {
    type: "line",
    data: xpTrend || { labels:[], datasets:[] },
    options: { responsive: true, scales: { y: { beginAtZero:true } } }
  });
}

/** === DASHBOARD POPULATION === **/
async function fetchUserStats(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/userStats?wallet=${wallet}`);
    const stats = await res.json();
    $("walletAddress") && ($("walletAddress").textContent = `Wallet: ${wallet}`);
    $("waldoXP") && ($("waldoXP").textContent = stats.xp ?? "0");
    $("waldoLevel") && ($("waldoLevel").textContent = `Level ${stats.level ?? 1}`);
    $("waldoTitle") && ($("waldoTitle").textContent = (levelTitles[stats.level] || `Level ${stats.level}`));
    $("waldoLikes") && ($("waldoLikes").textContent = stats.likes ?? "0");
    $("waldoRetweets") && ($("waldoRetweets").textContent = stats.retweets ?? "0");
    $("waldoMemes") && ($("waldoMemes").textContent = stats.memes ?? "0");
    $("waldoBattles") && ($("waldoBattles").textContent = stats.battles ?? "0");
    $("waldoReferrals") && ($("waldoReferrals").textContent = stats.referrals?.length ?? 0);
    $("refCount") && ($("refCount").textContent = stats.referrals?.length ?? 0);
    $("referralLink") && ($("referralLink").value = `https://waldocoin.live/?ref=${wallet}`);
    // XP breakdown
    const breakdown = stats.xpBreakdown || {};
    $("xpLikes") && ($("xpLikes").textContent = `${breakdown.likes ?? 0} XP`);
    $("xpRetweets") && ($("xpRetweets").textContent = `${breakdown.retweets ?? 0} XP`);
    $("xpBattles") && ($("xpBattles").textContent = `${breakdown.battles ?? 0} XP`);
    $("xpReferrals") && ($("xpReferrals").textContent = `${breakdown.referrals ?? 0} XP`);
    $("xpVoting") && ($("xpVoting").textContent = `${breakdown.voting ?? 0} XP`);
    $("xpStakingBonus") && ($("xpStakingBonus").textContent = `${breakdown.stakingBonus ?? 0}%`);
    // Level logic
    const level = stats.level || 1, xp = stats.xp || 0;
    const xpFloor = levelThresholds[level - 1] || 0, xpCeil = levelThresholds[level] || (xpFloor + 1000);
    const xpProgress = Math.min(100, Math.floor(((xp - xpFloor) / (xpCeil - xpFloor)) * 100));
    $("userLevelIcon") && ($("userLevelIcon").src = levelImages[level] || levelImages[1]);
    $("userLevelTitle") && ($("userLevelTitle").textContent = levelTitles[level] || `Level ${level}`);
    $("levelProgress") && ($("levelProgress").value = xpProgress);
    $("xpToNextLevel") && ($("xpToNextLevel").textContent = `${calculateXPToNextLevel(xp)} XP to next level`);
    $("xpToNextLevelStats") && ($("xpToNextLevelStats").textContent = `${calculateXPToNextLevel(xp)} XP`);
    renderXPTrendChart(stats.memeXPTrend || []);
  } catch (err) {
    showToast("Error loading user stats", "error");
  }
}
async function fetchConversionRate() {
  try {
    const res = await fetch(`${baseURL}/api/conversion`);
    const data = await res.json();
    $("waldoConversion") && ($("waldoConversion").textContent = `${data.waldoToUSD} USD / ${data.waldoToXRP} XRP`);
    $("waldoEarnings") && ($("waldoEarnings").textContent = `${data.totalWaldo} WALDO = ${data.totalUSD} USD`);
  } catch (err) { showToast("Could not load rates", "error"); }
}
async function loadTopMeme() {
  try {
    const res = await fetch(`${baseURL}/api/topMeme`);
    const data = await res.json();
    $("topMemeLikes") && ($("topMemeLikes").textContent = data.likes);
    $("topMemeImage") && ($("topMemeImage").src = data.image);
    $("topMemeImg") && ($("topMemeImg").src = data.image);
    $("topMemeLink") && ($("topMemeLink").href = `https://x.com/${data.author}/status/${data.id}`);
  } catch (err) {}
}

/** === INIT EVERYTHING === **/
async function initWaldoDashboard() {
  const wallet = getWallet();
  if (!wallet) return;
  generateRewardTable();
  await fetchUserStats(wallet);
  await fetchConversionRate();
  await loadTopMeme();
  // More dashboard sections can go here (meme table, activity feed, battles, leaderboard etc)
}

/** === ON PAGE LOAD === **/
document.addEventListener("DOMContentLoaded", () => {
  const wallet = getWallet();
  if (!wallet) {
    if (window.location.pathname === statsPage) {
      window.location.replace(loginPage); return;
    }
    showWaldoNotification("🔌 No WALDO wallet connected yet. Please connect!");
    return;
  }
  $("walletAddress") && ($("walletAddress").innerText = `Wallet: ${wallet}`);
  showWaldoNotification("✅ WALDO wallet connected");
  initWaldoDashboard();
});

/** === POSTMESSAGE LOGIN SUPPORT === **/
window.addEventListener("message", (event) => {
  if (event.origin !== "https://waldocoin.live") return;
  if (event.data.wallet) {
    localStorage.setItem("xummWallet", event.data.wallet);
    window.location.replace(statsPage);
  }
});

/** === BUTTON HOOKS FOR HTML === **/
window.dismissWaldoNotification = dismissWaldoNotification;
window.logoutWallet = logoutWallet;
window.copyReferral = copyReferral;
function $(id) { return document.getElementById(id); }
function getWallet() { return localStorage.getItem("xummWallet") || null; }
function logoutWallet() { localStorage.removeItem("xummWallet"); window.location.replace(loginPage); }
function copyReferral() { const input = $("referralLink"); if (!input) return; input.select(); document.execCommand("copy"); $("copyStatus").textContent = "📋 Copied!"; }
function showWaldoNotification(msg, timeout = 5000) { const n = $("waldoNotification"), m = $("waldoMessage"); if (!n || !m) return; m.textContent = msg; n.style.display = "flex"; if (timeout) setTimeout(() => { n.style.display = "none"; }, timeout);}
function dismissWaldoNotification() { $("waldoNotification")?.style && ($("waldoNotification").style.display = "none"); }
function showToast(message, type = "info", duration = 3500) { const toast = document.createElement("div"); toast.className = "toast"; toast.textContent = message; toast.style.cssText = `position: fixed; bottom:30px; left:50%; transform:translateX(-50%);background: ${type === "error" ? "#e63e3e" : type === "success" ? "#2ecc71" : "#222"};color:white; padding:12px 20px; border-radius:8px; font-weight:600;z-index:99999; box-shadow:0 0 12px rgba(0,0,0,0.28);`;document.body.appendChild(toast); setTimeout(() => toast.remove(), duration);}
window.dismissWaldoNotification = dismissWaldoNotification;
window.logoutWallet = logoutWallet;
window.copyReferral = copyReferral;


function calculateXPToNextLevel(xp) {
  for (let i = 0; i < levelThresholds.length; i++) if (xp < levelThresholds[i]) return levelThresholds[i] - xp;
  return 0;
}
function generateRewardTable() {
  const table = $("rewardTierBody");
  if (!table) return;
  table.innerHTML = "";
  rewardTiers.forEach(t => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>Tier ${t.tier}</td>
      <td>${t.likes}+</td>
      <td>${t.retweets}+</td>
      <td>${t.base.toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9).toFixed(2)} WALDO</td>
      <td>${(t.base * 1.15 * 0.95).toFixed(2)} WALDO</td>
      <td>${(t.base * 0.9 * 40).toFixed(2)}</td>
      <td>${(t.base * 1.15 * 0.95 * 40).toFixed(2)}</td>
    `;
    table.appendChild(row);
  });
}

// Chart (XP Trends)
let xpChartInstance;
function renderXPTrendChart(xpTrend) {
  const el = $("xpChart");
  if (!el || !window.Chart) return;
  const ctx = el.getContext("2d");
  if (xpChartInstance) xpChartInstance.destroy();
  xpChartInstance = new Chart(ctx, {
    type: "line",
    data: xpTrend || { labels:[], datasets:[] },
    options: { responsive: true, scales: { y: { beginAtZero:true } } }
  });
}

// User Stats/Conversion/Top Meme
async function fetchUserStats(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/userStats?wallet=${wallet}`);
    const stats = await res.json();
    $("walletAddress") && ($("walletAddress").textContent = `Wallet: ${wallet}`);
    $("waldoXP") && ($("waldoXP").textContent = stats.xp ?? "0");
    $("waldoLevel") && ($("waldoLevel").textContent = `Level ${stats.level ?? 1}`);
    $("waldoTitle") && ($("waldoTitle").textContent = (levelTitles[stats.level] || `Level ${stats.level}`));
    $("waldoLikes") && ($("waldoLikes").textContent = stats.likes ?? "0");
    $("waldoRetweets") && ($("waldoRetweets").textContent = stats.retweets ?? "0");
    $("waldoMemes") && ($("waldoMemes").textContent = stats.memes ?? "0");
    $("waldoBattles") && ($("waldoBattles").textContent = stats.battles ?? "0");
    $("waldoReferrals") && ($("waldoReferrals").textContent = stats.referrals?.length ?? 0);
    $("refCount") && ($("refCount").textContent = stats.referrals?.length ?? 0);
    $("referralLink") && ($("referralLink").value = `https://waldocoin.live/?ref=${wallet}`);
    // XP breakdown
    const breakdown = stats.xpBreakdown || {};
    $("xpLikes") && ($("xpLikes").textContent = `${breakdown.likes ?? 0} XP`);
    $("xpRetweets") && ($("xpRetweets").textContent = `${breakdown.retweets ?? 0} XP`);
    $("xpBattles") && ($("xpBattles").textContent = `${breakdown.battles ?? 0} XP`);
    $("xpReferrals") && ($("xpReferrals").textContent = `${breakdown.referrals ?? 0} XP`);
    $("xpVoting") && ($("xpVoting").textContent = `${breakdown.voting ?? 0} XP`);
    $("xpStakingBonus") && ($("xpStakingBonus").textContent = `${breakdown.stakingBonus ?? 0}%`);
    // Level logic
    const level = stats.level || 1, xp = stats.xp || 0;
    const xpFloor = levelThresholds[level - 1] || 0, xpCeil = levelThresholds[level] || (xpFloor + 1000);
    const xpProgress = Math.min(100, Math.floor(((xp - xpFloor) / (xpCeil - xpFloor)) * 100));
    $("userLevelIcon") && ($("userLevelIcon").src = levelImages[level] || levelImages[1]);
    $("userLevelTitle") && ($("userLevelTitle").textContent = levelTitles[level] || `Level ${level}`);
    $("levelProgress") && ($("levelProgress").value = xpProgress);
    $("xpToNextLevel") && ($("xpToNextLevel").textContent = `${calculateXPToNextLevel(xp)} XP to next level`);
    $("xpToNextLevelStats") && ($("xpToNextLevelStats").textContent = `${calculateXPToNextLevel(xp)} XP`);
    renderXPTrendChart(stats.memeXPTrend || []);
  } catch (err) { showToast("Error loading user stats", "error"); }
}
async function fetchConversionRate() {
  try {
    const res = await fetch(`${baseURL}/api/conversion`);
    const data = await res.json();
    $("waldoConversion") && ($("waldoConversion").textContent = `${data.waldoToUSD} USD / ${data.waldoToXRP} XRP`);
    $("waldoEarnings") && ($("waldoEarnings").textContent = `${data.totalWaldo} WALDO = ${data.totalUSD} USD`);
  } catch (err) { showToast("Could not load rates", "error"); }
}
async function loadTopMeme() {
  try {
    const res = await fetch(`${baseURL}/api/topMeme`);
    const data = await res.json();
    $("topMemeLikes") && ($("topMemeLikes").textContent = data.likes);
    $("topMemeImage") && ($("topMemeImage").src = data.image);
    $("topMemeImg") && ($("topMemeImg").src = data.image);
    $("topMemeLink") && ($("topMemeLink").href = `https://x.com/${data.author}/status/${data.id}`);
  } catch (err) {}
}

// ========== MEME TABLE (Claim/Stake/Mint Logic, Pagination) ==========
let memes = [], memePage = 1, memesPerPage = 8;
async function loadMemes(wallet) {
  try {
    const res = await fetch(`${baseURL}/api/tweets?wallet=${wallet}`);
    const data = await res.json();
    memes = Array.isArray(data) ? data : [];
    renderMemeTable();
  } catch (err) {
    showToast("Error loading memes", "error");
    memes = [];
    renderMemeTable();
  }
}
function renderMemeTable() {
  const tbody = $("memeTableBody");
  if (!tbody) return;
  tbody.innerHTML = "";
  let pageMemes = memes.slice((memePage-1)*memesPerPage, memePage*memesPerPage);
  pageMemes.forEach(meme => {
    const row = document.createElement("tr");
    // NFT eligibility
    const canMint = (meme.xp >= 60 && !meme.minted);
    row.innerHTML = `
      <td><img src="${meme.image || 'https://waldocoin.live/wp-content/uploads/2025/04/waldo-placeholder.png'}" class="meme-thumb" style="width:64px; height:64px; border-radius:12px;${canMint ? 'border:2px solid #e63e3e;' : ''}" onclick="showNFTModal('${meme.image}')"></td>
      <td>${meme.retweets ?? 0}</td>
      <td>${meme.likes ?? 0}</td>
      <td>${meme.xp ?? 0}</td>
      <td>${meme.tier ?? 1}</td>
      <td><button class="button-style" ${meme.claimed ? 'disabled' : ''} onclick="claimMeme('${meme.id}',${meme.tier})">Claim</button></td>
      <td><button class="button-style" ${meme.staked ? 'disabled' : ''} onclick="stakeMeme('${meme.id}',${meme.tier})">Stake</button></td>
      <td><button class="button-style" ${canMint ? '' : 'disabled'} onclick="mintMeme('${meme.id}')">Mint</button></td>
    `;
    tbody.appendChild(row);
  });
  renderMemePagination();
}
function renderMemePagination() {
  const totalPages = Math.ceil(memes.length / memesPerPage);
  const pDiv = $("pagination"); if (!pDiv) return;
  pDiv.innerHTML = "";
  for(let i=1;i<=totalPages;i++) {
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i===memePage ? "active" : "";
    btn.onclick = ()=>{ memePage=i; renderMemeTable(); };
    pDiv.appendChild(btn);
  }
}
window.showNFTModal = function(img) {
  $("nftModalImg").src = img;
  $("nftModal").style.display = "block";
};
window.closeNFTModal = function() {
  $("nftModal").style.display = "none";
};

// ========== CLAIM / STAKE / MINT BUTTON LOGIC ==========
window.claimMeme = async function(memeId, tier) {
  const wallet = getWallet();
  if (!wallet) { showToast("Not logged in", "error"); return; }
  try {
    const res = await fetch(`${baseURL}/api/claim`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ wallet, tier, memeId, stake:false })
    });
    const data = await res.json();
    if (data.success) { showToast("Claim started – check XUMM wallet", "success"); await loadMemes(wallet);}
    else { showToast(data.error || "Claim failed", "error"); }
  } catch (err) { showToast("Claim failed", "error"); }
};
window.stakeMeme = async function(memeId, tier) {
  const wallet = getWallet();
  if (!wallet) { showToast("Not logged in", "error"); return; }
  try {
    const res = await fetch(`${baseURL}/api/claim`, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ wallet, tier, memeId, stake:true })
    });
    const data = await res.json();
    if (data.success) { showToast("Staking started – check XUMM wallet", "success"); await loadMemes(wallet);}
    else { showToast(data.error || "Stake failed", "error"); }
  } catch (err) { showToast("Stake failed", "error"); }
};
window.mintMeme = async function(memeId) {
  const wallet = getWallet();
  if (!wallet) { showToast("Not logged in", "error"); return; }
  try {
    // Step 1: Pay mint fee
    const feeRes = await fetch(`${baseURL}/api/mint`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({wallet, memeId})
    });
    const feeData = await feeRes.json();
    if (!feeData.success) { showToast(feeData.error||"Mint fee failed","error"); return; }
    showToast("Sign mint fee in XUMM…", "info", 4000);
    // Step 2: Poll backend for mint confirmation
    setTimeout(async()=>{
      const mintRes = await fetch(`${baseURL}/api/mint/confirm`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({wallet, memeId})
      });
      const mintData = await mintRes.json();
      if (mintData.success) { showToast("NFT Minted!", "success"); await loadMemes(wallet);}
      else { showToast(mintData.error||"Mint failed", "error"); }
    }, 5000);
  } catch (err) { showToast("Mint failed", "error"); }
};

// ========== BATTLE ARENA (Current, History, Leaderboard) ==========
async function loadCurrentBattle() {
  try {
    const res = await fetch(`${baseURL}/api/battle/current`);
    const data = await res.json();
    if (!data || !data.open) {
      $("battleStatus").textContent = "No battle running. Start one below!";
      $("battleContent").style.display = "block";
      return;
    }
    $("battleStatus").textContent = "Battle is live!";
    $("battleContent").style.display = "block";
    $("meme1Img").src = data.meme1.image;
    $("meme2Img").src = data.meme2.image;
    $("meme1Link").href = `https://x.com/${data.meme1.author}/status/${data.meme1.id}`;
    $("meme2Link").href = `https://x.com/${data.meme2.author}/status/${data.meme2.id}`;
    // Set up vote buttons
    $("meme1Img").onclick = ()=>showNFTModal(data.meme1.image);
    $("meme2Img").onclick = ()=>showNFTModal(data.meme2.image);
    $("battle-wrapper").setAttribute("data-tweetid", data.id);
    $("battle-wrapper").setAttribute("data-status", data.status);
    $("battle-wrapper").setAttribute("data-canaccept", data.canAccept ? "true" : "false");
    $("battleTimer").textContent = data.timeLeft ? `⏰ ${data.timeLeft} left` : "";
  } catch (err) {
    $("battleStatus").textContent = "Could not load battle.";
  }
}
window.voteBattle = async function(which) {
  const wallet = getWallet();
  const battleId = $("battle-wrapper").getAttribute("data-tweetid");
  if (!wallet || !battleId) { showToast("Wallet or battle missing", "error"); return; }
  try {
    const res = await fetch(`${baseURL}/api/battle/vote`, {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ wallet, battleId, vote: which })
    });
    const data = await res.json();
    if (data.success) showToast("Vote submitted!", "success");
    else showToast(data.error || "Vote failed", "error");
  } catch (err) { showToast("Vote failed", "error"); }
};
// Start/accept battle UI
$("start-battle-btn")?.addEventListener("click", async () => {
  const input = $("memeTweetId");
  let tweetId = input.value.match(/status\/(\d{10,25})/)?.[1] || input.value.match(/(\d{10,25})/)?.[1];
  if (!tweetId) { showToast("Paste valid tweet link.", "error"); return; }
  $("battle-wrapper").setAttribute("data-tweetid", tweetId);
  // start battle
  const wallet = getWallet();
  try {
    const res = await fetch(`${baseURL}/api/battle/start`, {
      method:"POST",headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ wallet, tweetId })
    });
    const data = await res.json();
    if (data.success) showToast("Battle started!", "success");
    else showToast(data.error || "Could not start battle", "error");
  } catch (err) { showToast("Error starting battle", "error"); }
});
$("accept-battle-btn")?.addEventListener("click", async () => {
  const tweetId = $("battle-wrapper")?.getAttribute("data-tweetid");
  const wallet = getWallet();
  if (!wallet || !tweetId) { showToast("No battle selected.", "error"); return;}
  try {
    const res = await fetch(`${baseURL}/api/battle/accept`, {
      method:"POST",headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ wallet, tweetId })
    });
    const data = await res.json();
    if (data.success) showToast("Battle accepted!", "success");
    else showToast(data.error || "Could not accept", "error");
  } catch (err) { showToast("Error accepting battle", "error"); }
});

// Load battle history
async function loadBattleHistory() {
  try {
    const res = await fetch(`${baseURL}/api/battle/history`);
    const data = await res.json();
    const tbody = $("battleHistoryTable");
    if (!tbody) return;
    tbody.innerHTML = "";
    data.forEach((b,i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${b.id}</td>
        <td>${b.meme1?.id || ""}</td>
        <td>${b.meme2?.id || ""}</td>
        <td>${b.votes ?? 0}</td>
        <td>${b.winner ?? ""}</td>
        <td>${b.ended ? "Yes" : "No"}</td>`;
      tbody.appendChild(row);
    });
    $("battleHistoryTableContainer").style.display = "block";
  } catch (err) {}
}
async function loadBattleLeaderboard() {
  try {
    const res = await fetch(`${baseURL}/api/battle/leaderboard`);
    const data = await res.json();
    const tbody = $("battleLeaderboardTable");
    if (!tbody) return;
    tbody.innerHTML = "";
    data.forEach((b, i) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${i+1}</td>
        <td>${b.memeId || ""}</td>
        <td>${b.wins ?? 0}</td>
        <td><a href="https://x.com/${b.author}/status/${b.memeId}" target="_blank">Link</a></td>
      `;
      tbody.appendChild(row);
    });
    $("battleLeaderboardContainer").style.display = "block";
  } catch (err) {}
}

// ========== INITIALIZATION ==========
async function initWaldoDashboard() {
  const wallet = getWallet();
  if (!wallet) return;
  generateRewardTable();
  await fetchUserStats(wallet);
  await fetchConversionRate();
  await loadTopMeme();
  await loadMemes(wallet);
  await loadCurrentBattle();
  await loadBattleHistory();
  await loadBattleLeaderboard();
}

document.addEventListener("DOMContentLoaded", () => {
  const wallet = getWallet();
  if (!wallet) {
    if (window.location.pathname === statsPage) {
      window.location.replace(loginPage); return;
    }
    showWaldoNotification("🔌 No WALDO wallet connected yet. Please connect!");
    return;
  }
  $("walletAddress") && ($("walletAddress").innerText = `Wallet: ${wallet}`);
  showWaldoNotification("✅ WALDO wallet connected");
  initWaldoDashboard();
});
window.addEventListener("message", (event) => {
  if (event.origin !== "https://waldocoin.live") return;
  if (event.data.wallet) {
    localStorage.setItem("xummWallet", event.data.wallet);
    window.location.replace(statsPage);
  }
});
</script>
</body>
</html>