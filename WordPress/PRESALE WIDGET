<!-- WALDOCOIN Presale Widget with Progressive Flow - Mobile Optimized -->
<div id="waldocoin-presale-widget"
  style="background: linear-gradient(135deg, #0d2818 0%, #1a4d2e 100%); padding: 15px; border-radius: 15px; border: 2px solid #25c2a0; box-shadow: 0 10px 30px rgba(37, 194, 160, 0.3); max-width: 95vw; width: 100%; max-width: 450px; margin: 10px auto; box-sizing: border-box;">

  <!-- Header -->
  <div style="text-align: center; margin-bottom: 30px;">
    <h1 style="color: #25c2a0; font-size: 28px; margin: 0; font-family: 'Arial Black', sans-serif;">
      üöÄ WALDOCOIN PRESALE
    </h1>
    <p style="color: white; font-size: 16px; margin: 10px 0 0 0;">
      Secure your WALDO tokens with XRP
    </p>
  </div>

  <!-- Comprehensive Mobile-First CSS -->
  <style>
    /* Base responsive styles */
    #waldocoin-presale-widget {
      box-sizing: border-box;
      width: 100%;
      max-width: 450px;
      margin: 10px auto;
    }

    #waldocoin-presale-widget * {
      box-sizing: border-box;
    }

    /* Mobile-first approach */
    @media (max-width: 768px) {
      #waldocoin-presale-widget {
        padding: 12px !important;
        margin: 8px auto !important;
        border-radius: 12px !important;
        max-width: calc(100vw - 16px) !important;
        min-height: auto !important;
      }

      #waldocoin-presale-widget h1 {
        font-size: 24px !important;
        margin: 12px 0 !important;
        line-height: 1.2 !important;
        text-align: center !important;
      }

      #waldocoin-presale-widget h3 {
        font-size: 18px !important;
        margin: 15px 0 10px 0 !important;
        line-height: 1.3 !important;
      }

      #waldocoin-presale-widget p {
        font-size: 14px !important;
        line-height: 1.5 !important;
        margin: 10px 0 !important;
        text-align: center !important;
      }

      /* Button optimizations */
      #waldocoin-presale-widget button {
        width: 100% !important;
        padding: 14px 12px !important;
        font-size: 16px !important;
        margin: 8px 0 !important;
        box-sizing: border-box !important;
        min-height: 48px !important;
        border-radius: 8px !important;
        font-weight: bold !important;
        cursor: pointer !important;
        touch-action: manipulation !important;
      }

      /* Input optimizations */
      #waldocoin-presale-widget input {
        width: 100% !important;
        font-size: 16px !important;
        padding: 14px 12px !important;
        box-sizing: border-box !important;
        min-height: 48px !important;
        border-radius: 8px !important;
        border: 2px solid #25c2a0 !important;
        background: #333 !important;
        color: white !important;
      }

      /* Amount button grid */
      .amount-buttons {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
        margin: 12px 0 !important;
      }

      .amount-btn {
        min-height: 48px !important;
        font-size: 14px !important;
        padding: 12px 8px !important;
        border-radius: 8px !important;
        font-weight: bold !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }

      /* QR Code responsive */
      #xummQR {
        max-width: 100% !important;
        height: auto !important;
        margin: 10px auto !important;
        display: block !important;
      }

      /* Step indicators */
      .step-indicator {
        font-size: 14px !important;
        margin: 8px 0 !important;
        padding: 8px !important;
      }

      /* Progress indicators */
      .progress-text {
        font-size: 13px !important;
        line-height: 1.4 !important;
        margin: 5px 0 !important;
      }
    }

    @media (max-width: 480px) {
      #waldocoin-presale-widget {
        padding: 10px !important;
        margin: 5px auto !important;
        max-width: calc(100vw - 10px) !important;
      }

      #waldocoin-presale-widget h1 {
        font-size: 22px !important;
        margin: 10px 0 !important;
      }

      #waldocoin-presale-widget h3 {
        font-size: 16px !important;
        margin: 12px 0 8px 0 !important;
      }

      #waldocoin-presale-widget p {
        font-size: 13px !important;
        margin: 8px 0 !important;
      }

      .amount-buttons {
        grid-template-columns: 1fr !important;
        gap: 6px !important;
      }

      .amount-btn {
        font-size: 13px !important;
        padding: 10px 6px !important;
      }
    }

    @media (max-width: 360px) {
      #waldocoin-presale-widget {
        padding: 8px !important;
        margin: 3px auto !important;
        max-width: calc(100vw - 6px) !important;
      }

      #waldocoin-presale-widget h1 {
        font-size: 20px !important;
        margin: 8px 0 !important;
      }

      #waldocoin-presale-widget h3 {
        font-size: 15px !important;
      }

      #waldocoin-presale-widget p {
        font-size: 12px !important;
      }

      #waldocoin-presale-widget button {
        padding: 12px 8px !important;
        font-size: 14px !important;
      }

      #waldocoin-presale-widget input {
        padding: 12px 8px !important;
        font-size: 16px !important;
      }
    }

    /* Touch-friendly improvements */
    @media (hover: none) and (pointer: coarse) {
      #waldocoin-presale-widget button:hover {
        transform: none !important;
      }

      #waldocoin-presale-widget button:active {
        transform: scale(0.98) !important;
        transition: transform 0.1s !important;
      }
    }
  </style>

  <!-- Layout Wrapper - Mobile First -->
  <div style="max-width: 100%; margin: 0 auto; padding: 0 5px;">

    <!-- Progressive Steps -->
    <div style="color: white; font-family: 'Arial Black', sans-serif;">

      <!-- Step 1: Wallet Connection -->
      <div id="step1-connect" style="text-align:center; margin-bottom: 20px;">
        <h3 style="color: #25c2a0; margin-bottom: 15px;">Step 1: Connect Wallet</h3>
        <div id="qrContainer"
          style="min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <img id="xummQR" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
            style="width:90px; height:90px; border-radius:10px; border:2px solid #25c2a0; background:#0a1f0f; display: none;">
          <div id="qrPlaceholder"
            style="width:90px; height:90px; border-radius:10px; border:2px solid #25c2a0; background:#0a1f0f; display: flex; align-items: center; justify-content: center; color: #25c2a0; font-size: 10px; font-weight: bold;">
            Loading...
          </div>
        </div>
        <div style="color: white; font-size: 12px; font-weight: bold; margin-top: 8px;">Scan with XAMAN</div>
        <a id="xummDeepLink" href="#"
          style="color: #25c2a0; font-size: 12px; margin-top: 6px; display: none; font-weight: bold; text-decoration: underline;">üì≤
          Tap here for XAMAN App</a>
        <button onclick="connectXummWallet()"
          style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">üîÑ
          Refresh QR</button>
      </div>

      <!-- Step 2: Trustline Setup (hidden by default) -->
      <div id="step2-trustline" style="text-align:center; margin-bottom: 20px; display: none;">
        <h3 style="color: #ffd93d; margin-bottom: 15px;">Step 2: Add WALDO Trustline</h3>
        <div
          style="background: #0f2d17; padding: 20px; border-radius: 15px; border: 2px solid #ffd93d; margin-bottom: 20px;">
          <p style="color: white; font-size: 16px; margin: 0 0 15px 0; font-weight: bold;">
            ‚ö†Ô∏è Your wallet needs a WALDO trustline to receive tokens.
          </p>
          <p style="color: #ffd93d; font-size: 14px; margin: 0;">
            Tap the button below to add it automatically!
          </p>
        </div>

        <!-- Trustline QR Code -->
        <div id="trustlineQRContainer" style="margin-bottom: 20px; text-align: center;">
          <div style="display: inline-block; position: relative;">
            <img id="trustlineQR" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
              style="width:120px; height:120px; border-radius:15px; border:3px solid #ffd93d; background:#0a1f0f; display: none;">
            <div id="trustlineQRPlaceholder"
              style="width:120px; height:120px; border-radius:15px; border:3px solid #ffd93d; background:#0a1f0f; display: flex; align-items: center; justify-content: center; color: #ffd93d; font-size: 12px; font-weight: bold;">
              Loading QR...
            </div>
          </div>
        </div>

        <!-- Mobile-First: Primary Trustline Button -->
        <a id="trustlineDeepLink" href="#" onclick="addTrustlineAndWait()"
          style="background: #ffd93d; color: black; padding: 18px 30px; border-radius: 15px; text-decoration: none; font-weight: bold; display: inline-block; font-size: 16px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(255, 217, 61, 0.3);">
          üì≤ Add WALDO Trustline in XAMAN
        </a>

        <div style="color: #ffd93d; font-size: 12px; margin-bottom: 15px;">
          ‚¨ÜÔ∏è <strong>Mobile users:</strong> Tap the button above
        </div>

        <div style="color: white; font-size: 12px; margin-bottom: 10px;">
          üíª <strong>Desktop users:</strong> Scan QR code below
        </div>

        <div id="trustline-status" style="color: #25c2a0; font-size: 14px; margin-top: 15px; display: none;">
          ‚è≥ Waiting for trustline to be added...
        </div>

        <!-- Manual Check Button (backup) -->
        <button id="manualCheckBtn" onclick="recheckTrustline()"
          style="background: #25c2a0; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; margin-top: 15px; cursor: pointer; display: none;">
          ‚úÖ I've Added the Trustline - Check Now
        </button>

        <!-- Skip Button (API bypass) -->
        <button id="skipTrustlineBtn" onclick="skipTrustlineCheck()"
          style="background: #ffd93d; color: black; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; margin-top: 10px; cursor: pointer; display: none;">
          üöÄ Skip Check - Go to Purchase (API Issues)
        </button>
      </div>

      <!-- Step 3: Purchase Info (shown after wallet connected and trustline verified) -->
      <div id="step3-info" style="margin-top: 20px; text-align: center; display: none;">
        <h3 style="color: #ffea00; font-size: 22px;">Step 3: Purchase WALDO</h3>
        <p style="font-size: 15px;">Buy in <strong>5 XRP increments only</strong><br>üî• Bonus WALDO at 80 XRP and above!
        </p>

        <!-- Presale Progress -->
        <div id="presaleProgress"
          style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #1a4d2e; border-radius: 8px;">
          <div style="color: #25c2a0; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Presale Progress</div>
          <div id="progressText" style="color: white; font-size: 11px;">Loading...</div>
        </div>

        <!-- Wallet Status -->
        <div style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #25c2a0; border-radius: 8px;">
          <div style="color: #25c2a0; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Wallet Status</div>
          <div style="color: white; font-size: 11px;">
            <strong>Connected:</strong> <span id="connectedWallet">Not connected</span><br>
            <strong>Status:</strong> <span id="connectionStatus">Generating connection QR...</span>
          </div>
          <button id="disconnectBtn" onclick="disconnectWallet()"
            style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer; display: none;">
            üîå Disconnect
          </button>
        </div>

        <!-- Trustline Status -->
        <div id="trustlineStatus"
          style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #ffd93d; border-radius: 8px; display: none;">
          <div style="color: #ffd93d; font-size: 12px; font-weight: bold; margin-bottom: 5px;">WALDO Trustline</div>
          <div id="trustlineText" style="color: white; font-size: 11px;">Checking...</div>
        </div>
      </div>
    </div>

    <!-- Purchase Interface - Mobile Optimized -->
    <div id="purchase-interface" style="width: 100%; display: none; margin-top: 20px;">

      <!-- Purchase Calculator -->
      <div
        style="background: #0f2d17; padding: 20px; border-radius: 15px; border: 2px solid #25c2a0; margin-bottom: 20px;">
        <h3 style="color: #25c2a0; margin-top: 0; text-align: center;">Purchase Calculator</h3>

        <!-- Digital LED Display -->
        <div
          style="background: #000; padding: 20px; border-radius: 10px; border: 2px solid #333; margin-bottom: 20px; text-align: center;">
          <div style="color: #666; font-size: 12px; margin-bottom: 5px; font-family: 'Courier New', monospace;">WALDO
            AMOUNT</div>
          <div id="calculatorDisplay"
            style="color: #ff0000; font-size: 32px; font-family: 'Courier New', monospace; font-weight: bold; text-shadow: 0 0 10px #ff0000; letter-spacing: 2px; min-height: 40px; display: flex; align-items: center; justify-content: center;">
            0
          </div>
          <div style="color: #666; font-size: 10px; margin-top: 5px; font-family: 'Courier New', monospace;">SELECT XRP
            AMOUNT BELOW</div>
        </div>

        <!-- Amount Selection - Mobile Optimized -->
        <div style="margin-bottom: 20px;">
          <label
            style="color: white; font-weight: bold; display: block; margin-bottom: 15px; text-align: center; font-size: 16px;">Select
            XRP Amount:</label>
          <div class="amount-buttons"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px;">
            <button onclick="selectAmount(5)" class="amount-btn" data-amount="5"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              5 XRP
            </button>
            <button onclick="selectAmount(10)" class="amount-btn" data-amount="10"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              10 XRP
            </button>
            <button onclick="selectAmount(15)" class="amount-btn" data-amount="15"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              15 XRP
            </button>
            <button onclick="selectAmount(20)" class="amount-btn" data-amount="20"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              20 XRP
            </button>
            <button onclick="selectAmount(25)" class="amount-btn" data-amount="25"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              25 XRP
            </button>
            <button onclick="selectAmount(30)" class="amount-btn" data-amount="30"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              30 XRP
            </button>
            <button onclick="selectAmount(35)" class="amount-btn" data-amount="35"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              35 XRP
            </button>
            <button onclick="selectAmount(40)" class="amount-btn" data-amount="40"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 14px 8px; border-radius: 10px; cursor: pointer; font-weight: bold; min-height: 50px; font-size: 14px; transition: all 0.2s; touch-action: manipulation;">
              40 XRP
            </button>
            <button onclick="selectAmount(45)" class="amount-btn" data-amount="45"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              45 XRP
            </button>
            <button onclick="selectAmount(50)" class="amount-btn" data-amount="50"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              50 XRP
            </button>
            <button onclick="selectAmount(55)" class="amount-btn" data-amount="55"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              55 XRP
            </button>
            <button onclick="selectAmount(60)" class="amount-btn" data-amount="60"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              60 XRP
            </button>
            <button onclick="selectAmount(65)" class="amount-btn" data-amount="65"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              65 XRP
            </button>
            <button onclick="selectAmount(70)" class="amount-btn" data-amount="70"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              70 XRP
            </button>
            <button onclick="selectAmount(75)" class="amount-btn" data-amount="75"
              style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              75 XRP
            </button>
            <button onclick="selectAmount(80)" class="amount-btn" data-amount="80"
              style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              80 XRP üéÅ
            </button>
            <button onclick="selectAmount(85)" class="amount-btn" data-amount="85"
              style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              85 XRP üéÅ
            </button>
            <button onclick="selectAmount(90)" class="amount-btn" data-amount="90"
              style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              90 XRP üéÅ
            </button>
            <button onclick="selectAmount(95)" class="amount-btn" data-amount="95"
              style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              95 XRP üéÅ
            </button>
            <button onclick="selectAmount(100)" class="amount-btn" data-amount="100"
              style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
              100 XRP üéÅ
            </button>
          </div>
        </div>

        <!-- Purchase Summary -->
        <div id="purchaseSummary"
          style="background: #0a1f0f; padding: 15px; border-radius: 10px; border: 1px solid #25c2a0; margin-bottom: 20px; display: none;">
          <h4 style="color: #25c2a0; margin-top: 0;">Purchase Summary</h4>
          <div style="color: white; font-size: 14px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>XRP Amount:</span>
              <span id="summaryXRP">0</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span>Base WALDO:</span>
              <span id="summaryBaseWaldo">0</span>
            </div>
            <div id="bonusRow"
              style="display: flex; justify-content: space-between; margin-bottom: 5px; color: #ffd93d; display: none;">
              <span>Bonus WALDO:</span>
              <span id="summaryBonus">0</span>
            </div>
            <hr style="border: 1px solid #25c2a0; margin: 10px 0;">
            <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 16px;">
              <span>Total WALDO:</span>
              <span id="summaryTotal" style="color: #25c2a0;">0</span>
            </div>
          </div>
        </div>

        <!-- Purchase Button - Mobile Optimized -->
        <button id="purchaseBtn" onclick="purchaseWaldo()" disabled
          style="width: 100%; background: #25c2a0; color: white; border: none; padding: 18px 15px; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; opacity: 0.5; min-height: 60px; box-sizing: border-box; touch-action: manipulation; transition: all 0.2s ease;">
          üîê Select Amount to Purchase
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedAmount = 0;
  let connectedWallet = null;
  let hasTrustline = false;

  // Progressive flow management - Mobile optimized
  function showStep(stepNumber) {
    console.log(`üì± SHOWING STEP ${stepNumber}`);
    console.trace('Step change called from:'); // This will show the call stack

    // Hide all steps
    document.getElementById('step1-connect').style.display = 'none';
    document.getElementById('step2-trustline').style.display = 'none';
    document.getElementById('step3-info').style.display = 'none';
    document.getElementById('purchase-interface').style.display = 'none';

    // Show requested step
    if (stepNumber === 1) {
      console.log('‚úÖ Displaying Step 1: Connect Wallet');
      document.getElementById('step1-connect').style.display = 'block';
    } else if (stepNumber === 2) {
      console.log('‚úÖ Displaying Step 2: Add Trustline');
      document.getElementById('step2-trustline').style.display = 'block';
    } else if (stepNumber === 3) {
      console.log('‚úÖ Displaying Step 3: Purchase Interface');
      console.log('‚ö†Ô∏è WARNING: Make sure wallet has trustline before showing Step 3!');
      console.log('Current hasTrustline value:', hasTrustline);
      document.getElementById('step3-info').style.display = 'block';
      document.getElementById('purchase-interface').style.display = 'block';
    }
  }

  // Check if mobile device
  function isMobile() {
    return /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
  }

  // Initialize widget - start with step 1
  function initializePresaleWidget() {
    showStep(1);
    connectXummWallet();
  }

  // Step 1: Connect wallet function
  async function connectXummWallet(retryCount = 0) {
    try {
      console.log(`üîó Connecting XUMM wallet... (attempt ${retryCount + 1})`);

      // Show loading state
      document.getElementById('qrPlaceholder').innerText = retryCount === 0 ? 'Loading QR...' : `Retrying... (${retryCount + 1}/3)`;
      document.getElementById('qrPlaceholder').style.display = 'flex';
      document.getElementById('qrPlaceholder').style.color = '#25c2a0';
      document.getElementById('xummQR').style.display = 'none';

      // Create abort controller for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout

      // NO return URL - this prevents automatic redirects and keeps users in XUMM
      const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/login`, {
        method: 'GET',
        signal: controller.signal
      });

      clearTimeout(timeoutId);
      console.log('üì° Login API response status:', response.status);

      if (!response.ok) {
        throw new Error(`API returned ${response.status}`);
      }

      const data = await response.json();
      console.log('üì° Login API data:', data);

      if (data.qr && data.uuid) {
        console.log('‚úÖ QR code received, displaying...');

        // Store UUID for potential resume after XUMM return
        sessionStorage.setItem('presale_login_uuid', data.uuid);

        document.getElementById('xummQR').src = data.qr;
        document.getElementById('xummQR').style.display = 'block';
        document.getElementById('qrPlaceholder').style.display = 'none';

        // Set up mobile deep link using the UUID
        const mobileDeepLink = `https://xumm.app/sign/${data.uuid}`;
        document.getElementById('xummDeepLink').href = mobileDeepLink;
        document.getElementById('xummDeepLink').style.display = 'block';

        // Add click handler for mobile deep link
        document.getElementById('xummDeepLink').onclick = function(e) {
          e.preventDefault();
          console.log('üì± Opening XUMM app for mobile user...');

          if (isMobile()) {
            // On mobile, use window.location to open XUMM app
            window.location.href = mobileDeepLink;
          } else {
            // On desktop, open in new tab
            window.open(mobileDeepLink, '_blank');
          }

          return false;
        };

        // Poll for connection
        pollForConnection(data.uuid);
      } else {
        console.error('‚ùå Invalid response - missing qr or uuid:', data);
        throw new Error('Invalid API response - missing required fields');
      }
    } catch (error) {
      console.error('‚ùå Connection error:', error);

      // Retry up to 3 times
      if (retryCount < 2) {
        console.log(`üîÑ Retrying in 2 seconds... (${retryCount + 1}/3)`);
        document.getElementById('qrPlaceholder').innerText = 'Retrying in 2s...';
        document.getElementById('qrPlaceholder').style.color = '#ffd93d';

        setTimeout(() => {
          connectXummWallet(retryCount + 1);
        }, 2000);
      } else {
        console.error('‚ùå All retry attempts failed');
        document.getElementById('qrPlaceholder').innerHTML =
          'Connection failed<br><button onclick="connectXummWallet()" style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">üîÑ Try Again</button>';
        document.getElementById('qrPlaceholder').style.color = '#e74c3c';
      }
    }
  }

  // Poll for wallet connection with better feedback
  function pollForConnection(uuid) {
    console.log('üîÑ Starting to poll for connection with UUID:', uuid);
    let pollCount = 0;
    const maxPolls = 180; // 3 minutes with 1-second intervals

    // Store polling state
    window.currentPollingUuid = uuid;

    const pollInterval = setInterval(async () => {
      try {
        const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/login/status?uuid=${uuid}`);
        const data = await response.json();

        console.log(`üì° Login status response (poll ${pollCount + 1}):`, data);

        // Update feedback based on polling progress
        const placeholder = document.getElementById('qrPlaceholder');
        if (pollCount < 5) {
          placeholder.innerText = 'üîç Waiting for wallet response...';
        } else if (pollCount < 15) {
          placeholder.innerText = '‚è≥ Please check your XAMAN app...';
        } else if (pollCount < 30) {
          placeholder.innerText = 'üîÑ Still waiting for signature...';
        } else if (pollCount < 60) {
          placeholder.innerText = '‚è∞ Taking longer than usual...';
        } else {
          placeholder.innerText = 'üïê Please try refreshing if needed...';
        }

        if (data.signed && (data.account || data.response?.signer)) {
          clearInterval(pollInterval);
          window.currentPollingUuid = null; // Clear polling state

          // Get wallet address from any available property
          connectedWallet = data.account || data.response?.signer;

          // Store wallet connection in session storage
          sessionStorage.setItem('connected_wallet', connectedWallet);
          sessionStorage.removeItem('presale_login_uuid'); // Clear old UUID

          console.log('‚úÖ Wallet connected successfully:', connectedWallet);

          // Update UI immediately
          document.getElementById('connectedWallet').innerText = connectedWallet;
          document.getElementById('connectedWallet').style.color = '#25c2a0';
          document.getElementById('connectionStatus').innerText = 'Connected successfully!';
          document.getElementById('connectionStatus').style.color = '#25c2a0';
          document.getElementById('disconnectBtn').style.display = 'inline-block';

          // Hide QR code and show success
          document.getElementById('xummQR').style.display = 'none';
          document.getElementById('qrPlaceholder').innerText = '‚úÖ Wallet Connected!';
          document.getElementById('qrPlaceholder').style.display = 'block';
          document.getElementById('qrPlaceholder').style.color = '#25c2a0';

          // Move to step 2: Check trustline
          setTimeout(() => {
            checkTrustlineAndProceed();
          }, 1000);

        } else if (data.expired) {
          clearInterval(pollInterval);
          window.currentPollingUuid = null;
          console.log('‚ùå Login payload expired');
          document.getElementById('qrPlaceholder').innerText = 'QR Code Expired - Click to retry';
          document.getElementById('qrPlaceholder').style.color = '#e74c3c';
          document.getElementById('qrPlaceholder').onclick = () => connectXummWallet();
        }
      } catch (error) {
        console.error('‚ùå Polling error:', error);
      }

      pollCount++;
      if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
        window.currentPollingUuid = null;
        console.log('‚è∞ Polling timeout reached');
        document.getElementById('qrPlaceholder').innerText = 'Connection timeout - Click to retry';
        document.getElementById('qrPlaceholder').style.color = '#e74c3c';
        document.getElementById('qrPlaceholder').onclick = () => connectXummWallet();
      }
    }, 1000); // Faster polling - every 1 second
  }

  // Direct XRPL trustline check (same as airdrop system)
  async function checkTrustlineDirectXRPL(wallet) {
    console.log('üîç Direct XRPL trustline check for:', wallet);

    // Multiple XRPL servers for reliability (same as airdrop)
    const servers = [
      'https://xrplcluster.com',
      'https://s1.ripple.com:51234',
      'https://s2.ripple.com:51234'
    ];

    for (const server of servers) {
      try {
        console.log(`üîó Trying XRPL server: ${server}`);

        const response = await fetch(server, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: 'account_lines',
            params: [{
              account: wallet,
              ledger_index: 'validated'
            }]
          })
        });

        if (!response.ok) {
          console.log(`‚ùå ${server} returned status:`, response.status);
          continue;
        }

        const data = await response.json();
        console.log(`üì° XRPL response from ${server}:`, data);

        if (data.result && data.result.lines) {
          const waldoTrustline = data.result.lines.find(line =>
            line.account === 'rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY' &&
            (line.currency === 'WLO' || line.currency === 'WALDO')
          );

          if (waldoTrustline) {
            console.log('‚úÖ WALDO trustline found via direct XRPL!');
            return true;
          } else {
            console.log('‚ùå No WALDO trustline found via direct XRPL');
            return false;
          }
        }

      } catch (error) {
        console.log(`‚ùå Failed to query ${server}:`, error.message);
        continue;
      }
    }

    // All servers failed
    throw new Error('All XRPL servers failed');
  }

  // Step 2: Check trustline and proceed accordingly
  async function checkTrustlineAndProceed() {
    try {
      console.log('üîç Checking trustline for wallet:', connectedWallet);

      if (!connectedWallet) {
        console.error('‚ùå No connected wallet found');
        showStep(1);
        return;
      }

      // User is already signed in via XUMM authentication
      console.log('‚úÖ User signed in via XUMM with wallet:', connectedWallet);
      document.getElementById('connectionStatus').innerText = 'Signed in successfully!';
      document.getElementById('connectionStatus').style.color = '#25c2a0';

      // Now check WALDO trustline
      console.log('üîó Checking WALDO trustline...');
      document.getElementById('connectionStatus').innerText = 'Checking trustline...';
      document.getElementById('connectionStatus').style.color = '#ffd93d';

      // Use direct XRPL check (same as airdrop system)
      const hasWaldoTrustline = await checkTrustlineDirectXRPL(connectedWallet);

      if (hasWaldoTrustline) {
        console.log('‚úÖ Wallet HAS WALDO trustline - user fully signed in and ready');
        hasTrustline = true;

        // Update status to show ready state
        document.getElementById('connectionStatus').innerText = 'Ready to purchase!';
        document.getElementById('connectionStatus').style.color = '#25c2a0';

        showStep(3);
        loadPresaleProgress();
      } else {
        console.log('‚ö†Ô∏è Wallet DOES NOT have WALDO trustline - showing trustline setup');
        hasTrustline = false;

        // Update status to show trustline needed
        document.getElementById('connectionStatus').innerText = 'Signed in - Trustline required';
        document.getElementById('connectionStatus').style.color = '#ffd93d';

        showStep(2);
        setupTrustlineStep();
      }
    } catch (error) {
      console.error('‚ùå Trustline check error:', error);
      // If error, assume NO trustline and show step 2
      console.log('‚ö†Ô∏è Error checking trustline, assuming NO trustline - showing Step 2');
      hasTrustline = false;
      showStep(2);
      setupTrustlineStep();
    }
  }

  // Setup trustline step - Load QR code and set up deep link
  function setupTrustlineStep() {
    console.log('üîß Setting up trustline step...');
    console.log('üë§ User is signed in with wallet:', connectedWallet);
    console.log('üîó Now showing trustline setup for WALDO token');

    // Load the trustline QR code
    loadTrustlineQR();

    // Set up the deep link for mobile users (fallback if onclick doesn't work)
    const trustlineUrl = 'https://xumm.app/detect/xumm:trustline?issuer=rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY&currency=WLO';
    document.getElementById('trustlineDeepLink').href = trustlineUrl;

    // Show clear status that user is signed in but needs trustline
    console.log('‚úÖ User signed in successfully - trustline setup required to continue');
  }

  // New function: Add trustline and automatically wait for completion
  function addTrustlineAndWait() {
    console.log('üì≤ Opening XAMAN to add trustline...');

    // Show waiting status
    document.getElementById('trustline-status').style.display = 'block';
    document.getElementById('trustline-status').innerText = '‚è≥ Opening XAMAN... Please add the trustline';
    document.getElementById('trustline-status').style.color = '#ffd93d';

    // For mobile users, we need to actually navigate to the trustline URL
    // This will open XAMAN app if installed, or XUMM website if not
    const trustlineUrl = 'https://xumm.app/detect/xumm:trustline?issuer=rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY&currency=WLO';

    // Open the trustline URL
    window.open(trustlineUrl, '_blank');

    // Start automatic polling for trustline after a short delay
    setTimeout(() => {
      document.getElementById('trustline-status').innerText = '‚è≥ Add the trustline in XAMAN, then return here...';
      startTrustlinePolling();
    }, 3000); // Give user 3 seconds to open XAMAN
  }

  // Automatic trustline polling
  function startTrustlinePolling() {
    console.log('üîÑ Starting automatic trustline polling...');
    console.log('Connected wallet:', connectedWallet);

    if (!connectedWallet) {
      console.error('‚ùå No connected wallet for trustline polling');
      return;
    }

    // Don't start polling if we're already on Step 3
    if (document.getElementById('step3-info').style.display === 'block') {
      console.log('‚ö†Ô∏è Already on Step 3, skipping trustline polling');
      return;
    }

    document.getElementById('trustline-status').style.display = 'block';
    document.getElementById('trustline-status').innerText = '‚è≥ Checking for trustline...';
    document.getElementById('trustline-status').style.color = '#25c2a0';

    let pollCount = 0;
    const maxPolls = 120; // Poll for 10 minutes (5 second intervals)

    const pollInterval = setInterval(async () => {
      // Stop polling if user is already on Step 3
      if (document.getElementById('step3-info').style.display === 'block') {
        console.log('‚ö†Ô∏è User already on Step 3, stopping trustline polling');
        clearInterval(pollInterval);
        return;
      }

      pollCount++;
      console.log(`üîç Trustline poll attempt ${pollCount}/${maxPolls} for wallet: ${connectedWallet}`);

      try {
        // Use direct XRPL check instead of API
        const hasWaldoTrustline = await checkTrustlineDirectXRPL(connectedWallet);
        console.log(`üì° Trustline poll ${pollCount} result:`, hasWaldoTrustline);

        // Check explicitly for true value
        if (hasWaldoTrustline === true) {
          clearInterval(pollInterval);
          console.log('üéâ TRUSTLINE DETECTED AUTOMATICALLY!');
          console.log('Setting hasTrustline = true and proceeding to Step 3');

          document.getElementById('trustline-status').innerText = '‚úÖ Trustline added successfully!';
          document.getElementById('trustline-status').style.color = '#25c2a0';

          // Set the global variable
          hasTrustline = true;

          // Auto-proceed to Step 3 after 1 second
          setTimeout(() => {
            console.log('üöÄ Auto-proceeding to Step 3...');
            console.log('Current hasTrustline value:', hasTrustline);
            showStep(3);
            loadPresaleProgress();
          }, 1000);

          return;
        } else {
          console.log(`‚ùå Trustline not found yet. hasWaldoTrustline = ${data.hasWaldoTrustline}`);
        }

        // Update status with poll count
        document.getElementById('trustline-status').innerText = `‚è≥ Checking... (${pollCount}/${maxPolls})`;

      } catch (error) {
        console.error(`‚ùå Trustline polling error (attempt ${pollCount}):`, error);
        document.getElementById('trustline-status').innerText = `‚ö†Ô∏è Check failed (${pollCount}/${maxPolls}) - ${error.message}`;

        // Show manual button after 3 failed attempts
        if (pollCount >= 3) {
          document.getElementById('manualCheckBtn').style.display = 'inline-block';
        }

        // Show skip button after 5 failed attempts (API issues)
        if (pollCount >= 5) {
          document.getElementById('skipTrustlineBtn').style.display = 'inline-block';
        }
      }

      // Stop polling after max attempts
      if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
        console.log('‚ùå Trustline polling timeout after 10 minutes');
        document.getElementById('trustline-status').innerText = '‚ùå Auto-detection failed - Use button below';
        document.getElementById('trustline-status').style.color = '#e74c3c';
        document.getElementById('manualCheckBtn').style.display = 'inline-block';
      }

    }, 5000); // Poll every 5 seconds
  }

  // Load trustline QR code
  async function loadTrustlineQR() {
    try {
      console.log('üîó Loading trustline QR code...');

      // Show loading state
      document.getElementById('trustlineQRPlaceholder').style.display = 'flex';
      document.getElementById('trustlineQR').style.display = 'none';

      const response = await fetch('https://waldocoin-backend-api.onrender.com/api/login/trustline');

      if (!response.ok) {
        throw new Error(`Trustline API returned ${response.status}`);
      }

      const data = await response.json();
      console.log('üì° Trustline API response:', data);

      if (data.qr && data.uuid) {
        console.log('‚úÖ Trustline QR code received, displaying...');
        document.getElementById('trustlineQR').src = data.qr;
        document.getElementById('trustlineQR').style.display = 'block';
        document.getElementById('trustlineQRPlaceholder').style.display = 'none';

        // Update deep link with the actual XUMM URL if available
        if (data.next && data.next.always) {
          document.getElementById('trustlineDeepLink').href = data.next.always;
        }

        // Start automatic polling immediately when QR is displayed
        console.log('üîÑ Starting automatic trustline polling for QR scan...');
        document.getElementById('trustline-status').style.display = 'block';
        document.getElementById('trustline-status').innerText = '‚è≥ Scan QR code and add trustline in XAMAN...';

        // Start polling immediately - don't wait 5 seconds
        setTimeout(() => {
          console.log('üöÄ Starting trustline polling now...');
          startTrustlinePolling();
        }, 2000); // Reduced to 2 seconds

      } else {
        console.error('‚ùå Invalid trustline response - missing qr or uuid:', data);
        document.getElementById('trustlineQRPlaceholder').innerText = 'Failed to load QR';
        document.getElementById('trustlineQRPlaceholder').style.color = '#e74c3c';
      }
    } catch (error) {
      console.error('‚ùå Trustline QR error:', error);
      document.getElementById('trustlineQRPlaceholder').innerText = 'QR Load Failed';
      document.getElementById('trustlineQRPlaceholder').style.color = '#e74c3c';
    }
  }

  // Recheck trustline after user claims to have added it
  async function recheckTrustline() {
    try {
      console.log('üîÑ Manual trustline recheck for wallet:', connectedWallet);

      if (!connectedWallet) {
        alert('No wallet connected. Please refresh and try again.');
        return;
      }

      // Show loading state
      document.getElementById('manualCheckBtn').innerText = 'Checking...';
      document.getElementById('manualCheckBtn').disabled = true;

      // Use direct XRPL check instead of API
      const hasWaldoTrustline = await checkTrustlineDirectXRPL(connectedWallet);
      console.log('üì° Manual trustline recheck result:', hasWaldoTrustline);

      if (hasWaldoTrustline === true) {
        console.log('‚úÖ Trustline confirmed manually! Moving to Step 3');
        hasTrustline = true;
        document.getElementById('trustline-status').innerText = '‚úÖ Trustline confirmed!';
        document.getElementById('trustline-status').style.color = '#25c2a0';

        setTimeout(() => {
          showStep(3);
          loadPresaleProgress();
        }, 1000);
      } else {
        console.log('‚ùå Trustline still not detected');
        document.getElementById('manualCheckBtn').innerText = '‚úÖ I\'ve Added the Trustline - Check Now';
        document.getElementById('manualCheckBtn').disabled = false;
        alert('Trustline not detected yet. Please make sure you have added the WALDO trustline in XAMAN and try again.');
      }
    } catch (error) {
      console.error('‚ùå Manual trustline recheck error:', error);
      document.getElementById('manualCheckBtn').innerText = '‚úÖ I\'ve Added the Trustline - Check Now';
      document.getElementById('manualCheckBtn').disabled = false;
      alert(`Error checking trustline: ${error.message}. Please try again.`);
    }
  }

  // Load presale progress
  async function loadPresaleProgress() {
    // Safety check - don't load if no trustline
    if (!hasTrustline) {
      console.error('‚ùå SAFETY CHECK: Attempted to load presale progress without trustline!');
      console.log('Current hasTrustline value:', hasTrustline);
      console.log('Redirecting to Step 2...');
      showStep(2);
      setupTrustlineStep();
      return;
    }

    try {
      console.log('üìä Loading presale progress...');
      const response = await fetch('https://waldocoin-backend-api.onrender.com/api/presale/total-sold');

      if (!response.ok) {
        throw new Error(`Presale API returned ${response.status}`);
      }

      const data = await response.json();
      console.log('üìä Presale progress data:', data);

      if (data.success) {
        // Add null checks and fallback values
        const totalPurchases = data.totalPurchases || 0;
        const totalXRP = data.totalXRP || 0;
        const totalWaldo = data.totalWaldo || 0;

        document.getElementById('progressText').innerHTML =
          `<strong>${totalPurchases}</strong> purchases ‚Ä¢ <strong>${totalXRP}</strong> XRP raised ‚Ä¢ <strong>${totalWaldo.toLocaleString()}</strong> WALDO sold`;
      } else {
        console.error('‚ùå Presale API returned success: false');
        console.log('API response data:', data);
        // Show fallback data
        document.getElementById('progressText').innerHTML =
          `<strong>0</strong> purchases ‚Ä¢ <strong>0</strong> XRP raised ‚Ä¢ <strong>0</strong> WALDO sold`;
      }
    } catch (error) {
      console.error('‚ùå Progress load error:', error);
    }
  }

  // Amount selection
  function selectAmount(amount) {
    selectedAmount = amount;

    // Update button styles
    document.querySelectorAll('.amount-btn').forEach(btn => {
      btn.style.background = '#1a4d2e';
      btn.style.transform = 'none';
    });

    document.querySelector(`[data-amount="${amount}"]`).style.background = '#25c2a0';
    document.querySelector(`[data-amount="${amount}"]`).style.transform = 'scale(1.05)';

    // Calculate and show summary
    calculatePurchase(amount);

    // Enable purchase button
    document.getElementById('purchaseBtn').disabled = false;
    document.getElementById('purchaseBtn').style.opacity = '1';
    document.getElementById('purchaseBtn').innerText = `üîê Buy ${amount} XRP Worth of WALDO`;
  }

  // Calculate purchase details (local calculation - no API needed)
  function calculatePurchase(xrpAmount) {
    try {
      console.log('üßÆ Calculating purchase for', xrpAmount, 'XRP');

      // Base rate: 10,000 WALDO per XRP
      const baseRate = 10000;
      const baseWaldo = xrpAmount * baseRate;

      // Calculate bonus based on amount
      let bonusPercentage = 0;
      if (xrpAmount >= 100) {
        bonusPercentage = 30; // 30% bonus for 100+ XRP
      } else if (xrpAmount >= 90) {
        bonusPercentage = 22; // 22% bonus for 90+ XRP
      } else if (xrpAmount >= 80) {
        bonusPercentage = 15; // 15% bonus for 80+ XRP
      }

      const bonus = Math.floor(baseWaldo * (bonusPercentage / 100));
      const totalWaldo = baseWaldo + bonus;

      console.log('üìä Calculation result:', {
        xrpAmount,
        baseWaldo,
        bonusPercentage,
        bonus,
        totalWaldo
      });

      // Update digital LED display with total WALDO amount
      const totalWaldoFormatted = totalWaldo.toLocaleString();
      document.getElementById('calculatorDisplay').innerText = totalWaldoFormatted;

      // Add a brief flash effect for the digital display
      const display = document.getElementById('calculatorDisplay');
      display.style.textShadow = '0 0 20px #ff0000, 0 0 30px #ff0000';
      setTimeout(() => {
        display.style.textShadow = '0 0 10px #ff0000';
      }, 200);

      // Update purchase summary
      document.getElementById('summaryXRP').innerText = `${xrpAmount} XRP`;
      document.getElementById('summaryBaseWaldo').innerText = `${baseWaldo.toLocaleString()} WALDO`;
      document.getElementById('summaryTotal').innerText = `${totalWaldo.toLocaleString()} WALDO`;

      if (bonusPercentage > 0) {
        document.getElementById('bonusRow').style.display = 'flex';
        document.getElementById('summaryBonus').innerText = `${bonus.toLocaleString()} WALDO (${bonusPercentage}%)`;
      } else {
        document.getElementById('bonusRow').style.display = 'none';
      }

      document.getElementById('purchaseSummary').style.display = 'block';

    } catch (error) {
      console.error('‚ùå Calculation error:', error);
      // Show error on digital display
      document.getElementById('calculatorDisplay').innerText = 'ERROR';
      document.getElementById('calculatorDisplay').style.color = '#ff6666';

      // Reset after 2 seconds
      setTimeout(() => {
        document.getElementById('calculatorDisplay').innerText = '0';
        document.getElementById('calculatorDisplay').style.color = '#ff0000';
      }, 2000);
    }
  }

  // Purchase WALDO
  async function purchaseWaldo() {
    if (!selectedAmount || !connectedWallet) {
      alert('Please select an amount and connect your wallet first.');
      return;
    }

    const btn = document.getElementById('purchaseBtn');
    btn.disabled = true;
    btn.innerText = '‚è≥ Creating transaction...';

    try {
      const response = await fetch('https://waldocoin-backend-api.onrender.com/api/presale/buy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          wallet: connectedWallet,
          xrpAmount: selectedAmount
        })
      });

      const data = await response.json();

      if (data && data.success && data.deeplink) {
        // Always open XUMM directly - no QR codes needed
        console.log('üöÄ Opening XUMM app for purchase approval...');
        window.location.href = data.deeplink;

        btn.innerText = "‚úÖ Check XUMM App";
        btn.disabled = false;

        // Show success message
        alert(`Purchase request sent to XUMM!\n\nAmount: ${selectedAmount} XRP\nYou'll receive: ${data.calculation ? data.calculation.totalWaldo.toLocaleString() : 'calculating...'} WALDO tokens\n\nPlease approve the transaction in your XUMM app.`);

        // Start polling for transaction completion
        if (data.uuid) {
          pollTransactionStatus(data.uuid, btn);
        }

        // Reset button after 10 seconds if no completion detected
        setTimeout(() => {
          if (btn.innerText === "‚úÖ Check XUMM App") {
            btn.innerText = "üîê Buy Now with XUMM";
          }
        }, 10000);

      } else {
        throw new Error(data?.error || 'Purchase failed');
      }

    } catch (error) {
      console.error('Purchase error:', error);
      btn.innerText = '‚ùå Purchase Failed';
      btn.disabled = false;

      setTimeout(() => {
        btn.innerText = `üîê Buy ${selectedAmount} XRP Worth of WALDO`;
      }, 3000);

      alert('Purchase failed. Please try again.');
    }
  }

  // Function to poll transaction status and disconnect when complete
  function pollTransactionStatus(uuid, btn) {
    let pollCount = 0;
    const maxPolls = 60; // Poll for up to 5 minutes (5 second intervals)

    const pollInterval = setInterval(async () => {
      pollCount++;

      try {
        const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/presale/status/${uuid}`);
        const statusData = await response.json();

        console.log(`Poll ${pollCount}: Status for ${uuid}:`, statusData);

        if (statusData.success) {
          if (statusData.completed) {
            // Transaction completed successfully
            console.log('üéâ Transaction completed! Disconnecting wallet...');
            clearInterval(pollInterval);
            btn.innerText = "üéâ Purchase Complete!";

            // Show success message
            alert(`üéâ Purchase completed successfully!\n\nYou received: ${parseInt(statusData.waldoDelivered).toLocaleString()} WALDO tokens\n\nRedirecting to success page...`);

            // Redirect to success page after successful purchase
            setTimeout(() => {
              console.log('üöÄ Redirecting to success page...');
              window.location.href = 'https://waldocoin.live/presale-success/';
            }, 2000);

          } else if (statusData.rejected) {
            // Transaction was rejected
            console.log('‚ùå Transaction rejected');
            clearInterval(pollInterval);
            btn.innerText = "‚ùå Transaction Rejected";

            setTimeout(() => {
              btn.innerText = "üîê Buy Now with XUMM";
            }, 3000);
          } else {
            console.log('‚è≥ Transaction still pending...');
          }
          // If still pending, continue polling
        }

      } catch (error) {
        console.error('Error polling transaction status:', error);
      }

      // Stop polling after max attempts
      if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
        console.log('Stopped polling transaction status after 5 minutes');
      }

    }, 5000); // Poll every 5 seconds
  }

  // Disconnect wallet function
  function disconnectWallet() {
    console.log('üîå disconnectWallet() called');

    // For auto-disconnect after purchase, skip confirmation
    const isAutoDisconnect = arguments[0] === 'auto';

    if (isAutoDisconnect || confirm('Are you sure you want to disconnect your wallet?')) {
      console.log('üîå Proceeding with wallet disconnect...');

      // Reset all variables
      connectedWallet = null;
      hasTrustline = false;
      selectedAmount = 0;

      // Reset UI and start over
      showStep(1);
      connectXummWallet();

      console.log('‚úÖ Wallet disconnected successfully');
    } else {
      console.log('‚ùå Wallet disconnect cancelled by user');
    }
  }

  // Check if user returned from XUMM with signed status
  function checkForXummReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    const signed = urlParams.get('signed');
    const completed = urlParams.get('completed');
    const hash = window.location.hash;

    if ((signed === '1' || completed) && (hash === '#widget' || window.location.pathname.includes('presale-widget'))) {
      console.log('üéâ User returned from XUMM! Staying on presale widget...');

      // Clear the URL parameters but keep the hash
      window.history.replaceState({}, document.title, '/presale-widget/#widget');

      // If user was connecting wallet (signed=1), resume polling
      if (signed === '1') {
        const storedUuid = sessionStorage.getItem('presale_login_uuid');
        if (storedUuid && !connectedWallet) {
          console.log('üîÑ Resuming wallet connection polling...');

          // Show loading state
          document.getElementById('qrPlaceholder').innerText = 'üîç Checking wallet connection...';
          document.getElementById('qrPlaceholder').style.display = 'block';

          // Check status immediately
          checkWalletStatus(storedUuid);

          // Also start polling
          pollForConnection(storedUuid);
        }
        console.log('‚úÖ Staying on presale widget for wallet connection');
        return; // Don't redirect for wallet connection
      }

      // If user completed a purchase, check status but don't auto-redirect
      if (completed) {
        console.log('üîç Checking purchase completion status...');
        const purchaseBtn = document.getElementById('purchaseBtn');
        if (purchaseBtn && purchaseBtn.innerText === "‚úÖ Check XUMM App") {
          // Let the existing polling handle the completion
          console.log('‚úÖ Purchase polling will handle completion');
        }
      }
    }
  }

  // Function to immediately check wallet status
  async function checkWalletStatus(uuid) {
    try {
      const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/login/status?uuid=${uuid}`);
      const data = await response.json();

      console.log('üì° Immediate wallet status check:', data);

      if (data.signed && data.account) {
        console.log('‚úÖ Wallet already connected!');
        connectedWallet = data.account;

        // Store wallet connection in session storage
        sessionStorage.setItem('connected_wallet', data.account);

        // Update UI immediately
        document.getElementById('qrPlaceholder').innerText = '‚úÖ Wallet connected! Checking trustline...';
        document.getElementById('qrPlaceholder').style.color = '#25c2a0';

        // Check trustline and proceed (this will sign in the user)
        setTimeout(() => {
          checkTrustlineAndProceed();
        }, 1000);
      }
    } catch (error) {
      console.error('‚ùå Error checking wallet status:', error);
    }
  }

  // Check for existing wallet connection on page load
  function checkExistingConnection() {
    const storedUuid = sessionStorage.getItem('presale_login_uuid');
    const storedWallet = sessionStorage.getItem('connected_wallet');

    if (storedWallet) {
      console.log('üîç Found stored wallet:', storedWallet);
      connectedWallet = storedWallet;
      showStep(2);
      return true;
    }

    if (storedUuid) {
      console.log('üîç Found stored UUID, checking status...');
      checkWalletStatus(storedUuid);
      return true;
    }

    return false;
  }

  // Add window focus event to check authentication when user returns from XUMM
  window.addEventListener('focus', function() {
    console.log('üîç Window focused - checking for authentication updates...');

    // If we're currently polling and user returns to window, check status immediately
    if (window.currentPollingUuid && !connectedWallet) {
      console.log('üîÑ Checking authentication status on window focus...');
      checkWalletStatus(window.currentPollingUuid);
    }
  });

  // Add visibility change event for mobile browsers
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden && window.currentPollingUuid && !connectedWallet) {
      console.log('üîç Page became visible - checking authentication...');
      checkWalletStatus(window.currentPollingUuid);
    }
  });

  // Initialize widget on page load
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üöÄ Initializing progressive presale widget...');

    // Check for return from XUMM first
    if (!checkForXummReturn()) {
      // If not returning from XUMM, check for existing connection
      if (!checkExistingConnection()) {
        // If no existing connection, start fresh
        initializePresaleWidget();
      }
    } else {
      // If returning from XUMM, still initialize but don't start fresh connection
      console.log('üîÑ Returning from XUMM - checking authentication status...');
    }

    // Refresh progress every 30 seconds, but only if we have trustline
    setInterval(() => {
      if (hasTrustline) {
        loadPresaleProgress();
      }
    }, 30000);
  });
</script>