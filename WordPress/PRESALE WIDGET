<!-- üöÄ WALDO Presale Widget - Direct Display -->
<div style="background:#0d2818; padding: 40px 20px; border-radius: 18px; margin: 20px 0; border: 2px solid #25c2a0;">

  <!-- Widget Title -->
  <div style="text-align: center; margin-bottom: 30px;">
    <h1 style="color: #25c2a0; font-size: 28px; margin: 0; font-family: 'Arial Black', sans-serif;">
      üöÄ WALDO PRESALE
    </h1>
    <p style="color: white; font-size: 14px; margin: 5px 0 0 0; font-weight: bold;">
      Buy WALDO tokens with XRP ‚Ä¢ Bonus tiers available.
    </p>
  </div>

  <!-- Layout Wrapper -->
  <div
    style="display: flex; justify-content: center; gap: 40px; align-items: flex-start; max-width: 1200px; margin: 0 auto; flex-wrap: wrap;">

    <!-- üìé Left Side: QR + Info -->
    <div style="flex: 1; min-width: 280px; max-width: 500px; color: white; font-family: 'Arial Black', sans-serif;">

      <!-- üîó Trustline QR -->
      <div style="text-align:center; margin-bottom: 10px;">
        <img id="trustlineQR" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
          style="width:100px; border-radius:10px; border:2px solid #25c2a0;" />
        <div style="color: white; font-size: 13px; margin-top: 6px;">
          <strong>‚ûï Add WALDO Trustline</strong><br>
          WALDO won‚Äôt appear unless the trustline is added.
        </div>
      </div>
      <!-- üí¨ Info Text -->
      <div style="margin-top: 20px; text-align: center;">
        <h2 style="color: #ffea00; font-size: 22px;">WALDO Presale:</h2>
        <p style="font-size: 15px;">Buy in <strong>5 XRP increments only</strong><br>üî• Bonus WALDO at 80 XRP and above!
        </p>

        <!-- Presale Progress -->
        <div id="presaleProgress"
          style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #1a4d2e; border-radius: 8px;">
          <div style="font-size: 12px; color: white; font-weight: bold;">Presale Progress:</div>
          <div id="progressText" style="color: white; font-weight: bold; font-size: 14px;">Loading...</div>
          <div style="background: #0a1f0f; height: 8px; border-radius: 4px; margin: 8px 0; border: 1px solid #1a4d2e;">
            <div id="progressBar"
              style="background: #25c2a0; height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
          </div>
        </div>

        <p style="font-size: 14px; color: white; font-weight: bold;">Wallet: <span id="connectedWallet"
            style="color:#25c2a0; font-weight: bold;">Loading...</span><br>
          <span id="connectionStatus" style="color: #666; font-size: 12px;">Generating connection QR...</span><br>
          <span id="trustlineStatus" style="color: #666; font-size: 12px; display: none;">Checking
            trustline...</span><br>
          <button id="disconnectBtn" onclick="disconnectWallet()"
            style="display: none; background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; margin-top: 5px; cursor: pointer;">üîå
            Disconnect</button>
        </p>
        <a href="https://waldocoin.live/presale/" target="_blank"
          style="color: #25c2a0; font-size: 13px; font-weight: bold; text-decoration: underline;">üìÑ View Presale Info
          Page</a>
      </div>
      <!-- üì≤ XUMM QR -->
      <div style="margin-top: 25px; text-align: center;">
        <div id="qrContainer"
          style="min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
          <img id="xummQR" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
            style="width:90px; height:90px; border-radius:10px; border:2px solid #25c2a0; background:#0a1f0f; display: none;">
          <div id="qrPlaceholder"
            style="width:90px; height:90px; border-radius:10px; border:2px solid #25c2a0; background:#0a1f0f; display: flex; align-items: center; justify-content: center; color: #25c2a0; font-size: 10px; font-weight: bold;">
            Loading...
          </div>
        </div>
        <div style="color: white; font-size: 12px; font-weight: bold; margin-top: 8px;">Scan with XAMAN</div>
        <a id="xummDeepLink" href="#"
          style="color: #25c2a0; font-size: 12px; margin-top: 6px; display: none; font-weight: bold; text-decoration: underline;">üì≤
          Tap here for XAMAN App</a>
        <button onclick="connectXummWallet()"
          style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">üîÑ
          Refresh QR</button>
      </div>
    </div>

    <!-- üí≥ Right Side: Widget -->
    <div class="waldo-swap-box">
      <h2 style="color: white; font-weight: bold;">Buy WALDO</h2>
      <div class="swap-panel">
        <label>XRP (5‚Äì100 in 5 XRP increments) <span id="bonusTier"
            style="color: #ffd93d; font-size: 12px;"></span></label>
        <div class="panel-row">
          <input type="number" id="xrpInput" value="5" min="5" max="100" step="5" oninput="updateWaldoAmount()">
          <span>Max</span>
        </div>
        <div style="font-size: 11px; color: white; text-align: center; margin-top: 5px; font-weight: bold;">
          üéÅ Bonus Tiers: 15% at 80+ XRP | 22% at 90+ XRP | 30% at 100 XRP
        </div>
      </div>

      <div style="text-align:center; font-size:22px; margin:8px 0;">‚¨áÔ∏è</div>

      <div class="swap-panel">
        <label>WALDO</label>
        <div class="panel-row">
          <input type="text" id="waldoOutput" value="50,000" disabled>
          <span>Est.</span>
        </div>
      </div>

      <button id="buyWaldoBtn" onclick="buyWaldoSlider()">üîê Buy Now with XUMM</button>
      <p id="buySuccessMsg" style="color: #0f0; font-size: 14px; display: none; margin-top: 10px;">‚úÖ WALDO sent! Check
        your wallet.</p>
    </div>
  </div>
</div>

<!-- üíÑ Styling -->
<style>
  .waldo-swap-box {
    background: #0a1f0f;
    border: 2px solid #25c2a0;
    border-radius: 18px;
    padding: 30px 25px;
    font-family: 'Arial Black', sans-serif;
    box-shadow: 0 0 30px rgba(37, 194, 160, 0.3);
    color: white;
    text-align: center;
    width: 100%;
    max-width: 400px;
  }

  .waldo-swap-box h2 {
    color: white !important;
    font-weight: bold !important;
    margin-bottom: 20px;
  }

  .swap-panel {
    background: #0f2d17;
    border: 1px solid #1a4d2e;
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 14px;
    text-align: left;
  }

  .swap-panel label {
    font-size: 14px;
    color: white;
    font-weight: bold;
    margin-bottom: 8px;
    display: block;
  }

  .panel-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .panel-row input {
    flex: 1;
    background: #0a1f0f;
    border: 1px solid #25c2a0;
    color: #fff;
    padding: 12px;
    font-size: 16px;
    border-radius: 10px;
    margin-right: 10px;
  }

  .panel-row input:focus {
    outline: none;
    border-color: #25c2a0;
    box-shadow: 0 0 5px rgba(37, 194, 160, 0.3);
  }

  .panel-row span {
    font-size: 14px;
    color: white;
    font-weight: bold;
  }

  #buyWaldoBtn {
    background: #ffea00;
    color: black;
    font-weight: bold;
    padding: 14px 0;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    width: 100%;
    margin-top: 20px;
    cursor: pointer;
  }

  #buyWaldoBtn:hover {
    background: #fff000;
  }
</style>

<!-- üîß Script -->
<script>
  // Updated bonus table with correct calculations (1 XRP = 10,000 WALDO base + bonuses)
  const waldoBonusTable = {
    5: 50000, 10: 100000, 15: 150000, 20: 200000, 25: 250000, 30: 300000,
    35: 350000, 40: 400000, 45: 450000, 50: 500000, 55: 550000, 60: 600000,
    65: 650000, 70: 700000, 75: 750000,
    80: 920000,   // 800k base + 15% bonus (120k) = 920k
    85: 970000,   // 850k base + 15% bonus (127.5k) = 970k
    90: 1098000,  // 900k base + 22% bonus (198k) = 1.098M
    95: 1148000,  // 950k base + 22% bonus (209k) = 1.148M
    100: 1300000  // 1M base + 30% bonus (300k) = 1.3M
  };

  // Disconnect wallet function
  function disconnectWallet() {
    if (confirm('Are you sure you want to disconnect your wallet?')) {
      // Clear localStorage
      localStorage.removeItem("xummWallet");
      localStorage.removeItem("xummUUID");

      // Reset UI to disconnected state
      document.getElementById("connectedWallet").innerText = "Not connected";
      document.getElementById("connectedWallet").style.color = '#e74c3c';
      document.getElementById("connectionStatus").innerText = "Generating connection QR...";
      document.getElementById("connectionStatus").style.color = '#ffd93d';
      document.getElementById("disconnectBtn").style.display = 'none';
      document.getElementById("trustlineStatus").style.display = 'none';

      // Show connection elements
      document.getElementById('xummQR').style.display = 'none';
      document.getElementById('qrPlaceholder').style.display = 'flex';
      document.getElementById('xummDeepLink').style.display = 'none';

      // Automatically start connection process
      connectXummWallet();

      console.log('Wallet disconnected successfully');
    }
  }

  // Widget initialization function (no modal needed)
  function initializePresaleWidget() {
    updateWaldoAmount();
    const wallet = localStorage.getItem("xummWallet");

    if (wallet) {
      document.getElementById("connectedWallet").innerText = `${wallet.slice(0, 8)}...${wallet.slice(-6)} ‚úÖ`;
      document.getElementById("connectedWallet").style.color = '#25c2a0';
      document.getElementById("connectionStatus").innerText = "Wallet connected";
      document.getElementById("connectionStatus").style.color = '#25c2a0';
      document.getElementById("disconnectBtn").style.display = 'inline-block';
      // Hide the XUMM QR since wallet is already connected
      document.getElementById('xummQR').style.display = 'none';
      document.getElementById('qrPlaceholder').style.display = 'none';

      // Check trustline status for already connected wallet
      checkTrustlineStatus(wallet);
    } else {
      document.getElementById("connectedWallet").innerText = "Not connected";
      document.getElementById("connectedWallet").style.color = '#e74c3c';
      document.getElementById("connectionStatus").innerText = "Generating connection QR...";
      document.getElementById("connectionStatus").style.color = '#ffd93d';
      document.getElementById("disconnectBtn").style.display = 'none';
      // Show the placeholder, hide the QR initially
      document.getElementById('xummQR').style.display = 'none';
      document.getElementById('qrPlaceholder').style.display = 'flex';

      // Automatically load connection QR
      connectXummWallet();
    }

    document.getElementById("buySuccessMsg").style.display = "none";
    document.getElementById("buyWaldoBtn").disabled = false;
    document.getElementById("buyWaldoBtn").innerText = "üîê Buy Now with XUMM";
  }

  function updateWaldoAmount() {
    const amount = parseInt(document.getElementById("xrpInput").value);
    const waldo = waldoBonusTable[amount] || (amount * 10000);
    document.getElementById("waldoOutput").value = waldo.toLocaleString();

    // Update bonus tier indicator
    const bonusTier = document.getElementById('bonusTier');
    if (amount >= 100) {
      bonusTier.textContent = 'üî• 30% BONUS!';
      bonusTier.style.color = '#ff6b6b';
    } else if (amount >= 90) {
      bonusTier.textContent = 'üéÅ 22% BONUS!';
      bonusTier.style.color = '#ffd93d';
    } else if (amount >= 80) {
      bonusTier.textContent = '‚ú® 15% BONUS!';
      bonusTier.style.color = '#25c2a0';
    } else {
      bonusTier.textContent = '';
    }

    // Validate XRP amount
    const xrpInput = document.getElementById('xrpInput');
    const buyBtn = document.getElementById('buyWaldoBtn');

    if (amount % 5 !== 0 || amount < 5 || amount > 100 || isNaN(amount)) {
      xrpInput.style.borderColor = '#e74c3c';
      buyBtn.disabled = true;
      buyBtn.style.opacity = '0.5';
      buyBtn.textContent = '‚ùå Invalid Amount';
    } else {
      xrpInput.style.borderColor = '#25c2a0';
      buyBtn.disabled = false;
      buyBtn.style.opacity = '1';
      buyBtn.textContent = 'üîê Buy Now with XUMM';
    }
  }

  async function buyWaldoSlider() {
    const amount = parseInt(document.getElementById("xrpInput").value);
    const wallet = localStorage.getItem("xummWallet");
    if (!wallet) {
      alert("Please connect your XUMM wallet first.");
      return;
    }

    const btn = document.getElementById("buyWaldoBtn");
    const originalText = btn.innerText;
    btn.innerText = "‚è≥ Creating transaction...";
    btn.disabled = true;

    // Auto-reset button after 60 seconds as failsafe
    const failsafeTimeout = setTimeout(() => {
      btn.innerText = originalText;
      btn.disabled = false;
      console.warn('Transaction timeout - button reset automatically');
      alert('Transaction timed out. Please try again.');
    }, 60000);

    try {
      const res = await fetch("https://waldocoin-backend-api.onrender.com/api/presale/buy", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ wallet, xrpAmount: amount })
      });

      if (!res.ok) {
        throw new Error(`Server error: ${res.status} ${res.statusText}`);
      }

      const data = await res.json();

      if (data && data.success && data.deeplink) {
        clearTimeout(failsafeTimeout);

        // Always open XUMM directly - no QR codes needed
        console.log('ÔøΩ Opening XUMM app for purchase approval...');
        window.location.href = data.deeplink;

        btn.innerText = "‚úÖ Check XUMM App";
        btn.disabled = false;

        // Show success message
        alert(`Purchase request sent to XUMM!\n\nAmount: ${amount} XRP\nYou'll receive: ${data.calculation ? data.calculation.totalWaldo.toLocaleString() : 'calculating...'} WALDO tokens\n\nPlease approve the transaction in your XUMM app.`);

        // Reset button after 10 seconds
        setTimeout(() => {
          btn.innerText = "üîê Buy Now with XUMM";
        }, 10000);

      } else if (data && data.redirect) {
        // Fallback to redirect if no QR
        clearTimeout(failsafeTimeout);
        window.location.href = data.redirect;
      } else {
        throw new Error(data?.error || "Failed to create purchase request");
      }

    } catch (error) {
      clearTimeout(failsafeTimeout);
      console.error('Purchase error:', error);
      alert('Payment failed. Please try again.');
      btn.innerText = "üîê Buy Now with XUMM";
      btn.disabled = false;
    }
  }

  // Load dynamic trustline QR code
  async function loadTrustlineQR() {
    try {
      const response = await fetch('https://waldocoin-backend-api.onrender.com/api/login/trustline');
      const data = await response.json();

      if (data.qr) {
        document.getElementById('trustlineQR').src = data.qr;
      }
    } catch (error) {
      console.error('Failed to load trustline QR:', error);
    }
  }

  // Check trustline status for connected wallet
  async function checkTrustlineStatus(walletAddress) {
    const trustlineElement = document.getElementById('trustlineStatus');
    if (!trustlineElement || !walletAddress) return;

    try {
      trustlineElement.style.display = 'inline';
      trustlineElement.textContent = 'Checking trustline...';
      trustlineElement.style.color = '#ffd93d';

      // Check if wallet has WALDO trustline using a more reliable endpoint
      const response = await fetch(`https://xrplcluster.com/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          method: 'account_lines',
          params: [{
            account: walletAddress,
            ledger_index: 'validated'
          }]
        })
      });

      const data = await response.json();
      console.log('Trustline check response:', data);

      if (data.result && data.result.lines) {
        console.log('Found trustlines:', data.result.lines.length);

        // Look for WALDO trustline - check multiple possible formats
        const waldoTrustline = data.result.lines.find(line => {
          const currency = line.currency?.toUpperCase();
          const account = line.account;

          return (
            currency === 'WLO' ||
            currency === 'WALDO' ||
            currency === '57414C444F000000000000000000000000000000' ||
            account === 'rnWfL48YCknW6PYewFLKfMKUymHCfj3aww' // WALDO Treasury issuer
          );
        });

        console.log('WALDO trustline found:', !!waldoTrustline);

        if (waldoTrustline) {
          trustlineElement.textContent = '‚úÖ WALDO trustline active';
          trustlineElement.style.color = '#25c2a0';
        } else {
          trustlineElement.textContent = '‚ö†Ô∏è WALDO trustline missing - Add trustline above';
          trustlineElement.style.color = '#ffd93d';
        }
      } else if (data.error) {
        throw new Error(`XRPL API Error: ${data.error.error_message || data.error}`);
      } else {
        throw new Error('Invalid response from XRPL API');
      }
    } catch (error) {
      console.error('Trustline check error:', error);

      // Try fallback method using different endpoint
      try {
        console.log('Trying fallback trustline check...');
        const fallbackResponse = await fetch(`https://s1.ripple.com:51234/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: 'account_lines',
            params: [{
              account: walletAddress,
              ledger_index: 'validated'
            }]
          })
        });

        const fallbackData = await fallbackResponse.json();

        if (fallbackData.result && fallbackData.result.lines) {
          const waldoTrustline = fallbackData.result.lines.find(line =>
            line.currency === 'WLO' || line.account === 'rnWfL48YCknW6PYewFLKfMKUymHCfj3aww'
          );

          if (waldoTrustline) {
            trustlineElement.textContent = '‚úÖ WALDO trustline active';
            trustlineElement.style.color = '#25c2a0';
          } else {
            trustlineElement.textContent = '‚ö†Ô∏è WALDO trustline missing - Add trustline above';
            trustlineElement.style.color = '#ffd93d';
          }
        } else {
          throw new Error('Fallback also failed');
        }
      } catch (fallbackError) {
        console.error('Fallback trustline check also failed:', fallbackError);
        trustlineElement.textContent = '‚ùì Unable to check trustline - Please verify manually';
        trustlineElement.style.color = '#666';
      }
    }
  }

  // Load presale progress
  async function loadPresaleProgress() {
    try {
      const response = await fetch('https://waldocoin-backend-api.onrender.com/api/presale/total-sold');
      const data = await response.json();

      if (data.success) {
        const totalSold = data.totalWALDO || 0;
        const totalTarget = 40000000; // 40M WALDO presale target
        const progressPercent = Math.min((totalSold / totalTarget) * 100, 100);

        document.getElementById('progressText').textContent =
          `${totalSold.toLocaleString()} / ${totalTarget.toLocaleString()} WALDO sold`;
        document.getElementById('progressBar').style.width = `${progressPercent}%`;
      }
    } catch (error) {
      console.error('Failed to load presale progress:', error);
      document.getElementById('progressText').textContent = 'Progress unavailable';
    }
  }

  async function connectXummWallet() {
    try {
      // Don't change wallet status if already connected
      const existingWallet = localStorage.getItem("xummWallet");
      if (existingWallet) {
        console.log('Wallet already connected:', existingWallet);
        return;
      }

      console.log('Starting wallet connection process...');
      document.getElementById('connectedWallet').textContent = 'Connecting...';
      document.getElementById('connectionStatus').textContent = 'Loading connection QR...';
      document.getElementById('connectionStatus').style.color = '#ffd93d';

      // Ensure placeholder is visible while loading
      document.getElementById('xummQR').style.display = 'none';
      document.getElementById('qrPlaceholder').style.display = 'flex';
      document.getElementById('qrPlaceholder').textContent = 'Loading...';

      const res = await fetch("https://waldocoin-backend-api.onrender.com/api/login", {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
      });

      console.log('Response status:', res.status, res.statusText);

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}: ${res.statusText}`);
      }

      const data = await res.json();
      console.log('Login response:', data); // Debug log

      if (data.qr) {
        console.log('QR code received, displaying...', data.qr.substring(0, 50) + '...');

        // Update the XUMM QR code in the widget and make sure it's visible
        const qrElement = document.getElementById('xummQR');
        const placeholder = document.getElementById('qrPlaceholder');
        const isMobile = /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);

        if (!qrElement || !placeholder) {
          console.error('QR elements not found in DOM');
          return;
        }

        qrElement.src = data.qr;
        qrElement.style.display = 'block';
        placeholder.style.display = 'none';

        console.log('QR code displayed successfully');

        // Update status based on device type
        if (isMobile) {
          document.getElementById('connectionStatus').innerHTML = 'Tap the button below to open XUMM app';
          document.getElementById('connectionStatus').style.color = '#25c2a0';
        } else {
          document.getElementById('connectionStatus').innerHTML = 'Scan QR code with XUMM mobile app';
          document.getElementById('connectionStatus').style.color = '#25c2a0';
        }

        // Show deep link for mobile users
        if (isMobile && (data.refs?.xapp || data.next?.always)) {
          const deepLink = document.getElementById("xummDeepLink");
          deepLink.href = data.refs?.xapp || data.next?.always;
          deepLink.style.display = "inline-block";
          deepLink.innerHTML = "üöÄ Open XUMM App";
          deepLink.style.background = "#25c2a0";
          deepLink.style.color = "white";
          deepLink.style.padding = "8px 16px";
          deepLink.style.borderRadius = "6px";
          deepLink.style.textDecoration = "none";
          deepLink.style.fontWeight = "bold";
          deepLink.style.display = "inline-block";
          deepLink.style.marginTop = "10px";
        }

        // Store UUID for checking connection status
        if (data.uuid) {
          localStorage.setItem("xummUUID", data.uuid);

          // Check connection status periodically
          const checkConnection = setInterval(async () => {
            try {
              const statusRes = await fetch(`https://waldocoin-backend-api.onrender.com/api/login/status?uuid=${data.uuid}`);
              const statusData = await statusRes.json();
              console.log('Status check:', statusData); // Debug log

              if (statusData.signed && statusData.account) {
                localStorage.setItem("xummWallet", statusData.account);
                document.getElementById('connectedWallet').textContent = `${statusData.account.slice(0, 8)}...${statusData.account.slice(-6)} ‚úÖ`;
                document.getElementById('connectedWallet').style.color = '#25c2a0';
                document.getElementById('connectionStatus').textContent = 'Wallet connected successfully!';
                document.getElementById('connectionStatus').style.color = '#25c2a0';
                document.getElementById('disconnectBtn').style.display = 'inline-block';
                clearInterval(checkConnection);

                // Check trustline status
                checkTrustlineStatus(statusData.account);

                // Hide the connection QR and show placeholder
                document.getElementById('xummQR').style.display = 'none';
                document.getElementById('qrPlaceholder').style.display = 'none';
                document.getElementById('xummDeepLink').style.display = 'none';

                console.log('Wallet connected successfully:', statusData.account);
              } else if (statusData.expired) {
                console.log('QR code expired, generating new one');
                clearInterval(checkConnection);
                document.getElementById('connectionStatus').textContent = 'QR expired - generating new one...';
                document.getElementById('connectionStatus').style.color = '#ffd93d';

                // Auto-generate new QR code
                setTimeout(() => {
                  connectXummWallet();
                }, 1000);
              }
            } catch (error) {
              console.error('Status check error:', error);
            }
          }, 3000); // Check every 3 seconds

          // Stop checking after 2 minutes
          setTimeout(() => {
            clearInterval(checkConnection);
            if (document.getElementById('connectedWallet').textContent === 'Connecting...') {
              document.getElementById('connectedWallet').textContent = 'Connection timeout ‚è∞';
              document.getElementById('connectedWallet').style.color = '#ffd93d';
            }
          }, 120000);
        }

      } else {
        console.error('Login failed:', data);
        throw new Error(data.error || 'No QR code received from server');
      }
    } catch (error) {
      console.error('Wallet connection error:', error);
      document.getElementById('connectedWallet').textContent = 'Connection failed ‚ùå';
      document.getElementById('connectedWallet').style.color = '#e74c3c';
      document.getElementById('connectionStatus').textContent = 'Failed to load QR - retrying...';
      document.getElementById('connectionStatus').style.color = '#e74c3c';

      // Show error in placeholder
      const placeholder = document.getElementById('qrPlaceholder');
      if (placeholder) {
        placeholder.style.display = 'flex';
        placeholder.textContent = 'Error loading QR';
        placeholder.style.color = '#e74c3c';
      }
      document.getElementById('xummQR').style.display = 'none';

      // Show error details in console for debugging
      console.log('Full error details:', {
        error: error.message,
        timestamp: new Date().toISOString()
      });

      // Auto-retry after 3 seconds
      setTimeout(() => {
        connectXummWallet();
      }, 3000);
    }
  }

  // Debug function for testing connection
  window.testConnection = function () {
    console.log('üîç Testing wallet connection...');
    localStorage.removeItem('xummWallet');
    localStorage.removeItem('xummUUID');
    connectXummWallet();
  };

  // Initialize widget on page load
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üöÄ Initializing presale widget...');
    initializePresaleWidget();
    loadTrustlineQR();
    loadPresaleProgress();

    // Refresh progress every 30 seconds
    setInterval(loadPresaleProgress, 30000);
  });
</script>