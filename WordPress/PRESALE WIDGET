<!-- WALDOCOIN Presale Widget - Clean Version -->
<div id="waldocoin-presale-widget"
  style="background: linear-gradient(135deg, #0d2818 0%, #1a4d2e 100%); padding: 15px; border-radius: 15px; border: 2px solid #25c2a0; box-shadow: 0 10px 30px rgba(37, 194, 160, 0.3); max-width: 450px; margin: 10px auto; box-sizing: border-box; font-family: Arial, sans-serif;">

  <!-- Header -->
  <div style="text-align: center; margin-bottom: 20px;">
    <h1 style="color: #25c2a0; font-size: 24px; margin: 0; font-weight: bold;">üöÄ WALDOCOIN PRESALE</h1>
    <p style="color: white; font-size: 14px; margin: 8px 0 0 0;">Secure your WALDO tokens with XRP</p>
  </div>

  <!-- Mobile-First CSS -->
  <style>
    @media (max-width: 768px) {
      #waldocoin-presale-widget {
        max-width: calc(100vw - 20px) !important;
        padding: 12px !important;
        margin: 8px auto !important;
      }

      #waldocoin-presale-widget h1 {
        font-size: 20px !important;
      }

      #waldocoin-presale-widget p {
        font-size: 13px !important;
      }

      #waldocoin-presale-widget button {
        width: 100% !important;
        padding: 14px !important;
        font-size: 16px !important;
        min-height: 48px !important;
        box-sizing: border-box !important;
        touch-action: manipulation !important;
      }

      #waldocoin-presale-widget input {
        width: 100% !important;
        padding: 14px !important;
        font-size: 16px !important;
        min-height: 48px !important;
        box-sizing: border-box !important;
      }
    }
  </style>

  <!-- Step 1: Connect Wallet -->
  <div id="step1-connect" style="text-align: center;">
    <h3 style="color: #ffea00; font-size: 18px; margin: 15px 0;">Step 1: Connect Your Wallet</h3>

    <!-- QR Code Display -->
    <div style="margin: 15px 0;">
      <div id="qrPlaceholder"
        style="display: flex; align-items: center; justify-content: center; min-height: 200px; background: #0f2d17; border: 2px dashed #25c2a0; border-radius: 10px; color: #25c2a0; font-size: 14px; font-weight: bold;">
        Loading QR Code...
      </div>
      <img id="xummQR" style="display: none; max-width: 100%; height: auto; border-radius: 10px; margin: 10px 0;"
        alt="XUMM QR Code" />
      <a id="xummDeepLink"
        style="display: none; color: #25c2a0; text-decoration: none; font-weight: bold; margin-top: 10px; display: block;"
        target="_blank">üì± Open in XAMAN App</a>
    </div>

    <!-- Wallet Status -->
    <div style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #25c2a0; border-radius: 8px;">
      <div style="color: #25c2a0; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Wallet Status</div>
      <div style="color: white; font-size: 11px;">
        <strong>Connected:</strong> <span id="connectedWallet">Not connected</span><br>
        <strong>Status:</strong> <span id="connectionStatus">Generating connection QR...</span>
      </div>
      <button id="disconnectBtn" onclick="disconnectWallet()"
        style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer; display: none;">üîå
        Disconnect</button>
    </div>
  </div>

  <!-- Step 2: Add Trustline -->
  <div id="step2-trustline" style="display: none; text-align: center;">
    <h3 style="color: #ffea00; font-size: 18px; margin: 15px 0;">Step 2: Add WALDO Trustline</h3>
    <p style="color: white; font-size: 14px; margin: 10px 0;">You need to add a trustline to receive WALDO tokens</p>

    <!-- Trustline QR -->
    <div style="margin: 15px 0;">
      <div id="trustlineQRPlaceholder"
        style="display: flex; align-items: center; justify-content: center; min-height: 200px; background: #0f2d17; border: 2px dashed #ffd93d; border-radius: 10px; color: #ffd93d; font-size: 14px; font-weight: bold;">
        Loading Trustline QR...
      </div>
      <img id="trustlineQR" style="display: none; max-width: 100%; height: auto; border-radius: 10px; margin: 10px 0;"
        alt="Trustline QR Code" />
    </div>

    <!-- Trustline Actions -->
    <button onclick="addTrustlineAndWait()"
      style="background: #ffd93d; color: black; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; box-sizing: border-box;">
      üì≤ Add Trustline in XAMAN
    </button>

    <button onclick="recheckTrustline()"
      style="background: #25c2a0; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin: 5px; width: 100%; box-sizing: border-box;">
      üîÑ I've Added the Trustline
    </button>

    <!-- Trustline Status -->
    <div id="trustline-status"
      style="display: none; margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #ffd93d; border-radius: 8px; color: white; font-size: 12px; text-align: center;">
      Checking trustline...
    </div>
  </div>

  <!-- Step 3: Purchase Interface -->
  <div id="step3-info" style="display: none; text-align: center;">
    <h3 style="color: #ffea00; font-size: 18px; margin: 15px 0;">Step 3: Purchase WALDO</h3>
    <p style="color: white; font-size: 14px; margin: 10px 0;">Buy in <strong>5 XRP increments only</strong><br>üî• Bonus
      WALDO at 80 XRP and above!</p>

    <!-- Presale Progress -->
    <div id="presaleProgress"
      style="margin: 15px 0; padding: 10px; background: #0f2d17; border: 1px solid #1a4d2e; border-radius: 8px;">
      <div style="color: #25c2a0; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Presale Progress</div>
      <div id="progressText" style="color: white; font-size: 11px;">Loading...</div>
    </div>
  </div>

  <!-- Purchase Interface -->
  <div id="purchase-interface" style="display: none; margin-top: 15px;">
    <!-- Amount Selection -->
    <div style="margin-bottom: 15px;">
      <label style="color: white; font-weight: bold; display: block; margin-bottom: 10px; text-align: center;">Select
        XRP Amount:</label>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px;">
        <button onclick="selectAmount(5)" class="amount-btn" data-amount="5"
          style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">5
          XRP</button>
        <button onclick="selectAmount(10)" class="amount-btn" data-amount="10"
          style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">10
          XRP</button>
        <button onclick="selectAmount(25)" class="amount-btn" data-amount="25"
          style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">25
          XRP</button>
        <button onclick="selectAmount(50)" class="amount-btn" data-amount="50"
          style="background: #1a4d2e; color: white; border: 2px solid #25c2a0; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">50
          XRP</button>
        <button onclick="selectAmount(80)" class="amount-btn" data-amount="80"
          style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">80
          XRP<br><span style="font-size: 10px; color: #ffd93d;">+15% BONUS</span></button>
        <button onclick="selectAmount(90)" class="amount-btn" data-amount="90"
          style="background: #1a4d2e; color: white; border: 2px solid #ffd93d; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">90
          XRP<br><span style="font-size: 10px; color: #ffd93d;">+22% BONUS</span></button>
        <button onclick="selectAmount(100)" class="amount-btn" data-amount="100"
          style="background: #1a4d2e; color: white; border: 2px solid #ff6b6b; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">100
          XRP<br><span style="font-size: 10px; color: #ff6b6b;">+30% BONUS</span></button>
      </div>
    </div>

    <!-- Purchase Summary -->
    <div id="purchaseSummary"
      style="margin: 15px 0; padding: 15px; background: #0f2d17; border: 2px solid #25c2a0; border-radius: 10px; display: none;">
      <div style="color: #25c2a0; font-size: 14px; font-weight: bold; margin-bottom: 10px;">Purchase Summary</div>
      <div id="summaryText" style="color: white; font-size: 12px; line-height: 1.4;"></div>
    </div>

    <!-- Purchase Button -->
    <button id="purchaseBtn" onclick="purchaseWaldo()" disabled
      style="width: 100%; background: #25c2a0; color: white; border: none; padding: 15px; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; opacity: 0.5; min-height: 50px; box-sizing: border-box;">
      üîê Select Amount to Purchase
    </button>
  </div>
</div>

<script>
  // Global variables
  let selectedAmount = 0;
  let connectedWallet = null;
  let hasTrustline = false;

  // Progressive flow management
  function showStep(stepNumber) {
    console.log(`üì± SHOWING STEP ${stepNumber}`);

    // Hide all steps
    document.getElementById('step1-connect').style.display = 'none';
    document.getElementById('step2-trustline').style.display = 'none';
    document.getElementById('step3-info').style.display = 'none';
    document.getElementById('purchase-interface').style.display = 'none';

    // Show requested step
    if (stepNumber === 1) {
      document.getElementById('step1-connect').style.display = 'block';
    } else if (stepNumber === 2) {
      document.getElementById('step2-trustline').style.display = 'block';
    } else if (stepNumber === 3) {
      document.getElementById('step3-info').style.display = 'block';
      document.getElementById('purchase-interface').style.display = 'block';
    }
  }

  // Initialize widget
  function initializePresaleWidget() {
    showStep(1);
    connectXummWallet();
  }

  // Step 1: Connect wallet
  async function connectXummWallet() {
    try {
      console.log('üîó Connecting XUMM wallet...');

      document.getElementById('qrPlaceholder').innerText = 'Loading QR...';
      document.getElementById('qrPlaceholder').style.display = 'flex';
      document.getElementById('xummQR').style.display = 'none';

      const presaleWidgetUrl = 'https://waldocoin.live/presale-widget/?signed=1#widget';
      const encodedReturnUrl = encodeURIComponent(presaleWidgetUrl);

      const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/login?return_url=${encodedReturnUrl}`);
      const data = await response.json();

      if (data.qr && data.uuid) {
        sessionStorage.setItem('presale_login_uuid', data.uuid);

        document.getElementById('xummQR').src = data.qr;
        document.getElementById('xummQR').style.display = 'block';
        document.getElementById('qrPlaceholder').style.display = 'none';

        if (data.next && data.next.always) {
          document.getElementById('xummDeepLink').href = data.next.always;
          document.getElementById('xummDeepLink').style.display = 'block';
        }

        pollForConnection(data.uuid);
      }
    } catch (error) {
      console.error('‚ùå Connection error:', error);
      document.getElementById('qrPlaceholder').innerHTML = 'Connection failed<br><button onclick="connectXummWallet()" style="background: #25c2a0; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer;">üîÑ Try Again</button>';
    }
  }

  // Poll for wallet connection
  function pollForConnection(uuid) {
    console.log('üîÑ Starting to poll for connection with UUID:', uuid);
    let pollCount = 0;
    const maxPolls = 120;

    const pollInterval = setInterval(async () => {
      try {
        const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/login/status?uuid=${uuid}`);
        const data = await response.json();

        if (data.signed) {
          clearInterval(pollInterval);
          connectedWallet = data.account;
          sessionStorage.setItem('connected_wallet', data.account);

          console.log('‚úÖ Wallet connected:', connectedWallet);

          document.getElementById('connectedWallet').innerText = connectedWallet;
          document.getElementById('connectedWallet').style.color = '#25c2a0';
          document.getElementById('connectionStatus').innerText = 'Connected successfully!';
          document.getElementById('connectionStatus').style.color = '#25c2a0';
          document.getElementById('disconnectBtn').style.display = 'inline-block';

          checkTrustlineAndProceed();
        }
      } catch (error) {
        console.error('‚ùå Polling error:', error);
      }

      pollCount++;
      if (pollCount >= maxPolls) {
        clearInterval(pollInterval);
      }
    }, 1000);
  }

  // Check trustline and proceed
  async function checkTrustlineAndProceed() {
    try {
      console.log('üîç Checking trustline for wallet:', connectedWallet);

      if (!connectedWallet) {
        showStep(1);
        return;
      }

      console.log('‚úÖ User signed in via XUMM with wallet:', connectedWallet);
      document.getElementById('connectionStatus').innerText = 'Signed in successfully!';
      document.getElementById('connectionStatus').style.color = '#25c2a0';

      const hasWaldoTrustline = await checkTrustlineDirectXRPL(connectedWallet);

      if (hasWaldoTrustline) {
        console.log('‚úÖ Wallet HAS WALDO trustline');
        hasTrustline = true;
        document.getElementById('connectionStatus').innerText = 'Ready to purchase!';
        showStep(3);
        loadPresaleProgress();
      } else {
        console.log('‚ö†Ô∏è Wallet DOES NOT have WALDO trustline');
        hasTrustline = false;
        document.getElementById('connectionStatus').innerText = 'Signed in - Trustline required';
        document.getElementById('connectionStatus').style.color = '#ffd93d';
        showStep(2);
        setupTrustlineStep();
      }
    } catch (error) {
      console.error('‚ùå Trustline check error:', error);
      hasTrustline = false;
      showStep(2);
      setupTrustlineStep();
    }
  }

  // Direct XRPL trustline check
  async function checkTrustlineDirectXRPL(wallet) {
    console.log('üîç Direct XRPL trustline check for:', wallet);

    const servers = [
      'https://xrplcluster.com',
      'https://s1.ripple.com:51234',
      'https://s2.ripple.com:51234'
    ];

    for (const server of servers) {
      try {
        const response = await fetch(server, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            method: 'account_lines',
            params: [{
              account: wallet,
              ledger_index: 'validated'
            }]
          })
        });

        if (!response.ok) continue;

        const data = await response.json();

        if (data.result && data.result.lines) {
          const waldoTrustline = data.result.lines.find(line =>
            line.currency === 'WLO' &&
            line.account === 'rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY'
          );

          if (waldoTrustline) {
            console.log('‚úÖ WALDO trustline found via direct XRPL!');
            return true;
          } else {
            console.log('‚ùå No WALDO trustline found via direct XRPL');
            return false;
          }
        }
      } catch (error) {
        console.log(`‚ùå Failed to query ${server}:`, error.message);
        continue;
      }
    }

    throw new Error('All XRPL servers failed');
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function () {
    console.log('üöÄ Initializing presale widget...');
    initializePresaleWidget();
  });
</script>