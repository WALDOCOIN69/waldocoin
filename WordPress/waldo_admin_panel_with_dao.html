<!DOCTYPE html>
<html lang="en">
<head>
  <title>WALDO Admin Panel</title>
  <style>
    body { background:#111; color:white; font-family:sans-serif; padding:40px; }
    h2 { color:#e63e3e; }
    .waldo-chart, .waldo-chart-2 { margin-top: 20px; }
    .flex-wrap-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    table { width:100%; border-collapse:collapse; background:#222; margin-bottom:20px; }
    th, td { padding:10px; border:1px solid #444; text-align:left; }
    th { background:#e63e3e; }
    button { background:#e63e3e; color:white; padding:10px 20px; border:none; border-radius:5px; margin:5px; cursor:pointer; }
    pre { background:#222; padding:20px; border-radius:8px; margin-top:20px; }
    .card { margin-bottom:40px; }
    input, textarea { padding:10px; width:100%; margin:5px 0 10px; background:#222; color:white; border:1px solid #444; border-radius:5px; }
    .hidden { display: none; }
    .export-history-btn { margin-left: 10px; }
    .date-input { margin-right: 10px; }
    .margin-spacing { margin: 10px 0; }
    .margin-10 { margin: 10px 0; }
    .margin-10 { margin: 10px 0; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="card">
    <h2>ğŸ“Š Admin Analytics</h2>
    <button type="button" onclick="loadWalletAnalytics()">ğŸ“Œ Wallet Analytics</button>
    <button type="button" onclick="loadBattleStats()">âš”ï¸ Battle Stats</button>
    <button type="button" onclick="loadAirdropStats()">ğŸ Airdrop Stats</button>
    <button type="button" onclick="loadAdminLogs()">ğŸ“œ Admin Logs</button>
  <pre id="analyticsOutput">Waiting for admin input...</pre>
<h1>ğŸš¨ WALDO Admin Panel</h1>
</div>
<!-- Meme Battle Debug Tools -->
<div class="card">
    <button type="button" onclick="togglePhase()">ğŸ”„ Phase Switcher</button>
    <button type="button" onclick="showLiveStats()">ğŸ“ˆ Live Stats</button>
    <button type="button" onclick="openAirdropTools()">ğŸ“¦ Airdrop Tools</button>
    <button type="button" onclick="runDebugTools()">ğŸ§ª Debug Buttons</button>
    <button type="button" onclick="openWalletAnalytics()">ğŸ” Wallet Analytics</button>
  </div>
<!-- Presale Countdown -->
<div class="card">
  <h2>â²ï¸ Presale Countdown Controls</h2>
  <label for="presaleEnd">Presale End Date (YYYY-MM-DD):</label>
  <input type="date" id="presaleEnd" name="presaleEnd" input>
  <button type="button" onclick="setPresaleEndDate()">ğŸ’¾ Save End Date</button>
  <pre id="timerOutput">Loading current timer...</pre>
</div> <!-- Closing tag added -->

<!-- Presale Summary -->
<div class="card">
  <h2>ğŸ“Š Presale Summary</h2>
  <button type="button" onclick="downloadCSV()">â¬‡ï¸ Download Presale CSV</button>
  <button type="button" onclick="loadBuyers()">ğŸ”„ Refresh Buyer List</button>
  <p><strong>WALDO Sold:</strong> <span id="totalWaldo">...</span><br>
  <strong>XRP Collected:</strong> <span id="totalXrp">...</span></p>
  <div class="margin-10">
  <div class="margin-10">
    <label for="startDate">Filter by Date:</label><br>
    <input type="date" id="startDate" class="date-input">
    <input type="date" id="endDate" class="date-input" >
    <canvas id="waldoChart2" height="60" class="waldo-chart-2"></canvas>
  </div>
  <table>
      <thead>
        <tr>
          <th scope="col">Wallet</th>
          <th scope="col">XRP</th>
          <th scope="col">WALDO</th>
          <th scope="col">Email</th>
          <th scope="col">Timestamp</th>
          <th scope="col">WALDO Balance</th> <!-- new column -->
        </tr>
      </thead>

      <!-- airdop history-->
    <tbody id="buyerRows"><tr><td colspan="5">Loading...</td></tr></tbody>
  </table>
<div class="card">
  <h2>ğŸ Airdrop History</h2>
<input type="date" id="historyStart" class="date-input">
  <div class="margin-10">
    <button type="button" onclick="downloadAirdropHistoryCSV()" class="export-history-btn">Export History CSV</button>
    <input type="date" id="historyEnd">
    <button type="button" onclick="downloadAirdropHistoryCSV()" class="export-history-btn">Export History CSV</button>
  </div>
  <div>
  <table>
    <thead><tr><th scope="col">Wallet</th><th scope="col">Amount</th><th scope="col">Date</th></tr></thead>
    <tbody id="airdropHistoryRows"><tr><td colspan="3">Loading...</td></tr></tbody>
  </table>
  </div>
</div>

<!-- Minted Memes -->
<div class="card">
  <h2>ğŸ–¼ï¸ Minted Memes</h2>
  <table>
    <thead><tr><th scope="col">Wallet</th><th scope="col">XP</th><th scope="col">Tier</th><th scope="col">Image</th><th scope="col">Minted At</th></tr></thead>
    <tbody id="mintedRows"><tr><td colspan="5">Loading...</td></tr></tbody>
  </table>
</div>

<!-- Top Legendary Memes -->
<div class="card">
  <h2>ğŸ‘‘ Top Legendary Memes</h2>
  <table>
    <thead><tr><th scope="col">Wallet</th><th scope="col">XP</th><th scope="col">Tier</th><th scope="col">Image</th><th scope="col">Minted</th></tr></thead>
    <tbody id="legendaryRows"><tr><td colspan="5">Loading...</td></tr></tbody>
  </table>
</div>

<!-- XP Leaderboard -->
<div class="card">
  <h2>ğŸ“ˆ XP Leaderboard</h2>
  <table>
    <thead><tr><th scope="col">Wallet</th><th scope="col">XP</th><th scope="col">Level</th><th scope="col">Memes Minted</th><th scope="col">Battles Won</th></tr></thead>
    <tbody id="xpRows"><tr><td colspan="5">Loading...</td></tr></tbody>
  </table>
</div>

<!-- Airdrop Queue -->
<div class="card">
  <h2>ğŸ Airdrop Queue</h2>
  <form onsubmit="addToQueue(event)">
    <input type="text" id="airdropWallet" placeholder="Enter XRP Wallet Address" required>
    <input type="number" id="airdropAmount" placeholder="WALDO Amount" required>
    <button type="submit">â• Add to Queue</button>
  </form>
  <button type="button" onclick="sendAirdrops()">ğŸš€ Send All Airdrops</button>
  <button type="button" onclick="downloadAirdropCSV()">ğŸ“ Export Airdrop Queue</button>

  <table>
    <thead><tr><th scope="col">Wallet</th><th scope="col">Amount</th></tr></thead>
    <tbody id="airdropQueueRows"><tr><td colspan="2">No queued drops.</td></tr></tbody>
  </table>
</div>

<!-- Manual Sender -->
<div class="card">
  <h2>âœï¸ Manual WALDO Sender</h2>
  <form onsubmit="sendManual(event)">
    <input type="text" id="manualWallet" placeholder="XRP Wallet Address" required>
    <input type="number" id="manualAmount" placeholder="Amount to Send" required>
    <button type="submit">ğŸ“¤ Send WALDO</button>
  </form>
</div>

<!-- Trustline Checker -->
<div class="card">
  <h2>ğŸ” Trustline Checker</h2>
  <form onsubmit="checkTrustline(event)">
    <input type="text" id="trustWallet" placeholder="XRP Wallet Address" required>
    <button type="submit">ğŸ” Check</button>
  </form>
  <pre id="trustOutput">Waiting for wallet trustline check...</pre>
</div>
<!-- DAO Proposal Section -->
<div class="card dao-admin">
  <h2>ğŸ—³ï¸ Create a DAO Proposal</h2>
  <form id="daoProposalForm">
    <input type="text" id="daoTitle" placeholder="Proposal Title" required>
    <textarea id="daoDescription" placeholder="Description (optional)"></textarea>
    <input type="text" id="daoOptions" placeholder="Options e.g. Yes,No" required>
    <input type="number" id="daoDuration" placeholder="Voting Duration (hours)" value="24">
    <button type="submit">ğŸ“¨ Submit Proposal</button>
  </form>

  <h2>ğŸ“‹ Active Proposals</h2>
  <div id="proposalListDAO"><p>Loading proposals...</p></div>

  <div id="proposalDetailDAO" class="mt-6 hidden">
    <h3>ğŸ“„ Proposal Details</h3>
    <div id="detailContent"></div>
  </div>
</div>

</div>
<script>
  const base = "https://waldocoin-1.onrender.com"; 
  const WALLET = localStorage.getItem("xumm_wallet") || "";
  
    // ğŸ”„ Toggle Presale Phase
    function togglePhase() {
      fetch(`${base}/api/admin/toggle-phase`, {
        method: 'POST',
      })
      .then(res => res.json())
      .then(data => alert("Phase switched to: " + data.newPhase))
      .catch(err => alert("Failed to switch phase"));
    }
    function addToQueue(e) {
      e.preventDefault();
      const wallet = document.getElementById("airdropWallet").value.trim();
      const amount = parseFloat(document.getElementById("airdropAmount").value);
      if (!wallet || isNaN(amount)) return alert("Invalid entry.");
      queue.push({ wallet, amount });
      renderQueue();
    }
    
    // ğŸ“ˆ Show WALDO Live Stats
    function showLiveStats() {
      fetch(`${base}/api/admin/presale-stats`)
      .then(res => res.json())
      .then(data => {
        alert(`ğŸ’° WALDO Sold: ${data.totalSold}\nğŸ”¥ Top Wallet: ${data.topWallet}`);
      })
      .catch(err => alert("Error fetching stats"));
    }
    // ğŸ“¦ Open Airdrop Tools
    function openAirdropTools() {
        window.location.href = "/admin-airdrop-panel"; // swap for your internal route
      }
  
    // ğŸ§ª Run Debug Tools
    function runDebugTools() {
      fetch(`${base}/api/debug/fake-battle`, {
        method: 'POST',
      })
      .then(res => res.json())
      .then(data => alert("âœ… Fake battle created"))
      .catch(err => alert("Debug error"));
    }
  
    // ğŸ” Wallet Analytics
    function openWalletAnalytics() {
      const wallet = prompt("Enter wallet address to lookup:");
      if (!wallet) return;
      fetch(`${base}/api/admin/wallet-lookup?address=${wallet}`, {
    

      })
      .then(res => res.json())
      .then(data => {
        alert(`Wallet: ${wallet}\nBonus Tier: ${data.bonusTier}\nEmail: ${data.email || 'N/A'}`);
      })
      .catch(err => alert("Wallet lookup failed"));
    }

  function setPresaleEndDate() {
    const date = document.getElementById("presaleEnd").value;
    if (!date) return alert("Pick a valid date.");
    fetch(`${base}/api/admin/set-end-date`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ endDate: date })
    })
    
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Presale end date updated!");
        loadPresaleEnd();
      } else {
        alert("Failed to save: " + data.error);
      }
    })
    .catch(err => alert("Error: " + err.message));
  }
  function loadPresaleEnd() {
    fetch(`${base}/api/presale/end-date`)
      .then(res => res.json())
      .then(data => {
        if (!data.endDate) return document.getElementById("timerOutput").textContent = "No end date set.";
        document.getElementById("presaleEnd").value = data.endDate.split("T")[0];
        const end = new Date(data.endDate).getTime();
        const interval = setInterval(() => {
          const now = new Date().getTime();
          const diff = end - now;
          if (diff <= 0) {
            document.getElementById("timerOutput").textContent = "Presale Ended";
            clearInterval(interval);
            return;
          }
          const d = Math.floor(diff / (1000 * 60 * 60 * 24));
          const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const s = Math.floor((diff % (1000 * 60)) / 1000);
          document.getElementById("timerOutput").textContent = `${d}d ${h}h ${m}m ${s}s remaining`;
        }, 1000);
        });
      }

  window.onload = loadPresaleEnd;
  async function loadWalletAnalytics() {
    const address = prompt("Enter wallet address:");
    if (!address) return;
    const res = await fetch(`${base}/api/phase9/analytics/wallet/${address}`, {
      

    });
    const data = await res.json();
    renderAnalytics(data);
  }

  async function loadBattleStats() {
    const res = await fetch(`${base}/api/phase9/analytics/battles`, {
      

    });
    const data = await res.json();
    renderAnalytics(data);
  }

  async function loadAirdropStats() {
    const res = await fetch(`${base}/api/phase9/analytics/airdrops`, {


    });
    const data = await res.json();
    renderAnalytics(data);
  }

  async function loadAdminLogs() {
    const res = await fetch(`${base}/api/phase9/admin/logs`, {
  

    });
    const data = await res.json();
    renderAnalytics(data);
  }
  function downloadAirdropCSV() {
    if (!queue.length) {
      alert("Airdrop queue is empty.");
      return;
    }
  
    const csv = "Wallet,Amount\n" + queue.map(q => `${q.wallet},${q.amount}`).join("\n");
  
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
  
    const a = document.createElement("a");
    a.href = url;
    a.download = `waldo_airdrop_queue_${new Date().toISOString().split("T")[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  
  async function fetchWaldoBalance(wallet) {
    try {
      const res = await fetch(`https://s1.ripple.com:51234`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          method: "account_lines",
          params: [{ account: wallet }]
        })
      });
      const data = await res.json();
      const lines = data?.result?.lines || [];
      const waldoLine = lines.find(l => l.currency === "WALDO" && l.account === "rf97bQQbqztUnL1BYB5ti4rC691e7u5C8F");
      return waldoLine ? parseFloat(waldoLine.balance).toLocaleString() : "0";
    } catch (err) {
      console.error(`Error fetching balance for ${wallet}`, err);
      return "â€”";
    }
  };
  // â¬‡ï¸ Download Presale CSV
  function downloadCSV() {
    window.open(`${base}/admin/export/presale`, "_blank");
  }function downloadCSVByDate() {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
  
    if (!start || !end) {
      alert("Please select both start and end dates.");
      return;
    }
  
    const url = `${base}/admin/export/presale?start=${start}&end=${end}`;
  
    fetch(url, {
    })
      .then(res => {
        if (!res.ok) throw new Error("CSV export failed");
        return res.blob();
      })
      .then(blob => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `waldo_presale_${start}_to_${end}.csv`;
        link.click();
      })
      .catch(err => {
        alert("Error exporting CSV: " + err.message);
      });
  }
  // ğŸ§± Meme Battle Debug
  async function createFakeBattle() {
    const res = await fetch(`${base}/api/debug/fake-battle`, {
      method: "POST",
  

    });
    output(await res.json());
  }
  async function viewBattles() {
    const res = await fetch(`${base}/api/debug/battles`, {
    });
    output(await res.json());
  }
  async function resetBattle() {
    const res = await fetch(`${base}/api/debug/reset-active`, {
      method: "POST",
    });
    output(await res.json());
  }

  async function voteMeme(choice) {
    const res = await fetch(`${base}/api/debug/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet: "rVoter420", choice }),
    });
    output(await res.json());
  }
  
  async function payout() {
    const res1 = await fetch(`${base}/api/debug/battles`);
    const battles = await res1.json();
    const latest = battles[0];
    const res2 = await fetch(`${base}/api/debug/payout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ battleId: latest.battleId }),
    });
    output(await res2.json());
    
  }
  // âœï¸ Manual Sender
  async function sendManual(e) {
    e.preventDefault();
    const wallet = document.getElementById("manualWallet").value.trim();
    const amount = parseFloat(document.getElementById("manualAmount").value);
    const res = await fetch(`${base}/api/admin/send`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ wallet, amount })
    
    });
    output(await res.json());
  }
  async function checkTrustline(e) {
    e.preventDefault();
    const wallet = document.getElementById("trustWallet").value.trim();
  
    const res = await fetch(`${base}/api/trustline/check`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ wallet })
    });
  
    const data = await res.json();
    document.getElementById("trustOutput").textContent = JSON.stringify(data, null, 2);
  }
  

  // ğŸ Airdrop Queue
  const queue = JSON.parse(localStorage.getItem("airdropQueue")) || [];

  function renderQueue() {
    localStorage.setItem("airdropQueue", JSON.stringify(queue));
    const rows = document.getElementById("airdropQueueRows");
    rows.innerHTML = queue.length
      ? queue.map(q => `<tr><td>${q.wallet}</td><td>${q.amount}</td></tr>`).join("")
      : "<tr><td colspan='2'>No queued drops.</td></tr>";
  }
  async function sendAirdrops() {
    localStorage.setItem("airdropQueue", JSON.stringify(queue));
    for (const entry of queue) {
      const res = await fetch(`${base}/api/admin/send`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(entry)
      });
      output(await res.json());
    }
  }
  
  // ğŸ‘‘ Legendary Table Loader
async function loadTopLegendary() {
  const res = await fetch(`${base}/api/minted`, {
  });
  const data = await res.json();
  const table = document.getElementById("legendaryRows");
  table.innerHTML = "";

  const top = data
    .filter(m => m.xp >= 100)
    .sort((a, b) => b.xp - a.xp)
    .slice(0, 10);

  if (!top.length) {
    table.innerHTML = "<tr><td colspan='5'>No Legendary memes yet.</td></tr>";
    return;
  }

  for (const meme of top) {
    const row = document.createElement("tr");

const walletTd = document.createElement("td");
walletTd.textContent = meme.wallet;

const xpTd = document.createElement("td");
xpTd.textContent = meme.xp;

const tierTd = document.createElement("td");
tierTd.textContent = "ğŸ‘‘ Legendary";
tierTd.className = "legendary";

const imageTd = document.createElement("td");
const img = document.createElement("img");
img.src = meme.image_url;
img.width = 80;
img.style.borderRadius = "8px";
imageTd.appendChild(img);

const dateTd = document.createElement("td");
dateTd.textContent = new Date(meme.mintedAt).toLocaleDateString();

row.appendChild(walletTd);
row.appendChild(xpTd);
row.appendChild(tierTd);
row.appendChild(imageTd);
row.appendChild(dateTd);
table.appendChild(row);

  }
}
    let allBuyers = [];

async function loadBuyers() {
  try {
    const res = await fetch(`${base}/api/presale/feed`, {
      headers: {
      }
    });
    const data = await res.json();
    allBuyers = data;
    renderBuyers(allBuyers);
    getTotals();
  } catch (err) {
    console.error("Failed to load buyers:", err);
  }
}

function renderBuyers(list) {
  const tbody = document.getElementById("buyerRows");
  tbody.innerHTML = list.length
    ? list.map((b, i) => `
      <tr id="row-${i}">
        <td>${b.wallet}</td>
        <td>${b.amountXRP}</td>
        <td>${b.tokens}</td>
        <td>${b.email || "-"}</td>
        <td>${new Date(b.timestamp).toLocaleString()}</td>
        <td id="bal-${i}">Loading...</td>
      </tr>
    `).join("")
    : "<tr><td colspan='6'>No matching buyers.</td></tr>";

  // Kick off balance fetching for each wallet
  list.forEach(async (b, i) => {
    const balance = await fetchWaldoBalance(b.wallet);
    document.getElementById(`bal-${i}`).innerText = balance;
  });

}

function filterBuyers() {
  const term = document.getElementById("presaleSearch").value.trim().toLowerCase();
  const filtered = allBuyers.filter(b =>
    b.wallet.toLowerCase().includes(term) ||
    (b.email || "").toLowerCase().includes(term) ||
    ("" + b.amountXRP).includes(term)
  );
  renderBuyers(filtered);
}

let allHistory = [];

async function loadAirdropHistory() {
  try {
    const res = await fetch(`${base}/admin/airdrops`, {

    });
    allHistory = await res.json();
    renderHistory(allHistory);
  } catch (err) {
    console.error("Failed to load airdrop history", err);
  }
}

function renderHistory(list) {
  const tbody = document.getElementById("airdropHistoryRows");
  tbody.innerHTML = list.length ?
    list.map(entry => `
      <tr>
        <td>${entry.wallet}</td>
        <td>${entry.amount}</td>
        <td>${new Date(entry.timestamp).toLocaleString()}</td>
      </tr>
    `).join("") :
    "<tr><td colspan='3'>No airdrops found.</td></tr>";
}

function downloadAirdropHistoryCSV() {
  const start = document.getElementById("historyStart").value;
  const end = document.getElementById("historyEnd").value;
  const filtered = allHistory.filter(entry => {
    const ts = new Date(entry.timestamp);
    if (start && new Date(start) > ts) return false;
    if (end && new Date(end) < ts) return false;
    return true;
  });
  const csv = "Wallet,Amount,Timestamp\n" + filtered.map(e => `${e.wallet},${e.amount},${e.timestamp}`).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `waldo_airdrop_history_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
};
// Auto-load
loadAirdropHistory();
  
  // ğŸ¯ Submit New Proposal
  async function submitProposal(e) {
    e.preventDefault();
    const title = document.getElementById("daoTitle").value.trim();
    const description = document.getElementById("daoDescription").value.trim();
    const options = document.getElementById("daoOptions").value.split(",").map(o => o.trim()).filter(Boolean);
    const duration = parseInt(document.getElementById("daoDuration").value);
  
    if (!title || options.length < 2 || isNaN(duration)) {
      return alert("Please complete all required fields correctly.");
    }
    const res = await fetch(`${base}/api/proposals`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, description, options, duration, wallet: WALLET })
    });
  
    const data = await res.json();
    if (data.success) {
      alert("âœ… Proposal submitted!");
      loadDAOProposals();
    } else {
      alert("âŒ Failed to submit proposal.");
    }
  }async function castVote(proposalId, choice) {
    const res = await fetch(`${base}/api/vote`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ proposalId, choice, wallet: WALLET })
    });
  
    const data = await res.json();
    if (data.success) {
      alert("âœ… Vote cast!");
      showProposalDetails(proposalId); // Refresh proposal view
    } else {
      alert("âŒ Failed to vote.");
      
    }
  }
  // ğŸ“‹ Load Proposals
  async function loadDAOProposals() {
    const listContainer = document.getElementById("proposalListDAO");
    listContainer.innerHTML = "Loading...";
    const res = await fetch(`${base}/api/proposals`);
    const proposals = await res.json();
  
    if (!proposals.length) {
      listContainer.innerHTML = "<p>No proposals found.</p>";
      return;
    }
  
    listContainer.innerHTML = ""; // clear first
if (!proposals.length) {
  listContainer.innerHTML = "<p>No proposals found.</p>";
  return;
}

proposals.forEach(p => {
  const btn = document.createElement("button");
  btn.innerText = `${p.title} (expires ${new Date(p.expiresAt).toLocaleString()})`;
  btn.onclick = () => showProposalDetails(p.id);
  listContainer.appendChild(btn);
});

  
  }
 // ğŸ§¾ Show Proposal Details + Voting (Safe DOM rendering)
 async function showProposalDetails(id) {
  const res = await fetch(`${base}/api/proposals/${id}`);
  const data = await res.json();

  const tallyRes = await fetch(`${base}/api/vote/tally/${id}`);
  const tally = await tallyRes.json();

  const expired = new Date(data.expiresAt) < new Date();
  const content = document.getElementById("detailContent");
  const detail = document.getElementById("proposalDetailDAO");
  detail.classList.remove("hidden");
  content.innerHTML = ""; // clear previous content safely

  const titleEl = document.createElement('h4');
  titleEl.className = 'text-white font-bold mb-1';
  titleEl.textContent = data.title;

  const descEl = document.createElement('p');
  descEl.className = 'text-sm mb-2';
  descEl.textContent = data.description || 'No description';

  const expEl = document.createElement('p');
  expEl.className = 'text-xs mb-3 text-gray-400';
  expEl.textContent = `â³ Expires: ${new Date(data.expiresAt).toLocaleString()}`;

  content.appendChild(titleEl);
  content.appendChild(descEl);
  content.appendChild(expEl);

  const total = Object.values(tally.results || {}).reduce((a, b) => a + b, 0);
  const totalVotesEl = document.createElement("p");
  totalVotesEl.className = "text-sm mt-2 text-gray-300";
  totalVotesEl.textContent = `ğŸ—³ï¸ Total Votes: ${total}`;
  content.appendChild(totalVotesEl);

  (data.options || []).forEach(option => {
    const count = tally.results?.[option] || 0;
    const percent = total ? ((count / total) * 100).toFixed(1) : 0;

    const container = document.createElement('div');
    container.className = 'mb-3';

    const optionWrapper = document.createElement('div');
    optionWrapper.className = 'flex justify-between mb-1';

    const optionLabel = document.createElement('span');
    optionLabel.textContent = option;

    const voteStats = document.createElement('span');
    voteStats.className = 'font-mono';
    voteStats.textContent = `${count} votes (${percent}%)`;

    optionWrapper.appendChild(optionLabel);
    optionWrapper.appendChild(voteStats);
    container.appendChild(optionWrapper);

    const barWrapper = document.createElement('div');
    barWrapper.style.background = '#333';
    barWrapper.style.borderRadius = '5px';
    barWrapper.style.overflow = 'hidden';

    const bar = document.createElement('div');
    bar.style.width = `${percent}%`;
    bar.style.background = '#e63e3e';
    bar.style.height = '12px';

    barWrapper.appendChild(bar);
    container.appendChild(barWrapper);

    if (!expired) {
      const voteBtn = document.createElement('button');
      voteBtn.textContent = "Vote";
      voteBtn.onclick = () => castVote(id, option);
      voteBtn.style.marginTop = "5px";
      voteBtn.className = "bg-green-600 hover:bg-green-700 text-sm px-2 py-1 rounded";
      container.appendChild(voteBtn);
    } else {
      const closedLabel = document.createElement('span');
      closedLabel.className = 'text-red-500 text-sm';
      closedLabel.textContent = 'Voting closed';
      container.appendChild(closedLabel);
    }

    content.appendChild(container);
  });
}
  // ğŸ“Š Render Analytics
  function renderAnalytics(data) {
    const output = document.getElementById("analyticsOutput");
    output.textContent = JSON.stringify(data, null, 2);
  }

  // ğŸ–¼ï¸ Render Meme Image
  function renderMemeImage(url) {
    const img = document.createElement("img");
    img.src = url;
    img.width = 80;
    img.style.borderRadius = "8px";
    return img;
  }

  // ğŸ“œ Output to Debug Console

  function output(data) {
    const output = document.getElementById("output");
    output.textContent = typeof data === "string" ? data : JSON.stringify(data, null, 2);
  }
  
  document.addEventListener("DOMContentLoaded", () => {
    try {
      // Load all initial data
      loadTopLegendary(); 
      loadDAOProposals();
      loadAirdropHistory();
      renderQueue();
      loadPresaleEnd();
  
      // DAO proposal form setup
      const proposalForm = document.getElementById("daoProposalForm");
      if (proposalForm) {
        proposalForm.addEventListener("submit", submitProposal);
      }
  
      // DAO section visibility
      const daoCard = document.querySelector(".dao-admin");
      if (daoCard) daoCard.style.display = "block";
  
      // Safely re-bind admin panel buttons
      document.querySelector("button[onclick='loadWalletAnalytics()']")?.addEventListener("click", loadWalletAnalytics);
      document.querySelector("button[onclick='loadBattleStats()']")?.addEventListener("click", loadBattleStats);
      document.querySelector("button[onclick='loadAirdropStats()']")?.addEventListener("click", loadAirdropStats);
      document.querySelector("button[onclick='loadAdminLogs()']")?.addEventListener("click", loadAdminLogs);
      document.querySelector("button[onclick='runDebugTools()']")?.addEventListener("click", runDebugTools);
      document.querySelector("button[onclick='openAirdropTools()']")?.addEventListener("click", openAirdropTools);
      document.querySelector("button[onclick='openWalletAnalytics()']")?.addEventListener("click", openWalletAnalytics);
  
    } catch (err) {
      console.error("âŒ Error during admin panel load:", err);
    }
  });
</script>
</div>
</body>
</html>
  