<!-- üöÄ WALDO Presale Button -->
<div style="text-align:center; margin: 40px 0;">
  <button onclick="openWaldoPresaleModal()" style="background:#25c2a0; color:white; font-weight:bold; font-size:20px; padding:12px 30px; border:none; border-radius:8px; cursor:pointer;">
    üöÄ Buy WALDO PRESALE
  </button>
</div>

<!-- üß® Modal Wrapper -->
<div id="waldoPresaleModal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.9); backdrop-filter:blur(4px); overflow-y:auto;">

  <!-- Close Button -->
  <span onclick="closeWaldoPresaleModal()" style="position:absolute; top:20px; right:30px; font-size:26px; cursor:pointer; color:white;">‚úñ</span>

  <!-- Main Presale Container (Matches Airdrop Style) -->
  <div class="presale-box" style="background:#000; border:2px solid red; padding:20px; border-radius:18px; max-width:500px; margin:96px auto 0 auto; color:white; font-family:'Arial Black', sans-serif; text-align:center;">

    <style>
    .presale-box {
      background: #000 !important;
      color: white !important;
    }
    .presale-box * {
      color: white !important;
    }
    .presale-box input {
      background: #333 !important;
      color: white !important;
      border: 1px solid #444 !important;
    }
    .presale-box button {
      background: #25c2a0 !important;
      color: white !important;
      border: none !important;
    }
    .presale-box label {
      color: #ccc !important;
    }
    .presale-box .help-text {
      color: #666 !important;
    }
    @media (max-width: 600px) {
      .presale-box {
        margin: 5px !important;
        padding: 15px !important;
        border-radius: 12px !important;
        background: #000 !important;
      }
      .presale-box input {
        width: 90% !important;
        font-size: 16px !important; /* Prevents zoom on iOS */
        background: #333 !important;
        color: white !important;
      }
      .presale-box a, .presale-box button {
        padding: 10px 16px !important;
        font-size: 14px !important;
        background: #25c2a0 !important;
        color: white !important;
      }
    }
    </style>

    <h2 style="color:#ffea00;">üöÄ WALDO Presale</h2>
    <p style="font-size:14px;">Buy WALDO tokens in <strong>5 XRP increments</strong> ‚Ä¢ <strong>1 XRP = 10,000 WALDO</strong></p>
    <p style="font-size:12px; color:#ffd93d; margin-top:5px;">üî• <strong>Bonus WALDO at 80 XRP and above!</strong></p>

    <!-- Presale Status -->
    <div id="presaleStatus" style="background:#222; padding:10px; border-radius:8px; margin:10px 0; font-size:12px;">
      <div style="color:#25c2a0;">üìä Loading presale status...</div>
    </div>

    <!-- STEP 1: Connect Wallet -->
    <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #444;">
      <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è STEP 1: CONNECT WALLET</div>
      <div style="text-align:center;">
        <button onclick="connectXummWallet()" style="background:#25c2a0; color:white; padding:12px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin:5px;">
          üì± Connect Xaman Wallet
        </button>
        <p id="connectedWallet" style="color:#ccc; font-size:12px; margin-top:8px;">Click button to connect your wallet</p>
      </div>
    </div>

    <!-- STEP 2: Trustline Setup -->
    <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #444;">
      <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è STEP 2: SET TRUSTLINE</div>
      <p style="font-size:12px; color:#ccc; margin-bottom:15px;">
        <strong>You must set the WALDO trustline in your Xaman wallet.</strong>
      </p>

      <div style="display:flex; gap:20px; align-items:center; justify-content:center; flex-wrap:wrap;">
        <!-- Button for Direct Link -->
        <div style="text-align:center;">
          <button onclick="openTrustlineLink()" 
                  style="background:#25c2a0; color:white; padding:12px 20px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom:8px;">
            üîó Set WALDO Trustline
          </button>
          <div style="font-size:10px; color:#666;">
            Opens XRPL Services<br>
            Currency: <strong>WLO</strong>
          </div>
        </div>

        <!-- QR Code for Trustline -->
        <div style="text-align:center;">
          <div style="background:white; padding:10px; border-radius:8px; display:inline-block;">
            <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://xrpl.services/?issuer=rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY&currency=WLO&limit=1000000000"
                 style="width:100px; height:100px; border-radius:6px;" alt="Trustline QR Code" />
          </div>
          <div style="font-size:10px; color:#666; margin-top:8px;">
            Scan with Xaman<br>
            to set trustline
          </div>
        </div>
      </div>

      <div style="font-size:11px; color:#888; margin-top:15px; text-align:center; border-top:1px solid #444; padding-top:10px;">
        üí° <strong>Issuer:</strong> rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY<br>
        üí° <strong>Currency:</strong> WLO | <strong>Limit:</strong> 1,000,000,000
      </div>
    </div>

    <!-- STEP 3: Purchase WALDO -->
    <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #444;">
      <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">‚ö†Ô∏è STEP 3: PURCHASE WALDO</div>
      
      <!-- XRP Amount Input -->
      <div style="margin-bottom:15px;">
        <label style="color:#ccc; font-size:12px; display:block; margin-bottom:5px;">XRP Amount (5-100 in 5 XRP increments)</label>
        <input type="number" id="xrpAmount" min="5" max="100" step="5" value="5"
               style="width:100%; padding:10px; border:1px solid #444; border-radius:6px; background:#333; color:white; font-size:16px; text-align:center;">
      </div>

      <!-- WALDO Amount Display -->
      <div style="margin-bottom:15px; padding:10px; background:#333; border-radius:6px;">
        <div style="color:#25c2a0; font-size:14px; font-weight:bold;">
          You will receive: <span id="waldoAmount">900,000</span> WALDO
        </div>
        <div id="bonusInfo" style="color:#ffd93d; font-size:11px; margin-top:5px;">
          Base rate: 90,000 WALDO per XRP
        </div>
      </div>

      <!-- Purchase Button -->
      <button onclick="purchaseWaldo()" id="purchaseBtn" disabled
              style="width:100%; background:#666; color:#ccc; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:not-allowed; margin-bottom:10px;">
        üí≥ Purchase WALDO (Connect Wallet First)
      </button>

      <!-- Purchase QR Code -->
      <div id="purchaseQR" style="display:none; text-align:center; margin-top:15px;">
        <div style="background:white; padding:10px; border-radius:8px; display:inline-block;">
          <img id="xummPurchaseQR" src="" style="width:120px; height:120px; border-radius:6px;" alt="Purchase QR Code" />
        </div>
        <div style="font-size:10px; color:#666; margin-top:8px;">
          Scan with Xaman to complete purchase
        </div>
      </div>
    </div>

    <!-- Bonus Structure Info -->
    <div style="background:#222; padding:15px; border-radius:8px; margin:10px 0; border:1px solid #444;">
      <div style="color:#ffd93d; font-weight:bold; margin-bottom:8px;">üéÅ BONUS STRUCTURE</div>
      <div style="font-size:11px; color:#ccc; text-align:left;">
        ‚Ä¢ <strong>5-75 XRP:</strong> 10,000 WALDO per XRP (base rate)<br>
        ‚Ä¢ <strong>80 XRP:</strong> 920,000 WALDO (15% bonus = +120,000)<br>
        ‚Ä¢ <strong>90 XRP:</strong> 1,098,000 WALDO (22% bonus = +198,000)<br>
        ‚Ä¢ <strong>100 XRP:</strong> 1,300,000 WALDO (30% bonus = +300,000)
      </div>
      <div style="font-size:10px; color:#888; margin-top:8px; text-align:center; border-top:1px solid #444; padding-top:8px;">
        üí° Bonuses are automatically calculated and added to your base WALDO amount
      </div>
    </div>

    <!-- Info Link -->
    <div style="margin-top:15px;">
      <a href="https://waldocoin.live/presale/" target="_blank" style="color:#25c2a0; font-size:12px; text-decoration:none;">
        üìÑ View Full Presale Information
      </a>
    </div>

  </div>
</div>

<script>
// Modal functions
function openWaldoPresaleModal() {
  document.getElementById('waldoPresaleModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
  updateWaldoAmount(); // Calculate initial amount
}

function closeWaldoPresaleModal() {
  document.getElementById('waldoPresaleModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// Trustline setup function (matches airdrop widget)
function openTrustlineLink() {
  const trustlineUrl = "https://xrpl.services/?issuer=rstjAWDiqKsUMhHqiJShRSkuaZ44TXZyDY&currency=WLO&limit=1000000000";
  window.open(trustlineUrl, '_blank');
}

// Update WALDO amount based on XRP input - Connected to Backend API
async function updateWaldoAmount() {
  const xrpAmount = parseInt(document.getElementById('xrpAmount').value) || 10;
  const bonusInfo = document.getElementById('bonusInfo');

  try {
    // Call backend API for accurate calculation
    const response = await fetch(`https://waldocoin-backend-api.onrender.com/api/presale/calculate?amount=${xrpAmount}`);
    const data = await response.json();

    if (data.success) {
      const calc = data.calculation;
      document.getElementById('waldoAmount').textContent = calc.totalWaldo.toLocaleString();

      if (calc.bonus > 0) {
        bonusInfo.textContent = `${calc.bonusPercentage}% BONUS! (${calc.bonus.toLocaleString()} bonus WALDO)`;
        bonusInfo.style.color = '#ffea00';
      } else {
        bonusInfo.textContent = `Base rate: ${(calc.baseWaldo / xrpAmount).toLocaleString()} WALDO per XRP`;
        bonusInfo.style.color = '#ffd93d';
      }
    } else {
      throw new Error(data.error || 'Calculation failed');
    }
  } catch (error) {
    console.error('Error calculating WALDO amount:', error);
    // Fallback to frontend calculation
    const waldoAmount = xrpAmount * 10000; // Backend uses 10k base rate
    document.getElementById('waldoAmount').textContent = waldoAmount.toLocaleString();
    bonusInfo.textContent = "Base rate: 10,000 WALDO per XRP";
    bonusInfo.style.color = '#ffd93d';
  }
}

// XRP amount input listener
document.addEventListener('DOMContentLoaded', function() {
  const xrpInput = document.getElementById('xrpAmount');
  if (xrpInput) {
    xrpInput.addEventListener('input', updateWaldoAmount);
  }
});

// Global variables
let currentWallet = null;
const API_BASE = 'https://waldocoin-backend-api.onrender.com';

// Connect XUMM Wallet - Real Implementation
async function connectXummWallet() {
  try {
    const response = await fetch(`${API_BASE}/api/login`);
    const data = await response.json();

    if (data.qr) {
      // Show QR code for wallet connection
      showWalletConnectionQR(data.qr, data.uuid);

      // Poll for connection status
      pollWalletConnection(data.uuid);
    } else {
      throw new Error('Failed to generate wallet connection QR');
    }
  } catch (error) {
    console.error('Wallet connection error:', error);
    alert('Failed to connect wallet. Please try again.');
  }
}

// Show wallet connection QR and poll for status
function showWalletConnectionQR(qrUrl, uuid) {
  // Update wallet status
  document.getElementById('connectedWallet').innerHTML = `
    <div style="color:#ffd93d;">üîÑ Scan QR with Xaman to connect...</div>
    <img src="${qrUrl}" style="width:120px; margin:10px; border-radius:8px;" />
  `;
}

// Poll wallet connection status
async function pollWalletConnection(uuid) {
  let attempts = 0;
  const maxAttempts = 60; // 2 minutes

  const interval = setInterval(async () => {
    attempts++;

    if (attempts > maxAttempts) {
      clearInterval(interval);
      document.getElementById('connectedWallet').innerHTML = `
        <div style="color:#e74c3c;">‚ùå Connection timeout. Please try again.</div>
      `;
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/api/login/status?uuid=${uuid}`);
      const status = await response.json();

      if (status.signed && status.account) {
        clearInterval(interval);
        currentWallet = status.account;

        // Update UI
        document.getElementById('connectedWallet').innerHTML = `
          <div style="color:#25c2a0;">‚úÖ Connected: ${currentWallet.slice(0,8)}...${currentWallet.slice(-6)}</div>
        `;

        // Enable purchase button
        const purchaseBtn = document.getElementById('purchaseBtn');
        purchaseBtn.disabled = false;
        purchaseBtn.style.background = '#25c2a0';
        purchaseBtn.style.color = 'white';
        purchaseBtn.style.cursor = 'pointer';
        purchaseBtn.textContent = 'üí≥ Purchase WALDO';
      }
    } catch (error) {
      console.error('Status check error:', error);
    }
  }, 2000);
}

// Purchase WALDO - Real Implementation
async function purchaseWaldo() {
  if (!currentWallet) {
    alert('Please connect your wallet first');
    return;
  }

  const xrpAmount = parseInt(document.getElementById('xrpAmount').value);

  if (xrpAmount < 10 || xrpAmount > 100 || xrpAmount % 10 !== 0) {
    alert('XRP amount must be in 10 XRP increments (10-100)');
    return;
  }

  try {
    // Create purchase transaction
    const response = await fetch(`${API_BASE}/api/login`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        TransactionType: 'Payment',
        Account: currentWallet,
        Destination: 'rMJMw3i7W4dxTBkLKSnkNETCGPeons2MVt', // WALDO distributor wallet
        Amount: (xrpAmount * 1000000).toString(), // Convert to drops
        Memos: [{
          Memo: {
            MemoType: Buffer.from('presale').toString('hex').toUpperCase(),
            MemoData: Buffer.from(`${xrpAmount} XRP presale purchase`).toString('hex').toUpperCase()
          }
        }]
      })
    });

    const data = await response.json();

    if (data.qr) {
      // Show purchase QR
      document.getElementById('purchaseQR').style.display = 'block';
      document.getElementById('xummPurchaseQR').src = data.qr;

      // Poll for transaction completion
      pollPurchaseStatus(data.uuid, xrpAmount);
    } else {
      throw new Error('Failed to create purchase transaction');
    }
  } catch (error) {
    console.error('Purchase error:', error);
    alert('Failed to create purchase transaction. Please try again.');
  }
}

// Poll purchase transaction status
async function pollPurchaseStatus(uuid, xrpAmount) {
  let attempts = 0;
  const maxAttempts = 120; // 4 minutes

  const interval = setInterval(async () => {
    attempts++;

    if (attempts > maxAttempts) {
      clearInterval(interval);
      alert('Transaction timeout. Please check your wallet and try again if needed.');
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/api/login/status?uuid=${uuid}`);
      const status = await response.json();

      if (status.signed && status.txid) {
        clearInterval(interval);

        // Log the purchase to backend
        await logPurchase(currentWallet, xrpAmount, status.txid);

        // Show success
        alert(`‚úÖ Purchase successful! You will receive WALDO tokens shortly.\nTransaction ID: ${status.txid}`);

        // Hide QR and reset
        document.getElementById('purchaseQR').style.display = 'none';
      }
    } catch (error) {
      console.error('Purchase status check error:', error);
    }
  }, 3000);
}

// Log purchase to backend
async function logPurchase(wallet, xrpAmount, txid) {
  try {
    const response = await fetch(`${API_BASE}/api/presale/log`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        wallet: wallet,
        amount: xrpAmount,
        timestamp: Date.now(),
        txid: txid
      })
    });

    const data = await response.json();
    console.log('Purchase logged:', data);
  } catch (error) {
    console.error('Failed to log purchase:', error);
  }
}
</script>
